
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content=".net,java,php,python,docker,web">
      
      
        <meta name="author" content="BurningMyself">
      
      
        <link rel="canonical" href="https://burningmyself.gitee.io/cloud/kubernetes/kubernetes_storage_ceph/">
      
      
        <link rel="prev" href="../kubernetes_storage_volume/">
      
      
        <link rel="next" href="../kubernetes_cluster_serve/">
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>kubernetes存储解决方案Ceph - BurningMyself</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ceph" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="BurningMyself" class="md-header__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BurningMyself
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes存储解决方案Ceph
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BurningMyself" class="md-nav__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BurningMyself
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          技术博文
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          技术博文
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          .NET
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          .NET
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sharp/" class="md-nav__link">
        C#新特性语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_docker/" class="md-nav__link">
        .Net Core Docker 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sqlserver_nginx/" class="md-nav__link">
        Docker 容器化部署 ASP.NET Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_safety/" class="md-nav__link">
        让你的ASP.NET Core应用程序更安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_study_route/" class="md-nav__link">
        ASP.NET Core开发者指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/feature/" class="md-nav__link">
        Java特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/load-class/" class="md-nav__link">
        Java类加载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/orm/" class="md-nav__link">
        Orm的优缺点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/bio-nio/" class="md-nav__link">
        BIO与NIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/rocketmq/rmq-1/" class="md-nav__link">
        RocketMq下载与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springAnnotation/" class="md-nav__link">
        Spring常用注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/javavm/" class="md-nav__link">
        Java 虚拟机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springdesign/" class="md-nav__link">
        Spring 常用设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/spring-cloud/" class="md-nav__link">
        Spring Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-simple/" class="md-nav__link">
        Java simple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-validator/" class="md-nav__link">
        Java Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-string/" class="md-nav__link">
        Java String
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-utils/" class="md-nav__link">
        Java Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/feature/" class="md-nav__link">
        Python特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/str_joint/" class="md-nav__link">
        Python字符拼接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/syntax_rule/" class="md-nav__link">
        Python语法技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/fabric/" class="md-nav__link">
        远程部署神器 Fabric
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          Go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../go/go_base/" class="md-nav__link">
        Go基础语法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          PHP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          PHP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../php/kj/" class="md-nav__link">
        框架
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/es6/" class="md-nav__link">
        es6语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/ali_js_style/" class="md-nav__link">
        阿里js样式规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/node.js/" class="md-nav__link">
        node.js文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react/" class="md-nav__link">
        React 开发者指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../dart/syntax/" class="md-nav__link">
        Dart语法学习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react_interview/" class="md-nav__link">
        React 面试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/js_tool_method/" class="md-nav__link">
        js 工具函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/vue_cp_react/" class="md-nav__link">
        vue与react比较
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/javascript/" class="md-nav__link">
        JavaScript 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh17/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_log/" class="md-nav__link">
        MySQL日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_index/" class="md-nav__link">
        MySQL索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_pxc/" class="md-nav__link">
        MySQL PXC集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_use/" class="md-nav__link">
        MySQL 数据库应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_backups/" class="md-nav__link">
        MySql 备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/sql_server_master/" class="md-nav__link">
        Sql Server 主从备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/data_split/" class="md-nav__link">
        数据库之互联网常用分库分表方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mybatis/" class="md-nav__link">
        Mybatis使用心德
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/linux/" class="md-nav__link">
        Linux学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/often/" class="md-nav__link">
        常用命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/ope/" class="md-nav__link">
        实用的Linux 命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker/" class="md-nav__link">
        Docker全科
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker_core/" class="md-nav__link">
        Docker 核心技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-compose/" class="md-nav__link">
        docker和docker-compose配置常用环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-jenkins/" class="md-nav__link">
        Docker部署Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-phabricator/" class="md-nav__link">
        Docker部署Phabricator
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_fw_rule_and_object_design/" class="md-nav__link">
        Kubernetes架构原则和对象设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_etcd/" class="md-nav__link">
        Kubernetes控制平面组件etcd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_kube_APIServer/" class="md-nav__link">
        深入理解Kube-APIServer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_controller_manager/" class="md-nav__link">
        kubernetes控制平面组件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
      
      
      
        <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
          Tool
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_11">
          <span class="md-nav__icon md-icon"></span>
          Tool
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitusual/" class="md-nav__link">
        Git动画展示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitquestion/" class="md-nav__link">
        Git问题处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitflow/" class="md-nav__link">
        GitFlow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitbook/" class="md-nav__link">
        GitBook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitcmr/" class="md-nav__link">
        Git提交日志规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/markdown/" class="md-nav__link">
        Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cicd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/mkdocs/" class="md-nav__link">
        mkdocs简单使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitstudy/" class="md-nav__link">
        Git的黑魔法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/minio/" class="md-nav__link">
        MinIO 搭建使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cat-monitoring/" class="md-nav__link">
        Cat分布式监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          云架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          云架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../native/" class="md-nav__link">
        云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../virtual/" class="md-nav__link">
        虚拟化技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compute/" class="md-nav__link">
        云计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprelease/" class="md-nav__link">
        应用部署容器化演进
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlinux/" class="md-nav__link">
        容器技术所涉及Linux内核关键技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_native/" class="md-nav__link">
        容器管理工具Docker生态架构及部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_nginx/" class="md-nav__link">
        使用容器运行Nginx应用及Docker命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image/" class="md-nav__link">
        Docker容器镜像
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image_fast/" class="md-nav__link">
        Docker容器镜像加速器及本地容器镜像仓库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container_enterprice/" class="md-nav__link">
        Docker容器化部署企业级应用集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_file/" class="md-nav__link">
        Dockerfile精讲及新型容器镜像构建技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_network/" class="md-nav__link">
        Docker容器网络与通信原理深度解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_date/" class="md-nav__link">
        Docker容器数据持久化存储机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_compose/" class="md-nav__link">
        Docker容器服务编排利器Docker Compose应用实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_swarm/" class="md-nav__link">
        Docker主机集群化方案 Docker Swarm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_devops/" class="md-nav__link">
        基于Docker容器DevOps应用方案 企业业务代码发布系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container/" class="md-nav__link">
        轻量级或工业级容器管理工具
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        kubeadm极速部署Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_introduce/" class="md-nav__link">
        kubernetes介绍与集群架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_way/" class="md-nav__link">
        Kubernetes集群部署方式说明
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_master/" class="md-nav__link">
        kubeadm部署单Master节点kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight/" class="md-nav__link">
        kubeadm部署高可用kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rke/" class="md-nav__link">
        使用RKE构建企业生产级Kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin1/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）一
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin2/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）二
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        Kubernetes集群UI及主机资源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_sealos/" class="md-nav__link">
        使用sealos部署kubernetes集群并实现集群管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        kubernetes集群命令语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_core/" class="md-nav__link">
        Kubernetes核心概念
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_nginx_ingress_controller/" class="md-nav__link">
        Kubernetes集群 服务暴露 Nginx Ingress Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_traefik/" class="md-nav__link">
        Kubernetes集群 服务暴露 Traefik
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_configMap_secret/" class="md-nav__link">
        Kubernetes配置与密钥管理 ConfigMap&Secret
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_harbor/" class="md-nav__link">
        Kubernetes集群使用容器镜像仓库Harbor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_safety/" class="md-nav__link">
        Kubernetes集群安全管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_volume/" class="md-nav__link">
        kubernetes持久化存储卷
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        kubernetes存储解决方案Ceph
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster_serve/" class="md-nav__link">
        Kubernetes集群公共服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_java/" class="md-nav__link">
        kubernetes集群java项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_python/" class="md-nav__link">
        kubernetes集群Python项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_golang/" class="md-nav__link">
        Kubernetes集群golang项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_logs_collect/" class="md-nav__link">
        kubernetes日志收集方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_zookeeper/" class="md-nav__link">
        企业级中间件上云部署 zookeeper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kafka/" class="md-nav__link">
        kubernetes云原生中间件上云部署 kafka
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rokectmq/" class="md-nav__link">
        rocketmq部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_helm/" class="md-nav__link">
        Kubernetes集群包管理解决方案 Helm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kustomize/" class="md-nav__link">
        Kubernetes原生配置管理利器 kustomize
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_flannel/" class="md-nav__link">
        kubernetes集群网络解决方案 flannel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_calico/" class="md-nav__link">
        kubernetes集群网络解决方案 calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hybridnet/" class="md-nav__link">
        kubernetes集群 underlay 网络方案 hybridnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ipv4_and_ipv6/" class="md-nav__link">
        kubernetes版本双栈协议（IPv4&IPv6）集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rancher/" class="md-nav__link">
        Rancher容器云管理平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubeconfig/" class="md-nav__link">
        使用kubeconfig管理多集群方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_karmada/" class="md-nav__link">
        karmada实现k8s集群联邦
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubesphere/" class="md-nav__link">
        安装kubesphere使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          微服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          微服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/fbs-lock/" class="md-nav__link">
        分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/design/" class="md-nav__link">
        微服务设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/distrimsg/" class="md-nav__link">
        分布式系统与消息的投递
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/ddd/" class="md-nav__link">
        基于DDD的微服务设计和开发实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/kafka/" class="md-nav__link">
        Kafka架构原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/redis_cluster/" class="md-nav__link">
        Redis Cluster原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/spring-cloud-micro/" class="md-nav__link">
        分布式架构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          经验分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          经验分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/devops/" class="md-nav__link">
        DevOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/micro-service/" class="md-nav__link">
        Micro-Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/raft-gossip/" class="md-nav__link">
        Raft算法和Gossip协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cl/" class="md-nav__link">
        集群和负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/ai/" class="md-nav__link">
        人工智能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/code-principle/" class="md-nav__link">
        代码原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/techbig/" class="md-nav__link">
        如何成为技术大牛
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/learnweetout/" class="md-nav__link">
        程序员如何技术成长
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/pt/" class="md-nav__link">
        产品与技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/four_deep_learning/" class="md-nav__link">
        深度学习框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/tl/" class="md-nav__link">
        在阿里做了5年技术Leader，我总结出这些套路！
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cto/" class="md-nav__link">
        CTO 技能图谱
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          构架
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          构架
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/split/" class="md-nav__link">
        构架拆分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fgb/" class="md-nav__link">
        分布式、高并发、多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/agility/" class="md-nav__link">
        如何理解敏捷开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fwork/" class="md-nav__link">
        走向架构师必备的技能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/data_middle/" class="md-nav__link">
        数据中台的思考与总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/algorithm-ten/" class="md-nav__link">
        必学的 10 大算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          情感
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          情感
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/eq/" class="md-nav__link">
        情商
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/workheard/" class="md-nav__link">
        工作心得
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lookbook/" class="md-nav__link">
        看书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/selfdiscipline/" class="md-nav__link">
        自律
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/livefail/" class="md-nav__link">
        为什么活着失败
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/emotion/" class="md-nav__link">
        情绪管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/losecome/" class="md-nav__link">
        所有的失去，都会以另一种方式归来
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/threeheart/" class="md-nav__link">
        人生有这三种好心态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/onepath/" class="md-nav__link">
        余生，学会一个人走，不管有没有人陪
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/twopath/" class="md-nav__link">
        往后余生还很精彩，别被熬夜拖垮了
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lifetime/" class="md-nav__link">
        心态好的人，一辈子都好
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="ceph">存储解决方案 Ceph<a class="headerlink" href="#ceph" title="Permanent link">&para;</a></h1>
<h1 id="1">1 快速入门<a class="headerlink" href="#1" title="Permanent link">&para;</a></h1>
<h2 id="11">1.1 基础知识<a class="headerlink" href="#11" title="Permanent link">&para;</a></h2>
<h3 id="111">1.1.1 存储基础<a class="headerlink" href="#111" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、文件系统、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>存储基础</p>
<div class="highlight"><pre><span></span><code>    <span class="n">我们知道</span><span class="err">，</span><span class="n">对于一个计算机设备来说</span><span class="err">，</span><span class="n">其存储功能是非常重要的</span><span class="err">，</span><span class="n">也就是说</span><span class="err">，</span><span class="n">任何一台电脑上</span><span class="err">，</span><span class="n">必须包含一个设备</span><span class="p">--</span><span class="n">磁盘</span><span class="err">。</span><span class="n">这个磁盘就是用于数据存储的目的的</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">常见的存储设备接口</span><span class="err">：</span>
<span class="n">DAS设备</span><span class="err">：</span><span class="n">IDE</span><span class="err">、</span><span class="n">SATA</span><span class="err">、</span><span class="n">SCSI</span><span class="err">、</span><span class="n">SAS</span><span class="err">、</span><span class="n">USB</span>
    <span class="n">无论是那种接口</span><span class="err">，</span><span class="n">他都是存储设备驱动下的磁盘设备</span><span class="err">，</span><span class="n">而磁盘设备其实就是一种存储</span><span class="err">，</span><span class="n">这种存储是直接接入到主板总线上去的</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">基于数据块来进行访问</span>
    <span class="p">-</span> <span class="n">基于服务器方式实现互联访问</span><span class="err">，</span><span class="n">操作简单</span><span class="err">、</span><span class="n">成本低</span><span class="err">。</span>
<span class="n">NAS设备</span><span class="err">：</span><span class="n">NFS</span><span class="err">、</span><span class="n">CIFS</span>
    <span class="n">几乎所有的网络存储设备基本上都是以文件系统样式进行使用</span><span class="err">，</span><span class="n">无法进一步格式化操作</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">基于文件系统方式访问</span>
    <span class="p">-</span> <span class="n">没有网络区域限制</span><span class="err">，</span><span class="n">支持多种协议操作文件</span><span class="err">。</span>
<span class="n">SAN</span><span class="p">:</span><span class="n">scsi协议</span><span class="err">、</span><span class="nb">FC </span><span class="n">SAN</span><span class="err">、</span><span class="n">iSCSI</span>
    <span class="n">基于SAN方式提供给客户端操作系统的是一种块设备接口</span><span class="err">，</span><span class="n">所以这些设备间主要是通过scsi协议来完成正常的通信</span><span class="err">。</span>
    <span class="n">scsi的结构类似于TCP</span><span class="p">/</span><span class="n">IP协议</span><span class="err">，</span><span class="n">也有很多层</span><span class="err">，</span><span class="n">但是scsi协议主要是用来进行存储数据操作的</span><span class="err">。</span><span class="n">既然是分层方式实现的</span><span class="err">，</span><span class="n">那就是说</span><span class="err">，</span><span class="n">有部分层可以被替代</span><span class="err">。</span><span class="n">比如将物理层基于FC方式来实现</span><span class="err">，</span><span class="n">就形成了FCSAN</span><span class="err">，</span><span class="n">如果基于以太网方式来传递数据</span><span class="err">，</span><span class="n">就形成了iSCSI模式</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">基于数据块来实现访问</span>
    <span class="p">-</span> <span class="n">不受服务器约束</span><span class="err">，</span><span class="n">通过存储池实现资源的高效利用</span><span class="err">，</span><span class="n">扩展性好</span>
</code></pre></div>
<p><img alt="image-20220923150326956" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220923150326956.png" /></p>
<p>存储使用</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于存储的使用</span><span class="err">，</span><span class="n">我们需要借助于文件系统的方式来实现</span><span class="err">，</span><span class="n">而存储在使用前往往需要进行格式化</span><span class="err">。</span>
</code></pre></div>
<p><strong>文件系统</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">文件系统的基本数据单位是文件</span><span class="err">，</span><span class="n">它的目的是对磁盘上的文件进行组织管理</span><span class="err">，</span><span class="n">那组织的方式不同</span><span class="err">，</span><span class="n">就会形成不同的文件系统</span><span class="err">。</span> <span class="n">Linux</span> <span class="n">文件系统会为每个文件分配两个数据结构</span><span class="err">：</span><span class="n">索引节点</span><span class="p">(</span><span class="n">index</span> <span class="n">node</span><span class="p">)</span><span class="n">和目录项</span><span class="p">(</span><span class="n">directory</span> <span class="n">entry</span><span class="p">)</span><span class="err">，</span><span class="n">它们主要用来记录文件的元信息和目录层次结构</span><span class="err">。</span>

<span class="n">索引节点</span> 
    <span class="p">-</span> <span class="n">用来记录文件的元信息</span><span class="err">，</span><span class="n">比如</span> <span class="n">inode</span> <span class="n">编号</span><span class="err">、</span><span class="n">文件大小</span><span class="err">、</span><span class="n">访问权限</span><span class="err">、</span><span class="n">创建时间</span><span class="err">、</span><span class="n">等信息</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">索引节点是文件的唯一标识</span><span class="err">，</span><span class="n">它们之间一一对应</span><span class="err">，</span><span class="n">也同样都会被存储在硬盘中</span><span class="err">，</span><span class="n">所以索引节点同样占用磁盘空间</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">用户查找的时候</span><span class="err">，</span><span class="n">会根据inode的信息</span><span class="err">，</span><span class="n">找到对应的数据块</span><span class="err">，</span><span class="n">我们可以将inode理解为数据块的路由信息</span><span class="err">。</span>
<span class="n">目录项</span>
    <span class="p">-</span> <span class="n">用来记录文件的名字</span><span class="err">、</span><span class="n">索引节点指针以及与其他目录项的层级关联关系</span><span class="err">。</span><span class="n">多个目录项关联起来</span><span class="err">，</span><span class="n">形成目录结构</span>
    <span class="p">-</span> <span class="n">它与索引节点不同</span><span class="err">，</span><span class="n">目录项是由内核维护的一个数据结构</span><span class="err">，</span><span class="n">不存放于磁盘</span><span class="err">，</span><span class="n">而是缓存在内存</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">目录项和索引节点的关系是多对一</span>
</code></pre></div>
<p>数据存储</p>
<div class="highlight"><pre><span></span><code><span class="n">数据块</span>
    <span class="n">磁盘读写的最小单位是扇区</span><span class="err">，</span><span class="n">扇区的大小只有</span> <span class="n">512B</span> <span class="n">大小</span><span class="err">，</span><span class="n">文件系统把多个扇区组成了一个逻辑块</span><span class="err">，</span><span class="n">每次读写的最小单位就是逻辑块</span><span class="err">（</span><span class="n">数据块</span><span class="err">），</span><span class="n">Linux</span> <span class="n">中的逻辑块大小为</span> <span class="n">4KB</span><span class="err">，</span><span class="n">也就是一次性读写</span> <span class="n">8</span> <span class="n">个扇区</span><span class="err">，</span><span class="n">这将大大提高了磁盘的读写的效率</span><span class="err">。</span>
    <span class="n">磁盘想要被文件系统使用</span><span class="err">，</span><span class="n">需要进行格式化</span><span class="err">，</span><span class="n">此时磁盘会被分成三个存储区域</span>
        <span class="p">-</span> <span class="n">超级块</span><span class="err">，</span><span class="n">用来存储文件系统的详细信息</span><span class="err">，</span><span class="n">比如块个数</span><span class="err">、</span><span class="n">块大小</span><span class="err">、</span><span class="n">空闲块等等</span><span class="err">。</span> 
        <span class="p">-</span> <span class="n">索引节点区</span><span class="err">，</span><span class="n">用来存储索引节点</span><span class="err">；</span>
        <span class="p">-</span> <span class="n">数据块区</span><span class="err">，</span><span class="n">用来存储文件或目录数据</span><span class="err">；</span>
</code></pre></div>
<p>存储应用的基本方式</p>
<p><img alt="1636079494896" src="../../../img/kubernetes/kubernetes_storage_ceph/1636079494896.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">为了加速文件的访问</span><span class="err">，</span><span class="n">通常会把相关信息加载到内存中</span><span class="err">，</span><span class="n">但是考虑到内存的容量限制</span><span class="err">，</span><span class="n">它们加载进内存的时机是不同的</span><span class="err">：</span>
    <span class="n">超级块</span><span class="err">：</span><span class="n">当文件系统挂载时进入内存</span><span class="err">；</span>
    <span class="n">索引节点区</span><span class="err">：</span><span class="n">当文件被访问时进入内存</span><span class="err">；</span>
    <span class="n">数据块</span><span class="err">：</span><span class="n">文件数据使用的时候进入内</span><span class="err">；</span>
</code></pre></div>
<p>文件存储</p>
<div class="highlight"><pre><span></span><code>    <span class="n">文件的数据是要存储在硬盘上面的</span><span class="err">，</span><span class="n">数据在磁盘上的存放方式</span><span class="err">，</span><span class="n">有两种方式</span><span class="err">：</span>
        <span class="n">连续空间存放方式</span> 
            <span class="p">-</span> <span class="n">同一个文件存放到一个连续的存储空间</span>
            <span class="p">-</span> <span class="n">一旦文件删除可能导致磁盘空间碎片</span>
            <span class="p">-</span> <span class="n">文件内容长度扩展不方便</span><span class="err">，</span><span class="n">综合效率是非常低的</span><span class="err">。</span>
        <span class="n">非连续空间存放方式</span>
            <span class="p">-</span> <span class="n">同一个文件存放到一个不连续的存储空间</span><span class="err">，</span><span class="n">每个空间会关联下一个空间</span>
            <span class="p">-</span> <span class="n">可以消除磁盘碎片</span><span class="err">，</span><span class="n">可大大提高磁盘空间的利用率</span><span class="err">，</span><span class="n">同时文件的长度可以动态扩展</span><span class="err">。</span>
            <span class="p">-</span> <span class="n">查找效率低</span><span class="err">，</span><span class="n">需要额外的资源消耗</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220923154844319" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220923154844319.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="112_dfs">1.1.2 DFS概述<a class="headerlink" href="#112_dfs" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 DFS简介、原理解读、小结 三个方面来学习。</p>
<p><strong>DFS简介</strong></p>
<p>存储基础</p>
<div class="highlight"><pre><span></span><code><span class="n">存储处理能力不足</span><span class="err">：</span>
    <span class="n">传统的IDE的io值是100次</span><span class="p">/</span><span class="n">秒</span><span class="err">，</span><span class="n">SATA固态磁盘500次</span><span class="p">/</span><span class="n">秒</span><span class="err">，</span><span class="n">NVMe固态硬盘达到2000</span><span class="p">-</span><span class="n">4000次</span><span class="p">/</span><span class="n">秒</span><span class="err">。</span><span class="n">即时磁盘的io能力再大数十倍</span><span class="err">，</span><span class="n">难道能够抗住网站访问高峰期数十万</span><span class="err">、</span><span class="n">数百万甚至上亿用户的同时访问么</span><span class="err">？</span><span class="n">这还受到网络io能力的限制</span><span class="err">。</span>

<span class="n">存储空间能力不足</span><span class="err">：</span>
    <span class="n">单块磁盘的容量再大</span><span class="err">，</span><span class="n">也无法满足用户的正常访问所需的数据容量限制</span><span class="err">。</span>

<span class="n">需求</span><span class="err">：</span>
    <span class="n">可以实现横向扩展的存储系统</span><span class="err">，</span><span class="n">这种存储系统在市面中的表现样式很多</span><span class="err">，</span><span class="n">不过他们有一个统一的称呼</span> <span class="p">--</span> <span class="n">分布式存储系统</span><span class="err">。</span>
</code></pre></div>
<p>分布式文件系统</p>
<div class="highlight"><pre><span></span><code>    <span class="n">随着传输技术发展</span><span class="err">，</span><span class="n">操作系统读写数据的方式</span><span class="err">，</span><span class="n">不再局限于本地I</span><span class="p">/</span><span class="n">O技术</span><span class="err">，</span><span class="n">开始支持远距离的TCP</span><span class="p">/</span><span class="n">IP方式获取数据</span><span class="err">。</span><span class="n">它相当于新增一种可以远距离传输的I</span><span class="p">/</span><span class="n">O技术</span><span class="err">，</span><span class="n">使得分散的存储设备和用户操作系统可以通过网络方式接入联合在一起</span><span class="err">，</span><span class="n">形成更大容量</span><span class="err">，</span><span class="n">更易于拓展伸缩的存储系统</span><span class="err">，</span><span class="n">对此人们引入分布式文件系统的概念</span><span class="err">。</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">分布式文件系统</span><span class="err">（</span><span class="n">Distributed</span> <span class="n">File</span> <span class="n">System</span><span class="err">，</span><span class="n">DFS</span><span class="err">）</span><span class="n">是指文件系统管理的物理存储资源不一定直接连接在本地节点上</span><span class="err">，</span><span class="n">而是通过计算机网络与节点相连</span><span class="err">；</span><span class="n">或是若干不同的逻辑磁盘分区或卷标组合在一起而形成的完整的有层次的文件系统</span><span class="err">。</span>
    <span class="n">分布式文件系统的发展现后经历了三个阶段</span><span class="err">：</span><span class="n">网络文件系统</span><span class="err">、</span><span class="n">共享SAN文件系统</span><span class="err">、</span><span class="n">面向对象的并行文件系统</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">从本质上来说</span><span class="err">，</span><span class="n">分布式文件系统跟传统的文件系统没本质的差别</span><span class="err">，</span><span class="n">只不过是需要额外考虑多节点网络连接的可靠性</span><span class="err">、</span><span class="n">接入的存储设备的复杂性</span><span class="err">，</span><span class="n">需要文件系统</span><span class="err">、</span><span class="n">网络环境</span><span class="err">、</span><span class="n">存储策略共同协作而已</span><span class="err">。</span>
    <span class="n">由于文件系统与传统一致</span><span class="err">，</span><span class="n">网络环境不受控制</span><span class="err">，</span><span class="n">所以</span><span class="err">，</span><span class="n">我们平常所说的分布式文件系统</span><span class="err">，</span><span class="n">也等同于分布式存储系统</span><span class="err">。</span>
</code></pre></div>
<p>DSS简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">分布式存储系统</span><span class="err">，</span><span class="n">是将数据分散存储在多台独立的设备上</span><span class="err">，</span><span class="n">从而解决传统的存储系统的容量和性能限制</span><span class="err">。</span><span class="n">所以如果存储服务器的可靠性和安全性无法满足大规模存储应用的需要</span><span class="err">，</span><span class="n">那么它就会成为分布式文件系统的性能瓶颈</span><span class="err">。</span>
    <span class="n">其实</span><span class="err">，</span><span class="n">分布式存储系统可以理解为多台单机存储系统的各司其职</span><span class="err">、</span><span class="n">协同合作</span><span class="err">，</span><span class="n">统一的对外提供存储的服务</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">分布式网络存储系统采用可扩展的系统结构</span><span class="err">，</span><span class="n">利用多台存储服务器分担存储负荷</span><span class="err">，</span><span class="n">利用位置服务器定位存储信息</span><span class="err">，</span><span class="n">它不但提高了系统的可靠性</span><span class="err">、</span><span class="n">可用性和存取效率</span><span class="err">，</span><span class="n">还易于扩展</span><span class="err">。</span>
    <span class="n">按照分布式存储系统的作用场景</span><span class="err">，</span><span class="n">我们可以将其划分为</span> <span class="n">存储非结构化数据的分布式文件系统</span><span class="err">、</span><span class="n">存储结构化数据的分布式数据库</span><span class="err">、</span><span class="n">存储半结构化数据的分布式NoSQL数据库等</span><span class="err">。</span>
</code></pre></div>
<p>常见的文件系统</p>
<p><img alt="image-20220923162020799" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220923162020799.png" /></p>
<p><strong>原理解读</strong></p>
<p>分布式数据存储</p>
<p><img alt="1636082742521" src="../../../img/kubernetes/kubernetes_storage_ceph/1636082742521.png" /></p>
<p>存储角色</p>
<div class="highlight"><pre><span></span><code><span class="n">节点角色</span>
    <span class="n">当我们将数据存储到分布式系统上的时候</span><span class="err">，</span><span class="n">就需要有一个路由机制</span><span class="err">，</span><span class="n">能够将我们的请求转交给对应的存储节点上</span><span class="err">。</span><span class="n">所以</span><span class="err">，</span><span class="n">根据我们对数据在单节点上的存储原理</span><span class="err">，</span><span class="n">我们就需要有一个单独的节点来存储所有数据的元数据信息</span><span class="err">，</span><span class="n">然后</span><span class="err">，</span><span class="n">分布式存储就作为block的存储区域</span><span class="err">，</span><span class="n">专门用户数据存储</span><span class="err">。</span>
    <span class="n">存储元素据的节点我们把它称为NameNode</span><span class="err">，</span><span class="n">存储具体数据的节点我们称为DataNode</span><span class="err">。</span>

<span class="n">数据拆分</span><span class="err">：</span>
    <span class="n">当我们要存储的数据非常大</span><span class="err">，</span><span class="n">比如说5个G</span><span class="err">，</span><span class="n">所以我们在存储的时候</span><span class="err">，</span><span class="n">将存储的数据信息发送给元数据控制节点</span><span class="err">，</span><span class="n">然后元数据控制节点根据自定义的存储策略</span><span class="err">，</span><span class="n">将要存储的数据进行拆分</span><span class="p">(</span><span class="n">64M一块</span><span class="p">)--</span><span class="n">也就是数据切片</span><span class="err">，</span><span class="n">将切分后的数据作为一个独立的文件</span><span class="err">，</span><span class="n">然后基于同样的路由逻辑</span><span class="err">，</span><span class="n">将其分散存储到不同的存储节点上</span><span class="err">。</span>
    <span class="n">元数据控制节点</span><span class="err">，</span><span class="n">在进行数据切分的时候</span><span class="err">，</span><span class="n">还需要能够组合起来</span><span class="err">，</span><span class="n">所以拆分后的数据块大小</span><span class="err">、</span><span class="n">组合时候的偏移信息</span><span class="err">、</span><span class="n">路由到的节点等信息都应该有针对性的记录</span><span class="err">。</span>
    <span class="n">在切片的时候</span><span class="err">，</span><span class="n">还可以实现并行的存储逻辑效果</span><span class="err">。</span><span class="n">每一个数据块都称为一个shard</span><span class="err">。</span>
</code></pre></div>
<p>数据高可用</p>
<div class="highlight"><pre><span></span><code><span class="n">元数据高可用</span>
    <span class="n">由于NameNode保存了非常重要的数据信息</span><span class="err">，</span><span class="n">所以为了避免因为NameNode故障导致的问题</span><span class="err">，</span><span class="n">我们一定要对NameNode进行高可用处理</span><span class="err">。</span>
    <span class="n">由于元数据非常小</span><span class="p">(</span><span class="n">几k</span><span class="p">)</span><span class="err">，</span><span class="n">所以NameNode上的数据是</span> <span class="n">非常密集而且io量非常小的</span><span class="err">。</span><span class="n">所以为了提高数据的查询和存储效率</span><span class="err">，</span><span class="n">我们一般将这些数据保存到内存中</span><span class="err">。</span><span class="n">所以为了防止主机断电导致数据丢失</span><span class="err">，</span><span class="n">所以我们需要随时的进行数据同步到磁盘中</span><span class="err">，</span><span class="n">因为没有办法判断每一次到底是哪种数据被访问或更改</span><span class="err">，</span><span class="n">所以在磁盘数据同步的时候</span><span class="err">，</span><span class="n">随机io是非常大的</span><span class="err">。</span>
    <span class="n">同时</span><span class="err">，</span><span class="n">为了避免单节点的数据文件丢失</span><span class="err">，</span><span class="n">我们需要通过共享存储的方式将数据保存在第三方的存储设备上</span><span class="err">，</span><span class="n">同时还需要对数据存储主机进行高可用</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">数据高可用</span>
    <span class="n">由于我们对元数据进行了数据切片的方式</span><span class="err">，</span><span class="n">实现了数据的高效率存取</span><span class="err">，</span><span class="n">但是我们知道</span><span class="err">，</span><span class="n">一旦这些数据块中</span><span class="err">，</span><span class="n">任意丢弃一块</span><span class="err">，</span><span class="n">就会导致所有的数据无法正常的使用</span><span class="err">。</span><span class="n">所以有必要对这些数据进行高可用的操作</span><span class="err">。</span><span class="n">对于高可用的方式</span><span class="err">，</span><span class="n">我们一般会有两种方式来实现数据的冗余</span><span class="err">。</span>
    <span class="n">节点级</span><span class="err">：</span>
        <span class="n">通过对主机节点进行高可用</span><span class="err">，</span><span class="n">从而实现数据的冗余</span><span class="err">，</span><span class="n">这种机制</span><span class="err">，</span><span class="n">成本太高了</span><span class="err">，</span><span class="n">不值得</span><span class="err">。</span>
    <span class="n">数据级</span><span class="err">：</span>
        <span class="n">我们对拆分后的数据块进行副本操作</span><span class="err">，</span><span class="n">而且还可以根据节点的数量</span><span class="err">，</span><span class="n">自定义冗余的副本数量</span><span class="err">。</span><span class="n">这是推荐的</span><span class="err">。</span>
        <span class="n">主角色的数据块称为</span> <span class="n">primary</span> <span class="n">shard</span><span class="err">，</span><span class="n">副本数据块称为</span> <span class="n">replica</span> <span class="n">shard</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">在进行数据块数据冗余的时候</span><span class="err">，</span><span class="n">这些副本的策略机制是有元数据节点来进行控制的</span><span class="err">，</span><span class="n">当一个DataNode故障的时候</span><span class="err">：</span>
        <span class="p">-</span> <span class="n">如果主shard没有了</span><span class="err">，</span><span class="n">从所有的副本shard中选择一个主</span><span class="err">。</span>
        <span class="p">-</span> <span class="n">如果副本shard没有了</span><span class="err">，</span><span class="n">再创建一个副本shard即可</span><span class="err">。</span>
        <span class="p">-</span> <span class="n">一旦DataNode节点数量多于副本数量</span><span class="err">，</span><span class="n">控制副本数据在另一个DataNode节点上复制一个新的副本</span>
            <span class="n">从而保证副本的总体是满足预期的</span><span class="err">。</span>

    <span class="n">为了防止数据副本节点在同一个物理机架上的时候</span><span class="err">，</span><span class="n">因为机架故障</span><span class="err">，</span><span class="n">导致所有副本无效</span><span class="err">，</span><span class="n">所以我们在考虑冗余的时候</span><span class="err">，</span><span class="n">还需要考虑地理位置区域的冗余</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="113">1.1.3 存储简介<a class="headerlink" href="#113" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 存储类型、ceph简介、小结 三个方面来学习。</p>
<p><strong>存储类型</strong></p>
<p>三种存储</p>
<p><img alt="1636084901961" src="../../../img/kubernetes/kubernetes_storage_ceph/1636084901961.png" /></p>
<p>块存储</p>
<div class="highlight"><pre><span></span><code>    <span class="n">块存储是将裸磁盘空间整个映射给主机使用的</span><span class="err">，</span><span class="n">主机层面操作系统识别出硬盘</span><span class="err">，</span><span class="n">与我们服务器内置的硬盘没有什么差异</span><span class="p">,</span><span class="n">可以自由的进行磁盘进行分区</span><span class="err">、</span><span class="n">格式化</span><span class="err">，</span>
    <span class="n">块存储不仅仅是直接使用物理设备</span><span class="err">，</span><span class="n">间接使用物理设备的也叫块设备</span><span class="err">，</span><span class="n">比如虚机创建虚拟磁盘</span><span class="err">、</span><span class="n">虚机磁盘格式包括raw</span><span class="err">、</span><span class="n">qcow2等</span><span class="err">。</span>   
    <span class="n">常见解决方案</span><span class="err">：</span>
        <span class="n">ABS</span><span class="p">(</span><span class="n">Azure</span> <span class="n">Block</span> <span class="n">Storage</span><span class="p">)</span><span class="err">、</span><span class="n">GBS</span><span class="p">(</span><span class="n">Google</span> <span class="n">Block</span> <span class="n">Storage</span><span class="p">)</span><span class="err">、</span><span class="n">EBS</span><span class="p">(</span><span class="n">Elastic</span> <span class="n">Block</span> <span class="n">Storag</span><span class="p">)</span>
        <span class="n">Cinder</span><span class="err">、</span><span class="n">Ceph</span> <span class="n">RBD</span><span class="err">、</span><span class="n">sheepdog</span>
</code></pre></div>
<p>文件系统存储</p>
<div class="highlight"><pre><span></span><code>    <span class="n">最常见</span><span class="err">、</span><span class="n">最容易</span><span class="err">、</span><span class="n">最经典实现的一种存储接口</span><span class="err">。</span><span class="n">它可以直接以文件系统挂载的方式</span><span class="err">，</span><span class="n">为主机提供存储空间资源</span><span class="err">。</span><span class="n">它有别于块存储的特点就在于</span><span class="err">，</span><span class="n">可以实现共享效果</span><span class="err">，</span><span class="n">但是有可能受网络因素限制导致速度较慢</span><span class="err">。</span>

    <span class="n">常见解决方案</span><span class="err">：</span>
        <span class="n">AFS</span><span class="p">(</span><span class="n">Azure</span> <span class="n">FileStorage</span><span class="p">)</span><span class="err">、</span><span class="n">GFS</span><span class="p">(</span><span class="n">Google</span> <span class="n">FileStorage</span><span class="p">)</span><span class="err">、</span><span class="n">EFS</span><span class="p">(</span><span class="n">Elastic</span> <span class="n">File</span> <span class="n">Storage</span><span class="p">)</span>
        <span class="n">Swift</span><span class="err">、</span><span class="n">CephFS</span><span class="err">、</span><span class="n">HDFS</span><span class="err">、</span><span class="n">NFS</span><span class="err">、</span><span class="n">CIFS</span><span class="err">、</span><span class="n">Samba</span><span class="err">、</span><span class="n">FTP</span>
</code></pre></div>
<p>对象存储</p>
<div class="highlight"><pre><span></span><code>    <span class="n">其核心是将</span> <span class="n">数据读或写</span> <span class="n">和</span> <span class="n">元数据</span> <span class="n">分离</span><span class="err">，</span><span class="n">并且基于对象存储设备</span><span class="p">(</span><span class="n">Object-based</span> <span class="n">Storage</span> <span class="n">Device</span><span class="err">，</span><span class="n">OSD</span><span class="p">)</span><span class="n">构建存储系统</span><span class="err">，</span><span class="n">然后借助于对象存储设备的管理功能</span><span class="err">，</span><span class="n">自动管理该设备上的数据分布</span><span class="err">。</span>
    <span class="n">对象存储主要包括四部分</span><span class="err">：</span><span class="n">对象</span><span class="err">、</span><span class="n">对象存储设备</span><span class="err">、</span><span class="n">元数据服务器</span><span class="err">、</span><span class="n">对象存储系统的客户端</span>

    <span class="n">简单地说</span><span class="err">，</span><span class="n">块存储读写块</span><span class="err">，</span><span class="n">不利于共享</span><span class="err">，</span><span class="n">文件存储读写慢</span><span class="err">，</span><span class="n">利于共享</span><span class="err">，</span><span class="n">而对象存储综合了两者的优点</span><span class="err">。</span>
    <span class="n">常见的解决方案</span><span class="err">：</span>
        <span class="n">AS</span><span class="p">(</span><span class="n">Azure</span> <span class="n">Storage</span><span class="p">)</span><span class="err">、</span><span class="n">GCS</span><span class="p">(</span><span class="n">Google</span> <span class="n">Cloud</span> <span class="n">Storage</span><span class="p">)</span><span class="err">、</span><span class="n">S3</span><span class="p">(</span><span class="n">Simple</span> <span class="n">Storage</span> <span class="n">Service</span><span class="p">)</span>
        <span class="n">Swift</span><span class="err">、</span><span class="n">Ceph</span> <span class="n">OSD</span>
</code></pre></div>
<p><strong>Ceph简介</strong></p>
<p>官方介绍</p>
<div class="highlight"><pre><span></span><code>    Ceph is the future of storage; where traditional(传统的) systems fail to deliver, Ceph is designed to excel(出色). Leverage(利用) your data for better business(业务) decisions(决策) and achieve(实现) operational(运营) excellence(卓越) through scalable, intelligent(智能), reliable(可靠) and highly available(可用) storage software. Ceph supports object, block and file storage, all in one unified(统一) storage system.
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">来源</span><span class="err">：</span>
    <span class="n">Ceph项目最早起源于Sage就读博士期间的工作</span><span class="err">（</span><span class="n">最早的成果于2004年发表</span><span class="err">，</span><span class="n">论文发表于2006年</span><span class="err">），</span><span class="n">并随后贡献给开源社区</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">官方地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span>
    <span class="n">官方文档</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="c">#</span>
    <span class="n">github地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span>
    <span class="n">最新版本</span><span class="err">：</span><span class="n">Quincy</span><span class="p">-</span><span class="n">17</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">3</span><span class="p">(</span><span class="n">2022</span><span class="p">-</span><span class="n">04</span><span class="p">-</span><span class="n">19</span><span class="p">)</span><span class="err">、</span><span class="n">Pacific</span><span class="p">-</span><span class="n">16</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">10</span><span class="p">(</span><span class="n">2021</span><span class="p">-</span><span class="n">03</span><span class="p">-</span><span class="n">31</span><span class="p">)</span><span class="err">、</span><span class="n">Octopus</span><span class="p">-</span><span class="n">15</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">17</span><span class="p">(</span><span class="n">2020</span><span class="p">-</span><span class="n">03</span><span class="p">-</span><span class="n">23</span><span class="p">)</span>
    <span class="n">系统支持</span><span class="err">：</span>
        <span class="n">全系列最好的系统支持是Ubuntu</span>
        <span class="n">Ceph的发展对于Centos系列和Redhat系列不友好</span><span class="err">，</span><span class="n">新版本不支持旧版本系统</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220923170114091" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220923170114091.png" /></p>
<p>软件特点</p>
<p><img alt="image-20220923163720189" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220923163720189.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">为什么很多人用ceph</span><span class="err">？</span>
    <span class="n">1</span> <span class="n">创新</span><span class="err">，</span><span class="n">Ceph能够同时提供对象存储</span><span class="err">、</span><span class="n">块存储和文件系统存储三种存储服务的统一存储架构</span>
    <span class="n">2</span> <span class="n">算法</span><span class="err">，</span><span class="n">Ceph得以摒弃了传统的集中式存储元数据寻址方案</span><span class="err">，</span><span class="n">通过Crush算法的寻址操作</span><span class="err">，</span><span class="n">有相当强大的扩展性</span><span class="err">。</span>
    <span class="n">3</span> <span class="n">可靠</span><span class="err">，</span><span class="n">Ceph中的数据副本数量可以由管理员自行定义</span><span class="err">，</span><span class="n">并可以通过Crush算法指定副本的物理存储位置以分隔故障域</span><span class="err">，</span><span class="n">支持数据强一致性的特性也使Ceph具有了高可靠性</span><span class="err">，</span><span class="n">可以忍受多种故障场景并自动尝试并行修复</span><span class="err">。</span>
</code></pre></div>
<p>基本结构</p>
<p><img alt="1636088249032" src="../../../img/kubernetes/kubernetes_storage_ceph/1636088249032.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph是一个多版本存储系统</span><span class="err">，</span><span class="n">它把每一个待管理的数据流</span><span class="err">（</span><span class="n">例如一个文件</span><span class="err">）</span> <span class="n">切分为一到多个固定大小的对象数据</span><span class="err">，</span><span class="n">并以其为原子单元完成数据存取</span><span class="err">。</span>
    <span class="n">对象数据的底层存储服务是由多个主机</span><span class="err">（</span><span class="n">host</span><span class="err">）</span><span class="n">组成的存储集群</span><span class="err">，</span><span class="n">该集群也被称之为</span> <span class="n">RADOS</span><span class="err">（</span><span class="n">Reliable</span> <span class="n">Automatic</span> <span class="n">Distributed</span> <span class="n">Object</span> <span class="n">Store</span><span class="err">）</span><span class="n">存储集群</span><span class="err">，</span><span class="n">即可靠</span><span class="err">、</span><span class="n">自动化</span><span class="err">、</span> <span class="n">分布式对象存储系统</span> 
    <span class="n">librados是RADOS存储集群的API</span><span class="err">，</span><span class="n">它支持C</span><span class="err">、</span><span class="n">C</span><span class="p">++</span><span class="err">、</span><span class="n">Java</span><span class="err">、</span><span class="n">Python</span><span class="err">、</span><span class="n">Ruby和PHP等编程语言</span><span class="err">。</span>
</code></pre></div>
<p>应用场景</p>
<div class="highlight"><pre><span></span><code>    Ceph uniquely(独特的) delivers object, block, and file storage in one unified(统一) system. 
    注意：这个介绍在官网这几年基本没有变化
</code></pre></div>
<p><img alt="1636099032730" src="../../../img/kubernetes/kubernetes_storage_ceph/1636099032730.png" /></p>
<div class="highlight"><pre><span></span><code>    RadosGW、RBD和CephFS都是RADOS存储服务的客户端，它们把RADOS的存储服务接口(librados)分别从不同的角度做了进一步抽象，因而各自适用于不同的应用场景。
    也就是说，ceph将三种存储类型统一在一个平台中，从而实现了更强大的适用性。
</code></pre></div>
<p><img alt="1636089258096" src="../../../img/kubernetes/kubernetes_storage_ceph/1636089258096.png" /></p>
<div class="highlight"><pre><span></span><code>LIBRADOS    - 通过自编程方式实现数据的存储能力
RADOSGW     - 通过标准的RESTful接口，提供一种云存储服务
RBD         - 将ceph提供的空间，模拟出来一个一个的独立块设备使用。
                而且，ceph环境部署完毕后，服务端就准备好了rbd接口
CFS         - 通过一个标准的文件系统接口来进行数据的存储

参考图例：https://docs.ceph.com/en/pacific/_images/stack.png
</code></pre></div>
<p><img alt="image-20211110140906074" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211110140906074.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="114">1.1.4 组件解析<a class="headerlink" href="#114" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 组件介绍、流程解读、小结 三个方面来学习。</p>
<p><strong>组件介绍</strong></p>
<p>组件简介</p>
<div class="highlight"><pre><span></span><code>    无论您是想向云平台提供 Ceph 对象存储和 Ceph 块设备服务、部署 Ceph 文件系统还是将 Ceph 用于其他目的，所有 Ceph 存储集群部署都从设置每个 Ceph 节点、您的网络和 Ceph 开始 存储集群。
    一个 Ceph 存储集群至少需要一个 Ceph Monitor、Ceph Manager 和 Ceph OSD（对象存储守护进程）。 运行 Ceph 文件系统客户端时也需要 Ceph 元数据服务器。
</code></pre></div>
<p><img alt="1636099270839" src="../../../img/kubernetes/kubernetes_storage_ceph/1636099270839.png" /></p>
<table>
<thead>
<tr>
<th>组件</th>
<th>解析</th>
</tr>
</thead>
<tbody>
<tr>
<td>Monitors</td>
<td>Ceph Monitor (守护进程ceph-mon) 维护集群状态的映射，包括监视器映射、管理器映射、OSD 映射、MDS 映射和 CRUSH 映射。 这些映射是 Ceph 守护进程相互协调所需的关键集群状态。 监视器还负责管理守护进程和客户端之间的身份验证。 通常至少需要三个监视器才能实现冗余和高可用性。基于 paxos 协议实现节点间的信息同步。</td>
</tr>
<tr>
<td>Managers</td>
<td>Ceph 管理器 (守护进程ceph-mgr) 负责跟踪运行时指标和 Ceph 集群的当前状态，包括存储利用率、当前性能指标和系统负载。 Ceph 管理器守护进程还托管基于 Python 的模块来管理和公开 Ceph 集群信息，包括基于 Web 的 Ceph 仪表板和 REST API。 高可用性通常至少需要两个管理器。基于 raft 协议实现节点间的信息同步。</td>
</tr>
<tr>
<td>Ceph OSDs</td>
<td>Ceph OSD（对象存储守护进程，ceph-osd）存储数据，处理数据复制、恢复、重新平衡，并通过检查其他 Ceph OSD 守护进程的心跳来向 Ceph 监视器和管理器提供一些监控信息。 通常至少需要 3 个 Ceph OSD 来实现冗余和高可用性。本质上osd就是一个个host主机上的存储磁盘。</td>
</tr>
<tr>
<td>MDSs</td>
<td>Ceph 元数据服务器（MDS[Metadata Server]、ceph-mds）代表 Ceph 文件系统存储元数据。 Ceph 元数据服务器允许 POSIX（为应用程序提供的接口标准） 文件系统用户执行基本命令（如 ls、find 等），而不会给 Ceph 存储集群带来巨大负担。</td>
</tr>
<tr>
<td>PG</td>
<td>PG全称Placement Grouops，是一个逻辑的概念，一个PG包含多个OSD。引入PG这一层其实是为了更好的分配数据和定位数据。写数据的时候，写入主osd，冗余两份。</td>
</tr>
</tbody>
</table>
<p><strong>流程解读</strong></p>
<p>综合效果图</p>
<p><img alt="1636104082951" src="../../../img/kubernetes/kubernetes_storage_ceph/1636104082951.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph</span> <span class="n">将数据作为对象存储在逻辑存储池中</span><span class="err">，</span><span class="n">主要包括两步</span><span class="err">：</span>
    <span class="n">把对象数据</span> <span class="n">映射给</span> <span class="n">PG</span>    
        <span class="p">-</span> <span class="n">计算出哪个归置组应该包含该对象</span>
        <span class="p">-</span> <span class="n">这部分功能是由Hash算法实现的</span>
    <span class="n">把</span> <span class="n">PG</span> <span class="n">映射到</span> <span class="n">host的OSD</span> 
        <span class="p">-</span> <span class="n">计算出哪个</span> <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">Daemon</span> <span class="n">应该存储该归置组</span>
        <span class="p">-</span> <span class="n">这部分由</span> <span class="n">CRUSH算法来决定的</span><span class="err">，</span><span class="n">CRUSH</span> <span class="n">算法使</span> <span class="n">Ceph</span> <span class="n">存储集群能够动态扩展</span><span class="err">、</span><span class="n">重新平衡和恢复</span><span class="err">。</span>
</code></pre></div>
<p>数据存储逻辑</p>
<p><img alt="1636103641572" src="../../../img/kubernetes/kubernetes_storage_ceph/1636103641572.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="115">1.1.5 存储原理<a class="headerlink" href="#115" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 存储解读、案例解读、小结 三个方面来学习。</p>
<p><strong>存储解读</strong></p>
<p>存储数据</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">存储集群从</span> <span class="n">Ceph</span> <span class="n">客户端接收数据</span><span class="p">,</span><span class="n">无论是通过</span> <span class="n">Ceph</span> <span class="n">块设备</span><span class="err">、</span><span class="n">Ceph</span> <span class="n">对象存储</span><span class="err">、</span><span class="n">Ceph</span> <span class="n">文件系统还是您使用</span> <span class="n">librados</span> <span class="n">创建的自定义实现</span><span class="p">,</span> <span class="n">这些数据存储为</span> <span class="n">RADOS</span> <span class="n">对象</span><span class="p">,</span> <span class="n">每个对象都存储在一个对象存储设备上</span><span class="err">。</span>
    <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">守护进程处理存储驱动器上的读</span><span class="err">、</span><span class="n">写和复制操作</span><span class="err">。</span><span class="n">它主要基于两种文件方式实现</span><span class="err">：</span>
        <span class="p">-</span> <span class="n">Filestore方式</span><span class="err">，</span><span class="n">每个</span> <span class="n">RADOS</span> <span class="n">对象都作为一个单独的文件存储在传统文件系统</span><span class="err">（</span><span class="n">通常是</span> <span class="n">XFS</span><span class="err">）</span><span class="n">上</span><span class="err">。</span> 
        <span class="p">-</span> <span class="n">BlueStore方式</span><span class="err">，</span><span class="n">对象以类似整体数据库的方式存储</span><span class="err">，</span><span class="n">这是新版本ceph默认的存储方式</span><span class="err">。</span>

    <span class="n">注意</span><span class="err">：</span><span class="n">在Ceph中</span><span class="err">，</span><span class="n">每一个文件都会被拆分为多个独立的object</span><span class="err">，</span><span class="n">然后按照上面的逻辑进行持久化</span><span class="err">。</span>
</code></pre></div>
<p><img alt="1636104261047" src="../../../img/kubernetes/kubernetes_storage_ceph/1636104261047.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">守护进程将</span><span class="s2">&quot;数据&quot;</span><span class="n">作为对象存储在平面命名空间中</span><span class="p">,</span><span class="n">该对象包括如下部分</span><span class="err">：</span>
        <span class="n">标识符</span> <span class="p">-</span> <span class="n">在内存中唯一查找的标识</span>
        <span class="n">二进制数据</span> <span class="p">-</span> <span class="n">每个对象的真实数据</span>
        <span class="n">属性数据</span> <span class="p">-</span> <span class="n">由一组名称</span><span class="p">/</span><span class="n">值对组成的元数据</span><span class="err">，</span><span class="n">语义完全取决于</span> <span class="n">Ceph</span> <span class="n">客户端</span><span class="err">。</span> 
    <span class="n">例如</span><span class="err">，</span><span class="n">CephFS</span> <span class="n">使用元数据来存储文件属性</span><span class="err">，</span><span class="n">例如文件所有者</span><span class="err">、</span><span class="n">创建日期</span><span class="err">、</span><span class="n">上次修改日期等</span><span class="err">。</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">对象</span> <span class="n">ID</span> <span class="n">在整个集群中是唯一的</span><span class="err">，</span><span class="n">而不仅仅是本地文件系统</span><span class="p">.</span>
</code></pre></div>
<p><img alt="1636104309671" src="../../../img/kubernetes/kubernetes_storage_ceph/1636104309671.png" /></p>
<p><strong>案例解读</strong></p>
<p>存储示例</p>
<div class="highlight"><pre><span></span><code><span class="n">存储一个大小为16M的文件</span><span class="err">，</span><span class="n">存储的时候</span><span class="err">，</span><span class="n">需要首先进行切割</span><span class="err">，</span><span class="n">假设每个对象</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="n">大小为4M</span><span class="p">,</span><span class="n">然后通过hash方式将object存储到对应的PG上</span><span class="err">，</span><span class="n">然后通过</span> <span class="n">CRUSH</span> <span class="n">策略将对应的数据关联到不同的host上</span><span class="err">。</span>
    <span class="n">这个时候遇到一个问题</span><span class="err">：</span><span class="n">osd是一个磁盘设备</span><span class="err">，</span><span class="n">那么如何来进行存储数据</span>

<span class="n">常见的处理措施主要有两种</span><span class="err">：</span>
    <span class="n">第一种</span><span class="err">：</span><span class="n">将osd格式化为文件系统</span><span class="err">，</span><span class="n">然后挂载到对应目录</span><span class="err">，</span><span class="n">然后就可以使用了</span>
    <span class="n">第二种</span><span class="err">：</span><span class="n">osd有自己的守护进程</span><span class="err">，</span><span class="n">那么直接在守护进程空间中实现数据的处理</span>
</code></pre></div>
<p>方法1 - FileStore</p>
<p><img alt="1636105592444" src="../../../img/kubernetes/kubernetes_storage_ceph/1636105592444.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">这个时候</span><span class="err">，</span><span class="n">osd就变成一个文件系统中的文件</span><span class="p">(</span><span class="n">目录</span><span class="p">)</span><span class="n">了</span><span class="err">。</span>
    <span class="n">因此</span><span class="err">，</span><span class="n">OSD需要维护object的对象属性信息</span><span class="err">，</span><span class="n">object的元数据保存到</span> <span class="n">osd</span><span class="p">(</span><span class="n">文件系统</span><span class="p">)</span><span class="n">的元数据区</span><span class="err">。</span>
    <span class="n">但是文件系统的元数据区只能存放文件的</span> <span class="n">属主</span><span class="err">、</span><span class="n">属组</span><span class="err">、</span><span class="n">权限</span><span class="err">、</span><span class="n">时间戳等信息</span><span class="err">。</span><span class="n">对于ceph来说</span><span class="err">，</span><span class="n">object的元数据信息却包含很多相关信息</span><span class="err">，</span><span class="n">那么这些数据保存到哪里</span><span class="err">？</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">那么为了保存文件系统默认能够保存的数据之外的元数据</span><span class="p">(</span><span class="n">object对象的其他元数据信息</span><span class="p">)</span><span class="err">，</span><span class="n">我们就需要将OSD做成一个XFS文件系统</span><span class="err">，</span><span class="n">在这个文件系统中</span><span class="err">，</span><span class="n">需要有一个单独的数据库</span><span class="p">(</span><span class="n">LevelDB</span><span class="p">)</span><span class="err">，</span><span class="n">来维护ceph的元数据信息</span><span class="err">，</span><span class="n">效果如下</span>
</code></pre></div>
<p><img alt="1636106662704" src="../../../img/kubernetes/kubernetes_storage_ceph/1636106662704.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">由于这种方式是基于文件系统映射的方式来实现</span> <span class="n">ceph的属性存储</span><span class="err">，</span><span class="n">所以我们把这种文件的存储方式称为</span> <span class="n">FiltStore</span><span class="err">。</span>
<span class="n">劣势</span><span class="err">：</span>
    <span class="n">由于我们的object本来已经称为对象了</span><span class="err">，</span><span class="n">而在FileStore中</span><span class="err">，</span><span class="n">我们需要将其转换为文件方式来进行数据属性的存储</span><span class="err">，</span><span class="n">所以效率有些慢</span>

<span class="n">附注</span><span class="err">：</span>
    <span class="n">XFS是被开发用于高容量磁盘以及高性能文件系统之用的</span><span class="err">。</span><span class="n">主要规划为三个部分</span><span class="err">：</span>
    <span class="n">资料区</span><span class="err">（</span><span class="n">data</span> <span class="n">section</span><span class="err">）</span><span class="p">-</span> <span class="n">存储包括inode</span><span class="err">、</span><span class="n">block</span><span class="err">、</span><span class="n">superblock等数据</span>
    <span class="n">文件系统活动登录区</span><span class="err">（</span><span class="n">log</span> <span class="n">section</span><span class="err">）</span> <span class="p">-</span> <span class="n">用来记录文件系统的变化</span>
    <span class="n">实时运作</span><span class="err">（</span><span class="n">realtime</span> <span class="n">section</span><span class="err">）</span><span class="p">-</span> <span class="n">数据真正存储的地方</span>
</code></pre></div>
<p>方法2 - BlueStore</p>
<div class="highlight"><pre><span></span><code>    <span class="n">因为osd对象是由一个ceph-osd守护进程来实现存储数据</span><span class="err">、</span><span class="n">处理数据复制</span><span class="err">、</span><span class="n">恢复</span><span class="err">、</span><span class="n">重新平衡等管理操作的</span><span class="err">。</span><span class="n">所以新版的Ceph的osd进程中</span><span class="err">，</span><span class="n">维护了一个RocksDB用于存储objects的元数据属性信息</span><span class="p">.</span>
    <span class="n">RocksDB为了实现数据的存储还需要一个文件系统</span><span class="err">，</span><span class="n">所以Ceph就为它开发了一个文件系统</span> <span class="n">BlueFS</span><span class="err">。</span>

    <span class="n">RocksDB</span> <span class="p">+</span> <span class="n">BlueFS</span> <span class="n">共同实现了objects的元数据的存储</span><span class="err">，</span><span class="n">所以我们把这种存储方式称为</span> <span class="n">BlueStore</span><span class="err">。</span><span class="n">新版的Ceph的存储机制</span><span class="err">，</span><span class="n">默认采用的就是</span> <span class="n">BlueStore机制</span><span class="err">。</span>
</code></pre></div>
<p><img alt="1636107225026" src="../../../img/kubernetes/kubernetes_storage_ceph/1636107225026.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="12">1.2 集群部署<a class="headerlink" href="#12" title="Permanent link">&para;</a></h2>
<h3 id="121">1.2.1 环境概述<a class="headerlink" href="#121" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、环境规划、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>注意事项</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在Ceph系统的搭建过程中</span><span class="p">,</span><span class="n">会出现各种意想不到或者预想到问题</span><span class="err">，</span><span class="n">就算整个过程中每一步都没问题</span><span class="err">，</span><span class="n">还是会出现各种问题</span><span class="err">，</span><span class="n">这些问题不仅仅在网上找不到</span><span class="err">，</span><span class="n">甚至在官网中找不到</span><span class="err">，</span><span class="n">甚至玩ceph数年的人都解决不了</span><span class="err">。</span>
    <span class="n">尤其是</span><span class="err">，</span><span class="n">就算你第一次成功后</span><span class="err">，</span><span class="n">第二次重试就会出现问题</span><span class="err">。</span><span class="n">所以</span><span class="err">，</span><span class="n">如果出现问题怎么办</span><span class="err">？</span><span class="n">一步一步踏踏实实的进行研究</span><span class="err">，</span><span class="n">分析解决问题</span><span class="err">，</span><span class="n">并进行总结并梳理成册就可以了</span><span class="err">。</span>
</code></pre></div>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">ceph的环境部署是非常繁琐的</span><span class="err">，</span><span class="n">所以</span><span class="err">，</span><span class="n">官方帮我们提供了很多的快捷部署方式</span><span class="err">。</span>
<span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">pacific</span><span class="p">/</span><span class="n">install</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">推荐方法</span><span class="err">：</span>
<span class="n">Cephadm</span> 
    <span class="n">使用容器和</span> <span class="n">systemd</span> <span class="n">安装和管理</span> <span class="n">Ceph</span> <span class="n">集群</span><span class="err">，</span><span class="n">并与</span> <span class="nb">CLI </span><span class="n">和仪表板</span> <span class="n">GUI</span> <span class="n">紧密集成</span><span class="err">。</span>
    <span class="n">仅支持</span> <span class="n">Octopus</span> <span class="n">和更新版本</span><span class="err">，</span><span class="n">需要容器和</span> <span class="n">Python3支持</span>
    <span class="n">与新的编排</span> <span class="n">API</span> <span class="n">完全集成</span>
<span class="n">Rook</span>
    <span class="n">在</span> <span class="n">Kubernetes</span> <span class="n">中运行的</span> <span class="n">Ceph</span> <span class="n">集群</span><span class="err">，</span><span class="n">同时还支持通过</span> <span class="n">Kubernetes</span> <span class="n">API</span> <span class="n">管理存储资源和配置</span><span class="err">。</span>
    <span class="n">仅支持</span> <span class="n">Nautilus</span> <span class="n">和较新版本的</span> <span class="n">Ceph</span>

<span class="n">其他方法</span>
<span class="n">ceph-ansible</span>    <span class="n">使用Ansible部署Ceph集群</span><span class="err">，</span><span class="n">对于新的编排器功能</span><span class="err">、</span><span class="n">管理功能和仪表板支持不好</span><span class="err">。</span>
<span class="n">ceph-deploy</span>     <span class="n">是一个快速部署集群的工具</span><span class="err">，</span><span class="n">不支持Centos8</span>
<span class="n">DeepSea</span>         <span class="n">使用</span> <span class="n">Salt</span> <span class="n">安装</span> <span class="n">Ceph</span>
<span class="n">ceph-mon</span>        <span class="n">使用</span> <span class="n">Juju</span> <span class="n">安装</span> <span class="n">Ceph</span>
<span class="n">Puppet-ceph</span>     <span class="n">通过</span> <span class="n">Puppet</span> <span class="n">安装</span> <span class="n">Ceph</span>
<span class="n">二进制源码</span>        <span class="n">手工安装</span>
<span class="n">windows图形</span>      <span class="n">在windows主机上</span><span class="err">，</span><span class="n">通过鼠标点点点的方式进行部署</span><span class="err">。</span>
</code></pre></div>
<p>版本的选择</p>
<div class="highlight"><pre><span></span><code><span class="n">版本地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span>
<span class="n">最新版本</span><span class="err">：</span><span class="n">官网版本</span> <span class="n">v16</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">10</span> <span class="n">Pacific</span>
<span class="n">版本特性</span><span class="err">：</span><span class="n">x</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">z</span><span class="p">(</span><span class="n">开发版</span><span class="p">)</span><span class="err">、</span><span class="n">x</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">z</span><span class="p">(</span><span class="n">候选版</span><span class="p">)</span><span class="err">、</span><span class="n">x</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">z</span><span class="p">(</span><span class="n">稳定</span><span class="err">、</span><span class="n">修正版</span><span class="p">)</span>
</code></pre></div>
<p><strong>环境规划</strong></p>
<p>网络规划</p>
<p><img alt="image-20211110140641473" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211110140641473.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">公有网络</span><span class="p">(</span><span class="n">public</span><span class="p">)</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">用于用户的数据通信</span>
    <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
<span class="n">集群网络</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">用于集群内部的管理通信</span>
    <span class="p">-</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
</code></pre></div>
<p>主机规划</p>
<div class="highlight"><pre><span></span><code><span class="n">磁盘规划</span>
    <span class="n">磁盘1</span> <span class="p">-</span> <span class="n">VM的系统盘</span>
    <span class="n">磁盘2和磁盘3</span> <span class="p">-</span> <span class="n">Ceph的OSD</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">主机名规划</span>   
    <span class="n">主机名</span>    <span class="n">公有网络</span>     <span class="n">私有网络</span>        <span class="n">磁盘</span>         <span class="n">其他角色</span>
    <span class="n">admin</span>   <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">12</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>
    <span class="n">stor01</span>  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">13</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>     <span class="n">mon01</span>
    <span class="n">stor02</span>  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">14</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>     <span class="n">mon02</span>
    <span class="n">stor03</span>  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">15</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>     <span class="n">mon03</span>
    <span class="n">stor04</span>  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">16</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>     
    <span class="n">stor05</span>  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">17</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>
    <span class="n">stor06</span>  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">18</span>    <span class="n">sdb</span><span class="err">、</span><span class="n">sdc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">由于生产中</span><span class="err">，</span><span class="n">ceph的集群角色是非常多的</span><span class="err">，</span><span class="n">当我们的主机量少的时候</span><span class="err">，</span><span class="n">只能让一台主机节点运行多个角色</span><span class="err">。</span>
        <span class="n">stor01</span><span class="p">~</span><span class="n">03</span> <span class="n">这三台主机</span><span class="err">，</span><span class="n">还同时兼具</span> <span class="n">mon的角色</span><span class="err">，</span><span class="n">视情况兼容mgr角色</span>
        <span class="n">主机名的完整格式是</span><span class="err">：</span> <span class="n">xxx</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> 
</code></pre></div>
<p>其他准备</p>
<div class="highlight"><pre><span></span><code><span class="n">管理用户</span>
    <span class="n">由于我们接下来的所有操作</span><span class="err">，</span><span class="n">基本上都在</span> <span class="n">admin这个主机上来运行</span><span class="err">，</span><span class="n">所以</span><span class="err">，</span><span class="n">我们不推荐直接使用root用户来管理</span><span class="err">，</span><span class="n">倾向于通过一个普通用户来操作接下来的操作</span><span class="err">。</span>
    <span class="n">由于后续的安装软件</span><span class="err">，</span><span class="n">涉及到root用户权限的操作</span><span class="err">，</span><span class="n">所以这个普通用户最好具备sudo的权限</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">时间同步</span>
    <span class="n">对于任何一个集群来说</span><span class="err">，</span><span class="n">时间同步是非常重要的</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">主机名规划</span>
    <span class="n">随着生产中的主机节点越来越多</span><span class="err">，</span><span class="n">我们通过手工定制主机名的方式就不太适合集群的主机管理了</span><span class="err">。</span><span class="n">所以在企业中</span><span class="err">，</span><span class="n">我们的主机名相关的信息</span><span class="err">，</span><span class="n">倾向于通过内网dns来进行管理</span><span class="err">。</span>
    <span class="n">尤其是等我们到</span> <span class="n">radosgw的时候</span><span class="err">，</span><span class="n">必须通过泛域名解析的机制来实现</span><span class="err">，</span><span class="n">更强大的面向客户端的主机名管理体系</span><span class="err">。</span>
</code></pre></div>
<p>VM主机准备</p>
<p><img alt="image-20211108105810433" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211108105810433.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">所有节点都准备三块盘</span><span class="err">，</span><span class="n">两块网卡</span>
<span class="n">虚拟网络设置</span><span class="err">：</span>
    <span class="n">VMnet1</span> <span class="n">设定为</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">0</span> <span class="n">网段</span><span class="err">，</span> <span class="n">VMnet8</span> <span class="n">设定为</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="n">网段</span>
<span class="n">虚拟机设置</span>
    <span class="n">额外添加两块盘</span><span class="err">，</span><span class="n">每个根据自己的情况设定容量</span><span class="err">，</span><span class="n">我这里设定为20G</span>
    <span class="n">额外更加一块网络适配器</span><span class="err">，</span><span class="n">使用仅主机模式</span> <span class="p">--</span> <span class="n">VMnet1</span><span class="err">，</span><span class="n">mac地址必须要重新生成</span><span class="err">，</span><span class="n">避免冲突</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="122">1.2.2 准备工作<a class="headerlink" href="#122" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基本环境、软件安装、小结 三个方面来学习。</p>
<p><strong>基本环境</strong></p>
<p>主机名管理</p>
<div class="highlight"><pre><span></span><code><span class="n">编辑</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">hosts</span> <span class="n">文件</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">admin</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">admin</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">stor01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">stor01</span> <span class="n">mon01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">mon01</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="n">stor02</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">stor02</span> <span class="n">mon02</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">mon02</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">stor03</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">stor03</span> <span class="n">mon03</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">mon03</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">stor04</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">stor05</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">stor05</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span> <span class="n">stor06</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">stor06</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">后续可能会涉及到k8s环境的部署</span><span class="err">，</span><span class="n">所以hosts文件有可能会发生变动</span><span class="err">。</span>
</code></pre></div>
<p>防火墙管理</p>
<div class="highlight"><pre><span></span><code><span class="n">关闭防火墙</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">iptables</span> <span class="n">firewalld</span> 
<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">iptables</span> <span class="n">firewalld</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">iptables</span> <span class="n">firewalld</span> 
</code></pre></div>
<p>跨主机通信</p>
<div class="highlight"><pre><span></span><code><span class="n">脚本文件名称</span> <span class="n">01_remote_host_auth</span><span class="p">.</span><span class="n">sh</span> 
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 批量设定远程主机免密码认证</span>
<span class="c"># 版本: v0.2</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>
<span class="n">user_dir</span><span class="p">=</span><span class="s1">&#39;/root&#39;</span>
<span class="n">host_file</span><span class="p">=</span><span class="s1">&#39;/etc/hosts&#39;</span>
<span class="n">login_user</span><span class="p">=</span><span class="s1">&#39;root&#39;</span>
<span class="n">login_pass</span><span class="p">=</span><span class="s1">&#39;123456&#39;</span>
<span class="n">target_type</span><span class="p">=(</span><span class="n">部署</span> <span class="n">免密</span> <span class="n">同步</span> <span class="n">主机名</span> <span class="n">退出</span><span class="p">)</span>

<span class="c"># 菜单</span>
<span class="n">menu</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[31m批量设定远程主机免密码认证管理界面\e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 1: 部署环境   2: 免密认证   3: 同步hosts \e[0m&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 4: 设定主机名 5：退出操作 \e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
<span class="p">}</span>
<span class="c"># expect环境</span>
<span class="n">expect_install</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">[</span> <span class="o">-f</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">expect</span> <span class="p">]</span>
  <span class="n">then</span>
     <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect环境已经部署完毕\e[0m&quot;</span>
  <span class="k">else</span>
     <span class="n">yum</span> <span class="n">install</span> <span class="n">expect</span> <span class="n">-y</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">null</span> <span class="n">2</span><span class="p">&gt;&amp;</span><span class="n">1</span> <span class="p">&amp;&amp;</span> <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装完毕\e[0m&quot;</span> <span class="p">||</span> <span class="p">(</span><span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装失败\e[0m&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">exit</span><span class="p">)</span>
  <span class="n">fi</span>
<span class="p">}</span>
<span class="c"># 秘钥文件生成环境</span>
<span class="n">create_authkey</span><span class="p">(){</span>
  <span class="c"># 保证历史文件清空</span>
  <span class="p">[</span> <span class="n">-d</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span> <span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="nb">rm </span><span class="n">-rf</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/*</span> <span class="p">||</span> <span class="n">mkdir</span> <span class="n">-p</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span> 
  <span class="c"># 构建秘钥文件对</span>
  <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ssh-keygen</span> <span class="n">-t</span> <span class="n">rsa</span> <span class="n">-P</span> <span class="s2">&quot;&quot;</span> <span class="o">-f</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33m秘钥文件已经创建完毕\e[0m&quot;</span>
<span class="p">}</span>
<span class="c"># expect自动匹配逻辑</span>
<span class="n">expect_autoauth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部参数</span>
  <span class="n">command</span><span class="p">=</span><span class="s2">&quot;$@&quot;</span>
  <span class="n">expect</span> <span class="n">-c</span> <span class="s2">&quot;</span>
<span class="s2">    spawn ${command}</span>
<span class="s2">    expect {</span>
<span class="s2">      \&quot;</span><span class="n">yes</span><span class="p">/</span><span class="n">no</span><span class="p">\</span><span class="s2">&quot; {send \&quot;</span><span class="n">yes</span><span class="p">\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;}</span>
<span class="s2">   }&quot;</span>
<span class="p">}</span>
<span class="c"># 跨主机传输文件认证</span>
<span class="n">sshkey_auth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="c"># /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12</span>
     <span class="n">cmd</span><span class="p">=</span><span class="s2">&quot;/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub&quot;</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">expect_autoauth_func</span> <span class="p">${</span><span class="n">cmd</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 跨主机同步hosts文件</span>
<span class="n">scp_hosts_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">scp</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}:${</span><span class="n">host_file</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 跨主机设定主机名规划</span>
<span class="n">set_hostname_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="n">host_name</span><span class="p">=$(</span><span class="n">grep</span> <span class="p">${</span><span class="n">ip</span><span class="p">}</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}|</span><span class="n">awk</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">ssh</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span> <span class="s2">&quot;hostnamectl set-hostname ${host_name}&quot;</span>
  <span class="n">done</span>
<span class="p">}</span>
<span class="c"># 帮助信息逻辑</span>
<span class="n">Usage</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="s2">&quot;请输入有效的操作id&quot;</span>
<span class="p">}</span>
<span class="c"># 逻辑入口</span>
<span class="k">while</span> <span class="n">true</span>
<span class="k">do</span>
  <span class="n">menu</span>
  <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入有效的操作id: &quot;</span> <span class="n">target_id</span>
  <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="c">#target_type[@]} -ge ${target_id} ]</span>
  <span class="n">then</span>
    <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;部署&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始部署环境操作...&quot;</span>
       <span class="n">expect_install</span>
       <span class="n">create_authkey</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;免密&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行免密认证操作...&quot;</span>
       <span class="n">sshkey_auth_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;同步&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行同步hosts文件操作...&quot;</span>
       <span class="n">scp_hosts_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;主机名&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行设定主机名操作...&quot;</span>
       <span class="n">set_hostname_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;退出&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始退出管理界面...&quot;</span>
       <span class="n">exit</span>
    <span class="n">fi</span>
  <span class="k">else</span>
    <span class="n">Usage</span>
  <span class="n">fi</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">执行脚本文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/01_remote_host_auth.sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">同步hosts</span>
 <span class="n">4</span><span class="p">:</span> <span class="n">设定主机名</span> <span class="n">5</span><span class="err">：</span><span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">1</span>
<span class="n">开始部署环境操作</span><span class="p">...</span>
<span class="n">expect环境已经部署完毕</span>
<span class="n">Generating</span> <span class="n">public</span><span class="p">/</span><span class="n">private</span> <span class="n">rsa</span> <span class="n">key</span> <span class="n">pair</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">identification</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">public</span> <span class="n">key</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span><span class="p">.</span>
<span class="n">The</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="n">is</span><span class="p">:</span>
<span class="n">SHA256</span><span class="p">:</span><span class="n">DNQAfWAD3MYPywK4W0BrNsgK</span><span class="p">+</span><span class="n">u3ysliuI6QdF3BOuyc</span> <span class="n">root</span><span class="nv">@localhost</span>
<span class="n">The</span> <span class="n">key</span><span class="s1">&#39;s randomart image is:</span>
<span class="s1">+---[RSA 2048]----+</span>
<span class="s1">|.o .o**+         |</span>
<span class="s1">|= + +o*.o        |</span>
<span class="s1">|oO * +.=         |</span>
<span class="s1">|B o = oo.        |</span>
<span class="s1">|oo   +  S        |</span>
<span class="s1">|.o..E .          |</span>
<span class="s1">|o.oo.o           |</span>
<span class="s1">|+++.             |</span>
<span class="s1">|+oo=o            |</span>
<span class="s1">+----[SHA256]-----+</span>
<span class="s1">秘钥文件已经创建完毕</span>
<span class="s1">批量设定远程主机免密码认证管理界面</span>
<span class="s1">=====================================================</span>
<span class="s1"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s1"> 4: 设定主机名 5：退出操作</span>
<span class="s1">=====================================================</span>
<span class="s1">请输入有效的操作id: 2</span>
<span class="s1">请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {12..18}</span>
<span class="s1">开始执行免密认证操作...</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="s1">&#39;&quot;</span>
<span class="s1">and check to make sure that only the key(s) you wanted were added.</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="err">&#39;</span><span class="s2">&quot;</span>
<span class="s2">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 3</span>
<span class="s2">请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): {12..18}</span>
<span class="s2">开始执行同步hosts文件操作...</span>
<span class="s2">hosts   100%  520     1.2MB/s   00:00</span>
<span class="s2">...</span>
<span class="s2">hosts   100%  520   403.3KB/s   00:00</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 4</span>
<span class="s2">请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): {12..18}</span>
<span class="s2">开始执行设定主机名操作...</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 5</span>
<span class="s2">开始退出管理界面...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># for i in {12..18}; do hostname=$(ssh root@10.0.0.$i &quot;hostname&quot;); echo &quot;10.0.0.$i - $hostname&quot;; done</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">-</span> <span class="n">admin</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="p">-</span> <span class="n">mon01</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="p">-</span> <span class="n">mon02</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="p">-</span> <span class="n">mon03</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="p">-</span> <span class="n">stor04</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="p">-</span> <span class="n">stor05</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span> <span class="p">-</span> <span class="n">stor06</span>
</code></pre></div>
<p><strong>软件安装</strong></p>
<p>用户管理</p>
<div class="highlight"><pre><span></span><code><span class="n">创建普通用户</span>
<span class="n">useradd</span> <span class="n">-m</span> <span class="n">cephadm</span> <span class="n">-s</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span>
<span class="nb">echo </span><span class="n">cephadm</span><span class="p">:</span><span class="n">123456</span> <span class="p">|</span> <span class="n">chpasswd</span>

<span class="n">为用户配置root权限</span>
<span class="nb">echo </span><span class="s2">&quot;cephadm ALL = (root) NOPASSWD:ALL&quot;</span> <span class="p">|</span> <span class="n">sudo</span> <span class="nb">tee </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sudoers</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">cephadm</span> 
<span class="n">chmod</span> <span class="n">0440</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sudoers</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">cephadm</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">切换用户时候不输出最近登录信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># grep  &quot;se.*postlogin&quot; /etc/pam.d/su</span>
<span class="c"># session               include         postlogin</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">脚本方法</span> <span class="n">02_create_ceph_user</span><span class="p">.</span><span class="n">sh</span> 
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 创建专属的ceph管理用户</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>
<span class="n">login_user</span><span class="p">=</span><span class="s1">&#39;cephadm&#39;</span>
<span class="n">login_pass</span><span class="p">=</span><span class="s1">&#39;123456&#39;</span>

<span class="c"># 设定普通用户</span>
<span class="n">useradd</span> <span class="n">-m</span> <span class="p">${</span><span class="n">login_user</span><span class="p">}</span> <span class="n">-s</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span>
<span class="nb">echo </span><span class="p">${</span><span class="n">login_user</span><span class="p">}:${</span><span class="n">login_pass</span><span class="p">}</span> <span class="p">|</span> <span class="n">chpasswd</span>
<span class="nb">echo </span><span class="s2">&quot;${login_user} ALL = (root) NOPASSWD:ALL&quot;</span> <span class="p">|</span> <span class="n">sudo</span> <span class="nb">tee </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sudoers</span><span class="p">.</span><span class="n">d</span><span class="p">/${</span><span class="n">login_user</span><span class="p">}</span> 
<span class="n">chmod</span> <span class="n">0440</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sudoers</span><span class="p">.</span><span class="n">d</span><span class="p">/${</span><span class="n">login_user</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">批量执行</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">18</span><span class="p">}</span>
<span class="k">do</span>
  <span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;mkdir /data/scripts -p&quot;</span>
  <span class="n">scp</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">02_create_ceph_user</span><span class="p">.</span><span class="n">sh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span><span class="p">:/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">02_create_ceph_user</span><span class="p">.</span><span class="n">sh</span>
  <span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;/bin/bash /data/scripts/02_create_ceph_user.sh&quot;</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># for i in {12..18}; do usermsg=$(ssh root@10.0.0.$i &quot;id cephadm&quot;); echo &quot;10.0.0.$i - $usermsg&quot;; done</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span> <span class="p">-</span> <span class="n">uid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">gid</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span> <span class="n">组</span><span class="p">=</span><span class="n">1001</span><span class="p">(</span><span class="n">cephadm</span><span class="p">)</span>
</code></pre></div>
<p>跨主机免密码认证</p>
<div class="highlight"><pre><span></span><code><span class="n">脚本文件内容</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_remote_cephadm_auth</span><span class="p">.</span><span class="n">sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 批量设定远程主机免密码认证</span>
<span class="c"># 版本: v0.3</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>
<span class="n">user_dir</span><span class="p">=</span><span class="s1">&#39;/home/cephadm&#39;</span>
<span class="n">login_user</span><span class="p">=</span><span class="s1">&#39;cephadm&#39;</span>
<span class="n">login_pass</span><span class="p">=</span><span class="s1">&#39;123456&#39;</span>
<span class="n">host_file</span><span class="p">=</span><span class="s1">&#39;/etc/hosts&#39;</span>
<span class="n">target_type</span><span class="p">=(</span><span class="n">部署</span> <span class="n">免密</span> <span class="n">退出</span><span class="p">)</span>

<span class="c"># 菜单</span>
<span class="n">menu</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[31m批量设定远程主机免密码认证管理界面\e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 1: 部署环境   2: 免密认证   3: 退出操作 \e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
<span class="p">}</span>
<span class="c"># expect环境</span>
<span class="n">expect_install</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">[</span> <span class="o">-f</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">expect</span> <span class="p">]</span>
  <span class="n">then</span>
     <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect环境已经部署完毕\e[0m&quot;</span>
  <span class="k">else</span>
     <span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">expect</span> <span class="n">-y</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">null</span> <span class="n">2</span><span class="p">&gt;&amp;</span><span class="n">1</span> <span class="p">&amp;&amp;</span> <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装完毕\e[0m&quot;</span> <span class="p">||</span> <span class="p">(</span><span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装失败\e[0m&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">exit</span><span class="p">)</span>
  <span class="n">fi</span>
<span class="p">}</span>
<span class="c"># 秘钥文件生成环境</span>
<span class="n">create_authkey</span><span class="p">(){</span>
  <span class="c"># 保证历史文件清空</span>
  <span class="p">[</span> <span class="n">-d</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span> <span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="nb">rm </span><span class="n">-rf</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/*</span>
  <span class="c"># 构建秘钥文件对</span>
  <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ssh-keygen</span> <span class="n">-t</span> <span class="n">rsa</span> <span class="n">-P</span> <span class="s2">&quot;&quot;</span> <span class="o">-f</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33m秘钥文件已经创建完毕\e[0m&quot;</span>
<span class="p">}</span>
<span class="c"># expect自动匹配逻辑</span>
<span class="n">expect_autoauth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部参数</span>
  <span class="n">command</span><span class="p">=</span><span class="s2">&quot;$@&quot;</span>
  <span class="n">expect</span> <span class="n">-c</span> <span class="s2">&quot;</span>
<span class="s2">    spawn ${command}</span>
<span class="s2">    expect {</span>
<span class="s2">      \&quot;</span><span class="n">yes</span><span class="p">/</span><span class="n">no</span><span class="p">\</span><span class="s2">&quot; {send \&quot;</span><span class="n">yes</span><span class="p">\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;}</span>
<span class="s2">   }&quot;</span>
<span class="p">}</span>
<span class="c"># 跨主机传输文件认证</span>
<span class="n">sshkey_auth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="c"># /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12</span>
     <span class="n">cmd</span><span class="p">=</span><span class="s2">&quot;/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub&quot;</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">host_name</span><span class="p">=$(</span><span class="n">grep</span> <span class="p">${</span><span class="n">ip</span><span class="p">}</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}|</span><span class="n">awk</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
     <span class="n">remote_host1</span><span class="p">=</span><span class="s2">&quot;${login_user}@${host_name}&quot;</span>
     <span class="n">remote_host2</span><span class="p">=</span><span class="s2">&quot;${login_user}@${host_name}.superopsmsb.com&quot;</span>
     <span class="n">expect_autoauth_func</span> <span class="p">${</span><span class="n">cmd</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span>
     <span class="n">expect_autoauth_func</span> <span class="p">${</span><span class="n">cmd</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host1</span><span class="p">}</span>
     <span class="n">expect_autoauth_func</span> <span class="p">${</span><span class="n">cmd</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host2</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 帮助信息逻辑</span>
<span class="n">Usage</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="s2">&quot;请输入有效的操作id&quot;</span>
<span class="p">}</span>
<span class="c"># 逻辑入口</span>
<span class="k">while</span> <span class="n">true</span>
<span class="k">do</span>
  <span class="n">menu</span>
  <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入有效的操作id: &quot;</span> <span class="n">target_id</span>
  <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="c">#target_type[@]} -ge ${target_id} ]</span>
  <span class="n">then</span>
    <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;部署&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始部署环境操作...&quot;</span>
       <span class="n">expect_install</span>
       <span class="n">create_authkey</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;免密&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行免密认证操作...&quot;</span>
       <span class="n">sshkey_auth_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;退出&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始退出管理界面...&quot;</span>
       <span class="n">exit</span>
    <span class="n">fi</span>
  <span class="k">else</span>
    <span class="n">Usage</span>
  <span class="n">fi</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">更改文件权限</span>
<span class="n">chown</span> <span class="n">cephadm</span><span class="p">:</span><span class="n">cephadm</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_remote_cephadm_auth</span><span class="p">.</span><span class="n">sh</span>

<span class="n">切换用户</span>
<span class="n">su</span> <span class="p">-</span> <span class="n">cephadm</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">执行脚本文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_remote_cephadm_auth</span><span class="p">.</span><span class="n">sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">1</span>
<span class="n">开始部署环境操作</span><span class="p">...</span>
<span class="n">expect环境已经部署完毕</span>
<span class="n">Generating</span> <span class="n">public</span><span class="p">/</span><span class="n">private</span> <span class="n">rsa</span> <span class="n">key</span> <span class="n">pair</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">identification</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">public</span> <span class="n">key</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span><span class="p">.</span>
<span class="n">The</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="n">is</span><span class="p">:</span>
<span class="n">SHA256</span><span class="p">:</span><span class="n">EvrdtcF4q</span><span class="p">+</span><span class="n">e2iyVVOovFkoHOisorCem</span><span class="p">+</span><span class="n">1eSG7WO</span><span class="p">+</span><span class="n">NCQ</span> <span class="n">cephadm</span><span class="nv">@admin</span>
<span class="n">The</span> <span class="n">key</span><span class="s1">&#39;s randomart image is:</span>
<span class="s1">+---[RSA 2048]----+</span>
<span class="s1">|                 |</span>
<span class="s1">|         .       |</span>
<span class="s1">|      . . .   .  |</span>
<span class="s1">|     . +   * o   |</span>
<span class="s1">| . E.o. S + @    |</span>
<span class="s1">|o   Oo + . B *   |</span>
<span class="s1">|o. o.Bo . + =    |</span>
<span class="s1">|oo..+o.    =o    |</span>
<span class="s1">|.+=.o+o   o++o   |</span>
<span class="s1">+----[SHA256]-----+</span>
<span class="s1">秘钥文件已经创建完毕</span>
<span class="s1">批量设定远程主机免密码认证管理界面</span>
<span class="s1">=====================================================</span>
<span class="s1"> 1: 部署环境   2: 免密认证   3: 退出操作</span>
<span class="s1">=====================================================</span>
<span class="s1">请输入有效的操作id: 2</span>
<span class="s1">请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {12..18}</span>
<span class="s1">开始执行免密认证操作...</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="err">&#39;</span><span class="s2">&quot;</span>
<span class="s2">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 3</span>
<span class="s2">开始退出管理界面...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">测试效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">12</span><span class="p">..</span><span class="n">18</span><span class="p">};</span> <span class="k">do</span> <span class="n">hostname</span><span class="p">=$(</span><span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;hostname&quot;</span><span class="p">);</span> <span class="nb">echo </span><span class="s2">&quot;10.0.0.$i - $hostname&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">-</span> <span class="n">admin</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="p">-</span> <span class="n">mon01</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="p">-</span> <span class="n">mon02</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="p">-</span> <span class="n">mon03</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="p">-</span> <span class="n">stor04</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="p">-</span> <span class="n">stor05</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span> <span class="p">-</span> <span class="n">stor06</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">因为10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">-</span><span class="n">15</span> <span class="n">有两个角色</span><span class="err">，</span><span class="n">所以我们需要将相关角色的免密认证</span>
<span class="n">num_list</span><span class="p">={</span><span class="n">1</span><span class="p">..</span><span class="n">3</span><span class="p">}</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">stor0</span><span class="nv">$num_list</span> <span class="n">stor0</span><span class="nv">$num_list</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">);</span> <span class="k">do</span> <span class="n">ssh-copy-id</span> <span class="n">cephadm</span><span class="p">@</span><span class="nv">$i</span><span class="p">;</span> <span class="n">done</span>
</code></pre></div>
<p>定制软件源</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于ceph-deploy方式部署Ceph来说</span><span class="err">，</span><span class="n">Ceph的官方仓库路径是http</span><span class="p">://</span><span class="n">download</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="err">，</span><span class="n">包括各种ceph版本</span><span class="err">，</span><span class="n">比如octopus</span><span class="err">、</span><span class="n">pacific</span><span class="err">、</span><span class="n">quincy等</span><span class="err">，</span><span class="n">它根据不同OS系统环境</span><span class="err">，</span><span class="n">分别位于rpm</span><span class="p">-</span><span class="n">版本号</span> <span class="n">或者</span> <span class="n">debian</span><span class="p">-</span><span class="n">版本号</span> <span class="n">的noarch目录下</span><span class="err">。</span><span class="n">比如pacific版本的软件相关源在</span> <span class="n">rpm-octopus</span><span class="p">/</span><span class="n">el7</span><span class="p">/</span><span class="n">noarch</span><span class="p">/</span><span class="n">ceph-release</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span><span class="err">。</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">el7代表支持Red</span> <span class="n">Hat</span> <span class="n">7</span><span class="p">.</span><span class="n">x</span><span class="err">、</span><span class="n">CentOS</span> <span class="n">7</span><span class="p">.</span><span class="n">x</span> <span class="n">系统的软件</span>
        <span class="n">el8代表支持Red</span> <span class="n">Hat</span> <span class="n">8</span><span class="p">.</span><span class="n">x</span><span class="err">、</span><span class="n">CentOS</span> <span class="n">8</span><span class="p">.</span><span class="n">x</span> <span class="n">系统的软件</span>
        <span class="n">pacific版本及其更新版本</span><span class="err">，</span><span class="n">只支持CentOS</span> <span class="n">8</span><span class="p">.</span><span class="n">x环境</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph的pacific和Quincy版本</span><span class="err">，</span><span class="n">仅仅支持CentOS8</span><span class="p">.</span><span class="n">X</span><span class="err">，</span><span class="n">Octopus版本虽然有CentOS7的版本</span><span class="err">，</span><span class="n">不仅仅软件不全</span><span class="err">，</span><span class="n">而且对于底层GCC库和GLIBC库要求比较高</span><span class="err">，</span><span class="n">如果升级CentOS7的底层库</span><span class="err">，</span><span class="n">会导致其他软件受到影响</span><span class="err">，</span><span class="n">无法正常使用</span><span class="err">，</span><span class="n">另外没有配套的ceph-deploy</span><span class="err">。</span><span class="n">所以对于CentOS7来说</span><span class="err">，</span><span class="n">只能部署Nautilus版本和更低版本</span><span class="err">。</span>
    <span class="n">对于Ubuntu系统来说</span><span class="err">，</span><span class="n">即使多个版本对于底层环境要求有些区别</span><span class="err">，</span><span class="n">但是经过测试</span><span class="err">，</span><span class="n">问题不大</span><span class="err">，</span><span class="n">也就是说Ubuntu系统可以安装Ceph的全系列</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">安装软件源</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">rpm-nautilus</span><span class="p">/</span><span class="n">el7</span><span class="p">/</span><span class="n">noarch</span><span class="p">/</span><span class="n">ceph-release</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>

<span class="n">更新软件源</span>
<span class="n">yum</span> <span class="n">makecache</span> <span class="n">fast</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有ceph节点部署软件源</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">12</span><span class="p">..</span><span class="n">18</span><span class="p">}</span>
<span class="k">do</span> 
  <span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span>  <span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">rpm-nautilus</span><span class="p">/</span><span class="n">el7</span><span class="p">/</span><span class="n">noarch</span><span class="p">/</span><span class="n">ceph-release</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>
  <span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="n">yum</span> <span class="n">makecache</span> <span class="n">fast</span>
<span class="n">done</span>
</code></pre></div>
<p>部署依赖</p>
<div class="highlight"><pre><span></span><code><span class="n">admin主机安装ceph软件</span>
<span class="n">yum</span> <span class="n">update</span> <span class="n">-y</span>
<span class="n">yum</span> <span class="n">install</span>  <span class="n">ceph-deploy</span> <span class="n">python-setuptools</span> <span class="n">python2-subprocess32</span> <span class="n">-y</span>

<span class="n">测试效果</span>
<span class="n">su</span> <span class="p">-</span> <span class="n">cephadm</span> <span class="n">-c</span> <span class="s2">&quot;ceph-deploy --help&quot;</span>
</code></pre></div>
<p>命令解析</p>
<div class="highlight"><pre><span></span><code><span class="n">查看命令帮助</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># su - cephadm</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">ceph-deploy</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-v</span> <span class="p">|</span> <span class="n">-q</span><span class="p">]</span> <span class="p">[-</span><span class="n">-version</span><span class="p">]</span> <span class="p">[-</span><span class="n">-username</span> <span class="n">USERNAME</span><span class="p">]</span>
                   <span class="p">[-</span><span class="n">-overwrite-conf</span><span class="p">]</span> <span class="p">[-</span><span class="n">-cluster</span> <span class="n">NAME</span><span class="p">]</span> <span class="p">[-</span><span class="n">-ceph-conf</span> <span class="n">CEPH_CONF</span><span class="p">]</span>
                   <span class="n">COMMAND</span> <span class="p">...</span>

<span class="n">Easy</span> <span class="n">Ceph</span> <span class="n">deployment</span>

    <span class="p">-^-</span>
   <span class="p">/</span>   <span class="p">\</span>
   <span class="p">|</span><span class="n">O</span> <span class="n">o</span><span class="p">|</span>  <span class="n">ceph-deploy</span> <span class="n">v1</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">25</span>
   <span class="p">).-.(</span>
  <span class="s1">&#39;/|||\`</span>
<span class="s1">  | &#39;</span><span class="p">|`</span> <span class="p">|</span>
    <span class="err">&#39;</span><span class="p">|`</span>

<span class="n">Full</span> <span class="n">documentation</span> <span class="n">can</span> <span class="n">be</span> <span class="n">found</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">://</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">ceph-deploy</span><span class="p">/</span><span class="n">docs</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">-h</span><span class="p">,</span> <span class="p">-</span><span class="n">-help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="n">and</span> <span class="n">exit</span>
  <span class="n">-v</span><span class="p">,</span> <span class="p">-</span><span class="n">-verbose</span>         <span class="n">be</span> <span class="n">more</span> <span class="n">verbose</span>
  <span class="n">-q</span><span class="p">,</span> <span class="p">-</span><span class="n">-quiet</span>           <span class="n">be</span> <span class="n">less</span> <span class="n">verbose</span>
  <span class="p">-</span><span class="n">-version</span>             <span class="n">the</span> <span class="n">current</span> <span class="n">installed</span> <span class="n">version</span> <span class="n">of</span> <span class="n">ceph-deploy</span>
  <span class="p">-</span><span class="n">-username</span> <span class="n">USERNAME</span>   <span class="n">the</span> <span class="n">username</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">host</span>
  <span class="p">-</span><span class="n">-overwrite-conf</span>      <span class="n">overwrite</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">conf</span> <span class="n">file</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">host</span> <span class="p">(</span><span class="k">if</span>
                        <span class="n">present</span><span class="p">)</span>
  <span class="p">-</span><span class="n">-cluster</span> <span class="n">NAME</span>        <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cluster</span>
  <span class="p">-</span><span class="n">-ceph-conf</span> <span class="n">CEPH_CONF</span>
                        <span class="n">use</span> <span class="p">(</span><span class="n">or</span> <span class="n">reuse</span><span class="p">)</span> <span class="n">a</span> <span class="n">given</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="n">file</span>

<span class="n">commands</span><span class="p">:</span>
  <span class="n">COMMAND</span>               <span class="n">description</span>
    <span class="c"># 创建一个集群</span>
    <span class="n">new</span>                 <span class="nb">Start </span><span class="n">deploying</span> <span class="n">a</span> <span class="n">new</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">and</span> <span class="nb">write </span><span class="n">a</span>
                        <span class="n">CLUSTER</span><span class="p">.</span><span class="n">conf</span> <span class="n">and</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">it</span><span class="p">.</span>
    <span class="n">install</span>             <span class="n">Install</span> <span class="n">Ceph</span> <span class="n">packages</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">hosts</span><span class="p">.</span>
    <span class="n">rgw</span>                 <span class="n">Deploy</span> <span class="n">ceph</span> <span class="n">RGW</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">hosts</span><span class="p">.</span>
    <span class="n">mds</span>                 <span class="n">Deploy</span> <span class="n">ceph</span> <span class="n">MDS</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">hosts</span><span class="p">.</span>
    <span class="n">mon</span>                 <span class="n">Deploy</span> <span class="n">ceph</span> <span class="n">monitor</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">hosts</span><span class="p">.</span>
    <span class="n">gatherkeys</span>          <span class="n">Gather</span> <span class="n">authentication</span> <span class="n">keys</span> <span class="k">for</span> <span class="n">provisioning</span> <span class="n">new</span> <span class="n">nodes</span><span class="p">.</span>
    <span class="n">disk</span>                <span class="n">Manage</span> <span class="n">disks</span> <span class="n">on</span> <span class="n">a</span> <span class="n">remote</span> <span class="n">host</span><span class="p">.</span>
    <span class="n">osd</span>                 <span class="n">Prepare</span> <span class="n">a</span> <span class="n">data</span> <span class="n">disk</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">host</span><span class="p">.</span>
    <span class="c"># 同步admin秘钥信息</span>
    <span class="n">admin</span>               <span class="n">Push</span> <span class="n">configuration</span> <span class="n">and</span> <span class="n">client</span><span class="p">.</span><span class="n">admin</span> <span class="n">key</span> <span class="n">to</span> <span class="n">a</span> <span class="n">remote</span> <span class="n">host</span><span class="p">.</span>
    <span class="c"># 同步ceph.conf文件</span>
    <span class="n">config</span>              <span class="n">Push</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">to</span> <span class="n">a</span> <span class="n">remote</span> <span class="n">host</span><span class="p">.</span>
    <span class="n">uninstall</span>           <span class="n">Remove</span> <span class="n">Ceph</span> <span class="n">packages</span> <span class="n">from</span> <span class="n">remote</span> <span class="n">hosts</span><span class="p">.</span>
    <span class="n">purgedata</span>           <span class="n">Purge</span> <span class="p">(</span><span class="n">delete</span><span class="p">,</span> <span class="n">destroy</span><span class="p">,</span> <span class="n">discard</span><span class="p">,</span> <span class="n">shred</span><span class="p">)</span> <span class="n">any</span> <span class="n">Ceph</span> <span class="n">data</span>
                        <span class="n">from</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">ceph</span>
    <span class="n">purge</span>               <span class="n">Remove</span> <span class="n">Ceph</span> <span class="n">packages</span> <span class="n">from</span> <span class="n">remote</span> <span class="n">hosts</span> <span class="n">and</span> <span class="n">purge</span> <span class="n">all</span> <span class="n">data</span><span class="p">.</span>
    <span class="n">forgetkeys</span>          <span class="n">Remove</span> <span class="n">authentication</span> <span class="n">keys</span> <span class="n">from</span> <span class="n">the</span> <span class="n">local</span> <span class="n">directory</span><span class="p">.</span>
    <span class="n">pkg</span>                 <span class="n">Manage</span> <span class="n">packages</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">hosts</span><span class="p">.</span>
    <span class="n">calamari</span>            <span class="n">Install</span> <span class="n">and</span> <span class="n">configure</span> <span class="n">Calamari</span> <span class="n">nodes</span><span class="p">.</span> <span class="n">Assumes</span> <span class="n">that</span> <span class="n">a</span>
                        <span class="n">repository</span> <span class="n">with</span> <span class="n">Calamari</span> <span class="n">packages</span> <span class="n">is</span> <span class="n">already</span>
                        <span class="n">configured</span><span class="p">.</span> <span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">docs</span> <span class="k">for</span> <span class="n">examples</span>
                        <span class="p">(</span><span class="n">http</span><span class="p">://</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">ceph-deploy</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">conf</span><span class="p">.</span><span class="n">html</span><span class="p">)</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="123_ceph">1.2.3 Ceph部署<a class="headerlink" href="#123_ceph" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 集群创建、Mon环境、小结 三个方面来学习。</p>
<p><strong>集群创建</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">首先在管理节点上以cephadm用户创建集群相关的配置文件目录</span><span class="err">：</span>
<span class="n">su</span> <span class="p">-</span> <span class="n">cephadm</span>
<span class="n">mkdir</span> <span class="n">ceph-cluster</span> <span class="p">&amp;&amp;</span> <span class="nb">cd </span><span class="n">ceph-cluster</span>
</code></pre></div>
<p>初始化集群解析</p>
<div class="highlight"><pre><span></span><code><span class="n">操作解析</span>
    <span class="n">ceph-deploy</span> <span class="n">new</span> <span class="p">-</span><span class="n">-help</span>
    <span class="n">初始化第一个MON节点的命令格式为</span><span class="err">”</span><span class="n">ceph-deploy</span> <span class="n">new</span> <span class="p">{</span><span class="n">initial-monitor-node</span><span class="p">(</span><span class="n">s</span><span class="p">)}</span><span class="err">“，</span>
        <span class="p">-</span> <span class="n">mon01即为第一个MON节点名称</span><span class="err">，</span><span class="n">其名称必须与节点当前实际使用的主机名称</span><span class="p">(</span><span class="n">uname</span> <span class="n">-n</span><span class="p">)</span><span class="n">保存一致</span>
        <span class="p">-</span> <span class="n">可以是短名称</span><span class="err">，</span><span class="n">也可以是长名称</span><span class="err">，</span><span class="n">但是最终用的仍然是短名称</span><span class="p">,</span><span class="n">但是会导致如下报错</span><span class="err">：</span>
            <span class="n">ceph-deploy</span> <span class="n">new</span><span class="p">:</span> <span class="n">error</span><span class="p">:</span> <span class="n">hostname</span><span class="p">:</span>  <span class="n">xxx</span> <span class="n">is</span> <span class="n">not</span> <span class="n">resolvable</span>
        <span class="p">-</span> <span class="n">推荐使用完整写法</span><span class="err">：</span>
            <span class="n">格式</span> <span class="n">hostname</span><span class="p">:</span><span class="n">fqdn</span><span class="err">，</span><span class="n">比如</span> <span class="n">mon01</span><span class="p">:</span><span class="n">mon01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">如果初始化的时候</span><span class="err">，</span><span class="n">希望同时部署多个节点的换</span><span class="err">，</span><span class="n">使用空格隔开hostname</span><span class="p">:</span><span class="n">fqdn即可</span>
    <span class="n">如果部署过程出现问题</span><span class="err">，</span><span class="n">需要清空</span>
        <span class="n">ceph-deploy</span> <span class="n">forgetkeys</span>
        <span class="n">ceph-deploy</span> <span class="n">purge</span> <span class="n">mon01</span>
        <span class="n">ceph-deploy</span> <span class="n">purgedata</span> <span class="n">mon01</span>
        <span class="nb">rm </span><span class="n">ceph</span><span class="p">.*</span>
</code></pre></div>
<p>集群初始化</p>
<div class="highlight"><pre><span></span><code><span class="n">部署3个mon节点</span>
    <span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">new</span> <span class="p">-</span><span class="n">-public-network</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="p">-</span><span class="n">-cluster-network</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">mon01</span><span class="p">:</span><span class="n">mon01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">mon02</span><span class="p">:</span><span class="n">mon02</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">mon03</span><span class="p">:</span><span class="n">mon03</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="p">-</span><span class="n">-no-ssh-copykey</span>
    <span class="p">...</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Resolving</span> <span class="n">host</span> <span class="n">mon03</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Monitor</span> <span class="n">mon03</span> <span class="n">at</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Monitor</span> <span class="n">initial</span> <span class="n">members</span> <span class="n">are</span> <span class="p">[</span><span class="s1">&#39;mon01&#39;</span><span class="p">,</span> <span class="s1">&#39;mon02&#39;</span><span class="p">,</span> <span class="s1">&#39;mon03&#39;</span><span class="p">]</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Monitor</span> <span class="n">addrs</span> <span class="n">are</span> <span class="p">[</span><span class="n">u</span><span class="s1">&#39;10.0.0.13&#39;</span><span class="p">,</span> <span class="n">u</span><span class="s1">&#39;10.0.0.14&#39;</span><span class="p">,</span> <span class="n">u</span><span class="s1">&#39;10.0.0.15&#39;</span><span class="p">]</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">random</span> <span class="n">mon</span> <span class="n">key</span><span class="p">...</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Writing</span> <span class="n">monitor</span> <span class="n">keyring</span> <span class="n">to</span> <span class="n">ceph</span><span class="p">.</span><span class="n">mon</span><span class="p">.</span><span class="n">keyring</span><span class="p">...</span>
    <span class="no">[ceph_deploy.new][DEBUG ]</span> <span class="n">Writing</span> <span class="n">initial</span> <span class="n">config</span> <span class="n">to</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span><span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">如果出现如下报错</span><span class="err">：</span>
    <span class="no">[ceph_deploy][ERROR ]</span> <span class="n">AttributeError</span><span class="p">:</span> <span class="s1">&#39;module&#39;</span> <span class="n">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;needs_ssh&#39;</span>
    <span class="n">在执行命令的时候</span><span class="err">，</span><span class="n">添加一个</span> <span class="p">-</span><span class="n">-no-ssh-copykey</span> <span class="n">参数即可</span>
    <span class="n">这主要是因为免密认证的时候</span><span class="err">，</span><span class="n">没有进行</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@主机名</span> <span class="n">导致的</span>
</code></pre></div>
<p>查看效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看初始化后的文件内容</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">ls</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">log</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">mon</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">查看集群的配置文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[global]</span>
<span class="n">fsid</span> <span class="p">=</span> <span class="n">7738ce65</span><span class="p">-</span><span class="n">2d87</span><span class="p">-</span><span class="n">481c</span><span class="p">-</span><span class="n">8253</span><span class="p">-</span><span class="n">9d0d4b29e8eb</span>  <span class="c"># 这个地方很重要的，每次都不一样，不要乱动</span>
<span class="n">public_network</span> <span class="p">=</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
<span class="n">cluster_network</span> <span class="p">=</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
<span class="n">mon_initial_members</span> <span class="p">=</span> <span class="n">mon01</span><span class="p">,</span> <span class="n">mon02</span><span class="p">,</span> <span class="n">mon03</span>
<span class="n">mon_host</span> <span class="p">=</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>
<span class="n">auth_cluster_required</span> <span class="p">=</span> <span class="n">cephx</span>
<span class="n">auth_service_required</span> <span class="p">=</span> <span class="n">cephx</span>
<span class="n">auth_client_required</span> <span class="p">=</span> <span class="n">cephx</span>
<span class="n">filestore_xattr_use_omap</span> <span class="p">=</span> <span class="n">true</span>

<span class="n">查看集群通信的认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">mon</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[mon.]</span>
<span class="n">key</span> <span class="p">=</span> <span class="n">AQBZ9y1jAAAAABAAKnVONZ3l</span><span class="p">+</span><span class="n">EEpjUOjtK8Xmw</span><span class="p">==</span>
<span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="n">allow</span> <span class="p">*</span>

<span class="n">查看集群初始化的日志信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">log</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>
</code></pre></div>
<p><strong>部署Mon</strong></p>
<p>部署mon软件</p>
<div class="highlight"><pre><span></span><code><span class="n">操作解析</span><span class="err">：</span>
    <span class="n">ceph-deploy命令能够以远程的方式连入Ceph集群各节点完成程序包安装等操作</span>

<span class="n">命令格式</span><span class="err">：</span>
    <span class="n">ceph-deploy</span> <span class="n">install</span> <span class="p">{</span><span class="n">ceph-node</span><span class="p">}</span> <span class="p">[{</span><span class="n">ceph-node</span><span class="p">}</span> <span class="p">...]</span>
    <span class="n">示例</span><span class="err">：</span><span class="n">ceph-deploy</span> <span class="n">install</span> <span class="p">-</span><span class="n">-nogpgcheck</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">这里主要是ceph的工作角色的的节点</span>
        <span class="n">一般情况下</span><span class="err">，</span><span class="n">不推荐使用这种直接的方法来进行安装</span><span class="err">，</span><span class="n">效率太低</span><span class="err">，</span><span class="n">而且容易干扰其他主机环境</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span> 
    <span class="n">上面会在所有节点上都来进行正常的安装部署其实还有另外一种方法</span><span class="err">，</span><span class="n">手工在所有节点上安装ceph软件</span><span class="p">--</span> <span class="n">推荐</span>
    <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">ceph</span> <span class="n">ceph-osd</span> <span class="n">ceph-mds</span> <span class="n">ceph-mon</span> <span class="n">ceph-radosgw</span>

    <span class="n">最后在admin角色主机上安装</span>
    <span class="n">ceph-deploy</span> <span class="n">install</span> <span class="p">-</span><span class="n">-no-adjust-repos</span> <span class="p">-</span><span class="n">-nogpgcheck</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">执行过程</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">install</span> <span class="p">-</span><span class="n">-no-adjust-repos</span> <span class="p">-</span><span class="n">-nogpgcheck</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">Invoked</span> <span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">25</span><span class="p">):</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-deploy</span> <span class="n">install</span> <span class="p">-</span><span class="n">-no-adjust-repos</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
<span class="no">[ceph_deploy.install][DEBUG ]</span> <span class="n">Installing</span> <span class="n">stable</span> <span class="n">version</span> <span class="n">hammer</span> <span class="n">on</span> <span class="n">cluster</span> <span class="n">ceph</span> <span class="n">hosts</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
<span class="no">[ceph_deploy.install][DEBUG ]</span> <span class="n">Detecting</span> <span class="n">platform</span> <span class="k">for</span> <span class="n">host</span> <span class="n">mon01</span> <span class="p">...</span>
<span class="no">[admin][DEBUG ]</span> <span class="n">connection</span> <span class="n">detected</span> <span class="n">need</span> <span class="k">for</span> <span class="n">sudo</span>
<span class="no">[admin][DEBUG ]</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">host</span><span class="p">:</span> <span class="n">admin</span>
<span class="p">...</span>
<span class="no">[mon03][DEBUG ]</span> <span class="n">完毕</span><span class="err">！</span>
<span class="no">[mon03][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-version</span>
<span class="no">[mon03][DEBUG ]</span> <span class="n">ceph</span> <span class="n">version</span> <span class="n">14</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">22</span> <span class="p">(</span><span class="n">ca74598065096e6fcbd8433c8779a2be0c889351</span><span class="p">)</span> <span class="n">nautilus</span> <span class="p">(</span><span class="n">stable</span><span class="p">)</span>
</code></pre></div>
<p>集群通信认证</p>
<div class="highlight"><pre><span></span><code><span class="n">配置初始MON节点</span><span class="p">,</span><span class="n">同时向所有节点同步配置</span>
<span class="n">ceph-deploy</span> <span class="n">mon</span> <span class="n">create-initial</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">为了避免因为认证方面导致的通信失败</span><span class="err">，</span><span class="n">尤其是在现有环境上</span><span class="err">，</span><span class="n">推荐使用</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">参数</span>
    <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">config</span> <span class="n">push</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">执行效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">mon</span> <span class="n">create-initial</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">Invoked</span> <span class="p">(</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">):</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-deploy</span> <span class="n">mon</span> <span class="n">create-initial</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span> <span class="p">********************************************************************************</span>
<span class="no">[mon01][DEBUG ]</span> <span class="n">status</span> <span class="k">for</span> <span class="n">monitor</span><span class="p">:</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon01</span>
<span class="no">[mon01][DEBUG ]</span> <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;election_epoch&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;extra_probe_peers&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;feature_map&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;monmap&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span>     <span class="s2">&quot;mons&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="no">[mon01][DEBUG ]</span>       <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.0.13:6789/0&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mon01&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;public_addr&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.0.13:6789/0&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;public_addrs&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>           <span class="s2">&quot;addrvec&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="no">[mon01][DEBUG ]</span>             <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>               <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.0.13:3300&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>               <span class="s2">&quot;nonce&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>               <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;v2&quot;</span>
<span class="no">[mon01][DEBUG ]</span>             <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>             <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>               <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.0.13:6789&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>               <span class="s2">&quot;nonce&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>               <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span>
<span class="no">[mon01][DEBUG ]</span>             <span class="p">}</span>
<span class="no">[mon01][DEBUG ]           ]</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">0</span>
<span class="no">[mon01][DEBUG ]</span>       <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>       <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0:0/1&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mon02&quot;</span><span class="p">,</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">1</span>
<span class="no">[mon01][DEBUG ]</span>       <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>       <span class="p">{</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0:0/2&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mon03&quot;</span><span class="p">,</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span>         <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">2</span>
<span class="no">[mon01][DEBUG ]</span>       <span class="p">}</span>
<span class="no">[mon01][DEBUG ]     ]</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="p">},</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mon01&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;outside_quorum&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="no">[mon01][DEBUG ]</span>     <span class="s2">&quot;mon01&quot;</span>
<span class="no">[mon01][DEBUG ]   ]</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;quorum&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;probing&quot;</span><span class="p">,</span>
<span class="no">[mon01][DEBUG ]</span>   <span class="s2">&quot;sync_provider&quot;</span><span class="p">:</span> <span class="p">[]</span>
<span class="no">[mon01][DEBUG ]</span> <span class="p">}</span>
<span class="no">[mon01][DEBUG ]</span> <span class="p">********************************************************************************</span>
<span class="no">[mon01][INFO  ]</span> <span class="n">monitor</span><span class="p">:</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon01</span> <span class="n">is</span> <span class="n">running</span>
<span class="no">[mon01][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph-mon</span><span class="p">.</span><span class="n">mon01</span><span class="p">.</span><span class="n">asok</span> <span class="n">mon_status</span>
<span class="p">...</span>
<span class="no">[ceph_deploy.gatherkeys][INFO  ]</span> <span class="n">Storing</span> <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-osd</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[ceph_deploy.gatherkeys][INFO  ]</span> <span class="n">Storing</span> <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-rgw</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[ceph_deploy.gatherkeys][INFO  ]</span> <span class="n">Destroy</span> <span class="n">temp</span> <span class="n">directory</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">tmpyal7qW</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">到mon的节点上查看mon的守护进程</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">15</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;ps aux | grep -v grep | grep ceph-mon&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="n">ceph</span>        <span class="n">2189</span>  <span class="n">0</span><span class="p">.</span><span class="n">1</span>  <span class="n">1</span><span class="p">.</span><span class="n">8</span> <span class="n">504004</span> <span class="n">34644</span> <span class="p">?</span>        <span class="n">Ssl</span>  <span class="n">11</span><span class="p">:</span><span class="n">55</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-mon</span> <span class="o">-f</span> <span class="p">-</span><span class="n">-cluster</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-id</span> <span class="n">mon01</span> <span class="p">-</span><span class="n">-setuser</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-setgroup</span> <span class="n">ceph</span>
<span class="n">ceph</span>        <span class="n">2288</span>  <span class="n">0</span><span class="p">.</span><span class="n">1</span>  <span class="n">1</span><span class="p">.</span><span class="n">7</span> <span class="n">502984</span> <span class="n">33328</span> <span class="p">?</span>        <span class="n">Ssl</span>  <span class="n">11</span><span class="p">:</span><span class="n">55</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-mon</span> <span class="o">-f</span> <span class="p">-</span><span class="n">-cluster</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-id</span> <span class="n">mon02</span> <span class="p">-</span><span class="n">-setuser</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-setgroup</span> <span class="n">ceph</span>
<span class="n">ceph</span>        <span class="n">2203</span>  <span class="n">0</span><span class="p">.</span><span class="n">1</span>  <span class="n">1</span><span class="p">.</span><span class="n">7</span> <span class="n">502988</span> <span class="n">32912</span> <span class="p">?</span>        <span class="n">Ssl</span>  <span class="n">11</span><span class="p">:</span><span class="n">55</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-mon</span> <span class="o">-f</span> <span class="p">-</span><span class="n">-cluster</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-id</span> <span class="n">mon03</span> <span class="p">-</span><span class="n">-setuser</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-setgroup</span> <span class="n">ceph</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">在所有的节点主机上</span><span class="err">，</span><span class="n">都有一套ceph-mon的进程在进行</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">集群在初始化的时候</span><span class="err">，</span><span class="n">会为对应的mon节点生成配套的认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">ls </span><span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/</span><span class="n">ceph-cluster</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-mds</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-osd</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>  
<span class="n">ceph-deploy-ceph</span><span class="p">.</span><span class="n">log</span>        <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-mgr</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-rgw</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>                   <span class="n">ceph</span><span class="p">.</span><span class="n">mon</span><span class="p">.</span><span class="n">keyring</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">结果显示</span><span class="err">：</span>
    <span class="n">这里生成了一系列的与ceph集群相关的</span> <span class="n">认证文件</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-mds</span><span class="p">.</span><span class="n">keyring</span>      <span class="n">引导启动</span> <span class="n">mds的秘钥文件</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-osd</span><span class="p">.</span><span class="n">keyring</span>      <span class="n">引导启动</span> <span class="n">osd的秘钥文件</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>       <span class="n">ceph客户端和管理端通信的认证秘钥</span><span class="err">，</span><span class="n">是最重要的</span>
    <span class="n">ceph-deploy-ceph</span><span class="p">.</span><span class="n">log</span>           
    <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-mgr</span><span class="p">.</span><span class="n">keyring</span>      <span class="n">引导启动</span> <span class="n">mgr的秘钥文件</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-rgw</span><span class="p">.</span><span class="n">keyring</span>      <span class="n">引导启动</span> <span class="n">rgw的秘钥文件</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">mon</span><span class="p">.</span><span class="n">keyring</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span> <span class="n">拥有ceph集群的所有权限</span><span class="err">，</span><span class="n">一定不能有误</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="124_ceph2">1.2.4 Ceph部署2<a class="headerlink" href="#124_ceph2" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 Mon认证、Mgr环境、小结、三个方面来学习</p>
<p><strong>Mon认证</strong></p>
<div class="highlight"><pre><span></span><code>    <span class="n">为了方便后续的监控环境认证操作</span><span class="err">，</span><span class="n">在admin角色主机上</span><span class="err">，</span><span class="n">把配置文件和admin密钥拷贝Ceph集群各监控角色节点</span><span class="p">,</span><span class="n">拷贝前秘钥文件前的各个mon节点效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">15</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;echo -----$i-----; ls /etc/ceph&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="p">-----</span><span class="n">13</span><span class="p">-----</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">rbdmap</span>
<span class="n">tmpc8lO0G</span>
<span class="p">-----</span><span class="n">14</span><span class="p">-----</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">rbdmap</span>
<span class="n">tmpkmxmh3</span>
<span class="p">-----</span><span class="n">15</span><span class="p">-----</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">rbdmap</span>
<span class="n">tmp4GwYSs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">原则上要求</span><span class="err">，</span><span class="n">所有mon节点上的</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="n">内容必须一致</span><span class="err">，</span><span class="n">如果不一致的话</span><span class="err">，</span><span class="n">可以通过下面命令同步</span>
    <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">config</span> <span class="n">push</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>

<span class="n">执行集群的认证文件的拷贝动作</span>
<span class="n">ceph-deploy</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">执行认证文件信息同步</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>
<span class="no">[ceph_deploy.admin][DEBUG ]</span> <span class="n">Pushing</span> <span class="n">admin</span> <span class="n">keys</span> <span class="n">and</span> <span class="n">conf</span> <span class="n">to</span> <span class="n">mon01</span>
<span class="p">...</span>
<span class="no">[mon01][DEBUG ]</span> <span class="nb">write </span><span class="n">cluster</span> <span class="n">configuration</span> <span class="n">to</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/{</span><span class="n">cluster</span><span class="p">}.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.admin][DEBUG ]</span> <span class="n">Pushing</span> <span class="n">admin</span> <span class="n">keys</span> <span class="n">and</span> <span class="n">conf</span> <span class="n">to</span> <span class="n">mon02</span>
<span class="p">...</span>
<span class="no">[mon02][DEBUG ]</span> <span class="nb">write </span><span class="n">cluster</span> <span class="n">configuration</span> <span class="n">to</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/{</span><span class="n">cluster</span><span class="p">}.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.admin][DEBUG ]</span> <span class="n">Pushing</span> <span class="n">admin</span> <span class="n">keys</span> <span class="n">and</span> <span class="n">conf</span> <span class="n">to</span> <span class="n">mon03</span>
<span class="p">...</span>
<span class="no">[mon03][DEBUG ]</span> <span class="nb">write </span><span class="n">cluster</span> <span class="n">configuration</span> <span class="n">to</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/{</span><span class="n">cluster</span><span class="p">}.</span><span class="n">conf</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">15</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;echo -----$i-----; ls /etc/ceph&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="p">-----</span><span class="n">13</span><span class="p">-----</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">rbdmap</span>
<span class="n">tmpc8lO0G</span>
<span class="p">-----</span><span class="n">14</span><span class="p">-----</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">rbdmap</span>
<span class="n">tmpkmxmh3</span>
<span class="p">-----</span><span class="n">15</span><span class="p">-----</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">rbdmap</span>
<span class="n">tmp4GwYSs</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">所有的mon节点上多了一个</span> <span class="n">ceph的客户端与服务端进行认证的秘钥文件了</span><span class="err">。</span>
    <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span> <span class="n">主要用于</span> <span class="n">ceph客户端与管理端的一个通信认证</span><span class="err">。</span>
    <span class="n">注意</span><span class="err">：</span><span class="n">如果我们不做交互式操作的话</span><span class="err">，</span><span class="n">这个文件可以不用复制</span><span class="err">。</span>
</code></pre></div>
<p>认证文件权限</p>
<div class="highlight"><pre><span></span><code>    <span class="n">虽然我们把认证文件传递给对应的监控角色主机了</span><span class="err">，</span><span class="n">但是我们的服务式通过普通用户cephadm来进行交流的</span><span class="err">。</span><span class="n">而默认情况下</span><span class="err">，</span><span class="n">传递过去的认证文件</span><span class="err">，</span><span class="n">cephadm普通用户是无法正常访问的</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">15</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;echo -----$i-----; ls /etc/ceph/ceph.cl* -l&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="p">-----</span><span class="n">13</span><span class="p">-----</span>
<span class="n">-rw</span><span class="p">-------</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">151</span> <span class="n">9月</span>  <span class="n">25</span> <span class="n">12</span><span class="p">:</span><span class="n">06</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">-----</span><span class="n">14</span><span class="p">-----</span>
<span class="n">-rw</span><span class="p">-------</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">151</span> <span class="n">9月</span>  <span class="n">25</span> <span class="n">12</span><span class="p">:</span><span class="n">06</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">-----</span><span class="n">15</span><span class="p">-----</span>
<span class="n">-rw</span><span class="p">-------</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">151</span> <span class="n">9月</span>  <span class="n">25</span> <span class="n">12</span><span class="p">:</span><span class="n">06</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">我们需要在Ceph集群中需要运行ceph命令的的节点上</span><span class="err">，</span><span class="n">以root用户的身份设定普通用户cephadm能够读</span>
<span class="n">取</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring文件的权限</span><span class="err">。</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">15</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;sudo setfacl -m u:cephadm:r /etc/ceph/ceph.client.admin.keyring&quot;</span><span class="p">;</span> <span class="n">done</span>

<span class="n">查看文件权限效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">13</span><span class="p">..</span><span class="n">15</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;echo -----$i-----; ls /etc/ceph/ceph.cl* -l&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="p">-----</span><span class="n">13</span><span class="p">-----</span>
<span class="n">-rw-r</span><span class="p">-----+</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">151</span> <span class="n">9月</span>  <span class="n">25</span> <span class="n">12</span><span class="p">:</span><span class="n">06</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">-----</span><span class="n">14</span><span class="p">-----</span>
<span class="n">-rw-r</span><span class="p">-----+</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">151</span> <span class="n">9月</span>  <span class="n">25</span> <span class="n">12</span><span class="p">:</span><span class="n">06</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">-----</span><span class="n">15</span><span class="p">-----</span>
<span class="n">-rw-r</span><span class="p">-----+</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">151</span> <span class="n">9月</span>  <span class="n">25</span> <span class="n">12</span><span class="p">:</span><span class="n">06</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">查看文件的授权信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># getfacl /etc/ceph/ceph.client.admin.keyring</span>
<span class="n">getfacl</span><span class="p">:</span> <span class="n">Removing</span> <span class="n">leading</span> <span class="s1">&#39;/&#39;</span> <span class="n">from</span> <span class="n">absolute</span> <span class="n">path</span> <span class="n">names</span>
<span class="c"># file: etc/ceph/ceph.client.admin.keyring</span>
<span class="c"># owner: root</span>
<span class="c"># group: root</span>
<span class="n">user</span><span class="p">::</span><span class="n">rw</span><span class="p">-</span>
<span class="n">user</span><span class="p">:</span><span class="n">cephadm</span><span class="p">:</span><span class="n">r</span><span class="p">--</span>
<span class="n">group</span><span class="p">::---</span>
<span class="n">mask</span><span class="p">::</span><span class="n">r</span><span class="p">--</span>
<span class="n">other</span><span class="p">::---</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">监控节点就可以自己来收集相关的数据了</span><span class="err">，</span><span class="n">比如我们在mon01上执行如下命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph -s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
            <span class="n">mons</span> <span class="n">are</span> <span class="n">allowing</span> <span class="n">insecure</span> <span class="n">global_id</span> <span class="n">reclaim</span>

  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">18m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">no</span> <span class="n">daemons</span> <span class="n">active</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">0</span> <span class="n">osds</span><span class="p">:</span> <span class="n">0</span> <span class="n">up</span><span class="p">,</span> <span class="n">0</span> <span class="k">in</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">0</span> <span class="n">pools</span><span class="p">,</span> <span class="n">0</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">0</span> <span class="n">objects</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">0</span> <span class="n">B</span> <span class="n">used</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span> <span class="p">/</span> <span class="n">0</span> <span class="n">B</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">我们的cluster状态不是正常的</span>
    <span class="n">对于service来说</span><span class="err">，</span><span class="n">有三个mon服务</span><span class="err">，</span><span class="n">选举的节点有三个</span><span class="err">，</span><span class="n">其他的服务没有</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">集群状态不正常的原因</span><span class="err">，</span><span class="n">我们可以通过</span> <span class="n">ceph</span> <span class="n">health命令来进行确认</span><span class="err">，</span><span class="n">效果如下</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph health</span>
<span class="n">HEALTH_WARN</span> <span class="n">mons</span> <span class="n">are</span> <span class="n">allowing</span> <span class="n">insecure</span> <span class="n">global_id</span> <span class="n">reclaim</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph health detail</span>
<span class="n">HEALTH_WARN</span> <span class="n">mons</span> <span class="n">are</span> <span class="n">allowing</span> <span class="n">insecure</span> <span class="n">global_id</span> <span class="n">reclaim</span>
<span class="n">AUTH_INSECURE_GLOBAL_ID_RECLAIM_ALLOWED</span> <span class="n">mons</span> <span class="n">are</span> <span class="n">allowing</span> <span class="n">insecure</span> <span class="n">global_id</span> <span class="n">reclaim</span>
    <span class="n">mon</span><span class="p">.</span><span class="n">mon01</span> <span class="n">has</span> <span class="n">auth_allow_insecure_global_id_reclaim</span> <span class="nb">set </span><span class="n">to</span> <span class="n">true</span>
    <span class="n">mon</span><span class="p">.</span><span class="n">mon02</span> <span class="n">has</span> <span class="n">auth_allow_insecure_global_id_reclaim</span> <span class="nb">set </span><span class="n">to</span> <span class="n">true</span>
    <span class="n">mon</span><span class="p">.</span><span class="n">mon03</span> <span class="n">has</span> <span class="n">auth_allow_insecure_global_id_reclaim</span> <span class="nb">set </span><span class="n">to</span> <span class="n">true</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">我们在所有的mon节点上进行提示属性的设定</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph config set mon auth_allow_insecure_global_id_reclaim false</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph health detail</span>
<span class="n">HEALTH_OK</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">集群状态问题已经解决了</span>
</code></pre></div>
<p><strong>Mgr环境</strong></p>
<p>需求</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph-MGR工作的模式是事件驱动型的</span><span class="err">，</span><span class="n">简单来说</span><span class="err">，</span><span class="n">就是等待事件</span><span class="err">，</span><span class="n">事件来了则处理事件返回结果</span><span class="err">，</span><span class="n">又继续等待</span><span class="err">。</span><span class="n">Ceph</span> <span class="n">MGR</span> <span class="n">是</span> <span class="n">Ceph</span> <span class="n">12</span><span class="p">.</span><span class="n">2</span> <span class="n">依赖主推的功能之一</span><span class="err">，</span><span class="n">它负责</span> <span class="n">Ceph</span> <span class="n">集群管理的组件</span><span class="err">，</span><span class="n">它主要功能是把集群的一些指标暴露给外界使用</span><span class="err">。</span><span class="n">根据官方的架构原则上来说</span><span class="err">，</span><span class="n">mgr要有两个节点来进行工作</span><span class="err">。</span>
    <span class="n">对于我们的学习环境来说</span><span class="err">，</span><span class="n">其实一个就能够正常使用了</span><span class="p">,</span><span class="n">为了节省资源的使用</span><span class="err">，</span><span class="n">我们这里将mon01</span> <span class="n">和mon02主机节点兼做MGR节点</span><span class="err">，</span><span class="n">为了后续的节点扩充实践</span><span class="err">，</span><span class="n">我们暂时先安装一个节点</span><span class="err">，</span><span class="n">后面再安装一个节点</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">未部署mgr节点的集群状态效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon01</span>  <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_OK</span>

  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">29m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">no</span> <span class="n">daemons</span> <span class="n">active</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">0</span> <span class="n">osds</span><span class="p">:</span> <span class="n">0</span> <span class="n">up</span><span class="p">,</span> <span class="n">0</span> <span class="k">in</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">0</span> <span class="n">pools</span><span class="p">,</span> <span class="n">0</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">0</span> <span class="n">objects</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">0</span> <span class="n">B</span> <span class="n">used</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span> <span class="p">/</span> <span class="n">0</span> <span class="n">B</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>
</code></pre></div>
<p>mgr服务配置</p>
<div class="highlight"><pre><span></span><code><span class="n">配置Manager节点</span><span class="err">，</span><span class="n">启动ceph-mgr进程</span><span class="err">：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">mgr</span> <span class="n">create</span> <span class="n">mon01</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">Invoked</span> <span class="p">(</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">):</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-deploy</span> <span class="n">mgr</span> <span class="n">create</span> <span class="n">mon01</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">ceph-deploy</span> <span class="n">options</span><span class="p">:</span>
<span class="p">...</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span>  <span class="n">mgr</span>                           <span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;mon01&#39;</span><span class="p">,</span> <span class="s1">&#39;mon01&#39;</span><span class="p">)]</span>
<span class="p">...</span>
<span class="no">[mon01][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="nb">start </span><span class="n">ceph-mgr</span><span class="nv">@mon</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在指定的mgr节点上</span><span class="err">，</span><span class="n">查看守护进程</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon01</span> <span class="nb">ps </span><span class="n">aux</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">-v</span> <span class="n">grep</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">ceph-mgr</span>
<span class="n">ceph</span>        <span class="n">3065</span>  <span class="n">2</span><span class="p">.</span><span class="n">8</span>  <span class="n">6</span><span class="p">.</span><span class="n">6</span> <span class="n">1037824</span> <span class="n">124244</span> <span class="p">?</span>      <span class="n">Ssl</span>  <span class="n">12</span><span class="p">:</span><span class="n">27</span>   <span class="n">0</span><span class="p">:</span><span class="n">01</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-mgr</span> <span class="o">-f</span> <span class="p">-</span><span class="n">-cluster</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-id</span> <span class="n">mon01</span> <span class="p">-</span><span class="n">-setuser</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-setgroup</span> <span class="n">ceph</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">在mon01上</span><span class="err">，</span><span class="n">部署了一个mgr的服务进程</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看集群服务的运行状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon01</span>  <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">33m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">86s</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">0</span> <span class="n">osds</span><span class="p">:</span> <span class="n">0</span> <span class="n">up</span><span class="p">,</span> <span class="n">0</span> <span class="k">in</span>
  <span class="n">data</span><span class="p">:</span>
    <span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">这个时候</span><span class="err">，</span><span class="n">service上</span><span class="err">，</span><span class="n">多了一个mgr的服务</span><span class="err">，</span><span class="n">在mon01节点上</span><span class="err">，</span><span class="n">服务状态是</span> <span class="n">active</span><span class="err">。</span>
</code></pre></div>
<p>admin查看状态</p>
<div class="highlight"><pre><span></span><code><span class="n">远程查看状态方式不太方便</span><span class="err">，</span><span class="n">我们可以在admin主机上进行一下操作来实现admin主机查看集群状态</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">ceph-common</span>
<span class="n">ceph-deploy</span> <span class="n">admin</span> <span class="n">admin</span>
<span class="n">sudo</span> <span class="n">setfacl</span> <span class="n">-m</span> <span class="n">u</span><span class="p">:</span><span class="n">cephadm</span><span class="p">:</span><span class="n">rw</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
            <span class="n">OSD</span> <span class="n">count</span> <span class="n">0</span> <span class="p">&lt;</span> <span class="n">osd_pool_default_size</span> <span class="n">3</span>

  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">37m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">4m</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">0</span> <span class="n">osds</span><span class="p">:</span> <span class="n">0</span> <span class="n">up</span><span class="p">,</span> <span class="n">0</span> <span class="k">in</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">0</span> <span class="n">pools</span><span class="p">,</span> <span class="n">0</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">0</span> <span class="n">objects</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">0</span> <span class="n">B</span> <span class="n">used</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span> <span class="p">/</span> <span class="n">0</span> <span class="n">B</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="125_osd">1.2.5 OSD环境<a class="headerlink" href="#125_osd" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基本环境、OSD实践、小结、三个方面来学习。</p>
<p><strong>基本环境</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">我们知道对于osd来说</span><span class="err">，</span><span class="n">它进行真正数据的存储的引擎有两种</span><span class="err">：</span><span class="n">BlueStore和FileStore</span><span class="err">，</span><span class="n">自动Ceph</span> <span class="n">L版之后</span><span class="err">，</span><span class="n">默认都是BlueStore了</span><span class="err">。</span>
</code></pre></div>
<p>基本流程</p>
<div class="highlight"><pre><span></span><code><span class="n">一般来说</span><span class="err">，</span><span class="n">我们可以通过一下四个步骤来设置OSD环境</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">要知道对应的主机上有哪些磁盘可以提供给主机来进行正常的使用</span><span class="err">。</span>
    <span class="n">2</span> <span class="n">格式化磁盘</span><span class="p">(</span><span class="n">非必须</span><span class="p">)</span>
    <span class="n">3</span> <span class="n">ceph擦除磁盘上的数据</span>
    <span class="n">4</span> <span class="n">添加osd</span>
</code></pre></div>
<p>1 确保提供专属数据磁盘，然后进行格式化</p>
<div class="highlight"><pre><span></span><code><span class="n">根据我们的了解</span><span class="err">，</span><span class="n">我们为所有的节点主机都准备了两块额外的磁盘</span><span class="err">，</span>
<span class="n">fdisk</span> <span class="n">-l</span>
</code></pre></div>
<p>2 进行磁盘格式化</p>
<div class="highlight"><pre><span></span><code><span class="n">我们在所有的osd角色的主机上</span><span class="err">，</span><span class="n">进行磁盘的格式化操作</span><span class="p">,</span><span class="n">对所有的osd节点主机进行磁盘格式化</span><span class="err">。</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span>  <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span>  <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看磁盘格式化效果</span><span class="err">，</span><span class="n">以mon03为例</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># blkid | egrep &quot;sd[bc]&quot;</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span><span class="p">:</span> <span class="n">UUID</span><span class="p">=</span><span class="s2">&quot;49b5be7c-76dc-4ac7-a3e6-1f54526c83df&quot;</span> <span class="n">TYPE</span><span class="p">=</span><span class="s2">&quot;ext4&quot;</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span><span class="p">:</span> <span class="n">UUID</span><span class="p">=</span><span class="s2">&quot;ecdc0ce6-8045-4caa-b272-2607e70700ee&quot;</span> <span class="n">TYPE</span><span class="p">=</span><span class="s2">&quot;ext4&quot;</span>
</code></pre></div>
<p>3 ceph擦除磁盘上的数据</p>
<div class="highlight"><pre><span></span><code><span class="n">保证所有包含OSD磁盘上主机上</span><span class="err">，</span><span class="n">安装ceph的命令</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">ceph</span> <span class="n">radosgw</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查并列出OSD节点上所有可用的磁盘的相关信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">list</span> <span class="n">stor01</span> <span class="n">stor02</span> <span class="n">stor03</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">Invoked</span> <span class="p">(</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">):</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">list</span> <span class="n">stor01</span> <span class="n">stor02</span> <span class="n">stor03</span>
<span class="p">...</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">connection</span> <span class="n">detected</span> <span class="n">need</span> <span class="k">for</span> <span class="n">sudo</span>
<span class="p">...</span>
<span class="no">[stor01][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="n">fdisk</span> <span class="n">-l</span>
<span class="no">[stor02][DEBUG ]</span> <span class="n">connection</span> <span class="n">detected</span> <span class="n">need</span> <span class="k">for</span> <span class="n">sudo</span>
<span class="p">...</span>
<span class="no">[stor02][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="n">fdisk</span> <span class="n">-l</span>
<span class="no">[stor03][DEBUG ]</span> <span class="n">connection</span> <span class="n">detected</span> <span class="n">need</span> <span class="k">for</span> <span class="n">sudo</span>
<span class="p">...</span>
<span class="no">[stor03][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="n">fdisk</span> <span class="n">-l</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在管理节点上使用ceph-deploy命令擦除计划专用于OSD磁盘上的所有分区表和数据以便用于OSD</span><span class="err">，</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">1</span><span class="p">..</span><span class="n">3</span><span class="p">}</span>
<span class="k">do</span> 
   <span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">zap</span> <span class="n">stor0</span><span class="nv">$i</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="n">done</span>
<span class="p">...</span>
<span class="no">[stor03][WARNIN]</span>  <span class="n">stderr</span><span class="p">:</span> <span class="n">记录了10</span><span class="p">+</span><span class="n">0</span> <span class="n">的读入</span>
<span class="no">[stor03][WARNIN]</span> <span class="n">记录了10</span><span class="p">+</span><span class="n">0</span> <span class="n">的写出</span>
<span class="no">[stor03][WARNIN]</span> <span class="n">10485760字节</span><span class="p">(</span><span class="n">10</span> <span class="n">MB</span><span class="p">)</span><span class="n">已复制</span>
<span class="no">[stor03][WARNIN]</span>  <span class="n">stderr</span><span class="p">:</span> <span class="err">，</span><span class="n">0</span><span class="p">.</span><span class="n">018883</span> <span class="n">秒</span><span class="err">，</span><span class="n">555</span> <span class="n">MB</span><span class="p">/</span><span class="n">秒</span>
<span class="no">[stor03][WARNIN]</span> <span class="p">--&gt;</span> <span class="n">Zapping</span> <span class="n">successful</span> <span class="k">for</span><span class="p">:</span> <span class="p">&lt;</span><span class="n">Raw</span> <span class="n">Device</span><span class="p">:</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>OSD实践</strong></p>
<p>命令解析</p>
<div class="highlight"><pre><span></span><code><span class="n">对于osd的相关操作</span><span class="err">，</span><span class="n">可以通过</span> <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">命令来进行</span><span class="err">，</span><span class="n">帮助信息如下</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">{</span><span class="n">list</span><span class="p">,</span><span class="n">create</span><span class="p">}</span> <span class="p">...</span>

<span class="n">Create</span> <span class="n">OSDs</span> <span class="n">from</span> <span class="n">a</span> <span class="n">data</span> <span class="n">disk</span> <span class="n">on</span> <span class="n">a</span> <span class="n">remote</span> <span class="n">host</span><span class="p">:</span>
    <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">{</span><span class="n">node</span><span class="p">}</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">device</span>

<span class="k">For</span> <span class="n">bluestore</span><span class="p">,</span> <span class="n">optional</span> <span class="n">devices</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span><span class="p">::</span>
    <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">{</span><span class="n">node</span><span class="p">}</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">data</span> <span class="p">-</span><span class="n">-block-db</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">db-device</span>
    <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">{</span><span class="n">node</span><span class="p">}</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">data</span> <span class="p">-</span><span class="n">-block-wal</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">wal-device</span>
    <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">{</span><span class="n">node</span><span class="p">}</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">data</span> <span class="p">-</span><span class="n">-block-db</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">db-device</span> <span class="p">-</span><span class="n">-block-wal</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">wal-device</span>

<span class="k">For</span> <span class="n">filestore</span><span class="p">,</span> <span class="n">the</span> <span class="n">journal</span> <span class="n">must</span> <span class="n">be</span> <span class="n">specified</span><span class="p">,</span> <span class="n">as</span> <span class="n">well</span> <span class="n">as</span> <span class="n">the</span> <span class="n">objectstore</span><span class="p">::</span>
    <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">{</span><span class="n">node</span><span class="p">}</span> <span class="p">-</span><span class="n">-filestore</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">data</span> <span class="p">-</span><span class="n">-journal</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">journal</span>

<span class="k">For</span> <span class="n">data</span> <span class="n">devices</span><span class="p">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">logical</span> <span class="n">volume</span> <span class="k">in</span> <span class="n">the</span> <span class="n">format</span> <span class="n">of</span><span class="p">:</span>
<span class="n">vg</span><span class="p">/</span><span class="n">lv</span><span class="p">,</span> <span class="n">or</span> <span class="n">a</span> <span class="n">device</span><span class="p">.</span> <span class="k">For</span> <span class="n">other</span> <span class="n">OSD</span> <span class="n">components</span> <span class="n">like</span> <span class="n">wal</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">and</span> <span class="n">journal</span><span class="p">,</span> <span class="n">it</span>
<span class="n">can</span> <span class="n">be</span> <span class="n">logical</span> <span class="n">volume</span> <span class="p">(</span><span class="k">in</span> <span class="n">vg</span><span class="p">/</span><span class="n">lv</span> <span class="n">format</span><span class="p">)</span> <span class="n">or</span> <span class="n">it</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">GPT</span> <span class="n">partition</span><span class="p">.</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="p">{</span><span class="n">list</span><span class="p">,</span><span class="n">create</span><span class="p">}</span>
    <span class="n">list</span>         <span class="n">List</span> <span class="n">OSD</span> <span class="n">info</span> <span class="n">from</span> <span class="n">remote</span> <span class="n">host</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">create</span>       <span class="n">Create</span> <span class="n">new</span> <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">daemon</span> <span class="n">by</span> <span class="n">preparing</span> <span class="n">and</span> <span class="n">activating</span> <span class="n">a</span> <span class="n">device</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">帮助显示</span><span class="err">：</span><span class="n">这里提示了两类的存储机制</span><span class="err">：</span>
    <span class="n">对于bluestore来说</span><span class="err">，</span><span class="n">它主要包括三类数据</span><span class="err">：</span>
        <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">data</span>                        <span class="n">ceph</span> <span class="n">保存的对象数据</span>
        <span class="p">-</span><span class="n">-block-db</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">db-device</span>               <span class="n">ceph</span> <span class="n">保存的对象数据</span>
        <span class="p">-</span><span class="n">-block-wal</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">wal-device</span>             <span class="n">数据库的</span> <span class="n">wal</span> <span class="n">日志</span>
    <span class="n">对于filestore来说</span><span class="err">，</span><span class="n">它主要包括两类数据</span> 
        <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">data</span>                        <span class="n">ceph的文件数据</span>
        <span class="p">-</span><span class="n">-journal</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">journal</span>                  <span class="n">文件系统日志数据</span>
    <span class="n">对于</span> <span class="n">osd来说</span><span class="err">，</span><span class="n">它主要有两个动作</span><span class="err">：</span>
        <span class="n">list</span>    <span class="n">列出osd相关的信息</span>
        <span class="n">create</span>  <span class="n">创建osd设备</span>
</code></pre></div>
<p>添加OSD命令解读</p>
<div class="highlight"><pre><span></span><code><span class="n">对于osd的创建来说</span><span class="err">，</span><span class="n">我们来看一下他的基本格式</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">create</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[-</span><span class="n">-data</span> <span class="n">DATA</span><span class="p">]</span> <span class="p">[-</span><span class="n">-journal</span> <span class="n">JOURNAL</span><span class="p">]</span>
                              <span class="p">[-</span><span class="n">-zap-disk</span><span class="p">]</span> <span class="p">[-</span><span class="n">-fs-type</span> <span class="n">FS_TYPE</span><span class="p">]</span> <span class="p">[-</span><span class="n">-dmcrypt</span><span class="p">]</span>
                              <span class="p">[-</span><span class="n">-dmcrypt-key-dir</span> <span class="n">KEYDIR</span><span class="p">]</span> <span class="p">[-</span><span class="n">-filestore</span><span class="p">]</span>
                              <span class="p">[-</span><span class="n">-bluestore</span><span class="p">]</span> <span class="p">[-</span><span class="n">-block-db</span> <span class="n">BLOCK_DB</span><span class="p">]</span>
                              <span class="p">[-</span><span class="n">-block-wal</span> <span class="n">BLOCK_WAL</span><span class="p">]</span> <span class="p">[-</span><span class="n">-debug</span><span class="p">]</span>
                              <span class="no">[HOST]</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">HOST</span>                  <span class="n">Remote</span> <span class="n">host</span> <span class="n">to</span> <span class="n">connect</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="n">-h</span><span class="p">,</span> <span class="p">-</span><span class="n">-help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="n">and</span> <span class="n">exit</span>
  <span class="p">-</span><span class="n">-data</span> <span class="n">DATA</span>           <span class="n">The</span> <span class="n">OSD</span> <span class="n">data</span> <span class="n">logical</span> <span class="n">volume</span> <span class="p">(</span><span class="n">vg</span><span class="p">/</span><span class="n">lv</span><span class="p">)</span> <span class="n">or</span> <span class="n">absolute</span> <span class="n">path</span>
                        <span class="n">to</span> <span class="n">device</span>
  <span class="p">-</span><span class="n">-journal</span> <span class="n">JOURNAL</span>     <span class="n">Logical</span> <span class="n">Volume</span> <span class="p">(</span><span class="n">vg</span><span class="p">/</span><span class="n">lv</span><span class="p">)</span> <span class="n">or</span> <span class="n">path</span> <span class="n">to</span> <span class="n">GPT</span> <span class="n">partition</span>
  <span class="p">-</span><span class="n">-zap-disk</span>            <span class="n">DEPRECATED</span> <span class="p">-</span> <span class="n">cannot</span> <span class="n">zap</span> <span class="n">when</span> <span class="n">creating</span> <span class="n">an</span> <span class="n">OSD</span>
  <span class="p">-</span><span class="n">-fs-type</span> <span class="n">FS_TYPE</span>     <span class="n">filesystem</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">format</span> <span class="n">DEVICE</span> <span class="p">(</span><span class="n">xfs</span><span class="p">,</span> <span class="n">btrfs</span><span class="p">)</span>
  <span class="p">-</span><span class="n">-dmcrypt</span>             <span class="n">use</span> <span class="n">dm-crypt</span> <span class="n">on</span> <span class="n">DEVICE</span>
  <span class="p">-</span><span class="n">-dmcrypt-key-dir</span> <span class="n">KEYDIR</span>
                        <span class="n">directory</span> <span class="nb">where </span><span class="n">dm-crypt</span> <span class="n">keys</span> <span class="n">are</span> <span class="n">stored</span>
  <span class="p">-</span><span class="n">-filestore</span>           <span class="n">filestore</span> <span class="n">objectstore</span>
  <span class="p">-</span><span class="n">-bluestore</span>           <span class="n">bluestore</span> <span class="n">objectstore</span>
  <span class="p">-</span><span class="n">-block-db</span> <span class="n">BLOCK_DB</span>   <span class="n">bluestore</span> <span class="n">block</span><span class="p">.</span><span class="n">db</span> <span class="n">path</span>
  <span class="p">-</span><span class="n">-block-wal</span> <span class="n">BLOCK_WAL</span>
                        <span class="n">bluestore</span> <span class="n">block</span><span class="p">.</span><span class="n">wal</span> <span class="n">path</span>
  <span class="p">-</span><span class="n">-debug</span>               <span class="n">Enable</span> <span class="n">debug</span> <span class="n">mode</span> <span class="n">on</span> <span class="n">remote</span> <span class="n">ceph-volume</span> <span class="n">calls</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">对于osd的创建</span><span class="err">，</span><span class="n">默认情况下用的就是</span> <span class="n">bluestore类型</span><span class="err">，</span>
</code></pre></div>
<p>4 添加osd</p>
<div class="highlight"><pre><span></span><code><span class="n">创建osd</span><span class="err">，</span><span class="n">我们这里全部用于存储数据</span><span class="err">。</span>
<span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor01</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span>
<span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor01</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里只能一个磁盘一个磁盘的添加</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor01</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">Invoked</span> <span class="p">(</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">):</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor01</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="p">...</span>
<span class="no">[stor01][WARNIN]</span> <span class="p">--&gt;</span> <span class="n">ceph-volume</span> <span class="n">lvm</span> <span class="n">activate</span> <span class="n">successful</span> <span class="k">for</span> <span class="n">osd</span> <span class="n">ID</span><span class="p">:</span> <span class="n">1</span>
<span class="no">[stor01][WARNIN]</span> <span class="p">--&gt;</span> <span class="n">ceph-volume</span> <span class="n">lvm</span> <span class="n">create</span> <span class="n">successful</span> <span class="k">for</span><span class="p">:</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="no">[stor01][INFO  ]</span> <span class="n">checking</span> <span class="n">OSD</span> <span class="n">status</span><span class="p">...</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">find</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">an</span> <span class="n">executable</span>
<span class="no">[stor01][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">stat</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">json</span>
<span class="no">[ceph_deploy.osd][DEBUG ]</span> <span class="n">Host</span> <span class="n">stor01</span> <span class="n">is</span> <span class="n">now</span> <span class="n">ready</span> <span class="k">for</span> <span class="n">osd</span> <span class="n">use</span><span class="p">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看命令执行后的ceph的集群状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>

  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">59m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">27m</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">2</span> <span class="n">osds</span><span class="p">:</span> <span class="n">2</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">98s</span><span class="p">),</span> <span class="n">2</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">98s</span><span class="p">)</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">在services部分</span><span class="err">，</span><span class="n">的osd多了信息</span><span class="err">，</span><span class="n">有两个osd是up的状态</span><span class="p">,</span><span class="n">而且都加入到了集群中</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">接下来</span><span class="err">，</span><span class="n">我们通过批量操作的方式</span><span class="err">，</span><span class="n">将其他节点主机的磁盘都格式化</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">2</span> <span class="n">3</span>
<span class="k">do</span>
  <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor0</span><span class="nv">$i</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span>
  <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor0</span><span class="nv">$i</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="n">done</span>

<span class="n">执行后的效果如下</span><span class="err">：</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">再次查看集群状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">66m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">34m</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">5s</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">5s</span><span class="p">)</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">osd的磁盘数量达到了</span> <span class="n">6个</span><span class="err">，</span><span class="n">都是处于up的状态</span><span class="err">。</span>
    <span class="n">对于ceph集群的数据容量来说</span><span class="err">，</span><span class="n">一共有120G的磁盘空间可以使用</span>
</code></pre></div>
<p>查看节点磁盘状态</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">list</span> <span class="n">stor01</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[ceph_deploy.cli][INFO  ]</span> <span class="n">Invoked</span> <span class="p">(</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">):</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-deploy</span> <span class="n">osd</span> <span class="n">list</span> <span class="n">stor01</span>
<span class="p">...</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">connection</span> <span class="n">detected</span> <span class="n">need</span> <span class="k">for</span> <span class="n">sudo</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">host</span><span class="p">:</span> <span class="n">stor01</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">detect</span> <span class="n">platform</span> <span class="n">information</span> <span class="n">from</span> <span class="n">remote</span> <span class="n">host</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">detect</span> <span class="n">machine</span> <span class="nb">type</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">find</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">an</span> <span class="n">executable</span>
<span class="no">[ceph_deploy.osd][INFO  ]</span> <span class="n">Distro</span> <span class="n">info</span><span class="p">:</span> <span class="n">CentOS</span> <span class="n">Linux</span> <span class="n">7</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">2009</span> <span class="n">Core</span>
<span class="no">[ceph_deploy.osd][DEBUG ]</span> <span class="n">Listing</span> <span class="n">disks</span> <span class="n">on</span> <span class="n">stor01</span><span class="p">...</span>
<span class="no">[stor01][DEBUG ]</span> <span class="n">find</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">an</span> <span class="n">executable</span>
<span class="no">[stor01][INFO  ]</span> <span class="n">Running</span> <span class="n">command</span><span class="p">:</span> <span class="n">sudo</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">sbin</span><span class="p">/</span><span class="n">ceph-volume</span> <span class="n">lvm</span> <span class="n">list</span>
<span class="no">[stor01][DEBUG ]</span>
<span class="no">[stor01][DEBUG ]</span>
<span class="no">[stor01][DEBUG ]</span> <span class="p">======</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="p">=======</span>
<span class="no">[stor01][DEBUG ]</span>
<span class="p">...</span>
<span class="no">[stor01][DEBUG ]</span>       <span class="nb">type </span>                     <span class="n">block</span>
<span class="no">[stor01][DEBUG ]</span>       <span class="n">vdo</span>                       <span class="n">0</span>
<span class="no">[stor01][DEBUG ]</span>       <span class="n">devices</span>                   <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span>
<span class="no">[stor01][DEBUG ]</span>
<span class="no">[stor01][DEBUG ]</span> <span class="p">======</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span> <span class="p">=======</span>
<span class="no">[stor01][DEBUG ]</span>
<span class="p">...</span>
<span class="no">[stor01][DEBUG ]</span>       <span class="nb">type </span>                     <span class="n">block</span>
<span class="no">[stor01][DEBUG ]</span>       <span class="n">vdo</span>                       <span class="n">0</span>
<span class="no">[stor01][DEBUG ]</span>       <span class="n">devices</span>                   <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<p>OSD的磁盘状态查看</p>
<div class="highlight"><pre><span></span><code><span class="n">对于osd来说</span><span class="err">，</span><span class="n">它还有一个专门用于osd管理的</span> <span class="n">命令</span> <span class="n">ceph</span><span class="err">，</span><span class="n">相关的帮助信息如下</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">帮助解析</span><span class="err">：</span>
    <span class="n">这里面有几个是与osd信息查看相关的</span>
    <span class="nb">ls </span>             <span class="n">查看所有OSD的id值</span>
    <span class="n">dump</span>            <span class="n">查看</span> <span class="n">OSD</span> <span class="n">的概述性信息</span>
    <span class="n">status</span>          <span class="n">查看</span> <span class="n">OSD</span> <span class="n">的详细的状态信息</span>
    <span class="n">stat</span>            <span class="n">查看</span> <span class="n">OSD</span> <span class="n">的精简的概述性信息</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看所有OSD的id值</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">ls</span>
<span class="n">0</span>
<span class="n">1</span>
<span class="n">2</span>
<span class="n">3</span>
<span class="n">4</span>
<span class="n">5</span>

<span class="n">查看</span> <span class="n">OSD</span> <span class="n">的概述性信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">25</span>
<span class="p">...</span>
<span class="n">max_osd</span> <span class="n">6</span>
<span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">up</span>   <span class="k">in</span>  <span class="n">weight</span> <span class="n">1</span> <span class="n">up_from</span> <span class="n">5</span> <span class="n">up_thru</span> <span class="n">0</span> <span class="n">down_at</span> <span class="n">0</span> <span class="n">last_clean_interval</span> <span class="p">[</span><span class="n">0</span><span class="p">,</span><span class="n">0</span><span class="p">)</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6802</span><span class="p">/</span><span class="n">5544</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6803</span><span class="p">/</span><span class="n">5544</span><span class="p">]</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6800</span><span class="p">/</span><span class="n">5544</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6801</span><span class="p">/</span><span class="n">5544</span><span class="p">]</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="n">78bd7a7e</span><span class="p">-</span><span class="n">9dcf</span><span class="p">-</span><span class="n">4d91-be20-d5de2fbec7dd</span>
<span class="p">...</span>

<span class="n">查看</span> <span class="n">OSD</span> <span class="n">的精简的概述性信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">stat</span>
<span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">4m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">4m</span><span class="p">);</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">e25</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="126_osd">1.2.6 OSD操作<a class="headerlink" href="#126_osd" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基本实践、进阶实践、小结、三个方面来学习。</p>
<p><strong>基本实践</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">OSD全称Object</span> <span class="n">Storage</span> <span class="n">Device</span><span class="err">，</span><span class="n">负责响应客户端请求返回具体数据的进程</span><span class="err">。</span><span class="n">一个Ceph集群中</span><span class="err">，</span><span class="n">有专门的osd角色主机</span><span class="err">，</span><span class="n">在这个主机中一般有很多个OSD设备</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">对于osd来说</span><span class="err">，</span><span class="n">它还有一个专门用于osd管理的</span> <span class="n">命令</span> <span class="n">ceph</span><span class="err">，</span><span class="n">相关的帮助信息如下</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">帮助解析</span><span class="err">：</span>
    <span class="n">这里面有几个是与osd信息查看相关的</span>
    <span class="nb">ls </span>             <span class="n">查看所有OSD的id值</span>
    <span class="n">dump</span>            <span class="n">查看</span> <span class="n">OSD</span> <span class="n">的概述性信息</span>
    <span class="n">status</span>          <span class="n">查看</span> <span class="n">OSD</span> <span class="n">的详细的状态信息</span>
    <span class="n">stat</span>            <span class="n">查看</span> <span class="n">OSD</span> <span class="n">的精简的概述性信息</span>
    <span class="n">tree</span>            <span class="n">查看</span> <span class="n">OSD</span> <span class="n">在主机上的分布信息</span>
    <span class="n">perf</span>            <span class="n">查看</span> <span class="n">OSD</span> <span class="n">磁盘的延迟统计信息</span>
    <span class="n">df</span>              <span class="n">查看</span> <span class="n">OSD</span> <span class="n">磁盘的使用率信息</span>
</code></pre></div>
<p>命令查看</p>
<div class="highlight"><pre><span></span><code><span class="n">查看所有OSD的id值</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">ls</span>
<span class="n">0</span>
<span class="n">1</span>
<span class="n">2</span>
<span class="n">3</span>
<span class="n">4</span>
<span class="n">5</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看</span> <span class="n">OSD</span> <span class="n">的数据映射信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">25</span>
<span class="p">...</span>
<span class="n">max_osd</span> <span class="n">6</span>
<span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">up</span>   <span class="k">in</span>  <span class="n">weight</span> <span class="n">1</span> <span class="n">up_from</span> <span class="n">5</span> <span class="n">up_thru</span> <span class="n">0</span> <span class="n">down_at</span> <span class="n">0</span> <span class="n">last_clean_interval</span> <span class="p">[</span><span class="n">0</span><span class="p">,</span><span class="n">0</span><span class="p">)</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6802</span><span class="p">/</span><span class="n">5544</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6803</span><span class="p">/</span><span class="n">5544</span><span class="p">]</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6800</span><span class="p">/</span><span class="n">5544</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6801</span><span class="p">/</span><span class="n">5544</span><span class="p">]</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="n">78bd7a7e</span><span class="p">-</span><span class="n">9dcf</span><span class="p">-</span><span class="n">4d91-be20-d5de2fbec7dd</span>
<span class="p">...</span>

<span class="n">查看指定OSD节点的信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span> <span class="n">3</span>
<span class="n">epoch</span> <span class="n">3</span>
<span class="n">fsid</span> <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
<span class="p">...</span>
<span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">down</span> <span class="n">out</span> <span class="n">weight</span> <span class="n">0</span> <span class="n">up_from</span> <span class="n">0</span> <span class="n">up_thru</span> <span class="n">0</span> <span class="n">down_at</span> <span class="n">0</span> <span class="n">last_clean_interval</span> <span class="p">[</span><span class="n">0</span><span class="p">,</span><span class="n">0</span><span class="p">)</span>   <span class="n">exists</span><span class="p">,</span><span class="n">new</span> <span class="n">78bd7a7e</span><span class="p">-</span><span class="n">9dcf</span><span class="p">-</span><span class="n">4d91-be20-d5de2fbec7dd</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看</span> <span class="n">OSD</span> <span class="n">的精简的概述性信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">stat</span>
<span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">4m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">4m</span><span class="p">);</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">e25</span>
<span class="n">状态解析</span><span class="err">：</span>
    <span class="n">OSD节点数量</span><span class="p">(</span><span class="n">osds</span><span class="p">)</span>
    <span class="n">集群内</span><span class="p">(</span><span class="k">in</span><span class="p">)</span><span class="err">、</span><span class="n">集群外</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">运行</span><span class="p">(</span><span class="n">up</span><span class="p">)</span><span class="err">、</span><span class="n">不再运行</span><span class="p">(</span><span class="n">down</span><span class="p">)</span>
    <span class="n">OSD</span> <span class="n">的每一次状态变更的历史信息</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看</span> <span class="n">OSD</span> <span class="n">的详细的状态信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">status</span>
<span class="p">+----+-------+-------+-------+--------+---------+--------+---------+-----------+</span>
<span class="p">|</span> <span class="n">id</span> <span class="p">|</span>  <span class="n">host</span> <span class="p">|</span>  <span class="n">used</span> <span class="p">|</span> <span class="n">avail</span> <span class="p">|</span> <span class="n">wr</span> <span class="n">ops</span> <span class="p">|</span> <span class="n">wr</span> <span class="n">data</span> <span class="p">|</span> <span class="nb">rd </span><span class="n">ops</span> <span class="p">|</span> <span class="nb">rd </span><span class="n">data</span> <span class="p">|</span>   <span class="n">state</span>   <span class="p">|</span>
<span class="p">+----+-------+-------+-------+--------+---------+--------+---------+-----------+</span>
<span class="p">|</span> <span class="n">0</span>  <span class="p">|</span> <span class="n">mon01</span> <span class="p">|</span> <span class="n">1027M</span> <span class="p">|</span> <span class="n">18</span><span class="p">.</span><span class="n">9G</span> <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">1</span>  <span class="p">|</span> <span class="n">mon01</span> <span class="p">|</span> <span class="n">1027M</span> <span class="p">|</span> <span class="n">18</span><span class="p">.</span><span class="n">9G</span> <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">2</span>  <span class="p">|</span> <span class="n">mon02</span> <span class="p">|</span> <span class="n">1027M</span> <span class="p">|</span> <span class="n">18</span><span class="p">.</span><span class="n">9G</span> <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">3</span>  <span class="p">|</span> <span class="n">mon02</span> <span class="p">|</span> <span class="n">1027M</span> <span class="p">|</span> <span class="n">18</span><span class="p">.</span><span class="n">9G</span> <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">4</span>  <span class="p">|</span> <span class="n">mon03</span> <span class="p">|</span> <span class="n">1027M</span> <span class="p">|</span> <span class="n">18</span><span class="p">.</span><span class="n">9G</span> <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">5</span>  <span class="p">|</span> <span class="n">mon03</span> <span class="p">|</span> <span class="n">1027M</span> <span class="p">|</span> <span class="n">18</span><span class="p">.</span><span class="n">9G</span> <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span>    <span class="n">0</span>   <span class="p">|</span>     <span class="n">0</span>   <span class="p">|</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="p">|</span>
<span class="p">+----+-------+-------+-------+--------+---------+--------+---------+-----------+</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看OSD在各个主机上的分布情况</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">-</span><span class="n">5</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon02</span>
 <span class="n">2</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">2</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">3</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">3</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">5</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">5</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看OSD磁盘的延迟统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">perf</span>
<span class="n">osd</span> <span class="n">commit_latency</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="n">apply_latency</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
  <span class="n">5</span>                  <span class="n">0</span>                 <span class="n">0</span>
  <span class="n">4</span>                  <span class="n">0</span>                 <span class="n">0</span>
  <span class="n">0</span>                  <span class="n">0</span>                 <span class="n">0</span>
  <span class="n">1</span>                  <span class="n">0</span>                 <span class="n">0</span>
  <span class="n">2</span>                  <span class="n">0</span>                 <span class="n">0</span>
  <span class="n">3</span>                  <span class="n">0</span>                 <span class="n">0</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">主要解决单块磁盘问题</span><span class="err">，</span><span class="n">如果有问题及时剔除OSD</span><span class="err">。</span><span class="n">统计的是平均值</span>
    <span class="n">commit_latency</span> <span class="n">表示从接收请求到设置commit状态的时间间隔</span>
    <span class="n">apply_latency</span> <span class="n">表示从接收请求到设置apply状态的时间间隔</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看OSD磁盘的使用率信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">df</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="n">REWEIGHT</span> <span class="n">SIZE</span>    <span class="n">RAW</span> <span class="n">USE</span> <span class="n">DATA</span>    <span class="n">OMAP</span> <span class="n">META</span>  <span class="n">AVAIL</span>   <span class="k">%</span><span class="n">USE</span> <span class="n">VAR</span>  <span class="n">PGS</span> <span class="n">STATUS</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span> <span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">1</span> <span class="n">GiB</span>  <span class="n">19</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span>   <span class="n">0</span>     <span class="n">up</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span> <span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">1</span> <span class="n">GiB</span>  <span class="n">19</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span>   <span class="n">0</span>     <span class="n">up</span>
 <span class="n">2</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span> <span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">1</span> <span class="n">GiB</span>  <span class="n">19</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span>   <span class="n">0</span>     <span class="n">up</span>
 <span class="n">3</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span> <span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">1</span> <span class="n">GiB</span>  <span class="n">19</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span>   <span class="n">0</span>     <span class="n">up</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span> <span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">1</span> <span class="n">GiB</span>  <span class="n">19</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span>   <span class="n">0</span>     <span class="n">up</span>
 <span class="n">5</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span> <span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">1</span> <span class="n">GiB</span>  <span class="n">19</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span>   <span class="n">0</span>     <span class="n">up</span>
                    <span class="n">TOTAL</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">6</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span>  <span class="n">20</span> <span class="n">MiB</span>  <span class="n">0</span> <span class="n">B</span> <span class="n">6</span> <span class="n">GiB</span> <span class="n">114</span> <span class="n">GiB</span> <span class="n">5</span><span class="p">.</span><span class="n">02</span>
<span class="n">MIN</span><span class="p">/</span><span class="n">MAX</span> <span class="n">VAR</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">00</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">00</span>  <span class="n">STDDEV</span><span class="p">:</span> <span class="n">0</span>
</code></pre></div>
<p><strong>进阶实践</strong></p>
<p>osd 暂停开启</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pause</span>      <span class="n">集群暂停接收数据</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unpause</span>    <span class="n">集群开始接收数据</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pause</span>
<span class="n">pauserd</span><span class="p">,</span><span class="n">pausewr</span> <span class="n">is</span> <span class="nb">set</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">2h</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">2h</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">107m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">107m</span><span class="p">)</span>
         <span class="n">flags</span> <span class="n">pauserd</span><span class="p">,</span><span class="n">pausewr</span>          <span class="c"># 可以看到，多了pause的标签</span>
  <span class="p">...</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unpause</span>
<span class="n">pauserd</span><span class="p">,</span><span class="n">pausewr</span> <span class="n">is</span> <span class="n">unset</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">2h</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">2h</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">107m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">107m</span><span class="p">)</span>
  <span class="p">...</span>                                   <span class="c"># 可以看到，pause的标签已经被移除</span>
</code></pre></div>
<p>osd数据操作比重</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">osd节点上线</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">reweight</span> <span class="n">osd</span><span class="p">.</span><span class="n">编号</span> <span class="n">权重值</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看默认的OSD操作权重值</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>
<span class="p">...</span>

<span class="n">修改osd的数据操作权重值</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">reweight</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">1</span>
<span class="n">reweighted</span> <span class="n">item</span> <span class="n">id</span> <span class="n">0</span> <span class="n">name</span> <span class="s1">&#39;osd.0&#39;</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="k">in</span> <span class="n">crush</span> <span class="n">map</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">19742</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">11948</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">09999</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>
<span class="p">...</span>

<span class="n">恢复osd的数据操作权重值</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">reweight</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>
<span class="n">reweighted</span> <span class="n">item</span> <span class="n">id</span> <span class="n">0</span> <span class="n">name</span> <span class="s1">&#39;osd.0&#39;</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span> <span class="k">in</span> <span class="n">crush</span> <span class="n">map</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>
</code></pre></div>
<p>osd上下线</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">osd节点上线</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">down</span> <span class="n">osd编号</span>
    <span class="n">osd节点下线</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">up</span> <span class="n">osd编号</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">由于OSD有专门的管理服务器控制</span><span class="err">，</span><span class="n">一旦发现被下线</span><span class="err">，</span><span class="n">会尝试启动它</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将磁盘快速下线</span><span class="err">，</span><span class="n">然后查看状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">down</span> <span class="n">0</span> <span class="p">;</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">marked</span> <span class="n">down</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span><span class="p">.</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>    <span class="n">down</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">...</span>

<span class="n">等待一秒钟后查看状态</span><span class="err">，</span><span class="n">指定的节点又上线了</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">...</span>
</code></pre></div>
<p>驱逐加入OSD对象</p>
<div class="highlight"><pre><span></span><code>命令格式：
    ceph osd out osd编号
    ceph osd in osd编号
注意：
    所谓的从OSD集群中驱离或者加入OSD对象，本质上Ceph集群数据操作的权重值调整
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将0号OSD下线</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">out</span> <span class="n">0</span>
<span class="n">marked</span> <span class="n">out</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span><span class="p">.</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>      <span class="n">up</span>        <span class="n">0</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">...</span> 

<span class="n">将0号OSD上线</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="k">in</span> <span class="n">0</span><span class="p">;</span>
<span class="n">marked</span> <span class="k">in</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span><span class="p">.</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">OSD在上下线实践的时候</span><span class="err">，</span><span class="n">所谓的REWEIGHT会进行调整</span><span class="err">，</span><span class="n">1代表上线</span><span class="err">，</span><span class="n">空代表下线</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="127_osd">1.2.7 OSD节点<a class="headerlink" href="#127_osd" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 OSD删除、OSD添加、小结 三个方面来学习</p>
<p><strong>OSD删除</strong></p>
<p>基本步骤</p>
<div class="highlight"><pre><span></span><code><span class="n">将OSD删除需要遵循一定的步骤</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">修改osd的数据操作权重值</span><span class="err">，</span><span class="n">让数据不分布在这个节点上</span>
    <span class="n">2</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
    <span class="n">3</span> <span class="n">将移除OSD节点状态标记为out</span>
    <span class="n">4</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
    <span class="n">5</span> <span class="n">删除OSD节点</span>
    <span class="n">6</span> <span class="n">删除OSD节点的认证信息</span>
</code></pre></div>
<p>删除OSD节点实践</p>
<div class="highlight"><pre><span></span><code><span class="n">修改osd的数据操作权重值</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">reweight</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">0</span>
<span class="n">reweighted</span> <span class="n">item</span> <span class="n">id</span> <span class="n">5</span> <span class="n">name</span> <span class="s1">&#39;osd.5&#39;</span> <span class="n">to</span> <span class="n">0</span> <span class="k">in</span> <span class="n">crush</span> <span class="n">map</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">01949</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>
 <span class="n">5</span>   <span class="n">hdd</span>       <span class="n">0</span>         <span class="n">osd</span><span class="p">.</span><span class="n">5</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon03</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">disable</span> <span class="n">ceph-osd</span><span class="nv">@5</span>
<span class="n">Removed</span> <span class="n">symlink</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">ceph-osd</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">wants</span><span class="p">/</span><span class="n">ceph-osd</span><span class="nv">@5</span><span class="p">.</span><span class="n">service</span><span class="p">.</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon03</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">ceph-osd</span><span class="nv">@5</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon03</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">ceph-osd</span><span class="nv">@5</span>
<span class="p">...</span>
<span class="n">9月</span> <span class="n">25</span> <span class="n">15</span><span class="p">:</span><span class="n">25</span><span class="p">:</span><span class="n">32</span> <span class="n">mon03</span> <span class="n">systemd</span><span class="p">[</span><span class="n">1</span><span class="p">]:</span> <span class="n">Stopped</span> <span class="n">Ceph</span> <span class="n">object</span> <span class="n">storage</span> <span class="n">daemon</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span><span class="p">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将移除OSD节点状态标记为out</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">out</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="n">marked</span> <span class="n">out</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span><span class="p">.</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">01949</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">5</span>   <span class="n">hdd</span>       <span class="n">0</span>         <span class="n">osd</span><span class="p">.</span><span class="n">5</span>    <span class="n">down</span>        <span class="n">0</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">remove</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="n">removed</span> <span class="n">item</span> <span class="n">id</span> <span class="n">5</span> <span class="n">name</span> <span class="s1">&#39;osd.5&#39;</span> <span class="n">from</span> <span class="n">crush</span> <span class="n">map</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">01949</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">已经被移除了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">删除OSD节点前查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">01949</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">5</span>             <span class="n">0</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span>            <span class="n">down</span>        <span class="n">0</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>

<span class="n">移除无效的osd节点</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">rm </span><span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="n">removed</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span>

<span class="n">再次确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">01949</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">osd节点已经被移除了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看历史认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">ls</span>
<span class="p">...</span>
<span class="n">osd</span><span class="p">.</span><span class="n">5</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">AQCy4C9jI1wzDhAAaPjSPSQpMdu8NUPIRecctQ</span><span class="p">==</span>
        <span class="n">caps</span><span class="p">:</span> <span class="no">[mgr]</span> <span class="n">allow</span> <span class="n">profile</span> <span class="n">osd</span>
        <span class="n">caps</span><span class="p">:</span> <span class="no">[mon]</span> <span class="n">allow</span> <span class="n">profile</span> <span class="n">osd</span>
        <span class="n">caps</span><span class="p">:</span> <span class="no">[osd]</span> <span class="n">allow</span> <span class="p">*</span>
<span class="p">...</span>

<span class="n">删除OSD节点的认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">del </span><span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="n">updated</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">ls</span>
<span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">已经没有历史的节点信息了</span>
</code></pre></div>
<p><strong>OSD添加</strong></p>
<p>基本步骤</p>
<div class="highlight"><pre><span></span><code><span class="n">将OSD增加到集群需要遵循一定的步骤</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">确定OSD节点没有被占用</span>
    <span class="n">2</span> <span class="n">磁盘格式化</span>
    <span class="n">3</span> <span class="n">ceph擦除磁盘上的数据</span>
    <span class="n">4</span> <span class="n">添加OSD到集群</span>
</code></pre></div>
<p>添加OSD节点实践简介</p>
<div class="highlight"><pre><span></span><code><span class="n">确定OSD节点没有被占用</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># blkid | egrep &#39;sd[bc]&#39;</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span><span class="p">:</span> <span class="n">UUID</span><span class="p">=</span><span class="s2">&quot;h3NNr5-Sgr8-nJ8k-QWbY-UiRu-Pbmu-nxs3pZ&quot;</span> <span class="n">TYPE</span><span class="p">=</span><span class="s2">&quot;LVM2_member&quot;</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span><span class="p">:</span> <span class="n">UUID</span><span class="p">=</span><span class="s2">&quot;VdOW5k-zxMN-4Se5-Bxlc-8h93-uhPA-R30P3u&quot;</span> <span class="n">TYPE</span><span class="p">=</span><span class="s2">&quot;LVM2_member&quot;</span>

<span class="n">格式化磁盘失败</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># mkfs.ext4 /dev/sdc</span>
<span class="n">mke2fs</span> <span class="n">1</span><span class="p">.</span><span class="n">42</span><span class="p">.</span><span class="n">9</span> <span class="p">(</span><span class="n">28-Dec</span><span class="p">-</span><span class="n">2013</span><span class="p">)</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span> <span class="n">is</span> <span class="n">entire</span> <span class="n">device</span><span class="p">,</span> <span class="n">not</span> <span class="n">just</span> <span class="n">one</span> <span class="n">partition</span><span class="p">!</span>
<span class="n">无论如何也要继续</span><span class="p">?</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="n">y</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span> <span class="n">is</span> <span class="n">apparently</span> <span class="k">in</span> <span class="n">use</span> <span class="n">by</span> <span class="n">the</span> <span class="n">system</span><span class="p">;</span> <span class="n">will</span> <span class="n">not</span> <span class="n">make</span> <span class="n">a</span> <span class="n">文件系统</span> <span class="n">here</span><span class="p">!</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看被占用的磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># dmsetup status</span>
<span class="n">ceph</span><span class="p">--</span><span class="n">9dd352be</span><span class="p">--</span><span class="n">1b6e</span><span class="p">--</span><span class="n">4d60</span><span class="p">--</span><span class="n">957e</span><span class="p">--</span><span class="n">81c59eafa7b3-osd</span><span class="p">-</span><span class="n">-block</span><span class="p">--</span><span class="n">49251ee9</span><span class="p">-</span><span class="n">-b1cc</span><span class="p">--</span><span class="n">432f</span><span class="p">-</span><span class="n">-aed7</span><span class="p">--</span><span class="n">3af897911b60</span><span class="p">:</span> <span class="n">0</span> <span class="n">41934848</span> <span class="n">linear</span>
<span class="n">ceph</span><span class="p">--</span><span class="n">3712fe04</span><span class="p">-</span><span class="n">-cc04</span><span class="p">--</span><span class="n">4ce4</span><span class="p">-</span><span class="n">-a75e</span><span class="p">-</span><span class="n">-f7f746d62d6f-osd</span><span class="p">-</span><span class="n">-block</span><span class="p">--</span><span class="n">99787a7e</span><span class="p">--</span><span class="n">40ee</span><span class="p">--</span><span class="n">48ae</span><span class="p">--</span><span class="n">802a</span><span class="p">--</span><span class="n">491c4f326d0c</span><span class="p">:</span> <span class="n">0</span> <span class="n">41934848</span> <span class="n">linear</span>

<span class="n">1</span> <span class="n">确定OSD节点没有被占用</span><span class="err">，</span><span class="n">注意ceph的osd挂载目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># cat /var/lib/ceph/osd/ceph-4/fsid</span>
<span class="n">49251ee9-b1cc</span><span class="p">-</span><span class="n">432f-aed7</span><span class="p">-</span><span class="n">3af897911b60</span>

<span class="n">移除被占用磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># dmsetup remove ceph--3712fe04--cc04--4ce4--a75e--f7f746d62d6f-osd--block--99787a7e--40ee--48ae--802a--491c4f326d0c</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># dmsetup status | grep 99787a7e</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">磁盘格式化</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># mkfs.ext4 /dev/sdc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span> <span class="n">ceph擦除磁盘上的数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">zap</span> <span class="n">stor03</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span> <span class="n">添加OSD到集群</span>
<span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">stor03</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">5</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">5</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">之前被移除的osd节点已经被找回来了</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="128">1.2.8 存储实践<a class="headerlink" href="#128" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基本环境、OSD实践、小结、三个方面来学习。</p>
<p><strong>基本环境</strong></p>
<p>存储术语</p>
<div class="highlight"><pre><span></span><code><span class="n">Pool</span>
    <span class="n">RADOS存储集群提供的基础存储服务需要由</span><span class="err">“</span><span class="n">存储池</span><span class="err">（</span><span class="n">pool</span><span class="err">）”</span><span class="n">分割为逻辑存储</span> <span class="n">区域</span><span class="err">，</span><span class="n">此类的逻辑区域亦是对象数据的名称空间</span><span class="err">。</span>

<span class="n">PG</span>
    <span class="n">归置组</span><span class="err">（</span><span class="n">Placement</span> <span class="n">Group</span><span class="err">）</span><span class="n">是用于跨OSD将数据存储在某个存储池中的内部数据</span> <span class="n">结构</span>
    <span class="n">相对于存储池来说</span><span class="err">，</span><span class="n">PG是一个虚拟组件</span><span class="err">，</span><span class="n">它是对象映射到存储池时使用的虚拟层</span>
    <span class="n">是实现大容量集群的关键效率技术</span>

<span class="n">PGP</span> 
     <span class="p">(</span><span class="n">Placement</span> <span class="nb">Group </span><span class="k">for</span> <span class="n">Placement</span><span class="p">)</span><span class="n">是用于维持PG和OSD的一种策略</span><span class="err">。</span>
     <span class="n">防止OSD重新分配时候</span><span class="err">，</span><span class="n">PG找不到之前的OSD</span><span class="err">，</span><span class="n">从而引起大范围的数据迁移</span>

<span class="n">CRUSH</span>
    <span class="n">把对象直接映射到OSD之上会导致二者之间的紧密耦合关系</span><span class="err">，</span><span class="n">在OSD设备变动时不可避免地对整个集群产生扰动</span><span class="err">。</span><span class="n">所以需要一种策略算法来处理这种问题</span><span class="err">。</span>
    <span class="n">Ceph将一个对象映射进RADOS集群的过程分为两步</span>
        <span class="p">-</span> <span class="n">首先是以一致性哈希算法将对象名称映射到PG</span> 
        <span class="p">-</span> <span class="n">而后是将PG</span> <span class="n">ID基于CRUSH算法映射到OSD</span>
    <span class="n">CRUSH</span><span class="p">(</span><span class="n">Controlled</span> <span class="n">Replication</span> <span class="n">Under</span> <span class="n">Scalable</span> <span class="n">Hashing</span><span class="p">),</span><span class="n">它是一种数据分布式算法</span><span class="err">，</span><span class="n">类似于一致性哈希算法</span><span class="err">，</span><span class="n">用于为RADOS存储集群控制数据分布</span><span class="err">。</span>
</code></pre></div>
<p>基本逻辑图</p>
<p><img alt="1636103641572" src="../../../img/kubernetes/kubernetes_storage_ceph/1636103641572-1664092679864.png" /></p>
<p>需求</p>
<div class="highlight"><pre><span></span><code>    <span class="n">OSD平台的目的就是数据的存在</span><span class="err">，</span><span class="n">我们这里就先来简单的演示一下</span><span class="err">，</span><span class="n">OSD环境的数据操作</span><span class="err">。</span><span class="n">这里主要临时演示两个功能</span><span class="p">:</span>
    <span class="n">数据存储</span> <span class="p">-</span> <span class="n">客户端连接至RADOS集群上某存储池</span><span class="p">,</span><span class="n">根据相关的CRUSH规则完成数据对象存储</span><span class="p">.</span>
    <span class="n">数据删除</span> <span class="p">-</span> <span class="n">集合配套的命令</span><span class="err">，</span><span class="n">实现数据的移除功能</span><span class="err">。</span>
</code></pre></div>
<p><strong>OSD实践</strong></p>
<p>创建存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">pg-num</span><span class="p">&gt;</span> <span class="p">[</span><span class="n">pgp-num</span><span class="p">]</span> <span class="no">[replicated]</span> <span class="p">\</span> <span class="p">[</span><span class="n">crush-rule-name</span><span class="p">]</span> <span class="p">[</span><span class="n">expected-num-objects</span><span class="p">]</span>
    <span class="n">参数解析</span><span class="err">：</span>
        <span class="n">pool-name</span><span class="err">：</span><span class="n">存储池名称</span><span class="err">，</span><span class="n">在一个RADOS存储集群上必须具有唯一性</span><span class="err">；</span>
        <span class="n">pg-num</span><span class="err">：</span><span class="n">当前存储池中的PG数量</span><span class="err">，</span><span class="n">一定要合理</span>
        <span class="n">pgp-num</span> <span class="err">：</span><span class="n">用于归置的PG数量</span><span class="err">，</span><span class="n">其值应该等于PG的数量</span>
        <span class="n">replicated</span><span class="err">：</span><span class="n">存储池类型</span><span class="err">；</span><span class="n">副本存储池需更多原始存储空间</span><span class="err">，</span><span class="n">但已实现Ceph支持的所有操</span> <span class="n">作</span>
        <span class="n">crush-ruleset-name</span><span class="err">：</span><span class="n">此存储池所用的CRUSH规则集的名称</span><span class="err">，</span><span class="n">引用的规则集必须事先存在</span>
<span class="n">查看命令</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
    <span class="n">rados</span> <span class="n">lspools</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建一个存储池</span><span class="err">，</span><span class="n">名称为mypool</span><span class="err">，</span><span class="n">pg数量和pgp数量都是16</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">mypool</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">pool</span> <span class="s1">&#39;mypool&#39;</span> <span class="n">created</span>

<span class="n">查看存储池的列表</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="n">mypool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">lspools</span>
<span class="n">mypool</span>
</code></pre></div>
<p>数据的上传</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">虽然我们目前没有形成专用的数据接口</span><span class="err">，</span><span class="n">但是ceph提供了一个原理的文件测试接口</span> <span class="p">--</span> <span class="n">rados命令</span>
    <span class="n">rados</span> <span class="n">put</span> <span class="n">文件对象名</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">file</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">存储池</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">提交文件到对应的osd里面</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">put</span> <span class="n">ceph</span><span class="o">-file</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/</span><span class="n">ceph-cluster</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">mypool</span>

<span class="n">确认上传数据效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">mypool</span>
<span class="n">ceph</span><span class="o">-file</span>
</code></pre></div>
<p>查看数据的存储关系</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">通过属性的方式获取到存储池中数据对象的具体位置信息</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">map</span> <span class="n">存储池</span> <span class="n">文件对象名</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看ceph-file文件对象的内部属性关系</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">map</span> <span class="n">mypool</span> <span class="n">ceph</span><span class="o">-file</span>
<span class="n">osdmap</span> <span class="n">e51</span> <span class="n">pool</span> <span class="s1">&#39;mypool&#39;</span> <span class="p">(</span><span class="n">1</span><span class="p">)</span> <span class="n">object</span> <span class="s1">&#39;ceph-file&#39;</span> <span class="p">-&gt;</span> <span class="n">pg</span> <span class="n">1</span><span class="p">.</span><span class="n">7753490d</span> <span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">d</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">up</span> <span class="p">([</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">5</span><span class="p">],</span> <span class="n">p2</span><span class="p">)</span> <span class="n">acting</span> <span class="p">([</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">5</span><span class="p">],</span> <span class="n">p2</span><span class="p">)</span>
<span class="n">结果解析</span><span class="err">：</span>
    <span class="n">可以看到文件对象的内部属性关系</span>
    <span class="p">[</span> <span class="n">num</span> <span class="p">]</span> <span class="n">是副本所存储的osd</span> <span class="n">id的值</span>
</code></pre></div>
<p>数据删除实践</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">将文件对象从pool里面删除</span>
    <span class="n">rados</span> <span class="nb">rm </span><span class="n">文件对象名</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">存储池</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将刚才添加的文件对象从存储池里面移除</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="nb">rm </span><span class="n">ceph</span><span class="o">-file</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">mypool</span>

<span class="n">查看存储池的内容</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">mypool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="129">1.2.9 存储解析<a class="headerlink" href="#129" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 存储解析、存储删除、小结、三个方面来学习。</p>
<p><strong>基本环境</strong></p>
<p>数据存储逻辑</p>
<p><img alt="1636103641572" src="../../../img/kubernetes/kubernetes_storage_ceph/1636103641572.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">pool</span> <span class="n">是ceph存储数据时的逻辑分区</span><span class="err">，</span><span class="n">它起到据不同的用户场景</span><span class="err">，</span><span class="n">基于namespace实现隔离故障域的作用</span><span class="err">。</span>
<span class="n">每个pool包含一定数量的PG</span><span class="p">,</span> <span class="n">PG里的对象被映射到不同的OSD上</span><span class="err">。</span>
<span class="n">OSD分散到所有的主机磁盘上</span>
</code></pre></div>
<p>存储池基本信息</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="no">[detail]</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="p">{&lt;</span><span class="n">poolname</span><span class="p">&gt;}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看存储池名称</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="n">mypool</span>

<span class="n">查看存储池详情</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span>
<span class="n">pool</span> <span class="n">1</span> <span class="s1">&#39;mypool&#39;</span> <span class="n">replicated</span> <span class="n">size</span> <span class="n">3</span> <span class="n">min_size</span> <span class="n">2</span> <span class="n">crush_rule</span> <span class="n">0</span> <span class="n">object_hash</span> <span class="n">rjenkins</span> <span class="n">pg_num</span> <span class="n">16</span> <span class="n">pgp_num</span> <span class="n">16</span> <span class="n">autoscale_mode</span> <span class="n">warn</span> <span class="n">last_change</span> <span class="n">51</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">0</span>

<span class="n">确认存储池状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">mypool</span>
<span class="n">pool</span> <span class="n">mypool</span> <span class="n">id</span> <span class="n">1</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">对于mypool来说</span><span class="err">，</span><span class="n">它的id是1</span><span class="err">，</span><span class="n">该存储池里面的所有pg都是以1为开头的</span>
</code></pre></div>
<p>存储池&amp;PG</p>
<div class="highlight"><pre><span></span><code><span class="n">通过</span> <span class="n">pg</span> <span class="n">查找</span> <span class="n">pool</span>
    <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="p">|</span> <span class="n">grep</span> <span class="s2">&quot;^{poolid}\.&quot;</span>

<span class="n">通过</span> <span class="n">pool</span> <span class="n">查找</span> <span class="n">pg</span>
    <span class="n">ceph</span> <span class="n">pg</span> <span class="n">ls-by-pool</span> <span class="p">{</span><span class="n">poolname</span><span class="p">}</span>
    <span class="n">ceph</span> <span class="n">pg</span> <span class="nb">ls </span><span class="p">{</span><span class="n">poolid</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">根据pg查找pools</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="p">|</span> <span class="n">grep</span> <span class="s2">&quot;^1. &quot;</span>
<span class="p">...</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="n">pools</span>
<span class="n">POOLID</span> <span class="n">OBJECTS</span> <span class="p">...</span>
<span class="n">1</span>            <span class="n">0</span> <span class="p">...</span>

<span class="n">根据存储池找PG</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">ls-by-pool</span> <span class="n">mypool</span> <span class="p">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $1,$2,$15}&#39;</span>
<span class="n">PG</span> <span class="n">OBJECTS</span> <span class="n">ACTING</span>
<span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">0</span> <span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">5</span><span class="p">,</span><span class="n">0</span><span class="p">]</span><span class="n">p3</span>
<span class="p">...</span>
<span class="n">1</span><span class="p">.</span><span class="n">e</span> <span class="n">0</span> <span class="p">[</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">5</span><span class="p">]</span><span class="n">p2</span>
<span class="n">1</span><span class="p">.</span><span class="n">f</span> <span class="n">0</span> <span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">4</span><span class="p">]</span><span class="n">p3</span>

<span class="n">看出mypool的pg都是以1开头的</span><span class="p">,</span><span class="n">确定pg的分布情况</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="n">pgs</span><span class="p">|</span><span class="n">grep</span> <span class="p">^</span><span class="n">1</span><span class="p">|</span><span class="n">awk</span> <span class="s1">&#39;{print $1,$2,$15,$19}&#39;</span>
<span class="n">dumped</span> <span class="n">pgs</span>
<span class="n">1</span><span class="p">.</span><span class="n">f</span> <span class="n">0</span> <span class="n">0</span><span class="s1">&#39;0 [3,1,4]</span>
<span class="s1">...</span>
<span class="s1">1.9 0 0&#39;</span><span class="n">0</span> <span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="n">1</span><span class="p">]</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">每个pg都会分布在三个osd上</span><span class="err">，</span><span class="n">整个集群有6个osd</span>
</code></pre></div>
<p>PG &amp; OSD</p>
<div class="highlight"><pre><span></span><code><span class="n">通过</span> <span class="n">pg</span> <span class="n">查找</span> <span class="n">osd</span>
    <span class="n">ceph</span> <span class="n">pg</span> <span class="n">map</span> <span class="p">{</span><span class="n">pgid</span><span class="p">}</span>
<span class="n">通过</span> <span class="n">osd</span> <span class="n">查找</span> <span class="n">pg</span>
    <span class="n">ceph</span> <span class="n">pg</span> <span class="n">ls-by-osd</span> <span class="n">osd</span><span class="p">.{</span><span class="n">osdid</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">根据pg找osd的分布</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">map</span> <span class="n">1</span><span class="p">.</span><span class="n">1</span>
<span class="n">osdmap</span> <span class="n">e51</span> <span class="n">pg</span> <span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">up</span> <span class="p">[</span><span class="n">5</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">2</span><span class="p">]</span> <span class="n">acting</span> <span class="p">[</span><span class="n">5</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">2</span><span class="p">]</span>

<span class="n">根据osd找pg的分布</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">ls-by-osd</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span> <span class="p">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $1,$2,$10,$14,$15}&#39;</span>
<span class="n">PG</span> <span class="n">OBJECTS</span> <span class="n">STATE</span> <span class="n">UP</span> <span class="n">ACTING</span>
<span class="n">1</span><span class="p">.</span><span class="n">3</span> <span class="n">0</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span> <span class="p">[</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">,</span><span class="n">5</span><span class="p">]</span><span class="n">p1</span> <span class="p">[</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">,</span><span class="n">5</span><span class="p">]</span><span class="n">p1</span>
<span class="p">...</span>
<span class="n">1</span><span class="p">.</span><span class="n">f</span> <span class="n">0</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span> <span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">4</span><span class="p">]</span><span class="n">p3</span> <span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">4</span><span class="p">]</span><span class="n">p3</span>
<span class="p">*</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">and</span> <span class="n">soon</span> <span class="n">afterwards</span>
</code></pre></div>
<p><strong>存储删除</strong></p>
<p>存储池删除</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">删除存储池命令存在数据丢失的风险</span><span class="err">，</span><span class="n">Ceph于是默认禁止此类操作</span><span class="err">。</span>
    <span class="n">管理员需要在ceph</span><span class="p">.</span><span class="n">conf配置文件中启用支持删除动作</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">存储池名</span> <span class="n">存储池名</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">存储池名称必须出现两遍</span><span class="err">，</span><span class="n">后面的</span> <span class="n">参数代表是强制</span>
</code></pre></div>
<p>删除实践</p>
<div class="highlight"><pre><span></span><code><span class="n">默认情况下删除存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">mypool</span> <span class="n">mypool</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">Error</span> <span class="n">EPERM</span><span class="p">:</span> <span class="n">pool</span> <span class="n">deletion</span> <span class="n">is</span> <span class="n">disabled</span><span class="p">;</span> <span class="n">you</span> <span class="n">must</span> <span class="n">first</span> <span class="nb">set </span><span class="n">the</span> <span class="n">mon_allow_pool_delete</span> <span class="n">config</span> <span class="n">option</span> <span class="n">to</span> <span class="n">true</span> <span class="n">before</span> <span class="n">you</span> <span class="n">can</span> <span class="n">destroy</span> <span class="n">a</span> <span class="n">pool</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">主节点上修改ceph</span><span class="p">.</span><span class="n">conf文件</span><span class="err">，</span><span class="n">增加两行配置</span><span class="err">，</span><span class="n">让其运行删除pool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">tail</span> <span class="n">-n2</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[mon]</span>
<span class="n">mon</span> <span class="n">allow</span> <span class="n">pool</span> <span class="n">delete</span> <span class="p">=</span> <span class="n">true</span>

<span class="n">同步ceph</span><span class="p">.</span><span class="n">conf文件到所有的ceph节点上</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">config</span> <span class="n">push</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>

<span class="n">重启所有的mon节点上的ceph-mon服务</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">mon0</span><span class="p">{</span><span class="n">1</span><span class="p">..</span><span class="n">3</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="nv">$i</span> <span class="s2">&quot;sudo systemctl restart ceph-mon.target&quot;</span><span class="p">;</span> <span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将刚才添加的文件对象从存储池里面移除</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">mypool</span> <span class="n">mypool</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">pool</span> <span class="s1">&#39;mypool&#39;</span> <span class="n">removed</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span>
<span class="n">there</span> <span class="n">are</span> <span class="n">no</span> <span class="n">pools</span><span class="p">!</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="1210">1.2.10 环境完善<a class="headerlink" href="#1210" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 扩展mon、扩展mgr、小结、三个方面来学习。</p>
<p><strong>扩展mon</strong></p>
<p>操作mon节点基础</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">ceph-deploy</span> <span class="n">mon</span> <span class="n">add</span> <span class="n">mon节点名称</span>
    <span class="n">注意</span><span class="err">：</span><span class="n">如果add换成destroy</span><span class="err">，</span><span class="n">则变成移除mon节点</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看ceph的mon状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">3m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">4h</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">60m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">60m</span><span class="p">)</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mon</span> <span class="n">stat</span>
<span class="n">e1</span><span class="p">:</span> <span class="n">3</span> <span class="n">mons</span> <span class="n">at</span> <span class="p">{</span><span class="n">mon01</span><span class="p">=[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">],</span><span class="n">mon02</span><span class="p">=[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">],</span><span class="n">mon03</span><span class="p">=[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]},</span> <span class="n">election</span> <span class="n">epoch</span> <span class="n">6</span><span class="p">,</span> <span class="n">leader</span> <span class="n">0</span> <span class="n">mon01</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span>
</code></pre></div>
<p>移除实践</p>
<div class="highlight"><pre><span></span><code><span class="n">移除mon节点</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">mon</span> <span class="n">destroy</span> <span class="n">mon03</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">2</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span> <span class="p">(</span><span class="n">age</span> <span class="n">9s</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">4h</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">63m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">63m</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">mon03已经被移除了</span>
</code></pre></div>
<p>扩展实践</p>
<div class="highlight"><pre><span></span><code><span class="n">扩展mon实践</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">mon</span> <span class="n">add</span> <span class="n">mon03</span>
<span class="p">...</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">2s</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">4h</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">65m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">65m</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">mon03已经被添加到集群了</span>
</code></pre></div>
<p><strong>扩展mgr</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">Manager在高可用的场景下</span><span class="err">，</span><span class="n">守护进程以</span><span class="err">“</span><span class="n">Active</span><span class="p">/</span><span class="n">Standby</span><span class="err">”</span><span class="n">模式运行</span><span class="err">，</span><span class="n">部署其它ceph-mgr守护程序可确保在Active节点或其上的ceph-mgr守护进程故障时</span><span class="err">，</span><span class="n">其中的一个Standby实例可以在不中断服务的情况下接管其任务</span><span class="err">。</span><span class="n">如果只有一个mgr服务器的话</span><span class="err">，</span><span class="n">守护进程的状态是Active</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">2s</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">4h</span><span class="p">)</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">65m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">65m</span><span class="p">)</span>
</code></pre></div>
<p>扩展实践</p>
<div class="highlight"><pre><span></span><code><span class="n">在当前的环境中</span><span class="err">，</span><span class="n">添加mgr节点</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">mgr</span> <span class="n">create</span> <span class="n">mon02</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">3m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">4h</span><span class="p">),</span> <span class="n">standbys</span><span class="p">:</span> <span class="n">mon02</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">69m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">69m</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">mon01节点就是我们的主角色节点</span><span class="err">，</span><span class="n">mon02是我们的从角色节点</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h1 id="1_1">1 核心实践<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h1>
<h2 id="11_1">1.1 认证管理<a class="headerlink" href="#11_1" title="Permanent link">&para;</a></h2>
<h3 id="111_1">1.1.1 认证基础<a class="headerlink" href="#111_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph作为一个分布式存储系统</span><span class="err">，</span><span class="n">支持对象存储</span><span class="err">、</span><span class="n">块设备和文件系统</span><span class="err">。</span><span class="n">为了在网络传输中防止数据被篡改</span><span class="err">，</span><span class="n">做到较高程度的安全性</span><span class="err">，</span><span class="n">加入了Cephx加密认证协议</span><span class="err">。</span><span class="n">其目的是客户端和管理端之间的身份识别</span><span class="err">，</span><span class="n">加密</span><span class="err">、</span><span class="n">验证传输中的数据</span><span class="err">。</span>
    <span class="n">注意</span><span class="err">：</span><span class="n">所谓的client就是使用ceph命令的客户端</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ceph集群默认开启了cephx协议功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="no">[global]</span>
<span class="p">...</span>
<span class="n">auth_cluster_required</span> <span class="p">=</span> <span class="n">cephx</span>
<span class="n">auth_service_required</span> <span class="p">=</span> <span class="n">cephx</span>
<span class="n">auth_client_required</span> <span class="p">=</span> <span class="n">cephx</span>
<span class="p">...</span>

<span class="n">如果我们提供的是公共的信息</span> <span class="p">--</span> <span class="n">不需要进行认证</span><span class="err">，</span><span class="n">所以我们可以禁用CephX功能</span><span class="err">。</span><span class="n">将对应的属性值设置为</span> <span class="n">none即可</span><span class="err">，</span><span class="n">比如</span>
<span class="n">auth_cluster_required</span> <span class="p">=</span> <span class="n">none</span>
</code></pre></div>
<p>认证场景</p>
<div class="highlight"><pre><span></span><code><span class="n">命令行与Ceph集群操作</span><span class="err">，</span><span class="n">包括</span><span class="err">：</span>
    <span class="n">RadosGW</span> <span class="n">对象网关认证</span><span class="err">（</span><span class="n">对象网关认证系统</span><span class="p">+</span><span class="n">cephx</span><span class="err">）</span>
    <span class="n">RBD</span> <span class="n">认证</span>
    <span class="n">CephFS</span> <span class="n">用户认证</span><span class="err">（</span><span class="n">文件路径</span><span class="p">+</span><span class="n">cephx</span><span class="err">）</span>
<span class="n">Ceph集群内部组件之间通信</span>
    <span class="n">执行ceph命令时</span><span class="err">，</span><span class="n">会使用client</span><span class="p">.</span><span class="n">admin</span> <span class="n">用户并加载</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring文件</span>
</code></pre></div>
<p>认证和授权</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在ceph系统中</span><span class="err">，</span><span class="n">所有元数据保存在mon节点的ceph-mon的进程中</span><span class="err">，</span><span class="n">mon保存了系统中重要的认证相关元数据</span><span class="err">，</span><span class="n">例如每个用户的key以及权限</span><span class="err">。</span><span class="n">样式结构如下</span><span class="err">：</span>

    <span class="n">名称</span>              <span class="n">key</span>     <span class="n">Caps</span><span class="err">（</span><span class="n">权限</span><span class="err">）</span>
    <span class="n">client</span><span class="p">.</span><span class="n">admin</span>    <span class="n">xxxxxx</span>    <span class="n">osd</span> <span class="n">allow</span> <span class="n">rw</span><span class="p">,</span> <span class="n">mon</span> <span class="n">allow</span> <span class="n">rw</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">对于ceph的认证和授权来说</span><span class="err">，</span><span class="n">主要涉及到三个内容</span><span class="err">：</span><span class="n">ceph用户</span><span class="err">、</span><span class="n">资源权限</span><span class="err">、</span><span class="n">用户授权</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">Ceph用户必须拥有执行权限才能执行Ceph的管理命令</span>
    <span class="p">-</span> <span class="n">Ceph用户需要拥有存储池访问权限才能到ceph中读取和写入数据</span>
</code></pre></div>
<p>基本概念</p>
<div class="highlight"><pre><span></span><code><span class="n">用户</span> 
    <span class="p">-</span> <span class="n">ceph创建出来的用户</span><span class="err">，</span><span class="n">可以进入到ceph集群里面</span>
    <span class="p">-</span> <span class="n">ceph支持多种类型</span><span class="err">，</span><span class="n">可管理的用户属于Client类型</span>
    <span class="p">-</span> <span class="n">MON</span><span class="err">、</span><span class="n">OSD和MDS等系统组件属于系统参与者客户端</span>
<span class="n">授权</span>
    <span class="p">-</span> <span class="n">将某些资源的使用权限交给特定的用户</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">allow</span>
<span class="n">权限</span>
    <span class="p">-</span> <span class="n">描述用户可针对MON</span><span class="err">、</span><span class="n">OSD或MDS等资源的使用权限范围或级别</span>
    <span class="p">-</span> <span class="n">MON具备的权限包括r</span><span class="err">、</span><span class="n">w</span><span class="err">、</span><span class="n">x和allow</span> <span class="n">profile</span> <span class="n">cap</span>
    <span class="p">-</span> <span class="n">OSD具备的权限包括r</span><span class="err">、</span><span class="n">w</span><span class="err">、</span><span class="n">x和class-read</span><span class="err">、</span><span class="n">class-write和profile</span> <span class="n">osd</span><span class="err">、</span><span class="n">存储池和名称空间设置</span>
    <span class="p">-</span> <span class="n">OSD具备的权限包括allow</span>
</code></pre></div>
<p>权限解析</p>
<div class="highlight"><pre><span></span><code><span class="n">allow</span>
    <span class="n">需先于守护进程的访问设置指定</span><span class="err">，</span><span class="n">标识赋予的xx权限</span>
<span class="n">r</span><span class="err">：</span><span class="n">读取权限</span><span class="err">，</span><span class="n">访问MON以检索CRUSH时依赖此使能</span>
<span class="n">w</span><span class="err">：</span><span class="n">对象写入权限</span>
<span class="n">x</span><span class="err">：</span><span class="n">调用类方法</span><span class="err">（</span><span class="n">读取和写入</span><span class="err">）</span><span class="n">的能力</span><span class="err">，</span><span class="n">以及在MON上执行auth操作的能力</span>
<span class="n">class-read</span><span class="err">：</span><span class="n">x能力的子集</span><span class="err">，</span><span class="n">授予用户调用类读取方法的能力</span>
<span class="n">class-write</span><span class="err">：</span><span class="n">x的子集</span><span class="err">，</span><span class="n">授予用户调用类写入方法的能力</span>
<span class="p">*</span><span class="err">：</span><span class="n">授予用户对特定守护进程</span><span class="p">/</span><span class="n">存储池的读取</span><span class="err">、</span><span class="n">写入和执行权限</span><span class="err">，</span><span class="n">以及执行管理命令的能力</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">profile</span> <span class="n">osd</span>
    <span class="n">授予用户以某个OSD身份连接到其他OSD或监视器的权限</span>
<span class="n">profile</span> <span class="n">mds</span>
    <span class="n">授予用户以某个MDS身份连接到其他MDS或监视器的权限</span>
<span class="n">profile</span> <span class="n">bootstrap-osd</span>
    <span class="n">授予用户引导OSD的权限</span><span class="err">，</span><span class="n">在部署时候产生</span>
<span class="n">profile</span> <span class="n">bootstrap-mds</span>
    <span class="n">授予用户引导元数据服务器的权限</span><span class="err">，</span><span class="n">在部署时候产生</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>CephX身份验正流程</p>
<p><img alt="image-20211206175437937" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211206175437937.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">client和osd都有一个叫做monclient的模块负责认证和密钥交换</span><span class="err">。</span><span class="n">而monitor上有一个AuthMonitor的服务模块负责与monclient对话</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ceph使用cephx协议对客户端进行身份认证</span>
    <span class="n">每个MON都可以对客户端进行身份验正并分发密钥</span><span class="err">，</span><span class="n">不存在单点故障和性能瓶颈</span><span class="p">,</span><span class="n">MON会返回用于身份验正的数据结构</span><span class="err">，</span><span class="n">其包含获取Ceph服务时用到的session</span> <span class="n">key</span><span class="p">.</span>
    <span class="p">-</span> <span class="n">session</span> <span class="n">key通过客户端密钥进行加密</span>
    <span class="p">-</span> <span class="n">客户端使用session</span> <span class="n">key向MON请求所需的服务</span>
    <span class="p">-</span> <span class="n">MON向客户端提供一个ticket</span><span class="err">，</span><span class="n">用于向实际处理数据的OSD等验正客户端身份</span>
    <span class="p">-</span> <span class="n">MON和OSD共享同一个secret</span><span class="err">，</span><span class="n">因此OSD会信任由MON发放的ticket</span>
    <span class="p">-</span> <span class="n">ticket存在有效期限</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">CephX身份验正功能仅限制Ceph的各组件之间</span><span class="err">，</span><span class="n">它不能扩展到其它非Ceph组件</span><span class="err">；</span>
    <span class="n">它并不解决数据传输加密的问题</span><span class="err">；</span>
</code></pre></div>
<p>CephX身份验正-MDS和OSD</p>
<p><img alt="image-20211206175909027" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211206175909027.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">当client与Monitor实现基本的认证后</span><span class="err">，</span><span class="n">monitor与后端的mds和osd会自动进行认证信息的同步</span>
<span class="n">2</span> <span class="n">当client与Monitor实现基本的通信认证后</span>
    <span class="n">可以独立与后端的MDS服务发送请求</span><span class="err">。</span>
    <span class="n">可以独立与后端的OSD服务发送请求</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="112">1.1.2 用户基础<a class="headerlink" href="#112" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph集群管理员能够直接在Ceph集群中创建</span><span class="err">、</span><span class="n">更新和删除用户</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">创建用户时</span><span class="err">，</span><span class="n">可能需要将密钥分发到客户端</span><span class="err">，</span><span class="n">以便将密钥添加到密钥环</span>
</code></pre></div>
<p>常见命令</p>
<div class="highlight"><pre><span></span><code><span class="n">列出用户</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="n">list</span>
    <span class="n">用户标识</span><span class="err">：</span><span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span><span class="err">，</span><span class="n">因此</span><span class="err">，</span><span class="n">osd</span><span class="p">.</span><span class="n">0表示OSD类型的用户</span><span class="err">，</span><span class="n">用户ID为0</span>

<span class="n">检索特定用户</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID或者ceph</span> <span class="n">auth</span> <span class="n">export</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span>

<span class="n">列出用户的密钥</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>信息查看</p>
<div class="highlight"><pre><span></span><code><span class="n">查看用户账号</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">list</span>
<span class="n">osd</span><span class="p">.</span><span class="n">0</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">AQCv3i9j34BWKhAAII3</span><span class="p">+</span><span class="n">THENuLJTv5Yr2NwDxA</span><span class="p">==</span>
        <span class="n">caps</span><span class="p">:</span> <span class="no">[mgr]</span> <span class="n">allow</span> <span class="n">profile</span> <span class="n">osd</span>
        <span class="n">caps</span><span class="p">:</span> <span class="no">[mon]</span> <span class="n">allow</span> <span class="n">profile</span> <span class="n">osd</span>
        <span class="n">caps</span><span class="p">:</span> <span class="no">[osd]</span> <span class="n">allow</span> <span class="p">*</span>
<span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">每个osd都有类似的caps权限信息</span>
    <span class="n">client</span><span class="p">.</span><span class="n">admin具备的权限是非常多的</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看制定的认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span>
<span class="no">[osd.0]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQCv3i9j34BWKhAAII3</span><span class="p">+</span><span class="n">THENuLJTv5Yr2NwDxA</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mgr</span> <span class="p">=</span> <span class="s2">&quot;allow profile osd&quot;</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow profile osd&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看秘钥文件信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">ls </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>  <span class="n">rbdmap</span>  <span class="n">tmpr0oj5H</span>

<span class="n">查看秘钥环相关的信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.admin]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQAr0S9jK8RNLxAAD</span><span class="p">/</span><span class="n">xpDZgnAx1kQEV3</span><span class="p">+/</span><span class="n">utWw</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mds</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">mgr</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">一个秘钥环里面可以存放很多秘钥信息的</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">列出用户秘钥信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">mgr</span><span class="p">.</span><span class="n">mon01</span>
<span class="n">AQC12C9j</span><span class="p">/</span><span class="n">hAgKhAA6lOZiUpz5kqA55PFv3eHng</span><span class="p">==</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="113_1">1.1.3 用户实践<a class="headerlink" href="#113_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在ceph中</span><span class="err">，</span><span class="n">针对用户主要有两种场景</span><span class="err">：</span><span class="n">增删和导出导入</span>
</code></pre></div>
<p>命令解析</p>
<div class="highlight"><pre><span></span><code><span class="n">添加用户</span>
    <span class="n">ceph</span> <span class="n">auth</span> <span class="n">add</span><span class="err">：</span><span class="n">创建用户</span><span class="err">、</span><span class="n">生成密钥并添加指定的caps</span>
    <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span><span class="err">：</span><span class="n">创建用户并返回密钥文件格式的密钥信息</span><span class="err">，</span><span class="n">用户存在时返回密钥信息</span>
    <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create-key</span><span class="err">：</span><span class="n">创建用户并返回密钥信息</span><span class="err">，</span><span class="n">用户存在时返回密钥信息</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">典型的用户至少对</span> <span class="n">Ceph</span> <span class="n">monitor</span> <span class="n">具有读取功能</span><span class="err">，</span><span class="n">并对</span> <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">具有读取和写入功能</span><span class="err">；</span>
    <span class="n">另外</span><span class="err">，</span><span class="n">用户的</span> <span class="n">OSD</span> <span class="n">权限通常应该限制为只能访问特定的存储池</span><span class="err">，</span>
    <span class="n">否则</span><span class="err">，</span><span class="n">他将具有访问集群中所有存储池的权限</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">导入用户</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="n">import</span>

<span class="n">修改用户caps</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="n">caps</span>
        <span class="n">会覆盖用户现有的caps</span><span class="err">，</span><span class="n">因此建立事先使用ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID命令查看用户的caps</span>
    <span class="n">若是为添加caps</span><span class="err">，</span><span class="n">则需要先指定现有的caps</span><span class="p">,</span><span class="n">命令格式如下</span><span class="err">：</span>
        <span class="n">ceph</span> <span class="n">auth</span> <span class="n">caps</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span> <span class="n">daemon</span> <span class="s1">&#39;allow [r|w|x|*|...] [pool=pool-name]&#39;</span> <span class="p">...</span>

<span class="n">删除用户</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="nb">del </span><span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>添加用户</p>
<div class="highlight"><pre><span></span><code><span class="n">查看帮助信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="p">-</span><span class="n">-help</span>

 <span class="n">General</span> <span class="n">usage</span><span class="p">:</span>
 <span class="p">==============</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">ceph</span> <span class="p">[</span><span class="n">-h</span><span class="p">]</span> <span class="p">[</span><span class="n">-c</span> <span class="n">CEPHCONF</span><span class="p">]</span> <span class="p">[</span><span class="n">-i</span> <span class="n">INPUT_FILE</span><span class="p">]</span> <span class="p">[</span><span class="n">-o</span> <span class="n">OUTPUT_FILE</span><span class="p">]</span>
            <span class="p">[-</span><span class="n">-setuser</span> <span class="n">SETUSER</span><span class="p">]</span> <span class="p">[-</span><span class="n">-setgroup</span> <span class="n">SETGROUP</span><span class="p">]</span> <span class="p">[-</span><span class="n">-id</span> <span class="n">CLIENT_ID</span><span class="p">]</span>
            <span class="p">[-</span><span class="n">-name</span> <span class="n">CLIENT_NAME</span><span class="p">]</span> <span class="p">[-</span><span class="n">-cluster</span> <span class="n">CLUSTER</span><span class="p">]</span>
            <span class="p">[-</span><span class="n">-admin-daemon</span> <span class="n">ADMIN_SOCKET</span><span class="p">]</span> <span class="p">[</span><span class="n">-s</span><span class="p">]</span> <span class="p">[</span><span class="n">-w</span><span class="p">]</span> <span class="p">[-</span><span class="n">-watch-debug</span><span class="p">]</span>
            <span class="p">[-</span><span class="n">-watch-info</span><span class="p">]</span> <span class="p">[-</span><span class="n">-watch-sec</span><span class="p">]</span> <span class="p">[-</span><span class="n">-watch-warn</span><span class="p">]</span> <span class="p">[-</span><span class="n">-watch-error</span><span class="p">]</span>
            <span class="p">[-</span><span class="n">-watch-channel</span> <span class="p">{</span><span class="n">cluster</span><span class="p">,</span><span class="n">audit</span><span class="p">,*}]</span> <span class="p">[-</span><span class="n">-version</span><span class="p">]</span> <span class="p">[-</span><span class="n">-verbose</span><span class="p">]</span>
            <span class="p">[-</span><span class="n">-concise</span><span class="p">]</span> <span class="p">[</span><span class="o">-f</span> <span class="p">{</span><span class="n">json</span><span class="p">,</span><span class="n">json-pretty</span><span class="p">,</span><span class="n">xml</span><span class="p">,</span><span class="n">xml-pretty</span><span class="p">,</span><span class="n">plain</span><span class="p">}]</span>
            <span class="p">[-</span><span class="n">-connect-timeout</span> <span class="n">CLUSTER_TIMEOUT</span><span class="p">]</span> <span class="p">[-</span><span class="n">-block</span><span class="p">]</span> <span class="p">[-</span><span class="n">-period</span> <span class="n">PERIOD</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建普通用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">add</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow rw pool=rdbpool&#39;</span>
<span class="n">added</span> <span class="n">key</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>

<span class="n">获取创建的用户信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>

<span class="n">列出用户的秘钥信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
</code></pre></div>
<p>用户授权</p>
<div class="highlight"><pre><span></span><code><span class="n">修改用户的授权</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">caps</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span> <span class="n">mon</span> <span class="s1">&#39;allow rw&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow rw pool=rdbpool1&#39;</span>
<span class="n">updated</span> <span class="n">caps</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>

<span class="n">查看修改后的授权信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow rw&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool1&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
</code></pre></div>
<p>导出用户</p>
<div class="highlight"><pre><span></span><code><span class="n">查看导出信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">export</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow rw&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool1&quot;</span>
<span class="n">export</span> <span class="n">auth</span><span class="p">(</span><span class="n">key</span><span class="p">=</span><span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">导出信息到一个备份文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">export</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span> <span class="p">&gt;</span> <span class="n">testuser</span><span class="p">.</span><span class="n">file</span>
<span class="n">export</span> <span class="n">auth</span><span class="p">(</span><span class="n">key</span><span class="p">=</span><span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==)</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">testuser</span><span class="p">.</span><span class="n">file</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow rw&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool1&quot;</span>
</code></pre></div>
<p>删除用户</p>
<div class="highlight"><pre><span></span><code><span class="n">删除用户信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">del </span><span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="n">updated</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="n">Error</span> <span class="n">ENOENT</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">find</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span> <span class="k">in</span> <span class="n">keyring</span>
</code></pre></div>
<p>导入用户</p>
<div class="highlight"><pre><span></span><code><span class="n">导入用户文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span>  <span class="n">import</span> <span class="n">-i</span> <span class="n">testuser</span><span class="p">.</span><span class="n">file</span>
<span class="n">imported</span> <span class="n">keyring</span>

<span class="n">查看文件效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow rw&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool1&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
</code></pre></div>
<p>尝试创建一个未知的用户</p>
<div class="highlight"><pre><span></span><code><span class="n">创建一个已知的用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">如果是一个已存在的用户名</span><span class="err">，</span><span class="n">则会返回具体的信息</span><span class="err">，</span><span class="n">而且不会覆盖现有的用户信息</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
<span class="no">[client.testuser]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDfOTBjsmRaEhAATcpXwDluXBpshy4420</span><span class="p">/</span><span class="n">zgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow rw&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool1&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建一个未知的用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser2</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow rw pool=rdbpool&#39;</span>
<span class="no">[client.testuser2]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQAwPDBjHPByABAA</span><span class="p">+</span><span class="n">nMEvAXztrzE8FSCZkNGgg</span><span class="p">==</span>

<span class="n">如果从未出现过的用户</span><span class="err">，</span><span class="n">则直接创建新的用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser2</span>
<span class="no">[client.testuser2]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQAwPDBjHPByABAA</span><span class="p">+</span><span class="n">nMEvAXztrzE8FSCZkNGgg</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rw pool=rdbpool&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">testuser2</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="114_1">1.1.4 秘钥管理<a class="headerlink" href="#114_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>keyring</p>
<div class="highlight"><pre><span></span><code>    <span class="n">密钥环文件是</span><span class="err">“</span><span class="n">存储机密</span><span class="err">、</span><span class="n">密码</span><span class="err">、</span><span class="n">密钥</span><span class="err">、</span><span class="n">证书并使它们可用于应用程序的组件的集合</span><span class="err">”。</span><span class="n">密钥环文件存储一个或多个</span> <span class="n">Ceph</span> <span class="n">身份验证密钥以及可能的相关功能规范</span><span class="err">。</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">每个键都与一个实体名称相关联</span><span class="err">，</span><span class="n">形式为</span> <span class="p">{</span><span class="n">client</span><span class="p">,</span><span class="n">mon</span><span class="p">,</span><span class="n">mds</span><span class="p">,</span><span class="n">osd</span><span class="p">}.</span><span class="n">name</span><span class="err">。</span>
    <span class="n">ceph-authtool</span> <span class="n">是一个用于创建</span><span class="err">、</span><span class="n">查看和修改</span> <span class="n">Ceph</span> <span class="n">密钥环文件的实用程序</span><span class="err">。</span>
</code></pre></div>
<p>秘钥环文件信息</p>
<div class="highlight"><pre><span></span><code><span class="n">访问Ceph集群时</span><span class="err">，</span><span class="n">客户端会于本地查找密钥环</span><span class="err">，</span><span class="n">只有</span><span class="err">，</span><span class="n">认证成功的对象</span><span class="err">，</span><span class="n">才可以正常使用</span><span class="err">。</span>

<span class="n">默认情况下</span><span class="err">，</span><span class="n">Ceph会使用以下四个密钥环名称预设密钥环</span>
    <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">cluster-name</span><span class="p">.</span><span class="n">user-name</span><span class="p">.</span><span class="n">keyring</span><span class="err">：</span><span class="n">保存单个用户的keyring</span>
    <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span><span class="err">：</span><span class="n">保存多个用户的keyring</span>
    <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">keyring</span>
    <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">keyring</span><span class="p">.</span><span class="n">bin</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">cluster-name是为集群名称</span><span class="err">，</span><span class="n">user-name是为用户标识</span><span class="err">（</span><span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span><span class="err">）</span>
        <span class="n">client</span><span class="p">.</span><span class="n">admin用户的在名为ceph的集群上的密钥环文件名为ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
</code></pre></div>
<p>keyring的管理</p>
<div class="highlight"><pre><span></span><code><span class="n">创建keyring</span>
    <span class="n">ceph</span> <span class="n">auth</span> <span class="n">add等命令添加的用户还需要额外使用ceph-authtool命令为其创建用户密钥环文件</span><span class="p">,</span><span class="n">ceph客户端通过keyring文件查找用户名并检索密钥</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph-authtool</span> <span class="p">-</span><span class="n">-create-keyring</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">kerying</span>
<span class="n">注意</span>
    <span class="n">keyring文件一般应该保存于</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph目录中</span><span class="err">，</span><span class="n">以便客户端能自动查找</span>
    <span class="n">创建包含多个用户的keyring文件时</span><span class="err">，</span><span class="n">应该使用cluster-name</span><span class="p">.</span><span class="n">keyring作为文件名</span>
    <span class="n">创建仅包含单个用户的kerying文件时</span><span class="err">，</span><span class="n">应该使用cluster-name</span><span class="p">.</span><span class="n">user-name</span><span class="p">.</span><span class="n">keyring作为文件名</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将用户添加至keyring</span>
    <span class="n">可将某个用户从包含多个用户的keyring中导出</span><span class="err">，</span><span class="n">并保存于一个专用的keyring文件</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span> <span class="n">-o</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">cluster-name</span><span class="p">.</span><span class="n">user-name</span><span class="p">.</span><span class="n">keyring</span>

    <span class="n">也可将用户的keyring合并至一个统一的keyring文件中</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">ceph-authtool</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">cluster-name</span><span class="p">.</span><span class="n">keyring</span> <span class="p">-</span><span class="n">-import-key</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">clustername</span><span class="p">.</span>
<span class="n">user-name</span><span class="p">.</span><span class="n">keyring</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ceph-authtool命令可直接创建用户</span><span class="err">、</span><span class="n">授予caps并创建keyring</span>
    <span class="n">ceph-authtool</span> <span class="n">keyringfile</span> <span class="p">[</span><span class="n">-C</span> <span class="p">|</span> <span class="p">-</span><span class="n">-create-keyring</span><span class="p">]</span> <span class="p">[</span><span class="n">-n</span> <span class="p">|</span> <span class="p">-</span><span class="n">-name</span> <span class="n">entityname</span><span class="p">]</span> <span class="p">[-</span><span class="n">-genkey</span><span class="p">]</span>
<span class="p">[</span><span class="n">-a</span> <span class="p">|</span> <span class="p">-</span><span class="n">-add-key</span> <span class="n">base64_key</span><span class="p">]</span> <span class="p">[-</span><span class="n">-cap</span> <span class="p">|</span> <span class="p">-</span><span class="n">-caps</span> <span class="n">capfile</span><span class="p">]</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">此种方式添加的用户仅存在于keyring文件中</span><span class="err">，</span><span class="n">管理员还需要额外将其添加至Ceph集群上</span><span class="err">；</span>
    <span class="n">命令</span><span class="err">：</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">add</span> <span class="n">TYPE</span><span class="p">.</span><span class="n">ID</span> <span class="n">-i</span> <span class="p">/</span><span class="n">PATH</span><span class="p">/</span><span class="n">TO</span><span class="p">/</span><span class="n">keyring</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>创建携带秘钥环的账号</p>
<div class="highlight"><pre><span></span><code><span class="n">创建普通格式的用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow * pool=kube&#39;</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看用户信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow * pool=kube&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span>

<span class="n">查看文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">ls</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-mds</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-rgw</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph-deploy-ceph</span><span class="p">.</span><span class="n">log</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-mgr</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>   <span class="n">ceph</span><span class="p">.</span><span class="n">mon</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">bootstrap-osd</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>                   <span class="n">testuser</span><span class="p">.</span><span class="n">file</span>                  
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">没有生成对应的用户秘钥环文件</span>
</code></pre></div>
<p>导出秘钥环文件</p>
<div class="highlight"><pre><span></span><code><span class="n">将普通的用户导出为keyring</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span> <span class="n">-o</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ll</span> <span class="p">*</span><span class="n">kube</span><span class="p">*</span>
<span class="n">-rw-rw-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">cephadm</span> <span class="n">cephadm</span> <span class="n">117</span> <span class="n">9月</span>  <span class="n">26</span> <span class="n">06</span><span class="p">:</span><span class="n">26</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow * pool=kube&quot;</span>
</code></pre></div>
<p>合并秘钥环文件</p>
<div class="highlight"><pre><span></span><code><span class="n">创建要合并的文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-authtool</span> <span class="p">-</span><span class="n">-create-keyring</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">creating</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ll</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">-rw</span><span class="p">-------</span> <span class="n">1</span> <span class="n">cephadm</span> <span class="n">cephadm</span> <span class="n">0</span> <span class="n">9月</span>  <span class="n">26</span> <span class="n">06</span><span class="p">:</span><span class="n">28</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">合并要导入的keyring文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-authtool</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span> <span class="p">-</span><span class="n">-import-keyring</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">importing</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span> <span class="n">into</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow * pool=kube&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">再来合并一个用户</span>
<span class="n">c</span><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-authtool</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span> <span class="p">-</span><span class="n">-import-keyring</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">importing</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span> <span class="n">into</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">查看合并后效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.admin]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQAr0S9jK8RNLxAAD</span><span class="p">/</span><span class="n">xpDZgnAx1kQEV3</span><span class="p">+/</span><span class="n">utWw</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mds</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">mgr</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow * pool=kube&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">专用查看keyring的内容</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-authtool</span> <span class="n">-l</span> <span class="n">cluster</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.admin]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQAr0S9jK8RNLxAAD</span><span class="p">/</span><span class="n">xpDZgnAx1kQEV3</span><span class="p">+/</span><span class="n">utWw</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mds</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">mgr</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow *&quot;</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow * pool=kube&quot;</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="12_rbd">1.2 RBD接口<a class="headerlink" href="#12_rbd" title="Permanent link">&para;</a></h2>
<h3 id="121_1">1.2.1 基础知识<a class="headerlink" href="#121_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<p><img alt="1636089258096" src="../../../img/kubernetes/kubernetes_storage_ceph/1636089258096.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph块设备</span><span class="err">，</span><span class="n">也称为RADOS块设备</span><span class="err">（</span><span class="n">简称RBD</span><span class="err">），</span><span class="n">是一种基于RADOS存储系统支持超配</span><span class="err">（</span><span class="n">thin-provisioned</span><span class="err">）、</span><span class="n">可伸缩的条带化数据存储系统</span><span class="err">，</span><span class="n">它通过librbd库与OSD进行交互</span><span class="err">。</span><span class="n">RBD为KVM等虚拟化技术和云OS</span><span class="err">（</span><span class="n">如OpenStack和CloudStack</span><span class="err">）</span><span class="n">提供高性能和无限可扩展性的存储后端</span><span class="err">，</span><span class="n">这些系统依赖于libvirt和QEMU实用程序与RBD进行集成</span><span class="err">。</span>
</code></pre></div>
<p>RBD</p>
<div class="highlight"><pre><span></span><code><span class="n">RBD</span><span class="err">，</span><span class="n">全称RADOS</span> <span class="n">Block</span> <span class="n">Devices</span><span class="err">，</span><span class="n">是一种建构在RADOS存储集群之上为客户端提供块设备接口的存储服务中间层</span><span class="p">.</span>
    <span class="p">-</span> <span class="n">这类的客户端包括虚拟化程序KVM</span><span class="err">（</span><span class="n">结合qemu</span><span class="err">）</span><span class="n">和云的计算操作系统OpenStack和CloudStack等</span>

<span class="n">RBD基于RADOS存储集群中的多个OSD进行条带化</span><span class="err">，</span><span class="n">支持存储空间的简配</span><span class="err">（</span><span class="n">thinprovisioning</span><span class="err">）</span><span class="n">和动态扩容等特性</span><span class="err">，</span><span class="n">并能够借助于RADOS集群实现快照</span><span class="err">、</span><span class="n">副本和一致性</span><span class="err">。</span><span class="n">同时</span><span class="err">，</span><span class="n">RBD自身也是RADOS存储集群的客户端</span><span class="err">，</span><span class="n">它通过将存储池提供的存储服务抽象为一到多个image</span><span class="err">（</span><span class="n">表现为块设备</span><span class="err">）</span><span class="n">向客户端提供块级别的存储接口</span>
    <span class="p">-</span> <span class="n">RBD支持两种格式的image</span><span class="err">，</span><span class="n">不过v1格式因特性较少等原因已经处于废弃状态</span>
    <span class="p">-</span> <span class="n">当前默认使用的为v2格式</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">客户端访问RBD设备的方式有两种</span>
    <span class="p">-</span> <span class="n">通过内核模块rbd</span><span class="p">.</span><span class="n">ko将image映射为节点本地的块设备</span><span class="err">，</span><span class="n">相关的设备文件一般为</span><span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rdb</span><span class="c">#（#为设备编号，例如rdb0等）</span>
    <span class="p">-</span> <span class="n">通过librbd提供的API接口</span><span class="err">，</span><span class="n">它支持C</span><span class="p">/</span><span class="n">C</span><span class="p">++</span><span class="n">和Python等编程语言</span><span class="err">，</span><span class="n">qemu即是此类接口的客户端</span>
</code></pre></div>
<p>操作逻辑</p>
<div class="highlight"><pre><span></span><code>    <span class="n">RBD接口在ceph环境创建完毕后</span><span class="err">，</span><span class="n">就在服务端自动提供了</span><span class="p">;</span> <span class="n">客户端基于librbd库即可将RADOS存储集群用作块设备</span><span class="err">。</span><span class="n">不过</span><span class="err">，</span><span class="n">RADOS集群体用块设备需要经过一系列的</span><span class="s2">&quot;额外操作&quot;</span><span class="n">才能够为客户端提供正常的存储功能</span><span class="err">。</span>
    <span class="n">这个过程步骤</span><span class="err">，</span><span class="n">主要有以下几步</span><span class="err">：</span>
        <span class="p">-</span> <span class="n">1</span> <span class="n">创建一个专用的存储池</span>
            <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="p">{</span><span class="n">pool-name</span><span class="p">}</span> <span class="p">{</span><span class="n">pg-num</span><span class="p">}</span> <span class="p">{</span><span class="n">pgp-num</span><span class="p">}</span>
        <span class="p">-</span> <span class="n">2</span> <span class="n">对存储池启用rbd功能</span>
            <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">enable</span> <span class="p">{</span><span class="n">pool-name</span><span class="p">}</span> <span class="n">rbd</span>
        <span class="p">-</span> <span class="n">3</span> <span class="n">对存储池进行环境初始化</span>
            <span class="n">rbd</span> <span class="n">pool</span> <span class="n">init</span> <span class="n">-p</span> <span class="p">{</span><span class="n">pool-name</span><span class="p">}</span>
        <span class="p">-</span> <span class="n">4</span> <span class="n">基于存储池创建专用的磁盘镜像</span>
            <span class="n">rbd</span> <span class="n">create</span> <span class="p">-</span><span class="n">-size</span> <span class="p">&lt;</span><span class="n">megabytes</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">image-name</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其他命令</span>
    <span class="n">存储池中的各image名称需要惟一</span><span class="err">，“</span><span class="n">rbd</span> <span class="n">ls</span><span class="err">”</span><span class="n">命令能够列出指定存储池中的image</span>
    <span class="n">rbd</span> <span class="nb">ls </span><span class="p">[</span><span class="n">-p</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-format</span> <span class="n">json</span><span class="p">|</span><span class="n">xml</span><span class="p">]</span> <span class="p">[-</span><span class="n">-pretty-format</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span>

    <span class="n">要获取指定image的详细信息</span><span class="err">，</span><span class="n">则通常使用</span><span class="err">“</span><span class="n">rbd</span> <span class="n">info</span><span class="err">”</span><span class="n">命令</span>
    <span class="n">rbd</span> <span class="n">info</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span>  <span class="p">[-</span><span class="n">-format</span> <span class="p">&lt;</span><span class="n">format</span><span class="p">&gt;]</span> <span class="p">...</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>创建专用存储池</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">rbddata</span> <span class="n">64</span>
<span class="n">pool</span> <span class="s1">&#39;rbddata&#39;</span> <span class="n">created</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里面的pg数量</span><span class="err">，</span><span class="n">我们定制为64个</span>
</code></pre></div>
<p>对存储池启用rbd功能</p>
<div class="highlight"><pre><span></span><code><span class="n">启用存储池的rbd功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">enable</span> <span class="n">rbddata</span> <span class="n">rbd</span>
<span class="n">enabled</span> <span class="n">application</span> <span class="s1">&#39;rbd&#39;</span> <span class="n">on</span> <span class="n">pool</span> <span class="s1">&#39;rbddata&#39;</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">如果关闭应用的话</span><span class="err">，</span><span class="n">使用disable</span>

<span class="n">查看rbc的效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">get</span> <span class="n">rbddata</span>
<span class="p">{</span>
    <span class="s2">&quot;rbd&quot;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>
<p>对存储池进行环境初始化</p>
<div class="highlight"><pre><span></span><code><span class="n">环境初始化</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">init</span> <span class="n">-p</span> <span class="n">rbddata</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">rbddata</span>
<span class="n">Total</span> <span class="n">Images</span><span class="p">:</span> <span class="n">0</span>
<span class="n">Total</span> <span class="n">Snapshots</span><span class="p">:</span> <span class="n">0</span>
<span class="n">Provisioned</span> <span class="n">Size</span><span class="p">:</span> <span class="n">0</span> <span class="n">B</span>
</code></pre></div>
<p>基于存储池创建专用的磁盘镜像</p>
<div class="highlight"><pre><span></span><code><span class="n">创建镜像</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">create</span> <span class="n">img1</span> <span class="p">-</span><span class="n">-size</span> <span class="n">1024</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">rbddata</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">rbddata</span>
<span class="n">img1</span>

<span class="n">查看状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">rbddata</span>
<span class="n">Total</span> <span class="n">Images</span><span class="p">:</span> <span class="n">1</span>
<span class="n">Total</span> <span class="n">Snapshots</span><span class="p">:</span> <span class="n">0</span>
<span class="n">Provisioned</span> <span class="n">Size</span><span class="p">:</span> <span class="n">1</span> <span class="n">GiB</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">这个时候</span><span class="err">，</span><span class="n">我们创建出来的磁盘影响文件</span><span class="err">，</span><span class="n">就可以在客户端上</span><span class="err">，</span><span class="n">通过内核机制</span><span class="err">，</span><span class="n">直接导入到内核中</span><span class="err">，</span><span class="n">在内核中被当成一个磁盘设备来进行使用</span><span class="err">，</span><span class="n">样式就是</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">xxx</span><span class="err">，</span><span class="n">然后就可以针对这个rdb磁盘设备</span><span class="err">，</span><span class="n">进行各种后续分区</span><span class="err">、</span><span class="n">格式化等操作</span><span class="err">。</span>
</code></pre></div>
<p>查看磁盘信息</p>
<div class="highlight"><pre><span></span><code><span class="n">查看方法1</span><span class="err">：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">info</span> <span class="n">rbddata</span><span class="p">/</span><span class="n">img1</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="p">-</span><span class="n">-image</span> <span class="n">img1</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">rbddata</span> <span class="n">info</span>
<span class="n">rbd</span> <span class="n">image</span> <span class="s1">&#39;img1&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">1</span> <span class="n">GiB</span> <span class="k">in</span> <span class="n">256</span> <span class="n">objects</span>
        <span class="n">order</span> <span class="n">22</span> <span class="p">(</span><span class="n">4</span> <span class="n">MiB</span> <span class="n">objects</span><span class="p">)</span>
        <span class="n">snapshot_count</span><span class="p">:</span> <span class="n">0</span>
        <span class="n">id</span><span class="p">:</span> <span class="n">3817a3738fac</span>
        <span class="n">block_name_prefix</span><span class="p">:</span> <span class="n">rbd_data</span><span class="p">.</span><span class="n">3817a3738fac</span>
        <span class="n">format</span><span class="p">:</span> <span class="n">2</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">layering</span><span class="p">,</span> <span class="n">exclusive-lock</span><span class="p">,</span> <span class="n">object-map</span><span class="p">,</span> <span class="n">fast-diff</span><span class="p">,</span> <span class="n">deep-flatten</span>
        <span class="n">op_features</span><span class="p">:</span>
        <span class="n">flags</span><span class="p">:</span>
        <span class="n">create_timestamp</span><span class="p">:</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">10</span><span class="p">:</span><span class="n">46</span><span class="p">:</span><span class="n">25</span> <span class="n">2062</span>
        <span class="n">access_timestamp</span><span class="p">:</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">10</span><span class="p">:</span><span class="n">46</span><span class="p">:</span><span class="n">25</span> <span class="n">2062</span>
        <span class="n">modify_timestamp</span><span class="p">:</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">10</span><span class="p">:</span><span class="n">46</span><span class="p">:</span><span class="n">25</span> <span class="n">2062</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">size</span> <span class="p">:</span> <span class="n">就是这个块的大小</span><span class="err">，</span><span class="n">即1024MB</span><span class="p">=</span><span class="n">1G</span><span class="err">，</span><span class="n">1024MB</span><span class="p">/</span><span class="n">256</span> <span class="p">=</span> <span class="n">4M</span><span class="p">,</span><span class="n">共分成了256个对象</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="err">，</span><span class="n">每个对象4M</span><span class="err">。</span>
<span class="n">order</span> <span class="n">22</span><span class="err">：</span> <span class="n">有效范围为12</span><span class="p">-</span><span class="n">25</span><span class="err">。</span><span class="n">22是个幂编号</span><span class="err">，</span><span class="n">4M是22</span><span class="err">，</span> <span class="n">8M是23</span><span class="err">，</span><span class="n">也就是2</span><span class="p">^</span><span class="n">22</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">4MB</span><span class="p">,</span> <span class="n">2</span><span class="p">^</span><span class="n">23</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">8MB</span>
<span class="n">block_name_prefix</span> <span class="p">:</span> <span class="n">这个是块的最重要的属性了</span><span class="err">，</span><span class="n">这是每个块在ceph中的唯一前缀编号</span><span class="err">，</span><span class="n">有了这个前缀</span><span class="err">，</span><span class="n">把主机上的OSD都拔下来带回家</span><span class="err">，</span><span class="n">就能复活所有的VM了</span>
<span class="n">format</span> <span class="p">:</span> <span class="n">格式有两种</span><span class="err">，</span><span class="n">1和2</span>
<span class="n">features</span><span class="err">：</span><span class="n">当前image启用的功能特性</span><span class="err">，</span><span class="n">其值是一个以逗号分隔的字符串列表</span><span class="err">，</span><span class="n">例如</span>
            <span class="n">layering</span><span class="p">,</span> <span class="n">exclusive-lock</span><span class="p">,</span> <span class="n">object-map</span>
<span class="n">op_features</span><span class="err">：</span><span class="n">可选的功能特性</span><span class="err">；</span>
</code></pre></div>
<p>磁盘设备的删除</p>
<div class="highlight"><pre><span></span><code><span class="n">删除设备</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">rm </span><span class="n">rbddata</span><span class="p">/</span><span class="n">img1</span>
<span class="n">Removing</span> <span class="n">image</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">rbddata</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">rbddata</span>
<span class="n">Total</span> <span class="n">Images</span><span class="p">:</span> <span class="n">0</span>
<span class="n">Total</span> <span class="n">Snapshots</span><span class="p">:</span> <span class="n">0</span>
<span class="n">Provisioned</span> <span class="n">Size</span><span class="p">:</span> <span class="n">0</span> <span class="n">B</span>

<span class="n">删除存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">rbddata</span> <span class="n">rbddata</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">pool</span> <span class="s1">&#39;rbddata&#39;</span> <span class="n">removed</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="122_1">1.2.2 镜像管理<a class="headerlink" href="#122_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>镜像属性</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>解析</th>
</tr>
</thead>
<tbody>
<tr>
<td>layering</td>
<td>分层克隆机制，磁盘的数据分层获取克隆机制</td>
</tr>
<tr>
<td>striping</td>
<td>是否支持数据对象间的数据条带化</td>
</tr>
<tr>
<td>exclusive-lock</td>
<td>排它锁的机制，磁盘应用于多路读写机制场景。限制同时仅能有一个客户端访问当前image</td>
</tr>
<tr>
<td>object-map</td>
<td>对象位图机制，主要用于加速导入、导出及已用容量统计等操作，依赖于exclusive-lock特性</td>
</tr>
<tr>
<td>fast-diff</td>
<td>快照定制机制，快速对比数据差异，便于做快照管理，依赖于object-map特性</td>
</tr>
<tr>
<td>deep-flatten</td>
<td>数据处理机制，解除父子image及快照的依赖关系</td>
</tr>
<tr>
<td>journaling</td>
<td>磁盘日志机制，将image的所有修改操作进行日志化，便于异地备份，依赖于exclusive-lock特性</td>
</tr>
<tr>
<td>data-pool</td>
<td>是否支持将image的数据对象存储于纠删码存储池，主要用于将image的元数据与数据放置于不同的存储池；</td>
</tr>
</tbody>
</table>
<p>属性操作</p>
<div class="highlight"><pre><span></span><code><span class="n">镜像功能命令</span>
<span class="n">cephadm</span><span class="nv">@admin</span><span class="p">:~/</span><span class="n">ceph-cluster</span><span class="p">$</span> <span class="n">rbd</span> <span class="p">-</span><span class="n">-help</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">feature</span>
    <span class="n">feature</span> <span class="n">disable</span>                   <span class="n">Disable</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">image</span> <span class="n">feature</span><span class="p">.</span>
    <span class="n">feature</span> <span class="n">enable</span>                    <span class="n">Enable</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">image</span> <span class="n">feature</span><span class="p">.</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">kube</span> <span class="n">64</span> <span class="n">64</span>
<span class="n">pool</span> <span class="s1">&#39;kube&#39;</span> <span class="n">created</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="n">kube</span>


<span class="n">启动rbd功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">enable</span> <span class="n">kube</span> <span class="n">rbd</span>
<span class="n">enabled</span> <span class="n">application</span> <span class="s1">&#39;rbd&#39;</span> <span class="n">on</span> <span class="n">pool</span> <span class="s1">&#39;kube&#39;</span>


<span class="n">rbd环境初始化</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">init</span> <span class="n">kube</span>
</code></pre></div>
<p>创建镜像</p>
<div class="highlight"><pre><span></span><code><span class="n">方法2</span><span class="err">：</span><span class="n">通过参数属性方式</span><span class="err">，</span><span class="n">创建一个2G的镜像文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">create</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">super</span> <span class="p">-</span><span class="n">-size</span> <span class="n">2G</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span>

<span class="n">查看镜像</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span>
<span class="n">vol01</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">方法2</span><span class="err">：</span><span class="n">通过</span><span class="p">&lt;</span><span class="n">image-spec</span><span class="p">&gt;</span><span class="n">方式</span><span class="err">，</span><span class="n">创建一个2G的镜像文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">create</span> <span class="p">-</span><span class="n">-size</span> <span class="n">2G</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol02</span>

<span class="n">查看镜像</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span>
<span class="n">vol01</span>
<span class="n">vol02</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看详情信息</span> <span class="n">-l</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>   <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">vol01</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>
<span class="n">vol02</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>

<span class="n">以json格式查看详情</span> <span class="p">-</span><span class="n">-format</span> <span class="n">json</span> <span class="p">-</span><span class="n">-pretty-format</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="n">-l</span> <span class="p">-</span><span class="n">-format</span> <span class="n">json</span> <span class="p">-</span><span class="n">-pretty-format</span>
<span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;vol01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2147483648</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;vol02&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2147483648</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">2</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看镜像属性</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">info</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">rbd</span> <span class="n">image</span> <span class="s1">&#39;vol01&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">2</span> <span class="n">GiB</span> <span class="k">in</span> <span class="n">512</span> <span class="n">objects</span>
        <span class="n">order</span> <span class="n">22</span> <span class="p">(</span><span class="n">4</span> <span class="n">MiB</span> <span class="n">objects</span><span class="p">)</span>
        <span class="n">snapshot_count</span><span class="p">:</span> <span class="n">0</span>
        <span class="n">id</span><span class="p">:</span> <span class="n">386ed735e96b</span>
        <span class="n">block_name_prefix</span><span class="p">:</span> <span class="n">rbd_data</span><span class="p">.</span><span class="n">386ed735e96b</span>
        <span class="n">format</span><span class="p">:</span> <span class="n">2</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">layering</span><span class="p">,</span> <span class="n">exclusive-lock</span><span class="p">,</span> <span class="n">object-map</span><span class="p">,</span> <span class="n">fast-diff</span><span class="p">,</span> <span class="n">deep-flatten</span>
        <span class="p">...</span>
</code></pre></div>
<p>镜像属性</p>
<div class="highlight"><pre><span></span><code><span class="n">禁用磁盘镜像功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">feature</span> <span class="n">disable</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span> <span class="n">object-map</span> <span class="n">fast-diff</span> <span class="n">deep-flatten</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">info</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span>
<span class="n">rbd</span> <span class="n">image</span> <span class="s1">&#39;vol01&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">2</span> <span class="n">GiB</span> <span class="k">in</span> <span class="n">512</span> <span class="n">objects</span>
        <span class="p">...</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">layering</span><span class="p">,</span> <span class="n">exclusive-lock</span>
        <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">启用磁盘镜像功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">feature</span> <span class="n">enable</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span> <span class="n">object-map</span> <span class="n">fast-diff</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">info</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span>
<span class="n">rbd</span> <span class="n">image</span> <span class="s1">&#39;vol01&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">2</span> <span class="n">GiB</span> <span class="k">in</span> <span class="n">512</span> <span class="n">objects</span>
        <span class="p">...</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">object</span> <span class="n">map</span> <span class="n">invalid</span><span class="p">,</span> <span class="n">fast</span> <span class="nb">diff </span><span class="n">invalid</span>
        <span class="p">...</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="123">1.2.3 镜像实践<a class="headerlink" href="#123" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>磁盘使用</p>
<div class="highlight"><pre><span></span><code><span class="n">使用方法1</span><span class="err">：</span><span class="n">通过内核级别的ceph模块</span><span class="err">，</span><span class="n">将rdb设备提供给相关主机使用</span>
    <span class="n">初始化存储池后</span><span class="err">，</span><span class="n">创建image</span>
    <span class="n">最好禁用</span> <span class="n">object-map</span><span class="err">，</span><span class="n">fast-diff</span><span class="err">，</span><span class="n">deep-flatten功能</span>
    <span class="n">需要直接与monitor角色进行通信</span>
        <span class="p">-</span> <span class="n">若存储集群端启用了CephX认证</span><span class="err">，</span><span class="n">还需要指定用户名和keyring文件</span>
    <span class="n">使用rdb命令的map子命令</span><span class="err">，</span><span class="n">进行磁盘文件的映射</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">在客户端上可以通过</span> <span class="n">rbd</span> <span class="n">showmapped</span> <span class="n">查看已经映射的image</span>
    <span class="n">在客户端上可以通过</span> <span class="n">rbd</span> <span class="n">unmap</span> <span class="n">命令断开已经映射的image</span>
</code></pre></div>
<p>admin主机管理image镜像文件的权限</p>
<div class="highlight"><pre><span></span><code><span class="n">禁用无效的属性</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">feature</span> <span class="n">disable</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span> <span class="n">object-map</span> <span class="n">fast-diff</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">info</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span>
<span class="n">rbd</span> <span class="n">image</span> <span class="s1">&#39;vol01&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">2</span> <span class="n">GiB</span> <span class="k">in</span> <span class="n">512</span> <span class="n">objects</span>
        <span class="p">...</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">layering</span><span class="p">,</span> <span class="n">exclusive-lock</span>
</code></pre></div>
<p>映射命令的帮助</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">help</span> <span class="n">map</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">rbd</span> <span class="n">map</span> <span class="p">[-</span><span class="n">-device-type</span> <span class="p">&lt;</span><span class="n">device-type</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span>
               <span class="p">[-</span><span class="n">-namespace</span> <span class="p">&lt;</span><span class="n">namespace</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;]</span>
               <span class="p">[-</span><span class="n">-read-only</span><span class="p">]</span> <span class="p">[-</span><span class="n">-exclusive</span><span class="p">]</span> <span class="p">[-</span><span class="n">-options</span> <span class="p">&lt;</span><span class="n">options</span><span class="p">&gt;]</span>
               <span class="p">&lt;</span><span class="n">image</span><span class="o">-or</span><span class="n">-snap-spec</span><span class="p">&gt;</span>
<span class="p">...</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>客户端主机安装基本环境</p>
<div class="highlight"><pre><span></span><code><span class="n">客户端主机安装环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># yum install ceph ceph-common -y</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看模块效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># modinfo ceph</span>
<span class="n">filename</span><span class="p">:</span>       <span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">modules</span><span class="p">/</span><span class="n">3</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">1160</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">x86_64</span><span class="p">/</span><span class="n">kernel</span><span class="p">/</span><span class="n">fs</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">ko</span><span class="p">.</span><span class="n">xz</span>
<span class="n">license</span><span class="p">:</span>        <span class="n">GPL</span>
<span class="n">description</span><span class="p">:</span>    <span class="n">Ceph</span> <span class="n">filesystem</span> <span class="k">for</span> <span class="n">Linux</span>
<span class="n">author</span><span class="p">:</span>         <span class="n">Patience</span> <span class="n">Warnick</span> <span class="p">&lt;</span><span class="n">patience</span><span class="nv">@newdream</span><span class="p">.</span><span class="n">net</span><span class="p">&gt;</span>
<span class="n">author</span><span class="p">:</span>         <span class="n">Yehuda</span> <span class="n">Sadeh</span> <span class="p">&lt;</span><span class="n">yehuda</span><span class="nv">@hq</span><span class="p">.</span><span class="n">newdream</span><span class="p">.</span><span class="n">net</span><span class="p">&gt;</span>
<span class="n">author</span><span class="p">:</span>         <span class="n">Sage</span> <span class="n">Weil</span> <span class="p">&lt;</span><span class="n">sage</span><span class="nv">@newdream</span><span class="p">.</span><span class="n">net</span><span class="p">&gt;</span>
<span class="k">alias</span><span class="p">:</span>          <span class="n">fs-ceph</span>
<span class="n">retpoline</span><span class="p">:</span>      <span class="n">Y</span>
<span class="n">rhelversion</span><span class="p">:</span>    <span class="n">7</span><span class="p">.</span><span class="n">9</span>
<span class="n">srcversion</span><span class="p">:</span>     <span class="n">EB765DDC1F7F8219F09D34C</span>
<span class="n">depends</span><span class="p">:</span>        <span class="n">libceph</span>
<span class="n">intree</span><span class="p">:</span>         <span class="n">Y</span>
<span class="n">vermagic</span><span class="p">:</span>       <span class="n">3</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">1160</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">x86_64</span> <span class="n">SMP</span> <span class="n">mod_unload</span> <span class="n">modversions</span>
<span class="n">signer</span><span class="p">:</span>         <span class="n">CentOS</span> <span class="n">Linux</span> <span class="n">kernel</span> <span class="n">signing</span> <span class="n">key</span>
<span class="n">sig_key</span><span class="p">:</span>        <span class="n">E1</span><span class="p">:</span><span class="n">FD</span><span class="p">:</span><span class="n">B0</span><span class="p">:</span><span class="n">E2</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">E8</span><span class="p">:</span><span class="n">61</span><span class="p">:</span><span class="n">A1</span><span class="p">:</span><span class="n">D1</span><span class="p">:</span><span class="n">CA</span><span class="p">:</span><span class="n">80</span><span class="p">:</span><span class="n">A2</span><span class="p">:</span><span class="n">3D</span><span class="p">:</span><span class="n">CF</span><span class="p">:</span><span class="n">0D</span><span class="p">:</span><span class="n">BA</span><span class="p">:</span><span class="n">3A</span><span class="p">:</span><span class="n">A4</span><span class="p">:</span><span class="n">AD</span><span class="p">:</span><span class="n">F5</span>
<span class="n">sig_hashalgo</span><span class="p">:</span>   <span class="n">sha256</span>
</code></pre></div>
<p>管理端主机传递相关文件</p>
<div class="highlight"><pre><span></span><code><span class="n">查看认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span>
<span class="no">[client.kube]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA11TBjzq6NEhAAF2tyvEY0L</span><span class="p">+</span><span class="n">XYMP7IOykkcQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow * pool=super&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">kube</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">ls </span><span class="p">*</span><span class="n">kube</span><span class="p">*</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">传递认证文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">sudo</span> <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span> <span class="n">root</span><span class="nv">@stor06</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">传递正常的ceph集群的配置文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">sudo</span> <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="n">root</span><span class="nv">@stor06</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
</code></pre></div>
<p>客户端简单使用</p>
<div class="highlight"><pre><span></span><code><span class="n">默认情况下</span><span class="err">，</span><span class="n">是无法正常连接ceph集群的</span>
<span class="n">root</span><span class="nv">@stor06</span><span class="p">:~</span><span class="c"># ceph -s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ceph -s</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">05</span><span class="p">:</span><span class="n">04</span><span class="p">.</span><span class="n">530</span> <span class="n">7f7cca27f700</span> <span class="p">-</span><span class="n">1</span> <span class="n">auth</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">keyring</span> <span class="n">on</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span><span class="p">,/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">keyring</span><span class="p">,/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">keyring</span><span class="p">,/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">keyring</span><span class="p">.</span><span class="n">bin</span><span class="p">,:</span> <span class="p">(</span><span class="n">2</span><span class="p">)</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
<span class="p">...</span>
<span class="no">[errno 2]</span> <span class="n">error</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">默认采用的认证用户是</span> <span class="n">client</span><span class="p">.</span><span class="n">admin账号</span><span class="err">，</span><span class="n">而我们没有</span><span class="err">。</span>

<span class="n">通过</span><span class="p">-</span><span class="n">-user参数</span><span class="err">，</span><span class="n">使用指定的用户来访问ceph</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ceph --user kube -s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_OK</span>
    <span class="p">...</span>
</code></pre></div>
<p>rdb文件的使用</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前的系统磁盘效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># fdisk -l | grep &#39;磁盘 &#39;</span>
<span class="n">磁盘</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sda</span><span class="err">：</span><span class="n">21</span><span class="p">.</span><span class="n">5</span> <span class="n">GB</span><span class="p">,</span> <span class="n">21474836480</span> <span class="n">字节</span><span class="err">，</span><span class="n">41943040</span> <span class="n">个扇区</span>
<span class="n">磁盘</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdb</span><span class="err">：</span><span class="n">21</span><span class="p">.</span><span class="n">5</span> <span class="n">GB</span><span class="p">,</span> <span class="n">21474836480</span> <span class="n">字节</span><span class="err">，</span><span class="n">41943040</span> <span class="n">个扇区</span>
<span class="n">磁盘</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span><span class="err">：</span><span class="n">21</span><span class="p">.</span><span class="n">5</span> <span class="n">GB</span><span class="p">,</span> <span class="n">21474836480</span> <span class="n">字节</span><span class="err">，</span><span class="n">41943040</span> <span class="n">个扇区</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">映射远程ceph的磁盘文件到本地</span>
<span class="n">root</span><span class="nv">@stor06</span><span class="p">:~</span><span class="c"># rbd --user kube map kube/vol01</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># fdisk -l | grep &#39;磁盘 &#39;</span>
<span class="p">...</span>
<span class="n">磁盘</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span><span class="err">：</span><span class="n">2147</span> <span class="n">MB</span><span class="p">,</span> <span class="n">2147483648</span> <span class="n">字节</span><span class="err">，</span><span class="n">4194304</span> <span class="n">个扇区</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">格式化磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mkfs.ext4 /dev/rbd0</span>
<span class="n">mke2fs</span> <span class="n">1</span><span class="p">.</span><span class="n">45</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">07-Jan</span><span class="p">-</span><span class="n">2020</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">写入超级块和文件系统账户统计信息</span><span class="err">：</span> <span class="n">已完成</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">挂载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount /dev/rbd0 /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep rbd</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span> <span class="n">on</span> <span class="p">/</span><span class="n">mnt</span> <span class="nb">type </span><span class="n">ext4</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">stripe</span><span class="p">=</span><span class="n">1024</span><span class="p">,</span><span class="n">data</span><span class="p">=</span><span class="n">ordered</span><span class="p">)</span>

<span class="n">尝试使用磁盘文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cp /etc/issue /mnt/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /mnt/issue</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">卸载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># umount /mnt</span>
</code></pre></div>
<p>我们还可以在客户端上，使用 rbd命令对rbd设备进行管理</p>
<div class="highlight"><pre><span></span><code><span class="n">客户端挂载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount /dev/rbd0 /mnt</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>
<span class="n">id</span> <span class="n">pool</span> <span class="n">namespace</span> <span class="n">image</span> <span class="n">snap</span> <span class="n">device</span>
<span class="n">0</span>  <span class="n">kube</span>           <span class="n">vol01</span> <span class="p">-</span>    <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">主服务器上</span><span class="err">，</span><span class="n">查看挂载效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>  <span class="n">SIZE</span>  <span class="n">PARENT</span> <span class="n">FMT</span> <span class="n">PROT</span> <span class="n">LOCK</span>
<span class="n">vol01</span> <span class="n">2</span> <span class="n">GiB</span>          <span class="n">2</span>      <span class="n">excl</span>
<span class="n">vol02</span> <span class="n">2</span> <span class="n">GiB</span>          <span class="n">2</span>
</code></pre></div>
<p>磁盘卸载操作</p>
<div class="highlight"><pre><span></span><code><span class="n">卸载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd unmap /dev/rbd0</span>
<span class="n">rbd</span><span class="p">:</span> <span class="n">sysfs</span> <span class="nb">write </span><span class="n">failed</span>
<span class="n">rbd</span><span class="p">:</span> <span class="n">unmap</span> <span class="n">failed</span><span class="p">:</span> <span class="p">(</span><span class="n">16</span><span class="p">)</span> <span class="n">Device</span> <span class="n">or</span> <span class="n">resource</span> <span class="n">busy</span>

<span class="n">卸载磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># umount /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd unmap /dev/rbd0</span>

<span class="n">查看挂载效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>

<span class="n">主节点查看挂载效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>   <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">vol01</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>
<span class="n">vol02</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="124">1.2.4 容量管理<a class="headerlink" href="#124" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>容量</p>
<div class="highlight"><pre><span></span><code><span class="n">如果有必要的话</span><span class="err">，</span><span class="n">我们可以针对镜像文件的大小进行容量的调整</span><span class="err">。</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">help</span> <span class="n">resize</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">rbd</span> <span class="n">resize</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-namespace</span> <span class="p">&lt;</span><span class="n">namespace</span><span class="p">&gt;]</span>
                  <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-size</span> <span class="p">&lt;</span><span class="n">size</span><span class="p">&gt;</span> <span class="p">[-</span><span class="n">-allow-shrink</span><span class="p">]</span>
                  <span class="p">[-</span><span class="n">-no-progress</span><span class="p">]</span>
                  <span class="p">&lt;</span><span class="n">image-spec</span><span class="p">&gt;</span>
</code></pre></div>
<p>调整image的大小</p>
<div class="highlight"><pre><span></span><code><span class="n">增大</span><span class="err">：</span>
    <span class="n">rbd</span> <span class="n">resize</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-size</span> <span class="p">&lt;</span><span class="n">size</span><span class="p">&gt;</span>
<span class="n">减少</span><span class="err">：</span>
    <span class="n">rbd</span> <span class="n">resize</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-size</span> <span class="p">&lt;</span><span class="n">size</span><span class="p">&gt;</span> <span class="p">[-</span><span class="n">-allow-shrink</span><span class="p">]</span>
</code></pre></div>
<p>删除image</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span>
    <span class="n">rbd</span> <span class="n">remove</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">...</span> 
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">删除image会导致数据丢失</span><span class="err">，</span><span class="n">且不可恢复</span><span class="err">；</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">如果删除一些敏感的image</span><span class="err">，</span><span class="n">为了保险</span><span class="err">，</span><span class="n">推荐使用回收站功能trash</span><span class="err">，</span><span class="n">确定不再需要时再从trash中删除</span><span class="err">；</span>
<span class="n">命令格式</span><span class="err">：</span>
    <span class="n">rbd</span> <span class="n">trash</span> <span class="p">{</span><span class="n">list</span><span class="p">|</span><span class="n">move</span><span class="p">|</span><span class="n">purge</span><span class="p">|</span><span class="n">remove</span><span class="p">|</span><span class="n">restore</span><span class="p">}</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>image的容量扩展</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前的image容量</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>   <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">vol01</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>
<span class="n">vol02</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>

<span class="n">调整image容量</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">resize</span> <span class="n">-s</span> <span class="n">5G</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">Resizing</span> <span class="n">image</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">再次确认image容量大小</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>   <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">vol01</span>  <span class="n">5</span> <span class="n">GiB</span>            <span class="n">2</span>
<span class="n">vol02</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>
</code></pre></div>
<p>image容量的缩小</p>
<div class="highlight"><pre><span></span><code><span class="n">调整image容量</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">resize</span> <span class="n">-s</span> <span class="n">3G</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span> <span class="p">-</span><span class="n">-allow-shrink</span>
<span class="n">Resizing</span> <span class="n">image</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">再次确认image容量大小</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>   <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">vol01</span>  <span class="n">3</span> <span class="n">GiB</span>            <span class="n">2</span>
<span class="n">vol02</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>
</code></pre></div>
<p>删除image文件</p>
<div class="highlight"><pre><span></span><code><span class="n">删除image文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">rm </span><span class="n">kube</span><span class="p">/</span><span class="n">vol02</span>
<span class="n">Removing</span> <span class="n">image</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">查看image文件效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>   <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">vol01</span>  <span class="n">3</span> <span class="n">GiB</span>            <span class="n">2</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">image文件的删除是不可修复的</span>
</code></pre></div>
<p>image文件恢复</p>
<div class="highlight"><pre><span></span><code><span class="n">查看trash命令帮助</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">trash</span> <span class="p">-</span><span class="n">-help</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">trash</span>
    <span class="n">trash</span> <span class="n">list</span> <span class="p">(</span><span class="n">trash</span> <span class="n">ls</span><span class="p">)</span>             <span class="n">List</span> <span class="n">trash</span> <span class="n">images</span><span class="p">.</span>
    <span class="n">trash</span> <span class="nb">move </span><span class="p">(</span><span class="n">trash</span> <span class="n">mv</span><span class="p">)</span>             <span class="nb">Move </span><span class="n">an</span> <span class="n">image</span> <span class="n">to</span> <span class="n">the</span> <span class="n">trash</span><span class="p">.</span>
    <span class="n">trash</span> <span class="n">purge</span>                       <span class="n">Remove</span> <span class="n">all</span> <span class="n">expired</span> <span class="n">images</span> <span class="n">from</span> <span class="n">trash</span><span class="p">.</span>
    <span class="n">trash</span> <span class="n">remove</span> <span class="p">(</span><span class="n">trash</span> <span class="n">rm</span><span class="p">)</span>           <span class="n">Remove</span> <span class="n">an</span> <span class="n">image</span> <span class="n">from</span> <span class="n">trash</span><span class="p">.</span>
    <span class="n">trash</span> <span class="n">restore</span>                     <span class="n">Restore</span> <span class="n">an</span> <span class="n">image</span> <span class="n">from</span> <span class="n">trash</span><span class="p">.</span>
</code></pre></div>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">查看回收站</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">trash</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span>

<span class="n">移动文件到回收站</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">trash</span> <span class="nb">move </span><span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>

<span class="n">查看回收站</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">trash</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span>
<span class="n">386ed735e96b</span> <span class="n">vol01</span>

<span class="n">查看文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">恢复image文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">trash</span> <span class="n">restore</span> <span class="n">-p</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span> <span class="p">-</span><span class="n">-image-id</span> <span class="n">386ed735e96b</span>

<span class="n">查看回收站</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">trash</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span>

<span class="n">查看image文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span> <span class="n">-l</span>
<span class="n">NAME</span>  <span class="n">SIZE</span>  <span class="n">PARENT</span> <span class="n">FMT</span> <span class="n">PROT</span> <span class="n">LOCK</span>
<span class="n">vol01</span> <span class="n">3</span> <span class="n">GiB</span>          <span class="n">2</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="125">1.2.5 快照管理<a class="headerlink" href="#125" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>快照</p>
<div class="highlight"><pre><span></span><code>    <span class="n">RBD支持image快照技术</span><span class="err">，</span><span class="n">借助于快照可以保留image的状态历史</span><span class="err">。</span><span class="n">Ceph还支持快照</span><span class="err">“</span><span class="n">分层</span><span class="err">”</span><span class="n">机制</span><span class="err">，</span><span class="n">从而可实现快速克隆VM映像</span><span class="err">。</span>
</code></pre></div>
<p>常见命令</p>
<div class="highlight"><pre><span></span><code><span class="n">创建快照</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;</span>
    <span class="n">或者</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="p">[&lt;</span><span class="n">pool-name</span><span class="p">&gt;/]&lt;</span><span class="n">image-name</span><span class="p">&gt;@&lt;</span><span class="n">snapshot-name</span><span class="p">&gt;</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">在创建映像快照之前应停止image上的IO操作</span><span class="err">，</span><span class="n">且image上存在文件系统时</span><span class="err">，</span><span class="n">还要确保其处于一致状态</span><span class="err">；</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">列出快照</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">ls </span><span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">回滚快照</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="n">rollback</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;</span> <span class="p">...</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">意味着会使用快照中的数据重写当前版本的image</span><span class="err">，</span><span class="n">回滚所需的时间将随映像大小的增加而延长</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">限制快照数量</span>
    <span class="n">快照数量过多</span><span class="err">，</span><span class="n">必然会导致image上的原有数据第一次修改时的IO压力恶化</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="n">limit</span> <span class="nb">set </span><span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">...</span>

<span class="n">解除限制</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="n">limit</span> <span class="nb">clear </span><span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">删除快照</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">rm </span><span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;]</span> <span class="p">[-</span><span class="n">-no-progress</span><span class="p">]</span>
<span class="p">[-</span><span class="n">-force</span><span class="p">]</span>
<span class="n">提示</span><span class="err">：</span>
    <span class="n">Ceph</span> <span class="n">OSD会以异步方式删除数据</span><span class="err">，</span><span class="n">因此删除快照并不能立即释放磁盘空间</span><span class="p">;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">清理快照</span>
    <span class="n">删除一个image的所有快照</span><span class="err">，</span><span class="n">可以使用rbd</span> <span class="n">snap</span> <span class="n">purge命令</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="n">purge</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">[-</span><span class="n">-no-progress</span><span class="p">]</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>查看快照命令</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="p">-</span><span class="n">-help</span> <span class="p">|</span> <span class="n">grep</span> <span class="s1">&#39;  snap &#39;</span>
    <span class="n">snap</span> <span class="n">create</span> <span class="p">(</span><span class="n">snap</span> <span class="n">add</span><span class="p">)</span>            <span class="n">Create</span> <span class="n">a</span> <span class="n">snapshot</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">limit</span> <span class="nb">clear </span>                 <span class="n">Remove</span> <span class="n">snapshot</span> <span class="n">limit</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">limit</span> <span class="nb">set </span>                   <span class="n">Limit</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">snapshots</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">list</span> <span class="p">(</span><span class="n">snap</span> <span class="n">ls</span><span class="p">)</span>               <span class="n">Dump</span> <span class="n">list</span> <span class="n">of</span> <span class="n">image</span> <span class="n">snapshots</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">protect</span>                      <span class="n">Prevent</span> <span class="n">a</span> <span class="n">snapshot</span> <span class="n">from</span> <span class="n">being</span> <span class="n">deleted</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">purge</span>                        <span class="n">Delete</span> <span class="n">all</span> <span class="n">unprotected</span> <span class="n">snapshots</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">remove</span> <span class="p">(</span><span class="n">snap</span> <span class="n">rm</span><span class="p">)</span>             <span class="n">Delete</span> <span class="n">a</span> <span class="n">snapshot</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">rename</span>                       <span class="n">Rename</span> <span class="n">a</span> <span class="n">snapshot</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">rollback</span> <span class="p">(</span><span class="n">snap</span> <span class="n">revert</span><span class="p">)</span>       <span class="n">Rollback</span> <span class="n">image</span> <span class="n">to</span> <span class="n">snapshot</span><span class="p">.</span>
    <span class="n">snap</span> <span class="n">unprotect</span>                    <span class="n">Allow</span> <span class="n">a</span> <span class="n">snapshot</span> <span class="n">to</span> <span class="n">be</span> <span class="n">deleted</span><span class="p">.</span>
</code></pre></div>
<p>客户端准备rbd文件</p>
<div class="highlight"><pre><span></span><code><span class="n">客户端挂载rbd文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd --user kube map kube/vol01</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>
<span class="n">id</span>  <span class="n">pool</span>  <span class="n">namespace</span>  <span class="n">image</span>  <span class="n">snap</span>  <span class="n">device</span>
<span class="n">0</span>   <span class="n">kube</span>             <span class="n">vol01</span>  <span class="p">-</span>     <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>

<span class="n">挂载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount /dev/rbd0 /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /mnt/</span>
<span class="n">issue</span>  <span class="n">lost</span><span class="p">+</span><span class="n">found</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">虽然容量调整过了</span><span class="err">，</span><span class="n">但是就有的文件仍然存在</span>
</code></pre></div>
<p>管理端创建快照</p>
<div class="highlight"><pre><span></span><code><span class="n">查看快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">list</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>

<span class="n">创建快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@snap01</span>

<span class="n">查看快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">list</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">SNAPID</span> <span class="n">NAME</span>   <span class="n">SIZE</span>  <span class="n">PROTECTED</span> <span class="n">TIMESTAMP</span>
     <span class="n">4</span> <span class="n">snap01</span> <span class="n">3</span> <span class="n">GiB</span>           <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">34</span><span class="p">:</span><span class="n">20</span> <span class="n">2062</span>
</code></pre></div>
<p>恢复快照动作</p>
<div class="highlight"><pre><span></span><code><span class="n">客户端将文件删除</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /mnt/</span>
<span class="n">issue</span>  <span class="n">lost</span><span class="p">+</span><span class="n">found</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rm -f /mnt/issue</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /mnt/</span>
<span class="n">lost</span><span class="p">+</span><span class="n">found</span>

<span class="n">客户端解除磁盘的占用</span>
<span class="n">root</span><span class="nv">@stor06</span><span class="p">:~</span><span class="c"># umount /mnt</span>
<span class="n">root</span><span class="nv">@stor06</span><span class="p">:~</span><span class="c"># rbd unmap /dev/rbd0</span>
<span class="n">root</span><span class="nv">@stor06</span><span class="p">:~</span><span class="c"># rbd showmapped</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">服务端恢复快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">rollback</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@snap01</span>
<span class="n">Rolling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">客户端重新加载磁盘文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd --user kube map kube/vol01</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount /dev/rbd0 /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /mnt/</span>
<span class="n">issue</span>  <span class="n">lost</span><span class="p">+</span><span class="n">found</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">快照数据恢复过来了</span>
</code></pre></div>
<p>删除快照</p>
<div class="highlight"><pre><span></span><code><span class="n">删除之前查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">list</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">SNAPID</span> <span class="n">NAME</span>   <span class="n">SIZE</span>  <span class="n">PROTECTED</span> <span class="n">TIMESTAMP</span>
     <span class="n">4</span> <span class="n">snap01</span> <span class="n">3</span> <span class="n">GiB</span>           <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">34</span><span class="p">:</span><span class="n">20</span> <span class="n">2062</span>

<span class="n">删除快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">rm </span><span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@snap01</span>
<span class="n">Removing</span> <span class="n">snap</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">确认删除效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">list</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> 
</code></pre></div>
<p>快照数量的限制</p>
<div class="highlight"><pre><span></span><code><span class="n">设定快照数量的限制</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">limit</span> <span class="nb">set </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span> <span class="p">-</span><span class="n">-limit</span> <span class="n">5</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@snap01</span>
<span class="p">...</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@snap06</span>
<span class="n">rbd</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">create</span> <span class="n">snapshot</span><span class="p">:</span> <span class="p">(</span><span class="n">122</span><span class="p">)</span> <span class="n">Disk</span> <span class="n">quota</span> <span class="n">exceeded</span>

<span class="n">解除快照限制</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">limit</span> <span class="nb">clear </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@snap06</span>
<span class="n">Creating</span> <span class="n">snap</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">list</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">SNAPID</span> <span class="n">NAME</span>   <span class="n">SIZE</span>  <span class="n">PROTECTED</span> <span class="n">TIMESTAMP</span>
     <span class="n">6</span> <span class="n">snap01</span> <span class="n">3</span> <span class="n">GiB</span>           <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">38</span><span class="p">:</span><span class="n">25</span> <span class="n">2022</span>
     <span class="p">...</span>
    <span class="n">13</span> <span class="n">snap06</span> <span class="n">3</span> <span class="n">GiB</span>           <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">39</span><span class="p">:</span><span class="n">07</span> <span class="n">2022</span>
</code></pre></div>
<p>清理所有快照</p>
<div class="highlight"><pre><span></span><code><span class="n">清理所有快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">purge</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">kube</span> <span class="p">-</span><span class="n">-image</span> <span class="n">vol01</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">list</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="126">1.2.6 快照分层<a class="headerlink" href="#126" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph支持在一个块设备快照的基础上创建一到多个COW或COR</span><span class="err">（</span><span class="nb">Copy-On</span><span class="n">-Read</span><span class="err">）</span><span class="n">类型的克隆</span><span class="err">，</span><span class="n">这种中间快照层机制提了一种极速创建image的方式</span><span class="p">.</span><span class="n">用户可以创建一个基础image并为其创建一个只读快照层</span><span class="err">，</span><span class="n">而后可以在此快照层上创建任意个克隆进行读写操作</span><span class="err">，</span><span class="n">甚至能够进行多级克隆</span>

<span class="n">例如</span><span class="p">:</span>
    <span class="n">实践中可以为Qemu虚拟机创建一个image并安装好基础操作系统环境作为模板</span><span class="err">，</span><span class="n">对其创建创建快照层后</span><span class="err">，</span><span class="n">便可按需创建任意多个克隆作为image提供给多个不同的VM</span><span class="err">（</span><span class="n">虚拟机</span><span class="err">）</span><span class="n">使用</span><span class="err">，</span><span class="n">或者每创建一个克隆后进行按需修改</span><span class="err">，</span><span class="n">而后对其再次创建下游的克隆</span><span class="p">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">通过克隆生成的image在其功能上与直接创建的image几乎完全相同</span><span class="err">，</span><span class="n">它同样支持读</span><span class="err">、</span><span class="n">写</span><span class="err">、</span><span class="n">克隆</span><span class="err">、</span><span class="n">空间扩缩容等功能</span><span class="err">，</span><span class="n">惟一的不同之处是克隆引用了一个只读的上游快照</span><span class="err">，</span><span class="n">而且此快照必须要置于</span><span class="err">“</span><span class="n">保护</span><span class="err">”</span><span class="n">模式之下</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ceph的快照支持COW和COR两种类型</span>
    <span class="n">COW是为默认的类型</span><span class="err">，</span><span class="n">仅在数据首次写入时才需要将它复制到克隆的image中</span>
    <span class="n">COR则是在数据首次被读取时复制到当前克隆中</span><span class="err">，</span><span class="n">随后的读写操作都将直接基于此克隆中的对象进行</span>
</code></pre></div>
<p>分层快照使用</p>
<div class="highlight"><pre><span></span><code><span class="n">在RBD上使用分层克隆的方法非常简单</span><span class="err">：</span>
    <span class="n">创建一个image</span><span class="err">，</span><span class="n">对image创建一个快照并将其置入保护模式</span><span class="err">，</span><span class="n">而克隆此快照即可</span>

<span class="n">创建克隆的image时</span><span class="err">，</span>
    <span class="n">需要指定引用的存储池</span><span class="err">、</span><span class="n">镜像和镜像快照</span><span class="err">，</span><span class="n">以及克隆的目标image的存储池和镜像名称</span><span class="err">，</span>
    <span class="n">因此</span><span class="err">，</span><span class="n">克隆镜像支持跨存储池进行</span>
</code></pre></div>
<p><img alt="image-20211210111915782" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211210111915782.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">简单来说</span><span class="err">，</span><span class="n">这里的快照分层</span><span class="err">，</span><span class="n">主要说的就是</span><span class="err">：</span>
    <span class="n">基础的模板快照和特有应用快照</span>
</code></pre></div>
<p>命令实践</p>
<div class="highlight"><pre><span></span><code><span class="n">保护上游的原始快照</span>
    <span class="n">下游image需要引用上游快照中的数据</span><span class="err">，</span><span class="n">快照的意外删除必将导致数据服务的中止</span><span class="err">，</span><span class="n">因此在克隆操作之外</span><span class="err">，</span><span class="n">必须将上游的快照置于保护模式</span>
    <span class="n">rbd</span> <span class="n">snap</span> <span class="n">protect</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">克隆快照</span>
    <span class="n">rbd</span> <span class="n">clone</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-dest-pool</span> <span class="p">&lt;</span><span class="n">dest-pool</span><span class="p">&gt;</span> <span class="p">...</span>
    <span class="n">rbd</span> <span class="n">clone</span> <span class="p">[&lt;</span><span class="n">pool-name</span><span class="p">&gt;/]&lt;</span><span class="n">image-name</span><span class="p">&gt;@&lt;</span><span class="n">snapshot-name</span><span class="p">&gt;</span> <span class="p">[&lt;</span><span class="n">pool-name</span><span class="p">&gt;/]&lt;</span><span class="n">image-name</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">列出快照的子项</span>
    <span class="n">rbd</span> <span class="n">children</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">展平克隆的image</span>
    <span class="n">克隆的映像会保留对父快照的引用</span><span class="err">，</span><span class="n">删除子克隆对父快照的引用时</span><span class="err">，</span><span class="n">可通过将信息从快照复制到克隆</span><span class="err">，</span><span class="n">进行image的</span><span class="err">“</span><span class="n">展平</span><span class="err">”</span><span class="n">操作</span>
    <span class="n">展平克隆所需的时间随着映像大小的增加而延长</span>
    <span class="n">要删除某拥有克隆子项的快照</span><span class="err">，</span><span class="n">必须先平展其子image</span>
    <span class="n">命令</span><span class="err">：</span> <span class="n">rbd</span> <span class="n">flatten</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-no-progress</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">取消快照保护</span>
    <span class="n">必须先取消保护快照</span><span class="err">，</span><span class="n">然后才能删除它</span>
    <span class="n">用户无法删除克隆所引用的快照</span><span class="err">，</span><span class="n">需要先平展其每个克隆</span><span class="err">，</span><span class="n">然后才能删除快照</span>
    <span class="n">命令</span><span class="err">：</span><span class="n">rbd</span> <span class="n">snap</span> <span class="n">unprotect</span> <span class="p">[-</span><span class="n">-pool</span> <span class="p">&lt;</span><span class="n">pool</span><span class="p">&gt;]</span> <span class="p">-</span><span class="n">-image</span> <span class="p">&lt;</span><span class="n">image</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-snap</span> <span class="p">&lt;</span><span class="n">snap</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>清理环境</p>
<div class="highlight"><pre><span></span><code><span class="n">在客户端将磁盘取消应用</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># umount /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd unmap /dev/rbd0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>
</code></pre></div>
<p>服务端定制基础快照</p>
<div class="highlight"><pre><span></span><code><span class="n">定制基础快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">create</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">ls </span><span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">SNAPID</span> <span class="n">NAME</span>       <span class="n">SIZE</span>  <span class="n">PROTECTED</span> <span class="n">TIMESTAMP</span>
    <span class="n">20</span> <span class="n">clonetpl01</span> <span class="n">3</span> <span class="n">GiB</span>           <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">42</span><span class="p">:</span><span class="n">51</span> <span class="n">2062</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将快照置于保护模式</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">protect</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">ls </span><span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="n">SNAPID</span> <span class="n">NAME</span>       <span class="n">SIZE</span>  <span class="n">PROTECTED</span> <span class="n">TIMESTAMP</span>
    <span class="n">20</span> <span class="n">clonetpl01</span> <span class="n">3</span> <span class="n">GiB</span> <span class="n">yes</span>       <span class="n">Mon</span> <span class="n">Sep</span> <span class="n">26</span> <span class="n">11</span><span class="p">:</span><span class="n">42</span><span class="p">:</span><span class="n">51</span> <span class="n">2062</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">该快照已经被处于保护模式了</span>
</code></pre></div>
<p>基于快照来进行克隆操作</p>
<div class="highlight"><pre><span></span><code><span class="n">基于基础模板克隆一个镜像</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">clone</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span> <span class="n">kube</span><span class="p">/</span><span class="n">myimg01</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">clone</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span> <span class="n">kube</span><span class="p">/</span><span class="n">myimg02</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube</span>
<span class="n">myimg01</span>
<span class="n">myimg02</span>
<span class="n">vol01</span>

<span class="n">查看模板镜像的所有子镜像文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">children</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span>
<span class="n">kube</span><span class="p">/</span><span class="n">myimg01</span>
<span class="n">kube</span><span class="p">/</span><span class="n">myimg02</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">客户端尝试应用一下clone文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd --user kube map kube/myimg01</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>
<span class="n">id</span> <span class="n">pool</span> <span class="n">namespace</span> <span class="n">image</span>   <span class="n">snap</span> <span class="n">device</span>
<span class="n">0</span>  <span class="n">kube</span>           <span class="n">myimg01</span> <span class="p">-</span>    <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>

<span class="n">挂载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount /dev/rbd0 /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /mnt</span>
<span class="n">issue</span>  <span class="n">lost</span><span class="p">+</span><span class="n">found</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># echo myimg1 &gt;&gt; /mnt/issue</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">该clone镜像文件可以正常的使用</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">客户端再次应用clone文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd --user kube map kube/myimg02</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd1</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>
<span class="n">id</span> <span class="n">pool</span> <span class="n">namespace</span> <span class="n">image</span>   <span class="n">snap</span> <span class="n">device</span>
<span class="n">0</span>  <span class="n">kube</span>           <span class="n">myimg01</span> <span class="p">-</span>    <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>
<span class="n">1</span>  <span class="n">kube</span>           <span class="n">myimg02</span> <span class="p">-</span>    <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd1</span>

<span class="n">挂载操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mkdir /mnt1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount /dev/rbd1 /mnt1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /mnt1/issue</span>
<span class="p">\</span><span class="n">S</span>
<span class="n">Kernel</span> <span class="p">\</span><span class="nb">r </span><span class="n">on</span> <span class="n">an</span> <span class="p">\</span><span class="n">m</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">多个clone镜像文件可以独立的正常使用</span>
</code></pre></div>
<p>卸载操作</p>
<div class="highlight"><pre><span></span><code><span class="n">客户端卸载myimg02</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># umount /mnt1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># rbd unmap kube/myimg02</span>

<span class="n">管理端删除image镜像</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">rm </span><span class="n">kube</span><span class="p">/</span><span class="n">myimg02</span>
<span class="n">Removing</span> <span class="n">image</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">children</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span>
<span class="n">kube</span><span class="p">/</span><span class="n">myimg01</span>
</code></pre></div>
<p>展平快照文件</p>
<div class="highlight"><pre><span></span><code>    <span class="n">如果我们要删除底层的模板快照文件</span><span class="err">，</span><span class="n">为了避免对上层镜像的文件产生不好的影响</span><span class="err">，</span><span class="n">我们可以将底层快照的文件转移到上层clone文件中一份</span><span class="err">，</span><span class="n">这个动作叫展平快照文件</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">展平数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">flatten</span> <span class="n">kube</span><span class="p">/</span><span class="n">myimg01</span>
<span class="n">Image</span> <span class="n">flatten</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">取消保护基础快照模板文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="n">unprotect</span> <span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span>

<span class="n">移除底层的模板文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">rm </span><span class="n">kube</span><span class="p">/</span><span class="n">vol01</span><span class="nv">@clonetpl01</span>
<span class="n">Removing</span> <span class="n">snap</span><span class="p">:</span> <span class="n">100</span><span class="p">%</span> <span class="n">complete</span><span class="p">...</span><span class="n">done</span><span class="p">.</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">snap</span> <span class="nb">ls </span><span class="n">kube</span><span class="p">/</span><span class="n">vol01</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在客户端上不影响子clone文件的操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /mnt/issue</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="127_rbd">1.2.7 RBD实践<a class="headerlink" href="#127_rbd" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 案例需求、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph提供的块存储能够可以为其他虚拟机提供磁盘设备来进行使用</span><span class="err">，</span><span class="n">所以接下来我们准备将ceph的磁盘文件提供给kvm进行使用</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">我们需要按照如下的步骤来进行相关的实践</span><span class="err">：</span>
        <span class="n">1</span> <span class="n">kvm环境和ceph环境准备</span>
        <span class="n">2</span> <span class="n">ceph和kvm认证集成</span>
        <span class="n">3</span> <span class="n">kvm到ceph中创建镜像文件</span>
        <span class="n">4</span> <span class="n">启动kvm虚拟机测试ceph磁盘使用效果</span>
</code></pre></div>
<p>准备系统文件</p>
<div class="highlight"><pre><span></span><code><span class="n">获取镜像文件</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">images</span><span class="p">/</span> <span class="p">&amp;&amp;</span> <span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">images</span><span class="p">/</span>
<span class="nb">wget </span><span class="n">http</span><span class="p">://</span><span class="n">download</span><span class="p">.</span><span class="n">cirros-cloud</span><span class="p">.</span><span class="n">net</span><span class="p">/</span><span class="n">0</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span><span class="p">/</span><span class="n">cirros</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-x86_64-disk</span><span class="p">.</span><span class="n">img</span>
</code></pre></div>
<p>部署kvm环境</p>
<div class="highlight"><pre><span></span><code><span class="n">判断CPU是否支持硬件虚拟化</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># egrep &#39;(vmx|svm)&#39; --color=always /proc/cpuinfo | wc -l</span>
<span class="n">2</span>

<span class="n">检查kvm模块是否加载</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># lsmod | grep kvm</span>
<span class="n">kvm_intel</span>             <span class="n">188740</span>  <span class="n">0</span>
<span class="n">kvm</span>                   <span class="n">637289</span>  <span class="n">1</span> <span class="n">kvm_intel</span>
<span class="n">irqbypass</span>              <span class="n">13503</span>  <span class="n">1</span> <span class="n">kvm</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">安装软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># yum install -y virt-manager libvirt qemu-kvm kvm</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">libvirt</span> <span class="n">虚拟机管理</span>
    <span class="n">virt</span> <span class="n">虚拟机安装克隆</span>
    <span class="n">qemu-kvm</span> <span class="n">管理虚拟机磁盘</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">启动服务</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">libvirtd</span><span class="p">.</span><span class="n">service</span>

<span class="n">确认效果</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">libvirtd</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看虚拟网络</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># virsh net-list</span>
 <span class="n">名称</span>               <span class="n">状态</span>     <span class="n">自动开始</span>  <span class="n">持久</span>
<span class="p">----------------------------------------------------------</span>
 <span class="k">default</span>              <span class="n">活动</span>     <span class="n">是</span>           <span class="n">是</span>

<span class="n">查看虚拟主机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># virsh list</span>
 <span class="n">Id</span>    <span class="n">名称</span>                         <span class="n">状态</span>
<span class="p">----------------------------------------------------</span>
</code></pre></div>
<p>部署ceph环境</p>
<div class="highlight"><pre><span></span><code><span class="n">安装ceph软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># yum install ceph ceph-common -y</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>确认kvm环境支持rdb磁盘</p>
<div class="highlight"><pre><span></span><code><span class="n">内置的qemu-kvm包已经支持RBD块设备</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># qemu-img --help | grep rbd</span>
<span class="n">Supported</span> <span class="n">formats</span><span class="p">:</span> <span class="n">vvfat</span> <span class="n">vpc</span> <span class="n">vmdk</span> <span class="n">vhdx</span> <span class="n">vdi</span> <span class="n">ssh</span> <span class="n">sheepdog</span> <span class="n">rbd</span> <span class="p">...</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># ldd /usr/libexec/qemu-kvm | grep rbd</span>
        <span class="n">librbd</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="n">1</span> <span class="p">=&gt;</span> <span class="p">/</span><span class="n">lib64</span><span class="p">/</span><span class="n">librbd</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="n">1</span> <span class="p">(</span><span class="n">0x00007f9badca9000</span><span class="p">)</span>

<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">qemu-kvm具备访问RBD的能力</span><span class="err">。</span>
</code></pre></div>
<p>ceph创建专属的pool和秘钥</p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph建立一个Pool</span><span class="err">，</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">superopsmsb</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">pool</span> <span class="s1">&#39;superopsmsb&#39;</span> <span class="n">created</span>

<span class="n">启动rbd功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">enable</span> <span class="n">superopsmsb</span> <span class="n">rbd</span>
<span class="n">enabled</span> <span class="n">application</span> <span class="s1">&#39;rbd&#39;</span> <span class="n">on</span> <span class="n">pool</span> <span class="s1">&#39;superopsmsb&#39;</span>

<span class="n">rbd环境初始化</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">init</span> <span class="n">superopsmsb</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建superopsmsb的pool专属认证权限</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow class-read object_prefix rbd_children, allow rwx pool=superopsmsb&#39;</span>
<span class="no">[client.superopsmsb]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQD5JzFjymapKxAASoWCRgp</span><span class="p">/</span><span class="n">yQt4dFGRmZDI8w</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建专属用户的秘钥文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span> <span class="n">-o</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">传递认证文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">sudo</span> <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">keyring</span> <span class="n">root</span><span class="nv">@stor05</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">sudo</span> <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span> <span class="n">root</span><span class="nv">@stor05</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>

<span class="n">传递正常的ceph集群的配置文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">sudo</span> <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="n">root</span><span class="nv">@stor05</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># ceph --user superopsmsb -s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="p">...</span>
</code></pre></div>
<p>kvm 集成ceph</p>
<div class="highlight"><pre><span></span><code><span class="n">创建认证文件</span> <span class="n">ceph-client-superopsmsb-secret</span><span class="p">.</span><span class="n">xml</span>
<span class="p">&lt;</span><span class="n">secret</span> <span class="n">ephemeral</span><span class="p">=</span><span class="s1">&#39;no&#39;</span> <span class="n">private</span><span class="p">=</span><span class="s1">&#39;no&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">usage</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;ceph&#39;</span><span class="p">&gt;</span> 
        <span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span><span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span> <span class="n">secret</span><span class="p">&lt;/</span><span class="n">name</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="n">usage</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">secret</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">使用virsh创建secret</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh secret-define --file ceph-client-superopsmsb-secret.xml</span>
<span class="n">生成</span> <span class="n">secret</span> <span class="n">caf4336b-d2de</span><span class="p">-</span><span class="n">4699</span><span class="p">-</span><span class="n">8aee</span><span class="p">-</span><span class="n">94569531559b</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将ceph的client</span><span class="p">.</span><span class="n">superopsmsb的密钥导</span><span class="err">⼊</span><span class="n">secret中</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh secret-set-value --secret caf4336b-d2de-4699-8aee-94569531559b --base64 $(ceph auth get-key client.superopsmsb)</span>
<span class="n">secret</span> <span class="n">值设定</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh secret-list</span>
 <span class="n">UUID</span>                                  <span class="n">用量</span>
<span class="p">--------------------------------------------------------------------------------</span>
 <span class="n">caf4336b-d2de</span><span class="p">-</span><span class="n">4699</span><span class="p">-</span><span class="n">8aee</span><span class="p">-</span><span class="n">94569531559b</span>  <span class="n">ceph</span> <span class="n">client</span><span class="p">.</span><span class="n">superopsmsb</span> <span class="n">secret</span>
</code></pre></div>
<p>镜像创建</p>
<div class="highlight"><pre><span></span><code><span class="n">创建空的image</span><span class="err">，</span><span class="n">或者导</span><span class="err">⼊</span><span class="n">已经的磁盘镜像内容</span>
<span class="n">方法1</span><span class="err">：</span><span class="n">导入镜像</span>
<span class="n">qemu-img</span> <span class="n">convert</span> <span class="o">-f</span> <span class="n">qcow2</span> <span class="n">-O</span> <span class="n">raw</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">image</span><span class="p">.</span><span class="n">img</span> <span class="n">rbd</span><span class="p">:&lt;</span><span class="n">pool-name</span><span class="p">&gt;/&lt;</span><span class="n">image-name</span><span class="p">&gt;</span>
<span class="n">方法2</span><span class="err">：</span><span class="n">创建镜像</span>
<span class="n">qemu-img</span> <span class="n">xxx</span> <span class="n">create</span> <span class="o">-f</span> <span class="n">rbd</span> <span class="n">rbd</span><span class="p">:&lt;</span><span class="n">pool-name</span><span class="p">&gt;/&lt;</span><span class="n">image-name</span><span class="p">&gt;</span> <span class="n">size</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># qemu-img create -f rbd rbd:superopsmsb/superopsmsb-image 1G</span>
<span class="n">Formatting</span> <span class="s1">&#39;rbd:superopsmsb/superopsmsb-image&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">=</span><span class="n">rbd</span> <span class="n">size</span><span class="p">=</span><span class="n">10737418240</span> <span class="n">cluster_size</span><span class="p">=</span><span class="n">0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认镜像文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># qemu-img info /data/images/cirros-0.5.2-x86_64-disk.img</span>
<span class="n">image</span><span class="p">:</span> <span class="n">cirros</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-x86_64-disk</span><span class="p">.</span><span class="n">img</span>
<span class="n">file</span> <span class="n">format</span><span class="p">:</span> <span class="n">qcow2</span>
<span class="p">...</span>

<span class="n">导入镜像文件到rdb</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># qemu-img convert -f qcow2 -O raw /data/images/cirros-0.5.2-x86_64-disk.img rbd:superopsmsb/cirros-0.5.2</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">~]</span><span class="c"># rbd --user superopsmsb ls superopsmsb -l</span>
<span class="n">NAME</span>              <span class="n">SIZE</span>    <span class="n">PARENT</span> <span class="n">FMT</span> <span class="n">PROT</span> <span class="n">LOCK</span>
<span class="n">cirros</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>      <span class="n">112</span> <span class="n">MiB</span>          <span class="n">2</span>
<span class="n">superopsmsb-image</span>  <span class="n">10</span> <span class="n">GiB</span>          <span class="n">2</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">因为是远程查看</span><span class="err">，</span><span class="n">所以信息展示有可能缓慢</span><span class="err">，</span><span class="n">我们可以直接在admin主机上进行快速查看</span>
</code></pre></div>
<p>虚拟机创建</p>
<div class="highlight"><pre><span></span><code><span class="n">定制虚拟机配置文件</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">node1</span><span class="p">.</span><span class="n">xml</span>
<span class="p">&lt;</span><span class="n">domain</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;kvm&#39;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span><span class="n">node1</span><span class="p">&lt;/</span><span class="n">name</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">memory</span> <span class="n">unit</span><span class="p">=</span><span class="s1">&#39;KiB&#39;</span><span class="p">&gt;</span><span class="n">512000</span><span class="p">&lt;/</span><span class="n">memory</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">currentMemory</span> <span class="n">unit</span><span class="p">=</span><span class="s1">&#39;KiB&#39;</span><span class="p">&gt;</span><span class="n">512000</span><span class="p">&lt;/</span><span class="n">currentMemory</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">vcpu</span> <span class="n">placement</span><span class="p">=</span><span class="s1">&#39;static&#39;</span><span class="p">&gt;</span><span class="n">1</span><span class="p">&lt;/</span><span class="n">vcpu</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">os</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nb">type </span><span class="n">arch</span><span class="p">=</span><span class="s1">&#39;x86_64&#39;</span><span class="p">&gt;</span><span class="n">hvm</span><span class="p">&lt;/</span><span class="n">type</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="n">os</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">devices</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">emulator</span><span class="p">&gt;/</span><span class="n">usr</span><span class="p">/</span><span class="n">libexec</span><span class="p">/</span><span class="n">qemu-kvm</span><span class="p">&lt;/</span><span class="n">emulator</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">disk</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;network&#39;</span> <span class="n">device</span><span class="p">=</span><span class="s1">&#39;disk&#39;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">source</span> <span class="n">protocol</span><span class="p">=</span><span class="s1">&#39;rbd&#39;</span> <span class="n">name</span><span class="p">=</span><span class="s1">&#39;superopsmsb/cirros-0.5.2&#39;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="n">host</span> <span class="n">name</span><span class="p">=</span><span class="s1">&#39;mon01&#39;</span> <span class="n">port</span><span class="p">=</span><span class="s1">&#39;6789&#39;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="n">source</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">auth</span> <span class="n">username</span><span class="p">=</span><span class="s1">&#39;superopsmsb&#39;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="n">secret</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;ceph&#39;</span> <span class="n">uuid</span><span class="p">=</span><span class="s1">&#39;caf4336b-d2de-4699-8aee-94569531559b&#39;</span><span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="n">auth</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">target</span> <span class="n">dev</span><span class="p">=</span><span class="s1">&#39;vda&#39;</span> <span class="n">bus</span><span class="p">=</span><span class="s1">&#39;virtio&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="n">disk</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">interface</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;network&#39;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">mac</span> <span class="n">address</span><span class="p">=</span><span class="s1">&#39;52:54:01:74:1c:9e&#39;</span><span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="n">source</span> <span class="n">network</span><span class="p">=</span><span class="s1">&#39;default&#39;</span><span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="n">model</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;virtio&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="n">interface</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">serial</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;pty&#39;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">target</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;isa-serial&#39;</span> <span class="n">port</span><span class="p">=</span><span class="s1">&#39;0&#39;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="n">model</span> <span class="n">name</span><span class="p">=</span><span class="s1">&#39;isa-serial&#39;</span><span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="n">target</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="n">serial</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">console</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;pty&#39;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">target</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;serial&#39;</span> <span class="n">port</span><span class="p">=</span><span class="s1">&#39;0&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="n">console</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">graphics</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;vnc&#39;</span> <span class="n">port</span><span class="p">=</span><span class="s1">&#39;-1&#39;</span> <span class="n">autoport</span><span class="p">=</span><span class="s1">&#39;yes&#39;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">listen</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;address&#39;</span> <span class="n">address</span><span class="p">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="n">graphics</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="n">devices</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">domain</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建虚拟机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh define node1.xml</span>
<span class="n">定义域</span> <span class="n">node1</span><span class="err">（</span><span class="n">从</span> <span class="n">node1</span><span class="p">.</span><span class="n">xml</span><span class="err">）</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh start node1</span>
<span class="n">域</span> <span class="n">node1</span> <span class="n">已开始</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看主机状态</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh list --all</span>
 <span class="n">Id</span>    <span class="n">名称</span>                         <span class="n">状态</span>
<span class="p">----------------------------------------------------</span>
 <span class="n">2</span>     <span class="n">node1</span>                          <span class="n">running</span>

<span class="n">查看设备信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh domblklist node1</span>
<span class="n">目标</span>     <span class="n">源</span>
<span class="p">------------------------------------------------</span>
<span class="n">vda</span>        <span class="n">superopsmsb</span><span class="p">/</span><span class="n">cirros</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>

<span class="n">可以借助于vnc</span> <span class="n">viewer</span> <span class="n">连接到虚拟机查看效果</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">启动很慢</span><span class="err">，</span><span class="n">但是运行需要等待3分钟左右</span>
</code></pre></div>
<p>磁盘挂载</p>
<div class="highlight"><pre><span></span><code><span class="n">关闭虚拟机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh destroy node1</span>
<span class="n">域</span> <span class="n">node1</span> <span class="n">被删除</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">编写专有设备文件</span> <span class="n">device</span><span class="p">.</span><span class="n">xml</span> 
<span class="p">&lt;</span><span class="n">disk</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;network&#39;</span> <span class="n">device</span><span class="p">=</span><span class="s1">&#39;disk&#39;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">driver</span> <span class="n">name</span><span class="p">=</span><span class="s1">&#39;qemu&#39;</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;raw&#39;</span><span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">auth</span> <span class="n">username</span><span class="p">=</span><span class="s1">&#39;superopsmsb&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">secret</span> <span class="n">type</span><span class="p">=</span><span class="s1">&#39;ceph&#39;</span> <span class="n">uuid</span><span class="p">=</span><span class="s1">&#39;caf4336b-d2de-4699-8aee-94569531559b&#39;</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="n">auth</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">source</span> <span class="n">protocol</span><span class="p">=</span><span class="s1">&#39;rbd&#39;</span> <span class="n">name</span><span class="p">=</span><span class="s1">&#39;superopsmsb/superopsmsb-image&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">host</span> <span class="n">name</span><span class="p">=</span><span class="s1">&#39;mon01&#39;</span> <span class="n">port</span><span class="p">=</span><span class="s1">&#39;6789&#39;</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="n">source</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">target</span> <span class="n">dev</span><span class="p">=</span><span class="s1">&#39;vdc&#39;</span> <span class="n">bus</span><span class="p">=</span><span class="s1">&#39;virtio&#39;</span><span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="n">disk</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将设备追加到虚拟机中</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh attach-device node1 device.xml --persistent</span>
<span class="n">成功附加设备</span>

<span class="n">确认磁盘挂载效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh domblklist node1</span>
<span class="n">目标</span>     <span class="n">源</span>
<span class="p">------------------------------------------------</span>
<span class="n">vda</span>        <span class="n">superopsmsb</span><span class="p">/</span><span class="n">cirros</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>
<span class="n">vdc</span>        <span class="n">superopsmsb</span><span class="p">/</span><span class="n">superopsmsb-image</span>
</code></pre></div>
<p>环境还原</p>
<div class="highlight"><pre><span></span><code><span class="n">删除虚拟机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor05</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># virsh undefine node1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">删除pool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">superopsmsb</span> <span class="n">superopsmsb</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">pool</span> <span class="s1">&#39;superopsmsb&#39;</span> <span class="n">removed</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">kube</span> <span class="n">kube</span>  <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">pool</span> <span class="s1">&#39;kube&#39;</span> <span class="n">removed</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="13_rgw">1.3 RGW接口<a class="headerlink" href="#13_rgw" title="Permanent link">&para;</a></h2>
<h3 id="131">1.3.1 基础知识<a class="headerlink" href="#131" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>OSS简介</p>
<div class="highlight"><pre><span></span><code><span class="n">对象存储</span><span class="p">(</span><span class="n">Object</span> <span class="n">Storage</span><span class="p">)</span> <span class="n">是无层次结构的数据存储方法</span><span class="err">，</span><span class="n">通常用于云计算环境中</span><span class="err">。</span><span class="n">不同于其他数据存储方法</span><span class="err">，</span><span class="n">基于对象的存储不使用目录树</span>
    <span class="n">数据作为单独的对象进行存储</span>
    <span class="n">数据并不放置在目录层次结构中</span><span class="err">，</span><span class="n">而是存在于平面地址空间内的同一级别</span>
    <span class="n">应用通过唯一地址来识别每个单独的数据对象</span>
    <span class="n">每个对象可包含有助于检索的元数据</span>
    <span class="n">专为使用API在应用级别</span><span class="err">（</span><span class="n">而非用户级别</span><span class="err">）</span><span class="n">进行访问而设计</span>
</code></pre></div>
<p>对象</p>
<div class="highlight"><pre><span></span><code><span class="n">对象是对象存储系统中数据存储的基本单位</span><span class="err">，</span><span class="n">每个Object是数据和数据属性集的综合体</span><span class="err">，</span><span class="n">数据属性可以根据应用的需求进行设置</span><span class="err">，</span><span class="n">包括数据分布</span><span class="err">、</span><span class="n">服务质量等</span>
    <span class="n">每个对象自我维护其属性</span><span class="err">，</span><span class="n">从而简化了存储系统的管理任务</span>
    <span class="n">对象的大小可以不同</span><span class="err">，</span><span class="n">甚至可以包含整个数据结构</span><span class="err">，</span><span class="n">如文件</span><span class="err">、</span><span class="n">数据库表项等</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">对象存储系统一般是一类智能设备</span><span class="err">，</span><span class="n">它具有自己的存储介质</span><span class="err">、</span><span class="n">处理器</span><span class="err">、</span><span class="n">内存以及网络系统等</span><span class="err">，</span><span class="n">负责管理本地的对象</span><span class="err">，</span><span class="n">是对象存储系统的核心</span><span class="p">.</span>
</code></pre></div>
<p><img alt="image-20220926182809531" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220926182809531.png" /></p>
<p>术语解析</p>
<div class="highlight"><pre><span></span><code><span class="n">一般说来</span><span class="err">，</span><span class="n">一个对象存储系统的核心资源类型应该包括用户</span><span class="err">（</span><span class="n">User</span><span class="err">）、</span><span class="n">存储桶</span><span class="err">（</span> <span class="n">bucket</span><span class="err">）</span><span class="n">和对象</span><span class="err">（</span><span class="n">object</span><span class="err">）</span>
<span class="n">它们之间的关系是</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">User将Object存储到存储系统上的Bucket</span>
    <span class="p">-</span> <span class="n">存储桶属于某个用户并可以容纳对象</span><span class="err">，</span><span class="n">一个存储桶用于存储多个对象</span>
    <span class="p">-</span> <span class="n">同一个用户可以拥有多个存储桶</span><span class="err">，</span><span class="n">不同用户允许使用相同名称的bucket</span>
</code></pre></div>
<p><img alt="image-20211210163113908" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211210163113908.png" /></p>
<p>常见方案</p>
<div class="highlight"><pre><span></span><code><span class="n">各种存储方案</span><span class="err">，</span><span class="n">虽然在设计与实现上有所区别</span><span class="err">，</span><span class="n">但大多数对象存储系统对外呈现的核心资源类型大同小异</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>方案</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Amazon S3</td>
<td>提供了user、bucket和object分别表示用户、存储桶和对象，其中bucket隶属于user，因此user名称即可做为bucket的名称空间，不同用户允许使用相同名称的bucket</td>
</tr>
<tr>
<td>OpenStack Swift</td>
<td>提供了user、container和object分别对应于用户、存储桶和对象，不过它还额外为user提供了父级组件account，用于表示一个项目或租户，因此一个account中可包含一到多个user，它们可共享使用同一组container，并为container提供名称空间</td>
</tr>
<tr>
<td>RadosGW</td>
<td>提供了user、subuser、bucket和object，其中的user对应于S3的user，而subuser则对应于Swift的user，不过user和subuser都不支持为bucket提供名称空间，因此 ，不同用户的存储桶也不允许同名；不过，自Jewel版本起，RadosGW引入了tenant（租户）用于为user和bucket提供名称空间，但它是个可选组件<br>Jewel版本之前，radosgw的所有user位于同一名称空间，它要求所有user的ID必须惟一，并且即便是不同user的bucket也不允许使用相同的bucket ID</td>
</tr>
</tbody>
</table>
<p><strong>简单实践</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph对象存储使用Ceph对象网关守护进程</span><span class="err">（</span><span class="n">radosgw</span><span class="err">），</span><span class="n">它是用于与Ceph存储群集进行交互的HTTP服务器</span><span class="err">。</span><span class="n">由于它提供与OpenStack</span> <span class="n">Swift和Amazon</span> <span class="n">S3兼容的接口</span><span class="err">，</span><span class="n">因此Ceph对象网关具有自己的用户管理</span><span class="err">。</span><span class="n">Ceph对象网关可以将数据存储在用于存储来自Ceph文件系统客户端或Ceph块设备客户端的数据的同一Ceph存储群集中</span><span class="err">。</span><span class="n">S3和Swift</span> <span class="n">API共享一个公共的名称空间</span><span class="err">，</span><span class="n">因此可以使用一个API编写数据</span><span class="err">，</span><span class="n">而使用另一个API检索数据</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ceph</span> <span class="n">RGW基于librados</span><span class="err">，</span><span class="n">是为应用提供RESTful类型的对象存储接口</span><span class="err">。</span><span class="n">RGW提供两种类型的接口</span><span class="err">：</span>
　　<span class="n">1</span><span class="p">)</span> <span class="n">S3</span><span class="err">：</span><span class="n">兼容Amazon</span> <span class="n">S3RESTful</span> <span class="n">API</span><span class="err">；</span>
　　<span class="n">2</span><span class="p">)</span> <span class="n">Swift</span><span class="err">：</span><span class="n">兼容OpenStack</span> <span class="n">Swift</span> <span class="n">API</span><span class="err">。</span>
　　
<span class="n">同时</span><span class="err">，</span><span class="n">RGW为了实现RESTful接口的功能</span><span class="err">，</span><span class="n">默认使用Civetweb作为其Web</span> <span class="n">Sevice</span><span class="err">，</span><span class="n">而Civetweb默认使用端口7480提供服务</span><span class="err">，</span><span class="n">如果想修改端口</span><span class="err">（</span><span class="n">如80端口</span><span class="err">），</span><span class="n">就需要修改Ceph的配置文件</span><span class="err">。</span>
</code></pre></div>
<p>要点</p>
<div class="highlight"><pre><span></span><code><span class="n">RGW在创建的时候</span><span class="err">，</span><span class="n">自动会初始化自己的存储池</span><span class="err">，</span><span class="n">而且RGW还需要自己独有的守护进程服务才可以正常的使用</span>

<span class="n">RGW并非必须的接口</span><span class="err">，</span><span class="n">仅在需要用到与S3和Swift兼容的RESTful接口时才需要部署RGW实例</span>
</code></pre></div>
<p><img alt="image-20220926220715586" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220926220715586.png" /></p>
<p>RGW内部逻辑处理层级结构图</p>
<p><img alt="image-20220928111659491" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220928111659491.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">HTTP</span> <span class="n">前端</span><span class="p">:</span> 
    <span class="n">接收数据操作请求</span><span class="err">。</span>
<span class="n">REST</span> <span class="n">API接口</span><span class="err">：</span>
    <span class="n">从http请求中解析出</span> <span class="n">S3</span> <span class="n">或</span> <span class="n">Swift</span> <span class="n">数据并进行一系列检查</span><span class="err">。</span>
<span class="n">API操作逻辑</span><span class="p">:</span>
    <span class="n">经Restful</span> <span class="n">接口检查通过后</span><span class="err">，</span><span class="n">根据内部业务逻辑交由不同业务模块进行数据处理</span><span class="err">。</span>
<span class="n">RADOS接口</span><span class="err">：</span>
    <span class="n">如果需要写入或者操作ceph集群数据</span><span class="err">，</span><span class="n">则经由RADOS</span> <span class="p">+</span> <span class="n">librados</span> <span class="n">调用将数据发送给集群的后端主机</span>
</code></pre></div>
<p>常见属性</p>
<div class="highlight"><pre><span></span><code>    <span class="n">自0</span><span class="p">.</span><span class="n">80版本起</span><span class="err">，</span><span class="n">Ceph放弃了基于apache和fastcgi提供radosgw服务的传统而代之以默认嵌入在ceph-radosgw进程中的Citeweb</span><span class="err">，</span><span class="n">这种新的实现方式更加轻便和简洁</span><span class="err">，</span><span class="n">但直到Ceph</span> <span class="n">11</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1版本</span><span class="err">，</span><span class="n">Citeweb才开始支持SSL协议</span><span class="p">.</span>

    <span class="n">Citeweb默认监听于TCP协议的7480端口提供http服务</span><span class="err">，</span><span class="n">修改配置需要编辑ceph</span><span class="p">.</span><span class="n">conf配置文件</span><span class="err">，</span><span class="n">以如下格式进行定义</span>
    <span class="p">[</span><span class="n">client</span><span class="p">.</span><span class="n">rgw</span><span class="p">.&lt;</span><span class="n">gateway-node</span><span class="p">&gt;]</span>
    <span class="n">rgw_host</span> <span class="p">=</span> <span class="p">&lt;</span><span class="n">hostname</span> <span class="n">OR</span> <span class="n">ipaddr</span><span class="p">&gt;</span>
    <span class="n">rgw_frontends</span> <span class="p">=</span> <span class="s2">&quot;civetweb port=80&quot;</span>

    <span class="n">配置完成后需要重启ceph-radosgw进程以生效新配置</span>
    <span class="n">ceph-radosgw</span><span class="nv">@rgw</span><span class="p">.&lt;</span><span class="n">gateway-node</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其他相关的配置</span> 
<span class="n">配置https</span>
    <span class="n">额外添加参数ssl_certificate</span><span class="p">=/</span><span class="n">PATH</span><span class="p">/</span><span class="n">TO</span><span class="p">/</span><span class="n">PEM_FILE</span>
    <span class="n">定义port</span><span class="p">=</span><span class="n">443s</span><span class="err">，</span><span class="n">或者port</span><span class="p">=</span><span class="n">80</span><span class="p">+</span><span class="n">443s</span>

<span class="n">其它配置参数</span>
    <span class="n">num_threads</span><span class="err">：</span><span class="n">Citeweb以线程模型处理客户端请求</span><span class="err">，</span><span class="n">它为每个连接请求分配一个专用线</span>
<span class="n">程</span><span class="err">，</span><span class="n">因而此参数定义了其支持的最大并发连接数</span><span class="err">，</span><span class="n">默认值为50</span>
    <span class="n">request_timeout_ms</span><span class="err">：</span><span class="n">网络发送与接收操作的超时时长</span><span class="err">，</span><span class="n">以ms为单位</span><span class="err">，</span><span class="n">默认值为30000</span>
<span class="err">；</span><span class="n">可以在必要时通过增大此值实现长连接的效果</span>
    <span class="n">access_log_file</span><span class="err">：</span><span class="n">访问日志的文件路径</span><span class="err">，</span><span class="n">默认为空</span>
    <span class="n">error_log_file</span><span class="err">：</span><span class="n">错误日志的文件路径</span><span class="err">，</span><span class="n">默认为空</span>
    <span class="n">rgw_dns_name</span><span class="err">：</span> <span class="n">定制专属的dns服务解析域名</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="132">1.3.2 基础操作<a class="headerlink" href="#132" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>部署RGW主机</p>
<div class="highlight"><pre><span></span><code><span class="n">到stor04主机上的部署ceph环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># yum install -y ceph-radosgw</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">admin节点上</span><span class="err">，</span><span class="n">创建rgw的主机环境</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">rgw</span> <span class="n">create</span> <span class="n">stor04</span>
<span class="no">[ceph_deploy.conf][DEBUG ]</span> <span class="n">found</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">at</span><span class="p">:</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">cephdeploy</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>
<span class="no">[ceph_deploy.rgw][INFO  ]</span> <span class="n">The</span> <span class="n">Ceph</span> <span class="n">Object</span> <span class="n">Gateway</span> <span class="p">(</span><span class="n">RGW</span><span class="p">)</span> <span class="n">is</span> <span class="n">now</span> <span class="n">running</span> <span class="n">on</span> <span class="n">host</span> <span class="n">stor04</span> <span class="n">and</span> <span class="k">default</span> <span class="n">port</span> <span class="n">7480</span>
</code></pre></div>
<p>查看效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看集群的状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">3h</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">30h</span><span class="p">),</span> <span class="n">standbys</span><span class="p">:</span> <span class="n">mon02</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">26h</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">26h</span><span class="p">)</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看服务状况</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># netstat -tnulp | grep radosgw</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">7480</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>  <span class="n">LISTEN</span>      <span class="n">4295</span><span class="p">/</span><span class="n">radosgw</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">7480</span>        <span class="p">:::*</span>       <span class="n">LISTEN</span>      <span class="n">4295</span><span class="p">/</span><span class="n">radosgw</span>

<span class="n">查看服务进程</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># ps aux | grep -v grep | grep radosgw</span>
<span class="n">ceph</span>       <span class="n">4295</span>  <span class="n">0</span><span class="p">.</span><span class="n">5</span>  <span class="n">2</span><span class="p">.</span><span class="n">1</span> <span class="n">5145976</span> <span class="n">39612</span> <span class="p">?</span>       <span class="n">Ssl</span>  <span class="n">18</span><span class="p">:</span><span class="n">37</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">radosgw</span> <span class="o">-f</span> <span class="p">-</span><span class="n">-cluster</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-name</span> <span class="n">client</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">stor04</span> <span class="p">-</span><span class="n">-setuser</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-setgroup</span> <span class="n">ceph</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">RGW会在rados集群上生成包括如下存储池的一系列存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">control</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">log</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">默认情况下</span><span class="err">，</span><span class="n">rgw自动创建4个存储池</span>
</code></pre></div>
<p>RGW提供了一个简单的web接口，用于数据的交流</p>
<div class="highlight"><pre><span></span><code><span class="n">web访问接口</span>
    <span class="n">RGW提供的是REST接口</span><span class="err">，</span><span class="n">客户端通过http与其进行交互</span><span class="err">，</span><span class="n">完成数据的增删改查等管理操作</span><span class="err">。</span><span class="n">浏览器查看</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="p">:</span><span class="n">7480</span> <span class="n">的web简单应用效果</span>
</code></pre></div>
<p><img alt="image-20211206115942508" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211206115942508.png" /></p>
<p><strong>简单实践</strong></p>
<p>更改端口实践</p>
<div class="highlight"><pre><span></span><code><span class="n">默认情况下</span><span class="err">，</span><span class="n">RGW实例监听于TCP协议的7480端口7480</span><span class="err">，</span><span class="n">需要定制的话</span><span class="err">，</span><span class="n">可以通过在运行RGW的节点上编辑其主配置文件ceph</span><span class="p">.</span><span class="n">conf进行修改</span><span class="err">，</span><span class="n">相关参数如下所示</span><span class="err">：</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># cat /etc/ceph/ceph.conf</span>
<span class="p">...</span>
<span class="no">[client.rgw.stor04]</span>
<span class="n">rgw_frontends</span> <span class="p">=</span> <span class="s2">&quot;civetweb port=8080&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl status ceph-radosgw@rgw.stor04</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># netstat -tnulp | grep 8080</span>
<span class="n">tcp</span>     <span class="n">0</span>   <span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8080</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>    <span class="n">LISTEN</span>  <span class="n">152636</span><span class="p">/</span><span class="n">radosgw</span>
</code></pre></div>
<p><img alt="image-20211210173544875" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211210173544875.png" /></p>
<p>ssl通信</p>
<div class="highlight"><pre><span></span><code>需要提供pem证书文件，需要将 证书和私钥文件放在同一个文件里面
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">生成秘钥</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># mkdir /etc/ceph/ssl &amp;&amp; cd /etc/ceph/ssl</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ssl</span><span class="p">]</span><span class="c"># openssl genrsa -out civetweb.key 2048</span>

<span class="n">生成证书</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ssl</span><span class="p">]</span><span class="c"># openssl req -new -x509 -key civetweb.key -out civetweb.crt -days 3650 -subj &quot;/CN=stor04.superopsmsb.com&quot;</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ssl</span><span class="p">]</span><span class="c"># ls</span>
<span class="n">civetweb</span><span class="p">.</span><span class="n">crt</span>  <span class="n">civetweb</span><span class="p">.</span><span class="n">key</span>

<span class="n">合并证书信息</span>
<span class="n">root</span><span class="nv">@stor04</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ssl</span><span class="c"># cat civetweb.key civetweb.crt &gt; civetweb.pem</span>
</code></pre></div>
<p>修改认证信息</p>
<div class="highlight"><pre><span></span><code><span class="n">在运行RGW的节点上编辑其主配置文件ceph</span><span class="p">.</span><span class="n">conf进行修改</span><span class="err">，</span><span class="n">相关参数如下所示</span><span class="err">：</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># cat /etc/ceph/ceph.conf</span>
<span class="p">...</span>
<span class="no">[client.rgw.stor04]</span>
<span class="n">rgw_frontends</span> <span class="p">=</span> <span class="s2">&quot;civetweb port=8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem&quot;</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里的8443s</span><span class="err">，</span><span class="n">最后的s代表必须使用ssl通信方式</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl status ceph-radosgw@rgw.stor04</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># netstat -tnulp | grep 8443</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8443</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>     <span class="n">LISTEN</span>      <span class="n">153319</span><span class="p">/</span><span class="n">radosgw</span>
</code></pre></div>
<p><img alt="image-20211210174100106" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211210174100106.png" /></p>
<p>同时开启 https和http方式来进行访问</p>
<div class="highlight"><pre><span></span><code><span class="n">在运行RGW的节点上编辑其主配置文件ceph</span><span class="p">.</span><span class="n">conf进行修改</span><span class="err">，</span><span class="n">相关参数如下所示</span><span class="err">：</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># cat ceph.conf</span>
<span class="p">...</span>
<span class="no">[client.rgw.stor04]</span>
<span class="n">rgw_frontends</span> <span class="p">=</span> <span class="s2">&quot;civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem&quot;</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">通过</span> <span class="n">port</span><span class="p">+</span><span class="n">port</span> <span class="n">的方式实现多端口开启服务</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl status ceph-radosgw@rgw.stor04</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># netstat -tnulp | grep radosgw</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">7480</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>     <span class="n">LISTEN</span>      <span class="n">153941</span><span class="p">/</span><span class="n">radosgw</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8443</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>     <span class="n">LISTEN</span>      <span class="n">153941</span><span class="p">/</span><span class="n">radosgw</span>
</code></pre></div>
<p><img alt="image-20211210174340551" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211210174340551.png" /></p>
<p>高并发配置</p>
<div class="highlight"><pre><span></span><code>对于ceph来说，它内部的高并发主要是通过线程方式定义的，而且默认值是50，如果我们要调整并发数量的话，可以调整num_threads的属性值

配置示例：
    [client.rgw.stor04]
    rgw_frontends = &quot;civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem num_threads=2000&quot;
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="133">1.3.3 泛域名实践<a class="headerlink" href="#133" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">S3的存储桶是用于存储对象的容器</span><span class="err">，</span><span class="n">每个对象都必须储存在一个特定的存储桶中</span><span class="err">，</span><span class="n">且每个对象都要直接通过RESTful</span> <span class="n">API基于URL进行访问</span><span class="err">，</span><span class="n">URL格式为</span>
    <span class="err">“</span><span class="n">http</span><span class="p">(</span><span class="n">s</span><span class="p">)://</span><span class="n">bucket-name</span><span class="p">.</span><span class="n">radowgw-host</span><span class="p">[:</span><span class="n">port</span><span class="p">]/</span><span class="n">key</span><span class="err">”</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">例如</span><span class="err">，</span><span class="n">对于存储在rgw01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">io上的S3</span> <span class="n">API对象存储系统上eshop存储桶中的名为images</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">jpg</span> <span class="n">的对象</span><span class="err">，</span><span class="n">可通过</span> <span class="n">http</span><span class="p">://</span><span class="n">eshop</span><span class="p">.</span><span class="n">rgw01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">images</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">jpg对其进行寻址</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">因此</span><span class="err">，</span><span class="n">radosgw的S3</span> <span class="n">API接口的功能强依赖于DNS的泛域名解析服务</span><span class="err">，</span><span class="n">它必须能够正常解析任何</span><span class="err">“</span><span class="p">&lt;</span><span class="n">bucket-name</span><span class="p">&gt;.&lt;</span><span class="n">radowgw-host</span><span class="p">&gt;</span><span class="err">”</span><span class="n">格式的名称至radosgw主机</span><span class="err">。</span>
    <span class="n">除此之外</span><span class="err">，</span><span class="n">我们还需要配置每个radowgw守护进程的rgw_dns_name为其DNS名称</span>
</code></pre></div>
<p>dns环境配置</p>
<div class="highlight"><pre><span></span><code><span class="n">安装软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># yum -y install bind bind-chroot bind-utils bind-libs</span>
<span class="n">备注</span><span class="err">：</span>
  <span class="n">bind</span>           <span class="n">提供了域名服务的主要程序及相关文件</span>  
  <span class="n">bind-utils</span>     <span class="n">提供了对DNS服务器的测试工具程序</span><span class="err">（</span><span class="n">如nslookup</span><span class="err">、</span><span class="n">dig等</span><span class="err">）</span>
  <span class="n">bind-chroot</span>    <span class="n">为bind提供一个伪装的根目录以增强安全性</span>

<span class="n">启动服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># systemctl  start named</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># systemctl  status named</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看版本信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># named -v</span>
<span class="n">BIND</span> <span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4-P2-RedHat</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4</span><span class="p">-</span><span class="n">26</span><span class="p">.</span><span class="n">P2</span><span class="p">.</span><span class="n">el7_9</span><span class="p">.</span><span class="n">9</span> <span class="p">(</span><span class="n">Extended</span> <span class="n">Support</span> <span class="n">Version</span><span class="p">)</span> <span class="p">&lt;</span><span class="n">id</span><span class="p">:</span><span class="n">7107deb</span><span class="p">&gt;</span>

<span class="n">查看配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># rpm -ql bind | grep named.conf</span>
<span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">tmpfiles</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">bind</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4</span><span class="p">/</span><span class="n">man</span><span class="p">.</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">html</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">bind</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4</span><span class="p">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="k">default</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">bind</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4</span><span class="p">/</span><span class="n">sample</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">man</span><span class="p">/</span><span class="n">man5</span><span class="p">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">gz</span>

<span class="n">查看暴露端口</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># netstat -tnulp | grep 53</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">53</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>    <span class="n">LISTEN</span>    <span class="n">17563</span><span class="p">/</span><span class="n">named</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">953</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>    <span class="n">LISTEN</span>    <span class="n">17563</span><span class="p">/</span><span class="n">named</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="n">1</span><span class="p">:</span><span class="n">53</span>          <span class="p">:::*</span>         <span class="n">LISTEN</span>    <span class="n">17563</span><span class="p">/</span><span class="n">named</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="n">1</span><span class="p">:</span><span class="n">953</span>         <span class="p">:::*</span>         <span class="n">LISTEN</span>    <span class="n">17563</span><span class="p">/</span><span class="n">named</span>
<span class="n">udp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">53</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>              <span class="n">17563</span><span class="p">/</span><span class="n">named</span>
<span class="n">udp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">::</span><span class="n">1</span><span class="p">:</span><span class="n">53</span>          <span class="p">:::*</span>                   <span class="n">17563</span><span class="p">/</span><span class="n">named</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>定制zone的配置</p>
<div class="highlight"><pre><span></span><code><span class="n">定制正向解析zone的配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># tail /etc/named.conf -n 9</span>
<span class="n">options</span> <span class="p">{</span>
        <span class="n">listen-on</span> <span class="n">port</span> <span class="n">53</span> <span class="p">{</span> <span class="n">any</span><span class="p">;</span> <span class="p">};</span>  <span class="p">//</span> <span class="n">监听任何ip对53端口的请求</span>
        <span class="p">...</span>
        <span class="n">allow-query</span>     <span class="p">{</span> <span class="n">any</span><span class="p">;</span> <span class="p">};</span> <span class="p">//</span> <span class="n">接收任何来源查询dns记录</span>
        <span class="p">...</span>
<span class="p">};</span>
<span class="p">...</span>
<span class="p">//</span> <span class="n">定制网站主域名的zone配置</span>
<span class="n">zone</span> <span class="s2">&quot;superopsmsb.com&quot;</span> <span class="k">IN</span> <span class="p">{</span>
        <span class="nb">type </span><span class="n">master</span><span class="p">;</span>
        <span class="n">file</span> <span class="s2">&quot;superopsmsb.com.zone&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">//</span> <span class="n">定制泛域名网站的zone配置</span>
<span class="n">zone</span> <span class="s2">&quot;stor04.superopsmsb.com&quot;</span> <span class="k">IN</span> <span class="p">{</span>
        <span class="nb">type </span><span class="n">master</span><span class="p">;</span>
        <span class="n">file</span> <span class="s2">&quot;stor04.superopsmsb.com.zone&quot;</span><span class="p">;</span>

<span class="p">};</span>
<span class="p">...</span>
<span class="n">include</span> <span class="s2">&quot;/etc/named.rfc1912.zones&quot;</span><span class="p">;</span>
<span class="n">include</span> <span class="s2">&quot;/etc/named.root.key&quot;</span><span class="p">;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制主域名的zone文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># cat /var/named/superopsmsb.com.zone</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">BIND</span> <span class="n">reverse</span> <span class="n">data</span> <span class="n">file</span> <span class="k">for</span> <span class="n">local</span> <span class="n">loopback</span> <span class="n">interface</span>
<span class="p">;</span>
<span class="nv">$TTL</span>    <span class="n">604800</span>
<span class="p">@</span>       <span class="k">IN</span>      <span class="n">SOA</span>     <span class="n">ns</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="n">admin</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="p">(</span>
                              <span class="n">1</span>         <span class="p">;</span> <span class="n">Serial</span>
                         <span class="n">604800</span>         <span class="p">;</span> <span class="n">Refresh</span>
                          <span class="n">86400</span>         <span class="p">;</span> <span class="n">Retry</span>
                        <span class="n">2419200</span>         <span class="p">;</span> <span class="n">Expire</span>
                         <span class="n">604800</span> <span class="p">)</span>       <span class="p">;</span> <span class="n">Negative</span> <span class="n">Cache</span> <span class="n">TTL</span>
<span class="p">;</span>
        <span class="k">IN</span>      <span class="n">NS</span>      <span class="n">ns</span>
<span class="n">ns</span>      <span class="k">IN</span>      <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
<span class="n">stor02</span>  <span class="k">IN</span>      <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>
<span class="n">stor03</span>  <span class="k">IN</span>      <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>
<span class="n">stor04</span>  <span class="k">IN</span>     <span class="n">NS</span>    <span class="n">ns</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制泛域名的zone文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># cat /var/named/stor04.superopsmsb.com.zone</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">BIND</span> <span class="n">reverse</span> <span class="n">data</span> <span class="n">file</span> <span class="k">for</span> <span class="n">local</span> <span class="n">loopback</span> <span class="n">interface</span>
<span class="p">;</span>
<span class="nv">$TTL</span>    <span class="n">604800</span>
<span class="p">@</span>       <span class="k">IN</span>      <span class="n">SOA</span>     <span class="n">ns</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="n">admin</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="p">(</span>
                              <span class="n">1</span>         <span class="p">;</span> <span class="n">Serial</span>
                         <span class="n">604800</span>         <span class="p">;</span> <span class="n">Refresh</span>
                          <span class="n">86400</span>         <span class="p">;</span> <span class="n">Retry</span>
                        <span class="n">2419200</span>         <span class="p">;</span> <span class="n">Expire</span>
                         <span class="n">604800</span> <span class="p">)</span>       <span class="p">;</span> <span class="n">Negative</span> <span class="n">Cache</span> <span class="n">TTL</span>
<span class="p">;</span>
        <span class="k">IN</span>      <span class="n">NS</span>      <span class="n">ns</span>
<span class="n">ns</span>      <span class="k">IN</span>      <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
<span class="p">*</span>        <span class="k">IN</span>     <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># named-checkconf</span>

<span class="n">重启dns服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># systemctl restart named</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># systemctl status named</span>

<span class="n">定制本地主机专属的dns域名服务器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># cat /etc/resolv.conf</span>
<span class="c"># Generated by NetworkManager</span>
<span class="n">search</span> <span class="n">localhost</span>
<span class="n">nameserver</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>确认dns解析效果
[root@admin ~]# host -a stor02.superopsmsb.com
[root@admin ~]# host -a stor02.superopsmsb.com 10.0.0.12
[root@admin ~]# host -a stor02.superopsmsb.com 10.0.0.12
Trying &quot;stor02.superopsmsb.com&quot;
Using domain server:
Name: 10.0.0.12
Address: 10.0.0.12#53
Aliases:
...
;; QUESTION SECTION:
;stor02.superopsmsb.com.                IN      ANY

;; ANSWER SECTION:
stor02.superopsmsb.com. 604800  IN      A       10.0.0.14

;; AUTHORITY SECTION:
superopsmsb.com.        604800  IN      NS      ns.superopsmsb.com.

;; ADDITIONAL SECTION:
ns.superopsmsb.com.     604800  IN      A       10.0.0.12

Received 89 bytes from 10.0.0.12#53 in 0 ms
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># nslookup stor02.superopsmsb.com </span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># nslookup stor02.superopsmsb.com 10.0.0.12</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">stor02</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认dns解析效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># dig file.stor04.superopsmsb.com</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># dig img.stor04.superopsmsb.com @10.0.0.12</span>

<span class="p">;</span> <span class="p">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4-P2-RedHat</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4</span><span class="p">-</span><span class="n">26</span><span class="p">.</span><span class="n">P2</span><span class="p">.</span><span class="n">el7_9</span><span class="p">.</span><span class="n">9</span> <span class="p">&lt;&lt;&gt;&gt;</span> <span class="n">img</span><span class="p">.</span><span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
<span class="p">...</span>
<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">img</span><span class="p">.</span><span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="n">604800</span> <span class="k">IN</span>   <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>

<span class="p">;;</span> <span class="n">AUTHORITY</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="n">604800</span>  <span class="k">IN</span>      <span class="n">NS</span>      <span class="n">ns</span><span class="p">.</span><span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>

<span class="p">;;</span> <span class="n">ADDITIONAL</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">ns</span><span class="p">.</span><span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="n">604800</span> <span class="k">IN</span>    <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>

<span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="n">0</span> <span class="n">msec</span>
<span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="c">#53(10.0.0.12)</span>
<span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">一</span> <span class="n">9月</span> <span class="n">26</span> <span class="n">19</span><span class="p">:</span><span class="n">46</span><span class="p">:</span><span class="n">57</span> <span class="n">CST</span> <span class="n">2022</span>
<span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="n">104</span>
</code></pre></div>
<p>配置rgw存储节点的dns相关配置</p>
<div class="highlight"><pre><span></span><code><span class="n">定制stor04的dns域名配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># tail -n4 /etc/ceph/ceph.conf</span>
<span class="no">[client.rgw.stor04]</span>
<span class="n">rgw_host</span> <span class="p">=</span> <span class="n">stor04</span>
<span class="n">rgw_frontends</span> <span class="p">=</span> <span class="s2">&quot;civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem&quot;</span>
<span class="n">rgw_dns_name</span> <span class="p">=</span> <span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
<span class="n">属性解析</span><span class="err">：</span>
    <span class="n">通过</span> <span class="n">rgw_dns_name</span> <span class="n">属性制定当前节点的域名</span>

<span class="n">重启当前节点的服务效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl status ceph-radosgw@rgw.stor04</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="134_s3">1.3.4 S3测试<a class="headerlink" href="#134_s3" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>S3 API接口简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">S3服务的REST</span> <span class="n">API使用用户账号</span><span class="err">（</span><span class="n">user</span><span class="err">）、</span><span class="n">存储桶</span><span class="err">（</span><span class="n">bucket</span><span class="err">）</span><span class="n">和对象</span><span class="err">（</span><span class="n">object</span><span class="err">）</span><span class="n">三个组件来组织存储的数据对象</span><span class="err">，</span><span class="n">对象保存于存储桶中</span><span class="err">，</span><span class="n">而存储桶则支持授权给特定账号进行读写及创建</span><span class="p">/</span><span class="n">删除等操作</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">radosgw-admin是用于管理radowgw服务的命令行接口</span><span class="err">，</span><span class="n">它有着众多的分别用于不同管理功能的命令</span><span class="err">，</span><span class="n">例如user</span><span class="err">、</span><span class="n">subuser</span><span class="err">、</span><span class="n">key</span><span class="err">、</span><span class="n">bucket和object等</span>
    <span class="n">命令格式</span><span class="err">：</span>
        <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">create</span> <span class="p">-</span><span class="n">-uid</span><span class="p">=</span><span class="s2">&quot;s3user&quot;</span> <span class="p">-</span><span class="n">-display-name</span><span class="p">=</span><span class="s2">&quot;S3 Testing User&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">而后即可通过其API接口进行访问测试</span><span class="err">，</span><span class="n">或者使用s3cmd命令进行</span>
<span class="p">-</span> <span class="n">使用s3cmd命令之前需要事先配置其工作环境</span><span class="err">，</span><span class="n">包括指定Access</span> <span class="n">Key和Secret</span> <span class="n">Key</span><span class="err">，</span><span class="n">以及S3服务的访问端点和默认的Region</span><span class="err">（</span><span class="n">Ceph的新版本中称作zonegroup</span><span class="err">）</span><span class="n">等</span>
    <span class="n">命令格式</span><span class="err">：</span>
        <span class="n">s3cmd</span> <span class="p">-</span><span class="n">-configure</span>

<span class="p">-</span> <span class="n">配置的结果将保存于</span><span class="p">~/.</span><span class="n">s3cmd</span><span class="p">.</span><span class="n">cfg配置文件中</span><span class="err">，</span><span class="n">用户随后可通过编辑此文件修改配置参数</span><span class="err">，</span><span class="n">或者再次运行此配置命令为其指定新的配置信息</span>
    <span class="n">s3cmd有众多的子命令</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">radosgw</span><span class="p">/</span><span class="n">s3</span><span class="p">/</span><span class="n">python</span><span class="p">/</span><span class="c">#using-s3-api-extensions</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>S3 API接口专用账号</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属账号</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">create</span> <span class="p">-</span><span class="n">-uid</span><span class="p">=</span><span class="s1">&#39;s3user&#39;</span> <span class="p">-</span><span class="n">-display-name</span><span class="p">=</span><span class="s1">&#39;S3 Testing user&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;S3 Testing user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;suspended&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
    <span class="s2">&quot;max_buckets&quot;</span><span class="p">:</span> <span class="n">1000</span><span class="p">,</span>
    <span class="s2">&quot;subusers&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看认证用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">list</span>
<span class="p">[</span>
    <span class="s2">&quot;s3user&quot;</span>
<span class="p">]</span>

<span class="n">查看详情</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">info</span> <span class="p">-</span><span class="n">-uid</span> <span class="n">s3user</span>
<span class="p">{</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>客户端配置</p>
<div class="highlight"><pre><span></span><code><span class="n">在客户端上安装测试命令</span> <span class="n">s3cmd</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># yum install s3cmd -y</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">使用s3之前</span><span class="err">，</span><span class="n">需要做一些预设的配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd --configure</span>

<span class="n">Enter</span> <span class="n">new</span> <span class="n">values</span> <span class="n">or</span> <span class="n">accept</span> <span class="n">defaults</span> <span class="k">in</span> <span class="n">brackets</span> <span class="n">with</span> <span class="n">Enter</span><span class="p">.</span>
<span class="n">Refer</span> <span class="n">to</span> <span class="n">user</span> <span class="n">manual</span> <span class="k">for</span> <span class="n">detailed</span> <span class="n">description</span> <span class="n">of</span> <span class="n">all</span> <span class="n">options</span><span class="p">.</span>

<span class="n">Access</span> <span class="n">key</span> <span class="n">and</span> <span class="n">Secret</span> <span class="n">key</span> <span class="n">are</span> <span class="n">your</span> <span class="n">identifiers</span> <span class="k">for</span> <span class="n">Amazon</span> <span class="n">S3</span><span class="p">.</span> <span class="n">Leave</span> <span class="n">them</span> <span class="n">empty</span> <span class="k">for</span> <span class="n">using</span> <span class="n">the</span> <span class="n">env</span> <span class="n">variables</span><span class="p">.</span>
<span class="c"># 下面的两个属性是来自于之前的账号信息</span>
<span class="n">Access</span> <span class="n">Key</span><span class="p">:</span> <span class="n">BX2IDCO5ADZ8IWZ4AVX7</span>        
<span class="n">Secret</span> <span class="n">Key</span><span class="p">:</span> <span class="n">wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf</span>
<span class="k">Default</span> <span class="n">Region</span> <span class="no">[US]</span><span class="p">:</span>        <span class="c"># 此处可以使用默认的</span>

<span class="n">Use</span> <span class="s2">&quot;s3.amazonaws.com&quot;</span> <span class="k">for</span> <span class="n">S3</span> <span class="n">Endpoint</span> <span class="n">and</span> <span class="n">not</span> <span class="n">modify</span> <span class="n">it</span> <span class="n">to</span> <span class="n">the</span> <span class="n">target</span> <span class="n">Amazon</span> <span class="n">S3</span><span class="p">.</span>
<span class="c"># 此处的域名是否用，我们自己定义的内容</span>
<span class="n">S3</span> <span class="n">Endpoint</span> <span class="no">[s3.amazonaws.com]</span><span class="p">:</span> <span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">:</span><span class="n">7480</span>

<span class="n">Use</span> <span class="s2">&quot;%(bucket)s.s3.amazonaws.com&quot;</span> <span class="n">to</span> <span class="n">the</span> <span class="n">target</span> <span class="n">Amazon</span> <span class="n">S3</span><span class="p">.</span> <span class="s2">&quot;%(bucket)s&quot;</span> <span class="n">and</span> <span class="s2">&quot;%(location)s&quot;</span> <span class="n">vars</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span>
<span class="k">if</span> <span class="n">the</span> <span class="n">target</span> <span class="n">S3</span> <span class="n">system</span> <span class="n">supports</span> <span class="n">dns</span> <span class="n">based</span> <span class="n">buckets</span><span class="p">.</span>
<span class="c"># 关于存储桶的定制，需要使用自己的域名，但是格式一样</span>
<span class="n">DNS-style</span> <span class="n">bucket</span><span class="p">+</span><span class="n">hostname</span><span class="p">:</span><span class="n">port</span> <span class="n">template</span> <span class="k">for</span> <span class="n">accessing</span> <span class="n">a</span> <span class="n">bucket</span> <span class="p">[%(</span><span class="n">bucket</span><span class="p">)</span><span class="n">s</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span><span class="p">]:</span> <span class="p">%(</span><span class="n">bucket</span><span class="p">)</span><span class="n">s</span><span class="p">.</span><span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">:</span><span class="n">7480</span>

<span class="n">Encryption</span> <span class="n">password</span> <span class="n">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">protect</span> <span class="n">your</span> <span class="n">files</span> <span class="n">from</span> <span class="n">reading</span>
<span class="n">by</span> <span class="n">unauthorized</span> <span class="n">persons</span> <span class="k">while</span> <span class="k">in</span> <span class="n">transfer</span> <span class="n">to</span> <span class="n">S3</span>
<span class="n">Encryption</span> <span class="n">password</span><span class="p">:</span>                        <span class="c"># 这里不需要密码</span>
<span class="n">Path</span> <span class="n">to</span> <span class="n">GPG</span> <span class="n">program</span> <span class="p">[/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">gpg</span><span class="p">]:</span>         <span class="c"># 使用默认的gpg命令路径</span>

<span class="n">When</span> <span class="n">using</span> <span class="n">secure</span> <span class="n">HTTPS</span> <span class="n">protocol</span> <span class="n">all</span> <span class="n">communication</span> <span class="n">with</span> <span class="n">Amazon</span> <span class="n">S3</span>
<span class="n">servers</span> <span class="n">is</span> <span class="n">protected</span> <span class="n">from</span> <span class="n">3rd</span> <span class="n">party</span> <span class="n">eavesdropping</span><span class="p">.</span> <span class="n">This</span> <span class="n">method</span> <span class="n">is</span>
<span class="n">slower</span> <span class="n">than</span> <span class="n">plain</span> <span class="n">HTTP</span><span class="p">,</span> <span class="n">and</span> <span class="n">can</span> <span class="n">only</span> <span class="n">be</span> <span class="n">proxied</span> <span class="n">with</span> <span class="n">Python</span> <span class="n">2</span><span class="p">.</span><span class="n">7</span> <span class="n">or</span> <span class="n">newer</span>
<span class="n">Use</span> <span class="n">HTTPS</span> <span class="n">protocol</span> <span class="no">[Yes]</span><span class="p">:</span> <span class="n">No</span>                <span class="c"># 不使用HTTPs协议</span>

<span class="n">On</span> <span class="n">some</span> <span class="n">networks</span> <span class="n">all</span> <span class="n">internet</span> <span class="n">access</span> <span class="n">must</span> <span class="n">go</span> <span class="n">through</span> <span class="n">a</span> <span class="n">HTTP</span> <span class="n">proxy</span><span class="p">.</span>
<span class="k">Try</span> <span class="n">setting</span> <span class="n">it</span> <span class="n">here</span> <span class="k">if</span> <span class="n">you</span> <span class="n">can</span><span class="s1">&#39;t connect to S3 directly</span>
<span class="s1">HTTP Proxy server name:                     # 不使用代理，因为是本地访问</span>

<span class="s1">New settings:</span>
<span class="s1">  Access Key: NOF182FGP8Q38CWLZ8WQ</span>
<span class="s1">  Secret Key: zP2ZWJPXTsZWQXg2hKY4Wv4OpoolKZEOwfheJlx3</span>
<span class="s1">  Default Region: US</span>
<span class="s1">  S3 Endpoint: stor04.superopsmsb.com:7480</span>
<span class="s1">  DNS-style bucket+hostname:port template for accessing a bucket: %(bucket)s.stor04.superopsmsb.com:7480</span>
<span class="s1">  Encryption password:</span>
<span class="s1">  Path to GPG program: /usr/bin/gpg</span>
<span class="s1">  Use HTTPS protocol: False</span>
<span class="s1">  HTTP Proxy server name:</span>
<span class="s1">  HTTP Proxy server port: 0</span>

<span class="s1">Test access with supplied credentials? [Y/n] Y      # 确认最后的信息</span>
<span class="s1">Please wait, attempting to list all buckets...</span>
<span class="s1">Success. Your access key and secret key worked fine :-)</span>

<span class="s1">Now verifying that encryption works...</span>
<span class="s1">Not configured. Never mind.</span>

<span class="s1">Save settings? [y/N] y                              # 保存信息</span>
<span class="s1">Configuration saved to &#39;</span><span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">s3cfg</span><span class="err">&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看常见的帮助信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd</span>
<span class="n">Usage</span><span class="p">:</span> <span class="n">s3cmd</span> <span class="no">[options] COMMAND [parameters]</span>
<span class="p">...</span>
<span class="n">Commands</span><span class="p">:</span>
  <span class="n">Make</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">mb</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">Remove</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">rb</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">List</span> <span class="n">objects</span> <span class="n">or</span> <span class="n">buckets</span>
      <span class="n">s3cmd</span> <span class="nb">ls </span><span class="p">[</span><span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span><span class="p">[/</span><span class="n">PREFIX</span><span class="p">]]</span>
  <span class="n">List</span> <span class="n">all</span> <span class="n">object</span> <span class="k">in</span> <span class="n">all</span> <span class="n">buckets</span>
      <span class="n">s3cmd</span> <span class="n">la</span>
  <span class="n">Put</span> <span class="n">file</span> <span class="n">into</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">put</span> <span class="n">FILE</span> <span class="no">[FILE...]</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span><span class="p">[/</span><span class="n">PREFIX</span><span class="p">]</span>
  <span class="n">Get</span> <span class="n">file</span> <span class="n">from</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">get</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span><span class="p">/</span><span class="n">OBJECT</span> <span class="n">LOCAL_FILE</span>
  <span class="n">Delete</span> <span class="n">file</span> <span class="n">from</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="nb">del </span><span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span><span class="p">/</span><span class="n">OBJECT</span>
  <span class="n">Delete</span> <span class="n">file</span> <span class="n">from</span> <span class="n">bucket</span> <span class="p">(</span><span class="k">alias</span> <span class="k">for</span> <span class="n">del</span><span class="p">)</span>
      <span class="n">s3cmd</span> <span class="nb">rm </span><span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span><span class="p">/</span><span class="n">OBJECT</span>
  <span class="n">Restore</span> <span class="n">file</span> <span class="n">from</span> <span class="n">Glacier</span> <span class="n">storage</span>
      <span class="n">s3cmd</span> <span class="n">restore</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span><span class="p">/</span><span class="n">OBJECT</span>
<span class="p">...</span>
</code></pre></div>
<p>域名解析</p>
<div class="highlight"><pre><span></span><code><span class="n">定制专属的dns域名</span><span class="err">，</span><span class="n">让客户端找到</span> <span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">主机名</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># cat /etc/resolv.conf</span>
<span class="c"># Generated by NetworkManager</span>
<span class="n">nameserver</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
      <span class="p">...</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># nslookup file.stor04.superopsmsb.com 10.0.0.12</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">file</span><span class="p">.</span><span class="n">stor04</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>
</code></pre></div>
<p>存储桶创建实践</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储桶</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd mb s3://images</span>
<span class="n">Bucket</span> <span class="s1">&#39;s3://images/&#39;</span> <span class="n">created</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd mb s3://dir</span>
<span class="n">Bucket</span> <span class="s1">&#39;s3://dir/&#39;</span> <span class="n">created</span>

<span class="n">查看存储桶</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">14</span><span class="p">:</span><span class="n">21</span>  <span class="n">s3</span><span class="p">://</span><span class="nb">dir</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">13</span><span class="p">:</span><span class="n">57</span>  <span class="n">s3</span><span class="p">://</span><span class="n">images</span>
</code></pre></div>
<p>文件上传下载实践</p>
<div class="highlight"><pre><span></span><code><span class="n">上传文件到存储桶中</span><span class="err">，</span><span class="n">存储同目录可以随意玩耍</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd put /etc/issue s3://images/linux/issue</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;/etc/issue&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://images/linux/issue&#39;</span>  <span class="p">[</span><span class="n">1</span> <span class="n">of</span> <span class="n">1</span><span class="p">]</span>
 <span class="n">23</span> <span class="n">of</span> <span class="n">23</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">1s</span>    <span class="n">12</span><span class="p">.</span><span class="n">79</span> <span class="n">B</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>

<span class="n">查看文件对象效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://images/linux</span>
                          <span class="nb">DIR </span> <span class="n">s3</span><span class="p">://</span><span class="n">images</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://images/linux/issue</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">13</span><span class="p">:</span><span class="n">58</span>           <span class="n">23</span>  <span class="n">s3</span><span class="p">://</span><span class="n">images</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">issue</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">下载文件对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd get s3://images/linux/issue</span>
<span class="n">download</span><span class="p">:</span> <span class="s1">&#39;s3://images/linux/issue&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;./issue&#39;</span>  <span class="p">[</span><span class="n">1</span> <span class="n">of</span> <span class="n">1</span><span class="p">]</span>
 <span class="n">23</span> <span class="n">of</span> <span class="n">23</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>     <span class="n">3</span><span class="p">.</span><span class="n">42</span> <span class="n">KB</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd get s3://images/linux/issue /tmp/issue-bak</span>
<span class="n">download</span><span class="p">:</span> <span class="s1">&#39;s3://images/linux/issue&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;/tmp/issue-bak&#39;</span>  <span class="p">[</span><span class="n">1</span> <span class="n">of</span> <span class="n">1</span><span class="p">]</span>
 <span class="n">23</span> <span class="n">of</span> <span class="n">23</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>     <span class="n">3</span><span class="p">.</span><span class="n">38</span> <span class="n">KB</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># ls</span>
<span class="n">anaconda-ks</span><span class="p">.</span><span class="n">cfg</span>  <span class="n">issue</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># ls /tmp/issue-bak</span>
<span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">issue-bak</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">对于一个大的RGW</span> <span class="n">Object</span><span class="err">，</span><span class="n">会被切割成多个独立的RGW</span> <span class="n">Object上传</span><span class="err">，</span><span class="n">称为multipart</span><span class="err">。</span><span class="n">multipar的优势是断点续传</span><span class="err">。</span><span class="n">s3接口默认切割大小为15MB</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># dd if=/dev/zero of=a.txt bs=1M count=60</span>
<span class="n">记录了60</span><span class="p">+</span><span class="n">0</span> <span class="n">的读入</span>
<span class="n">记录了60</span><span class="p">+</span><span class="n">0</span> <span class="n">的写出</span>
<span class="n">62914560字节</span><span class="p">(</span><span class="n">63</span> <span class="n">MB</span><span class="p">)</span><span class="n">已复制</span><span class="err">，</span><span class="n">0</span><span class="p">.</span><span class="n">0495739</span> <span class="n">秒</span><span class="err">，</span><span class="n">1</span><span class="p">.</span><span class="n">3</span> <span class="n">GB</span><span class="p">/</span><span class="n">秒</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># ll a.txt</span>
<span class="n">-rw-r</span><span class="p">-</span><span class="n">-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">62914560</span> <span class="n">9月</span>  <span class="n">27</span> <span class="n">11</span><span class="p">:</span><span class="n">06</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c">#  s3cmd put a.txt s3://images/linux/</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;a.txt&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://images/linux/a.txt&#39;</span>  <span class="no">[part 1 of 4, 15MB] [1 of 1]</span>
 <span class="n">15728640</span> <span class="n">of</span> <span class="n">15728640</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>    <span class="n">25</span><span class="p">.</span><span class="n">99</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;a.txt&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://images/linux/a.txt&#39;</span>  <span class="no">[part 2 of 4, 15MB] [1 of 1]</span>
 <span class="n">15728640</span> <span class="n">of</span> <span class="n">15728640</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>    <span class="n">27</span><span class="p">.</span><span class="n">90</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;a.txt&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://images/linux/a.txt&#39;</span>  <span class="no">[part 3 of 4, 15MB] [1 of 1]</span>
 <span class="n">15728640</span> <span class="n">of</span> <span class="n">15728640</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>    <span class="n">28</span><span class="p">.</span><span class="n">93</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;a.txt&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://images/linux/a.txt&#39;</span>  <span class="no">[part 4 of 4, 15MB] [1 of 1]</span>
 <span class="n">15728640</span> <span class="n">of</span> <span class="n">15728640</span>   <span class="n">100</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>    <span class="n">31</span><span class="p">.</span><span class="n">85</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
</code></pre></div>
<p>目录上传下载实践</p>
<div class="highlight"><pre><span></span><code><span class="n">准备目录结构</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># mkdir /data/test/{scripts,conf,file} -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># touch /data/test/{scripts/{1..4}.sh,conf/{1..3}.conf,file/{1..5}.txt}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># echo scripts-1 &gt; /data/test/scripts/1.sh</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># echo conf-2 &gt; /data/test/conf/2.conf</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># echo file-5 &gt; /data/test/file/5.txt</span>

<span class="n">上传目录</span> 
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd put /data/test/ s3://dir/etc/ --recursive</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;/data/test/conf/1.conf&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://dir/etc/conf/1.conf&#39;</span>  <span class="p">[</span><span class="n">1</span> <span class="n">of</span> <span class="n">12</span><span class="p">]</span>
 <span class="n">0</span> <span class="n">of</span> <span class="n">0</span>     <span class="n">0</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>     <span class="n">0</span><span class="p">.</span><span class="n">00</span> <span class="n">B</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="p">...</span>
<span class="n">upload</span><span class="p">:</span> <span class="s1">&#39;/data/test/scripts/4.sh&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;s3://dir/etc/scripts/4.sh&#39;</span>  <span class="p">[</span><span class="n">12</span> <span class="n">of</span> <span class="n">12</span><span class="p">]</span>
 <span class="n">0</span> <span class="n">of</span> <span class="n">0</span>     <span class="n">0</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>     <span class="n">0</span><span class="p">.</span><span class="n">00</span> <span class="n">B</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://dir</span>
                          <span class="nb">DIR </span> <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://dir/etc              # 查看目录的时候，必须在最后添加/</span>
                          <span class="nb">DIR </span> <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://dir/etc/</span>
                          <span class="nb">DIR </span> <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span>
                          <span class="nb">DIR </span> <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">file</span><span class="p">/</span>
                          <span class="nb">DIR </span> <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://dir/etc/conf/</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">14</span><span class="p">:</span><span class="n">23</span>            <span class="n">0</span>  <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">conf</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">14</span><span class="p">:</span><span class="n">23</span>            <span class="n">7</span>  <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">2</span><span class="p">.</span><span class="n">conf</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26</span> <span class="n">14</span><span class="p">:</span><span class="n">23</span>            <span class="n">0</span>  <span class="n">s3</span><span class="p">://</span><span class="n">dir</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">3</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">下载目录对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd get s3://dir/  --recursive</span>
<span class="n">download</span><span class="p">:</span> <span class="s1">&#39;s3://dir/etc/conf/1.conf&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;./etc/conf/1.conf&#39;</span>  <span class="p">[</span><span class="n">1</span> <span class="n">of</span> <span class="n">12</span><span class="p">]</span>
 <span class="n">0</span> <span class="n">of</span> <span class="n">0</span>     <span class="n">0</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>     <span class="n">0</span><span class="p">.</span><span class="n">00</span> <span class="n">B</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="p">...</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">如果按照上传目录结构方式下载文件的时候</span><span class="err">，</span><span class="n">不要加子目录</span><span class="err">，</span>

<span class="n">下载子目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd get s3://dir/etc/  --recursive</span>
<span class="n">download</span><span class="p">:</span> <span class="s1">&#39;s3://dir/etc/conf/1.conf&#39;</span> <span class="p">-&gt;</span> <span class="s1">&#39;./conf/1.conf&#39;</span>  <span class="p">[</span><span class="n">1</span> <span class="n">of</span> <span class="n">12</span><span class="p">]</span>
 <span class="n">0</span> <span class="n">of</span> <span class="n">0</span>     <span class="n">0</span><span class="p">%</span> <span class="k">in</span>    <span class="n">0s</span>     <span class="n">0</span><span class="p">.</span><span class="n">00</span> <span class="n">B</span><span class="p">/</span><span class="n">s</span>  <span class="n">done</span>
<span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">它是将子目录下载到当前目录了</span>
</code></pre></div>
<p>文件删除</p>
<div class="highlight"><pre><span></span><code><span class="n">删除文件文件对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd del s3://images/linux/issue</span>
<span class="n">delete</span><span class="p">:</span> <span class="s1">&#39;s3://images/linux/issue&#39;</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://images/linux/issue</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c">#</span>

<span class="n">删除目录对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd del s3://images/linux/issue</span>
<span class="n">delete</span><span class="p">:</span> <span class="s1">&#39;s3://images/linux/issue&#39;</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd del s3://dir/etc/  --recursive</span>
<span class="n">delete</span><span class="p">:</span> <span class="s1">&#39;s3://dir/etc/conf/1.conf&#39;</span>
<span class="p">...</span>
<span class="n">delete</span><span class="p">:</span> <span class="s1">&#39;s3://dir/etc/scripts/4.sh&#39;</span>

<span class="n">删除存储桶</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd rb  s3://images</span>
<span class="n">Bucket</span> <span class="s1">&#39;s3://images/&#39;</span> <span class="n">removed</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd rb  s3://dir</span>
<span class="n">Bucket</span> <span class="s1">&#39;s3://dir/&#39;</span> <span class="n">removed</span>
</code></pre></div>
<p>python测试</p>
<div class="highlight"><pre><span></span><code><span class="n">安装测试模块</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># yum -y install python-boto</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制测试脚本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># cat /data/scripts/tests3.py</span>
<span class="n">import</span> <span class="n">boto</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">connection</span>

<span class="n">access_key</span> <span class="p">=</span> <span class="s1">&#39;BX2IDCO5ADZ8IWZ4AVX7&#39;</span>
<span class="n">secret_key</span> <span class="p">=</span> <span class="s1">&#39;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&#39;</span>
<span class="n">conn</span> <span class="p">=</span> <span class="n">boto</span><span class="p">.</span><span class="n">connect_s3</span><span class="p">(</span>
        <span class="n">aws_access_key_id</span><span class="p">=</span><span class="n">access_key</span><span class="p">,</span>
        <span class="n">aws_secret_access_key</span><span class="p">=</span><span class="n">secret_key</span><span class="p">,</span>
        <span class="n">host</span><span class="p">=</span><span class="s1">&#39;10.0.0.16&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">=</span><span class="n">7480</span><span class="p">,</span>
        <span class="n">is_secure</span><span class="p">=</span><span class="n">False</span><span class="p">,</span> <span class="n">calling_format</span><span class="p">=</span><span class="n">boto</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">OrdinaryCallingFormat</span><span class="p">(),</span>
       <span class="p">)</span>

<span class="n">bucket</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="s1">&#39;ceph-s3-bucket&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bucket</span> <span class="k">in</span> <span class="n">conn</span><span class="p">.</span><span class="n">get_all_buckets</span><span class="p">():</span>
    <span class="n">print</span> <span class="s2">&quot;{name} {created}&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">name</span><span class="p">=</span><span class="n">bucket</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">created</span><span class="p">=</span><span class="n">bucket</span><span class="p">.</span><span class="n">creation_date</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># python /data/scripts/tests3.py</span>
<span class="n">ceph-s3-bucket</span> <span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">26T14</span><span class="p">:</span><span class="n">41</span><span class="p">:</span><span class="n">42</span><span class="p">.</span><span class="n">505Z</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="135_swift">1.3.5 Swift测试<a class="headerlink" href="#135_swift" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>Swift API接口简介</p>
<div class="highlight"><pre><span></span><code><span class="n">Swift的用户账号对应于radosgw中的subuser</span><span class="err">（</span><span class="n">子用户</span><span class="err">），</span><span class="n">它隶属于某个事先存在的user</span><span class="err">（</span><span class="n">用户账号</span><span class="err">）</span>
    <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">create</span> <span class="p">-</span><span class="n">-uid</span><span class="p">=</span><span class="s2">&quot;swiftuser&quot;</span> <span class="p">-</span><span class="n">-display-name</span><span class="p">=</span><span class="s2">&quot;Swift Testing User&quot;</span>
    <span class="n">radosgw-admin</span> <span class="n">subuser</span> <span class="n">create</span> <span class="p">-</span><span class="n">-uid</span><span class="p">=</span><span class="n">swiftuser</span> <span class="p">-</span><span class="n">-subuser</span><span class="p">=</span><span class="n">swiftuser</span><span class="p">:</span><span class="n">swift</span> <span class="p">-</span><span class="n">-access</span><span class="p">=</span><span class="n">full</span>

<span class="n">Swift</span> <span class="n">API的上下文中</span><span class="err">，</span><span class="n">存储桶以container表示</span><span class="err">，</span><span class="n">而非S3中的bucket</span><span class="err">，</span><span class="n">但二者在功用上类同</span><span class="err">，</span><span class="n">都是对象数据的容器</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Python</span> <span class="n">Swiftclient是一个用于与Swift</span> <span class="n">API交互的Python客户端程序</span><span class="err">，</span><span class="n">它包含了Python</span> <span class="n">API</span><span class="err">（</span><span class="n">swift</span> <span class="n">模块</span><span class="err">）</span><span class="n">和一个命令行工具swift</span><span class="p">.</span>
    <span class="n">环境安装如下</span>
    <span class="n">pip</span> <span class="n">instal</span> <span class="p">-</span><span class="n">-upgrade</span> <span class="n">python-swiftclient</span>

<span class="n">swift命令可以通过Swift</span> <span class="n">API完成容器和对象数据的管理操作</span><span class="err">，</span><span class="n">其基础语法格式为</span><span class="err">“</span>
    <span class="n">swift</span> <span class="p">[</span><span class="n">-A</span> <span class="n">Auth</span> <span class="n">URL</span><span class="p">]</span> <span class="p">[</span><span class="n">-U</span> <span class="n">username</span><span class="p">]</span> <span class="p">[</span><span class="n">-K</span> <span class="n">password</span><span class="p">]</span> <span class="n">subcommand</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>用户创建</p>
<div class="highlight"><pre><span></span><code><span class="n">swift的实践用户</span><span class="err">，</span><span class="n">我们直接使用上面s3创建的用户来创建</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">list</span>
<span class="p">[</span>
    <span class="s2">&quot;s3user&quot;</span>
<span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">基于s3user用户创建swift拥有所有权限的用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">subuser</span> <span class="n">create</span> <span class="p">-</span><span class="n">-uid</span> <span class="n">s3user</span> <span class="p">-</span><span class="n">-subuser</span><span class="p">=</span><span class="n">s3user</span><span class="p">:</span><span class="n">swift</span> <span class="p">-</span><span class="n">-access</span><span class="p">=</span><span class="n">full</span>
<span class="p">{</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;subusers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user:swift&quot;</span><span class="p">,</span>
            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;full-control&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;swift_keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user:swift&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;pZ5DGT3YDBqdAtb10aFiNGeO2AtJKJN4rLKuI4wU&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">生成</span> <span class="n">s3user</span><span class="p">:</span><span class="n">swift</span> <span class="n">对应的secret_key</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">key</span> <span class="n">create</span> <span class="p">-</span><span class="n">-subuser</span><span class="p">=</span><span class="n">s3user</span><span class="p">:</span><span class="n">swift</span> <span class="p">-</span><span class="n">-key-type</span><span class="p">=</span><span class="n">swift</span> <span class="p">-</span><span class="n">-gen-secret</span>
<span class="p">{</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;S3 Testing user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;suspended&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
    <span class="s2">&quot;max_buckets&quot;</span><span class="p">:</span> <span class="n">1000</span><span class="p">,</span>
    <span class="s2">&quot;subusers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user:swift&quot;</span><span class="p">,</span>
            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;full-control&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;swift_keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;s3user:swift&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>客户端环境</p>
<div class="highlight"><pre><span></span><code><span class="n">安装swift命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># yum -y install python-setuptools python-pip</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># pip install python-swiftclient==3.4.0</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">如果需要安装最新版本的话</span><span class="err">，</span><span class="n">需要提前将Python版本提升到3</span><span class="p">.</span><span class="n">6</span><span class="p">+</span>
    <span class="n">https</span><span class="p">://</span><span class="n">pypi</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">project</span><span class="p">/</span><span class="n">python-swiftclient</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">命令解析</span><span class="err">：</span>
    <span class="n">swift</span> <span class="n">-A</span> <span class="n">认证URL</span><span class="p">/</span><span class="n">auth</span> <span class="n">-U</span> <span class="n">用户名称</span><span class="p">:</span><span class="n">swift</span> <span class="n">-K</span> <span class="n">secret_key</span> <span class="n">命令</span>

<span class="n">命令测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift -A http://10.0.0.16:7480/auth -U s3user:swift -K O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04 list</span>
<span class="n">ceph-s3-bucket</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">配置环境变量</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="p">~/.</span><span class="n">swift</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">export</span> <span class="n">ST_AUTH</span><span class="p">=</span><span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="p">:</span><span class="n">7480</span><span class="p">/</span><span class="n">auth</span>
<span class="n">export</span> <span class="n">ST_USER</span><span class="p">=</span><span class="n">s3user</span><span class="p">:</span><span class="n">swift</span>
<span class="n">export</span> <span class="n">ST_KEY</span><span class="p">=</span><span class="n">O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">加载环境变量</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># source ~/.swift</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift list</span>
<span class="n">ceph-s3-bucket</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看状态信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift stat</span>
                                    <span class="n">Account</span><span class="p">:</span> <span class="n">v1</span>
                                 <span class="n">Containers</span><span class="p">:</span> <span class="n">2</span>
                                    <span class="n">Objects</span><span class="p">:</span> <span class="n">1</span>
                                      <span class="n">Bytes</span><span class="p">:</span> <span class="n">23</span>
<span class="n">Objects</span> <span class="k">in</span> <span class="n">policy</span> <span class="s2">&quot;default-placement-bytes&quot;</span><span class="p">:</span> <span class="n">0</span>
  <span class="n">Bytes</span> <span class="k">in</span> <span class="n">policy</span> <span class="s2">&quot;default-placement-bytes&quot;</span><span class="p">:</span> <span class="n">0</span>
   <span class="n">Containers</span> <span class="k">in</span> <span class="n">policy</span> <span class="s2">&quot;default-placement&quot;</span><span class="p">:</span> <span class="n">2</span>
      <span class="n">Objects</span> <span class="k">in</span> <span class="n">policy</span> <span class="s2">&quot;default-placement&quot;</span><span class="p">:</span> <span class="n">1</span>
        <span class="n">Bytes</span> <span class="k">in</span> <span class="n">policy</span> <span class="s2">&quot;default-placement&quot;</span><span class="p">:</span> <span class="n">23</span>
                     <span class="n">X-Openstack-Request-Id</span><span class="p">:</span> <span class="n">tx00000000000000000012c</span><span class="p">-</span><span class="n">0063324b45</span><span class="p">-</span><span class="n">63ad-default</span>
                <span class="n">X-Account-Bytes-Used-Actual</span><span class="p">:</span> <span class="n">4096</span>
                                 <span class="n">X-Trans-Id</span><span class="p">:</span> <span class="n">tx00000000000000000012c</span><span class="p">-</span><span class="n">0063324b45</span><span class="p">-</span><span class="n">63ad-default</span>
                                <span class="n">X-Timestamp</span><span class="p">:</span> <span class="n">1664240453</span><span class="p">.</span><span class="n">17581</span>
                               <span class="n">Content-Type</span><span class="p">:</span> <span class="n">text</span><span class="p">/</span><span class="n">plain</span><span class="p">;</span> <span class="n">charset</span><span class="p">=</span><span class="n">utf</span><span class="p">-</span><span class="n">8</span>
                              <span class="n">Accept-Ranges</span><span class="p">:</span> <span class="n">bytes</span>
</code></pre></div>
<p>存储桶增删测试</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储桶</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift post swift-super</span>

<span class="n">删除存储桶</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift delete ceph-s3-bucket</span>
<span class="n">ceph-s3-bucket</span>

<span class="n">查看存储桶</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift list</span>
<span class="n">swift-super</span>
</code></pre></div>
<p>文件上传操作</p>
<div class="highlight"><pre><span></span><code><span class="n">上传文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift upload swift-super /etc/passwd</span>
<span class="n">etc</span><span class="p">/</span><span class="n">passwd</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift list swift-super</span>
<span class="n">etc</span><span class="p">/</span><span class="n">passwd</span>
</code></pre></div>
<p>目录上传操作</p>
<div class="highlight"><pre><span></span><code><span class="n">上传目录操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift upload swift-super /data/test</span>
<span class="n">data</span><span class="p">/</span><span class="n">test</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">4</span><span class="p">.</span><span class="n">sh</span>
<span class="p">...</span>
<span class="n">data</span><span class="p">/</span><span class="n">test</span><span class="p">/</span><span class="n">file</span><span class="p">/</span><span class="n">3</span><span class="p">.</span><span class="n">txt</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift list swift-super</span>
<span class="n">data</span><span class="p">/</span><span class="n">test</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>
<span class="n">etc</span><span class="p">/</span><span class="n">passwd</span>
</code></pre></div>
<p>文件下载操作</p>
<div class="highlight"><pre><span></span><code><span class="n">下载文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift download swift-super etc/passwd</span>
<span class="n">etc</span><span class="p">/</span><span class="n">passwd</span> <span class="p">[</span><span class="n">auth</span> <span class="n">0</span><span class="p">.</span><span class="n">014s</span><span class="p">,</span> <span class="n">headers</span> <span class="n">0</span><span class="p">.</span><span class="n">023s</span><span class="p">,</span> <span class="n">total</span> <span class="n">0</span><span class="p">.</span><span class="n">024s</span><span class="p">,</span> <span class="n">0</span><span class="p">.</span><span class="n">120</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span><span class="p">]</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># ls etc/passwd</span>
<span class="n">etc</span><span class="p">/</span><span class="n">passwd</span>

<span class="n">下载所有</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift download --all</span>
<span class="n">swift-super</span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">test</span><span class="p">/</span><span class="n">file</span><span class="p">/</span><span class="n">4</span><span class="p">.</span><span class="n">txt</span> <span class="p">[</span><span class="n">auth</span> <span class="n">0</span><span class="p">.</span><span class="n">008s</span><span class="p">,</span> <span class="n">headers</span> <span class="n">0</span><span class="p">.</span><span class="n">019s</span><span class="p">,</span> <span class="n">total</span> <span class="n">0</span><span class="p">.</span><span class="n">019s</span><span class="p">,</span> <span class="n">0</span><span class="p">.</span><span class="n">000</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span><span class="p">]</span>
<span class="p">...</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">它对于目录的递归下载不是太友好</span>
</code></pre></div>
<p>文件删除操作</p>
<div class="highlight"><pre><span></span><code><span class="n">删除文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift delete swift-super etc/passwd</span>
<span class="n">etc</span><span class="p">/</span><span class="n">passwd</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">它不支持目录删除</span><span class="err">，</span><span class="n">但是可以通过批量删除来实现</span>

<span class="n">批量删除</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift delete swift-super --prefix=data</span>
<span class="n">data</span><span class="p">/</span><span class="n">test</span><span class="p">/</span><span class="n">file</span><span class="p">/</span><span class="n">4</span><span class="p">.</span><span class="n">txt</span>
<span class="p">...</span>
<span class="n">data</span><span class="p">/</span><span class="n">test</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">sh</span>

<span class="n">批量删除</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># swift delete swift-super --all</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="136">1.3.6 对象访问<a class="headerlink" href="#136" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">作为OSS对象存储</span><span class="err">，</span><span class="n">我们可以在互联网上以http</span><span class="p">(</span><span class="n">s</span><span class="p">)://</span> <span class="n">的方式来访问对象文件</span><span class="err">，</span><span class="n">基本格式如下</span><span class="err">：</span>
    <span class="n">对于存储在rgw01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com上的S3</span> <span class="n">API对象存储系统上bucket存储桶中的名为images</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">jpg</span> <span class="n">的对象</span><span class="err">，</span><span class="n">可通过</span> <span class="n">http</span><span class="p">://</span><span class="n">bucket</span><span class="p">.</span><span class="n">rgw01</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">images</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">jpg对其进行访问</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">默认情况下</span><span class="err">，</span><span class="n">这种情况是拒绝的</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># s3cmd ls s3://images/linux/issue</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">27</span> <span class="n">00</span><span class="p">:</span><span class="n">49</span>           <span class="n">23</span>  <span class="n">s3</span><span class="p">://</span><span class="n">images</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">issue</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># curl http://images.stor04.superopsmsb.com:7480/linux/issue</span>
<span class="p">&lt;</span><span class="k">?</span><span class="n">xml</span> <span class="n">version</span><span class="p">=</span><span class="s2">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="p">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">?&gt;&lt;</span><span class="n">Error</span><span class="p">&gt;&lt;</span><span class="n">Code</span><span class="p">&gt;</span><span class="n">AccessDenied</span><span class="p">&lt;/</span><span class="n">Code</span><span class="p">&gt;&lt;</span><span class="n">BucketName</span><span class="p">&gt;</span><span class="n">images</span><span class="p">&lt;/</span><span class="n">BucketName</span><span class="p">&gt;&lt;</span><span class="n">RequestId</span><span class="p">&gt;</span><span class="n">tx00000000000000000012f</span><span class="p">-</span><span class="n">0063324d15</span><span class="p">-</span><span class="n">63ad-default</span><span class="p">&lt;/</span><span class="n">RequestId</span><span class="p">&gt;&lt;</span><span class="n">HostId</span><span class="p">&gt;</span><span class="n">63ad-default-default</span><span class="p">&lt;/</span><span class="n">HostId</span><span class="p">&gt;&lt;/</span><span class="n">Error</span><span class="p">&gt;</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">这里拒绝的原因就是</span> <span class="n">AccessDenied</span><span class="err">，</span><span class="n">是需要我们通过专用的访问策略方式来进行功能实现</span><span class="err">。</span>
</code></pre></div>
<p>解析</p>
<div class="highlight"><pre><span></span><code><span class="n">在使用http方式访问对象存储的时候</span><span class="err">，</span><span class="n">我们需要注意的是</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">资源对象的访问方式</span>
        <span class="n">http</span> <span class="n">还是</span> <span class="n">https</span><span class="err">，</span><span class="n">依赖于rgw的基本配置</span>
    <span class="n">2</span> <span class="n">资源对象的访问控制</span>
        <span class="n">通过定制策略的方式来实现</span>
    <span class="n">3</span> <span class="n">资源对象的跨域问题</span>
        <span class="n">通过定制cors的方式来实现</span>
    <span class="n">4</span> <span class="n">资源对象在浏览器端的缓存机制</span>
        <span class="n">rgw的基本配置定制</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">radosgw</span><span class="p">/</span><span class="n">bucketpolicy</span><span class="p">/</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">radosgw</span><span class="p">/</span><span class="n">s3</span><span class="p">/</span><span class="n">python</span><span class="p">/</span>
</code></pre></div>
<p>命令解析</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># s3cmd --help</span>
<span class="n">Usage</span><span class="p">:</span> <span class="n">s3cmd</span> <span class="no">[options] COMMAND [parameters]</span>
<span class="p">...</span>
  <span class="n">Modify</span> <span class="n">Bucket</span> <span class="n">Policy</span>
      <span class="n">s3cmd</span> <span class="n">setpolicy</span> <span class="n">FILE</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">Delete</span> <span class="n">Bucket</span> <span class="n">Policy</span>
      <span class="n">s3cmd</span> <span class="n">delpolicy</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">Modify</span> <span class="n">Bucket</span> <span class="n">CORS</span>
      <span class="n">s3cmd</span> <span class="n">setcors</span> <span class="n">FILE</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">Delete</span> <span class="n">Bucket</span> <span class="n">CORS</span>
      <span class="n">s3cmd</span> <span class="n">delcors</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="p">...</span>
  <span class="n">Upload</span> <span class="n">a</span> <span class="n">lifecycle</span> <span class="n">policy</span> <span class="k">for</span> <span class="n">the</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">setlifecycle</span> <span class="n">FILE</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">Get</span> <span class="n">a</span> <span class="n">lifecycle</span> <span class="n">policy</span> <span class="k">for</span> <span class="n">the</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">getlifecycle</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="n">Remove</span> <span class="n">a</span> <span class="n">lifecycle</span> <span class="n">policy</span> <span class="k">for</span> <span class="n">the</span> <span class="n">bucket</span>
      <span class="n">s3cmd</span> <span class="n">dellifecycle</span> <span class="n">s3</span><span class="p">://</span><span class="n">BUCKET</span>
  <span class="p">...</span>
</code></pre></div>
<p>查看默认策略</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># s3cmd info s3://swift-super</span>
<span class="n">s3</span><span class="p">://</span><span class="n">swift-super</span><span class="p">/</span> <span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
   <span class="n">Location</span><span class="p">:</span>  <span class="k">default</span>
   <span class="n">Payer</span><span class="p">:</span>     <span class="n">BucketOwner</span>
   <span class="n">Expiration</span> <span class="n">Rule</span><span class="p">:</span> <span class="n">none</span>
   <span class="n">Policy</span><span class="p">:</span>    <span class="n">none</span>
   <span class="n">CORS</span><span class="p">:</span>      <span class="n">none</span>
   <span class="n">ACL</span><span class="p">:</span>       <span class="n">S3</span> <span class="n">Testing</span> <span class="n">user</span><span class="p">:</span> <span class="n">FULL_CONTROL</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>定制策略</p>
<div class="highlight"><pre><span></span><code><span class="n">定制访问策略文件</span> <span class="nb">cat </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">policy</span><span class="p">.</span><span class="n">json</span>
<span class="p">{</span>
        <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;s3:GetObject&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
        <span class="p">}]</span>
<span class="p">}</span>
<span class="n">属性解析</span><span class="err">：</span>
    <span class="n">Resource参数匹配某一种文件</span><span class="err">：</span><span class="n">Resource</span><span class="p">:[</span><span class="s2">&quot;*.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;*.png&quot;</span><span class="p">]</span>
    <span class="n">Action可以设置较多参数</span><span class="err">，</span>
<span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">master</span><span class="p">/</span><span class="n">radosgw</span><span class="p">/</span><span class="n">bucketpolicy</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用访问策略</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># s3cmd setpolicy policy.json s3://images --acl-public</span>
<span class="n">s3</span><span class="p">://</span><span class="n">images</span><span class="p">/:</span> <span class="n">Policy</span> <span class="n">updated</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># s3cmd info s3://images</span>
<span class="n">s3</span><span class="p">://</span><span class="n">images</span><span class="p">/</span> <span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
   <span class="n">Location</span><span class="p">:</span>  <span class="k">default</span>
   <span class="n">Payer</span><span class="p">:</span>     <span class="n">BucketOwner</span>
   <span class="n">Expiration</span> <span class="n">Rule</span><span class="p">:</span> <span class="n">none</span>
   <span class="n">Policy</span><span class="p">:</span>    <span class="p">{</span>
        <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;s3:GetObject&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
        <span class="p">}]</span>
<span class="p">}</span>

   <span class="n">CORS</span><span class="p">:</span>      <span class="n">none</span>
   <span class="n">ACL</span><span class="p">:</span>       <span class="n">S3</span> <span class="n">Testing</span> <span class="n">user</span><span class="p">:</span> <span class="n">FULL_CONTROL</span>
</code></pre></div>
<p>设置访问限制</p>
<div class="highlight"><pre><span></span><code><span class="n">定制cors的策略文件</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">/</span><span class="n">rules</span><span class="p">.</span><span class="n">xml</span> 
<span class="p">&lt;</span><span class="n">CORSConfiguration</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">CORSRule</span><span class="p">&gt;</span> 
    <span class="p">&lt;</span><span class="n">ID</span><span class="p">&gt;</span><span class="n">Allow</span> <span class="n">everything</span><span class="p">&lt;/</span><span class="n">ID</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedOrigin</span><span class="p">&gt;*&lt;/</span><span class="n">AllowedOrigin</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedMethod</span><span class="p">&gt;</span><span class="n">GET</span><span class="p">&lt;/</span><span class="n">AllowedMethod</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedMethod</span><span class="p">&gt;</span><span class="n">HEAD</span><span class="p">&lt;/</span><span class="n">AllowedMethod</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedMethod</span><span class="p">&gt;</span><span class="n">PUT</span><span class="p">&lt;/</span><span class="n">AllowedMethod</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedMethod</span><span class="p">&gt;</span><span class="n">POST</span><span class="p">&lt;/</span><span class="n">AllowedMethod</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedMethod</span><span class="p">&gt;</span><span class="n">DELETE</span><span class="p">&lt;/</span><span class="n">AllowedMethod</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">AllowedHeader</span><span class="p">&gt;*&lt;/</span><span class="n">AllowedHeader</span><span class="p">&gt;</span>  
    <span class="p">&lt;</span><span class="n">MaxAgeSeconds</span><span class="p">&gt;</span><span class="n">30</span><span class="p">&lt;/</span><span class="n">MaxAgeSeconds</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="n">CORSRule</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">CORSConfiguration</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用浏览器跨域设置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># s3cmd setcors rules.xml s3://images</span>
<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># s3cmd info s3://images</span>
<span class="n">s3</span><span class="p">://</span><span class="n">images</span><span class="p">/</span> <span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
   <span class="n">Location</span><span class="p">:</span>  <span class="k">default</span>
   <span class="n">Payer</span><span class="p">:</span>     <span class="n">BucketOwner</span>
   <span class="n">Expiration</span> <span class="n">Rule</span><span class="p">:</span> <span class="n">none</span>
   <span class="n">Policy</span><span class="p">:</span>    <span class="p">{</span>
        <span class="p">...</span>
<span class="p">}</span>

   <span class="n">CORS</span><span class="p">:</span>      <span class="p">&lt;</span><span class="n">CORSConfiguration</span> <span class="n">xmlns</span><span class="p">=...&lt;/</span><span class="n">CORSConfiguration</span><span class="p">&gt;</span>
   <span class="n">ACL</span><span class="p">:</span>       <span class="n">S3</span> <span class="n">Testing</span> <span class="n">user</span><span class="p">:</span> <span class="n">FULL_CONTROL</span>
</code></pre></div>
<p>访问效果</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">conf</span><span class="p">]</span><span class="c"># curl http://images.stor04.superopsmsb.com:7480/linux/issue</span>
<span class="p">\</span><span class="n">S</span>
<span class="n">Kernel</span> <span class="p">\</span><span class="nb">r </span><span class="n">on</span> <span class="n">an</span> <span class="p">\</span><span class="n">m</span>
</code></pre></div>
<p>脚本测试</p>
<div class="highlight"><pre><span></span><code><span class="n">定制访问测试脚本</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">tests4</span><span class="p">.</span><span class="n">py</span>
<span class="n">import</span> <span class="n">boto</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">connection</span>

<span class="n">access_key</span> <span class="p">=</span> <span class="s1">&#39;BX2IDCO5ADZ8IWZ4AVX7&#39;</span>
<span class="n">secret_key</span> <span class="p">=</span> <span class="s1">&#39;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&#39;</span>
<span class="n">conn</span> <span class="p">=</span> <span class="n">boto</span><span class="p">.</span><span class="n">connect_s3</span><span class="p">(</span>
        <span class="n">aws_access_key_id</span><span class="p">=</span><span class="n">access_key</span><span class="p">,</span>
        <span class="n">aws_secret_access_key</span><span class="p">=</span><span class="n">secret_key</span><span class="p">,</span>
        <span class="n">host</span><span class="p">=</span><span class="s1">&#39;10.0.0.16&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">=</span><span class="n">7480</span><span class="p">,</span>
        <span class="n">is_secure</span><span class="p">=</span><span class="n">False</span><span class="p">,</span> <span class="n">calling_format</span><span class="p">=</span><span class="n">boto</span><span class="p">.</span><span class="n">s3</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">OrdinaryCallingFormat</span><span class="p">(),</span>
       <span class="p">)</span>
<span class="n">def</span> <span class="n">get_object_url</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">object_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">plans_key</span> <span class="p">=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="n">plans_url</span> <span class="p">=</span> <span class="n">plans_key</span><span class="p">.</span><span class="n">generate_url</span><span class="p">(</span><span class="n">0</span><span class="p">,</span> <span class="n">query_auth</span><span class="p">=</span><span class="n">False</span><span class="p">,</span>
                                           <span class="n">force_http</span><span class="p">=</span><span class="n">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plans_url</span>
    <span class="n">except</span> <span class="n">Exception</span> <span class="n">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print</span><span class="p">(</span><span class="s2">&quot;get {} error:{}&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">False</span>
<span class="n">print</span><span class="p">(</span><span class="n">get_object_url</span><span class="p">(</span><span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="s2">&quot;linux/issue&quot;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取资源对象的url效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># python tests4.py</span>
<span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="p">:</span><span class="n">7480</span><span class="p">/</span><span class="n">images</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">issue</span><span class="k">?</span><span class="n">x-amz-meta-s3cmd-attrs</span><span class="p">=</span><span class="n">atime</span><span class="k">%</span><span class="n">3A1664200700</span><span class="p">/</span><span class="n">ctime</span><span class="k">%</span><span class="n">3A1654585109</span><span class="p">/</span><span class="n">gid</span><span class="k">%</span><span class="n">3A0</span><span class="p">/</span><span class="n">gname</span><span class="k">%</span><span class="n">3Aroot</span><span class="p">/</span><span class="n">md5</span><span class="k">%</span><span class="n">3Af078fe086dfc22f64b5dca2e1b95de2c</span><span class="p">/</span><span class="n">mode</span><span class="k">%</span><span class="n">3A33188</span><span class="p">/</span><span class="n">mtime</span><span class="k">%</span><span class="n">3A1603464839</span><span class="p">/</span><span class="n">uid</span><span class="k">%</span><span class="n">3A0</span><span class="p">/</span><span class="n">uname</span><span class="k">%</span><span class="n">3Aroot</span>
<span class="n">访问url的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># curl http://10.0.0.16:7480/images/linux/issue?x-amz-meta-s3cmd-attrs=atime%3A1664200700/ctime%3A1654585109/gid%3A0/gname%3Aroot/md5%3Af078fe086dfc22f64b5dca2e1b95de2c/mode%3A33188/mtime%3A1603464839/uid%3A0/uname%3Aroot</span>
<span class="p">\</span><span class="n">S</span>
<span class="n">Kernel</span> <span class="p">\</span><span class="nb">r </span><span class="n">on</span> <span class="n">an</span> <span class="p">\</span><span class="n">m</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="137">1.3.7 底层数据<a class="headerlink" href="#137" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">RGW是一个对象处理网关</span><span class="err">。</span><span class="n">数据实际存储在ceph集群中</span><span class="err">。</span><span class="n">利用librados的接口</span><span class="err">，</span><span class="n">与ceph集群通信</span><span class="err">。</span><span class="n">RGW主要存储三类数据</span><span class="err">：</span><span class="n">元数据</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span><span class="err">、</span><span class="n">索引数据</span><span class="p">(</span><span class="n">bucket</span> <span class="n">index</span><span class="p">)</span><span class="err">、</span><span class="n">数据</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">元数据信息</span><span class="err">：</span><span class="n">包括user</span><span class="p">(</span><span class="n">用户信息</span><span class="p">)</span><span class="err">，</span><span class="n">bucket</span><span class="p">(</span><span class="n">存储桶关系</span><span class="p">)</span><span class="err">，</span><span class="n">bucket</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="n">存储桶实例</span><span class="p">)</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">索引数据信息</span><span class="p">:</span> <span class="n">主要k</span><span class="p">/</span><span class="n">v的结构来维护bucket中rgw对象的索引信息</span><span class="err">，</span><span class="n">val是关于rgw对象的元数据信息</span>
    <span class="p">-</span> <span class="n">数据信息</span><span class="p">:</span> <span class="n">其实就是rgw</span> <span class="n">object内容</span><span class="err">，</span><span class="n">它存放在一个或多个rados</span> <span class="n">object中</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">这三类数据一般存储在不同的pool中</span><span class="err">，</span><span class="n">元数据也分多种元数据</span><span class="err">，</span><span class="n">存在不同的ceph</span> <span class="n">pool中</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">默认情况下</span><span class="err">，</span><span class="n">RGW安装完毕后</span><span class="err">，</span><span class="n">会在rados集群上生成包括如下存储池的一系列存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">control</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">log</span>

<span class="n">当我们开始基于对象存储的方式实现数据访问后</span><span class="err">，</span><span class="n">它就会生成另外一些存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>                       <span class="c"># 包含的都是zone,zonegroup,realm等信息</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">control</span>             <span class="c"># pool中对象的控制信息</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span>                <span class="c"># 包含的是元数据信息</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">log</span>                 <span class="c"># 包含的是日志处理信息，包括垃圾回收机制</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">index</span>       <span class="c"># 包含的是存储桶和对象的映射信息</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">data</span>        <span class="c"># 包含的是存储桶的对象数据信息</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里的default指的是</span> <span class="n">ceph的zone区域</span><span class="err">。</span>
    <span class="n">control利用librados提供的对象watch-notify功能</span><span class="err">，</span><span class="n">当有数据更新时</span><span class="err">，</span><span class="n">通知其他RGW刷新cache</span><span class="err">。</span>
</code></pre></div>
<p>元数据</p>
<div class="highlight"><pre><span></span><code><span class="n">查看元数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">list</span>
<span class="p">[</span>
    <span class="s2">&quot;bucket&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bucket.instance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;otp&quot;</span><span class="p">,</span>      <span class="c"># One-time password 一次性密码机制</span>
    <span class="s2">&quot;user&quot;</span>
<span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看用户</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">list</span> <span class="n">user</span>
<span class="p">[</span>
    <span class="s2">&quot;s3user&quot;</span>
<span class="p">]</span>

<span class="n">获取用户细节信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">list</span> <span class="n">user</span><span class="p">:</span><span class="n">s3user</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看存储桶</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">list</span> <span class="n">bucket</span>
<span class="p">[</span>
    <span class="s2">&quot;images&quot;</span><span class="p">,</span>
    <span class="s2">&quot;swift-super&quot;</span>
<span class="p">]</span>

<span class="n">获取存储桶信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">get</span> <span class="n">bucket</span><span class="p">:</span><span class="n">images</span><span class="p">:</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取存储桶实例</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">list</span> <span class="n">bucket</span><span class="p">.</span><span class="n">instance</span>
<span class="p">[</span>
    <span class="s2">&quot;images:09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;swift-super:09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.4&quot;</span>
<span class="p">]</span>

<span class="n">获取存储桶实例信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">radosgw-admin</span> <span class="n">metadata</span> <span class="n">get</span> <span class="n">bucket</span><span class="p">.</span><span class="n">instance</span><span class="p">:</span><span class="n">images</span><span class="p">:</span><span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7</span>
<span class="p">...</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>元数据存储池</p>
<div class="highlight"><pre><span></span><code>{zone}.rgw.meta 存放的是元数据
    root: bucket及bucket-instance
    users.keys: 用户key
    users.email:用户Email,object的key值=email
    users.swift: swift账号
    users.uid: s3用户及用户的Bucket信息
    roles：
    heap：
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看用户的uid信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span> <span class="n">-N</span> <span class="n">users</span><span class="p">.</span><span class="n">uid</span> <span class="nb">ls</span>
<span class="n">s3user</span>
<span class="n">s3user</span><span class="p">.</span><span class="n">buckets</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取用户管理的buckets</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span>  <span class="n">-N</span> <span class="n">users</span><span class="p">.</span><span class="n">uid</span> <span class="n">listomapkeys</span> <span class="n">s3user</span><span class="p">.</span><span class="n">buckets</span>
<span class="n">images</span>
<span class="n">swift-super</span>

<span class="n">默认查看bucket信息是二进制</span><span class="err">，</span><span class="n">所以我们需要将其保存到一个文件中</span><span class="err">，</span><span class="n">通过专用命令进行查看</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span>  <span class="n">-N</span> <span class="n">users</span><span class="p">.</span><span class="n">uid</span> <span class="n">getomapval</span> <span class="n">s3user</span><span class="p">.</span><span class="n">buckets</span> <span class="n">images</span> <span class="n">images_bucket</span>
<span class="n">Writing</span> <span class="n">to</span> <span class="n">images_bucket</span>

<span class="n">查看加密文件信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">ceph-dencoder</span> <span class="n">import</span> <span class="n">images_bucket</span> <span class="nb">type </span><span class="n">cls_user_bucket_entry</span> <span class="n">decode</span> <span class="n">dump_json</span>
<span class="p">{</span>
    <span class="s2">&quot;bucket&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span>
        <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bucket_id&quot;</span><span class="p">:</span> <span class="s2">&quot;09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">23</span><span class="p">,</span>
    <span class="s2">&quot;size_rounded&quot;</span><span class="p">:</span> <span class="n">4096</span><span class="p">,</span>
    <span class="s2">&quot;creation_time&quot;</span><span class="p">:</span> <span class="s2">&quot;2022-09-27 00:49:53.839482Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">1</span><span class="p">,</span>
    <span class="s2">&quot;user_stats_sync&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其他信息获取</span>
    <span class="n">bucket信息</span><span class="err">：</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span> <span class="n">-N</span> <span class="n">root</span> <span class="nb">ls</span>
    <span class="n">bucket元数据</span><span class="err">：</span><span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span> <span class="n">-N</span> <span class="n">root</span> <span class="n">get</span> <span class="p">{</span><span class="n">bucket_id</span><span class="p">}</span> <span class="n">meta_file</span>
</code></pre></div>
<p>索引数据存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">获取buckets的索引信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">index</span> <span class="nb">ls</span>
<span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">4</span>
<span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看存储桶的对象信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">index</span> <span class="n">listomapkeys</span> <span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7</span>
<span class="n">linux</span><span class="p">/</span><span class="n">issue</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看对象元数据信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">index</span> <span class="n">getomapval</span> <span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7</span> <span class="n">linux</span><span class="p">/</span><span class="n">issue</span> <span class="n">object_key</span>
<span class="n">Writing</span> <span class="n">to</span> <span class="n">object_key</span>

<span class="n">查看文件内容信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">ceph-dencoder</span> <span class="nb">type </span><span class="n">rgw_bucket_dir_entry</span> <span class="n">import</span> <span class="n">object_key</span> <span class="n">decode</span> <span class="n">dump_json</span>         <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;linux/issue&quot;</span><span class="p">,</span>
    <span class="s2">&quot;instance&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ver&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;pool&quot;</span><span class="p">:</span> <span class="n">11</span><span class="p">,</span>
        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">1</span>
    <span class="p">},</span>
    <span class="s2">&quot;locator&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">文件对象的header中记录了一些统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">index</span> <span class="n">getomapheader</span> <span class="p">.</span><span class="n">dir</span><span class="p">.</span><span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7</span> <span class="n">index_object_header</span>
<span class="n">Writing</span> <span class="n">to</span> <span class="n">index_object_header</span>

<span class="n">查看统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">ceph-dencoder</span> <span class="nb">type </span><span class="n">rgw_bucket_dir_header</span> <span class="n">import</span> <span class="n">index_object_header</span> <span class="n">decode</span> <span class="n">dump_json</span>
<span class="p">{</span>
    <span class="s2">&quot;ver&quot;</span><span class="p">:</span> <span class="n">2</span><span class="p">,</span>
    <span class="s2">&quot;master_ver&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
    <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">1</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;total_size&quot;</span><span class="p">:</span> <span class="n">23</span><span class="p">,</span>
            <span class="s2">&quot;total_size_rounded&quot;</span><span class="p">:</span> <span class="n">4096</span><span class="p">,</span>
            <span class="s2">&quot;num_entries&quot;</span><span class="p">:</span> <span class="n">1</span><span class="p">,</span>
            <span class="s2">&quot;actual_size&quot;</span><span class="p">:</span> <span class="n">23</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;new_instance&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;reshard_status&quot;</span><span class="p">:</span> <span class="s2">&quot;not-resharding&quot;</span><span class="p">,</span>
        <span class="s2">&quot;new_bucket_instance_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;num_shards&quot;</span><span class="p">:</span> <span class="p">-</span><span class="n">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>数据信息存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">查看数据对象</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">data</span> <span class="nb">ls</span>
<span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7_linux</span><span class="p">/</span><span class="n">issue</span>

<span class="n">查看对象数据的属性信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">data</span> <span class="n">listxattr</span> <span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7_linux</span><span class="p">/</span><span class="n">issue</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">acl</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">content_type</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">etag</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">idtag</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">manifest</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">pg_ver</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">source_zone</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">storage_class</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">tail_tag</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">x-amz-content-sha256</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">x-amz-date</span>
<span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">x-amz-meta-s3cmd-attrs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取对象的manifest的信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">data</span> <span class="n">getxattr</span> <span class="n">09d0b6f1-fc49</span><span class="p">-</span><span class="n">4838-bda1</span><span class="p">-</span><span class="n">08cc60553e29</span><span class="p">.</span><span class="n">15577</span><span class="p">.</span><span class="n">7_linux</span><span class="p">/</span><span class="n">issue</span> <span class="n">user</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">manifest</span> <span class="p">&gt;</span> <span class="n">manifest</span>
<span class="n">查看信息详情</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="p">~]$</span> <span class="n">ceph-dencoder</span> <span class="nb">type </span><span class="n">RGWObjManifest</span> <span class="n">import</span> <span class="n">manifest</span> <span class="n">decode</span> <span class="n">dump_json</span>
<span class="p">{</span>
    <span class="s2">&quot;objs&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">...</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="138">1.3.8 进阶方案<a class="headerlink" href="#138" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、案例解读、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph分布式存储机制</span><span class="err">，</span><span class="n">随着大量应用的普及</span><span class="err">，</span><span class="n">在生产中的存储地位越来越高了</span><span class="err">，</span><span class="n">但是自我搭建存储云的成本太高了</span><span class="err">，</span><span class="n">所以我们在实际应用的过程中</span><span class="err">，</span><span class="n">往往是混合云</span><span class="p">(</span><span class="n">公有云</span><span class="p">+</span><span class="n">私有云</span><span class="p">)</span><span class="n">的方式来实现</span><span class="p">,</span><span class="n">借助于公有云的可扩展</span><span class="err">、</span><span class="n">低成本实现大量普通数据的存储</span><span class="err">，</span><span class="n">借助于私有云的高度可控实现敏感数据的安全控制</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">混合云存储的特点</span><span class="err">：</span>
    <span class="n">高性能</span><span class="err">：</span><span class="n">敏感活动数据存储在私有云存储中</span><span class="err">，</span><span class="n">普通数据存储到公有云存储中</span><span class="err">。</span><span class="n">利用公有云的特性</span><span class="err">，</span><span class="n">实现负载的分散</span><span class="err">，</span><span class="n">从而提供一个较高的综合访问性能</span><span class="err">；</span>
    <span class="n">安全可控</span><span class="err">：</span><span class="n">混合云存储中的私有云部分的软硬件资源都是高度控制的</span><span class="err">，</span><span class="n">所以可以实现敏感数据的可控制性和安全性</span><span class="err">；</span>
    <span class="n">高度扩展</span><span class="err">：</span><span class="n">借助于公有云存储的扩展特性</span><span class="err">，</span><span class="n">混合云存储也具备了高度扩展容量的特性</span><span class="err">；</span>
    <span class="n">相对低成本</span><span class="err">：</span><span class="n">普通数据存储到公有云存储中</span><span class="err">，</span><span class="n">节省了私有云存储的成本</span><span class="err">，</span><span class="n">还拥有公有云存储的成本优势</span><span class="err">，</span><span class="n">混合云存储具有低成本的优势</span><span class="err">。</span>
</code></pre></div>
<p>ceph解决方案</p>
<div class="highlight"><pre><span></span><code>    <span class="n">混合云存储相较于公有云存储和私有云存储会更加全面</span><span class="err">，</span><span class="n">更加完善</span><span class="err">。</span><span class="n">Ceph</span> <span class="n">的对象存储针对混合云的场景</span><span class="err">，</span><span class="n">也相应的提供了解决方案</span><span class="err">，</span><span class="n">即云同步Cloud</span> <span class="n">Sync功能</span><span class="err">。</span><span class="n">Ceph</span> <span class="n">RGW</span> <span class="n">的Cloud</span> <span class="n">Sync</span> <span class="n">功能是基于RGW</span> <span class="n">Multisite</span> <span class="n">机制实现的</span><span class="err">，</span><span class="n">先看下RGW</span> <span class="n">Multisite</span> <span class="n">机制</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">RGW</span> <span class="n">的</span> <span class="n">Multisite</span> <span class="n">机制用于实现多个Ceph</span> <span class="n">对象存储集群间数据同步</span><span class="err">，</span><span class="n">其涉及到的核心概念包括</span><span class="err">：</span>
        <span class="n">zone</span><span class="err">：</span><span class="n">对应于一个独立的集群</span><span class="err">，</span><span class="n">由一组</span> <span class="n">RGW</span> <span class="n">对外提供服务</span><span class="err">。</span>
        <span class="n">zonegroup</span><span class="err">：</span><span class="n">每个</span> <span class="n">zonegroup</span> <span class="n">可以对应多个zone</span><span class="err">，</span><span class="n">zone</span> <span class="n">之间同步数据和元数据</span><span class="err">。</span>
        <span class="n">realm</span><span class="err">：</span><span class="n">每个realm都是独立的命名空间</span><span class="err">，</span><span class="n">可以包含多个</span> <span class="n">zonegroup</span><span class="err">，</span><span class="n">zonegroup</span> <span class="n">之间同步元数据</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220927100024375" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220927100024375.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">Multisite</span> <span class="n">是一个zone</span> <span class="n">层面的功能处理机制</span><span class="err">，</span><span class="n">所以默认情况下</span><span class="err">，</span><span class="n">是</span> <span class="n">zone</span> <span class="n">级的数据同步</span><span class="err">，</span><span class="n">所以说操作粒度过于粗糙</span><span class="err">。</span><span class="n">而基于RGW</span> <span class="n">multisite</span> <span class="n">实现了</span> <span class="n">Cloud</span> <span class="n">Sync</span><span class="err">，</span><span class="n">支持将Ceph</span> <span class="n">中的对象数据同步到支持</span> <span class="n">S3</span> <span class="n">接口的公有云存储中</span><span class="err">，</span><span class="n">作为slave</span> <span class="n">zone不再是一个具体的对象存储集群</span><span class="err">，</span><span class="n">而是一个抽象程度更高的概念</span><span class="err">，</span><span class="n">可以代表任何一个对象存储集群</span><span class="err">，</span><span class="n">从而实现了混合云的基本能力</span><span class="err">。</span>
    <span class="n">Cloud</span> <span class="n">Sync</span> <span class="n">功能正是将支持</span> <span class="n">S3</span> <span class="n">接口的存储集群</span><span class="err">，</span><span class="n">抽象为</span> <span class="n">slave</span> <span class="n">zone</span> <span class="n">的概念</span><span class="err">，</span><span class="n">然后通过Multisite</span> <span class="n">机制</span><span class="err">，</span><span class="n">实现将</span> <span class="n">Ceph</span> <span class="n">中的对象数据同步到外部对象存储中</span><span class="err">。</span>
</code></pre></div>
<p>局限性</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在使用</span> <span class="n">Ceph</span> <span class="n">对象存储时</span><span class="err">，</span> <span class="n">RGW</span> <span class="n">的</span> <span class="n">Cloud</span> <span class="n">Sync</span> <span class="n">功能实际上是基本可以满足混合云存储的应用场景的</span><span class="err">，</span><span class="n">当然劣势是不可避免的</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">支持的同步粒度最细为存储桶级</span><span class="err">，</span><span class="n">在某些应用场景下</span><span class="err">，</span><span class="n">存储桶级的同步粒度是不太合适的</span><span class="err">；</span>
    <span class="n">2</span> <span class="n">RGW</span> <span class="n">Multisite</span> <span class="n">的数据同步因为涉及到多云环境</span><span class="err">，</span><span class="n">所以时间控制要求高</span><span class="err">，</span><span class="n">一些时间敏感的场景并不适用</span><span class="err">。</span>
</code></pre></div>
<p><strong>案例解读</strong></p>
<p>存储分级管理</p>
<div class="highlight"><pre><span></span><code><span class="n">存储介质</span><span class="err">：</span>
    <span class="n">出于对访问性能</span><span class="err">、</span><span class="n">成本等因素的考虑</span><span class="err">，</span><span class="n">同时引入多种存储介质的分级管理</span><span class="err">，</span><span class="n">实现高效数据存储</span><span class="err">。</span>
<span class="n">存储策略</span><span class="err">：</span>
    <span class="n">主要针对的是数据级别的副本设定</span><span class="p">(</span><span class="n">默认3副本</span><span class="p">)</span><span class="n">和存储厂商的指定</span><span class="err">。</span>
<span class="n">存放规则</span><span class="err">：</span>
    <span class="n">针对应用场景的不同</span><span class="err">，</span><span class="n">对不同的数据实现各自的数据存放规则</span><span class="err">。</span><span class="n">但是因为是zone级别的</span><span class="err">，</span><span class="n">所以有些场景不合适</span><span class="err">。</span>
</code></pre></div>
<p>对象周期管理</p>
<div class="highlight"><pre><span></span><code>    <span class="n">作为对象存储</span><span class="err">，</span><span class="n">它的最大特点就是基于web形式来进行访问</span><span class="err">，</span><span class="n">不可避免的涉及到缓存的管理</span><span class="err">，</span><span class="n">所以对象生命周期管理是非常重要的事项</span><span class="err">。</span>
    <span class="n">目前来说</span><span class="err">，</span><span class="n">对象存储的周期管理主要有两种方式</span><span class="err">：</span><span class="n">迁移处理和过期删除处理</span>
</code></pre></div>
<p>自动迁移管理</p>
<div class="highlight"><pre><span></span><code>    <span class="n">根据存储桶日志中的操作记录等属性参数</span><span class="err">，</span><span class="n">我们可以实现对存储桶中的对象数据的热度进行分析</span><span class="err">，</span><span class="n">并按照分析结果自动生成迁移策略</span><span class="err">，</span><span class="n">从而实现对象数据的自动化管理</span><span class="err">。</span>
    <span class="n">从</span> <span class="n">target</span> <span class="n">bucket</span> <span class="n">中读取存储桶日志</span><span class="err">；</span>
    <span class="n">对日记记录进行过滤</span><span class="err">、</span><span class="n">分析</span><span class="err">，</span><span class="n">得到用户配置的规则中所标定的对象数据的访问热度</span><span class="err">；</span>
    <span class="n">生成相应的生命周期管理规则</span><span class="err">；</span>
    <span class="n">将生成的生命周期管理规则配置到相应的存储桶上</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="14_cephfs">1.4 CephFS接口<a class="headerlink" href="#14_cephfs" title="Permanent link">&para;</a></h2>
<h3 id="141">1.4.1 基础知识<a class="headerlink" href="#141" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>场景</p>
<div class="highlight"><pre><span></span><code>    <span class="n">有了</span> <span class="n">RBD</span><span class="err">，</span><span class="n">远程磁盘挂载的问题就解决了</span><span class="err">，</span><span class="n">但</span> <span class="n">RBD</span> <span class="n">的问题是不能多个主机共享一个磁盘</span><span class="err">，</span><span class="n">如果有一份数据很多客户端都要读写该怎么办呢</span><span class="err">？</span><span class="n">这时</span> <span class="n">CephFS</span> <span class="n">作为文件系统存储解决方案就派上用场了</span><span class="err">。</span>
</code></pre></div>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">文件系统</span><span class="err">（</span><span class="n">Ceph</span> <span class="n">FS</span><span class="err">）</span><span class="n">是个</span> <span class="n">POSIX</span> <span class="n">兼容的文件系统</span><span class="err">，</span><span class="n">它直接使用</span> <span class="n">Ceph</span> <span class="n">存储集群来存储数据</span><span class="err">。</span> <span class="n">Ceph</span> <span class="n">文件系统与</span> <span class="n">Ceph</span> <span class="n">块设备</span><span class="err">、</span><span class="n">同时提供</span> <span class="n">S3</span> <span class="n">和</span> <span class="n">Swift</span> <span class="n">API</span> <span class="n">的</span> <span class="n">Ceph</span> <span class="n">对象存储</span><span class="err">、</span><span class="n">或者原生库</span><span class="err">（</span> <span class="n">librados</span> <span class="err">）</span><span class="n">的实现机制稍显不同</span><span class="err">。</span>
</code></pre></div>
<p>要点</p>
<p><img alt="image-20211117114047214" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211117114047214.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">CephFS需要至少运行一个元数据服务器</span><span class="err">（</span><span class="n">MDS</span><span class="err">）</span><span class="n">守护进程</span><span class="err">（</span><span class="n">ceph-mds</span><span class="err">），</span><span class="n">此进程管理与CephFS上存储的文件相关的元数据</span><span class="err">，</span><span class="n">并协调对Ceph存储集群的访问</span><span class="err">。</span>
    <span class="n">因此</span><span class="err">，</span><span class="n">若要使用CephFS接口</span><span class="err">，</span><span class="n">需要在存储集群中至少部署一个MDS实例</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">MDS虽然称为元数据服务</span><span class="err">，</span><span class="n">但是它却不存储任何元数据信息</span><span class="err">，</span><span class="n">它存在的目的仅仅是</span> <span class="n">让我们rados集群提供的存储接口能够兼容POSIX</span> <span class="n">的文件系统接口</span> <span class="p">--</span> <span class="n">简单来说</span><span class="err">，</span><span class="n">它是真正元数据信息的索引服务</span><span class="err">。</span>
    <span class="n">客户端在访问文件接口的时候</span><span class="err">，</span><span class="n">首先连接到</span> <span class="n">MDS上</span><span class="err">，</span><span class="n">在MDS的内存里面维持元数据的索引信息</span><span class="err">，</span><span class="n">这些信息真正的保存在RADOS集群的metadata</span> <span class="n">pool上面</span><span class="err">，</span><span class="n">而对应的数据</span><span class="err">，</span><span class="n">保存在对应的</span> <span class="n">data</span> <span class="n">pool上面</span><span class="err">。</span>
    <span class="n">而且以将元数据服务作为一个非状态的效果</span><span class="err">，</span><span class="n">便于扩展</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">相较于NFS来说</span><span class="err">，</span><span class="n">它主要有以下特点优势</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">底层数据冗余的功能</span><span class="err">，</span><span class="n">底层的roados</span> <span class="n">提供了基本的数据冗余功能</span><span class="err">，</span><span class="n">因此不存在nfs的单点故障因素</span><span class="err">。</span>
    <span class="n">2</span> <span class="n">底层的roados系统有n个存储节点组成</span><span class="err">，</span><span class="n">所以数据的存储可以分散IO</span><span class="err">，</span><span class="n">吞吐量较高</span><span class="err">。</span>
    <span class="n">3</span> <span class="n">底层的roados系统有n个存储节点组成</span><span class="err">，</span><span class="n">所以ceph提供的扩展性要想当的高</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>部署mds主机</p>
<div class="highlight"><pre><span></span><code><span class="n">在admin主机上为stor05上部署mds服务</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">mds</span> <span class="n">create</span> <span class="n">stor05</span>

<span class="n">在stor05上</span><span class="err">，</span><span class="n">并确认是否开启了守护进程</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">stor05</span> <span class="s2">&quot;ps aux | grep ceph-mds | grep -v grep&quot;</span>
<span class="n">ceph</span>       <span class="n">14471</span>  <span class="n">0</span><span class="p">.</span><span class="n">1</span>  <span class="n">1</span><span class="p">.</span><span class="n">2</span> <span class="n">384316</span> <span class="n">22504</span> <span class="p">?</span>        <span class="n">Ssl</span>  <span class="n">11</span><span class="p">:</span><span class="n">48</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ceph-mds</span> <span class="o">-f</span> <span class="p">-</span><span class="n">-cluster</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-id</span> <span class="n">stor05</span> <span class="p">-</span><span class="n">-setuser</span> <span class="n">ceph</span> <span class="p">-</span><span class="n">-setgroup</span> <span class="n">ceph</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在admin主机上通过</span> <span class="n">ceph</span> <span class="n">-s</span> <span class="n">中查看mds的状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span>  <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">6m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">47h</span><span class="p">),</span> <span class="n">standbys</span><span class="p">:</span> <span class="n">mon02</span>
    <span class="n">mds</span><span class="p">:</span>  <span class="n">1</span> <span class="n">up</span><span class="p">:</span><span class="n">standby</span>      <span class="c"># 一个mds部署成功</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">6m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">43h</span><span class="p">)</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">在没有为fs准备存储池的前提下</span><span class="err">，</span><span class="n">是看不到效果的</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">需要专用的命令来进行查看mds的状态效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mds</span> <span class="n">stat</span>
 <span class="n">1</span> <span class="n">up</span><span class="p">:</span><span class="n">standby</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">查看MDS的相关状态可以发现</span><span class="err">，</span><span class="n">刚添加的MDS处于Standby模式</span>
</code></pre></div>
<p>创建专属存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">创建元数据存储池</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">cephfs-metadata</span> <span class="n">32</span> <span class="n">32</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">cephfs-data</span> <span class="n">64</span> <span class="n">64</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将刚才创建的存储池组合为fs专属存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">fs</span> <span class="n">new</span> <span class="n">cephfs</span> <span class="n">cephfs-metadata</span> <span class="n">cephfs-data</span>
<span class="n">new</span> <span class="n">fs</span> <span class="n">with</span> <span class="n">metadata</span> <span class="n">pool</span> <span class="n">14</span> <span class="n">and</span> <span class="n">data</span> <span class="n">pool</span> <span class="n">15</span>
</code></pre></div>
<p>确认效果</p>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">11m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">47h</span><span class="p">),</span> <span class="n">standbys</span><span class="p">:</span> <span class="n">mon02</span>
    <span class="n">mds</span><span class="p">:</span> <span class="n">cephfs</span><span class="p">:</span><span class="n">1</span> <span class="p">{</span><span class="n">0</span><span class="p">=</span><span class="n">stor05</span><span class="p">=</span><span class="n">up</span><span class="p">:</span><span class="n">active</span><span class="p">}</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">11m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">43h</span><span class="p">)</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">fs</span> <span class="n">status</span> <span class="n">cephfs</span>
<span class="n">cephfs</span> <span class="p">-</span> <span class="n">0</span> <span class="n">clients</span>
<span class="p">======</span>
<span class="p">+------+--------+--------+---------------+-------+-------+</span>
<span class="p">|</span> <span class="n">Rank</span> <span class="p">|</span> <span class="n">State</span>  <span class="p">|</span>  <span class="n">MDS</span>   <span class="p">|</span>    <span class="n">Activity</span>   <span class="p">|</span>  <span class="n">dns</span>  <span class="p">|</span>  <span class="n">inos</span> <span class="p">|</span>
<span class="p">+------+--------+--------+---------------+-------+-------+</span>
<span class="p">|</span>  <span class="n">0</span>   <span class="p">|</span> <span class="n">active</span> <span class="p">|</span> <span class="n">stor05</span> <span class="p">|</span> <span class="n">Reqs</span><span class="p">:</span>    <span class="n">0</span> <span class="p">/</span><span class="n">s</span> <span class="p">|</span>   <span class="n">10</span>  <span class="p">|</span>   <span class="n">13</span>  <span class="p">|</span>
<span class="p">+------+--------+--------+---------------+-------+-------+</span>
<span class="p">+-----------------+----------+-------+-------+</span>
<span class="p">|</span>       <span class="n">Pool</span>      <span class="p">|</span>   <span class="nb">type </span>  <span class="p">|</span>  <span class="n">used</span> <span class="p">|</span> <span class="n">avail</span> <span class="p">|</span>
<span class="p">+-----------------+----------+-------+-------+</span>
<span class="p">|</span> <span class="n">cephfs-metadata</span> <span class="p">|</span> <span class="n">metadata</span> <span class="p">|</span> <span class="n">1536k</span> <span class="p">|</span> <span class="n">35</span><span class="p">.</span><span class="n">8G</span> <span class="p">|</span>
<span class="p">|</span>   <span class="n">cephfs-data</span>   <span class="p">|</span>   <span class="n">data</span>   <span class="p">|</span>    <span class="n">0</span>  <span class="p">|</span> <span class="n">35</span><span class="p">.</span><span class="n">8G</span> <span class="p">|</span>
<span class="p">+-----------------+----------+-------+-------+</span>
<span class="p">+-------------+</span>
<span class="p">|</span> <span class="n">Standby</span> <span class="n">MDS</span> <span class="p">|</span>
<span class="p">+-------------+</span>
<span class="p">+-------------+</span>
<span class="n">MDS</span> <span class="n">version</span><span class="p">:</span> <span class="n">ceph</span> <span class="n">version</span> <span class="n">14</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">22</span> <span class="p">(</span><span class="n">ca74598065096e6fcbd8433c8779a2be0c889351</span><span class="p">)</span> <span class="n">nautilus</span> <span class="p">(</span><span class="n">stable</span><span class="p">)</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="142">1.4.2 接口使用<a class="headerlink" href="#142" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>客户端使用cephFS方式</p>
<p><img alt="image-20211210121816739" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211210121816739.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">客户端使用cephFS</span><span class="err">，</span><span class="n">主要有两种方式</span><span class="err">：</span>
    <span class="n">内核文件系统</span> <span class="p">-</span> <span class="n">Ceph</span><span class="err">、</span><span class="n">libcephfs</span>
    <span class="n">用户空间文件系统</span> <span class="p">-</span> <span class="n">FUSE</span><span class="p">(</span><span class="n">Filesystem</span> <span class="k">in</span> <span class="n">USErspace</span><span class="p">)</span>
<span class="n">前提</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">至少一个节点运行ceph-mds守护进程</span>
    <span class="n">2</span> <span class="n">创建存储池</span> <span class="n">ceph-metadata</span><span class="err">、</span><span class="n">ceph-data</span>
    <span class="n">3</span> <span class="n">激活文件系统</span>
    <span class="n">4</span> <span class="n">无论那种客户端使用cephFS的方式</span><span class="err">，</span><span class="n">都需要有专门的认证机制</span><span class="err">。</span>
</code></pre></div>
<p>准备认证文件</p>
<div class="highlight"><pre><span></span><code><span class="n">在admin节点上</span><span class="err">，</span><span class="n">准备认证账号</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">mds</span> <span class="s1">&#39;allow rw&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow rwx pool=cephfs-data&#39;</span> <span class="n">-o</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">fsclient</span><span class="p">.</span><span class="n">keyring</span>
    <span class="n">注意</span><span class="err">：</span><span class="n">我们只需要对data的存储池进行操作即可</span><span class="err">，</span><span class="n">不需要对metadata存储池进行授权</span><span class="err">。</span>  
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看账号信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span>

<span class="n">查看认证文件信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">ls </span><span class="p">*</span><span class="n">fsclient</span><span class="p">*</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">fsclient</span><span class="p">.</span><span class="n">keyring</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">fsclient</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.fsclient]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQBgdTJj</span><span class="p">+</span><span class="n">LVdFBAAZOjGIsw4t</span><span class="p">+</span><span class="n">o1swZlW4CvKQ</span><span class="p">==</span> 
</code></pre></div>
<p>秘钥管理</p>
<div class="highlight"><pre><span></span><code>    <span class="n">客户端挂载cephFS的时候</span><span class="err">，</span><span class="n">需要指定用户名和key</span><span class="err">，</span><span class="n">而这两项是有不同的两个选项来指定的</span><span class="err">，</span><span class="n">所以我们应该将这两个内容分开存储</span>

<span class="n">获取相关的秘钥信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-authtool</span> <span class="n">-p</span> <span class="n">-n</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">fsclient</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">AQBgdTJj</span><span class="p">+</span><span class="n">LVdFBAAZOjGIsw4t</span><span class="p">+</span><span class="n">o1swZlW4CvKQ</span><span class="p">==</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span>
<span class="n">AQBgdTJj</span><span class="p">+</span><span class="n">LVdFBAAZOjGIsw4t</span><span class="p">+</span><span class="n">o1swZlW4CvKQ</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">保存用户账号的密钥信息于secret文件</span><span class="err">，</span><span class="n">用于客户端挂载操作认证之用</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span> <span class="p">&gt;</span> <span class="n">fsclient</span><span class="p">.</span><span class="n">key</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">fsclient</span><span class="p">.</span><span class="n">key</span>
<span class="n">AQBgdTJj</span><span class="p">+</span><span class="n">LVdFBAAZOjGIsw4t</span><span class="p">+</span><span class="n">o1swZlW4CvKQ</span><span class="p">==</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>ceph客户端的需求</p>
<div class="highlight"><pre><span></span><code><span class="n">客户端主机环境准备</span>
    <span class="n">内核模块ceph</span><span class="p">.</span><span class="n">ko</span>
        <span class="n">yum</span> <span class="n">install</span> <span class="n">ceph</span>
    <span class="n">安装ceph-common程序包</span>
        <span class="n">yum</span> <span class="n">install</span> <span class="n">ceph-common</span>
    <span class="n">提供ceph</span><span class="p">.</span><span class="n">conf配置文件</span>
        <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">config</span> <span class="n">push</span> <span class="n">stor06</span>
    <span class="n">获取到用于认证的密钥文件</span>
        <span class="n">sudo</span> <span class="n">scp</span> <span class="n">fsclient</span><span class="p">.</span><span class="n">key</span> <span class="n">stor06</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
</code></pre></div>
<p>cephFS客户端准备</p>
<div class="highlight"><pre><span></span><code><span class="n">我们准备将</span> <span class="n">stor06</span> <span class="n">作为cephFS的客户端主机</span><span class="err">，</span><span class="n">检查stor06的ceph模块加载情况</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># modinfo ceph</span>
<span class="p">...</span>

<span class="n">保证</span> <span class="n">stor06上有ceph相关的配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /etc/ceph/</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span> <span class="p">...</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>  <span class="n">fsclient</span><span class="p">.</span><span class="n">key</span>  <span class="n">rbdmap</span>
</code></pre></div>
<p>挂载cephFS</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的数据目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mkdir /cephfs-data/</span>

<span class="n">挂载cephFS对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount -t ceph mon01:6789,mon02:6789,mon03:6789:/ /cephfs-data/ -o name=fsclient,secretfile=/etc/ceph/fsclient.key</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">内核空间挂载ceph文件系统</span><span class="err">，</span><span class="n">要求必须指定ceph文件系统的挂载路径</span>

<span class="n">确认挂载效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep cephfs</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">:/</span> <span class="n">on</span> <span class="p">/</span><span class="n">cephfs-data</span> <span class="nb">type </span><span class="n">ceph</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">name</span><span class="p">=</span><span class="n">fsclient</span><span class="p">,</span><span class="n">secret</span><span class="p">=&lt;</span><span class="n">hidden</span><span class="p">&gt;,</span><span class="n">acl</span><span class="p">,</span><span class="n">wsize</span><span class="p">=</span><span class="n">16777216</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看挂载点的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># stat -f /cephfs-data/</span>
  <span class="n">文件</span><span class="err">：</span><span class="s2">&quot;/cephfs-data/&quot;</span>
    <span class="n">ID</span><span class="err">：</span><span class="n">c931549bd8ae8624</span> <span class="n">文件名长度</span><span class="err">：</span><span class="n">255</span>     <span class="n">类型</span><span class="err">：</span><span class="n">ceph</span>
<span class="n">块大小</span><span class="err">：</span><span class="n">4194304</span>    <span class="n">基本块大小</span><span class="err">：</span><span class="n">4194304</span>
    <span class="n">块</span><span class="err">：</span><span class="n">总计</span><span class="err">：</span><span class="n">9182</span>       <span class="n">空闲</span><span class="err">：</span><span class="n">9182</span>       <span class="n">可用</span><span class="err">：</span><span class="n">9182</span>
<span class="n">Inodes</span><span class="p">:</span> <span class="n">总计</span><span class="err">：</span><span class="n">0</span>          <span class="n">空闲</span><span class="err">：</span><span class="p">-</span><span class="n">1</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">挂载点的类型是</span> <span class="n">ceph</span><span class="err">。</span>

<span class="n">确认文件系统使用效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># echo nihao cephfs &gt; /cephfs-data/cephfs.txt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /cephfs-data/cephfs.txt</span>
<span class="n">nihao</span> <span class="n">cephfs</span>
</code></pre></div>
<p>开机自启动挂载cephFS</p>
<div class="highlight"><pre><span></span><code><span class="n">卸载刚才挂载的cephFS</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># umount /cephfs-data</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep ceph</span>

<span class="n">设置开机自启动</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># echo &#39;mon01:6789,mon02:6789,mon03:6789:/  /cephfs-data  ceph name=fsclient,secretfile=/etc/ceph/fsclient.key,_netdev,noatime 0 0&#39; &gt;&gt; /etc/fstab</span>
<span class="n">属性解析</span><span class="err">：</span>
    <span class="n">_netdev</span> <span class="p">-</span> <span class="n">告诉挂载程序</span><span class="err">，</span><span class="n">一旦超时</span><span class="err">，</span><span class="n">自动跳过去</span><span class="err">。</span>
    <span class="n">noatime</span> <span class="p">-</span> <span class="n">在读文件时不去更改文件的access</span> <span class="n">time属性</span><span class="err">，</span><span class="n">提高性能</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">挂载磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount -a</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep ceph</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">:/</span> <span class="n">on</span> <span class="p">/</span><span class="n">cephfs-data</span> <span class="nb">type </span><span class="n">ceph</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">noatime</span><span class="p">,</span><span class="n">name</span><span class="p">=</span><span class="n">fsclient</span><span class="p">,</span><span class="n">secret</span><span class="p">=&lt;</span><span class="n">hidden</span><span class="p">&gt;,</span><span class="n">acl</span><span class="p">)</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /cephfs-data/cephfs.txt</span>
<span class="n">nihao</span> <span class="n">cephfs</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="143_fuse">1.4.3 FUSE实践<a class="headerlink" href="#143_fuse" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于某些操作系统来说</span><span class="err">，</span><span class="n">它没有提供对应的ceph内核模块</span><span class="err">，</span><span class="n">我们还需要使用cephFS的话</span><span class="err">，</span><span class="n">可以通过</span> <span class="n">FUSE方式来实现</span><span class="err">，</span><span class="n">FUSE全称Filesystem</span> <span class="k">in</span> <span class="n">Userspace</span><span class="err">，</span><span class="n">用于非特权用户能够无需操作内核而创建文件系统</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">如果我们在非内核的环境下使用cephFS的话</span><span class="err">，</span><span class="n">需要对客户端主机的环境做一些准备工作</span><span class="err">：</span>
    <span class="n">安装ceph-fuse程序包</span>
        <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">ceph-fuse</span> <span class="n">ceph-common</span>
    <span class="n">获取到客户端账号的keyring文件和ceph</span><span class="p">.</span><span class="n">conf配置文件</span>
        <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">config</span> <span class="n">push</span> <span class="n">stor06</span>
        <span class="n">sudo</span> <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">fsclient</span><span class="p">.</span><span class="n">keyring</span> <span class="n">root</span><span class="nv">@stor06</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>客户端环境准备</p>
<div class="highlight"><pre><span></span><code><span class="n">我们准备将</span> <span class="n">stor06</span> <span class="n">作为cephFS的客户端主机</span><span class="err">，</span><span class="n">安装对应的软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># yum install ceph-fuse ceph-common -y</span>

<span class="n">保证</span> <span class="n">stor06上有ceph相关的配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ls /etc/ceph/</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">kube</span><span class="p">.</span><span class="n">keyring</span> <span class="p">...</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>  <span class="n">fsclient</span><span class="p">.</span><span class="n">key</span>  <span class="n">rbdmap</span>
</code></pre></div>
<p>挂载cephFS</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的数据目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mkdir /cephfs-data-user/</span>

<span class="n">挂载cephFS对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># ceph-fuse -n client.fsclient -m mon01:6789,mon02:6789,mon03:6789 /cephfs-data-user/</span>
<span class="n">ceph-fuse</span><span class="p">[</span><span class="n">7963</span><span class="p">]:</span> <span class="n">starting</span> <span class="n">ceph</span> <span class="n">client2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">27</span> <span class="n">12</span><span class="p">:</span><span class="n">23</span><span class="p">:</span><span class="n">47</span><span class="p">.</span><span class="n">905</span> <span class="n">7f6e97de4f80</span> <span class="p">-</span><span class="n">1</span> <span class="n">init</span><span class="p">,</span> <span class="n">newargv</span> <span class="p">=</span> <span class="n">0x5637c9545540</span> <span class="n">newargc</span><span class="p">=</span><span class="n">9</span>
<span class="n">ceph-fuse</span><span class="p">[</span><span class="n">7963</span><span class="p">]:</span> <span class="n">starting</span> <span class="n">fuse</span>

<span class="n">确认挂载效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep cephfs</span>
<span class="n">ceph-fuse</span> <span class="n">on</span> <span class="p">/</span><span class="n">cephfs-data-user</span> <span class="nb">type </span><span class="n">fuse</span><span class="p">.</span><span class="n">ceph-fuse</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">user_id</span><span class="p">=</span><span class="n">0</span><span class="p">,</span><span class="n">group_id</span><span class="p">=</span><span class="n">0</span><span class="p">,</span><span class="n">allow_other</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看挂载点的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># stat -f /cephfs-data-user/</span>
  <span class="n">文件</span><span class="err">：</span><span class="s2">&quot;/cephfs-data-user/&quot;</span>
    <span class="n">ID</span><span class="err">：</span><span class="n">0</span>        <span class="n">文件名长度</span><span class="err">：</span><span class="n">255</span>     <span class="n">类型</span><span class="err">：</span><span class="n">fuseblk</span>
<span class="n">块大小</span><span class="err">：</span><span class="n">4194304</span>    <span class="n">基本块大小</span><span class="err">：</span><span class="n">4194304</span>
    <span class="n">块</span><span class="err">：</span><span class="n">总计</span><span class="err">：</span><span class="n">9182</span>       <span class="n">空闲</span><span class="err">：</span><span class="n">9182</span>       <span class="n">可用</span><span class="err">：</span><span class="n">9182</span>
<span class="n">Inodes</span><span class="p">:</span> <span class="n">总计</span><span class="err">：</span><span class="n">1</span>          <span class="n">空闲</span><span class="err">：</span><span class="n">0</span>

<span class="n">确认文件系统使用效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># echo nihao cephfs user &gt; /cephfs-data-user/cephfs.txt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /cephfs-data-user/cephfs.txt</span>
<span class="n">nihao</span> <span class="n">cephfs</span> <span class="n">-user</span>
</code></pre></div>
<p>开机自启动挂载cephFS</p>
<div class="highlight"><pre><span></span><code><span class="n">卸载刚才挂载的cephFS</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># umount /cephfs-data-user</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep ceph</span>

<span class="n">设置开机自启动</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># echo &#39;none  /cephfs-data-user   fuse.ceph   ceph.id=fsclient,ceph.conf=/etc/ceph/ceph.conf,_netdev,noatime 0 0&#39; &gt;&gt; /etc/fstab</span>
<span class="n">属性解析</span><span class="err">：</span>
    <span class="n">_netdev</span> <span class="p">-</span> <span class="n">告诉挂载程序</span><span class="err">，</span><span class="n">一旦超时</span><span class="err">，</span><span class="n">自动跳过去</span><span class="err">。</span>
    <span class="n">noatime</span> <span class="p">-</span> <span class="n">在读文件时不去更改文件的access</span> <span class="n">time属性</span><span class="err">，</span><span class="n">提高性能</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">挂载磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount -a</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep ceph</span>
<span class="n">ceph-fuse</span> <span class="n">on</span> <span class="p">/</span><span class="n">cephfs-data-user</span> <span class="nb">type </span><span class="n">fuse</span><span class="p">.</span><span class="n">ceph-fuse</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noatime</span><span class="p">,</span><span class="n">user_id</span><span class="p">=</span><span class="n">0</span><span class="p">,</span><span class="n">group_id</span><span class="p">=</span><span class="n">0</span><span class="p">,</span><span class="n">allow_other</span><span class="p">)</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># cat /cephfs-data-user/cephfs.txt</span>
<span class="n">nihao</span> <span class="n">cephfs</span> <span class="n">user</span>

<span class="n">专用的卸载命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># fusermount -u /cephfs-data-user</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">~]</span><span class="c"># mount | grep cephfs</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="15">1.5 集群管理<a class="headerlink" href="#15" title="Permanent link">&para;</a></h2>
<h3 id="151">1.5.1 集群状态<a class="headerlink" href="#151" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、集群管理、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>检查集群状态</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span> <span class="n">查看集群ID</span> <span class="n">和</span> <span class="n">集群运行状况</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_OK</span>

  <span class="n">services</span><span class="p">:</span> <span class="n">各种服务的状态监控</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span> <span class="p">(</span><span class="n">age</span> <span class="n">48m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">mon01</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">2d</span><span class="p">),</span> <span class="n">standbys</span><span class="p">:</span> <span class="n">mon02</span>
    <span class="n">mds</span><span class="p">:</span> <span class="n">cephfs</span><span class="p">:</span><span class="n">1</span> <span class="p">{</span><span class="n">0</span><span class="p">=</span><span class="n">stor05</span><span class="p">=</span><span class="n">up</span><span class="p">:</span><span class="n">active</span><span class="p">}</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">48m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">44h</span><span class="p">)</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>

  <span class="n">task</span> <span class="n">status</span><span class="p">:</span>  <span class="n">任务状态</span>

  <span class="n">data</span><span class="p">:</span> <span class="n">存储数据相关的监控</span><span class="err">，</span><span class="n">包括存储池</span><span class="err">、</span><span class="n">存储对象</span><span class="err">、</span><span class="n">存储统计数量等</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">10</span> <span class="n">pools</span><span class="p">,</span> <span class="n">352</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">270</span> <span class="n">objects</span><span class="p">,</span> <span class="n">60</span> <span class="n">MiB</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">6</span><span class="p">.</span><span class="n">3</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">114</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>     <span class="n">352</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span>  
</code></pre></div>
<p>检查集群即时状态</p>
<div class="highlight"><pre><span></span><code><span class="n">查看pg的状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">stat</span>
<span class="n">352</span> <span class="n">pgs</span><span class="p">:</span> <span class="n">352</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span><span class="p">;</span> <span class="n">60</span> <span class="n">MiB</span> <span class="n">data</span><span class="p">,</span> <span class="n">314</span> <span class="n">MiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">114</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span><span class="p">;</span> <span class="n">4</span><span class="p">.</span><span class="n">0</span> <span class="n">KiB</span><span class="p">/</span><span class="n">s</span> <span class="n">rd</span><span class="p">,</span> <span class="n">0</span> <span class="n">B</span><span class="p">/</span><span class="n">s</span> <span class="n">wr</span><span class="p">,</span> <span class="n">6</span> <span class="n">op</span><span class="p">/</span><span class="n">s</span>

<span class="n">查看pool的状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span>
<span class="n">pool</span> <span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span> <span class="n">id</span> <span class="n">6</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>
  <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看ceph的存储空间状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">df</span> <span class="no">[detail]</span>
<span class="n">RAW</span> <span class="n">STORAGE</span><span class="p">:</span>
    <span class="n">CLASS</span>     <span class="n">SIZE</span>        <span class="n">AVAIL</span>       <span class="n">USED</span>        <span class="n">RAW</span> <span class="n">USED</span>     <span class="k">%</span><span class="n">RAW</span> <span class="n">USED</span>
    <span class="n">hdd</span>       <span class="n">120</span> <span class="n">GiB</span>     <span class="n">114</span> <span class="n">GiB</span>     <span class="n">314</span> <span class="n">MiB</span>      <span class="n">6</span><span class="p">.</span><span class="n">3</span> <span class="n">GiB</span>          <span class="n">5</span><span class="p">.</span><span class="n">26</span>
    <span class="n">TOTAL</span>     <span class="n">120</span> <span class="n">GiB</span>     <span class="n">114</span> <span class="n">GiB</span>     <span class="n">314</span> <span class="n">MiB</span>      <span class="n">6</span><span class="p">.</span><span class="n">3</span> <span class="n">GiB</span>          <span class="n">5</span><span class="p">.</span><span class="n">26</span>

<span class="n">POOLS</span><span class="p">:</span>
    <span class="n">POOL</span>         <span class="n">ID</span>  <span class="n">PGS</span>  <span class="n">STORED</span>    <span class="n">OBJECTS</span>  <span class="n">USED</span>      <span class="k">%</span><span class="n">USED</span>    <span class="n">MAX</span> <span class="n">AVAIL</span>
    <span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>    <span class="n">6</span>   <span class="n">32</span>   <span class="n">1</span><span class="p">.</span><span class="n">2</span> <span class="n">KiB</span>   <span class="n">4</span>        <span class="n">768</span> <span class="n">KiB</span>   <span class="n">0</span>        <span class="n">36</span> <span class="n">GiB</span>
<span class="p">...</span>
</code></pre></div>
<p>查看osd状态</p>
<div class="highlight"><pre><span></span><code><span class="n">查看osd的基本状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">stat</span>
<span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">52m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">44h</span><span class="p">);</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">e150</span>

<span class="n">查看osd的属性详情</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">150</span>
<span class="n">fsid</span> <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
<span class="p">...</span>

<span class="n">查看osd的归属结构Ceph将列显CRUSH树及主机</span><span class="err">、</span><span class="n">它的OSD</span><span class="err">、</span><span class="n">OSD是否已启动及其权重</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">11691</span> <span class="n">root</span> <span class="k">default</span>
<span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon01</span>
 <span class="n">0</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">...</span>
</code></pre></div>
<p>查看mon状态</p>
<div class="highlight"><pre><span></span><code>    <span class="n">集群中存在多个Mon主机时</span><span class="err">，</span><span class="n">应该在启动集群之后读取或写入数据之前检查Mon的仲裁状态</span><span class="err">；</span><span class="n">事实上</span><span class="err">，</span><span class="n">管理员也应该定期检查这种仲裁结果</span>

<span class="n">显示监视器映射</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mon</span> <span class="n">stat</span>
<span class="n">e3</span><span class="p">:</span> <span class="n">3</span> <span class="n">mons</span> <span class="n">at</span> <span class="p">{</span><span class="n">mon01</span><span class="p">=[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">],</span><span class="n">mon02</span><span class="p">=[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">],</span><span class="n">mon03</span><span class="p">=[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]},</span> <span class="n">election</span> <span class="n">epoch</span> <span class="n">36</span><span class="p">,</span> <span class="n">leader</span> <span class="n">0</span> <span class="n">mon01</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span> <span class="n">mon01</span><span class="p">,</span><span class="n">mon02</span><span class="p">,</span><span class="n">mon03</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mon</span> <span class="n">dump</span>
<span class="p">...</span>
<span class="n">0</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon01</span>
<span class="n">1</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon02</span>
<span class="n">2</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon03</span>
<span class="n">dumped</span> <span class="n">monmap</span> <span class="n">epoch</span> <span class="n">3</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">普通方式查看多个mon节点的选举状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">quorum_status</span>

<span class="n">以格式化方式查看选举状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">quorum_status</span> <span class="o">-f</span> <span class="n">json-pretty</span>
</code></pre></div>
<p><strong>集群管理</strong></p>
<p>集群管理套接字</p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph的管理套接字接口常用于查询守护进程</span>
    <span class="n">资源对象文件保存的目录</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">ceph目录</span>
    <span class="n">套接字默认保存</span> <span class="n">于</span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph目录</span>
    <span class="n">此接口的使用不能以远程方式进程</span>
</code></pre></div>
<p>借助于socket文件实现ceph属性的动态管理</p>
<div class="highlight"><pre><span></span><code><span class="n">命令的使用格式</span><span class="err">：</span>
    <span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">socket-name</span>
    <span class="n">获取使用帮助</span><span class="err">：</span>
    <span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">socket-name</span> <span class="n">help</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">简单示例</span>
    <span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph-mgr</span><span class="p">.</span><span class="n">mon01</span><span class="p">.</span><span class="n">asok</span> <span class="n">help</span>
    <span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph-mon</span><span class="p">.</span><span class="n">mon01</span><span class="p">.</span><span class="n">asok</span> <span class="n">help</span>
    <span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph-osd</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">asok</span> <span class="n">help</span>
    <span class="n">ceph</span> <span class="p">-</span><span class="n">-admin-daemon</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph-osd</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">asok</span> <span class="n">help</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="152">1.5.2 配置文件<a class="headerlink" href="#152" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>文件目录</p>
<div class="highlight"><pre><span></span><code><span class="n">ceph软件安装完成后</span><span class="err">，</span><span class="n">就会生成专用的家目录</span>

<span class="n">root</span><span class="nv">@mon01</span><span class="p">:~</span><span class="c"># ls /etc/ceph/</span>
<span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">admin</span><span class="p">.</span><span class="n">keyring</span>  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>  <span class="n">rbdmap</span>  <span class="n">tmpzvyyulv9</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ceph配置文件就是</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span><span class="err">，</span><span class="n">该文件遵循</span> <span class="n">ini文件的语法格式</span><span class="err">。</span>

<span class="n">root</span><span class="nv">@mon01</span><span class="p">:~</span><span class="c"># cat /etc/ceph/ceph.conf</span>
<span class="no">[global]</span>
<span class="n">fsid</span> <span class="p">=</span> <span class="n">22fc9b8e</span><span class="p">-</span><span class="n">6d30</span><span class="p">-</span><span class="n">463d-b312</span><span class="p">-</span><span class="n">89dc91ee0969</span>
<span class="n">public_network</span> <span class="p">=</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
<span class="n">cluster_network</span> <span class="p">=</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
<span class="p">...</span>

<span class="no">[mon]</span>
<span class="n">mon</span> <span class="n">allow</span> <span class="n">pool</span> <span class="n">delete</span> <span class="p">=</span> <span class="n">true</span>
</code></pre></div>
<p>配置结构</p>
<div class="highlight"><pre><span></span><code><span class="n">对于ceph</span><span class="p">.</span><span class="n">conf文件来说</span><span class="err">，</span><span class="n">它主要有四部分组成</span><span class="err">：</span>
    <span class="no">[global]</span>    <span class="n">ceph存储的全局性配置</span>
    <span class="no">[osd]</span>       <span class="n">所有影响</span> <span class="n">Ceph</span> <span class="n">存储集群中</span> <span class="n">ceph-osd</span> <span class="n">守护进程的相关配置</span><span class="err">，</span><span class="n">会覆盖global的相同属性</span>
    <span class="no">[mon]</span>       <span class="n">所有影响</span> <span class="n">Ceph</span> <span class="n">存储集群中</span> <span class="n">ceph-mon</span> <span class="n">守护进程的相关配置</span><span class="err">，</span><span class="n">会覆盖global的相同属性</span>
    <span class="no">[client]</span>    <span class="n">所有影响</span> <span class="n">Ceph</span> <span class="n">客户端管理的相关配置</span><span class="err">，</span><span class="n">比如</span> <span class="n">块设备客户端</span><span class="err">、</span><span class="n">fs客户端</span><span class="err">、</span><span class="n">oss客户端等</span>

<span class="n">注意</span><span class="err">：</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf主要是针对整体来进行设置的</span><span class="err">，</span><span class="n">如果我们需要针对某一个对象来进行修改的话</span><span class="err">，</span><span class="n">可以使用</span>
    <span class="s2">&quot;对象.主机名|id&quot;</span> <span class="n">的方式来进行针对性定制</span><span class="err">。</span>
    <span class="n">比如</span><span class="err">：</span><span class="no">[mon.mon01]</span><span class="err">、</span><span class="no">[osd.1]</span>
</code></pre></div>
<p>配置文件的加载</p>
<div class="highlight"><pre><span></span><code><span class="n">对于ceph来说</span><span class="err">，</span><span class="n">它的配置文件</span><span class="err">，</span><span class="n">不仅仅有</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="n">一种样式</span><span class="err">，</span><span class="n">他还有更多的样式</span> <span class="p">--</span> <span class="n">主要是作用的范围不一样</span>

<span class="n">全局范围</span><span class="err">：</span>
    <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
    <span class="nv">$CEPH_CONF</span>
    <span class="n">-c</span> <span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="n">局部范围</span>
    <span class="p">~/.</span><span class="n">ceph</span><span class="p">/</span><span class="n">config</span>
    <span class="p">./</span><span class="n">ceph</span><span class="p">/</span><span class="n">conf</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>元参数</p>
<div class="highlight"><pre><span></span><code>    在ceph环境中，它提供了很多可以直接拿过来使用的元数据变量。这些变量可以直接从环境中获取到指定的信息，方便我们进行后续处理。
    这些信息，不仅仅可以在运行时使用，还可以在配置文件中进行定制。
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">常见的变量信息有</span><span class="err">：</span>
<span class="p">-</span> <span class="nv">$cluster</span><span class="err">：</span><span class="n">当前Ceph集群的名称</span>
<span class="p">-</span> <span class="nv">$type</span><span class="err">：</span><span class="n">当前服务的类型名称</span><span class="err">，</span><span class="n">可能会展开为osd或mon</span><span class="err">；</span>
<span class="p">-</span> <span class="nv">$id</span><span class="err">：</span><span class="n">进程的标识符</span><span class="err">，</span><span class="n">例如对osd</span><span class="p">.</span><span class="n">0来说</span><span class="err">，</span><span class="n">其标识符为0</span><span class="err">；</span>
<span class="p">-</span> <span class="nv">$host</span><span class="err">：</span><span class="n">守护进程所在主机的主机名</span><span class="err">；</span>
<span class="p">-</span> <span class="nv">$name</span><span class="err">：</span><span class="n">其值为</span><span class="nv">$type</span><span class="p">.</span><span class="nv">$id</span>
</code></pre></div>
<p>运行时使用</p>
<div class="highlight"><pre><span></span><code><span class="n">我们在ceph运行过程中</span><span class="err">，</span><span class="n">可以通过</span> <span class="n">以下方式来获取不同的属性信息内容</span>
    <span class="n">查看配置信息</span>
    <span class="n">ceph</span> <span class="n">daemon</span> <span class="p">{</span><span class="n">daemon-type</span><span class="p">}.{</span><span class="n">id</span><span class="p">}</span> <span class="n">config</span> <span class="n">show</span>
    <span class="n">查看帮助信息</span>
    <span class="n">ceph</span> <span class="n">daemon</span> <span class="p">{</span><span class="n">daemon-type</span><span class="p">}.{</span><span class="n">id</span><span class="p">}</span> <span class="n">help</span>
    <span class="n">查看指定参数信息</span>
    <span class="n">ceph</span> <span class="n">daemon</span> <span class="p">{</span><span class="n">daemon-type</span><span class="p">}.{</span><span class="n">id</span><span class="p">}</span> <span class="n">config</span> <span class="n">get</span> <span class="p">{</span><span class="k">parameter</span><span class="p">}</span>
    <span class="n">修改特定的信息</span>
    <span class="n">ceph</span> <span class="n">tell</span> <span class="p">{</span><span class="n">daemon-type</span><span class="p">}.{</span><span class="n">daemon</span> <span class="n">id</span> <span class="n">or</span> <span class="p">*}</span> <span class="n">injectargs</span> <span class="p">--{</span><span class="n">name</span><span class="p">}</span> <span class="p">{</span><span class="n">value</span><span class="p">}</span> <span class="p">[--{</span><span class="n">name</span><span class="p">}</span> <span class="p">{</span><span class="n">value</span><span class="p">}]</span>
    <span class="n">设定特定的属性</span>
    <span class="n">ceph</span> <span class="n">daemon</span> <span class="p">{</span><span class="n">daemon-type</span><span class="p">}.{</span><span class="n">id</span><span class="p">}</span> <span class="nb">set </span><span class="p">{</span><span class="n">name</span><span class="p">}</span> <span class="p">{</span><span class="n">value</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取所有配置属性</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config show</span>
<span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;osd.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="s2">&quot;ceph&quot;</span><span class="p">,</span>
    <span class="s2">&quot;admin_socket&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/run/ceph/ceph-osd.0.asok&quot;</span><span class="p">,</span>
    <span class="s2">&quot;admin_socket_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;threadpool_empty_queue_max_wait&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;throttler_perf_counter&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
<span class="p">}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config show | wc -l</span>
<span class="n">1644</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取帮助信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon mon.mon01 help</span>
<span class="p">{</span>
    <span class="s2">&quot;add_bootstrap_peer_hint&quot;</span><span class="p">:</span> <span class="s2">&quot;add peer address as potential bootstrap peer for cluster bringup&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;sessions&quot;</span><span class="p">:</span> <span class="s2">&quot;list existing sessions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;smart&quot;</span><span class="p">:</span> <span class="s2">&quot;Query health metrics for underlying device&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sync_force&quot;</span><span class="p">:</span> <span class="s2">&quot;force sync of and clear monitor store&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;get ceph version&quot;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取制定信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon mon.mon01 config get admin_socket</span>
<span class="p">{</span>
    <span class="s2">&quot;admin_socket&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/run/ceph/ceph-mon.mon01.asok&quot;</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config get admin_socket</span>
<span class="p">{</span>
    <span class="s2">&quot;admin_socket&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/run/ceph/ceph-osd.0.asok&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>更改属性</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前的属性信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config get debug_osd</span>
<span class="p">{</span>
    <span class="s2">&quot;debug_osd&quot;</span><span class="p">:</span> <span class="s2">&quot;1/5&quot;</span>
<span class="p">}</span>

<span class="n">修改制定的属性</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph tell osd.0 injectargs &#39;--debug-osd 0/5&#39;</span>

<span class="n">查看修改后的属性信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config get debug_osd</span>
<span class="p">{</span>
    <span class="s2">&quot;debug_osd&quot;</span><span class="p">:</span> <span class="s2">&quot;0/5&quot;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改制定的属性</span>
<span class="n">ceph</span> <span class="n">daemon</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">config</span> <span class="nb">set </span><span class="n">debug_osd</span> <span class="n">1</span><span class="p">/</span><span class="n">5</span>
<span class="n">ceph</span> <span class="n">daemon</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">config</span> <span class="n">get</span> <span class="n">debug_osd</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="153">1.5.3 磁盘管理<a class="headerlink" href="#153" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 场景需求、简单实践、小结 三个方面来学习。</p>
<p><strong>场景需求</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在ceph分布式存储集群里</span><span class="err">，</span><span class="n">数以千计万计的磁盘数量规模下</span><span class="err">，</span><span class="n">磁盘出现故障是不可避免</span><span class="err">，</span><span class="n">所以服务器更换故障磁盘就成为大规模机房的日常运维工作之一</span><span class="err">，</span><span class="n">而ceph存储集群中就需要在物理磁盘更换的前提下</span><span class="err">，</span><span class="n">需要不断重复的完成OSD磁盘的更换的操作</span><span class="err">。</span>
</code></pre></div>
<p>操作步骤</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在ceph集群环境中</span><span class="err">，</span><span class="n">主要有三套方法来实现磁盘的更换操作</span><span class="err">，</span><span class="n">但是这些操作各有优劣</span><span class="err">，</span><span class="n">甚至对于某些场景来说</span><span class="err">，</span><span class="n">不能够使用xx方式的磁盘更换操作</span><span class="err">，</span><span class="n">所以我们需要了解一下这些常见的磁盘管理操作</span><span class="err">。</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">这里主要介绍多种磁盘更换的思路和区别</span><span class="err">，</span><span class="n">里面的一些数据</span><span class="err">，</span><span class="n">仅供参考</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">更换方式1</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
    <span class="n">2</span> <span class="n">将移除OSD节点状态标记为out</span>
    <span class="n">3</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
    <span class="n">4</span> <span class="n">删除OSD节点和对应的认证信息</span>
    <span class="n">5</span> <span class="n">增加一个新的</span> <span class="n">OSD</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">1</span><span class="err">、</span><span class="n">2</span><span class="err">、</span><span class="n">3</span><span class="err">、</span><span class="n">4</span><span class="err">、</span><span class="n">5</span> <span class="n">这几步都会发生数据迁移的动作</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">更换方式2</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">修改osd的数据操作权重值</span><span class="err">，</span><span class="n">让数据不分布在这个节点上</span>
    <span class="n">2</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
    <span class="n">3</span> <span class="n">将移除OSD节点状态标记为out</span>
    <span class="n">4</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
    <span class="n">5</span> <span class="n">删除OSD节点和对应的认证信息</span>
    <span class="n">6</span> <span class="n">增加一个新的</span> <span class="n">OSD</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">1</span><span class="err">、</span><span class="n">5</span><span class="err">、</span><span class="n">6</span> <span class="n">这几步会发生数据迁移动作</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">更换方式3</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">对ceph集群的osd设置禁止数据迁移的标记</span>
    <span class="n">2</span> <span class="n">修改osd的数据操作权重值</span><span class="err">，</span><span class="n">让数据不分布在这个节点上</span>
    <span class="n">3</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
    <span class="n">4</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
    <span class="n">5</span> <span class="n">删除OSD节点和对应的认证信息</span>
    <span class="n">6</span> <span class="n">增加一个新的</span> <span class="n">OSD</span>
    <span class="n">7</span> <span class="n">移除ceph集群的osd禁止数据迁移标记</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">因为添加了标记</span><span class="err">，</span><span class="n">所以1</span><span class="p">-</span><span class="n">6这几步的数据迁移都不会执行</span><span class="err">，</span><span class="n">只有7这一步会发生数据迁移动作</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">如果想要查看每次数据迁移的状态</span><span class="err">，</span><span class="n">可以查看当前pg的状态效果</span>
    <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="n">pgs</span><span class="p">|</span><span class="n">awk</span> <span class="s1">&#39;{print $1,$15}&#39;</span><span class="p">|</span><span class="n">grep</span> <span class="n">-v</span> <span class="n">pg</span> <span class="p">&gt;</span> <span class="n">pg_base</span><span class="p">.</span><span class="n">txt</span>
    <span class="n">每次执行数据迁移动作后</span><span class="err">，</span><span class="n">可以再次保存</span><span class="err">，</span><span class="n">然后对比此次数据迁移的效果</span>
    <span class="nb">diff </span><span class="n">-y</span> <span class="n">-W</span> <span class="n">100</span> <span class="n">pg_end</span><span class="p">.</span><span class="n">txt</span> <span class="n">pg_base</span><span class="p">.</span><span class="n">txt</span> <span class="p">-</span><span class="n">-suppress-common-lines</span> <span class="p">|</span> <span class="n">wc</span> <span class="n">-l</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>磁盘更换方式1实践</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># systemctl  stop  ceph-osd@1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph osd tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>    <span class="n">down</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">将移除OSD节点状态标记为out</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph osd out 1</span>
<span class="n">marked</span> <span class="n">out</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph osd tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
 <span class="p">...</span>
 <span class="n">1</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>    <span class="n">down</span>        <span class="n">0</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">标记状态的改变</span><span class="err">，</span><span class="n">会导致pg的迁移</span><span class="err">，</span><span class="n">查看pgs的状态</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph pg dump pgs</span>
<span class="n">10</span><span class="p">.</span><span class="n">1d</span>         <span class="n">0</span>     <span class="p">...</span>   <span class="n">0</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span> <span class="p">...</span>
<span class="p">...</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">pg迁移过程中</span><span class="err">，</span><span class="n">会有一些异常状态</span> <span class="n">active</span><span class="p">+</span><span class="n">recovering</span><span class="p">+</span><span class="n">undersized</span><span class="p">+</span><span class="n">remapped</span> 

<span class="n">我们还有另外一种方式来进行检查数据迁移效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="p">...</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">7</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">20s</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">20s</span><span class="p">);</span> <span class="n">17</span> <span class="n">remapped</span> <span class="n">pgs</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>

  <span class="n">task</span> <span class="n">status</span><span class="p">:</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">10</span> <span class="n">pools</span><span class="p">,</span> <span class="n">352</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">270</span> <span class="n">objects</span><span class="p">,</span> <span class="n">60</span> <span class="n">MiB</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">6</span><span class="p">.</span><span class="n">4</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">114</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>     <span class="n">0</span><span class="p">.</span><span class="n">284</span><span class="p">%</span> <span class="n">pgs</span> <span class="n">not</span> <span class="n">active</span>
             <span class="n">158</span><span class="p">/</span><span class="n">810</span> <span class="n">objects</span> <span class="n">degraded</span> <span class="p">(</span><span class="n">19</span><span class="p">.</span><span class="n">506</span><span class="p">%)</span>
             <span class="n">14</span><span class="p">/</span><span class="n">810</span> <span class="n">objects</span> <span class="n">misplaced</span> <span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">728</span><span class="p">%)</span>
             <span class="n">327</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span>
             <span class="n">17</span>  <span class="n">active</span><span class="p">+</span><span class="n">recovery_wait</span><span class="p">+</span><span class="n">undersized</span><span class="p">+</span><span class="n">degraded</span><span class="p">+</span><span class="n">remapped</span>
             <span class="n">3</span>   <span class="n">active</span><span class="p">+</span><span class="n">recovery_wait</span><span class="p">+</span><span class="n">degraded</span>
             <span class="n">1</span>   <span class="n">active</span><span class="p">+</span><span class="n">recovery_wait</span>
             <span class="n">1</span>   <span class="n">active</span><span class="p">+</span><span class="n">recovery_wait</span><span class="p">+</span><span class="n">remapped</span>
             <span class="n">1</span>   <span class="n">active</span><span class="p">+</span><span class="n">recovering</span><span class="p">+</span><span class="n">degraded</span>
             <span class="n">1</span>   <span class="n">activating</span>
             <span class="n">1</span>   <span class="n">active</span><span class="p">+</span><span class="n">recovering</span><span class="p">+</span><span class="n">undersized</span><span class="p">+</span><span class="n">remapped</span>

  <span class="n">io</span><span class="p">:</span>
    <span class="n">recovery</span><span class="p">:</span> <span class="n">3</span><span class="p">.</span><span class="n">1</span> <span class="n">MiB</span><span class="p">/</span><span class="n">s</span><span class="p">,</span> <span class="n">4</span> <span class="n">objects</span><span class="p">/</span><span class="n">s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph osd crush remove osd.1</span>
<span class="n">removed</span> <span class="n">item</span> <span class="n">id</span> <span class="n">1</span> <span class="n">name</span> <span class="s1">&#39;osd.1&#39;</span> <span class="n">from</span> <span class="n">crush</span> <span class="n">map</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span> <span class="n">移除无效的osd节点</span><span class="p">,</span><span class="n">并移除认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">rm </span><span class="n">osd</span><span class="p">.</span><span class="n">1</span>
<span class="n">removed</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">del </span><span class="n">osd</span><span class="p">.</span><span class="n">1</span>
<span class="n">updated</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">5</span><span class="p">-</span><span class="n">1</span> <span class="n">清理磁盘</span>
<span class="n">dmsetup</span> <span class="n">status</span>
<span class="nb">cat </span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">osd</span><span class="p">/</span><span class="n">ceph</span><span class="p">-</span><span class="n">1</span><span class="p">/</span><span class="n">fsid</span>
<span class="n">dmsetup</span> <span class="n">remove</span> <span class="n">ceph</span><span class="p">-</span><span class="n">1的id</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>

<span class="n">5</span><span class="p">-</span><span class="n">2</span> <span class="n">擦除磁盘上的数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">zap</span> <span class="n">mon01</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>

<span class="n">5</span><span class="p">-</span><span class="n">3</span> <span class="n">添加磁盘数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">mon01</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<p>磁盘更换方式2实践</p>
<div class="highlight"><pre><span></span><code><span class="n">这次以mon02</span> <span class="n">主机为例</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># ceph osd tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">5</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon02</span>
 <span class="n">2</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">2</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">3</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">3</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">修改osd的数据操作权重值</span><span class="err">，</span><span class="n">让数据不分布在这个节点上</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># ceph osd crush reweight osd.3 0</span>
<span class="n">reweighted</span> <span class="n">item</span> <span class="n">id</span> <span class="n">3</span> <span class="n">name</span> <span class="s1">&#39;osd.3&#39;</span> <span class="n">to</span> <span class="n">0</span> <span class="k">in</span> <span class="n">crush</span> <span class="n">map</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># sudo systemctl stop ceph-osd@3</span>

<span class="n">3</span> <span class="n">将移除OSD节点状态标记为out</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">out</span> <span class="n">osd</span><span class="p">.</span><span class="n">3</span>
<span class="n">marked</span> <span class="n">out</span> <span class="n">osd</span><span class="p">.</span><span class="n">3</span><span class="p">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># ceph osd crush remove osd.3</span>
<span class="n">removed</span> <span class="n">item</span> <span class="n">id</span> <span class="n">3</span> <span class="n">name</span> <span class="s1">&#39;osd.3&#39;</span> <span class="n">from</span> <span class="n">crush</span> <span class="n">map</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">5</span> <span class="n">移除无效的osd节点后删除认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">rm </span><span class="n">osd</span><span class="p">.</span><span class="n">3</span>
<span class="n">removed</span> <span class="n">osd</span><span class="p">.</span><span class="n">3</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">del </span><span class="n">osd</span><span class="p">.</span><span class="n">3</span>
<span class="n">updated</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">6</span><span class="p">-</span><span class="n">1</span> <span class="n">清理磁盘</span>
<span class="n">dmsetup</span> <span class="n">status</span>
<span class="nb">cat </span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">osd</span><span class="p">/</span><span class="n">ceph</span><span class="p">-</span><span class="n">2</span><span class="p">/</span><span class="n">fsid</span>
<span class="n">dmsetup</span> <span class="n">remove</span> <span class="n">ceph</span><span class="p">-</span><span class="n">3的id</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>

<span class="n">6</span><span class="p">-</span><span class="n">2</span> <span class="n">擦除磁盘上的数据后添加磁盘</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">zap</span> <span class="n">mon02</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">mon02</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<p>磁盘更换方式3实践</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">对ceph集群的osd设置禁止数据迁移的标记</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set </span><span class="n">norebalance</span>
<span class="n">norebalance</span> <span class="n">is</span> <span class="nb">set</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set </span><span class="n">nobackfill</span>
<span class="n">nobackfill</span> <span class="n">is</span> <span class="nb">set</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set </span><span class="n">norecover</span>
<span class="n">norecover</span> <span class="n">is</span> <span class="nb">set</span>

<span class="n">查看状态后</span><span class="err">，</span><span class="n">osd会有相应标签</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="p">...</span>
  <span class="n">services</span><span class="p">:</span>
    <span class="p">...</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">16m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">16m</span><span class="p">)</span>
         <span class="n">flags</span> <span class="n">nobackfill</span><span class="p">,</span><span class="n">norebalance</span><span class="p">,</span><span class="n">norecover</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">修改osd的数据操作权重值</span><span class="err">，</span><span class="n">让数据不分布在这个节点上</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">reweight</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">0</span>
<span class="n">reweighted</span> <span class="n">item</span> <span class="n">id</span> <span class="n">5</span> <span class="n">name</span> <span class="s1">&#39;osd.5&#39;</span> <span class="n">to</span> <span class="n">0</span> <span class="k">in</span> <span class="n">crush</span> <span class="n">map</span>

<span class="n">因为集群已经禁止数据迁移了</span><span class="err">，</span><span class="n">所以这个时候</span><span class="err">，</span><span class="n">并不会发生数据迁移动作</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">1d4e5773</span><span class="p">-</span><span class="n">619a</span><span class="p">-</span><span class="n">479d</span><span class="p">-</span><span class="n">861a</span><span class="p">-</span><span class="n">66ba451ce945</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
            <span class="n">nobackfill</span><span class="p">,</span><span class="n">norebalance</span><span class="p">,</span><span class="n">norecover</span> <span class="n">flag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="nb">set</span>
            <span class="n">Reduced</span> <span class="n">data</span> <span class="n">availability</span><span class="p">:</span> <span class="n">16</span> <span class="n">pgs</span> <span class="n">inactive</span><span class="p">,</span> <span class="n">20</span> <span class="n">pgs</span> <span class="n">peering</span>
            <span class="n">Degraded</span> <span class="n">data</span> <span class="n">redundancy</span><span class="p">:</span> <span class="n">104</span><span class="p">/</span><span class="n">810</span> <span class="n">objects</span> <span class="n">degraded</span> <span class="p">(</span><span class="n">12</span><span class="p">.</span><span class="n">840</span><span class="p">%),</span> <span class="n">30</span> <span class="n">pgs</span> <span class="n">degraded</span><span class="p">,</span> <span class="n">1</span> <span class="n">pg</span> <span class="n">undersized</span>
    <span class="p">...</span>
  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">10</span> <span class="n">pools</span><span class="p">,</span> <span class="n">352</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">270</span> <span class="n">objects</span><span class="p">,</span> <span class="n">60</span> <span class="n">MiB</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">6</span><span class="p">.</span><span class="n">5</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">114</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>     <span class="n">27</span><span class="p">.</span><span class="n">273</span><span class="p">%</span> <span class="n">pgs</span> <span class="n">not</span> <span class="n">active</span>
             <span class="n">104</span><span class="p">/</span><span class="n">810</span> <span class="n">objects</span> <span class="n">degraded</span> <span class="p">(</span><span class="n">12</span><span class="p">.</span><span class="n">840</span><span class="p">%)</span>
             <span class="n">6</span><span class="p">/</span><span class="n">810</span> <span class="n">objects</span> <span class="n">misplaced</span> <span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="n">741</span><span class="p">%)</span>
             <span class="n">226</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span>
             <span class="n">95</span>  <span class="n">peering</span>
             <span class="n">16</span>  <span class="n">active</span><span class="p">+</span><span class="n">recovery_wait</span><span class="p">+</span><span class="n">degraded</span>
             <span class="n">14</span>  <span class="n">active</span><span class="p">+</span><span class="n">recovery_wait</span><span class="p">+</span><span class="n">undersized</span><span class="p">+</span><span class="n">degraded</span><span class="p">+</span><span class="n">remapped</span>
             <span class="n">1</span>   <span class="n">remapped</span><span class="p">+</span><span class="n">peering</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span> <span class="n">到指定节点上</span><span class="err">，</span><span class="n">停止指定的osd进程</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># sudo systemctl stop ceph-osd@5</span>

<span class="n">4</span> <span class="n">从crush中移除OSD节点</span><span class="err">，</span><span class="n">该节点不作为数据的载体</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># ceph osd crush remove osd.5</span>
<span class="n">removed</span> <span class="n">item</span> <span class="n">id</span> <span class="n">5</span> <span class="n">name</span> <span class="s1">&#39;osd.5&#39;</span> <span class="n">from</span> <span class="n">crush</span> <span class="n">map</span>

<span class="n">5</span> <span class="n">移除无效的osd节点后删除认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">rm </span><span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="n">removed</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">del </span><span class="n">osd</span><span class="p">.</span><span class="n">5</span>
<span class="n">updated</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">6</span><span class="p">-</span><span class="n">1</span> <span class="n">清理磁盘</span>
<span class="n">dmsetup</span> <span class="n">status</span>
<span class="nb">cat </span><span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">osd</span><span class="p">/</span><span class="n">ceph</span><span class="p">-</span><span class="n">5</span><span class="p">/</span><span class="n">fsid</span>
<span class="n">dmsetup</span> <span class="n">remove</span> <span class="n">ceph</span><span class="p">-</span><span class="n">5的id</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext4</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>

<span class="n">6</span><span class="p">-</span><span class="n">2</span> <span class="n">擦除磁盘上的数据后添加磁盘</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">disk</span> <span class="n">zap</span> <span class="n">mon03</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">osd</span> <span class="n">create</span> <span class="n">mon03</span> <span class="p">-</span><span class="n">-data</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">sdc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">7</span> <span class="n">移除ceph集群的osd禁止数据迁移标记</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">norebalance</span>
<span class="n">norebalance</span> <span class="n">is</span> <span class="n">unset</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">nobackfill</span>
<span class="n">nobackfill</span> <span class="n">is</span> <span class="n">unset</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">norecover</span>
<span class="n">norecover</span> <span class="n">is</span> <span class="n">unset</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">稍等一会查看ceph的状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="p">...</span>
  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">10</span> <span class="n">pools</span><span class="p">,</span> <span class="n">352</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">270</span> <span class="n">objects</span><span class="p">,</span> <span class="n">60</span> <span class="n">MiB</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">6</span><span class="p">.</span><span class="n">5</span> <span class="n">GiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">113</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>     <span class="n">352</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">这个时候</span><span class="err">，</span><span class="n">才会发生数据迁移的动作</span>
</code></pre></div>
<p>生产技巧</p>
<div class="highlight"><pre><span></span><code>    <span class="n">当我们遇到ceph宿主机重启的场景</span><span class="err">，</span><span class="n">如果不想发生频繁的数据迁移动作</span><span class="err">，</span><span class="n">可以手工临时禁用ceph自带数据恢复平衡功能即可</span>

<span class="n">禁用ceph集群数据迁移</span><span class="err">：</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set </span><span class="n">noout</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set </span><span class="n">nobackfill</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set </span><span class="n">norecover</span>
<span class="n">启用ceph集群数据迁移</span><span class="err">：</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">noout</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">nobackfill</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">norecover</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="154">1.5.4 性能调优<a class="headerlink" href="#154" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、常见策略、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">性能优化没有一个标准的定义</span><span class="err">，</span><span class="n">如果用大白话来说的话</span><span class="err">，</span><span class="n">他就是在现有主机资源的前提下</span><span class="err">，</span><span class="n">发挥业务最大的处理能力</span><span class="err">。</span><span class="n">也理解为</span><span class="err">：</span><span class="n">通过空间</span><span class="p">(</span><span class="n">资源消耗</span><span class="p">)</span><span class="n">优化换取时间</span><span class="p">(</span><span class="n">业务处理</span><span class="p">)</span><span class="n">效益</span>
    <span class="n">它主要体现在几个方面</span><span class="err">：</span><span class="n">改善业务逻辑处理的速度</span><span class="err">、</span><span class="n">提升业务数据吞吐量</span><span class="err">、</span><span class="n">优化主机资源的消耗量</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">性能优化没有一个基准值</span><span class="err">，</span><span class="n">我们只能通过自我或者普遍的场景工作经验</span><span class="err">，</span><span class="n">设定一个阶段性的目标</span><span class="err">，</span><span class="n">然后通过物理手段</span><span class="err">、</span><span class="n">配置手段</span><span class="err">、</span><span class="n">代码手段等方式提高主机资源的业务处理能力</span><span class="err">。</span>
</code></pre></div>
<p>通用处理措施</p>
<div class="highlight"><pre><span></span><code><span class="n">基础设施</span>
    <span class="n">合适设备</span> <span class="p">-</span> <span class="n">多云环境</span><span class="err">、</span><span class="n">新旧服务器结合</span><span class="err">、</span><span class="n">合适网络等</span>
    <span class="n">研发环境</span> <span class="p">-</span> <span class="n">应用架构</span><span class="err">、</span><span class="n">研发平台</span><span class="err">、</span><span class="n">代码规范等</span>
<span class="n">应用软件</span>
    <span class="n">多级缓存</span> <span class="p">-</span> <span class="n">浏览器缓存</span><span class="err">、</span><span class="n">缓存服务器</span><span class="err">、</span><span class="n">服务器缓存</span><span class="err">、</span><span class="n">应用缓存</span><span class="err">、</span><span class="n">代码缓存</span><span class="err">、</span><span class="n">数据缓存等</span><span class="err">。</span>
    <span class="n">数据压缩</span> <span class="p">-</span> <span class="n">数据构建压缩</span><span class="err">、</span><span class="n">数据传输压缩</span><span class="err">、</span><span class="n">缓存数据压缩</span><span class="err">、</span><span class="n">数据对象压缩</span><span class="err">、</span><span class="n">清理无效数据等</span><span class="err">。</span>
    <span class="n">数据预热</span> <span class="p">-</span> <span class="n">缓冲数据</span><span class="err">、</span><span class="n">预取数据</span><span class="err">、</span><span class="n">预置主机</span><span class="err">、</span><span class="n">数据同步等</span><span class="err">。</span>
<span class="n">业务处理</span>
    <span class="n">削峰填谷</span> <span class="p">-</span> <span class="n">延时加载</span><span class="err">、</span><span class="n">分批发布</span><span class="err">、</span><span class="n">限流控制</span><span class="err">、</span><span class="n">异步处理</span><span class="err">、</span><span class="n">超时降级等</span>
    <span class="n">任务批处理</span> <span class="p">-</span> <span class="n">数据打包传输</span><span class="err">、</span><span class="n">数据批量传输</span><span class="err">、</span><span class="n">延迟数据处理等</span>
</code></pre></div>
<p>ceph环境</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph分布式存储环境是以集群服务器来进行承载存储服务的</span><span class="err">，</span><span class="n">所以对于Ceph的性能优化主要体现在基础设施层的合适设备</span><span class="err">、</span><span class="n">应用项目的多级缓存和数据压缩</span><span class="err">、</span><span class="n">业务处理的任务批处理</span><span class="err">。</span>
</code></pre></div>
<p><strong>常见策略</strong></p>
<p>基础设施</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph集群的各个服务守护进程在</span> <span class="n">Linux</span> <span class="n">服务器上运行</span><span class="err">，</span><span class="n">所以适当调优操作系统能够对ceph存储集群的性能产生积极的影响</span><span class="err">。</span><span class="n">它主要涉及到以下几个方面</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">选择合适的CPU和内存</span><span class="err">。</span>
        <span class="n">不同角色具有不同的</span> <span class="n">CPU</span> <span class="n">需求</span><span class="err">，</span><span class="n">MDS</span><span class="p">(</span><span class="n">4</span><span class="p">)&gt;</span><span class="n">OSD</span><span class="p">(</span><span class="n">2</span><span class="p">)&gt;</span><span class="n">MON</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="err">，</span><span class="n">纠删代码功能需要更多</span> <span class="n">CPU</span><span class="err">。</span>
        <span class="n">不同角色具有不同的</span> <span class="n">内存</span> <span class="n">需求</span><span class="err">，</span><span class="n">MON</span><span class="p">&gt;</span><span class="n">OSD</span>
    <span class="p">-</span> <span class="n">选择合适的磁盘容量</span> 
        <span class="n">合理评估阶段性业务量</span><span class="err">，</span><span class="n">计算节点数量及各个节点的磁盘容量需求</span><span class="err">。</span>
        <span class="n">选择合适的</span> <span class="n">SAS</span><span class="err">、</span><span class="n">SATA</span><span class="err">、</span><span class="n">SSD</span><span class="err">，</span><span class="n">实现分级存储的能力</span><span class="err">。</span>
        <span class="n">OS系统</span><span class="err">、</span><span class="n">数据</span><span class="err">、</span><span class="n">日志使用独立的SSD硬盘</span><span class="err">，</span><span class="n">使整体吞吐量最大化</span>
    <span class="p">-</span> <span class="n">选择合适的网络设备</span>
        <span class="n">Ceph集群对于网络数据传输能力要求高</span><span class="err">，</span><span class="n">需要支持巨型帧</span><span class="p">(</span><span class="n">9000字节</span><span class="err">，</span><span class="n">默认1500字节</span><span class="p">)</span><span class="n">功能</span>
        <span class="n">Ceph集群数据传输量很大</span><span class="err">，</span><span class="n">需要所有设备的</span> <span class="n">MTU</span> <span class="n">设置必须一致</span>
        <span class="n">如果可以的话</span><span class="err">，</span><span class="n">网络带宽一定要大</span><span class="err">，</span><span class="n">最好以3倍需求量的方式采购</span>
    <span class="p">-</span> <span class="n">配置合适的文件系统</span>
        <span class="n">推荐使用vfs文件系统</span><span class="err">，</span><span class="n">ceph借助于xfs扩展属性在创建和挂载文件系统场景中提高索引数据缓存</span>
        <span class="n">osd_mkfs_options_xfs</span><span class="err">、</span><span class="n">osd_mount_options_xfs</span>
    <span class="p">-</span> <span class="n">搭建内部时间服务器</span>
        <span class="n">ceph集群对于时间要求比较高</span><span class="err">，</span><span class="n">为了保证数据的通信一致性</span><span class="err">，</span><span class="n">最好采用内部时间服务器</span>
    <span class="p">-</span> <span class="n">合理采用多云环境</span>
        <span class="n">将合适的业务负载转移到公有云环境</span><span class="err">。</span>
</code></pre></div>
<p>应用软件</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph集群的很多功能都是以各种服务配置的方式来进行实现的</span><span class="err">，</span><span class="n">所以我们有必要结合不同的配置属性</span><span class="err">，</span><span class="n">实现ceph集群环境级别的性能优化</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">数据访问</span>
        <span class="n">采用public网络和cluster网络机制</span><span class="err">，</span><span class="n">实现数据操作网络的可靠性</span><span class="err">，</span><span class="n">避免外部网络攻击的安全性</span><span class="err">。</span>
        <span class="n">配置属性</span><span class="err">：</span><span class="n">public_network</span><span class="err">、</span><span class="n">cluster_network</span><span class="err">、</span><span class="n">max_open_file等</span>
    <span class="p">-</span> <span class="n">数据存储</span>
        <span class="n">设定合理的存储池的PG</span> <span class="n">数量</span><span class="err">，</span><span class="n">集群PGs总数</span> <span class="p">=</span> <span class="p">(</span><span class="n">OSD总数</span> <span class="p">*</span> <span class="n">100</span> <span class="p">/</span> <span class="n">最大副本数</span><span class="p">)</span>
        <span class="n">更多数据存储规划</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">rados</span><span class="p">/</span><span class="n">operations</span><span class="p">/</span><span class="n">placement-groups</span><span class="p">/</span><span class="c">#choosing-the-number-of-placement-groups</span>
    <span class="p">-</span> <span class="n">多级缓存</span>
        <span class="n">根据实际情况开启RDBCache</span><span class="p">(</span><span class="n">rbd_cache_xxx</span><span class="p">)</span><span class="err">、</span><span class="n">RGWCache</span><span class="p">(</span><span class="n">rgw_cache_xxx</span><span class="p">)</span><span class="err">、</span><span class="n">OSDCache</span><span class="err">、</span><span class="n">MDSCache</span>
        <span class="n">建立合理的SSD缓存pool</span><span class="err">，</span><span class="n">设定合理的cache</span> <span class="n">age</span><span class="err">、</span><span class="n">target</span> <span class="n">size</span> <span class="n">等参数</span>
        <span class="n">理清业务场景</span><span class="err">，</span><span class="n">根据缓存模式</span><span class="p">(</span><span class="nb">write-back</span><span class="err">、</span><span class="n">readproxy</span><span class="err">、</span><span class="n">readonly等</span><span class="p">)</span><span class="err">，</span><span class="n">启用cache-tiering机制</span><span class="err">。</span>
</code></pre></div>
<p>业务处理</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph集群在大规模数据处理的时候</span><span class="err">，</span><span class="n">可以通过数据批处理能力来实现数据的高效传输</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">数据批处理</span>
        <span class="n">filestore_max</span><span class="p">|</span><span class="n">min_sync_interval</span> <span class="n">从日志到数据盘最大</span><span class="p">|</span><span class="n">小同步间隔</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
        <span class="n">filestore_queue_max_ops</span><span class="p">|</span><span class="n">bytes</span> <span class="n">数据盘单次最大接受的操作数</span><span class="p">|</span><span class="n">字节数</span>
        <span class="n">filestore_queue_committing_max_ops</span><span class="p">|</span><span class="n">bytes</span> <span class="n">数据盘单次最大处理的操作数</span><span class="p">|</span><span class="n">字节数</span>
        <span class="n">journal_max_write_ops</span><span class="p">|</span><span class="n">bytes</span> <span class="n">日志一次性写入的最大操作数</span><span class="p">|</span><span class="n">字节数</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
        <span class="n">journal_queue_max_ops</span><span class="p">|</span><span class="n">bytes</span> <span class="n">日志一次性查询的最大操作数</span><span class="p">|</span><span class="n">字节数</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
        <span class="n">osd_max_write_size</span>  <span class="n">OSD一次可写入的最大值</span><span class="p">(</span><span class="n">MB</span><span class="p">)</span>
        <span class="n">osd_recovery_max_active</span> <span class="n">同一时间内活跃的恢复请求数</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="155">1.5.5 性能测试<a class="headerlink" href="#155" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基准测试、rados测试、小结 三个方面来学习。</p>
<p><strong>基准测试</strong></p>
<p>磁盘测试</p>
<div class="highlight"><pre><span></span><code><span class="n">准备工作</span><span class="p">-</span><span class="n">清理缓存</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># echo 3 &gt; /proc/sys/vm/drop_caches^C</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># cat /proc/sys/vm/drop_caches</span>
<span class="n">0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># echo 3 &gt; /proc/sys/vm/drop_caches</span>

<span class="n">查看磁盘</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># ls /var/lib/ceph/osd/</span>
<span class="n">ceph</span><span class="p">-</span><span class="n">4</span>  <span class="n">ceph</span><span class="p">-</span><span class="n">5</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">OSD</span> <span class="n">磁盘写性能</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># dd if=/dev/zero of=/var/lib/ceph/osd/ceph-4/write_test bs=1M count=100</span>
<span class="p">...</span>
<span class="n">104857600字节</span><span class="p">(</span><span class="n">105</span> <span class="n">MB</span><span class="p">)</span><span class="n">已复制</span><span class="err">，</span><span class="n">0</span><span class="p">.</span><span class="n">4009</span> <span class="n">秒</span><span class="err">，</span><span class="n">262</span> <span class="n">MB</span><span class="p">/</span><span class="n">秒</span>

<span class="n">OSD</span> <span class="n">磁盘读性能</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># dd if=/var/lib/ceph/osd/ceph-4/write_test of=/dev/null bs=1M count=100</span>
<span class="p">...</span>
<span class="n">104857600字节</span><span class="p">(</span><span class="n">105</span> <span class="n">MB</span><span class="p">)</span><span class="n">已复制</span><span class="err">，</span><span class="n">0</span><span class="p">.</span><span class="n">0233439</span> <span class="n">秒</span><span class="err">，</span><span class="n">4</span><span class="p">.</span><span class="n">5</span> <span class="n">GB</span><span class="p">/</span><span class="n">秒</span>

<span class="n">清理环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># rm -f /var/lib/ceph/osd/ceph-4/write_test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">www</span><span class="p">.</span><span class="n">thomas-krenn</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">wiki</span><span class="p">/</span><span class="n">Linux_I</span><span class="p">/</span><span class="n">O_Performance_Tests_using_dd</span>
</code></pre></div>
<p>网络测试</p>
<div class="highlight"><pre><span></span><code><span class="n">在多台主机上准备网络基准测试工具</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">iperf</span> <span class="n">-y</span>
<span class="n">服务端命令参数</span>
    <span class="n">-s</span> <span class="n">以server模式启动</span>
    <span class="n">-p</span> <span class="n">指定服务器端使用的端口或客户端所连接的端口</span>
<span class="n">客户端命令参数</span>
    <span class="n">-d</span> <span class="n">同时进行双向传输测试</span>
    <span class="n">-n</span> <span class="n">指定传输的字节数</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">节点1执行命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># iperf -s -p 6900</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">客户端执行命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># iperf -c admin -p 6900</span>
<span class="p">------------------------------------------------------------</span>
<span class="n">Client</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">admin</span><span class="p">,</span> <span class="n">TCP</span> <span class="n">port</span> <span class="n">6900</span>
<span class="n">TCP</span> <span class="n">window</span> <span class="n">size</span><span class="p">:</span>  <span class="n">552</span> <span class="n">KByte</span> <span class="p">(</span><span class="k">default</span><span class="p">)</span>
<span class="p">------------------------------------------------------------</span>
<span class="p">[</span>  <span class="n">3</span><span class="p">]</span> <span class="n">local</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">port</span> <span class="n">48376</span> <span class="n">connected</span> <span class="n">with</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">port</span> <span class="n">6900</span>
<span class="p">[</span> <span class="n">ID</span><span class="p">]</span> <span class="n">Interval</span>       <span class="n">Transfer</span>     <span class="n">Bandwidth</span>
<span class="p">[</span>  <span class="n">3</span><span class="p">]</span>  <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span> <span class="n">sec</span>  <span class="n">2</span><span class="p">.</span><span class="n">58</span> <span class="n">GBytes</span>  <span class="n">2</span><span class="p">.</span><span class="n">21</span> <span class="n">Gbits</span><span class="p">/</span><span class="n">sec</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">无论是磁盘测试还是网络测试</span><span class="err">，</span><span class="n">都需要多次测试后</span><span class="err">，</span><span class="n">获取平均值效果</span>
</code></pre></div>
<p><strong>rados测试</strong></p>
<p>bench性能测试工具</p>
<div class="highlight"><pre><span></span><code><span class="n">它是Ceph</span> <span class="n">自带的</span> <span class="n">rados</span> <span class="n">bench</span> <span class="n">测试工具</span><span class="err">，</span><span class="n">命令格式如下</span><span class="err">：</span>
    <span class="n">rados</span> <span class="n">bench</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">存储池</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">秒数</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">操作模式</span><span class="p">&gt;</span> <span class="n">-b</span> <span class="p">&lt;</span><span class="n">块大小</span><span class="p">&gt;</span> <span class="n">-t</span> <span class="n">并行数</span> <span class="p">-</span><span class="n">-no-cleanup</span>
<span class="n">参数解读</span><span class="err">：</span>
    <span class="n">操作模式</span><span class="err">：</span><span class="n">包括三种</span><span class="err">，</span><span class="n">分别是write</span><span class="err">：</span><span class="n">写</span><span class="err">，</span><span class="n">seq</span><span class="err">：</span><span class="n">顺序读</span><span class="err">；</span><span class="n">rand</span><span class="err">：</span><span class="n">随机读</span>
    <span class="n">块大小</span><span class="err">：</span><span class="n">默认为4M</span>
    <span class="n">并行数</span><span class="p">:</span> <span class="n">读</span><span class="p">/</span><span class="n">写并行数</span><span class="err">，</span><span class="n">默认为</span> <span class="n">16</span>
    <span class="p">-</span><span class="n">-no-cleanup</span> <span class="n">表示测试完成后不删除测试用数据</span><span class="err">。</span>
        <span class="p">-</span> <span class="n">在做读测试之前</span><span class="err">，</span><span class="n">需要使用该参数来运行一遍写测试来产生测试数据</span><span class="err">，</span>
        <span class="p">-</span> <span class="n">在测试结束后运行</span> <span class="n">rados</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">存储池</span><span class="p">&gt;</span> <span class="n">cleanup</span> <span class="n">清理测试数据</span><span class="err">。</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">曾经的bench-write已经被整合到bench中了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建测试存储池</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># ceph osd pool create pool-test 32 32</span>
<span class="n">pool</span> <span class="s1">&#39;pool-test&#39;</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">写测试</span><span class="err">：</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># rados bench -p pool-test 10 write --no-cleanup</span>
<span class="n">hints</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">Maintaining</span> <span class="n">16</span> <span class="n">concurrent</span> <span class="n">writes</span> <span class="n">of</span> <span class="n">4194304</span> <span class="n">bytes</span> <span class="n">to</span> <span class="n">objects</span> <span class="n">of</span> <span class="n">size</span> <span class="n">4194304</span> <span class="k">for</span> <span class="n">up</span> <span class="n">to</span> <span class="n">10</span> <span class="n">seconds</span> <span class="n">or</span> <span class="n">0</span> <span class="n">objects</span>
<span class="n">Object</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">benchmark_data_admin_5683</span>
  <span class="n">sec</span> <span class="n">Cur</span> <span class="n">ops</span>   <span class="n">started</span>  <span class="n">finished</span>  <span class="n">avg</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">cur</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span> <span class="n">last</span> <span class="n">lat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="n">avg</span> <span class="n">lat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">0</span>       <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>           <span class="p">-</span>           <span class="n">0</span>
    <span class="p">...</span>
   <span class="n">10</span>      <span class="n">16</span>       <span class="n">147</span>       <span class="n">131</span>   <span class="n">52</span><span class="p">.</span><span class="n">3689</span>        <span class="n">64</span>     <span class="n">1</span><span class="p">.</span><span class="n">18095</span>     <span class="n">1</span><span class="p">.</span><span class="n">16048</span>
<span class="n">Total</span> <span class="n">time</span> <span class="n">run</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">9577</span>
<span class="p">...</span>
<span class="n">Min</span> <span class="n">latency</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>         <span class="n">0</span><span class="p">.</span><span class="n">202</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">顺序读测试</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># rados bench -p pool-test 10 seq</span>
<span class="n">hints</span> <span class="p">=</span> <span class="n">1</span>
  <span class="n">sec</span> <span class="n">Cur</span> <span class="n">ops</span>   <span class="n">started</span>  <span class="n">finished</span>  <span class="n">avg</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">cur</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span> <span class="n">last</span> <span class="n">lat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="n">avg</span> <span class="n">lat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">0</span>       <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>           <span class="p">-</span>           <span class="n">0</span>
    <span class="p">...</span>
   <span class="n">10</span>      <span class="n">15</span>       <span class="n">139</span>       <span class="n">124</span>   <span class="n">45</span><span class="p">.</span><span class="n">0608</span>         <span class="n">8</span>     <span class="n">9</span><span class="p">.</span><span class="n">09797</span>     <span class="n">0</span><span class="p">.</span><span class="n">93913</span>
<span class="n">Total</span> <span class="n">time</span> <span class="n">run</span><span class="p">:</span>       <span class="n">11</span><span class="p">.</span><span class="n">5093</span>
<span class="p">...</span>
<span class="n">Min</span> <span class="n">latency</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>       <span class="n">0</span><span class="p">.</span><span class="n">0240264</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">随机读测试</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># rados bench -p pool-test 10 rand</span>
<span class="n">hints</span> <span class="p">=</span> <span class="n">1</span>
  <span class="n">sec</span> <span class="n">Cur</span> <span class="n">ops</span>   <span class="n">started</span>  <span class="n">finished</span>  <span class="n">avg</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span>  <span class="n">cur</span> <span class="n">MB</span><span class="p">/</span><span class="n">s</span> <span class="n">last</span> <span class="n">lat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="n">avg</span> <span class="n">lat</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">0</span>       <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>         <span class="n">0</span>           <span class="p">-</span>           <span class="n">0</span>
    <span class="p">...</span>
   <span class="n">10</span>      <span class="n">16</span>       <span class="n">589</span>       <span class="n">573</span>   <span class="n">229</span><span class="p">.</span><span class="n">081</span>       <span class="n">244</span>     <span class="n">0</span><span class="p">.</span><span class="n">20209</span>    <span class="n">0</span><span class="p">.</span><span class="n">272096</span>
<span class="n">Total</span> <span class="n">time</span> <span class="n">run</span><span class="p">:</span>       <span class="n">10</span><span class="p">.</span><span class="n">2428</span>
<span class="p">...</span>
<span class="n">Min</span> <span class="n">latency</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>       <span class="n">0</span><span class="p">.</span><span class="n">0225745</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">清理环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">~]</span><span class="c"># rados -p pool-test cleanup</span>
<span class="n">Removed</span> <span class="n">148</span> <span class="n">objects</span>
</code></pre></div>
<p>load-gen性能测试工具</p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph</span> <span class="n">自带的</span> <span class="n">rados</span> <span class="n">性能测试工具</span><span class="err">，</span><span class="n">可在集群内产生混合类型的负载</span><span class="err">，</span><span class="n">相较于bench</span><span class="err">，</span><span class="n">load-gen只做吞吐量测试</span><span class="err">。</span><span class="n">命令格式如下</span><span class="err">：</span>
    <span class="n">rados</span> <span class="n">-p</span> <span class="n">存储池</span> <span class="n">load-gen</span> 
<span class="n">参数解读</span><span class="err">：</span>
    <span class="p">...</span>
    <span class="p">-</span><span class="n">-num-objects</span>       <span class="c"># 初始生成测试用的对象数</span>
    <span class="p">-</span><span class="n">-min-object-size</span>   <span class="c"># 最小对象大小</span>
    <span class="p">-</span><span class="n">-max-object-size</span>   <span class="c"># 最大对象大小</span>
    <span class="p">-</span><span class="n">-max-ops</span>           <span class="c"># 最大操作数目</span>
    <span class="p">-</span><span class="n">-min-op-len</span>        <span class="c"># 最小操作长度，相当于iodepth</span>
    <span class="p">-</span><span class="n">-max-op-len</span>        <span class="c"># 最大操作长度</span>
    <span class="p">-</span><span class="n">-read-percent</span>      <span class="c"># 读操作的百分比</span>
    <span class="p">-</span><span class="n">-target-throughput</span> <span class="c"># 单次提交IO的累计吞吐量上线，单位 MB/s</span>
    <span class="p">-</span><span class="n">-run-length</span>        <span class="c"># 运行时长，单位秒</span>
    <span class="p">-</span><span class="n">-percent</span>           <span class="c"># 读写混合中，读操作占用比例</span>
    <span class="p">-</span><span class="n">-max_backlog</span>       <span class="c"># 单次提交IO的吞吐量上限</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">iodepth就是io队列深度</span><span class="p">(</span><span class="n">io队列里面允许出现几个命令等待操作</span><span class="p">)</span><span class="err">，</span><span class="n">它的作用是</span>
        <span class="p">-</span> <span class="n">控制硬盘操作的过程中的负载情况</span><span class="err">，</span><span class="n">避免系统一直发送指令</span><span class="err">，</span><span class="n">出现磁盘受不了导致系统崩溃的现象</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在pool-test存储池中</span><span class="err">，</span><span class="n">初始对象50个</span><span class="err">，</span><span class="n">单次io的最大数量16</span><span class="err">，</span><span class="n">顺序写入4M的数据块</span><span class="p">,</span><span class="n">测试时间10秒</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon03</span> <span class="p">~]</span><span class="c"># rados -p pool-test load-gen --num-objects 50 --min-object-size 4M --max-object-size 4M --max-object-size 4M --max-ops 16 --min-op-len 4M  --max-op-len 4M --percent 5 --target-throughput 40 --run-length 10</span>
<span class="n">run</span> <span class="n">length</span> <span class="n">10</span> <span class="n">seconds</span>
<span class="n">preparing</span> <span class="n">50</span> <span class="n">objects</span>
<span class="n">load-gen</span> <span class="n">will</span> <span class="n">run</span> <span class="n">10</span> <span class="n">seconds</span>
    <span class="n">1</span><span class="p">:</span> <span class="n">throughput</span><span class="p">=</span><span class="n">0MB</span><span class="p">/</span><span class="n">sec</span> <span class="n">pending</span> <span class="n">data</span><span class="p">=</span><span class="n">0</span>
<span class="n">READ</span> <span class="p">:</span> <span class="n">oid</span><span class="p">=</span><span class="n">obj-AF5uiLtTtxSNSNR</span> <span class="n">off</span><span class="p">=</span><span class="n">0</span> <span class="n">len</span><span class="p">=</span><span class="n">4194304</span>
<span class="n">op</span> <span class="n">0</span> <span class="n">completed</span><span class="p">,</span> <span class="n">throughput</span><span class="p">=</span><span class="n">3</span><span class="p">.</span><span class="n">86MB</span><span class="p">/</span><span class="n">sec</span>
    <span class="p">...</span>
    <span class="n">9</span><span class="p">:</span> <span class="n">throughput</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">442MB</span><span class="p">/</span><span class="n">sec</span> <span class="n">pending</span> <span class="n">data</span><span class="p">=</span><span class="n">0</span>
<span class="n">waiting</span> <span class="k">for</span> <span class="n">all</span> <span class="n">operations</span> <span class="n">to</span> <span class="n">complete</span>
<span class="n">cleaning</span> <span class="n">up</span> <span class="n">objects</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h1 id="1_2">1 综合实践<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h1>
<h2 id="11_2">1.1 存储池<a class="headerlink" href="#11_2" title="Permanent link">&para;</a></h2>
<h3 id="111_2">1.1.1 创建实践<a class="headerlink" href="#111_2" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">存储的常用管理操作包括列出</span><span class="err">、</span><span class="n">创建</span><span class="err">、</span><span class="n">重命名和删除等操作</span><span class="err">，</span><span class="n">常用相关的工具都是</span> <span class="err">“</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span><span class="err">”</span><span class="n">的子命令</span><span class="err">，</span><span class="n">包括ls</span><span class="err">、</span><span class="n">create</span><span class="err">、</span><span class="n">rename和rm等</span>
</code></pre></div>
<p>创建存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">副本型存储池创建命令</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">pg-num</span><span class="p">&gt;</span> <span class="p">[</span><span class="n">pgp-num</span><span class="p">]</span> <span class="no">[replicated]</span> <span class="p">\</span> <span class="p">[</span><span class="n">crush-rule-name</span><span class="p">]</span> <span class="p">[</span><span class="n">expected-num-objects</span><span class="p">]</span>

<span class="n">纠删码池创建命令</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">pg-num</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">pgp-num</span><span class="p">&gt;</span> <span class="n">erasure</span> <span class="p">\</span> <span class="p">[</span><span class="n">erasure-code-profile</span><span class="p">]</span> <span class="p">[</span><span class="n">crush-rule-name</span><span class="p">]</span> <span class="p">[</span><span class="n">expected-num-objects</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">命令格式中常用的参数</span>
    <span class="n">pool-name</span><span class="err">：</span><span class="n">存储池名称</span><span class="err">，</span><span class="n">在一个RADOS存储集群上必须具有唯一性</span><span class="err">；</span>
    <span class="n">pg-num</span><span class="err">：</span><span class="n">当前存储池中的PG数量</span><span class="err">，</span><span class="n">合理的PG数量对于存储池的数据分布及性能表现来说至关重要</span><span class="err">；</span>
    <span class="n">pgp-num</span> <span class="err">：</span><span class="n">用于归置的PG数量</span><span class="err">，</span><span class="n">其值应该等于PG的数量</span>
    <span class="n">replicated</span><span class="p">|</span><span class="n">erasure</span><span class="err">：</span><span class="n">存储池类型</span><span class="err">；</span><span class="n">副本存储池需更多原始存储空间</span><span class="err">，</span><span class="n">但已实现Ceph支持的所有操作</span><span class="err">，</span><span class="n">而纠删码存储池所需原始存储空间较少</span><span class="err">，</span><span class="n">但目前仅实现了Ceph的部分操作</span>
    <span class="n">crush-ruleset-name</span><span class="err">：</span><span class="n">此存储池所用的CRUSH规则集的名称</span><span class="err">，</span><span class="n">不过</span><span class="err">，</span><span class="n">引用的规则集必须事先存在</span>
</code></pre></div>
<p>获取存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">列出存储池</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="no">[detail]</span>

<span class="n">获取存储池的统计数据</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="p">[</span><span class="n">pool-name</span><span class="p">]</span>

<span class="n">显示存储池的用量信息</span>
    <span class="n">rados</span> <span class="n">df</span>
</code></pre></div>
<p>重命名存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">重命名存储池</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">rename</span> <span class="n">old-name</span> <span class="nb">new-name</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>查看存储池信息</p>
<div class="highlight"><pre><span></span><code><span class="n">列出所有存储池名称</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
<span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">control</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">meta</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">log</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">index</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">data</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">otp</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">buckets</span><span class="p">.</span><span class="n">non-ec</span>
<span class="n">cephfs-metadata</span>
<span class="n">cephfs-data</span>

<span class="n">获取所有存储池的详细信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span>
<span class="n">pool</span> <span class="n">6</span> <span class="s1">&#39;.rgw.root&#39;</span> <span class="n">replicated</span> <span class="n">size</span> <span class="n">3</span> <span class="n">min_size</span> <span class="n">2</span> <span class="n">crush_rule</span> <span class="n">0</span> <span class="n">object_hash</span> <span class="n">rjenkins</span> <span class="n">pg_num</span> <span class="n">32</span> <span class="n">pgp_num</span> <span class="n">32</span> <span class="n">autoscale_mode</span> <span class="n">warn</span> <span class="n">last_change</span> <span class="n">117</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">0</span> <span class="n">application</span> <span class="n">rgw</span>
<span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">可以看到</span><span class="err">，</span><span class="n">所有存储池的详情信息</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取所有存储池的统计数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span>
<span class="n">pool</span> <span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span> <span class="n">id</span> <span class="n">6</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>
<span class="p">...</span>
<span class="n">pool</span> <span class="n">cephfs-data</span> <span class="n">id</span> <span class="n">15</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>

<span class="n">获取制定存储池的统计数据</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">cephfs-data</span>
<span class="n">pool</span> <span class="n">cephfs-data</span> <span class="n">id</span> <span class="n">15</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">显示存储池的用量信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">df</span>
<span class="n">POOL_NAME</span>                     <span class="n">USED</span> <span class="n">OBJECTS</span> <span class="p">...</span> <span class="n">RD_OPS</span>      <span class="nb">RD </span><span class="n">WR_OPS</span>      <span class="n">WR</span> <span class="p">...</span>
<span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>                  <span class="n">768</span> <span class="n">KiB</span>       <span class="n">4</span> <span class="p">...</span>      <span class="n">0</span>     <span class="n">0</span> <span class="n">B</span>      <span class="n">4</span>   <span class="n">4</span> <span class="n">KiB</span> <span class="p">...</span>
<span class="p">...</span>
<span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">otp</span>                <span class="n">0</span> <span class="n">B</span>       <span class="n">0</span> <span class="p">...</span>      <span class="n">0</span>     <span class="n">0</span> <span class="n">B</span>      <span class="n">0</span>     <span class="n">0</span> <span class="n">B</span> <span class="p">...</span>

<span class="n">total_objects</span>    <span class="n">328</span>
<span class="n">total_used</span>       <span class="n">7</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span>
<span class="n">total_avail</span>      <span class="n">113</span> <span class="n">GiB</span>
<span class="n">total_space</span>      <span class="n">120</span> <span class="n">GiB</span>
</code></pre></div>
<p>创建副本存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">创建副本型存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">replicated-pool</span> <span class="n">32</span> <span class="n">32</span>
<span class="n">pool</span> <span class="s1">&#39;replicated-pool&#39;</span> <span class="n">created</span>

<span class="n">查看副本统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">replicated-pool</span>
<span class="n">pool</span> <span class="n">replicated-pool</span> <span class="n">id</span> <span class="n">18</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>

<span class="n">查看副本详情信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">replicated-pool</span>
<span class="n">pool</span> <span class="n">18</span> <span class="s1">&#39;replicated-pool&#39;</span> <span class="n">replicated</span> <span class="n">size</span> <span class="n">3</span> <span class="n">min_size</span> <span class="n">2</span> <span class="n">crush_rule</span> <span class="n">0</span> <span class="n">object_hash</span> <span class="n">rjenkins</span> <span class="n">pg_num</span> <span class="n">32</span> <span class="n">pgp_num</span> <span class="n">32</span> <span class="n">autoscale_mode</span> <span class="n">warn</span> <span class="n">last_change</span> <span class="n">507</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">0</span>
</code></pre></div>
<p>创建纠偏码池</p>
<div class="highlight"><pre><span></span><code><span class="n">创建纠删码池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">erasure-pool</span> <span class="n">16</span> <span class="n">16</span> <span class="n">erasure</span>
<span class="n">pool</span> <span class="s1">&#39;erasure-pool&#39;</span> <span class="n">created</span>

<span class="n">查看副本统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">stats</span> <span class="n">erasure-pool</span>
<span class="n">pool</span> <span class="n">erasure-pool</span> <span class="n">id</span> <span class="n">19</span>
  <span class="n">nothing</span> <span class="n">is</span> <span class="n">going</span> <span class="n">on</span>

<span class="n">查看副本详情信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">erasure-pool</span>
<span class="n">pool</span> <span class="n">19</span> <span class="s1">&#39;erasure-pool&#39;</span> <span class="n">erasure</span> <span class="n">size</span> <span class="n">3</span> <span class="n">min_size</span> <span class="n">2</span> <span class="n">crush_rule</span> <span class="n">1</span> <span class="n">object_hash</span> <span class="n">rjenkins</span> <span class="n">pg_num</span> <span class="n">16</span> <span class="n">pgp_num</span> <span class="n">16</span> <span class="n">autoscale_mode</span> <span class="n">warn</span> <span class="n">last_change</span> <span class="n">511</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">8192</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="112_1">1.1.2 删除实践<a class="headerlink" href="#112_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">意外删除存储池会导致数据丢失</span><span class="err">，</span><span class="n">因此</span> <span class="n">Ceph</span> <span class="n">实施了两个机制来防止删除存储池</span><span class="err">，</span><span class="n">要删除存储池</span><span class="err">，</span><span class="n">必须先禁用这两个机制</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">第一个机制是NODELETE标志</span><span class="err">，</span><span class="n">其值需要为false</span><span class="err">，</span><span class="n">默认也是false</span>
    <span class="n">查看命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">pool-name</span> <span class="n">nodelete</span>
    <span class="n">修改命令</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">pool-name</span> <span class="n">nodelete</span> <span class="n">false</span>

<span class="n">第二个机制是集群范围的配置参数mon</span> <span class="n">allow</span> <span class="n">pool</span> <span class="n">delete</span><span class="err">，</span><span class="n">其默认值为</span> <span class="err">“</span><span class="n">false</span><span class="err">”，</span><span class="n">这表示默认不能删除存储池</span><span class="err">，</span><span class="n">临时设定的方法如下</span>
    <span class="n">ceph</span> <span class="n">tell</span> <span class="n">mon</span><span class="p">.*</span> <span class="n">injectargs</span> <span class="p">-</span><span class="n">-mon-allow-pool-delete</span><span class="p">={</span><span class="n">true</span><span class="p">|</span><span class="n">false</span><span class="p">}</span>
    <span class="n">建议删除之前将其值设置为true</span><span class="err">，</span><span class="n">删除完成后再改为false</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">删除存储池命令格式</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">pool-name</span> <span class="n">pool-name</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>删除存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">查看删除标识</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">replicated-pool</span> <span class="n">nodelete</span>
<span class="n">nodelete</span><span class="p">:</span> <span class="n">false</span>

<span class="n">删除存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">replicated-pool</span> <span class="n">replicated-pool</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">Error</span> <span class="n">EPERM</span><span class="p">:</span> <span class="n">pool</span> <span class="n">deletion</span> <span class="n">is</span> <span class="n">disabled</span><span class="p">;</span> <span class="n">you</span> <span class="n">must</span> <span class="n">first</span> <span class="nb">set </span><span class="n">the</span> <span class="n">mon_allow_pool_delete</span> <span class="n">config</span> <span class="n">option</span> <span class="n">to</span> <span class="n">true</span> <span class="n">before</span> <span class="n">you</span> <span class="n">can</span> <span class="n">destroy</span> <span class="n">a</span> <span class="n">pool</span>
<span class="n">结果显示</span><span class="p">:</span>
    <span class="n">默认无法删除存储池</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改删除标识</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">tell</span> <span class="n">mon</span><span class="p">.*</span> <span class="n">injectargs</span> <span class="p">-</span><span class="n">-mon-allow-pool-delete</span><span class="p">=</span><span class="n">true</span>
<span class="n">mon</span><span class="p">.</span><span class="n">mon01</span><span class="p">:</span> <span class="n">injectargs</span><span class="p">:</span><span class="n">mon_allow_pool_delete</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
<span class="n">mon</span><span class="p">.</span><span class="n">mon02</span><span class="p">:</span> <span class="n">injectargs</span><span class="p">:</span><span class="n">mon_allow_pool_delete</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
<span class="n">mon</span><span class="p">.</span><span class="n">mon03</span><span class="p">:</span> <span class="n">injectargs</span><span class="p">:</span><span class="n">mon_allow_pool_delete</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>

<span class="n">再次删除存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">replicated-pool</span> <span class="n">replicated-pool</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">pool</span> <span class="s1">&#39;replicated-pool&#39;</span> <span class="n">removed</span>
</code></pre></div>
<p>永久删除方法</p>
<div class="highlight"><pre><span></span><code><span class="n">将所有的ceph</span><span class="p">.</span><span class="n">conf文件中</span><span class="err">，</span><span class="n">增加默认允许删除存储池的配置</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>
<span class="no">[mon]</span>
<span class="n">mon_allow_pool_delete</span> <span class="p">=</span> <span class="n">true</span>

<span class="n">然后同步到所有节点</span><span class="err">，</span><span class="n">重启mon服务</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="p">-</span><span class="n">-overwrite-conf</span> <span class="n">config</span> <span class="n">push</span> <span class="n">admin</span> <span class="n">mon01</span> <span class="n">mon02</span> <span class="n">mon03</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">mon0</span><span class="p">{</span><span class="n">1</span><span class="p">..</span><span class="n">3</span><span class="p">};</span> <span class="k">do</span> <span class="n">ssh</span> <span class="nv">$i</span> <span class="s2">&quot;sudo systemctl restart ceph-mon.target&quot;</span><span class="p">;</span> <span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改删除标识</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">tell</span> <span class="n">mon</span><span class="p">.*</span> <span class="n">injectargs</span> <span class="p">-</span><span class="n">-mon-allow-pool-delete</span><span class="p">=</span><span class="n">false</span>

<span class="n">创建存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">replicated-pool</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">pool</span> <span class="s1">&#39;replicated-pool&#39;</span> <span class="n">created</span>

<span class="n">删除存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">replicated-pool</span> <span class="n">replicated-pool</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">pool</span> <span class="s1">&#39;replicated-pool&#39;</span> <span class="n">removed</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="113_2">1.1.3 配额管理<a class="headerlink" href="#113_2" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>设置存储池配额</p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph支持为存储池设置可存储对象的最大数量</span><span class="err">（</span><span class="n">max_objects</span><span class="err">）</span><span class="n">和可占用的最大空间</span><span class="err">（</span> <span class="n">max_bytes</span><span class="err">）</span><span class="n">两个纬度的配额</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set-quota</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">max_objects</span><span class="p">|</span><span class="n">max_bytes</span> <span class="p">&lt;</span><span class="n">val</span><span class="p">&gt;</span>

<span class="n">获取存储池配额的相关信息</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">get-quota</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span>
</code></pre></div>
<p>配置存储池参数</p>
<div class="highlight"><pre><span></span><code><span class="n">存储池的诸多配置属性保存于配置参数中</span>
    <span class="n">获取配置</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span>
    <span class="n">设定配置</span><span class="err">：</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">key</span><span class="p">&gt;</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">常用的可配置参数</span>
    <span class="n">size</span><span class="err">：</span>           <span class="n">存储池中的对象副本数</span><span class="err">；</span>
    <span class="n">min_size</span><span class="err">：</span>       <span class="n">I</span><span class="p">/</span><span class="n">O所需要的最小副本数</span><span class="err">；</span>
    <span class="n">pg_num</span><span class="err">：</span>         <span class="n">存储池的PG数量</span><span class="err">；</span>
    <span class="n">pgp_num</span><span class="err">：</span>        <span class="n">计算数据归置时要使用的PG的有效数量</span><span class="err">；</span>
    <span class="n">crush_ruleset</span><span class="err">：</span>  <span class="n">用于在集群中映射对象归置的规则组</span><span class="err">；</span>
    <span class="n">nodelete</span><span class="err">：</span>       <span class="n">控制是否可删除存储池</span><span class="err">；</span>
    <span class="n">nopgchange</span><span class="err">：</span>     <span class="n">控制是否可更改存储池的pg_num和pgp_num</span><span class="err">；</span>
    <span class="n">nosizechange</span><span class="err">：</span>   <span class="n">控制是否可更改存储池的大小</span><span class="err">；</span>
    <span class="n">noscrub和nodeep-scrub</span><span class="err">：</span>   <span class="n">控制是否可整理或深层整理存储池以解决临时高I</span><span class="p">/</span><span class="n">O负载的问题</span>
    <span class="n">scrub_min_interval</span><span class="err">：</span> <span class="n">集群负载较低时整理存储池的最小时间间隔</span><span class="err">；</span>
                <span class="n">默认值为0</span><span class="err">，</span><span class="n">表示其取值来自于配置文件中的osd_scrub_min_interval参数</span><span class="err">；</span>
    <span class="n">scrub_max_interval</span><span class="err">：</span><span class="n">整理存储池的最大时间间隔</span><span class="err">；</span>
                <span class="n">默认值为0</span><span class="err">，</span><span class="n">表示其取值来自于配置文件中的osd_scrub_max_interval参数</span><span class="err">；</span>
    <span class="n">deep_scrub_interval</span><span class="err">：</span><span class="n">深层整理存储池的间隔</span><span class="err">；</span>
                <span class="n">默认值为0</span><span class="err">，</span><span class="n">表示其取值来自于配置文件中的osd_deep_scrub参数</span><span class="err">；</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>设置存储池配额</p>
<div class="highlight"><pre><span></span><code><span class="n">获取存储池配额的相关信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">get-quota</span> <span class="n">erasure-pool</span>
<span class="n">quotas</span> <span class="k">for</span> <span class="n">pool</span> <span class="s1">&#39;erasure-pool&#39;</span><span class="p">:</span>
  <span class="n">max</span> <span class="n">objects</span><span class="p">:</span> <span class="n">N</span><span class="p">/</span><span class="n">A</span>      <span class="c"># 表示没有限制</span>
  <span class="n">max</span> <span class="n">bytes</span>  <span class="p">:</span> <span class="n">N</span><span class="p">/</span><span class="n">A</span>      <span class="c"># 表示没有限制</span>

<span class="n">设置存储池配额的值</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set-quota</span> <span class="n">erasure-pool</span> <span class="n">max_objects</span> <span class="n">10000</span>
<span class="nb">set-quota</span> <span class="n">max_objects</span> <span class="p">=</span> <span class="n">10000</span> <span class="k">for</span> <span class="n">pool</span> <span class="n">erasure-pool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set-quota</span> <span class="n">erasure-pool</span> <span class="n">max_bytes</span> <span class="n">1024000</span>
<span class="nb">set-quota</span> <span class="n">max_bytes</span> <span class="p">=</span> <span class="n">1024000</span> <span class="k">for</span> <span class="n">pool</span> <span class="n">erasure-pool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">get-quota</span> <span class="n">erasure-pool</span>
<span class="n">quotas</span> <span class="k">for</span> <span class="n">pool</span> <span class="s1">&#39;erasure-pool&#39;</span><span class="p">:</span>
  <span class="n">max</span> <span class="n">objects</span><span class="p">:</span> <span class="n">10k</span> <span class="n">objects</span>
  <span class="n">max</span> <span class="n">bytes</span>  <span class="p">:</span> <span class="n">1000</span> <span class="n">KiB</span>
</code></pre></div>
<p>配置存储池参数</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">replicated-pool</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">pool</span> <span class="s1">&#39;replicated-pool&#39;</span> <span class="n">created</span>

<span class="n">获取配置</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">replicated-pool</span> <span class="n">size</span>
<span class="n">size</span><span class="p">:</span> <span class="n">3</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">调整配置属性</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">replicated-pool</span> <span class="n">size</span> <span class="n">4</span>
<span class="nb">set </span><span class="n">pool</span> <span class="n">21</span> <span class="n">size</span> <span class="n">to</span> <span class="n">4</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">replicated-pool</span> <span class="n">size</span>
<span class="n">size</span><span class="p">:</span> <span class="n">4</span>

<span class="n">调整配置属性</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">replicated-pool</span> <span class="n">size</span> <span class="n">3</span>
<span class="nb">set </span><span class="n">pool</span> <span class="n">21</span> <span class="n">size</span> <span class="n">to</span> <span class="n">3</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">replicated-pool</span> <span class="n">size</span>
<span class="n">size</span><span class="p">:</span> <span class="n">3</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="114_2">1.1.4 快照管理<a class="headerlink" href="#114_2" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">关于存储池快照</span>
    <span class="n">存储池快照是指整个存储池的状态快照</span>
    <span class="n">通过存储池快照</span><span class="err">，</span><span class="n">可以保留存储池状态的历史</span>
    <span class="n">创建存储池快照可能需要大量存储空间</span><span class="err">，</span><span class="n">具体取决于存储池的大小</span>
</code></pre></div>
<p>常见操作</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储池快照</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">mksnap</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">snap-name</span><span class="p">&gt;</span>
    <span class="n">rados</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">mksnap</span> <span class="p">&lt;</span><span class="n">snap-name</span><span class="p">&gt;</span>

<span class="n">列出存储池的快照</span>
    <span class="n">rados</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">lssnap</span>

<span class="n">回滚存储池至指定的快照</span>
    <span class="n">rados</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">rollback</span> <span class="p">&lt;</span><span class="n">snap-name</span><span class="p">&gt;</span>

<span class="n">删除存储池快照</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">rmsnap</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">snap-name</span><span class="p">&gt;</span>
    <span class="n">rados</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">rmsnap</span> <span class="p">&lt;</span><span class="n">snap-name</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>查看快照</p>
<div class="highlight"><pre><span></span><code><span class="n">查看制定存储池的快照数量</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">replicated-pool</span> <span class="n">lssnap</span>
<span class="n">0</span> <span class="n">snaps</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">erasure-pool</span> <span class="n">lssnap</span>
<span class="n">0</span> <span class="n">snaps</span>
</code></pre></div>
<p>制作快照</p>
<div class="highlight"><pre><span></span><code><span class="n">创建快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">mksnap</span> <span class="n">replicated-pool</span> <span class="n">replicated-snap</span>
<span class="n">created</span> <span class="n">pool</span> <span class="n">replicated-pool</span> <span class="n">snap</span> <span class="n">replicated-snap</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">mksnap</span> <span class="n">erasure-pool</span> <span class="n">erasure-snap</span>
<span class="n">created</span> <span class="n">pool</span> <span class="n">erasure-pool</span> <span class="n">snap</span> <span class="n">erasure-snap</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">replicated-pool</span> <span class="n">lssnap</span>
<span class="n">1</span>       <span class="n">replicated-snap</span> <span class="n">2062</span><span class="p">.</span><span class="n">09</span><span class="p">.</span><span class="n">28</span> <span class="n">22</span><span class="p">:</span><span class="n">28</span><span class="p">:</span><span class="n">33</span>
<span class="n">1</span> <span class="n">snaps</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">erasure-pool</span> <span class="n">lssnap</span>
<span class="n">1</span>       <span class="n">erasure-snap</span>    <span class="n">2062</span><span class="p">.</span><span class="n">09</span><span class="p">.</span><span class="n">28</span> <span class="n">22</span><span class="p">:</span><span class="n">28</span><span class="p">:</span><span class="n">43</span>
<span class="n">1</span> <span class="n">snaps</span>

<span class="n">结果分析</span><span class="err">：</span>
    <span class="n">创建过image的存储池无法再创建存储池快照了</span><span class="err">，</span><span class="n">因为存储池当前已经为unmanaged</span> <span class="n">snaps</span> <span class="n">mode</span> <span class="n">或者</span> <span class="n">selfmanaged_snaps模式</span><span class="err">，</span><span class="n">而没有创建image的</span><span class="err">，</span><span class="n">就可以做存储池快照</span><span class="err">。</span>
</code></pre></div>
<p>快照还原</p>
<div class="highlight"><pre><span></span><code><span class="n">添加文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">put</span> <span class="n">ceph</span><span class="o">-file</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/</span><span class="n">ceph-cluster</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">erasure-pool</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">erasure-pool</span>
<span class="n">ceph</span><span class="o">-file</span>

<span class="n">添加快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">mksnap</span> <span class="n">erasure-pool</span> <span class="n">erasure-snap1</span>
<span class="n">created</span> <span class="n">pool</span> <span class="n">erasure-pool</span> <span class="n">snap</span> <span class="n">erasure-snap1</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">erasure-pool</span> <span class="n">lssnap</span>
<span class="n">1</span>       <span class="n">erasure-snap</span>    <span class="n">2062</span><span class="p">.</span><span class="n">09</span><span class="p">.</span><span class="n">28</span> <span class="n">22</span><span class="p">:</span><span class="n">28</span><span class="p">:</span><span class="n">43</span>
<span class="n">2</span>       <span class="n">erasure-snap1</span>   <span class="n">2062</span><span class="p">.</span><span class="n">09</span><span class="p">.</span><span class="n">28</span> <span class="n">22</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">17</span>
<span class="n">2</span> <span class="n">snaps</span>

<span class="n">回滚快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">erasure-pool</span> <span class="n">rollback</span> <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="n">erasure-snap</span>
<span class="n">rolled</span> <span class="n">back</span> <span class="n">pool</span> <span class="n">erasure-pool</span> <span class="n">to</span> <span class="n">snapshot</span> <span class="n">erasure-snap</span>
</code></pre></div>
<p>删除快照</p>
<div class="highlight"><pre><span></span><code><span class="n">删除快照</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">rmsnap</span> <span class="n">erasure-pool</span> <span class="n">erasure-snap1</span>
<span class="n">removed</span> <span class="n">pool</span> <span class="n">erasure-pool</span> <span class="n">snap</span> <span class="n">erasure-snap1</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">rmsnap</span> <span class="n">erasure-pool</span> <span class="n">erasure-snap</span>
<span class="n">removed</span> <span class="n">pool</span> <span class="n">erasure-pool</span> <span class="n">snap</span> <span class="n">erasure-snap</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">erasure-pool</span> <span class="n">lssnap</span>
<span class="n">0</span> <span class="n">snaps</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="115_1">1.1.5 压缩管理<a class="headerlink" href="#115_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">BlueStore存储引擎提供即时数据压缩</span><span class="err">，</span><span class="n">以节省磁盘空间</span>
</code></pre></div>
<p>启用压缩</p>
<div class="highlight"><pre><span></span><code><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">compression_algorithm</span> <span class="n">snappy</span>
    <span class="n">压缩算法有none</span><span class="err">、</span><span class="n">zlib</span><span class="err">、</span><span class="n">lz4</span><span class="err">、</span><span class="n">zstd和snappy等几种</span><span class="err">，</span><span class="n">默认为snappy</span><span class="err">；</span>
    <span class="n">zstd有较好的压缩比</span><span class="err">，</span><span class="n">但比较消耗CPU</span><span class="err">；</span>
    <span class="n">lz4和snappy对CPU占用比例较低</span><span class="err">；</span>
    <span class="n">不建议使用zlib</span><span class="err">；</span>

<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="n">compression_mode</span> <span class="n">aggressive</span>
    <span class="n">压缩模式</span><span class="err">：</span><span class="n">none</span><span class="err">、</span><span class="n">aggressive</span><span class="err">、</span><span class="n">passive和force</span><span class="err">，</span><span class="n">默认值为none</span><span class="err">；</span>
    <span class="n">none</span><span class="err">：</span><span class="n">不压缩</span>
    <span class="n">passive</span><span class="err">：</span><span class="n">若提示COMPRESSIBLE</span><span class="err">，</span><span class="n">则压缩</span>
    <span class="n">aggressive</span><span class="err">：</span><span class="n">除非提示INCOMPRESSIBLE</span><span class="err">，</span><span class="n">否则就压缩</span><span class="err">；</span>
    <span class="n">force</span><span class="err">：</span><span class="n">始终压缩</span>

<span class="n">注意</span><span class="err">：</span><span class="n">如果需要全局压缩</span><span class="err">，</span><span class="n">最好在配置文件中定制</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其它可用的压缩参数</span>
    <span class="n">compression_required_ratio</span><span class="err">：</span><span class="n">指定压缩比</span><span class="err">，</span><span class="n">取值格式为双精度浮点型</span><span class="err">，</span><span class="n">其值为</span>
<span class="n">SIZE_COMPRESSED</span><span class="p">/</span><span class="n">SIZE_ORIGINAL</span><span class="err">，</span><span class="n">即压缩后的大小与原始内容大小的比值</span><span class="err">，</span><span class="n">默认为</span> <span class="p">.</span><span class="n">875</span><span class="err">；</span>
    <span class="n">compression_max_blob_size</span><span class="err">：</span><span class="n">压缩对象的最大体积</span><span class="err">，</span><span class="n">无符号整数型数值</span><span class="err">，</span><span class="n">默认为0</span><span class="err">；</span>
    <span class="n">compression_min_blob_size</span><span class="err">：</span><span class="n">压缩对象的最小体积</span><span class="err">，</span><span class="n">无符号整数型数值</span><span class="err">，</span><span class="n">默认为0</span><span class="err">；</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">全局压缩选项</span>
    <span class="n">可在ceph配置文件中设置压缩属性</span><span class="err">，</span><span class="n">它将对所有的存储池生效</span><span class="err">，</span><span class="n">可设置的相关参数如下</span>
    <span class="n">bluestore_compression_algorithm</span>
    <span class="n">bluestore_compression_mode</span>
    <span class="n">bluestore_compression_required_ratio</span>
    <span class="n">bluestore_compression_min_blob_size</span>
    <span class="n">bluestore_compression_max_blob_size</span>
    <span class="n">bluestore_compression_min_blob_size_ssd</span>
    <span class="n">bluestore_compression_max_blob_size_ssd</span>
    <span class="n">bluestore_compression_min_blob_size_hdd</span>
    <span class="n">bluestore_compression_max_blob_size_hdd</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>查看默认的算法</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config show | grep compression</span>
    <span class="s2">&quot;bluestore_compression_algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;bluestore_compression_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bluestore_compression_required_ratio&quot;</span><span class="p">:</span> <span class="s2">&quot;0.875000&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;rbd_compression_hint&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">默认的压缩算法是</span> <span class="n">snappy</span><span class="p">,</span><span class="n">默认的压缩模式是</span> <span class="n">node</span><span class="p">,</span><span class="n">压缩比例是0</span><span class="p">.</span><span class="n">875</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这条命令最好指定节点下执行</span>
</code></pre></div>
<p>更改压缩算法</p>
<div class="highlight"><pre><span></span><code><span class="n">管理节点设定压缩算法</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">erasure-pool</span> <span class="n">compression_algorithm</span> <span class="n">zstd</span>
<span class="nb">set </span><span class="n">pool</span> <span class="n">19</span> <span class="n">compression_algorithm</span> <span class="n">to</span> <span class="n">zstd</span>

<span class="n">存储池查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">erasure-pool</span>
<span class="n">pool</span> <span class="n">19</span> <span class="s1">&#39;erasure-pool&#39;</span> <span class="n">erasure</span> <span class="p">...</span> <span class="n">compression_algorithm</span> <span class="n">zstd</span>
</code></pre></div>
<p>更改算法模式</p>
<div class="highlight"><pre><span></span><code><span class="n">更改算法模式</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">erasure-pool</span> <span class="n">compression_mode</span> <span class="n">aggressive</span>
<span class="nb">set </span><span class="n">pool</span> <span class="n">19</span> <span class="n">compression_mode</span> <span class="n">to</span> <span class="n">aggressive</span>

<span class="n">查看存储池算法模式</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">erasure-pool</span>
<span class="n">pool</span> <span class="n">19</span> <span class="s1">&#39;erasure-pool&#39;</span> <span class="n">erasure</span> <span class="p">...</span> <span class="n">compression_mode</span> <span class="n">aggressive</span>
</code></pre></div>
<p>还原算法模式和算法</p>
<div class="highlight"><pre><span></span><code><span class="n">还原算法和模式</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">erasure-pool</span> <span class="n">compression_algorithm</span> <span class="n">snappy</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">erasure-pool</span> <span class="n">compression_mode</span> <span class="n">none</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">erasure-pool</span>
<span class="n">pool</span> <span class="n">19</span> <span class="s1">&#39;erasure-pool&#39;</span> <span class="n">erasure</span> <span class="p">...</span> <span class="n">compression_algorithm</span> <span class="n">snappy</span> <span class="n">compression_mode</span> <span class="n">none</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="116">1.1.6 纠删码基础<a class="headerlink" href="#116" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>场景介绍</p>
<div class="highlight"><pre><span></span><code>    <span class="n">纠删码理论</span><span class="p">(</span><span class="n">erasure</span> <span class="n">coding</span><span class="err">，</span><span class="n">EC</span><span class="p">)</span><span class="n">始于</span> <span class="n">20</span> <span class="n">世纪</span> <span class="n">60</span> <span class="n">年代</span><span class="p">,</span><span class="n">它是一种数据保护方法</span><span class="err">。</span><span class="n">从原理上说</span><span class="err">，</span><span class="n">它将数据分割成片段</span><span class="err">，</span><span class="n">把冗余数据块扩展</span><span class="err">、</span><span class="n">编码</span><span class="err">，</span><span class="n">并将其存储在不同的位置</span><span class="err">，</span><span class="n">比如磁盘</span><span class="err">、</span><span class="n">存储节点或者其它地理位置</span><span class="err">。</span>
    <span class="n">总数据块</span> <span class="p">=</span> <span class="n">原始数据块</span> <span class="p">+</span> <span class="n">校验块</span><span class="err">，</span> <span class="n">常见表示为</span><span class="err">，</span><span class="n">n</span> <span class="p">=</span> <span class="n">k</span> <span class="p">+</span> <span class="n">m</span>
    <span class="n">当冗余级别为n时</span><span class="err">，</span><span class="n">将这些数据块分别存放在n个硬盘上</span><span class="err">，</span><span class="n">这样就能容忍小于m个</span><span class="err">（</span><span class="n">假设初始数据有k个</span><span class="err">）</span><span class="n">硬盘发生故障</span><span class="err">。</span><span class="n">当不超过m个硬盘发生故障时</span><span class="err">，</span><span class="n">只需任意选取k个正常的数据块就能计算得到所有的原始数据</span><span class="err">。</span>
    <span class="n">在云存储中</span><span class="err">，</span><span class="n">我们通常会使用副本的方式来保证系统的可用性</span><span class="err">。</span><span class="n">问题是当存储达到</span> <span class="n">PB</span> <span class="n">级别后要求的容量将会非常高</span><span class="err">。</span><span class="n">通过使用纠删码技术可以在保证相同可用性的情况下</span><span class="err">，</span><span class="n">节省大量存储空间</span><span class="err">，</span><span class="n">从而大大的降低</span> <span class="n">TCO</span><span class="err">（</span><span class="n">总体成本</span><span class="err">）。</span><span class="n">Ceph</span> <span class="n">从</span> <span class="n">Firefly</span> <span class="n">版本开始支持纠删码</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">比如8块磁盘的总数</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="err">，</span><span class="n">5个数据盘</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">通过5个数据块计算出3个校验块</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="err">，</span><span class="n">我们可以用RS</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="n">3</span><span class="p">)</span><span class="n">来代表</span><span class="err">。</span><span class="n">在这样的场景中</span><span class="err">，</span><span class="n">每份数据都会切分5份</span><span class="p">--</span><span class="n">5</span><span class="p">*</span><span class="n">5的逆向矩阵</span><span class="err">，</span><span class="n">它可以容忍任意</span> <span class="n">3</span> <span class="n">块磁盘的故障</span><span class="err">。</span><span class="n">如果某些数据块丢失</span><span class="err">，</span><span class="n">可以通过剩下的可用数据恢复出原始的数据内容</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220928232215966" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220928232215966.png" /></p>
<p>ceph纠偏码</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph纠删码实现了高速的计算</span><span class="err">，</span><span class="n">但有2个缺点</span><span class="err">：</span><span class="n">速度慢</span><span class="err">、</span><span class="n">只支持对象的部分操作</span><span class="err">。</span><span class="n">ceph中的EC编码是以插件的形式来提供的</span><span class="err">。</span><span class="n">EC编码有三个指标</span><span class="err">：</span><span class="n">空间利用率</span><span class="err">、</span><span class="n">数据可靠性和恢复效率</span><span class="err">。</span><span class="n">ceph提供以下几种纠删码插件</span><span class="err">：</span><span class="n">clay</span><span class="p">(</span><span class="n">coupled-layer</span><span class="p">)</span><span class="err">、</span><span class="n">jerasure</span><span class="err">、</span><span class="n">lrc</span><span class="err">、</span><span class="n">shec</span><span class="err">、</span><span class="n">isa等</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph支持以插件方式加载使用的纠删编码插件</span><span class="err">，</span><span class="n">存储管理员可根据存储场景的需要优化选择合用的插件</span><span class="err">。</span>
<span class="n">jerasure</span><span class="err">：</span>
    <span class="n">最为通用的和灵活的纠删编码插件</span><span class="err">，</span><span class="n">它也是纠删码池默认使用的插件</span><span class="err">；</span><span class="n">不过</span><span class="err">，</span><span class="n">任何一个OSD成员的丢失</span><span class="err">，</span><span class="n">都需要余下的所有成员OSD参与恢复过程</span><span class="err">；</span><span class="n">另外</span><span class="err">，</span><span class="n">使用此类插件时</span><span class="err">，</span><span class="n">管理员还可以通过technique选项指定要使用的编码技术</span><span class="err">：</span>
    <span class="n">reed_sol_van</span><span class="err">：</span><span class="n">最灵活的编码技术</span><span class="err">，</span><span class="n">管理员仅需提供k和m参数即可</span><span class="err">；</span>
    <span class="n">cauchy_good</span><span class="err">：</span><span class="n">更快的编码技术</span><span class="err">，</span><span class="n">但需要小心设置PACKETSIZE参数</span><span class="err">；</span>
    <span class="n">reed_sol_r6_op</span><span class="err">、</span><span class="n">liberation</span><span class="err">、</span><span class="n">blaum_roth或liber8tion</span><span class="err">：</span>
            <span class="n">仅支持使用m</span><span class="p">=</span><span class="n">2的编码技术</span><span class="err">，</span><span class="n">功能特性类同于RAID</span> <span class="n">6</span><span class="err">；</span>
<span class="n">lrc</span><span class="err">：</span>
    <span class="n">全称为Locally</span> <span class="n">Repairable</span> <span class="n">Erasure</span> <span class="n">Code</span><span class="err">，</span><span class="n">即本地修复纠删码</span><span class="err">，</span><span class="n">除了默认的m个编码块之外</span><span class="err">，</span><span class="n">它会额外在本地创建指定数量</span><span class="err">（</span><span class="n">l</span><span class="err">）</span><span class="n">的奇偶校验块</span><span class="err">，</span><span class="n">从而在一个OSD丢失时</span><span class="err">，</span><span class="n">可以仅通过l个奇偶校验块完成恢复</span>

<span class="n">isa</span><span class="err">：</span>
    <span class="n">仅支持运行在intel</span> <span class="n">CPU之上的纠删编码插件</span><span class="err">，</span><span class="n">它支持reed_sol_van和cauchy两种技术</span>

<span class="n">shec</span><span class="err">：</span>
    <span class="n">shec</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">l</span><span class="p">)</span><span class="err">，</span><span class="n">k为数据块</span><span class="err">，</span><span class="n">m为校验块</span><span class="err">，</span><span class="n">l代表计算校验块时需要的数据块数量</span><span class="err">。</span>
    <span class="n">其最大允许失效数据块为</span><span class="err">：</span><span class="n">ml</span><span class="p">/</span><span class="n">k</span><span class="err">，</span><span class="n">恢复失效的单个数据块</span><span class="err">（</span><span class="n">data</span> <span class="n">chunk</span><span class="err">）</span><span class="n">只需要额外读取l个数据块</span><span class="err">。</span>
</code></pre></div>
<p>基础概念</p>
<div class="highlight"><pre><span></span><code><span class="n">块</span><span class="err">（</span><span class="n">chunk</span><span class="err">）</span>
    <span class="n">基于纠删码编码时</span><span class="err">，</span><span class="n">每次编码将产生若干大小相同的块</span><span class="p">(</span><span class="n">有序</span><span class="p">)</span><span class="err">。</span>
    <span class="n">ceph通过数量相等的PG将这些分别存储在不同的osd中</span><span class="err">。</span>
<span class="n">条带</span><span class="err">（</span><span class="n">strip</span><span class="err">）</span>
    <span class="n">如果编码对象太大</span><span class="err">，</span><span class="n">可分多次进行编码</span><span class="err">，</span><span class="n">每次完成编码的部分称为条带</span><span class="err">。</span><span class="n">同一个对内的条带时有序的</span><span class="err">。</span>
<span class="n">分片</span><span class="err">（</span><span class="n">shared</span><span class="err">）</span>
    <span class="n">同一个对象中所有序号相同的块位于同一个PG上</span><span class="err">，</span><span class="n">他们组成对象的一个分片</span><span class="err">，</span><span class="n">分片的编号就是块的序号</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">空间利用率</span><span class="err">（</span><span class="n">rate</span><span class="err">）：</span>
    <span class="n">通过k</span><span class="p">/</span><span class="n">n计算</span><span class="err">。</span>
<span class="n">对象尺寸</span><span class="err">：</span> 
    <span class="n">Ceph</span> <span class="n">存储集群里的对象有最大可配置尺寸</span><span class="err">，</span><span class="n">对象尺寸必须足够大</span><span class="p">,</span><span class="n">而且应该是条带单元的整数倍</span><span class="err">。</span>
<span class="n">条带数量</span><span class="err">（</span><span class="n">strip_size</span><span class="err">）：</span> 
    <span class="n">Ceph</span> <span class="n">客户端把一系列条带单元写入由条带数量所确定的一系列对象</span><span class="err">，</span><span class="n">这一系列的对象称为一个对象集</span><span class="err">。</span>
    <span class="n">客户端写到对象集内的最后一个对象时</span><span class="err">，</span><span class="n">再返回到第一个</span><span class="err">。</span>
<span class="n">条带宽度</span><span class="err">（</span><span class="n">strip_width</span><span class="err">）：</span> 
    <span class="n">条带都有可配置的单元尺寸</span><span class="err">。</span><span class="n">Ceph</span> <span class="n">客户端把数据等分成适合写入对象的条带单元</span><span class="err">。</span>
    <span class="n">strip_width</span> <span class="p">=</span> <span class="n">chunk_size</span> <span class="p">*</span> <span class="n">strip_size</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">假设有EC</span><span class="err">（</span><span class="n">k</span><span class="p">=</span><span class="n">4</span><span class="err">，</span><span class="n">m</span><span class="p">=</span><span class="n">2</span><span class="err">），</span><span class="n">strip_size</span><span class="p">=</span><span class="n">4</span><span class="err">，</span><span class="n">chunk_size</span><span class="p">=</span><span class="n">1K</span><span class="err">，</span><span class="n">那么strip_width</span><span class="p">=</span><span class="n">4K</span><span class="err">。</span><span class="n">在ceph中</span><span class="err">，</span><span class="n">strip_width默认为4K</span><span class="err">。</span>
    <span class="n">假如object对象内容是</span> <span class="n">ABCDEFGHIJKL</span><span class="err">；</span><span class="n">将该数据对象写入pool时</span><span class="err">，</span><span class="n">纠删码函数把object分4个数据块</span><span class="err">：</span><span class="n">第1个是ABC</span><span class="p">,</span><span class="n">第2个是DEF</span><span class="err">，</span><span class="n">第3个是GHI</span><span class="err">，</span><span class="n">第4个是JKL</span><span class="err">；</span><span class="n">如果object的长度不是K的倍数</span><span class="err">，</span><span class="n">object会被填充一些内容</span><span class="err">；</span><span class="n">纠删码函数同时创建2个编码块</span><span class="err">：</span><span class="n">第4个是xxx</span><span class="err">，</span><span class="n">第5个是yyy</span><span class="err">；</span>
</code></pre></div>
<p><img alt="image-20220928234255383" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220928234255383.png" /></p>
<p><strong>简单实践</strong></p>
<p>创建纠删码池</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="p">&lt;</span><span class="n">pool-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">pg-num</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">pgp-num</span><span class="p">&gt;</span> <span class="n">erasure</span> <span class="p">[</span><span class="n">erasure-code-profile</span><span class="p">]</span> <span class="p">[</span><span class="n">crush-rule-name</span><span class="p">]</span> <span class="p">[</span><span class="n">expected-num-objects</span><span class="p">]</span>

<span class="n">要点解析</span>
    <span class="n">未指定要使用的纠删编码配置文件时</span><span class="err">，</span><span class="n">创建命令会为其自动创建一个</span><span class="err">，</span><span class="n">并在创建相关的CRUSH规则集时使用到它</span>
    <span class="n">默认配置文件自动定义k</span><span class="p">=</span><span class="n">2和m</span><span class="p">=</span><span class="n">1</span><span class="err">，</span><span class="n">这意味着Ceph将通过三个OSD扩展对象数据</span><span class="err">，</span><span class="n">并且可以丢失其中一个OSD而不会丢失数据</span><span class="err">，</span><span class="n">因此</span><span class="err">，</span><span class="n">在冗余效果上</span><span class="err">，</span><span class="n">它相当于一个大小为2的副本池</span> <span class="err">，</span><span class="n">不过</span><span class="err">，</span><span class="n">其存储空间有效利用率为2</span><span class="p">/</span><span class="n">3而非1</span><span class="p">/</span><span class="n">2</span><span class="err">。</span>
</code></pre></div>
<p>其他命令</p>
<div class="highlight"><pre><span></span><code><span class="n">列出纠删码配置文件</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">ls</span>

<span class="n">获取指定的配置文件的相关内容</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="n">get</span> <span class="k">default</span>

<span class="n">自定义纠删码配置文件</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">set </span><span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span> <span class="p">[&lt;</span><span class="n">directory</span><span class="p">=</span><span class="n">directory</span><span class="p">&gt;]</span> <span class="p">[&lt;</span><span class="n">plugin</span><span class="p">=</span><span class="n">plugin</span><span class="p">&gt;]</span> <span class="p">[&lt;</span><span class="n">crush-device-class</span><span class="p">&gt;]</span> <span class="p">[&lt;</span><span class="n">crush-failure-domain</span><span class="p">&gt;]</span> <span class="p">[&lt;</span><span class="n">key</span><span class="p">=</span><span class="n">value</span><span class="p">&gt;</span> <span class="p">...]</span> <span class="p">[-</span><span class="n">-force</span><span class="p">]</span>
    <span class="p">-</span> <span class="n">directory</span><span class="err">：</span><span class="n">加载纠删码插件的目录路径</span><span class="err">，</span><span class="n">默认为</span><span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">erasure-code</span><span class="err">；</span>
    <span class="p">-</span> <span class="n">plugin</span><span class="err">：</span><span class="n">用于生成及恢复纠删码块的插件名称</span><span class="err">，</span><span class="n">默认为jerasure</span><span class="err">；</span>
    <span class="p">-</span> <span class="n">crush-device-class</span><span class="err">：</span><span class="n">设备类别</span><span class="err">，</span><span class="n">例如hdd或ssd</span><span class="err">，</span><span class="n">默认为none</span><span class="err">，</span><span class="n">即无视类别</span><span class="err">；</span>
    <span class="p">-</span> <span class="n">crush-failure-domain</span><span class="err">：</span><span class="n">故障域</span><span class="err">，</span><span class="n">默认为host</span><span class="err">，</span><span class="n">支持使用的包括osd</span><span class="err">、</span><span class="n">host</span><span class="err">、</span><span class="n">rack</span><span class="err">、</span><span class="n">row和room等</span> <span class="err">；</span>
    <span class="p">-</span> <span class="p">-</span><span class="n">-force</span><span class="err">：</span><span class="n">强制覆盖现有的同名配置文件</span><span class="err">；</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">示例</span><span class="err">：</span>
    <span class="n">例如</span><span class="err">，</span><span class="n">如果所需的体系结构必须承受两个OSD的丢失</span><span class="err">，</span><span class="n">并且存储开销为40</span><span class="err">％</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">set </span><span class="n">myprofile</span>  <span class="n">k</span><span class="p">=</span><span class="n">4</span>  <span class="n">m</span><span class="p">=</span><span class="n">2</span> <span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>
    <span class="n">例如</span><span class="err">，</span><span class="n">下面的命令创建了一个使用lrc插件的配置文件LRCprofile</span><span class="err">，</span><span class="n">其本地奇偶校验块为3</span><span class="err">，</span><span class="n">故障域为osd</span>
    <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">set </span><span class="n">LRCprofile</span> <span class="n">plugin</span><span class="p">=</span><span class="n">lrc</span> <span class="n">k</span><span class="p">=</span><span class="n">4</span> <span class="n">m</span><span class="p">=</span><span class="n">2</span> <span class="n">l</span><span class="p">=</span><span class="n">3</span> <span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>
</code></pre></div>
<p>查看纠删码池</p>
<div class="highlight"><pre><span></span><code><span class="n">列出纠删码配置文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">ls</span>
<span class="k">default</span>

<span class="n">获取指定的配置文件的相关内容</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="n">get</span> <span class="k">default</span>
<span class="n">k</span><span class="p">=</span><span class="n">2</span>
<span class="n">m</span><span class="p">=</span><span class="n">1</span>
<span class="n">plugin</span><span class="p">=</span><span class="n">jerasure</span>
<span class="n">technique</span><span class="p">=</span><span class="n">reed_sol_van</span>
</code></pre></div>
<p>自定义纠删码配置</p>
<div class="highlight"><pre><span></span><code><span class="n">创建纠删码配置</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">set </span><span class="n">myprofile</span>  <span class="n">k</span><span class="p">=</span><span class="n">4</span>  <span class="n">m</span><span class="p">=</span><span class="n">2</span> <span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>

<span class="n">查看纠删码配置信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">ls</span>
<span class="k">default</span>
<span class="n">myprofile</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="n">get</span> <span class="n">myprofile</span>
<span class="n">crush-device-class</span><span class="p">=</span>
<span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>
<span class="n">crush-root</span><span class="p">=</span><span class="k">default</span>
<span class="n">jerasure-per-chunk-alignment</span><span class="p">=</span><span class="n">false</span>
<span class="n">k</span><span class="p">=</span><span class="n">4</span>
<span class="n">m</span><span class="p">=</span><span class="n">2</span>
<span class="n">plugin</span><span class="p">=</span><span class="n">jerasure</span>
<span class="n">technique</span><span class="p">=</span><span class="n">reed_sol_van</span>
<span class="n">w</span><span class="p">=</span><span class="n">8</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建定制的纠偏码池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">erasure-pool-myprofile</span> <span class="n">8</span> <span class="n">8</span> <span class="n">erasure</span> <span class="n">myprofile</span>
<span class="n">pool</span> <span class="s1">&#39;erasure-pool-myprofile&#39;</span> <span class="n">created</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">erasure-pool-myprofile</span>
<span class="n">pool</span> <span class="n">22</span> <span class="s1">&#39;erasure-pool-myprofile&#39;</span> <span class="n">erasure</span> <span class="n">size</span> <span class="n">6</span> <span class="n">min_size</span> <span class="n">5</span> <span class="n">crush_rule</span> <span class="n">2</span> <span class="n">object_hash</span> <span class="n">rjenkins</span> <span class="n">pg_num</span> <span class="n">8</span> <span class="n">pgp_num</span> <span class="n">8</span> <span class="n">autoscale_mode</span> <span class="n">warn</span> <span class="n">last_change</span> <span class="n">540</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">16384</span>
<span class="n">解析</span><span class="err">：</span>
    <span class="n">erasure</span> <span class="n">size</span> <span class="n">6</span> <span class="n">代表有</span><span class="p">(</span><span class="n">K</span><span class="p">+</span><span class="n">m</span><span class="p">)</span><span class="n">6个osd磁盘</span>
</code></pre></div>
<p>基于插件定制纠偏码配置</p>
<div class="highlight"><pre><span></span><code><span class="n">基于纠偏码算法定制专属配置</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">set </span><span class="n">LRCprofile</span> <span class="n">plugin</span><span class="p">=</span><span class="n">lrc</span> <span class="n">k</span><span class="p">=</span><span class="n">4</span> <span class="n">m</span><span class="p">=</span><span class="n">2</span> <span class="n">l</span><span class="p">=</span><span class="n">3</span> <span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>

<span class="n">查看纠删码配置信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">ls</span>
<span class="n">LRCprofile</span>
<span class="k">default</span>
<span class="n">myprofile</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="n">get</span> <span class="n">LRCprofile</span>
<span class="n">crush-device-class</span><span class="p">=</span>
<span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>
<span class="n">crush-root</span><span class="p">=</span><span class="k">default</span>
<span class="n">k</span><span class="p">=</span><span class="n">4</span>
<span class="n">l</span><span class="p">=</span><span class="n">3</span>
<span class="n">m</span><span class="p">=</span><span class="n">2</span>
<span class="n">plugin</span><span class="p">=</span><span class="n">lrc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建定制配置的纠偏码池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">erasure-pool-LRCprofile</span> <span class="n">1</span> <span class="n">1</span> <span class="n">erasure</span> <span class="n">LRCprofile</span>
<span class="n">pool</span> <span class="s1">&#39;erasure-pool-LRCprofile&#39;</span> <span class="n">created</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls </span><span class="n">detail</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">erasure-pool-LRCprofile</span>
<span class="n">pool</span> <span class="n">23</span> <span class="s1">&#39;erasure-pool-LRCprofile&#39;</span> <span class="p">...</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">16384</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="117">1.1.7 纠删码实践<a class="headerlink" href="#117" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 数据实践、异常实践、小结三个方面来学习。</p>
<p><strong>数据实践</strong></p>
<p>纠删码池数据实践</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">ecpool</span> <span class="n">12</span> <span class="n">12</span> <span class="n">erasure</span>
<span class="n">pool</span> <span class="s1">&#39;ecpool&#39;</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">数据写入实践</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">echo </span><span class="n">ABCDEFGHI</span> <span class="p">|</span> <span class="n">rados</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">ecpool</span> <span class="n">put</span> <span class="n">object_data</span> <span class="p">-</span>

<span class="n">数据读取实践</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="p">-</span><span class="n">-pool</span> <span class="n">ecpool</span> <span class="n">get</span> <span class="n">object_data</span> <span class="p">-</span>
<span class="n">ABCDEFGHI</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">数据写入和读取的实践命令末尾必须有一个</span> <span class="p">-</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">文件写入实践</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">echo </span><span class="n">test</span> <span class="p">&gt;</span> <span class="n">test</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">ecpool</span> <span class="n">put</span> <span class="n">test</span> <span class="n">test</span><span class="p">.</span><span class="n">txt</span>

<span class="n">文件读取实践</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">ecpool</span> <span class="n">get</span> <span class="n">test</span> <span class="n">file</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">file</span><span class="p">.</span><span class="n">txt</span>
<span class="n">test</span>
</code></pre></div>
<p>纠删码池不支持部分image功能</p>
<div class="highlight"><pre><span></span><code><span class="n">启用rbd功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">enable</span> <span class="n">ecpool</span> <span class="n">rbd</span>
<span class="n">enabled</span> <span class="n">application</span> <span class="s1">&#39;rbd&#39;</span> <span class="n">on</span> <span class="n">pool</span> <span class="s1">&#39;ecpool&#39;</span>

<span class="n">创建image操作</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">create</span> <span class="n">myimg</span> <span class="n">-p</span> <span class="n">ecpool</span> <span class="p">-</span><span class="n">-size</span> <span class="n">1024</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">29</span> <span class="n">01</span><span class="p">:</span><span class="n">01</span><span class="p">:</span><span class="n">01</span><span class="p">.</span><span class="n">144</span> <span class="n">7faafbfff700</span> <span class="p">-</span><span class="n">1</span> <span class="n">librbd</span><span class="p">::</span><span class="n">image</span><span class="p">::</span><span class="n">ValidatePoolRequest</span><span class="p">:</span> <span class="n">handle_overwrite_rbd_info</span><span class="p">:</span> <span class="n">pool</span> <span class="n">missing</span> <span class="n">required</span> <span class="n">overwrite</span> <span class="n">support</span>
<span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">29</span> <span class="n">01</span><span class="p">:</span><span class="n">01</span><span class="p">:</span><span class="n">01</span><span class="p">.</span><span class="n">144</span> <span class="n">7faafbfff700</span> <span class="p">-</span><span class="n">1</span> <span class="n">librbd</span><span class="p">::</span><span class="n">image</span><span class="p">::</span><span class="n">CreateRequest</span><span class="p">:</span> <span class="n">0x55a667ec7190</span> <span class="n">handle_validate_data_pool</span><span class="p">:</span> <span class="n">pool</span> <span class="n">does</span> <span class="n">not</span> <span class="n">support</span> <span class="n">RBD</span> <span class="n">images</span>
<span class="n">rbd</span><span class="p">:</span> <span class="n">create</span> <span class="n">error</span><span class="p">:</span> <span class="p">(</span><span class="n">22</span><span class="p">)</span> <span class="n">Invalid</span> <span class="n">argument</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">纠偏码池不支持RBD</span> <span class="n">images的参数操作</span>
</code></pre></div>
<p><strong>异常实践</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">创建纠删码配置</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span>  <span class="nb">set </span><span class="n">Ecprofile</span> <span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span> <span class="n">k</span><span class="p">=</span><span class="n">3</span> <span class="n">m</span><span class="p">=</span><span class="n">2</span>

<span class="n">查看纠删码配置信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="nb">ls</span>
<span class="n">Ecprofile</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure-code-profile</span> <span class="n">get</span>  <span class="n">Ecprofile</span>
<span class="n">crush-device-class</span><span class="p">=</span>
<span class="n">crush-failure-domain</span><span class="p">=</span><span class="n">osd</span>
<span class="n">crush-root</span><span class="p">=</span><span class="k">default</span>
<span class="n">jerasure-per-chunk-alignment</span><span class="p">=</span><span class="n">false</span>
<span class="n">k</span><span class="p">=</span><span class="n">3</span>
<span class="n">m</span><span class="p">=</span><span class="n">2</span>
<span class="n">plugin</span><span class="p">=</span><span class="n">jerasure</span>
<span class="n">technique</span><span class="p">=</span><span class="n">reed_sol_van</span>
<span class="n">w</span><span class="p">=</span><span class="n">8</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">基于纠删码配置文件创建erasure类型的Ceph池</span><span class="err">：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">Ecpool</span> <span class="n">16</span> <span class="n">16</span> <span class="n">erasure</span> <span class="n">Ecprofile</span>
<span class="n">pool</span> <span class="s1">&#39;Ecpool&#39;</span> <span class="n">created</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">Ecpool</span>
<span class="n">pool</span> <span class="n">25</span> <span class="s1">&#39;Ecpool&#39;</span> <span class="n">erasure</span> <span class="n">size</span> <span class="n">5</span> <span class="n">min_size</span> <span class="n">4</span> <span class="n">crush_rule</span> <span class="n">4</span> <span class="n">object_hash</span> <span class="n">rjenkins</span> <span class="n">pg_num</span> <span class="n">16</span> <span class="n">pgp_num</span> <span class="n">16</span> <span class="n">autoscale_mode</span> <span class="n">warn</span> <span class="n">last_change</span> <span class="n">566</span> <span class="n">flags</span> <span class="n">hashpspool</span> <span class="n">stripe_width</span> <span class="n">12288</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">erasure</span> <span class="n">size</span> <span class="n">5</span> <span class="n">表示</span> <span class="n">3</span><span class="p">+</span><span class="n">2</span><span class="p">=</span><span class="n">5</span> <span class="n">个osd磁盘来存储数据和校验码</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建文件后提交文件到纠删码池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">echo </span><span class="n">test_ecpool</span> <span class="p">&gt;</span> <span class="n">test_file</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">put</span> <span class="n">-p</span> <span class="n">Ecpool</span> <span class="n">object1</span> <span class="n">test_file</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">Ecpool</span> <span class="nb">ls</span>
<span class="n">object1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查纠删码池中和object1的OSDmap</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">map</span> <span class="n">Ecpool</span> <span class="n">object1</span>
<span class="n">osdmap</span> <span class="n">e566</span> <span class="n">pool</span> <span class="s1">&#39;Ecpool&#39;</span> <span class="p">(</span><span class="n">25</span><span class="p">)</span> <span class="n">object</span> <span class="s1">&#39;object1&#39;</span> <span class="p">-&gt;</span> <span class="n">pg</span> <span class="n">25</span><span class="p">.</span><span class="n">bac5debc</span> <span class="p">(</span><span class="n">25</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">up</span> <span class="p">([</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="n">5</span><span class="p">],</span> <span class="n">p2</span><span class="p">)</span> <span class="n">acting</span> <span class="p">([</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="n">5</span><span class="p">],</span> <span class="n">p2</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">0</span><span class="p">-</span><span class="n">5的osd磁盘上都有我们的数据库和校验块</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">找到两台节点</span><span class="err">，</span><span class="n">将两个被用到的osd移除</span><span class="err">，</span><span class="n">比如mon02主机上的osd2</span><span class="err">，</span><span class="n">mon03主机上的osd5</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon03</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">ceph-osd</span><span class="nv">@5</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ssh</span> <span class="n">mon02</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">ceph-osd</span><span class="nv">@2</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>      <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">...</span>
<span class="p">-</span><span class="n">5</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon02</span>
 <span class="n">2</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">2</span>    <span class="n">down</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">3</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">3</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
<span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">03897</span>     <span class="n">host</span> <span class="n">mon03</span>
 <span class="n">4</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>      <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="n">5</span>   <span class="n">hdd</span> <span class="n">0</span><span class="p">.</span><span class="n">01949</span>         <span class="n">osd</span><span class="p">.</span><span class="n">5</span>    <span class="n">down</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查EC池和object1的OSDmap</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">map</span> <span class="n">Ecpool</span> <span class="n">object1</span>
<span class="n">osdmap</span> <span class="n">e574</span> <span class="n">pool</span> <span class="s1">&#39;Ecpool&#39;</span> <span class="p">(</span><span class="n">25</span><span class="p">)</span> <span class="n">object</span> <span class="s1">&#39;object1&#39;</span> <span class="p">-&gt;</span> <span class="n">pg</span> <span class="n">25</span><span class="p">.</span><span class="n">bac5debc</span> <span class="p">(</span><span class="n">25</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">up</span> <span class="p">(</span><span class="no">[NONE,1,0,4,NONE]</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span> <span class="n">acting</span> <span class="p">(</span><span class="no">[NONE,1,0,4,NONE]</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">osd</span><span class="p">.</span><span class="n">5和osd</span><span class="p">.</span><span class="n">2</span> <span class="n">已经不管用了</span>

<span class="n">获取文件查看</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">Ecpool</span> <span class="n">get</span> <span class="n">object1</span> <span class="n">ok</span><span class="p">.</span><span class="n">txt</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">查看文件失败</span><span class="err">，</span><span class="n">可以看到</span><span class="err">，</span><span class="n">不允许有超过2个osd失败的效果</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="12_1">1.2 存储进阶<a class="headerlink" href="#12_1" title="Permanent link">&para;</a></h2>
<h3 id="121_2">1.2.1 原理解读<a class="headerlink" href="#121_2" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>存储池</p>
<div class="highlight"><pre><span></span><code>    <span class="n">RADOS存储集群提供的基础存储服务需要由</span><span class="err">“</span><span class="n">pool</span><span class="err">”</span><span class="n">分割为逻辑存储区域</span> <span class="p">--</span> <span class="n">对象数据的名称空间</span><span class="err">。</span><span class="n">我们在部署ceph集群的过程中</span><span class="err">，</span><span class="n">涉及到大量的应用程序</span><span class="err">，</span><span class="n">而这些应用程序在创建的时候</span><span class="err">，</span><span class="n">需要专属的数据存储空间</span><span class="p">--</span><span class="n">存储池</span><span class="err">，</span><span class="n">比如rbd存储池</span><span class="err">、</span><span class="n">rgw存储池</span><span class="err">、</span><span class="n">cephfs存储池等</span><span class="err">。</span>
    <span class="n">存储池还可以再进一步细分为一至多个子名称空间</span><span class="err">，</span><span class="n">比如我们在看pool的时候</span>
    <span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">ls</span>
    <span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">root</span>
    <span class="k">default</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">control</span>
    <span class="p">{</span><span class="n">根命名空间</span><span class="p">}.{</span><span class="n">应用命名空间</span><span class="p">}.{</span><span class="n">子空间</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">对于Ceph集群来说</span><span class="err">，</span><span class="n">它的存储池主要由默认的副本池</span><span class="p">(</span><span class="n">replicated</span> <span class="n">pool</span><span class="p">)</span><span class="n">和纠删码池</span><span class="p">(</span><span class="n">erasure</span> <span class="n">code</span><span class="p">)</span> <span class="n">两种类型组成</span><span class="err">。</span>
    <span class="n">客户端在使用这些存储池的时候</span><span class="err">，</span><span class="n">往往依赖于相关用户信息的认证机制</span><span class="err">。</span>
</code></pre></div>
<p>数据存储逻辑</p>
<p><img alt="1636103641572" src="../../../img/kubernetes/kubernetes_storage_ceph/1636103641572.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">在</span> <span class="n">RADOS</span> <span class="n">集群中动态存储</span><span class="err">、</span><span class="n">复制和重新平衡数据对象</span><span class="err">。</span><span class="n">由于许多不同的用户在无数</span> <span class="n">OSD</span> <span class="n">上出于不同目的将对象存储在不同的池中</span><span class="err">，</span><span class="n">因此</span> <span class="n">Ceph</span> <span class="n">操作需要一些数据放置规划</span><span class="err">。</span><span class="n">Ceph</span> <span class="n">中主要的数据放置规划概念包括</span><span class="err">：</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Pools</span><span class="err">（</span><span class="n">池</span><span class="err">）：</span>
    <span class="n">Ceph</span> <span class="n">将数据存储在pool中</span><span class="err">，</span><span class="n">pool是用于存储对象的逻辑组</span><span class="err">。</span><span class="n">首次部署集群而不创建pool时</span><span class="err">，</span><span class="n">Ceph</span> <span class="n">使用默认pool来存储数据</span><span class="err">。</span>
    <span class="n">pool主要管理的内容有</span><span class="err">：</span><span class="n">PG的数量</span><span class="err">、</span><span class="n">副本的数量和pool的</span> <span class="n">CRUSH</span> <span class="n">规则</span><span class="err">。</span>
    <span class="n">当然了</span><span class="err">。</span><span class="n">要将数据存储在池中</span><span class="err">，</span><span class="n">您必须有一个经过身份验证的用户</span><span class="err">，</span><span class="n">该用户具有该池的权限</span><span class="err">。</span>
<span class="n">参考资料</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">quincy</span><span class="p">/</span><span class="n">rados</span><span class="p">/</span><span class="n">operations</span><span class="p">/</span><span class="n">pools</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Placement</span> <span class="n">Groups</span><span class="err">（</span><span class="n">归置组</span><span class="err">）：</span>
    <span class="n">归置组</span> <span class="p">(</span><span class="n">PG</span><span class="p">)</span> <span class="n">是</span> <span class="n">Ceph</span> <span class="n">如何分发数据的内部实现细节</span><span class="err">。</span>
    <span class="n">Ceph</span> <span class="n">将对象映射到归置组</span><span class="p">(</span><span class="n">PG</span><span class="p">)</span><span class="err">，</span><span class="n">归置组</span><span class="p">(</span><span class="n">PG</span><span class="p">)</span><span class="n">是逻辑对象池的分片或片段</span><span class="err">，</span><span class="n">它们将对象作为一个组放置到OSD中</span><span class="err">。</span><span class="n">当</span> <span class="n">Ceph</span> <span class="n">将数据存储在</span> <span class="n">OSD</span> <span class="n">中时</span><span class="err">，</span><span class="n">放置组会减少每个对象的元数据量</span><span class="err">。</span>
    <span class="n">每个</span> <span class="n">PG</span> <span class="n">都属于一个特定的Pool</span><span class="err">，</span><span class="n">因此当多个Pool使用相同的</span> <span class="n">OSD</span> <span class="n">时</span><span class="err">，</span><span class="n">必须注意每个OSD的PG副本的总和不能超过OSD自身允许的PG数量阈值</span><span class="err">。</span>
<span class="n">参考资料</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">quincy</span><span class="p">/</span><span class="n">rados</span><span class="p">/</span><span class="n">operations</span><span class="p">/</span><span class="n">placement-groups</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">CRUSH</span> <span class="n">Maps</span><span class="err">（</span><span class="n">CRUSH</span> <span class="n">映射</span><span class="err">）：</span> 
    <span class="n">CRUSH</span> <span class="n">是让</span> <span class="n">Ceph</span> <span class="n">在正常运行情况下进行数据扩展的重要部分</span><span class="err">。</span><span class="n">CRUSH</span> <span class="n">映射为</span> <span class="n">CRUSH</span> <span class="n">算法提供集群的物理拓扑数据</span><span class="err">，</span><span class="n">以确定对象及其副本的数据应该存储在哪里</span><span class="err">，</span><span class="n">以及如何跨故障域以增加数据安全等</span><span class="err">。</span>
<span class="n">参考资料</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">quincy</span><span class="p">/</span><span class="n">rados</span><span class="p">/</span><span class="n">operations</span><span class="p">/</span><span class="n">crush-map</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Balancer</span><span class="err">：</span>
    <span class="n">平衡器是一个功能</span><span class="err">，</span><span class="n">它会自动优化PG跨设备的分布</span><span class="err">，</span><span class="n">以实现数据的均衡分布</span><span class="err">，</span><span class="n">最大化集群中可以存储的数据量</span><span class="err">，</span><span class="n">并在OSD之间平均分配工作负载</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Pool数量</span><span class="err">、</span><span class="n">CRUSH规则和PG数量决定了</span> <span class="n">Ceph</span> <span class="n">将如何放置数据</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph</span> <span class="n">的</span> <span class="n">RADOS中</span><span class="err">，</span><span class="n">引入了</span> <span class="n">PG</span> <span class="n">的概念用以更好地管理数据</span><span class="err">。</span><span class="n">PG</span> <span class="n">的引入降低对数量巨大的对象的管理难度</span><span class="err">。</span>
    <span class="n">1</span><span class="err">、</span><span class="n">对象数量时刻处于变化中</span><span class="err">。</span><span class="n">而PG的数量经过人工规划因而严格可控</span><span class="err">。</span>
    <span class="n">2</span><span class="err">、</span><span class="n">PG数量远小于对象</span><span class="err">，</span><span class="n">且生命周期稳定</span><span class="err">。</span><span class="n">因此以PG为单位进行数据同步或者迁移</span><span class="err">，</span><span class="n">相比较对象难度更小</span><span class="err">。</span>

<span class="n">PG</span> <span class="n">最引人注目之处在于其可以在OSD之间</span><span class="err">（</span><span class="n">根据CRUSH的实时计算结果</span><span class="err">）</span><span class="n">自由迁移</span><span class="err">，</span><span class="n">这是ceph赖以实现自动数据恢复</span><span class="err">、</span><span class="n">自动数据平衡等高级特性的基础</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">RADOS</span> <span class="n">提供的是基于</span> <span class="n">Object</span> <span class="n">的存储功能</span><span class="err">，</span><span class="n">每个</span> <span class="n">Object</span> <span class="n">会先通过简单的</span> <span class="n">Hash</span> <span class="n">算法归到一个</span> <span class="n">PG</span> <span class="n">中</span><span class="err">，</span><span class="n">PGID</span> <span class="n">再作为</span><span class="s2">&quot;参数&quot;</span><span class="n">通过</span> <span class="n">CRUSH</span> <span class="n">计算置入到多个</span> <span class="n">OSD</span> <span class="n">中</span><span class="err">。</span>
    <span class="n">Object</span> <span class="p">-</span> <span class="n">可以理解为一个文件</span>
    <span class="n">PG</span>     <span class="p">-</span> <span class="n">可以理解为一个目录</span>
    <span class="n">OSD</span>    <span class="p">-</span> <span class="n">可以理解我一个PG目录下的简易文件系统</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">存储池在操作资源对象的时候</span><span class="err">，</span><span class="n">需要设置</span><span class="err">：</span><span class="n">对象的所有权</span><span class="p">/</span><span class="n">访问权</span><span class="err">、</span><span class="n">归置组的数量</span><span class="err">、</span><span class="n">CRUSH</span> <span class="n">规则</span> 
</code></pre></div>
<p>PG 映射到 OSD</p>
<p><img alt="image-20220930074909586" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220930074909586.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">每个Pool都有许多归置组</span><span class="err">。</span><span class="n">当</span> <span class="n">Ceph</span> <span class="n">客户端存储对象时</span><span class="err">，</span><span class="n">CRUSH</span> <span class="n">会将每个对象映射到一个归置组</span><span class="p">,</span><span class="n">然后CRUSH</span> <span class="n">将</span> <span class="n">PG</span> <span class="n">动态映射到</span> <span class="n">OSD</span><span class="err">。</span>
    <span class="n">所以说</span><span class="err">，</span><span class="n">PG相当于</span> <span class="n">OSD守护进程</span> <span class="n">和</span> <span class="n">Ceph客户端之间的一个中间层</span><span class="err">：</span>
        <span class="n">1</span> <span class="n">通过CRUSH实现数据对象动态平衡的分散到所有OSD中</span><span class="err">，</span><span class="n">同时也可以让客户端知道数据在哪个OSD中</span>
        <span class="n">2</span> <span class="n">中间层还允许新加入的OSD和其他OSD在数据负载时候实现动态平衡</span>
</code></pre></div>
<p>PG id</p>
<div class="highlight"><pre><span></span><code>    <span class="n">当</span> <span class="n">Ceph客户端绑定到</span> <span class="n">Ceph</span> <span class="n">Mon节点时</span><span class="err">，</span><span class="n">它会检索</span> <span class="n">Cluster</span> <span class="n">Map的最新副本</span><span class="err">。</span><span class="n">客户端可以通过Cluster</span> <span class="n">Map了解集群中的所有监视器</span><span class="err">、</span><span class="n">OSD和元数据服务器信息</span><span class="err">。</span><span class="n">由于数据对象与Cluster</span> <span class="n">Map无关</span><span class="err">，</span><span class="n">所以它对对象位置一无所知</span><span class="err">。</span>
    <span class="n">客户端操作数据对象的时候</span><span class="err">，</span><span class="n">需要指定</span> <span class="n">对象ID</span><span class="p">(</span><span class="n">就是对象名称</span><span class="p">)</span><span class="n">和Pool</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">CRUSH算法允许客户端计算对象应该存储在哪里</span><span class="err">，</span><span class="n">从而实现客户端能够快速联系主</span> <span class="n">OSD</span> <span class="n">以存储或检索对象</span><span class="err">。</span>
    <span class="n">1</span> <span class="n">Ceph</span> <span class="n">客户端输入Pool名称和对象ID</span>
        <span class="n">rados</span> <span class="n">put</span> <span class="p">{</span><span class="n">object_name</span><span class="p">}</span> <span class="p">/</span><span class="n">path</span><span class="p">/</span><span class="n">to</span><span class="p">/</span><span class="n">local_file</span> <span class="p">-</span><span class="n">-pool</span><span class="p">={</span><span class="n">pool_name</span><span class="p">}</span>
    <span class="n">2</span> <span class="n">Ceph</span> <span class="n">获取对象ID后对其进行hash处理</span>
        <span class="n">hash</span><span class="p">(</span><span class="n">对象ID名称</span><span class="p">)</span><span class="k">%</span><span class="n">PG_num</span>
    <span class="n">3</span> <span class="n">Ceph</span> <span class="n">基于PG数为模对PG进行哈希计算后获取</span> <span class="n">PG</span> <span class="n">ID</span><span class="err">，</span><span class="n">比如</span> <span class="n">58</span>
    <span class="n">4</span> <span class="n">Ceph</span> <span class="n">根据pool名称获取Pool</span> <span class="n">ID</span><span class="err">，</span><span class="n">比如</span> <span class="n">4</span>
    <span class="n">5</span> <span class="n">Ceph</span> <span class="n">将pool</span> <span class="n">ID</span> <span class="n">附加到</span> <span class="n">PG</span> <span class="n">ID</span><span class="err">，</span><span class="n">比如</span> <span class="n">4</span><span class="p">.</span><span class="n">58</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">守护进程会检查彼此的心跳并向</span> <span class="n">Ceph</span> <span class="n">Mon节点报告状态信息</span><span class="err">。</span>
    <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">守护进程会将同一组PG中所有对象的状态进行一致性同步</span><span class="err">，</span><span class="n">同步异常往往会自动解决</span>
</code></pre></div>
<p>数据一致性</p>
<div class="highlight"><pre><span></span><code>    <span class="n">为了保证Ceph</span> <span class="n">存储集群的数据安全向</span><span class="err">，</span><span class="n">它被设计为存储至少两个对象副本</span><span class="err">，</span><span class="n">以便它可以在保持数据安全的同时继续在某个状态下运行</span><span class="err">。</span>
    <span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph daemon osd.0 config show | grep default_size</span>
    <span class="s2">&quot;osd_pool_default_size&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph osd pool get ecpool size</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">3</span>
    <span class="n">所以PG在关联的时候</span><span class="err">，</span><span class="n">往往会关联多个OSD的id值</span><span class="err">，</span><span class="n">我们会将同一个PG关联的多个OSD集合称为</span> <span class="n">Acting</span> <span class="n">Set</span><span class="err">，</span><span class="n">注意该Set是一个有序集合</span><span class="err">。</span><span class="n">其中第一个OSD</span><span class="err">，</span><span class="n">我们将其称为</span> <span class="n">Primary</span> <span class="n">OSD</span><span class="err">，</span><span class="n">然后依次类推为</span> <span class="n">Secondary</span> <span class="n">OSD等等</span><span class="err">。</span><span class="n">注意Primary</span> <span class="n">OSD守护进程会维护同一组PG的所有OSD副本数据状态的一致性</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">对于Acting</span> <span class="n">Set的</span> <span class="n">Ceph</span> <span class="n">OSD</span> <span class="n">守护进程状态主要有四种</span><span class="err">：</span>
        <span class="n">UP</span><span class="p">(</span><span class="n">启动已运行</span><span class="p">)</span><span class="err">、</span><span class="n">Down</span><span class="p">(</span><span class="n">关闭未运行</span><span class="p">)</span><span class="err">、</span><span class="k">In</span><span class="p">(</span><span class="n">集群中</span><span class="p">)</span><span class="err">、</span><span class="n">Out</span><span class="p">(</span><span class="n">集群外</span><span class="p">),</span>

    <span class="n">我们可以通过</span> <span class="n">ceph</span> <span class="n">-s</span><span class="err">、</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span><span class="err">、</span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">stat来查看OSD的状态信息</span>
    <span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># ceph osd stat</span>
    <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">14h</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">14h</span><span class="p">);</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">e631</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">OSD和PG上的每一次状态变更的历史信息</span><span class="err">，</span><span class="n">我们称为epoch</span>
</code></pre></div>
<p><img alt="image-20220930111350189" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220930111350189.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="122_2">1.2.2 归置组<a class="headerlink" href="#122_2" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>PG简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">当用户在Ceph存储集群中创建存储池Pool的时候</span><span class="err">，</span><span class="n">我们往往会为它创建PG和PGS</span><span class="err">，</span><span class="n">如果我们没有指定PG和PGP的话</span><span class="err">，</span><span class="n">则Ceph使用配置文件中的默认值来创建Pool的PG和PGP</span><span class="err">。</span><span class="n">通常情况下</span><span class="err">，</span><span class="n">我们建议用户根据实际情况在配置文件中自定义pool的对象副本数量和PG数目</span><span class="err">。</span>
<span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">rados</span><span class="p">/</span><span class="n">configuration</span><span class="p">/</span><span class="n">pool-pg-config-ref</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">关于对象副本数目</span><span class="err">，</span><span class="n">用户可以根据自身对于数据安全性的要求程度进行设置</span><span class="err">，</span><span class="n">Ceph默认存储一份主数据对象和两个副本数据</span><span class="p">(</span><span class="n">osd</span> <span class="n">pool</span> <span class="k">default</span> <span class="n">size</span> <span class="p">=</span> <span class="n">3</span><span class="p">)</span><span class="err">。</span><span class="n">对于PG数目</span><span class="err">，</span><span class="n">假如数据对象副本数目为N</span><span class="err">，</span><span class="n">集群OSD数量为M</span><span class="err">，</span><span class="n">则每个OSD上的PG数量为X</span><span class="err">，</span><span class="n">官方提供了一个默认的PG数量计算公式</span><span class="err">。</span>
    <span class="n">PG</span><span class="p">|</span><span class="n">PGP</span> <span class="n">数量</span> <span class="p">=</span> <span class="n">M</span> <span class="p">*</span> <span class="n">X</span> <span class="p">/</span> <span class="n">N</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">官方推荐X默认的值为100</span>
    <span class="n">再一个</span><span class="err">，</span><span class="n">PG算出来的数据往往不是一个整数</span><span class="err">，</span><span class="n">但是我们往往将该值取为最接近2的幂次方值</span><span class="err">。</span>  
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">PG数量计数</span><span class="err">：</span>
    <span class="n">假如Ceph集群有100个OSD</span><span class="err">，</span><span class="n">数据副本为3</span><span class="err">，</span><span class="n">则PG数量值为</span> <span class="n">100</span><span class="p">*</span><span class="n">100</span><span class="p">/</span><span class="n">3</span><span class="p">=</span><span class="n">3333</span><span class="p">.</span><span class="n">33</span><span class="p">,</span><span class="n">该值不是一个整数</span><span class="err">，</span><span class="n">我们将该值取为4096</span><span class="p">(</span><span class="n">2</span><span class="p">^</span><span class="n">12</span><span class="p">),</span><span class="n">所以我们可以将PG相关的属性设置为</span>
    <span class="no">[global]</span>
    <span class="n">osd</span> <span class="n">pool</span> <span class="k">default</span> <span class="n">size</span> <span class="p">=</span> <span class="n">4</span>
    <span class="n">osd</span> <span class="n">pool</span> <span class="k">default</span> <span class="n">min</span> <span class="n">size</span> <span class="p">=</span> <span class="n">1</span>
    <span class="n">osd</span> <span class="n">pool</span> <span class="k">default</span> <span class="n">pg</span> <span class="n">mum</span> <span class="p">=</span> <span class="n">4096</span>
    <span class="n">osd</span> <span class="n">pool</span> <span class="k">default</span> <span class="n">pgp</span> <span class="n">mum</span> <span class="p">=</span> <span class="n">4096</span>

<span class="n">常见数量统计</span><span class="err">：</span>
    <span class="n">OSD</span><span class="p">&lt;</span><span class="n">5个</span><span class="err">，</span><span class="n">pg_num</span> <span class="n">设置为</span> <span class="n">256</span><span class="err">；</span><span class="n">5个</span><span class="p">&lt;</span><span class="n">OSD</span><span class="p">&lt;</span><span class="n">10个</span><span class="err">，</span><span class="n">pg_num</span> <span class="n">设置为</span> <span class="n">512</span><span class="err">；</span>
    <span class="n">10个</span><span class="p">&lt;</span><span class="n">OSD</span><span class="p">&lt;</span><span class="n">50个</span><span class="err">，</span><span class="n">pg_num</span> <span class="n">设置为</span> <span class="n">2048</span><span class="err">；</span><span class="n">50个</span><span class="p">&lt;</span><span class="n">OSD</span><span class="err">，</span><span class="n">pg_num</span> <span class="n">设置为</span> <span class="n">4096</span><span class="err">；</span>
</code></pre></div>
<p>信息查看</p>
<div class="highlight"><pre><span></span><code><span class="n">存储池的归置组数量设置好之后</span><span class="err">，</span><span class="n">还可以增加</span><span class="err">，</span><span class="n">但不可以减少</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">mypool</span> <span class="n">128</span>
<span class="n">pool</span> <span class="s1">&#39;mypool&#39;</span> <span class="n">created</span>

<span class="n">获取PG和PGP的数量</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">mypool</span> <span class="n">pg_num</span>
<span class="n">pg_num</span><span class="p">:</span> <span class="n">128</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">get</span> <span class="n">mypool</span> <span class="n">pgp_num</span>
<span class="n">pgp_num</span><span class="p">:</span> <span class="n">128</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">调整PG的数量</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">mypool</span> <span class="n">pg_num</span> <span class="n">256</span>
<span class="nb">set </span><span class="n">pool</span> <span class="n">7</span> <span class="n">pg_num</span> <span class="n">to</span> <span class="n">256</span>

<span class="n">调整PGP的数量</span><span class="p">(</span><span class="n">不允许大于PG梳理</span><span class="p">)</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">mypool</span> <span class="n">pgp_num</span> <span class="n">512</span>
<span class="n">Error</span> <span class="n">EINVAL</span><span class="p">:</span> <span class="n">specified</span> <span class="n">pgp_num</span> <span class="n">512</span> <span class="p">&gt;</span> <span class="n">pg_num</span> <span class="n">256</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">set </span><span class="n">mypool</span> <span class="n">pgp_num</span> <span class="n">256</span>
<span class="nb">set </span><span class="n">pool</span> <span class="n">7</span> <span class="n">pgp_num</span> <span class="n">to</span> <span class="n">256</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取完整的PG的统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">json</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span> <span class="p">-</span><span class="n">-format</span><span class="p">=</span><span class="n">json-pretty</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取精简的PG统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">pgs</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">1</span> <span class="n">pools</span><span class="p">,</span> <span class="n">256</span> <span class="n">pgs</span>
    <span class="n">pgs</span><span class="p">:</span>     <span class="n">256</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump_stuck</span>
<span class="n">ok</span>

<span class="n">查看所有PG的状态</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">stat</span>
<span class="n">256</span> <span class="n">pgs</span><span class="p">:</span> <span class="n">256</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span><span class="p">;</span> <span class="n">0</span> <span class="n">B</span> <span class="n">data</span><span class="p">,</span> <span class="n">122</span> <span class="n">MiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">114</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看指定PG值的统计信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span> <span class="n">query</span>
</code></pre></div>
<p>状态</p>
<div class="highlight"><pre><span></span><code><span class="n">检查集群状态时</span><span class="p">(</span><span class="n">ceph</span> <span class="n">-s</span><span class="p">)</span><span class="err">，</span> <span class="n">Ceph</span> <span class="n">会报告归置组状态</span><span class="p">,</span><span class="n">其最优状态为</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span><span class="err">。</span><span class="n">其他常见状态有</span><span class="err">：</span>
    <span class="n">Creating</span>            <span class="n">Ceph</span> <span class="n">仍在创建归置组</span><span class="err">。</span>
    <span class="n">Active</span>              <span class="n">Ceph</span> <span class="n">可处理到归置组的请求</span><span class="err">。</span>
    <span class="n">Clean</span>               <span class="n">Ceph</span> <span class="n">把归置组内的对象复制了规定次数</span><span class="err">。</span>
    <span class="n">Down</span>                <span class="n">包含必备数据的副本挂了</span><span class="err">，</span><span class="n">所以归置组离线</span><span class="err">。</span>
    <span class="n">Replay</span>              <span class="n">某</span> <span class="n">OSD</span> <span class="n">崩溃后</span><span class="err">，</span><span class="n">归置组在等待客户端重放操作</span><span class="err">。</span>
    <span class="n">Splitting</span>           <span class="n">Ceph</span> <span class="n">正在把一归置组分割为多个</span><span class="err">。（</span><span class="n">实现了</span><span class="err">？）</span>
    <span class="n">Scrubbing</span>           <span class="n">Ceph</span> <span class="n">正在检查归置组的一致性</span><span class="err">。</span>
    <span class="n">Degraded</span>            <span class="n">归置组内的对象还没复制到规定次数</span><span class="err">。</span>
    <span class="n">Inconsistent</span>        <span class="n">Ceph</span> <span class="n">检测到了归置组内一或多个副本间不一致现象</span><span class="err">。</span>
    <span class="n">Peering</span>             <span class="n">归置组正在互联</span><span class="err">。</span>
    <span class="n">Repair</span>              <span class="n">Ceph</span> <span class="n">正在检查归置组</span><span class="err">、</span><span class="n">并试图修复发现的不一致</span><span class="err">（</span><span class="n">如果可能的话</span><span class="err">）。</span>
    <span class="n">Recovering</span>          <span class="n">Ceph</span> <span class="n">正在迁移</span><span class="p">/</span><span class="n">同步对象及其副本</span><span class="err">。</span>
    <span class="n">Backfill</span>            <span class="n">Ceph</span> <span class="n">正在扫描并同步整个归置组的内容</span><span class="err">，</span><span class="n">Backfill</span> <span class="n">是恢复的一种特殊情况</span><span class="err">。</span>
    <span class="nb">Wait-backfill</span>       <span class="n">归置组正在排队</span><span class="err">，</span><span class="n">等候回填</span><span class="err">。</span>
    <span class="n">Backfill-toofull</span>    <span class="n">一回填操作在等待</span><span class="err">，</span><span class="n">因为目标</span> <span class="n">OSD</span> <span class="n">使用率超过了占满率</span><span class="err">。</span>
    <span class="n">Incomplete</span>          <span class="n">Ceph</span> <span class="n">探测到某一归置组异常</span><span class="err">。</span>
    <span class="n">Stale</span>               <span class="n">归置组处于一种未知状态</span><span class="err">，</span><span class="n">从归置组运行图变更起就没再收到它的更新</span><span class="err">。</span>
    <span class="n">Remapped</span>            <span class="n">归置组被临时映射到了另外一组</span> <span class="n">OSD</span> <span class="err">，</span><span class="n">它们不是</span> <span class="n">CRUSH</span> <span class="n">算法指定的</span><span class="err">。</span>
    <span class="n">Undersized</span>          <span class="n">此归置组的副本数小于配置的存储池副本水平</span><span class="err">。</span>
    <span class="n">Peered</span>              <span class="n">此归置组已互联</span><span class="err">，</span><span class="n">因为副本数没有达到标准</span><span class="err">，</span><span class="n">不能向客户端提供服务</span>

<span class="n">异常状态标识</span>
    <span class="n">Inactive</span>            <span class="n">归置组不能处理读写</span><span class="err">，</span><span class="n">因为它们在等待一个有最新数据的</span> <span class="n">OSD</span> <span class="n">复活且进入集群</span><span class="err">。</span>
    <span class="n">Unclean</span>             <span class="n">归置组含有复制数未达到期望数量的对象</span><span class="err">，</span><span class="n">它们应该在恢复中</span><span class="err">。</span>
    <span class="n">Stale</span>               <span class="n">归置组处于未知状态</span><span class="err">：</span><span class="n">存储它们的</span> <span class="n">OSD</span> <span class="n">有段时间没向监视器报告了</span><span class="err">。</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>获取特殊状态的PG</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump_stuck</span> <span class="n">stale</span>
<span class="n">ok</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">其他的异常状态有</span><span class="err">：</span><span class="n">inactive</span><span class="p">|</span><span class="n">unclean</span><span class="p">|</span><span class="n">stale</span><span class="p">|</span><span class="n">undersized</span><span class="p">|</span><span class="n">degraded</span>
</code></pre></div>
<p>列举不一致pg信息</p>
<div class="highlight"><pre><span></span><code><span class="n">列出不一致的PG</span><span class="err">：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">list-inconsistent-pg</span> <span class="n">mypool</span>
<span class="p">[]</span>
<span class="n">列出不一致的</span> <span class="n">rados</span> <span class="n">对象</span><span class="err">：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">list-inconsistent-obj</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span>
<span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span><span class="n">156</span><span class="p">,</span><span class="s2">&quot;inconsistents&quot;</span><span class="p">:[]}</span>

<span class="n">列出给定置放群组中不一致的快照集</span><span class="err">：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">list-inconsistent-snapset</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span>
<span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span><span class="n">156</span><span class="p">,</span><span class="s2">&quot;inconsistents&quot;</span><span class="p">:[]}</span>
</code></pre></div>
<p>修复损坏pg信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">repair</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span>
<span class="n">instructing</span> <span class="n">pg</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span> <span class="n">on</span> <span class="n">osd</span><span class="p">.</span><span class="n">4</span> <span class="n">to</span> <span class="n">repair</span>
</code></pre></div>
<p>临时PG</p>
<div class="highlight"><pre><span></span><code>    <span class="n">假设一个PG的acting</span> <span class="n">set为</span><span class="p">[</span><span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">]</span><span class="n">列表</span><span class="err">。</span><span class="n">此时如果osd0出现故障</span><span class="err">，</span><span class="n">导致CRUSH算法重新分配该PG的acting</span> <span class="n">set为</span><span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">]</span><span class="err">。</span><span class="n">此时osd3为该PG的主OSD</span><span class="err">，</span><span class="n">但是OSD3为新加入的OSD</span><span class="err">，</span><span class="n">并不能负担该PG上的读操作</span><span class="err">。</span><span class="n">所以PG向Monitor申请一个临时的PG</span><span class="err">，</span><span class="n">osd1为临时的主OSD</span><span class="err">，</span><span class="n">这是up</span> <span class="n">set变为</span><span class="p">[</span><span class="n">1</span><span class="p">,</span><span class="n">3</span><span class="p">,</span><span class="n">2</span><span class="p">]</span><span class="err">，</span><span class="n">acting</span> <span class="n">set依然为</span><span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">]</span><span class="err">，</span><span class="n">导致acting</span> <span class="n">set和up</span> <span class="n">set不同</span><span class="err">。</span><span class="n">当osd3完成Backfill过程之后</span><span class="err">，</span><span class="n">临时PG被取消</span><span class="err">，</span><span class="n">该PG的up</span> <span class="n">set修复为acting</span> <span class="n">set</span><span class="err">，</span><span class="n">此时acting</span> <span class="n">set和up</span> <span class="n">set都是</span><span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">]</span><span class="n">列表</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="123_1">1.2.3 运行图<a class="headerlink" href="#123_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>map简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于Ceph集群来说</span><span class="err">，</span><span class="n">有个非常重要的特点就是高性能</span><span class="err">，</span><span class="n">而高性能有一个非常突出的特点就是单位时间内处理业务数据的量</span><span class="err">。</span><span class="n">Ceph为了实现业务数据的精准高效操作</span><span class="err">，</span><span class="n">它主要是通过五种Map分别来实现特定的功能</span><span class="err">：</span>
    <span class="n">Monitor</span> <span class="n">Map</span>
        <span class="n">Mon节点和所有节点的连接信息</span><span class="err">，</span><span class="n">包括ceph集群ID</span><span class="err">，</span><span class="n">monitor</span> <span class="n">节点名称</span><span class="err">，</span><span class="n">IP地址和端口等</span><span class="err">。</span>
    <span class="n">CRUSH</span> <span class="n">Map</span> 
        <span class="n">让</span> <span class="n">Ceph</span> <span class="n">在正常运行情况下进行高效数据操作的重要支撑部分</span><span class="err">，</span><span class="n">包括数据的写入和查询用到的设备列表</span><span class="err">、</span><span class="n">存储桶信息</span><span class="err">、</span><span class="n">故障域结构</span><span class="err">，</span><span class="n">故障域规则等</span><span class="err">。</span>
    <span class="n">OSD</span> <span class="n">Map</span>
        <span class="n">保存OSD的基本信息</span><span class="err">，</span><span class="n">包括ID</span><span class="err">，</span><span class="n">状态</span><span class="err">，</span><span class="n">副本</span><span class="err">、</span><span class="n">PG</span><span class="err">、</span><span class="n">OSD信息等</span><span class="err">，</span><span class="n">便于数据的均衡性操作</span><span class="err">。</span>
    <span class="n">MDS</span> <span class="n">Map</span>
        <span class="n">保存MDS的基本信息</span><span class="err">，</span><span class="n">包括版本号</span><span class="err">、</span><span class="n">创建和修改时间</span><span class="err">、</span><span class="n">数据和元数据存储池</span><span class="err">、</span><span class="n">数量</span><span class="err">、</span><span class="n">MDS状态等</span><span class="err">。</span>
    <span class="n">PG</span> <span class="n">Map</span>
        <span class="n">保存PG的基本信息</span><span class="err">，</span><span class="n">包括PG的ID</span><span class="err">、</span><span class="n">数量</span><span class="err">、</span><span class="n">状态</span><span class="err">、</span><span class="n">版本号</span><span class="err">、</span><span class="n">时间戳</span><span class="err">、</span><span class="n">容量百分比等</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220930074909586" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220930074909586.png" /></p>
<p><strong>简单实践</strong></p>
<p>基本map关联关系</p>
<div class="highlight"><pre><span></span><code><span class="n">查看mon相关的关联关系</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span>  <span class="n">ceph</span> <span class="n">mon</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">3</span>
<span class="n">fsid</span> <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
<span class="p">...</span>
<span class="n">2</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon03</span>
<span class="n">dumped</span> <span class="n">monmap</span> <span class="n">epoch</span> <span class="n">3</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看osd相关信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">158</span>
<span class="n">fsid</span> <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
<span class="p">...</span>
<span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">up</span>   <span class="k">in</span>  <span class="n">weight</span> <span class="n">1</span> <span class="n">up_from</span> <span class="n">146</span> <span class="n">up_thru</span> <span class="n">156</span> <span class="n">down_at</span> <span class="n">145</span> <span class="n">last_clean_interval</span> <span class="p">[</span><span class="n">125</span><span class="p">,</span><span class="n">142</span><span class="p">)</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6800</span><span class="p">/</span><span class="n">1274</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6805</span><span class="p">/</span><span class="n">1274</span><span class="p">]</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6804</span><span class="p">/</span><span class="n">1274</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6805</span><span class="p">/</span><span class="n">1274</span><span class="p">]</span> <span class="n">exists</span><span class="p">,</span><span class="n">up</span> <span class="n">67282205</span><span class="p">-</span><span class="n">0c58</span><span class="p">-</span><span class="n">49c8</span><span class="p">-</span><span class="n">9af6</span><span class="p">-</span><span class="n">878198d05f2e</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看mds相关信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mds</span> <span class="n">dump</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看crush相关信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">dump</span>
<span class="p">{</span>
    <span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="p">[</span>                    <span class="c"># 设备列表信息</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;osd.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;hdd&quot;</span>
        <span class="p">},</span>
        <span class="p">...</span>
    <span class="p">],</span>
    <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="p">[</span>                      <span class="c"># 资源类型列表12类，主要有</span>
        <span class="p">{</span>                           <span class="c"># osd、host、chassis、rack</span>
            <span class="s2">&quot;type_id&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>           <span class="c"># row、pdu、pod、room</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;osd&quot;</span>           <span class="c"># datacenter、zone、region、root</span>
        <span class="p">},</span>
        <span class="p">...</span>
    <span class="p">],</span>
    <span class="s2">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>                    <span class="c"># 存储桶列表</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">-</span><span class="n">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
            <span class="p">...</span>
        <span class="p">},</span>
        <span class="p">...</span>
    <span class="p">],</span>
    <span class="s2">&quot;rules&quot;</span><span class="p">:</span> <span class="p">[</span>                      <span class="c"># 数据映射规则列表</span>
        <span class="p">{</span>
            <span class="s2">&quot;rule_id&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
            <span class="s2">&quot;rule_name&quot;</span><span class="p">:</span> <span class="s2">&quot;replicated_rule&quot;</span><span class="p">,</span>
            <span class="p">...</span>
    <span class="p">],</span>
    <span class="s2">&quot;tunables&quot;</span><span class="p">:</span> <span class="p">{</span>                   <span class="c"># 可调节的相关属性</span>
        <span class="s2">&quot;choose_local_tries&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="s2">&quot;choose_args&quot;</span><span class="p">:</span> <span class="p">{}</span>               <span class="c"># 可选择的其他参数</span>
<span class="p">}</span>
</code></pre></div>
<p>查看PG的相关信息</p>
<div class="highlight"><pre><span></span><code><span class="n">查看pg相关的信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump</span>
<span class="n">version</span> <span class="n">3481</span>
<span class="n">stamp</span> <span class="n">2062</span><span class="p">-</span><span class="n">10</span><span class="p">-</span><span class="n">08</span> <span class="n">20</span><span class="p">:</span><span class="n">54</span><span class="p">:</span><span class="n">41</span><span class="p">.</span><span class="n">007647</span>
<span class="n">last_osdmap_epoch</span> <span class="n">0</span>
<span class="n">last_pg_scan</span> <span class="n">0</span>
<span class="p">...</span>
<span class="n">OSD_STAT</span> <span class="n">USED</span>    <span class="n">AVAIL</span>   <span class="n">USED_RAW</span> <span class="n">TOTAL</span>   <span class="n">HB_PEERS</span>    <span class="n">PG_SUM</span> <span class="n">PRIMARY_PG_SUM</span>
<span class="n">5</span>         <span class="n">20</span> <span class="n">MiB</span>  <span class="n">19</span> <span class="n">GiB</span>  <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">GiB</span>  <span class="n">20</span> <span class="n">GiB</span> <span class="p">[</span><span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">,</span><span class="n">3</span><span class="p">,</span><span class="n">4</span><span class="p">]</span>    <span class="n">137</span>             <span class="n">44</span>
<span class="p">...</span>
<span class="n">sum</span>      <span class="n">122</span> <span class="n">MiB</span> <span class="n">114</span> <span class="n">GiB</span>  <span class="n">6</span><span class="p">.</span><span class="n">1</span> <span class="n">GiB</span> <span class="n">120</span> <span class="n">GiB</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看PG-OSD关系图</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">map</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span>
<span class="n">osdmap</span> <span class="n">e158</span> <span class="n">pg</span> <span class="n">7</span><span class="p">.</span><span class="n">c4</span> <span class="p">(</span><span class="n">7</span><span class="p">.</span><span class="n">c4</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">up</span> <span class="p">[</span><span class="n">4</span><span class="p">,</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">]</span> <span class="n">acting</span> <span class="p">[</span><span class="n">4</span><span class="p">,</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">提交文件到对应的osd里面</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">put</span> <span class="n">ceph</span><span class="o">-file</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/</span><span class="n">ceph-cluster</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">conf</span> <span class="p">-</span><span class="n">-pool</span><span class="p">=</span><span class="n">mypool</span>
<span class="n">object-PG-OSD关系图</span> <span class="n">查看ceph-file文件对象的内部属性关系</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">map</span> <span class="n">mypool</span> <span class="n">ceph</span><span class="o">-file</span>
<span class="n">osdmap</span> <span class="n">e51</span> <span class="n">pool</span> <span class="s1">&#39;mypool&#39;</span> <span class="p">(</span><span class="n">1</span><span class="p">)</span> <span class="n">object</span> <span class="s1">&#39;ceph-file&#39;</span> <span class="p">-&gt;</span> <span class="n">pg</span> <span class="n">1</span><span class="p">.</span><span class="n">7753490d</span> <span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">d</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">up</span> <span class="p">([</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">5</span><span class="p">],</span> <span class="n">p2</span><span class="p">)</span> <span class="n">acting</span> <span class="p">([</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">,</span><span class="n">5</span><span class="p">],</span> <span class="n">p2</span><span class="p">)</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="124_crush">1.2.4 CRUSH<a class="headerlink" href="#124_crush" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">CRUSH</span><span class="p">(</span><span class="n">Controlled</span> <span class="n">Replication</span> <span class="n">Under</span> <span class="n">Scalable</span> <span class="n">Hashing</span><span class="p">)</span><span class="n">是ceph的核心设计之一</span><span class="err">，</span><span class="n">它本质上是Ceph存储集群使用的一种数据分发算法</span><span class="err">，</span><span class="n">类似于OpenStack的Swift和AQS的对象存储所使用的哈希和一致性hash数据分布算法</span><span class="err">。</span>
    <span class="n">CRUSH算法通过接受多维参数</span><span class="err">，</span><span class="n">通过一定的计算对客户端对象数据进行分布存储位置的确定</span><span class="err">，</span><span class="n">来解决数据动态分发的问题</span><span class="err">。</span><span class="n">因此ceph客户端无需经过传统查表的方式来获取数据的索引</span><span class="err">，</span><span class="n">进而根据索引来读写数据</span><span class="err">，</span><span class="n">只需通过crush算法计算后直接和对应的OSD交互进行数据读写</span><span class="err">。</span><span class="n">这样</span><span class="err">，</span><span class="n">ceph就避免了查表这种传统中心化架构存在的单点故障</span><span class="err">、</span><span class="n">性能瓶颈以及不易扩展的缺陷</span><span class="err">。</span><span class="n">这也是Ceph相较于其他分布式存储系统具有高扩展性</span><span class="err">、</span><span class="n">高可用和高性能特点的主要原因</span><span class="err">。</span>
</code></pre></div>
<p>CRUSH Map简介</p>
<div class="highlight"><pre><span></span><code><span class="n">Ceph中的寻址至少要经历以下三次映射</span><span class="err">：</span>
    <span class="n">File</span> <span class="n">和</span> <span class="n">object</span> <span class="n">映射</span><span class="err">：</span><span class="n">文件数据object的数据块切片操作</span><span class="err">，</span><span class="n">便于多数据的并行化处理</span><span class="err">。</span>
    <span class="n">Object</span> <span class="n">和</span> <span class="n">PG</span> <span class="n">映射</span><span class="err">：</span><span class="n">将文件数据切分后的每一个Object通过简单的</span> <span class="n">Hash</span> <span class="n">算法归到一个</span> <span class="n">PG</span> <span class="n">中</span><span class="err">。</span>
    <span class="n">PG</span> <span class="n">和</span> <span class="n">OSD</span> <span class="n">映射</span><span class="err">：</span><span class="n">将PG映射到主机实际的OSD数据磁盘上</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">CRUSH算法提供了配置和更改和数据动态再平衡等关键特性</span><span class="err">，</span><span class="n">而CRUSH算法存储数据对象的过程可通过CRUSH</span> <span class="n">Map控制并进行自定义修改</span><span class="err">，</span><span class="n">CRUSH</span> <span class="n">Map是Ceph集群物理拓扑结构</span><span class="err">、</span><span class="n">副本策略以及故障域等信息抽象配置段</span><span class="err">，</span><span class="n">借助于CRUSH</span> <span class="n">Map可以将数据伪随机地分布到集群的各个OSD上</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20221008220724118" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221008220724118.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">CRUSH</span> <span class="n">Map</span> <span class="n">由不同层次的逻辑Buckets</span> <span class="n">和</span> <span class="n">Devices组成</span><span class="err">：</span>
    <span class="n">Buckets</span> <span class="p">-</span> <span class="n">Root指的是多区域</span><span class="err">，</span><span class="n">datacenter是数据中心</span><span class="err">，</span><span class="n">room是机房</span><span class="err">、</span><span class="n">rack是机柜</span><span class="err">，</span><span class="n">host是主机</span>
    <span class="n">Devices</span> <span class="p">-</span> <span class="n">主要指各种OSD存储设备</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">对于每一个Ceph集群来说</span><span class="err">，</span><span class="n">CRUSH</span> <span class="n">Map在正式上线前已经确定好了</span><span class="err">，</span><span class="n">如果用户需要自定义更改CRUSH</span> <span class="n">Map的话</span><span class="err">，</span><span class="n">必须在集群上线前进行更改和核实</span><span class="err">，</span><span class="n">然后应用到CRUSH算法中</span><span class="err">。</span>
</code></pre></div>
<p>Buckets</p>
<div class="highlight"><pre><span></span><code><span class="n">CRUSH</span> <span class="n">Map中的Buckets是用户自定义增加的</span><span class="err">，</span><span class="n">每个层级的Bucket对应不同的故障域</span><span class="err">，</span><span class="n">在实际应用中</span><span class="err">，</span><span class="n">为了更加精细化地隔离故障域</span><span class="err">，</span><span class="n">用户还可以增加PDU</span><span class="err">、</span><span class="n">POD</span><span class="err">、</span><span class="n">ROW</span><span class="err">、</span><span class="n">CHASSIS等</span><span class="err">，</span><span class="n">这些名称是用户随意定义的</span><span class="err">。</span>
<span class="n">对于Ceph</span> <span class="n">N版本来说</span><span class="err">，</span><span class="n">它默认声明了12种Buckets</span><span class="err">。</span>
    <span class="n">root</span><span class="p">-</span><span class="n">根分区</span><span class="err">、</span><span class="n">region</span><span class="p">-</span><span class="n">可用区域</span><span class="err">、</span><span class="n">zone</span><span class="p">-</span><span class="n">数据区域</span><span class="err">、</span><span class="n">datacenter</span><span class="p">-</span><span class="n">数据中心</span>
    <span class="n">room</span><span class="p">-</span><span class="n">机房</span><span class="err">、</span><span class="n">pod</span><span class="p">-</span><span class="n">机房单间</span><span class="err">、</span><span class="n">pdu</span><span class="p">-</span><span class="n">电源插座</span><span class="err">、</span><span class="n">row</span><span class="p">-</span><span class="n">机柜排</span>
    <span class="n">rack</span><span class="p">-</span><span class="n">机柜</span><span class="err">、</span><span class="n">chassis</span><span class="p">-</span><span class="n">机箱</span><span class="err">、</span><span class="n">host</span><span class="p">-</span><span class="n">主机</span><span class="err">、</span><span class="n">osd</span><span class="p">-</span><span class="n">磁盘</span>
</code></pre></div>
<p>配置文件解读</p>
<div class="highlight"><pre><span></span><code><span class="c"># begin crush map  设定修正bug、优化算法、以及向后兼容老版本等属性信息</span>
<span class="n">tunable</span> <span class="n">choose_local_tries</span> <span class="n">0</span>            <span class="c"># 为做向后兼容应保持为0</span>
<span class="n">tunable</span> <span class="n">choose_local_fallback_tries</span> <span class="n">0</span>   <span class="c"># 为做向后兼容应保持为0</span>
<span class="n">tunable</span> <span class="n">choose_total_tries</span> <span class="n">50</span>           <span class="c"># 选择bucket的最大重试次数</span>
<span class="n">tunable</span> <span class="n">chooseleaf_descend_once</span> <span class="n">1</span>       <span class="c"># 为做向后兼容应保持为1</span>
<span class="n">tunable</span> <span class="n">chooseleaf_vary_r</span> <span class="n">1</span>             <span class="c"># 修复旧bug，为做向后兼容应保持为1</span>
<span class="n">tunable</span> <span class="n">chooseleaf_stable</span> <span class="n">1</span>             <span class="c"># 避免不必要的pg迁移，为做向后兼容应保持为1</span>
<span class="n">tunable</span> <span class="n">straw_calc_version</span> <span class="n">1</span>            <span class="c"># straw算法版本，为做向后兼容应保持为1</span>
<span class="n">tunable</span> <span class="n">allowed_bucket_algs</span> <span class="n">54</span>          <span class="c"># 允许使用的bucket选择算法，通过位运算计算得出的值</span>

<span class="c"># devices 该部分保存了 Ceph 集群中所有 OSD 设备和 ceph-osd 守护进程的映射关系。</span>
<span class="c"># 格式： device {num} {osd.name} [class {class}]</span>
<span class="n">device</span> <span class="n">0</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">class</span> <span class="n">hdd</span>
<span class="p">...</span>
<span class="n">device</span> <span class="n">5</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">class</span> <span class="n">hdd</span>

<span class="c"># types 该部分定义了在 CRUSH 层次结构中用到的 buckets 类型。</span>
<span class="c"># 格式：type {num} {bucket-name}</span>
<span class="nb">type </span><span class="n">0</span> <span class="n">osd</span>          <span class="c"># OSD守护进程编号（如：osd.1,osd.2等）</span>
<span class="nb">type </span><span class="n">1</span> <span class="n">host</span>         <span class="c"># OSD所在主机名称</span>
<span class="nb">type </span><span class="n">2</span> <span class="n">chassis</span>      <span class="c"># host所在机箱名称</span>
<span class="nb">type </span><span class="n">3</span> <span class="n">rack</span>         <span class="c"># 机箱所在机柜名称</span>
<span class="nb">type </span><span class="n">4</span> <span class="n">row</span>          <span class="c"># 机柜所在排名称</span>
<span class="nb">type </span><span class="n">5</span> <span class="n">pdu</span>          <span class="c"># 机柜排所在的电源插座</span>
<span class="nb">type </span><span class="n">6</span> <span class="n">pod</span>          <span class="c"># 电源插座专属的单间</span>
<span class="nb">type </span><span class="n">7</span> <span class="n">room</span>         <span class="c"># 房间所属的机房</span>
<span class="nb">type </span><span class="n">8</span> <span class="n">datacenter</span>   <span class="c"># 机房所属的数据中心</span>
<span class="nb">type </span><span class="n">9</span> <span class="n">zone</span>         <span class="c"># 数据中心所属的数据区域</span>
<span class="nb">type </span><span class="n">10</span> <span class="n">region</span>      <span class="c"># 数据区域所属的可用区域</span>
<span class="nb">type </span><span class="n">11</span> <span class="n">root</span>        <span class="c"># 设备管理的根路径</span>

<span class="c"># buckets 该部分定义了一个个具体的type类型的设备区域</span>
<span class="n">host</span> <span class="n">mon01</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">3</span>           <span class="c"># do not change unnecessarily</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">4</span> <span class="n">class</span> <span class="n">hdd</span>         <span class="c"># do not change unnecessarily</span>
        <span class="c"># weight 0.039</span>
        <span class="n">alg</span> <span class="n">straw2</span>      <span class="c"># straw2算法减少了集群发生了改变后的数据移动</span>
        <span class="n">hash</span> <span class="n">0</span>  <span class="c"># bucket使用的hash算法，默认是rjenkins1</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>     <span class="c"># 低一层级的bucket名称，以及其对应的weight</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>
<span class="p">...</span>

<span class="c"># rules 部分定义了存储池的属性，以及存储池中数据的存放方式，尤其是复制(replication)和放置(placement)数据的策略。默认的 CRUSH map 包含了适用于默认存储池 rbd 的一条规则。</span>
<span class="n">rule</span> <span class="n">replicated_rule</span> <span class="p">{</span>
        <span class="n">id</span> <span class="n">0</span>                <span class="c"># 定制所属规则集</span>
        <span class="nb">type </span><span class="n">replicated</span>     <span class="c"># 作用副本存储池范围</span>
        <span class="n">min_size</span> <span class="n">1</span>          <span class="c"># 副本少于1个，规则失效</span>
        <span class="n">max_size</span> <span class="n">10</span>         <span class="c"># 副本大于10个，规则失效</span>
        <span class="n">step</span> <span class="n">take</span> <span class="k">default</span>   <span class="c"># 作用于default类型的bucket</span>
        <span class="n">step</span> <span class="n">chooseleaf</span> <span class="n">firstn</span> <span class="n">0</span> <span class="nb">type </span><span class="n">host</span>  <span class="c"># 作用于包含3个子bucket的host</span>
        <span class="n">step</span> <span class="n">emit</span>  <span class="c"># 表示数据处理的方式，处理完数据后，清理处理过程</span>
<span class="p">}</span>

<span class="c"># end crush map</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">bucket</span> <span class="n">实例的属性解析</span>
<span class="no">[bucket类型] [bucket名称]</span> <span class="p">{</span>
   <span class="n">id</span> <span class="p">[</span><span class="n">负整数表示bucket唯一ID</span><span class="p">]</span>
   <span class="n">weight</span> <span class="p">[</span><span class="n">表示设备容量之间的权重差异</span><span class="err">，</span><span class="n">权重1</span><span class="p">.</span><span class="n">00代表1T容量</span><span class="err">，</span><span class="n">权重0</span><span class="p">.</span><span class="n">5代表500G容量</span><span class="p">]</span>
   <span class="n">alg</span> <span class="p">[</span><span class="n">bucket类型的算法选择</span><span class="p">:</span> <span class="n">uniform</span><span class="p">|</span><span class="n">list</span><span class="p">|</span><span class="n">tree</span><span class="p">|</span><span class="n">straw</span><span class="p">|</span><span class="n">straw2</span><span class="err">，</span><span class="n">它是性能和效率之间的一种妥协</span><span class="p">]</span>
   <span class="n">hash</span> <span class="p">[</span><span class="n">hash算法类型</span><span class="p">:</span> <span class="n">0</span> <span class="n">是默认的rjenkins1算法</span><span class="p">]</span>
   <span class="n">item</span> <span class="p">[</span><span class="n">当前bucket的子项元素</span><span class="p">]</span> <span class="n">weight</span> <span class="p">[</span><span class="n">相对权重值</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">算法解读</span><span class="err">：</span>
    <span class="n">uniform</span> <span class="n">每次设备变动</span><span class="err">，</span><span class="n">数据都会进行均衡处理</span><span class="err">，</span><span class="n">要求所有设备的权重一致</span><span class="err">，</span><span class="n">效率极低</span>
    <span class="n">list</span> <span class="n">设备的变动场景以链表方式实现</span><span class="err">，</span><span class="n">大规模设备场景下</span><span class="err">，</span><span class="n">效率极其低下</span><span class="err">。</span>
    <span class="n">tree</span> <span class="n">设备的变动场景以二叉树方式实现</span><span class="err">，</span><span class="n">综合数据处理性能叫均衡</span><span class="err">。</span>
    <span class="n">straw</span> <span class="n">设备的变动场景在list和tree之间选择最优方式进行</span><span class="err">，</span><span class="n">同时支持副本放置时公平竞争处理和二级权重处理</span>
    <span class="n">straw2</span> <span class="n">进阶版的straw</span><span class="err">，</span><span class="n">即使出现数据变动</span><span class="err">，</span><span class="n">不会影响到跨高层的数据操作</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">实例的属性解析</span>
<span class="n">rule</span> <span class="p">&lt;</span><span class="n">rule名称</span><span class="p">&gt;{</span>
    <span class="n">ruleset</span> <span class="p">&lt;</span><span class="n">当前规则所属的规则集</span><span class="err">，</span><span class="n">整数标识</span><span class="p">&gt;</span>
    <span class="nb">type </span><span class="p">[</span><span class="n">指定rule作用的存储池类型</span> <span class="n">replicated</span><span class="p">|</span><span class="n">erasure</span><span class="p">]</span>
    <span class="n">min_size</span> <span class="p">&lt;</span><span class="n">存储池的副本份数小于min_size值后</span><span class="err">，</span><span class="n">rule不起作用</span><span class="p">&gt;</span>
    <span class="n">max_size</span> <span class="p">&lt;</span><span class="n">存储池的副本份数大于max_size值后</span><span class="err">，</span><span class="n">rule不起作用</span><span class="p">&gt;</span>
    <span class="n">step</span> <span class="n">take</span> <span class="p">&lt;</span><span class="n">获取一个</span> <span class="n">bucket类型名称</span><span class="err">，</span><span class="n">开始遍历其结构</span><span class="p">&gt;</span>
    <span class="n">step</span> <span class="p">[</span><span class="n">choose</span><span class="p">|</span><span class="n">chooseleaf</span><span class="p">]</span> <span class="p">[</span><span class="n">firstn</span><span class="p">|</span><span class="n">indep</span><span class="p">]</span> <span class="p">&lt;</span><span class="n">num</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">bucket-type</span><span class="p">&gt;</span>
    <span class="n">step</span> <span class="n">emit</span>
<span class="p">}</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">choose</span><span class="err">：</span><span class="n">选择到预期数量和类型的bucket即可结束</span>
    <span class="n">chooseleaf</span><span class="err">：</span><span class="n">选择到预期数量和类型的bucket</span><span class="err">，</span><span class="n">并最终从这些bucket中选出叶子节点</span>
    <span class="p">---</span>
    <span class="n">当出现osd</span> <span class="n">异常情况时</span><span class="err">，</span>
        <span class="n">副本池选择firstn方式</span><span class="err">，</span><span class="n">表示新节点以追加方式追加到osd列表</span>
        <span class="n">纠删码池选择indep方式</span><span class="err">，</span><span class="n">表示新节点以原位置插入添加到osd列表</span><span class="err">，</span><span class="n">其他保持有序状态</span>
    <span class="p">---</span>
    <span class="n">如果</span> <span class="n">num</span><span class="p">==</span><span class="n">0</span><span class="err">，</span><span class="n">选择</span> <span class="n">N</span> <span class="n">个</span> <span class="n">bucket</span><span class="err">。</span>
    <span class="n">如果</span> <span class="n">num</span> <span class="p">&gt;</span> <span class="n">0</span> <span class="n">并且</span> <span class="n">num</span><span class="p">&lt;</span><span class="n">N</span><span class="err">，</span><span class="n">选择</span> <span class="n">num</span> <span class="n">个</span> <span class="n">bucket</span><span class="err">。</span>
    <span class="n">如果</span> <span class="n">num</span> <span class="p">&lt;</span> <span class="n">0</span><span class="err">，</span><span class="n">选择</span> <span class="n">N-num</span> <span class="n">个</span> <span class="n">bucket</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">举例1</span><span class="err">：</span>
    <span class="n">step</span> <span class="n">choose</span> <span class="n">firstn</span> <span class="n">1</span> <span class="nb">type </span><span class="n">row</span>
    <span class="n">num</span><span class="p">=</span><span class="n">1</span><span class="err">，</span><span class="n">存储池的副本份数为3</span><span class="err">，</span><span class="n">0</span><span class="p">&lt;</span><span class="n">num</span><span class="p">&lt;</span><span class="n">3</span><span class="err">，</span><span class="n">因此</span><span class="err">，</span><span class="n">crush</span> <span class="n">map会选择包含</span> <span class="n">1</span> <span class="n">个</span> <span class="n">bucket</span> <span class="n">的row进行处理</span><span class="err">。</span>

    <span class="n">step</span> <span class="n">chooseleaf</span> <span class="n">firstn</span> <span class="n">0</span> <span class="nb">type </span><span class="n">row</span>
    <span class="n">num</span><span class="p">=</span><span class="n">0</span><span class="err">，</span><span class="n">存储池的副本份数为3</span><span class="err">，</span><span class="n">num</span><span class="p">==</span><span class="n">0</span><span class="err">，</span><span class="n">因此</span><span class="err">，</span><span class="n">crush</span> <span class="n">map会从包含</span> <span class="n">3</span> <span class="n">个</span> <span class="n">bucket</span> <span class="n">的row的每一个叶子节点中选择一个子元素</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">举例2</span><span class="err">：</span>
    <span class="n">一个PG的5个副本分布在OSD</span> <span class="n">1</span><span class="err">，</span><span class="n">2</span><span class="err">，</span><span class="n">3</span><span class="err">，</span><span class="n">4</span><span class="err">，</span><span class="n">5上</span><span class="err">，</span><span class="n">然后3</span> <span class="n">down了</span><span class="err">。</span>
    <span class="n">在firstn模式下</span><span class="err">：</span>
        <span class="n">CRUSH算法发现3其down掉后</span><span class="err">，</span><span class="n">最后在末尾追加一个新的未down的OSD</span> <span class="n">6</span><span class="err">，</span><span class="n">OSD变迁过程为</span><span class="err">：</span>
            <span class="n">1</span><span class="err">，</span><span class="n">2</span><span class="err">，</span><span class="n">3</span><span class="err">，</span><span class="n">4</span><span class="err">，</span><span class="n">5</span> <span class="p">-&gt;</span> <span class="n">1</span><span class="err">，</span><span class="n">2</span><span class="err">，</span><span class="n">4</span><span class="err">，</span><span class="n">5</span><span class="err">，</span><span class="n">6</span><span class="err">。</span>
    <span class="n">在indep模式下</span><span class="err">：</span>
        <span class="n">CRUSH算法发现3其down掉后</span><span class="err">，</span><span class="n">会在3位置插入一个新的未down的OSD</span> <span class="n">6</span><span class="err">，</span><span class="n">OSD变迁过程为</span><span class="err">：</span>
            <span class="n">1</span><span class="err">，</span><span class="n">2</span><span class="err">，</span><span class="n">3</span><span class="err">，</span><span class="n">4</span><span class="err">，</span><span class="n">5</span> <span class="p">-&gt;</span> <span class="n">1</span><span class="err">，</span><span class="n">2</span><span class="err">，</span><span class="n">6</span><span class="err">，</span><span class="n">4</span><span class="err">，</span><span class="n">5</span><span class="err">。</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>Crush map操作步骤解读</p>
<div class="highlight"><pre><span></span><code><span class="n">crush</span> <span class="n">相关的信息</span><span class="err">，</span><span class="n">我们可以通过两种方法来进行操作</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">获取crush相关信息</span>
        <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">dump</span>
    <span class="n">2</span> <span class="n">操作crush相关信息</span>
        <span class="n">获取crush</span> <span class="n">map信息后进行格式转换</span><span class="err">，</span><span class="n">编辑文件后再次应用crush</span> <span class="n">map数据</span>
</code></pre></div>
<p>操作crush信息</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span><span class="err">、</span><span class="n">从monitor节点上获取CRUSH</span> <span class="n">map</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">getcrushmap</span> <span class="n">-o</span> <span class="n">crushmap_file</span>
<span class="n">23</span>

<span class="n">默认获取的文件并不是普通的文本文件</span><span class="err">，</span><span class="n">无法直接查看</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">file</span> <span class="n">crushmap_file</span>
<span class="n">crushmap_file</span><span class="p">:</span> <span class="n">MS</span> <span class="n">Windows</span> <span class="n">icon</span> <span class="n">resource</span> <span class="p">-</span> <span class="n">8</span> <span class="n">icons</span><span class="p">,</span> <span class="n">1-colors</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span><span class="err">、</span><span class="n">获取该crushmap文件后</span><span class="err">，</span><span class="n">编译为可读文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">crushtool</span> <span class="n">-d</span> <span class="n">crushmap_file</span> <span class="n">-o</span> <span class="n">crushmap_file</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">file</span> <span class="n">crushmap_file</span><span class="p">.</span><span class="n">txt</span>
<span class="n">crushmap_file</span><span class="p">.</span><span class="n">txt</span><span class="p">:</span> <span class="n">ASCII</span> <span class="n">text</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看文件内容</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">crushmap_file</span><span class="p">.</span><span class="n">txt</span>
<span class="p">...</span>  <span class="c"># 参考上述的文件格式解读</span>
</code></pre></div>
<p>crush map信息修改</p>
<div class="highlight"><pre><span></span><code><span class="n">修改crushmap_file文件内容</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">vim</span> <span class="n">crushmap_file</span><span class="p">.</span><span class="n">txt</span>
<span class="p">...</span>
<span class="n">rule</span> <span class="n">replicated_rule</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">max_size</span> <span class="n">20</span>     <span class="c"># 修改该值</span>
        <span class="p">...</span>
<span class="p">}</span>

<span class="n">3</span><span class="err">、</span><span class="n">将修改后的crushmap_file</span><span class="p">.</span><span class="n">txt编译为二进制文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">crushtool</span> <span class="n">-c</span> <span class="n">crushmap_file</span><span class="p">.</span><span class="n">txt</span> <span class="n">-o</span> <span class="n">new_crushmap_file</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span><span class="err">、</span><span class="n">将新的crushmap注入到ceph集群</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">setcrushmap</span> <span class="n">-i</span> <span class="n">new_crushmap_file</span><span class="p">.</span><span class="n">txt</span>
<span class="n">24</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">dump</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">max_size</span>
            <span class="s2">&quot;max_size&quot;</span><span class="p">:</span> <span class="n">20</span><span class="p">,</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">rule</span> <span class="n">dump</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">max_size</span>
        <span class="s2">&quot;max_size&quot;</span><span class="p">:</span> <span class="n">20</span><span class="p">,</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">crush</span> <span class="n">map的数据修改成功了</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="125_1">1.2.5 实践解读<a class="headerlink" href="#125_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>案例需求</p>
<div class="highlight"><pre><span></span><code>    <span class="n">随着存储技术的发展</span><span class="err">，</span><span class="n">目前存储平台中的存储介质的类型也越来越多了</span><span class="err">，</span><span class="n">目前主要有两大类型</span><span class="err">：</span><span class="n">SSD磁盘和SAS</span><span class="p">|</span><span class="n">SATA磁盘</span><span class="err">。</span><span class="n">我们可以根据应用对于场景的使用特点</span><span class="err">，</span><span class="n">高性能场景的数据存储使用SSD磁盘</span><span class="err">，</span><span class="n">而普通数据的存储我们采用SAS磁盘</span><span class="err">，</span><span class="n">所以在SSD场景中</span><span class="err">，</span><span class="n">我们就可以基于SSD磁盘组成高性能POOL</span><span class="err">，</span><span class="n">将基于SAS</span><span class="p">|</span><span class="n">SATA磁盘组成常规POOL</span><span class="err">。</span>
    <span class="n">以OpenStack场景为例</span><span class="err">，</span><span class="n">对于VM实例来说</span><span class="err">，</span><span class="n">Nova对于实时数据IO要求较高</span><span class="err">，</span><span class="n">所以推荐使用SSD存储池</span><span class="err">；</span><span class="n">VM实例创建过程中不高的冷数据</span><span class="err">，</span><span class="n">比如Glance镜像数据和Cinder块设备备份数据</span><span class="err">，</span><span class="n">推荐使用SAS</span><span class="p">|</span><span class="n">SATA的常规POOL</span><span class="err">。</span>
</code></pre></div>
<p>场景规划</p>
<p><img alt="image-20221009234113283" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221009234113283.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">为了区分SSD和SAS磁盘</span><span class="err">，</span><span class="n">需要在CRUSH</span> <span class="n">Map中增加Root层</span><span class="err">，</span><span class="n">增加SAS和SSD区域</span><span class="err">。</span>
        <span class="n">业务A对性能要求较高</span><span class="err">，</span><span class="n">将SSD作为数据盘</span><span class="err">，</span><span class="n">需创建3副本的SSD存储池</span>
        <span class="n">业务B对性能要求不高</span><span class="err">，</span><span class="n">但数据量较大</span><span class="err">，</span><span class="n">将SAS作为数据盘降低成本</span><span class="err">，</span><span class="n">需创建3副本的SAS存储池</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>定制crush map</p>
<div class="highlight"><pre><span></span><code><span class="n">定制专属文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">crushmap_file_case</span><span class="p">.</span><span class="n">txt</span>
<span class="c"># begin crush map</span>
<span class="n">tunable</span> <span class="n">choose_local_tries</span> <span class="n">0</span>
<span class="n">tunable</span> <span class="n">choose_local_fallback_tries</span> <span class="n">0</span>
<span class="n">tunable</span> <span class="n">choose_total_tries</span> <span class="n">50</span>
<span class="n">tunable</span> <span class="n">chooseleaf_descend_once</span> <span class="n">1</span>
<span class="n">tunable</span> <span class="n">chooseleaf_vary_r</span> <span class="n">1</span>
<span class="n">tunable</span> <span class="n">chooseleaf_stable</span> <span class="n">1</span>
<span class="n">tunable</span> <span class="n">straw_calc_version</span> <span class="n">1</span>
<span class="n">tunable</span> <span class="n">allowed_bucket_algs</span> <span class="n">54</span>

<span class="c"># devices</span>
<span class="n">device</span> <span class="n">0</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">class</span> <span class="n">ssd</span>
<span class="n">device</span> <span class="n">1</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span> <span class="n">class</span> <span class="n">sas</span>
<span class="n">device</span> <span class="n">2</span> <span class="n">osd</span><span class="p">.</span><span class="n">2</span> <span class="n">class</span> <span class="n">ssd</span>
<span class="n">device</span> <span class="n">3</span> <span class="n">osd</span><span class="p">.</span><span class="n">3</span> <span class="n">class</span> <span class="n">sas</span>
<span class="n">device</span> <span class="n">4</span> <span class="n">osd</span><span class="p">.</span><span class="n">4</span> <span class="n">class</span> <span class="n">ssd</span>
<span class="n">device</span> <span class="n">5</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">class</span> <span class="n">sas</span>

<span class="c"># types</span>
<span class="nb">type </span><span class="n">0</span> <span class="n">osd</span>
<span class="nb">type </span><span class="n">1</span> <span class="n">host</span>
<span class="nb">type </span><span class="n">2</span> <span class="n">chassis</span>
<span class="nb">type </span><span class="n">3</span> <span class="n">rack</span>
<span class="nb">type </span><span class="n">4</span> <span class="n">row</span>
<span class="nb">type </span><span class="n">5</span> <span class="n">pdu</span>
<span class="nb">type </span><span class="n">6</span> <span class="n">pod</span>
<span class="nb">type </span><span class="n">7</span> <span class="n">room</span>
<span class="nb">type </span><span class="n">8</span> <span class="n">datacenter</span>
<span class="nb">type </span><span class="n">9</span> <span class="n">zone</span>
<span class="nb">type </span><span class="n">10</span> <span class="n">region</span>
<span class="nb">type </span><span class="n">11</span> <span class="n">root</span>

<span class="c"># buckets</span>
<span class="n">host</span> <span class="n">mon01-ssd</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">3</span>           <span class="c"># do not change unnecessarily</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">4</span> <span class="n">class</span> <span class="n">ssd</span>         <span class="c"># do not change unnecessarily</span>
        <span class="c"># weight 0.039</span>
        <span class="n">alg</span> <span class="n">straw2</span>
        <span class="n">hash</span> <span class="n">0</span>  <span class="c"># rjenkins1</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">0</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>

<span class="n">host</span> <span class="n">mon02-ssd</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">5</span>           <span class="c"># do not change unnecessarily</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">6</span> <span class="n">class</span> <span class="n">ssd</span>         <span class="c"># do not change unnecessarily</span>
        <span class="c"># weight 0.039</span>
        <span class="n">alg</span> <span class="n">straw2</span>
        <span class="n">hash</span> <span class="n">0</span>  <span class="c"># rjenkins1</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">2</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>
<span class="n">host</span> <span class="n">mon03-ssd</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">7</span>           <span class="c"># do not change unnecessarily</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">8</span> <span class="n">class</span> <span class="n">ssd</span>         <span class="c"># do not change unnecessarily</span>
        <span class="c"># weight 0.039</span>
        <span class="n">alg</span> <span class="n">straw2</span>
        <span class="n">hash</span> <span class="n">0</span>  <span class="c"># rjenkins1</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">4</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>
<span class="n">host</span> <span class="n">mon01-sas</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">9</span> <span class="n">class</span> <span class="n">sas</span>
        <span class="n">alg</span> <span class="n">straw2</span>
        <span class="n">hash</span> <span class="n">0</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">1</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>
<span class="n">host</span> <span class="n">mon02-sas</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">10</span> <span class="n">class</span> <span class="n">sas</span>
        <span class="n">alg</span> <span class="n">straw2</span>
        <span class="n">hash</span> <span class="n">0</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">3</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>
<span class="n">host</span> <span class="n">mon03-sas</span> <span class="p">{</span>
        <span class="n">id</span> <span class="p">-</span><span class="n">11</span> <span class="n">class</span> <span class="n">sas</span>
        <span class="n">alg</span> <span class="n">straw2</span>
        <span class="n">hash</span> <span class="n">0</span>
        <span class="n">item</span> <span class="n">osd</span><span class="p">.</span><span class="n">5</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>

<span class="n">root</span> <span class="n">ssd</span> <span class="p">{</span>
    <span class="n">id</span> <span class="p">-</span><span class="n">1</span>
    <span class="n">id</span> <span class="p">-</span><span class="n">2</span> <span class="n">class</span> <span class="n">ssd</span>
    <span class="n">alg</span> <span class="n">straw2</span>
    <span class="n">hash</span> <span class="n">0</span>
    <span class="n">item</span> <span class="n">mon01-ssd</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
    <span class="n">item</span> <span class="n">mon02-ssd</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
    <span class="n">item</span> <span class="n">mon03-ssd</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>
<span class="n">root</span> <span class="n">sas</span> <span class="p">{</span>
    <span class="n">id</span> <span class="p">-</span><span class="n">127</span>
    <span class="n">id</span> <span class="p">-</span><span class="n">128</span> <span class="n">class</span> <span class="n">sas</span>
    <span class="n">alg</span> <span class="n">straw2</span>
    <span class="n">hash</span> <span class="n">0</span>
    <span class="n">item</span> <span class="n">mon01-sas</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
    <span class="n">item</span> <span class="n">mon02-sas</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
    <span class="n">item</span> <span class="n">mon03-sas</span> <span class="n">weight</span> <span class="n">0</span><span class="p">.</span><span class="n">019</span>
<span class="p">}</span>

<span class="c"># rules</span>
<span class="n">rule</span> <span class="n">ssd_rule</span> <span class="p">{</span>
    <span class="n">id</span> <span class="n">0</span>
    <span class="nb">type </span><span class="n">replicated</span>
    <span class="n">min_size</span> <span class="n">1</span>
    <span class="n">max_size</span> <span class="n">10</span>
    <span class="n">step</span> <span class="n">take</span> <span class="n">ssd</span>
    <span class="n">step</span> <span class="n">chooseleaf</span> <span class="n">firstn</span> <span class="n">0</span> <span class="nb">type </span><span class="n">host</span>
    <span class="n">step</span> <span class="n">emit</span>

<span class="p">}</span>
<span class="n">rule</span> <span class="n">sas_rule</span> <span class="p">{</span>
    <span class="n">id</span> <span class="n">1</span>
    <span class="nb">type </span><span class="n">replicated</span>
    <span class="n">min_size</span> <span class="n">1</span>
    <span class="n">max_size</span> <span class="n">10</span>
    <span class="n">step</span> <span class="n">take</span> <span class="n">sas</span>
    <span class="n">step</span> <span class="n">chooseleaf</span> <span class="n">firstn</span> <span class="n">0</span> <span class="nb">type </span><span class="n">host</span>
    <span class="n">step</span> <span class="n">emit</span>
<span class="p">}</span>

<span class="c"># end crush map</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">每个元素都应该有自己的id值</span>
    <span class="n">原则上来说</span><span class="err">，</span><span class="n">每个bucket名称最好不要一致</span><span class="err">，</span><span class="n">即使是同一台主机</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span><span class="err">、</span><span class="n">将修改后的crushmap_file</span><span class="p">.</span><span class="n">txt编译为二进制文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">crushtool</span> <span class="n">-c</span> <span class="n">crushmap_file_case</span><span class="p">.</span><span class="n">txt</span> <span class="n">-o</span> <span class="n">crushmap_file_case</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span><span class="err">、</span><span class="n">将新的crushmap注入到ceph集群</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">setcrushmap</span> <span class="n">-i</span> <span class="n">crushmap_file_case</span>
<span class="n">25</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">dump</span>
        <span class="p">...</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">crush</span> <span class="n">rule</span> <span class="n">dump</span>
        <span class="p">...</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">crush</span> <span class="n">map的数据修改成功了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认osd的状态树</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span>
<span class="n">ID</span>   <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="nb">TYPE </span><span class="n">NAME</span>          <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI-AFF</span>
<span class="p">-</span><span class="n">127</span>       <span class="n">0</span><span class="p">.</span><span class="n">05699</span> <span class="n">root</span> <span class="n">sas</span>
 <span class="p">-</span><span class="n">12</span>       <span class="n">0</span><span class="p">.</span><span class="n">01900</span>     <span class="n">host</span> <span class="n">mon01-sas</span>
   <span class="n">1</span>   <span class="n">sas</span> <span class="n">0</span><span class="p">.</span><span class="n">01900</span>         <span class="n">osd</span><span class="p">.</span><span class="n">1</span>          <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="p">-</span><span class="n">13</span>       <span class="n">0</span><span class="p">.</span><span class="n">01900</span>     <span class="n">host</span> <span class="n">mon02-sas</span>
   <span class="n">3</span>   <span class="n">sas</span> <span class="n">0</span><span class="p">.</span><span class="n">01900</span>         <span class="n">osd</span><span class="p">.</span><span class="n">3</span>          <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
 <span class="p">-</span><span class="n">14</span>       <span class="n">0</span><span class="p">.</span><span class="n">01900</span>     <span class="n">host</span> <span class="n">mon03-sas</span>
   <span class="n">5</span>   <span class="n">sas</span> <span class="n">0</span><span class="p">.</span><span class="n">01900</span>         <span class="n">osd</span><span class="p">.</span><span class="n">5</span>          <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
  <span class="p">-</span><span class="n">1</span>       <span class="n">0</span><span class="p">.</span><span class="n">05699</span> <span class="n">root</span> <span class="n">ssd</span>
  <span class="p">-</span><span class="n">3</span>       <span class="n">0</span><span class="p">.</span><span class="n">01900</span>     <span class="n">host</span> <span class="n">mon01-ssd</span>
   <span class="n">0</span>   <span class="n">ssd</span> <span class="n">0</span><span class="p">.</span><span class="n">01900</span>         <span class="n">osd</span><span class="p">.</span><span class="n">0</span>          <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
  <span class="p">-</span><span class="n">5</span>       <span class="n">0</span><span class="p">.</span><span class="n">01900</span>     <span class="n">host</span> <span class="n">mon02-ssd</span>
   <span class="n">2</span>   <span class="n">ssd</span> <span class="n">0</span><span class="p">.</span><span class="n">01900</span>         <span class="n">osd</span><span class="p">.</span><span class="n">2</span>          <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
  <span class="p">-</span><span class="n">7</span>       <span class="n">0</span><span class="p">.</span><span class="n">01900</span>     <span class="n">host</span> <span class="n">mon03-ssd</span>
   <span class="n">4</span>   <span class="n">ssd</span> <span class="n">0</span><span class="p">.</span><span class="n">01900</span>         <span class="n">osd</span><span class="p">.</span><span class="n">4</span>          <span class="n">up</span>  <span class="n">1</span><span class="p">.</span><span class="n">00000</span> <span class="n">1</span><span class="p">.</span><span class="n">00000</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建ssd存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">ssd_pool</span> <span class="n">16</span> <span class="n">16</span> <span class="n">replicated</span> <span class="n">ssd_rule</span>
<span class="n">pool</span> <span class="s1">&#39;ssd_pool&#39;</span> <span class="n">created</span>

<span class="n">创建sas存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">sas_pool</span> <span class="n">16</span> <span class="n">16</span> <span class="n">replicated</span> <span class="n">sas_rule</span>
<span class="n">pool</span> <span class="s1">&#39;sas_pool&#39;</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认不同的pool所使用的osd效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">ls-by-pool</span>  <span class="n">ssd_pool</span> <span class="p">|</span><span class="n">awk</span> <span class="s1">&#39;{print $1,$2,$15}&#39;</span>
<span class="n">PG</span> <span class="n">OBJECTS</span> <span class="n">ACTING</span>
<span class="n">15</span><span class="p">.</span><span class="n">0</span> <span class="n">0</span> <span class="p">[</span><span class="n">4</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="n">2</span><span class="p">]</span><span class="n">p4</span>
<span class="p">...</span>
<span class="n">15</span><span class="p">.</span><span class="n">f</span> <span class="n">0</span> <span class="p">[</span><span class="n">2</span><span class="p">,</span><span class="n">4</span><span class="p">,</span><span class="n">0</span><span class="p">]</span><span class="n">p2</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">pg</span> <span class="n">ls-by-pool</span>  <span class="n">sas_pool</span> <span class="p">|</span><span class="n">awk</span> <span class="s1">&#39;{print $1,$2,$15}&#39;</span>
<span class="n">PG</span> <span class="n">OBJECTS</span> <span class="n">ACTING</span>
<span class="n">16</span><span class="p">.</span><span class="n">0</span> <span class="n">0</span> <span class="p">[</span><span class="n">3</span><span class="p">,</span><span class="n">5</span><span class="p">,</span><span class="n">1</span><span class="p">]</span><span class="n">p3</span>
<span class="p">...</span>
<span class="n">16</span><span class="p">.</span><span class="n">f</span> <span class="n">0</span> <span class="p">[</span><span class="n">5</span><span class="p">,</span><span class="n">3</span><span class="p">,</span><span class="n">1</span><span class="p">]</span><span class="n">p5</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="13">1.3 可视化<a class="headerlink" href="#13" title="Permanent link">&para;</a></h2>
<h3 id="131_dashboard">1.3.1 dashboard<a class="headerlink" href="#131_dashboard" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">dashboard</span> <span class="n">是通过一个web界面</span><span class="err">，</span><span class="n">对已经运行的ceph集群进行状态查看以及功能配置等功能</span><span class="err">，</span><span class="n">早起ceph使用的是第三方的dashboard组件</span><span class="err">。</span>

    <span class="n">关于dashboard是通过模块的方式来进行加载的</span><span class="err">，</span><span class="n">而且默认情况下</span><span class="err">，</span><span class="n">该模块是具备输出所有ceph集群状态的一个模块</span><span class="err">，</span><span class="n">因为这里面涉及到某些敏感信息</span><span class="err">，</span><span class="n">所以默认情况下</span><span class="err">，</span><span class="n">使用https协议来进行访问</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span>
</code></pre></div>
<p>常见 监控模块工具</p>
<table>
<thead>
<tr>
<th>工具</th>
<th>解析</th>
</tr>
</thead>
<tbody>
<tr>
<td>calamari</td>
<td>对外提供了十分漂亮的web管理和监控界面，以及一套改进的REST API接口，在一定程度上简化了ceph管理，最初calamari是作为lnktank公司的ceph企业级商业产品来销售，红帽2015年收购后为了更好地推动ceph的发展，对外宣布calamari开源</td>
</tr>
<tr>
<td>VSM</td>
<td>Virtual Storage Manager是Inter公司研发并且开源的一款ceph集群管理和监控软件，简化了一些ceph集群部署的一些步骤，可以简单的通过web页面来操作</td>
</tr>
<tr>
<td>Inksope</td>
<td>Inksope是一个ceph的管理和监控系统，依赖于ceph提供的API，使用MongoDB来存储实时的监控数据和历史信息</td>
</tr>
<tr>
<td>dashboard</td>
<td>是用python开发的一个ceph的监控面板，用来监控ceph的运行状态。同时提供REST API来访问状态数据，该插件必须安装在mgr节点上。</td>
</tr>
</tbody>
</table>
<p>查看模块相关的命令</p>
<div class="highlight"><pre><span></span><code><span class="n">查与模块相关的功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="p">-</span><span class="n">-help</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">module</span>
<span class="n">mgr</span> <span class="n">module</span> <span class="n">disable</span> <span class="p">&lt;</span><span class="n">module</span><span class="p">&gt;</span>                               <span class="n">disable</span> <span class="n">mgr</span> <span class="n">module</span>
<span class="n">mgr</span> <span class="n">module</span> <span class="n">enable</span> <span class="p">&lt;</span><span class="n">module</span><span class="p">&gt;</span> <span class="p">{-</span><span class="n">-force</span><span class="p">}</span>                      <span class="n">enable</span> <span class="n">mgr</span> <span class="n">module</span>
<span class="n">mgr</span> <span class="n">module</span> <span class="nb">ls </span>                                            <span class="n">list</span> <span class="n">active</span> <span class="n">mgr</span> <span class="n">modules</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看模块功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="nb">ls</span>
<span class="p">{</span>
    <span class="s2">&quot;always_on_modules&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;balancer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;crash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;devicehealth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;orchestrator_cli&quot;</span><span class="p">,</span>
        <span class="s2">&quot;progress&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rbd_support&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;volumes&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;enabled_modules&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;iostat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;restful&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;disabled_modules&quot;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;alerts&quot;</span><span class="p">,</span>
            <span class="p">...</span>
</code></pre></div>
<p>部署dashboard模块</p>
<div class="highlight"><pre><span></span><code><span class="n">默认情况下</span><span class="err">，</span><span class="n">ceph是没有dashboard模块的</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="nb">ls </span><span class="p">|</span> <span class="n">grep</span> <span class="n">dashboard</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在所有的mgr节点上部署dashoard模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">mon01</span> <span class="n">mon02</span>
<span class="p">&gt;</span> <span class="k">do</span>
<span class="p">&gt;</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="p">@</span><span class="nv">$i</span> <span class="s2">&quot;sudo yum install ceph-mgr-dashboard -y&quot;</span>
<span class="p">&gt;</span> <span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认ceph集群是否启动了dashboard的模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="nb">ls </span><span class="p">|</span> <span class="n">grep</span> <span class="n">dashboard</span>                          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>启用dashboard</p>
<div class="highlight"><pre><span></span><code><span class="n">启用dashboard模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="n">enable</span> <span class="n">dashboard</span>

<span class="n">查看已经启用的功能模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="nb">ls </span><span class="p">|</span> <span class="n">grep</span> <span class="n">-A4</span> <span class="s2">&quot;enabled_modules&quot;</span>
    <span class="s2">&quot;enabled_modules&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iostat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;restful&quot;</span>
    <span class="p">],</span>
</code></pre></div>
<p>查看状态</p>
<div class="highlight"><pre><span></span><code><span class="n">关闭dashboard的tls功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">ssl</span> <span class="n">false</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认dashboard的服务效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">services</span>
<span class="p">{</span>
    <span class="s2">&quot;dashboard&quot;</span><span class="p">:</span> <span class="s2">&quot;http://stor01.superopsmsb.com:8080/&quot;</span>
<span class="p">}</span>

<span class="n">查看服务器启动端口</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">mon01</span> <span class="n">mon02</span><span class="p">;</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="p">@</span><span class="nv">$i</span> <span class="s2">&quot;sudo netstat -tnulp | grep 8080&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">8080</span>       <span class="p">:::*</span>       <span class="n">LISTEN</span>      <span class="n">1963</span><span class="p">/</span><span class="n">ceph-mgr</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">8080</span>       <span class="p">:::*</span>       <span class="n">LISTEN</span>      <span class="n">1903</span><span class="p">/</span><span class="n">ceph-mgr</span>
</code></pre></div>
<p>配置模块</p>
<div class="highlight"><pre><span></span><code><span class="n">配置dashboard监听的mon节点地址和端</span><span class="err">⼝：</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">mon01</span><span class="p">/</span><span class="n">server_addr</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">mon01</span><span class="p">/</span><span class="n">server_port</span> <span class="n">8080</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">mon02</span><span class="p">/</span><span class="n">server_addr</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">mon02</span><span class="p">/</span><span class="n">server_port</span> <span class="n">8080</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启mgr服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">再次确认监听端口的效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">mon01</span> <span class="n">mon02</span><span class="p">;</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="p">@</span><span class="nv">$i</span> <span class="s2">&quot;sudo netstat -tnulp | grep 8080&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">8080</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>    <span class="n">LISTEN</span>      <span class="n">2549</span><span class="p">/</span><span class="n">ceph-mgr</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">8080</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>    <span class="n">LISTEN</span>      <span class="n">2211</span><span class="p">/</span><span class="n">ceph-mgr</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">浏览器访问</span><span class="err">：</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">8080</span> <span class="n">或者</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">8080</span> <span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013195313762" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013195313762.png" /></p>
<p>设定登录密码</p>
<div class="highlight"><pre><span></span><code><span class="n">设定登录的用户名和密码</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">echo </span><span class="s2">&quot;12345678&quot;</span> <span class="p">&gt;&gt;</span> <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="nb">set-login</span><span class="n">-credentials</span> <span class="n">admin</span> <span class="n">-i</span> <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
<span class="p">******************************************************************</span>
<span class="p">***</span>          <span class="n">WARNING</span><span class="p">:</span> <span class="n">this</span> <span class="n">command</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">.</span>              <span class="p">***</span>
<span class="p">***</span> <span class="n">Please</span> <span class="n">use</span> <span class="n">the</span> <span class="n">ac-user</span><span class="p">-*</span> <span class="n">related</span> <span class="n">commands</span> <span class="n">to</span> <span class="n">manage</span> <span class="n">users</span><span class="p">.</span> <span class="p">***</span>
<span class="p">******************************************************************</span>
<span class="n">Username</span> <span class="n">and</span> <span class="n">password</span> <span class="n">updated</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">使用用户</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span><span class="n">和密码</span><span class="p">(</span><span class="n">12345678</span><span class="p">),</span><span class="n">浏览器登录dashboard的效果</span>
</code></pre></div>
<p><img alt="image-20221013195513390" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013195513390.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="132_tls">1.3.2 tls实践<a class="headerlink" href="#132_tls" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">如果我们希望ceph具有更加安全的访问能力的话</span><span class="err">，</span><span class="n">我们可以为dashboard能力提供tls能力</span><span class="err">。</span><span class="n">对于ceph来说</span><span class="err">，</span><span class="n">它的tls能力主要有两种方式</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">使用默认的tls能力</span>
    <span class="p">-</span> <span class="n">使用自签证书实现tls能力</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">对于tls能力来说</span><span class="err">，</span><span class="n">我们需要提前对于ceph启用tls的功能</span>
    <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">ssl</span> <span class="n">true</span>
</code></pre></div>
<p>基本步骤</p>
<div class="highlight"><pre><span></span><code><span class="n">方法1</span><span class="err">：</span><span class="n">使用默认的tls能力</span>
    <span class="n">ceph</span> <span class="n">dashboard</span> <span class="n">create-self-signed-cert</span>
<span class="n">方法2</span><span class="err">：</span><span class="n">使用自签证书实现tls能力</span>
    <span class="n">openssl</span> <span class="n">req</span> <span class="n">-new</span> <span class="n">-nodes</span> <span class="n">-x509</span> <span class="n">-subj</span> <span class="s2">&quot;/O=IT/CN=ceph.superopsmsb.com&quot;</span> <span class="n">-days</span> <span class="n">3650</span> <span class="n">-keyout</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">key</span> <span class="n">-out</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">crt</span> <span class="n">-extensions</span> <span class="n">v3_ca</span>

<span class="n">配置dashboard加载证书</span>
<span class="n">ceph</span> <span class="n">config-key</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">crt</span> <span class="n">-i</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">crt</span> 
<span class="n">ceph</span> <span class="n">config-key</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">key</span> <span class="n">-i</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">key</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>使用自动生成证书</p>
<div class="highlight"><pre><span></span><code><span class="n">重启模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">mkdir</span> <span class="n">tls</span> <span class="p">&amp;&amp;</span> <span class="nb">cd </span><span class="n">tls</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="n">disable</span> <span class="n">dashboard</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="n">enable</span> <span class="n">dashboard</span>

<span class="n">启用tls服务</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">ssl</span> <span class="n">true</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">生成自签证书</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="n">create-self-signed-cert</span>
<span class="n">Self-signed</span> <span class="n">certificate</span> <span class="n">created</span>

<span class="n">创建</span> <span class="n">web</span> <span class="n">登录用户密码</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="nb">echo </span><span class="s2">&quot;12345678&quot;</span> <span class="p">&gt;&gt;</span> <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="nb">set-login</span><span class="n">-credentials</span> <span class="n">admin</span> <span class="n">-i</span> <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启mgr服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">再次确认监听端口的效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">mon01</span> <span class="n">mon02</span><span class="p">;</span> <span class="k">do</span> <span class="n">ssh</span> <span class="n">cephadm</span><span class="p">@</span><span class="nv">$i</span> <span class="s2">&quot;sudo netstat -tnulp | grep ceph-mgr&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="p">...</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">8443</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>     <span class="n">LISTEN</span>      <span class="n">3093</span><span class="p">/</span><span class="n">ceph-mgr</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">8443</span>    <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>     <span class="n">LISTEN</span>      <span class="n">2491</span><span class="p">/</span><span class="n">ceph-mgr</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">使用用户</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span><span class="n">和密码</span><span class="p">(</span><span class="n">12345678</span><span class="p">),</span><span class="n">浏览器访问</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">8443</span> <span class="n">或者</span> <span class="n">https</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">8443</span> <span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013201943746" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013201943746.png" /></p>
<p>使用自签名证书</p>
<div class="highlight"><pre><span></span><code><span class="n">重启模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="n">disable</span> <span class="n">dashboard</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="n">enable</span> <span class="n">dashboard</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">生成自签证书</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">openssl</span> <span class="n">req</span> <span class="n">-new</span> <span class="n">-nodes</span> <span class="n">-x509</span> <span class="n">-subj</span> <span class="s2">&quot;/O=IT/CN=ceph.superopsmsb.com&quot;</span> <span class="n">-days</span> <span class="n">3650</span> <span class="n">-keyout</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">key</span> <span class="n">-out</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">crt</span> <span class="n">-extensions</span> <span class="n">v3_ca</span>
<span class="n">Generating</span> <span class="n">a</span> <span class="n">2048</span> <span class="n">bit</span> <span class="n">RSA</span> <span class="n">private</span> <span class="n">key</span>
<span class="p">.......+++</span>
<span class="p">...................+++</span>
<span class="n">writing</span> <span class="n">new</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">&#39;dashboard.key&#39;</span>
<span class="p">-----</span>
<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="nb">ls</span>
<span class="n">dashboard</span><span class="p">.</span><span class="n">crt</span>  <span class="n">dashboard</span><span class="p">.</span><span class="n">key</span>  <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用自签证书</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config-key</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">crt</span> <span class="n">-i</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">crt</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">config-key</span> <span class="nb">set </span><span class="n">mgr</span> <span class="n">mgr</span><span class="p">/</span><span class="n">dashboard</span><span class="p">/</span><span class="n">key</span> <span class="n">-i</span> <span class="n">dashboard</span><span class="p">.</span><span class="n">key</span>

<span class="n">创建</span> <span class="n">web</span> <span class="n">登录用户密码</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="nb">echo </span><span class="s2">&quot;12345678&quot;</span> <span class="p">&gt;&gt;</span> <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">tls</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="nb">set-login</span><span class="n">-credentials</span> <span class="n">admin-openssl</span> <span class="n">-i</span> <span class="n">dashboard_passwd</span><span class="p">.</span><span class="n">txt</span>
<span class="p">******************************************************************</span>
<span class="p">***</span>          <span class="n">WARNING</span><span class="p">:</span> <span class="n">this</span> <span class="n">command</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">.</span>              <span class="p">***</span>
<span class="p">***</span> <span class="n">Please</span> <span class="n">use</span> <span class="n">the</span> <span class="n">ac-user</span><span class="p">-*</span> <span class="n">related</span> <span class="n">commands</span> <span class="n">to</span> <span class="n">manage</span> <span class="n">users</span><span class="p">.</span> <span class="p">***</span>
<span class="p">******************************************************************</span>
<span class="n">Username</span> <span class="n">and</span> <span class="n">password</span> <span class="n">updated</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">宿主机hosts</span> <span class="n">文件定制</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">ceph</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">使用用户</span><span class="p">(</span><span class="n">admin-openssl</span><span class="p">)</span><span class="n">和密码</span><span class="p">(</span><span class="n">12345678</span><span class="p">),</span><span class="n">浏览器访问</span> <span class="n">https</span><span class="p">://</span><span class="n">ceph</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">:</span><span class="n">8443</span> <span class="n">效果</span><span class="err">：</span>
</code></pre></div>
<p><img alt="image-20221013203249531" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013203249531.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="133_rgw">1.3.3 RGW实践<a class="headerlink" href="#133_rgw" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph的dashboard很多都是可以直接使用的</span><span class="err">，</span><span class="n">但是对于</span> <span class="n">rgw</span><span class="p">,</span><span class="n">cephfs</span><span class="p">,</span><span class="n">iscsi</span><span class="p">,</span><span class="n">监控等功能</span><span class="err">，</span><span class="n">需要基于手工方式启用功能</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20221013204353270" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013204353270.png" /></p>
<p>准备rgw环境</p>
<div class="highlight"><pre><span></span><code><span class="n">查看rgw的效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">rgw</span>
    <span class="n">rgw</span><span class="p">:</span> <span class="n">1</span> <span class="n">daemon</span> <span class="n">active</span> <span class="p">(</span><span class="n">stor04</span><span class="p">)</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>用户准备</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的用户信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">create</span> <span class="p">-</span><span class="n">-uid</span><span class="p">=</span><span class="n">rgw</span> <span class="p">-</span><span class="n">-display-name</span><span class="p">=</span><span class="n">rgw</span> <span class="p">-</span><span class="n">-system</span>
<span class="p">{</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;rgw&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;rgw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;NAS972R98010Q2HUYW1F&quot;</span><span class="p">,</span>
            <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;AvQO7AepS0017A75ClRAZxkhFmzFwXxahkyQFHdX&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="p">...</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">radosgw-admin</span> <span class="n">user</span> <span class="n">info</span> <span class="p">-</span><span class="n">-uid</span><span class="p">=</span><span class="n">rgw</span>
</code></pre></div>
<p>为Dashboard设置access_key 和 secret_key</p>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span><span class="n">ceph的rgw属性定制是使用文件方式来实现</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制access-key认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="nb">echo </span><span class="s1">&#39;NAS972R98010Q2HUYW1F&#39;</span> <span class="p">&gt;</span> <span class="n">access-key</span><span class="p">.</span><span class="n">file</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="nb">set-rgw</span><span class="n">-api-access-key</span> <span class="n">-i</span> <span class="n">access-key</span><span class="p">.</span><span class="n">file</span>
<span class="n">Option</span> <span class="n">RGW_API_ACCESS_KEY</span> <span class="n">updated</span>

<span class="n">定制secret_key认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="nb">echo </span><span class="s1">&#39;AvQO7AepS0017A75ClRAZxkhFmzFwXxahkyQFHdX&#39;</span> <span class="p">&gt;</span> <span class="n">secret_key</span><span class="p">.</span><span class="n">file</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="nb">set-rgw</span><span class="n">-api-secret-key</span> <span class="n">-i</span> <span class="n">secret_key</span><span class="p">.</span><span class="n">file</span>
<span class="n">Option</span> <span class="n">RGW_API_SECRET_KEY</span> <span class="n">updated</span>
</code></pre></div>
<p>重启mgr服务</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看dashboard的RGW效果</span>
</code></pre></div>
<p><img alt="image-20221013210433473" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013210433473.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="134_nfs">1.3.4 NFS实践<a class="headerlink" href="#134_nfs" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph的dashboard很多都是可以直接使用的</span><span class="err">，</span><span class="n">但是对于</span> <span class="n">rgw</span><span class="p">,</span><span class="n">nfs</span><span class="p">,</span><span class="n">iscsi</span><span class="p">,</span><span class="n">监控等功能</span><span class="err">，</span><span class="n">需要基于手工方式启用功能</span><span class="err">。</span><span class="n">自从Ceph</span> <span class="n">的J版本开始</span><span class="err">，</span><span class="n">ceph引入了</span> <span class="n">nfs-ganesha软件</span><span class="err">，</span><span class="n">ganesha通过rgw和cephfs两种方式实现ceph以nfs的方式实现外部功能访问</span><span class="err">。</span><span class="n">从Ceph</span> <span class="n">Nautilus版本开始</span><span class="err">，</span><span class="n">Ceph</span> <span class="n">Dashboard中可以直接支持配置这两种方式的NFS</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">FSAL_RGW</span> <span class="n">调用librgw2将NFS协议转义为S3协议再通过RGW存入到Ceph中</span>
    <span class="p">-</span> <span class="n">FSAL_CEPH</span> <span class="n">调用libcephfs2将NFS转义为Cephfs协议再存入到Ceph</span> <span class="n">中</span>
</code></pre></div>
<p><img alt="image-20221013211051686" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013211051686.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">latest</span><span class="p">/</span><span class="n">cephfs</span><span class="p">/</span><span class="n">nfs</span><span class="p">/</span><span class="c">#nfs</span>
</code></pre></div>
<p>我们以stor04主机为ganesha节点</p>
<div class="highlight"><pre><span></span><code><span class="n">查看是否安装librgw2和libcephfs2软件包</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># rpm -qa |grep librgw</span>
<span class="n">librgw2</span><span class="p">-</span><span class="n">14</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">22</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">x86_64</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># rpm -qa |grep libcephfs</span>
<span class="n">libcephfs2</span><span class="p">-</span><span class="n">14</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">22</span><span class="p">-</span><span class="n">0</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">x86_64</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制软件源</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">nfs-ganesha</span><span class="p">.</span><span class="n">repo</span><span class="p">&lt;&lt;</span> <span class="n">eof</span>
<span class="p">[</span><span class="n">nfs-ganesha</span><span class="p">]</span>
<span class="n">name</span><span class="p">=</span><span class="n">nfs-ganesha</span>
<span class="n">baseurl</span><span class="p">=</span><span class="n">http</span><span class="p">://</span><span class="n">us-west</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">nfs-ganesha</span><span class="p">/</span><span class="n">rpm-V2</span><span class="p">.</span><span class="n">7-stable</span><span class="p">/</span><span class="n">nautilus</span><span class="p">/</span><span class="n">x86_64</span><span class="p">/</span>
<span class="n">enabled</span><span class="p">=</span><span class="n">1</span>
<span class="n">priority</span><span class="p">=</span><span class="n">1</span>
<span class="n">eof</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">部署ganesha服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># yum install nfs-ganesha nfs-ganesha-ceph nfs-ganesha-rgw -y</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">启动服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl start nfs-ganesha.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl status nfs-ganesha.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># systemctl enable nfs-ganesha.service</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>定制存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">新建</span> <span class="n">ganesha_data的pool</span><span class="err">，</span><span class="n">用来存放一些dashboard的nfs相关配置文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">ganesha_data</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">pool</span> <span class="s1">&#39;ganesha_data&#39;</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">新建空的daemon</span><span class="p">.</span><span class="n">txt文本文件</span><span class="err">。</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span>  <span class="n">touch</span> <span class="n">daemon</span><span class="p">.</span><span class="n">txt</span>

<span class="n">导入daemon文件到ganesha_data</span> <span class="n">pool中</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">ganesha_data</span> <span class="n">put</span> <span class="n">conf-stor04</span><span class="p">.</span><span class="n">localdomain</span> <span class="n">daemon</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意事项</span><span class="err">：</span>
    <span class="n">存入rados的文件名必须要是conf</span><span class="p">-&lt;</span><span class="n">daemon_id</span><span class="p">&gt;</span><span class="n">格式</span><span class="err">，</span><span class="n">其中</span><span class="p">&lt;</span><span class="n">daemon_id</span><span class="p">&gt;</span><span class="n">对应于运行此服务的节点名称</span><span class="err">。</span>
    <span class="n">后续Dashboard创建NFS后</span><span class="err">，</span><span class="n">conf</span><span class="p">-&lt;</span><span class="n">daemon_id</span><span class="p">&gt;</span><span class="n">会有内容</span><span class="err">，</span><span class="n">每个conf</span><span class="p">-&lt;</span><span class="n">daemon_id</span><span class="p">&gt;</span><span class="n">都包含指向NFS-Ganesha守护程序应服务的导出的RADOS</span> <span class="n">URL</span><span class="err">。</span>
        <span class="n">格式为</span><span class="err">：</span><span class="k">%</span><span class="n">url</span> <span class="n">rados</span><span class="p">://&lt;</span><span class="n">pool_name</span><span class="p">&gt;[/&lt;</span><span class="n">namespace</span><span class="p">&gt;]/</span><span class="n">export</span><span class="p">-&lt;</span><span class="n">id</span><span class="p">&gt;</span>
    <span class="n">conf</span><span class="p">-&lt;</span><span class="n">daemon_id</span><span class="p">&gt;</span><span class="n">和export</span><span class="p">-&lt;</span><span class="n">id</span><span class="p">&gt;</span><span class="n">对象必须存储在同一个RADOS池</span><span class="p">/</span><span class="n">命名空间</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rados</span> <span class="n">-p</span> <span class="n">ganesha_data</span> <span class="nb">ls</span>
<span class="n">conf-mon02</span><span class="p">.</span><span class="n">localdomain</span>
<span class="n">conf-mon03</span><span class="p">.</span><span class="n">localdomain</span>
<span class="n">conf-mon01</span><span class="p">.</span><span class="n">localdomain</span>
</code></pre></div>
<p>确定rgw认证信息</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前Ceph节点的rgw认证信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">stor04</span>
<span class="no">[client.rgw.stor04]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQCkOEJj</span><span class="p">/</span><span class="n">uBgIRAALPAxf3NIp0EbGiCDgLegig</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow rw&quot;</span>
        <span class="n">caps</span> <span class="n">osd</span> <span class="p">=</span> <span class="s2">&quot;allow rwx&quot;</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">rgw</span><span class="p">.</span><span class="n">stor04</span>
</code></pre></div>
<p>配置ganesha配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">修改所有rgw节点上的ganesha配置文件</span> 
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">~]</span><span class="c"># cat /etc/ganesha/ganesha.conf</span>
<span class="p">...</span>
<span class="c"># 定制rados的连接配置</span>
<span class="n">RADOS_URLS</span> <span class="p">{</span>
    <span class="n">ceph_conf</span> <span class="p">=</span> <span class="s2">&quot;/etc/ceph/ceph.conf&quot;</span><span class="p">;</span>
    <span class="n">Userid</span> <span class="p">=</span> <span class="s2">&quot;admin&quot;</span><span class="p">;</span>
    <span class="n">watch_url</span> <span class="p">=</span> <span class="s2">&quot;rados://ganesha_data/conf-stor04.localdomain&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">%</span><span class="n">url</span> <span class="n">rados</span><span class="p">://</span><span class="n">ganesha_data</span><span class="p">/</span><span class="n">conf-stor04</span><span class="p">.</span><span class="n">localdomain</span>
<span class="c"># 定制rgw的连接配置</span>
<span class="n">RGW</span> <span class="p">{</span>
        <span class="n">ceph_conf</span> <span class="p">=</span> <span class="s2">&quot;/etc/ceph/ceph.conf&quot;</span><span class="p">;</span>
        <span class="n">name</span> <span class="p">=</span> <span class="s2">&quot;client.rgw.stor04.localdomain&quot;</span><span class="p">;</span>
        <span class="n">cluster</span> <span class="p">=</span> <span class="s2">&quot;ceph&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">配置解析</span><span class="err">：</span>
    <span class="n">RADOS_URLS</span> <span class="n">定制rados的连接配置</span>
        <span class="n">watch_url</span> <span class="n">指定rados的专属文件地址</span>
    <span class="n">RGW</span> <span class="n">定制rgw的连接配置</span>
        <span class="n">name</span> <span class="n">定制rgw的专属认证账户信息</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启ganesha服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor04</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># systemctl restart nfs-ganesha</span>
</code></pre></div>
<p>启用NFS-Ganesha能力</p>
<div class="highlight"><pre><span></span><code><span class="n">设定dashboard的nfs配置所在位置</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">dashboard</span> <span class="nb">set-ganesha</span><span class="n">-clusters-rados-pool-namespace</span> <span class="n">ganesha_data</span>
<span class="n">Option</span> <span class="n">GANESHA_CLUSTERS_RADOS_POOL_NAMESPACE</span> <span class="n">updated</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启mgr服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon01</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@mon02</span> <span class="p">~]</span><span class="c"># systemctl restart ceph-mgr.target</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重新查看Dashboard的NFS功能效果</span>
</code></pre></div>
<p><img alt="image-20221013222600422" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013222600422.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="14">1.4 监控<a class="headerlink" href="#14" title="Permanent link">&para;</a></h2>
<h3 id="141_prom">1.4.1 prom基础<a class="headerlink" href="#141_prom" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、术语解析、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>软件简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Prometheus</span> <span class="n">作为生态圈</span> <span class="n">Cloud</span> <span class="n">Native</span> <span class="n">Computing</span> <span class="n">Foundation</span><span class="err">（</span><span class="n">CNCF</span><span class="err">）</span><span class="n">中的重要一员</span>

    <span class="n">Prometheus</span> <span class="n">本身基于Go语言开发的一套开源的系统监控报警框架和时序列数据库</span><span class="p">(</span><span class="n">TSDB</span><span class="p">)</span><span class="err">。</span><span class="n">它启发于</span> <span class="n">Google</span> <span class="n">的</span> <span class="n">borgmon</span> <span class="n">监控系统</span><span class="err">，</span><span class="n">在一定程度上可以理解为</span><span class="err">，</span><span class="n">Google</span> <span class="n">BorgMon监控系统的开源版本</span><span class="err">。</span>
    <span class="n">该软件由工作在</span> <span class="n">SoundCloud</span> <span class="n">的</span> <span class="n">google</span> <span class="n">前员工在</span> <span class="n">2012</span> <span class="n">年创建</span><span class="err">，</span><span class="n">作为社区开源项目进行开发</span><span class="err">，</span><span class="n">并于</span> <span class="n">2015</span> <span class="n">年正式发布</span><span class="err">。</span><span class="n">2016</span> <span class="n">年</span><span class="err">，</span><span class="n">Prometheus</span> <span class="n">正式加入</span> <span class="n">Cloud</span> <span class="n">Native</span> <span class="n">Computing</span> <span class="n">Foundation</span><span class="err">，</span><span class="n">随着容器技术的迅速发展</span><span class="err">，</span><span class="n">Kubernetes</span> <span class="n">已然成为大家追捧的容器集群管理系统</span><span class="err">。</span><span class="n">其活跃度仅次于</span> <span class="n">Kubernetes的开源项目</span><span class="p">,</span> <span class="n">现已广泛用于容器集群的监控系统中</span><span class="err">，</span><span class="n">当然不仅限于容器集群</span><span class="err">。。</span>
    <span class="n">Prometheus功能更完善</span><span class="err">、</span><span class="n">更全面</span><span class="err">，</span><span class="n">性能也足够支撑上万台规模的集群</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">网站</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">prometheus</span><span class="p">.</span><span class="n">io</span><span class="p">/</span>
<span class="n">github</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">prometheus</span>
<span class="n">最新版本</span><span class="err">：</span><span class="n">2</span><span class="p">.</span><span class="n">39</span><span class="p">.</span><span class="n">1</span> <span class="p">/</span> <span class="n">2022</span><span class="p">-</span><span class="n">10</span><span class="p">-</span><span class="n">07</span>
</code></pre></div>
<p>prometheus的架构效果图如下：</p>
<p><img alt="architecture" src="../../../img/kubernetes/kubernetes_storage_ceph/1.1.3-2.png" /></p>
<div class="highlight"><pre><span></span><code>    从上图可以看出，Prometheus 的主要模块包括：Prometheus server, exporters, Pushgateway, PromQL, Alertmanager 以及图形界面。
</code></pre></div>
<p>其大概的工作流程是：</p>
<div class="codehilite"><pre><span></span><code>1 Prometheus server 定期从配置好的 jobs 或者 exporters 中拉 metrics，或者接收来自 Pushgateway 发过来的 metrics，或者从其他的 Prometheus server 中拉 metrics。
2 Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，记录新的时间序列或者向 Alertmanager 推送警报，实现一定程度上的完全冗余功能。
3 Alertmanager 根据配置文件，对接收到的警报进行去重分组，根据路由配置，向对应主机发出告警。
4 集成Grafana或其他API作为图形界面，用于可视化收集的数据。
</code></pre></div>

<p>Prometheus 由几个主要的软件组件组成，其职责概述如下。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>解析</th>
</tr>
</thead>
<tbody>
<tr>
<td>Prometheus Server</td>
<td>彼此独立运行，仅依靠其本地存储来实现其核心功能：抓取时序数据，规则处理和警报等。</td>
</tr>
<tr>
<td>Client Library</td>
<td>客户端库，为需要监控的服务生成相应的 metrics 并暴露给 Prometheus server。当 Prometheus server 来 pull 时，直接返回实时状态的 metrics。</td>
</tr>
<tr>
<td>Push Gateway</td>
<td>主要用于短期的 jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus server 端推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。</td>
</tr>
<tr>
<td>Exporters</td>
<td>部署到第三方软件主机上，用于暴露已有的第三方服务的 metrics 给 Prometheus。</td>
</tr>
<tr>
<td>Alertmanager</td>
<td>从 Prometheus server 端接收到 alerts 后，会进行去除重复数据，分组，并路由到对应的接受方式，以高效向用户完成告警信息发送。常见的接收方式有：电子邮件，pagerduty，OpsGenie, webhook 等,一些其他的工具。</td>
</tr>
<tr>
<td>Data Visualization</td>
<td>Prometheus Web UI （Prometheus Server内建），及Grafana等</td>
</tr>
<tr>
<td>Service Discovery</td>
<td>动态发现待监控的Target，从而完成监控配置的重要组件，在容器化环境中尤为有用；该组件目前由Prometheus Server内建支持；</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><code>在上诉的组件中，大多数都是用Go编写的，因此易于构建和部署为静态二进制文件。
</code></pre></div>

<p><strong>术语解析</strong></p>
<p>metrics</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Prometheus中存储的数据为时间序列</span><span class="err">，</span><span class="n">即基于同一度量标准或者同一时间维度的数据流</span><span class="err">。</span><span class="n">除了时间序列数据的正常存储之外</span><span class="err">，</span><span class="n">Prometheus还会基于原始数据临时生成新的时间序列数据</span><span class="err">，</span><span class="n">用于后续查询的依据或结果</span><span class="err">。</span>
    <span class="n">每个时间序列都由metric名称和标签</span><span class="p">(</span><span class="n">可选键值对</span><span class="p">)</span><span class="n">组合成唯一标识</span><span class="err">。</span>

    <span class="n">查询语言允许基于这些维度进行过滤和聚合</span><span class="err">。</span><span class="n">更改任何标签值</span><span class="err">，</span><span class="n">包括添加或删除标签</span><span class="err">，</span><span class="n">都会创建一个新的时间序列</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20211013134435251" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211013134435251.png" /></p>
<p>数据获取</p>
<div class="highlight"><pre><span></span><code>    <span class="n">这些metric数据</span><span class="err">，</span><span class="n">是基于HTTP</span> <span class="n">call方式来进行获取的</span><span class="err">，</span><span class="n">从对方的配置文件中指定的网络端点</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span><span class="n">上周期性获取指标数据</span><span class="err">。</span><span class="n">每一个端点上几乎不可能只有一个数据指标</span><span class="err">。</span>
    <span class="n">用Prometheus术语来说</span><span class="err">，</span><span class="n">一个单独</span> <span class="n">scrape</span><span class="p">(</span><span class="n">host</span><span class="p">:</span><span class="n">port</span><span class="p">;)</span><span class="n">的目标称为instance</span><span class="err">，</span><span class="n">通常对应于单个进程</span><span class="err">。</span> <span class="n">一组同种类型的</span> <span class="n">instances集合称为jobs</span><span class="err">，</span><span class="n">主要用于保证可扩展性和可靠性</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20211013111443902" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20211013111443902.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="142_prom">1.4.2 prom部署<a class="headerlink" href="#142_prom" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 prometheus部署、grafana部署、exporter部署、小结 四个方面来学习。</p>
<p><strong>prometheus部署</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">创建软件目录</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/{</span><span class="n">server</span><span class="p">,</span><span class="n">softs</span><span class="p">}</span> <span class="n">-p</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">softs</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">以上所有的prometheus软件都去https</span><span class="p">://</span><span class="n">prometheus</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">网站下载</span><span class="err">。</span>
    <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">prometheus</span><span class="p">/</span><span class="n">prometheus</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">v2</span><span class="p">.</span><span class="n">39</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">prometheus</span><span class="p">-</span><span class="n">2</span><span class="p">.</span><span class="n">39</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">解压软件</span>
<span class="n">tar</span> <span class="n">xf</span> <span class="n">prometheus</span><span class="p">-</span><span class="n">2</span><span class="p">.</span><span class="n">39</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="n">-C</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span>
<span class="n">ln</span> <span class="n">-s</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span><span class="p">-</span><span class="n">2</span><span class="p">.</span><span class="n">39</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">linux-amd64</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span>
</code></pre></div>
<p>安装软件</p>
<div class="highlight"><pre><span></span><code><span class="n">配置准备</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span><span class="p">/{</span><span class="n">data</span><span class="p">,</span><span class="n">cfg</span><span class="p">,</span><span class="n">logs</span><span class="p">,</span><span class="n">bin</span><span class="p">}</span> <span class="n">-p</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span>
<span class="nb">mv </span><span class="n">prometheus</span> <span class="n">promtool</span> <span class="n">bin</span><span class="p">/</span>
<span class="nb">mv </span><span class="n">prometheus</span><span class="p">.</span><span class="n">yml</span> <span class="n">cfg</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">环境变量定制</span>
<span class="p">]</span><span class="c"># cat /etc/profile.d/prometheus.sh </span>
<span class="c">#!/bin/bash</span>
<span class="c"># set prometheus env</span>
<span class="n">export</span> <span class="n">PROMETHEUS_HOME</span><span class="p">=/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span>
<span class="n">export</span> <span class="n">PATH</span><span class="p">=</span><span class="nv">$PATH</span><span class="p">:${</span><span class="n">PROMETHEUS_HOME</span><span class="p">}/</span><span class="n">bin</span>

<span class="n">应用环境变量文件</span>
<span class="p">]</span><span class="c"># source /etc/profile.d/prometheus.sh </span>
<span class="p">]</span><span class="c"># chmod +x /etc/profile.d/prometheus.sh</span>
</code></pre></div>
<p>服务定制</p>
<div class="highlight"><pre><span></span><code><span class="n">定制prometheus服务文件</span>
<span class="p">]</span><span class="c"># cat /usr/lib/systemd/system/prometheus.service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">prometheus</span> <span class="n">server</span> <span class="n">project</span>
<span class="n">After</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">simple</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">prometheus</span> <span class="p">-</span><span class="n">-config</span><span class="p">.</span><span class="n">file</span><span class="p">=/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span><span class="p">/</span><span class="n">cfg</span><span class="p">/</span><span class="n">prometheus</span><span class="p">.</span><span class="n">yml</span> <span class="p">-</span><span class="n">-storage</span><span class="p">.</span><span class="n">tsdb</span><span class="p">.</span><span class="n">path</span><span class="p">=/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">prometheus</span><span class="p">/</span><span class="n">data</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>

<span class="n">配置解析</span><span class="err">：</span>
    <span class="n">在这里</span><span class="err">，</span><span class="n">我们需要将定制的prometheus的配置文件和数据目录作为启动参数配置好</span>
    <span class="n">其它的参数</span><span class="err">，</span><span class="n">我们可以基于prometheus</span> <span class="p">-</span><span class="n">-help</span> <span class="n">查看更多</span>

<span class="n">启动服务</span>
<span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">prometheus</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">prometheus</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">prometheus</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">]</span><span class="c"># netstat -tnulp | egrep &#39;Pro|pro&#39;</span>
<span class="n">Proto</span> <span class="n">Recv-Q</span> <span class="nb">Send-Q</span> <span class="n">Local</span> <span class="n">Address</span>           <span class="n">Foreign</span> <span class="n">Address</span>         <span class="n">State</span>       <span class="n">PID</span><span class="p">/</span><span class="n">Program</span> <span class="n">name</span>    
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">9090</span>                 <span class="p">:::*</span>                    <span class="n">LISTEN</span>      <span class="n">25082</span><span class="p">/</span><span class="n">prometheus</span> 
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">可以看到当前主机上可以看到一个端口9090</span><span class="err">，</span><span class="n">我们可通过可以看到prometheus的服务页面</span>

<span class="n">浏览器访问</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="p">:</span><span class="n">9090</span><span class="p">/</span><span class="err">，</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013232913546" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013232913546.png" /></p>
<p><strong>grafana部署</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">创建软件目录</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">softs</span>
<span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">dl</span><span class="p">.</span><span class="n">grafana</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">enterprise</span><span class="p">/</span><span class="n">release</span><span class="p">/</span><span class="n">grafana-enterprise</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">x86_64</span><span class="p">.</span><span class="n">rpm</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">grafana软件从</span> <span class="n">https</span><span class="p">://</span><span class="n">grafana</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">grafana</span><span class="p">/</span><span class="n">download</span> <span class="n">下载</span>
</code></pre></div>
<p>安装软件</p>
<div class="highlight"><pre><span></span><code><span class="n">安装软件</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">grafana-enterprise</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">x86_64</span><span class="p">.</span><span class="n">rpm</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里安装的是本地文件</span><span class="err">，</span><span class="n">所以要加文件路径</span>

<span class="n">安装插件</span>
<span class="n">grafana-cli</span> <span class="n">plugins</span> <span class="n">list-remote</span>
<span class="n">grafana-cli</span> <span class="n">plugins</span> <span class="n">install</span> <span class="n">grafana-piechart-panel</span>
<span class="n">grafana-cli</span> <span class="n">plugins</span> <span class="nb">ls</span>

<span class="n">启动服务</span>
<span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">grafana-server</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">grafana-server</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">grafana-server</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">]</span><span class="c"># netstat -tnulp | egrep &#39;Pro|gra&#39;</span>
<span class="n">Proto</span> <span class="n">Recv-Q</span> <span class="nb">Send-Q</span> <span class="n">Local</span> <span class="n">Address</span>           <span class="n">Foreign</span> <span class="n">Address</span>         <span class="n">State</span>       <span class="n">PID</span><span class="p">/</span><span class="n">Program</span> <span class="n">name</span>    
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">3000</span>                 <span class="p">:::*</span>                    <span class="n">LISTEN</span>      <span class="n">25839</span><span class="p">/</span><span class="n">grafana-serve</span> 
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">当前主机上出现了一个端口3000</span>

<span class="n">浏览器访问</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="p">:</span><span class="n">3000</span><span class="p">/</span><span class="err">，</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013233232284" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013233232284.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">输入用户名和密码</span><span class="err">：</span><span class="n">admin</span><span class="p">/</span><span class="n">admin</span><span class="err">，</span><span class="n">就会进入到更改密码的页面</span><span class="err">，</span><span class="n">重置过密码后</span><span class="err">，</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013233326269" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013233326269.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">添加数据源</span><span class="p">:</span> <span class="n">点击</span> <span class="s2">&quot;Add your data source&quot;</span> <span class="n">选择</span> <span class="s2">&quot;Prometheus&quot;</span> <span class="n">出现添加界面</span>
</code></pre></div>
<p><img alt="image-20221013233442609" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013233442609.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">点击最下面的</span> <span class="n">save</span> <span class="p">&amp;</span> <span class="n">test</span>
</code></pre></div>
<p><strong>exporter部署</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">解压软件</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">softs</span>
<span class="n">tar</span> <span class="n">xf</span> <span class="n">node_exporter</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="n">-C</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">配置命令</span>
<span class="n">ln</span> <span class="n">-s</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">linux-amd64</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span><span class="p">/</span><span class="n">bin</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span>
<span class="nb">mv </span><span class="n">node_exporter</span> <span class="n">bin</span><span class="p">/</span>

<span class="n">配置环境变量</span>
<span class="c"># cat /etc/profile.d/node_exporter.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># set node_exporter env</span>
<span class="n">export</span> <span class="n">PROMETHEUS_HOME</span><span class="p">=/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span>
<span class="n">export</span> <span class="n">PATH</span><span class="p">=</span><span class="nv">$PATH</span><span class="p">:${</span><span class="n">PROMETHEUS_HOME</span><span class="p">}/</span><span class="n">bin</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">服务文件</span>
<span class="p">]</span><span class="c"># cat /usr/lib/systemd/system/node_exporter.service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">node</span> <span class="n">exporter</span> <span class="n">project</span>
<span class="n">After</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">simple</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">node_exporter</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>

<span class="n">启动服务</span>
<span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">node_exporter</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">node_exporter</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">node_exporter</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">]</span><span class="c"># netstat -tnulp | egrep &#39;Pro|node&#39;    </span>
<span class="n">Proto</span> <span class="n">Recv-Q</span> <span class="nb">Send-Q</span> <span class="n">Local</span> <span class="n">Address</span>           <span class="n">Foreign</span> <span class="n">Address</span>         <span class="n">State</span>       <span class="n">PID</span><span class="p">/</span><span class="n">Program</span> <span class="n">name</span>    
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">9100</span>                 <span class="p">:::*</span>                    <span class="n">LISTEN</span>      <span class="n">24650</span><span class="p">/</span><span class="n">node_exporter</span> 
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">可以看到当前主机上可以看到一个端口9100</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">访问http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="p">:</span><span class="n">9100</span><span class="p">/</span><span class="n">metrics</span> <span class="n">就可以看到node</span> <span class="n">export所在节点的所有定制好的监控项</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@stor06</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">node_exporter</span><span class="p">]</span><span class="c"># curl -s http://10.0.0.18:9100/metrics | head</span>
<span class="c"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span>
<span class="c"># TYPE go_gc_duration_seconds summary</span>
<span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="p">=</span><span class="s2">&quot;0&quot;</span><span class="p">}</span> <span class="n">0</span><span class="p">.</span><span class="n">000104469</span>
<span class="n">go_gc_duration_seconds</span><span class="p">{</span><span class="n">quantile</span><span class="p">=</span><span class="s2">&quot;0.25&quot;</span><span class="p">}</span> <span class="n">0</span><span class="p">.</span><span class="n">000104469</span>
</code></pre></div>
<p>环境集成</p>
<div class="highlight"><pre><span></span><code><span class="n">编辑prometheus配置文件</span>
<span class="p">]</span><span class="c"># vim /data/server/prometheus/cfg/prometheus.yml</span>
<span class="p">...</span>
<span class="n">scrape_configs</span><span class="p">:</span>
  <span class="p">...</span>
  <span class="p">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="s1">&#39;node_exporter&#39;</span>
    <span class="n">static_configs</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;10.0.0.12:9100&#39;</span><span class="p">]</span>

    <span class="n">属性解析</span><span class="err">：</span>
        <span class="n">新增一个job_name</span> <span class="n">和</span> <span class="n">static_configs的属性</span>
        <span class="n">targets</span> <span class="n">就是我们在基本概念中讲到的instance</span><span class="err">，</span><span class="n">格式就是</span><span class="s2">&quot;ip:port&quot;</span>

<span class="n">重启服务</span>        
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">prometheus</span><span class="p">.</span><span class="n">service</span>    
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">浏览器访问</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="p">:</span><span class="n">9090</span><span class="p">/</span><span class="n">targets</span> <span class="n">就可以看到node_exporter已经被prometheus加载到监控中了</span><span class="err">，</span><span class="n">效果如下</span>
</code></pre></div>
<p><img alt="image-20221013234058265" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013234058265.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">登录到Grafana界面</span><span class="err">，</span><span class="n">点击左侧边栏</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="n">选择</span><span class="s2">&quot;import&quot;</span><span class="p">,</span><span class="n">在dashboard的输入框中输入</span> <span class="n">https</span><span class="p">://</span><span class="n">grafana</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">dashboards</span><span class="p">/</span><span class="n">8919</span><span class="p">,</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013234413884" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013234413884.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">点击完</span> <span class="n">load后</span><span class="err">，</span><span class="n">在当前界面的下方找到数据集</span> <span class="n">prometheus</span><span class="err">，</span><span class="n">最后点击</span> <span class="n">import</span><span class="err">，</span><span class="n">效果如下</span>
</code></pre></div>
<p><img alt="image-20221013234455785" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013234455785.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="143_ceph">1.4.3 ceph监控<a class="headerlink" href="#143_ceph" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Ceph</span> <span class="n">Manager内置了众多模块</span><span class="err">，</span><span class="n">包括prometheus模块</span><span class="err">，⽤</span><span class="n">于直接输出Prometheus</span><span class="err">⻛</span><span class="n">格的指标数据</span><span class="err">。</span><span class="n">我们只需要开启该功能即可</span><span class="err">，</span><span class="n">Prometheus模块默认监听于TCP协议的9283端</span><span class="err">⼝。</span>
</code></pre></div>
<p>开启ceph的prometheus模块</p>
<div class="highlight"><pre><span></span><code><span class="n">开启ceph的监听模块</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="n">enable</span> <span class="n">prometheus</span>

<span class="n">查看模块效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mgr</span> <span class="n">module</span> <span class="nb">ls</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="s2">&quot;enabled_modules&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;dashboard&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iostat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nfs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prometheus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;restful&quot;</span>
    <span class="p">],</span>

<span class="n">检查mgr的暴露端口</span>
<span class="n">root</span><span class="nv">@mon02</span><span class="p">:~</span><span class="c"># netstat -tnulp | grep mgr</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">8443</span>          <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>    <span class="n">LISTEN</span>      <span class="n">8111</span><span class="p">/</span><span class="n">ceph-mgr</span>
<span class="n">tcp6</span>       <span class="n">0</span>      <span class="n">0</span> <span class="p">:::</span><span class="n">9283</span>                 <span class="p">:::*</span>         <span class="n">LISTEN</span>      <span class="n">8111</span><span class="p">/</span><span class="n">ceph-mgr</span>
</code></pre></div>
<p>配置prometheus的监控配置</p>
<div class="highlight"><pre><span></span><code><span class="p">]</span><span class="c"># vim /data/server/prometheus/cfg/prometheus.yml</span>
<span class="p">...</span>
<span class="n">scrape_configs</span><span class="p">:</span>
  <span class="p">...</span>
  <span class="p">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="s1">&#39;ceph&#39;</span>
    <span class="n">static_configs</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;10.0.0.13:9283&#39;</span><span class="p">]</span>

    <span class="n">属性解析</span><span class="err">：</span>
        <span class="n">新增一个job_name</span> <span class="n">和</span> <span class="n">static_configs的属性</span>
        <span class="n">targets</span> <span class="n">就是我们在基本概念中讲到的instance</span><span class="err">，</span><span class="n">格式就是</span><span class="s2">&quot;ip:port&quot;</span>

<span class="n">重启服务</span>        
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">prometheus</span><span class="p">.</span><span class="n">service</span>    

<span class="n">浏览器访问</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span><span class="p">:</span><span class="n">9090</span><span class="p">/</span><span class="n">targets</span> <span class="n">就可以看到node_exporter已经被prometheus加载到监控中了</span><span class="err">，</span><span class="n">效果如下</span>
</code></pre></div>
<p><img alt="image-20221013235206075" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013235206075.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">登录到Grafana界面</span><span class="err">，</span><span class="n">点击左侧边栏</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="n">选择</span><span class="s2">&quot;import&quot;</span><span class="p">,</span><span class="n">在dashboard的输入框中输入</span> <span class="n">https</span><span class="p">://</span><span class="n">grafana</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">dashboards</span><span class="p">/</span><span class="n">2842</span><span class="p">,</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20221013235316552" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221013235316552.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="15_k8s">1.5 k8s实践<a class="headerlink" href="#15_k8s" title="Permanent link">&para;</a></h2>
<h3 id="151_1">1.5.1 基础环境<a class="headerlink" href="#151_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 集群规划、主机认证、小结 三个方面来学习。</p>
<p><strong>集群规划</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">在这里</span><span class="err">，</span><span class="n">我们以单主分布式的主机节点效果来演示kubernetes的最新版本的集群环境部署</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220715092558666" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220715092558666.png" /></p>
<p>节点集群组件规划</p>
<p><img alt="image-20220715093007357" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20220715093007357.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">master节点</span>
    <span class="n">kubeadm</span><span class="p">(</span><span class="n">集群环境</span><span class="p">)</span><span class="err">、</span><span class="n">kubectl</span><span class="p">(</span><span class="n">集群管理</span><span class="p">)</span><span class="err">、</span><span class="n">kubelet</span><span class="p">(</span><span class="n">节点状态</span><span class="p">)</span>
    <span class="n">kube-apiserver</span><span class="err">、</span><span class="n">kube-controller-manager</span><span class="err">、</span><span class="n">kube-scheduler</span><span class="err">、</span><span class="n">etcd</span>
    <span class="n">containerd</span><span class="p">(</span><span class="n">docker方式部署</span><span class="p">)</span><span class="err">、</span><span class="n">flannel</span><span class="p">(</span><span class="n">插件部署</span><span class="p">)</span>
<span class="n">node节点</span>
    <span class="n">kubeadm</span><span class="p">(</span><span class="n">集群环境</span><span class="p">)</span><span class="err">、</span><span class="n">kubelet</span><span class="p">(</span><span class="n">节点状态</span><span class="p">)</span>
    <span class="n">kube-proxy</span><span class="err">、</span><span class="n">containerd</span><span class="p">(</span><span class="n">docker方式部署</span><span class="p">)</span><span class="err">、</span><span class="n">flannel</span><span class="p">(</span><span class="n">插件部署</span><span class="p">)</span>
</code></pre></div>
<p>主机名规划</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>主机ip</th>
<th>主机名规划</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10.0.0.19</td>
<td>kubernetes-master.superopsmsb.com  kubernetes-master</td>
</tr>
<tr>
<td>2</td>
<td>10.0.0.20</td>
<td>kubernetes-node1.superopsmsb.com  kubernetes-node1</td>
</tr>
<tr>
<td>3</td>
<td>10.0.0.21</td>
<td>kubernetes-node2.superopsmsb.com  kubernetes-node2</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">修改master节点主机的hosts文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /etc/hosts</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span> <span class="n">kubernetes-master</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">kubernetes-master</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">kubernetes-node1</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">21</span> <span class="n">kubernetes-node2</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node2</span>
</code></pre></div>
<p><strong>主机认证</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">因为整个集群节点中的很多文件配置都是一样的</span><span class="err">，</span><span class="n">所以我们需要配置跨主机免密码认证方式来定制集群的认证通信机制</span><span class="err">，</span><span class="n">这样后续在批量操作命令的时候</span><span class="err">，</span><span class="n">就非常轻松了</span><span class="err">。</span>
</code></pre></div>
<p>脚本内容</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/01_remote_host_auth.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 批量设定远程主机免密码认证</span>
<span class="c"># 版本: v0.2</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>
<span class="n">user_dir</span><span class="p">=</span><span class="s1">&#39;/root&#39;</span>
<span class="n">host_file</span><span class="p">=</span><span class="s1">&#39;/etc/hosts&#39;</span>
<span class="n">login_user</span><span class="p">=</span><span class="s1">&#39;root&#39;</span>
<span class="n">login_pass</span><span class="p">=</span><span class="s1">&#39;123456&#39;</span>
<span class="n">target_type</span><span class="p">=(</span><span class="n">部署</span> <span class="n">免密</span> <span class="n">同步</span> <span class="n">主机名</span> <span class="n">退出</span><span class="p">)</span>

<span class="c"># 菜单</span>
<span class="n">menu</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[31m批量设定远程主机免密码认证管理界面\e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 1: 部署环境   2: 免密认证   3: 同步hosts \e[0m&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 4: 设定主机名 5：退出操作 \e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
<span class="p">}</span>
<span class="c"># expect环境</span>
<span class="n">expect_install</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">[</span> <span class="o">-f</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">expect</span> <span class="p">]</span>
  <span class="n">then</span>
     <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect环境已经部署完毕\e[0m&quot;</span>
  <span class="k">else</span>
     <span class="n">yum</span> <span class="n">install</span> <span class="n">expect</span> <span class="n">-y</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">null</span> <span class="n">2</span><span class="p">&gt;&amp;</span><span class="n">1</span> <span class="p">&amp;&amp;</span> <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装完毕\e[0m&quot;</span> <span class="p">||</span> <span class="p">(</span><span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装失败\e[0m&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">exit</span><span class="p">)</span>
  <span class="n">fi</span>
<span class="p">}</span>
<span class="c"># 秘钥文件生成环境</span>
<span class="n">create_authkey</span><span class="p">(){</span>
  <span class="c"># 保证历史文件清空</span>
  <span class="p">[</span> <span class="n">-d</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span> <span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="nb">rm </span><span class="n">-rf</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/*</span>
  <span class="c"># 构建秘钥文件对</span>
  <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ssh-keygen</span> <span class="n">-t</span> <span class="n">rsa</span> <span class="n">-P</span> <span class="s2">&quot;&quot;</span> <span class="o">-f</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33m秘钥文件已经创建完毕\e[0m&quot;</span>
<span class="p">}</span>
<span class="c"># expect自动匹配逻辑</span>
<span class="n">expect_autoauth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部参数</span>
  <span class="n">command</span><span class="p">=</span><span class="s2">&quot;$@&quot;</span>
  <span class="n">expect</span> <span class="n">-c</span> <span class="s2">&quot;</span>
<span class="s2">    spawn ${command}</span>
<span class="s2">    expect {</span>
<span class="s2">      \&quot;</span><span class="n">yes</span><span class="p">/</span><span class="n">no</span><span class="p">\</span><span class="s2">&quot; {send \&quot;</span><span class="n">yes</span><span class="p">\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;}</span>
<span class="s2">   }&quot;</span>
<span class="p">}</span>
<span class="c"># 跨主机传输文件认证</span>
<span class="n">sshkey_auth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="c"># /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12</span>
     <span class="n">cmd</span><span class="p">=</span><span class="s2">&quot;/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub&quot;</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">expect_autoauth_func</span> <span class="p">${</span><span class="n">cmd</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 跨主机同步hosts文件</span>
<span class="n">scp_hosts_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">scp</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}:${</span><span class="n">host_file</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 跨主机设定主机名规划</span>
<span class="n">set_hostname_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="n">host_name</span><span class="p">=$(</span><span class="n">grep</span> <span class="p">${</span><span class="n">ip</span><span class="p">}</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}|</span><span class="n">awk</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">ssh</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span> <span class="s2">&quot;hostnamectl set-hostname ${host_name}&quot;</span>
  <span class="n">done</span>
<span class="p">}</span>
<span class="c"># 帮助信息逻辑</span>
<span class="n">Usage</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="s2">&quot;请输入有效的操作id&quot;</span>
<span class="p">}</span>
<span class="c"># 逻辑入口</span>
<span class="k">while</span> <span class="n">true</span>
<span class="k">do</span>
  <span class="n">menu</span>
  <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入有效的操作id: &quot;</span> <span class="n">target_id</span>
  <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="c">#target_type[@]} -ge ${target_id} ]</span>
  <span class="n">then</span>
    <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;部署&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始部署环境操作...&quot;</span>
       <span class="n">expect_install</span>
       <span class="n">create_authkey</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;免密&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行免密认证操作...&quot;</span>
       <span class="n">sshkey_auth_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;同步&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行同步hosts文件操作...&quot;</span>
       <span class="n">scp_hosts_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;主机名&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行设定主机名操作...&quot;</span>
       <span class="n">set_hostname_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;退出&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始退出管理界面...&quot;</span>
       <span class="n">exit</span>
    <span class="n">fi</span>
  <span class="k">else</span>
    <span class="n">Usage</span>
  <span class="n">fi</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">为了更好的把环境部署成功</span><span class="err">，</span><span class="n">最好提前更新一下软件源信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum makecache</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看脚本执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/01_remote_host_auth.sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">同步hosts</span>
 <span class="n">4</span><span class="p">:</span> <span class="n">设定主机名</span> <span class="n">5</span><span class="err">：</span><span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">1</span>
<span class="n">开始部署环境操作</span><span class="p">...</span>
<span class="n">expect环境已经部署完毕</span>
<span class="n">Generating</span> <span class="n">public</span><span class="p">/</span><span class="n">private</span> <span class="n">rsa</span> <span class="n">key</span> <span class="n">pair</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">identification</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">public</span> <span class="n">key</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span><span class="p">.</span>
<span class="n">The</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="n">is</span><span class="p">:</span>
<span class="n">SHA256</span><span class="p">:</span><span class="n">u</span><span class="p">/</span><span class="n">Tzk0d9sNtG6r9Kx</span><span class="p">+</span><span class="n">6xPaENNqT3Lw178XWXQhX1yMw</span> <span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span>
<span class="n">The</span> <span class="n">key</span><span class="s1">&#39;s randomart image is:</span>
<span class="s1">+---[RSA 2048]----+</span>
<span class="s1">|               .+|</span>
<span class="s1">|             + o.|</span>
<span class="s1">|              E .|</span>
<span class="s1">|             o.  |</span>
<span class="s1">|        S   +  +.|</span>
<span class="s1">|         . . *=+B|</span>
<span class="s1">|        o   o+B%O|</span>
<span class="s1">|       . o. +.O+X|</span>
<span class="s1">|        . .o.=+XB|</span>
<span class="s1">+----[SHA256]-----+</span>
<span class="s1">秘钥文件已经创建完毕</span>
<span class="s1">批量设定远程主机免密码认证管理界面</span>
<span class="s1">=====================================================</span>
<span class="s1"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s1"> 4: 设定主机名 5：退出操作</span>
<span class="s1">=====================================================</span>
<span class="s1">请输入有效的操作id: 2</span>
<span class="s1">请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {19..21}</span>
<span class="s1">开始执行免密认证操作...</span>
<span class="s1">spawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.19</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">21</span><span class="err">&#39;</span><span class="s2">&quot;</span>
<span class="s2">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 3</span>
<span class="s2">请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): {19..21}</span>
<span class="s2">开始执行同步hosts文件操作...</span>
<span class="s2">hosts                                    100%  470   226.5KB/s   00:00</span>
<span class="s2">hosts                                    100%  470   458.8KB/s   00:00</span>
<span class="s2">hosts                                    100%  470   533.1KB/s   00:00</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 4</span>
<span class="s2">请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): {19..21}</span>
<span class="s2">开始执行设定主机名操作...</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 5</span>
<span class="s2">开始退出管理界面...</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># exec /bin/bash</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in {19..21}</span>
<span class="p">&gt;</span> <span class="k">do</span>
<span class="p">&gt;</span> <span class="n">name</span><span class="p">=$(</span><span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;hostname&quot;</span><span class="p">)</span>
<span class="p">&gt;</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="nv">$name</span>
<span class="p">&gt;</span> <span class="n">done</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span> <span class="n">kubernetes-master</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">kubernetes-node1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">21</span> <span class="n">kubernetes-node2</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="152_1">1.5.2 集群准备<a class="headerlink" href="#152_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 内核调整、软件源配置、小结 三个方面来学习。</p>
<p><strong>内核调整</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">根据kubernetes官方资料的相关信息</span><span class="err">，</span><span class="n">我们需要对kubernetes集群是所有主机进行内核参数的调整</span><span class="err">。</span>
</code></pre></div>
<p>禁用swap</p>
<div class="highlight"><pre><span></span><code>    <span class="n">部署集群时</span><span class="err">，</span><span class="n">kubeadm默认会预先检查当前主机是否禁用了Swap设备</span><span class="err">，</span><span class="n">并在未禁用时强制终止部署过程</span><span class="err">。</span><span class="n">因此</span><span class="err">，</span><span class="n">在主机内存资源充裕的条件下</span><span class="err">，</span><span class="n">需要禁用所有的Swap设备</span><span class="err">，</span><span class="n">否则</span><span class="err">，</span><span class="n">就需要在后文的kubeadm</span> <span class="n">init及kubeadm</span> <span class="n">join命令执行时额外使用相关的选项忽略检查错误</span>

<span class="n">关闭Swap设备</span><span class="err">，</span><span class="n">需要分两步完成</span><span class="err">。</span>
<span class="n">首先是关闭当前已启用的所有Swap设备</span><span class="err">：</span>
<span class="n">swapoff</span> <span class="n">-a</span>

<span class="n">而后编辑</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab配置文件</span><span class="err">，</span><span class="n">注释用于挂载Swap设备的所有行</span><span class="err">。</span>
<span class="n">方法一</span><span class="err">：</span><span class="n">手工编辑</span>
<span class="n">vim</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
<span class="c"># UUID=0a55fdb5-a9d8-4215-80f7-f42f75644f69 none  swap    sw      0       0</span>

<span class="n">方法二</span><span class="err">：</span>
<span class="n">sed</span> <span class="n">-i</span> <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span> 
    <span class="n">替换后位置的</span><span class="p">&amp;</span><span class="n">代表前面匹配的整行内容</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">只需要注释掉自动挂载SWAP分区项即可</span><span class="err">，</span><span class="n">防止机子重启后swap启用</span>

<span class="n">内核</span><span class="p">(</span><span class="n">禁用swap</span><span class="p">)</span><span class="n">参数</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="p">=</span><span class="n">0</span>
<span class="n">EOF</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<p>网络参数</p>
<div class="highlight"><pre><span></span><code><span class="n">配置iptables参数</span><span class="err">，</span><span class="n">使得流经网桥的流量也经过iptables</span><span class="p">/</span><span class="n">netfilter防火墙</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">EOF</span>

<span class="n">配置生效</span>
<span class="n">modprobe</span> <span class="n">br_netfilter</span>
<span class="n">modprobe</span> <span class="n">overlay</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">脚本方式</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/02_kubernetes_kernel_conf.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 批量设定kubernetes的内核参数调整</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 禁用swap</span>
<span class="n">swapoff</span> <span class="n">-a</span>
<span class="n">sed</span> <span class="n">-i</span> <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="p">=</span><span class="n">0</span>
<span class="n">EOF</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>

<span class="c"># 打开网络转发</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">EOF</span>

<span class="c"># 加载相应的模块</span>
<span class="n">modprobe</span> <span class="n">br_netfilter</span>
<span class="n">modprobe</span> <span class="n">overlay</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<p>脚本执行</p>
<div class="highlight"><pre><span></span><code><span class="n">master主机执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/02_kubernetes_kernel_conf.sh</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有node主机执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in 20 21;do ssh root@10.0.0.$i mkdir /data/scripts -p; scp /data/scripts/02_kubernetes_kernel_conf.sh root@10.0.0.$i:/data/scripts/02_kubernetes_kernel_conf.sh;ssh root@10.0.0.$i &quot;/bin/bash /data/scripts/02_kubernetes_kernel_conf.sh&quot;;done</span>
</code></pre></div>
<p><strong>软件源配置</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">由于我们需要在多台主机上初始化kubernetes主机环境</span><span class="err">，</span><span class="n">所以我们需要在多台主机上配置kubernetes的软件源</span><span class="err">，</span><span class="n">以最简便的方式部署kubernetes环境</span><span class="err">。</span>
</code></pre></div>
<p>定制阿里云软件源</p>
<div class="highlight"><pre><span></span><code><span class="n">定制阿里云的关于kubernetes的软件源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span>
<span class="no">[kubernetes]</span>
<span class="n">name</span><span class="p">=</span><span class="n">Kubernetes</span>
<span class="n">baseurl</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">repos</span><span class="p">/</span><span class="n">kubernetes-el7-x86_64</span>
<span class="n">enabled</span><span class="p">=</span><span class="n">1</span>
<span class="n">gpgcheck</span><span class="p">=</span><span class="n">0</span>
<span class="n">repo_gpgcheck</span><span class="p">=</span><span class="n">0</span>
<span class="n">gpgkey</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">yum-key</span><span class="p">.</span><span class="n">gpg</span> <span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">rpm-package-key</span><span class="p">.</span><span class="n">gpg</span>
<span class="n">EOF</span>

<span class="n">更新软件源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum makecache fast</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum install kubeadm-1.23.9-0 kubectl-1.23.9-0 kubelet-1.23.9-0 -y</span>
</code></pre></div>
<p>其他节点主机同步软件源</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in 20 21;do scp /etc/yum.repos.d/kubernetes.repo root@10.0.0.$i:/etc/yum.repos.d/kubernetes.repo;ssh root@10.0.0.$i &quot;yum makecache fast; yum install kubeadm-1.23.9-0 kubelet-1.23.9-0 -y&quot;;done</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="153_1">1.5.3 容器环境<a class="headerlink" href="#153_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 Docker环境、环境配置、小结 三个方面来学习。</p>
<p><strong>Docker环境</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">由于kubernetes1</span><span class="p">.</span><span class="n">24版本才开始将默认支持的容器引擎转换为了Containerd了</span><span class="err">，</span><span class="n">所以这里我们还是以Docker软件作为后端容器的引擎</span><span class="err">，</span><span class="n">因为目前的CKA考试环境是以kubernetes1</span><span class="p">.</span><span class="n">23版本为基准的</span><span class="err">。</span>
</code></pre></div>
<p>软件源配置</p>
<div class="highlight"><pre><span></span><code><span class="n">安装基础依赖软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum install -y yum-utils device-mapper-persistent-data lvm2</span>

<span class="n">定制专属的软件源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre></div>
<p>安装软件</p>
<div class="highlight"><pre><span></span><code><span class="n">确定最新版本的docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum list docker-ce --showduplicates | sort -r</span>

<span class="n">安装最新版本的docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum install -y docker-ce</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">启动docker服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># systemctl restart docker</span>

<span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker version</span>
<span class="n">Client</span><span class="p">:</span> <span class="n">Docker</span> <span class="n">Engine</span> <span class="p">-</span> <span class="n">Community</span>
 <span class="n">Version</span><span class="p">:</span>           <span class="n">20</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">17</span>
 <span class="n">API</span> <span class="n">version</span><span class="p">:</span>       <span class="n">1</span><span class="p">.</span><span class="n">41</span>
 <span class="n">Go</span> <span class="n">version</span><span class="p">:</span>        <span class="n">go1</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">11</span>
 <span class="n">Git</span> <span class="n">commit</span><span class="p">:</span>        <span class="n">100c701</span>
 <span class="n">Built</span><span class="p">:</span>             <span class="n">Mon</span> <span class="n">Jun</span>  <span class="n">6</span> <span class="n">23</span><span class="p">:</span><span class="n">05</span><span class="p">:</span><span class="n">12</span> <span class="n">2022</span>
 <span class="n">OS</span><span class="p">/</span><span class="n">Arch</span><span class="p">:</span>           <span class="n">linux</span><span class="p">/</span><span class="n">amd64</span>
 <span class="n">Context</span><span class="p">:</span>           <span class="k">default</span>
 <span class="n">Experimental</span><span class="p">:</span>      <span class="n">true</span>

<span class="n">Server</span><span class="p">:</span> <span class="n">Docker</span> <span class="n">Engine</span> <span class="p">-</span> <span class="n">Community</span>
 <span class="n">Engine</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">20</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">17</span>
  <span class="n">API</span> <span class="n">version</span><span class="p">:</span>      <span class="n">1</span><span class="p">.</span><span class="n">41</span> <span class="p">(</span><span class="n">minimum</span> <span class="n">version</span> <span class="n">1</span><span class="p">.</span><span class="n">12</span><span class="p">)</span>
  <span class="n">Go</span> <span class="n">version</span><span class="p">:</span>       <span class="n">go1</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">11</span>
  <span class="n">Git</span> <span class="n">commit</span><span class="p">:</span>       <span class="n">a89b842</span>
  <span class="n">Built</span><span class="p">:</span>            <span class="n">Mon</span> <span class="n">Jun</span>  <span class="n">6</span> <span class="n">23</span><span class="p">:</span><span class="n">03</span><span class="p">:</span><span class="n">33</span> <span class="n">2022</span>
  <span class="n">OS</span><span class="p">/</span><span class="n">Arch</span><span class="p">:</span>          <span class="n">linux</span><span class="p">/</span><span class="n">amd64</span>
  <span class="n">Experimental</span><span class="p">:</span>     <span class="n">false</span>
 <span class="n">containerd</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">1</span><span class="p">.</span><span class="n">6</span><span class="p">.</span><span class="n">6</span>
  <span class="n">GitCommit</span><span class="p">:</span>        <span class="n">10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span>
 <span class="n">runc</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span>
  <span class="n">GitCommit</span><span class="p">:</span>        <span class="n">v1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">-</span><span class="n">0-ga916309</span>
 <span class="n">docker-init</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">0</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">0</span>
  <span class="n">GitCommit</span><span class="p">:</span>        <span class="n">de40ad0</span>
</code></pre></div>
<p><strong>环境配置</strong></p>
<p>需求</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">镜像仓库</span>
    <span class="n">默认安装的docker会从官方网站上获取docker镜像</span><span class="err">，</span><span class="n">有时候会因为网络因素无法获取</span><span class="err">，</span><span class="n">所以我们需要配置国内镜像仓库的加速器</span>
<span class="n">2</span> <span class="n">kubernetes的改造</span>
    <span class="n">kubernetes的创建容器</span><span class="err">，</span><span class="n">需要借助于kubelet来管理Docker</span><span class="err">，</span><span class="n">而默认的Docker服务进程的管理方式不是kubelet的类型</span><span class="err">，</span><span class="n">所以需要改造Docker的服务启动类型为systemd方式</span><span class="err">。</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">默认情况下</span><span class="err">，</span><span class="n">Docker的服务修改有两种方式</span><span class="err">：</span>
        <span class="n">1</span> <span class="n">Docker服务</span> <span class="p">-</span> <span class="n">需要修改启动服务文件</span><span class="err">，</span><span class="n">需要重载服务文件</span><span class="err">，</span><span class="n">比较繁琐</span><span class="err">。</span>
        <span class="n">2</span> <span class="n">daemon</span><span class="p">.</span><span class="n">json文件</span> <span class="p">-</span> <span class="n">修改文件后</span><span class="err">，</span><span class="n">只需要重启docker服务即可</span><span class="err">，</span><span class="n">该文件默认情况下不存在</span><span class="err">。</span>
</code></pre></div>
<p>定制docker配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">定制配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># cat &gt;&gt; /etc/docker/daemon.json &lt;&lt;-EOF</span>
<span class="p">{</span>
  <span class="s2">&quot;registry-mirrors&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;http://74f21445.m.daocloud.io&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://registry.docker-cn.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http://hub-mirror.c.163.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
  <span class="p">],</span> 
  <span class="s2">&quot;insecure-registries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.0.0.20:80&quot;</span><span class="p">],</span> 
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="n">重启docker服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># systemctl restart docker</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看配置效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker info</span>
<span class="n">Client</span><span class="p">:</span>
 <span class="p">...</span>

<span class="n">Server</span><span class="p">:</span>
 <span class="p">...</span>
 <span class="n">Cgroup</span> <span class="n">Driver</span><span class="p">:</span> <span class="n">systemd</span>
 <span class="p">...</span>
 <span class="n">Insecure</span> <span class="n">Registries</span><span class="p">:</span>
  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span><span class="p">:</span><span class="n">80</span>
  <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">8</span>
 <span class="n">Registry</span> <span class="n">Mirrors</span><span class="p">:</span>
  <span class="n">http</span><span class="p">://</span><span class="n">74f21445</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">daocloud</span><span class="p">.</span><span class="n">io</span><span class="p">/</span>
  <span class="n">https</span><span class="p">://</span><span class="n">registry</span><span class="p">.</span><span class="n">docker-cn</span><span class="p">.</span><span class="n">com</span><span class="p">/</span>
  <span class="n">http</span><span class="p">://</span><span class="n">hub-mirror</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">163</span><span class="p">.</span><span class="n">com</span><span class="p">/</span>
  <span class="n">https</span><span class="p">://</span><span class="n">docker</span><span class="p">.</span><span class="n">mirrors</span><span class="p">.</span><span class="n">ustc</span><span class="p">.</span><span class="n">edu</span><span class="p">.</span><span class="n">cn</span><span class="p">/</span>
 <span class="n">Live</span> <span class="n">Restore</span> <span class="n">Enabled</span><span class="p">:</span> <span class="n">false</span>
</code></pre></div>
<p>docker环境定制脚本</p>
<div class="highlight"><pre><span></span><code><span class="n">查看脚本内容</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/03_kubernetes_docker_install.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 安装部署Docker容器环境</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>

<span class="c"># 软件源配置</span>
<span class="n">softs_base</span><span class="p">(){</span>
  <span class="c"># 安装基础软件</span>
  <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">yum-utils</span> <span class="n">device-mapper-persistent-data</span> <span class="n">lvm2</span>
  <span class="c"># 定制软件仓库源</span>
  <span class="n">yum-config-manager</span> <span class="p">-</span><span class="n">-add-repo</span> <span class="n">http</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">centos</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span>
  <span class="c"># 更新软件源</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">network</span>
  <span class="n">yum</span> <span class="n">makecache</span> <span class="n">fast</span>
<span class="p">}</span>

<span class="c"># 软件安装</span>
<span class="n">soft_install</span><span class="p">(){</span>
  <span class="c"># 安装最新版的docker软件</span>
  <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">docker-ce</span>
  <span class="c"># 重启docker服务</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="p">}</span>

<span class="c"># 加速器配置</span>
<span class="n">speed_config</span><span class="p">(){</span>
  <span class="c"># 定制加速器配置</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">docker</span><span class="p">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">-EOF</span>
<span class="p">{</span>
  <span class="s2">&quot;registry-mirrors&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;http://74f21445.m.daocloud.io&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://registry.docker-cn.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http://hub-mirror.c.163.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;insecure-registries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.0.0.20:80&quot;</span><span class="p">],</span>
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
  <span class="c"># 重启docker服务</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="p">}</span>

<span class="c"># 环境监测</span>
<span class="n">docker_check</span><span class="p">(){</span>
  <span class="n">process_name</span><span class="p">=$(</span><span class="n">docker</span> <span class="n">info</span> <span class="p">|</span> <span class="n">grep</span> <span class="s1">&#39;p D&#39;</span> <span class="p">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
  <span class="p">[</span> <span class="s2">&quot;${process_name}&quot;</span> <span class="p">==</span> <span class="s2">&quot;systemd&quot;</span> <span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="nb">echo </span><span class="s2">&quot;Docker软件部署完毕&quot;</span> <span class="p">||</span> <span class="p">(</span><span class="nb">echo </span><span class="s2">&quot;Docker软件部署失败&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">exit</span><span class="p">)</span>
<span class="p">}</span>

<span class="c"># 软件部署</span>
<span class="n">main</span><span class="p">(){</span>
  <span class="n">softs_base</span>
  <span class="n">soft_install</span>
  <span class="n">speed_config</span>
  <span class="n">docker_check</span>
<span class="p">}</span>

<span class="c"># 调用主函数</span>
<span class="n">main</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其他主机环境部署docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in {19..21}; do ssh root@10.0.0.$i &quot;mkdir -p /data/scripts&quot;; scp /data/scripts/03_kubernetes_docker_install.sh root@10.0.0.$i:/data/scripts/03_kubernetes_docker_install.sh; done</span>

<span class="n">其他主机各自执行下面的脚本</span>
<span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_kubernetes_docker_install</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="154_k8s">1.5.4 k8s环境<a class="headerlink" href="#154_k8s" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 集群部署、其他配置、小结 三个方面来学习。</p>
<p><strong>集群部署</strong></p>
<p>镜像获取</p>
<div class="highlight"><pre><span></span><code><span class="n">镜像获取脚本内容</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/04_kubernetes_get_images.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 获取kubernetes依赖的Docker镜像文件</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>
<span class="c"># 定制普通环境变量</span>
<span class="n">ali_mirror</span><span class="p">=</span><span class="s1">&#39;registry.aliyuncs.com&#39;</span>
<span class="n">harbor_mirror</span><span class="p">=</span><span class="s1">&#39;kubernetes-register.superopsmsb.com&#39;</span>
<span class="n">harbor_repo</span><span class="p">=</span><span class="s1">&#39;google_containers&#39;</span>

<span class="c"># 环境定制</span>
<span class="n">kubernetes_image_get</span><span class="p">(){</span>
  <span class="c"># 获取脚本参数</span>
  <span class="n">kubernetes_version</span><span class="p">=</span><span class="s2">&quot;$1&quot;</span>
  <span class="c"># 获取制定kubernetes版本所需镜像</span>
  <span class="n">images</span><span class="p">=$(</span><span class="n">kubeadm</span> <span class="n">config</span> <span class="n">images</span> <span class="n">list</span> <span class="p">-</span><span class="n">-kubernetes-version</span><span class="p">=${</span><span class="n">kubernetes_version</span><span class="p">}</span> <span class="p">|</span> <span class="n">awk</span> <span class="o">-F</span> <span class="s2">&quot;/&quot;</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>

  <span class="c"># 获取依赖镜像</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">${</span><span class="n">images</span><span class="p">}</span>
  <span class="k">do</span>
    <span class="n">docker</span> <span class="n">pull</span> <span class="p">${</span><span class="n">ali_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">tag</span> <span class="p">${</span><span class="n">ali_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>  <span class="p">${</span><span class="n">harbor_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">rmi</span> <span class="p">${</span><span class="n">ali_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 脚本的帮助</span>
<span class="n">Usage</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="s2">&quot;/bin/bash $0 &quot;</span>
<span class="p">}</span>

<span class="c"># 脚本主流程</span>
<span class="k">if</span> <span class="p">[</span> <span class="p">$</span><span class="c"># -eq 0 ]</span>
<span class="n">then</span>
   <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入要获取kubernetes镜像的版本(示例: v1.23.9): &quot;</span> <span class="n">kubernetes_version</span>
   <span class="n">kubernetes_image_get</span> <span class="p">${</span><span class="n">kubernetes_version</span><span class="p">}</span>
<span class="k">else</span>
   <span class="n">Usage</span>
<span class="n">fi</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">脚本执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/04_kubernetes_get_images.sh</span>
<span class="n">请输入要获取kubernetes镜像的版本</span><span class="p">(</span><span class="n">示例</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span><span class="p">):</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">node节点获取镜像</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">pause</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">6</span>
</code></pre></div>
<p>master环境初始化</p>
<div class="highlight"><pre><span></span><code><span class="n">环境初始化命令</span>
<span class="n">kubeadm</span> <span class="n">init</span> <span class="p">-</span><span class="n">-kubernetes-version</span><span class="p">=</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-apiserver-advertise-address</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-image-repository</span> <span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-service-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-pod-network-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-ignore-preflight-errors</span><span class="p">=</span><span class="n">Swap</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">设定kubernetes的认证权限</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># mkdir -p $HOME/.kube</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>

<span class="n">再次检测</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>     <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">4m10s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<p>node环境初始化</p>
<div class="highlight"><pre><span></span><code><span class="n">node节点环境初始化</span>
<span class="n">kubeadm</span> <span class="n">join</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-token</span> <span class="n">vfiiwc</span><span class="p">.</span><span class="n">se99g4ai8wl2md9r</span>  <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">0c552edf7b884431dfc1877e6f09a0660460ddbdc567d2366dae43dbc10e9554</span>
</code></pre></div>
<p><strong>其他配置</strong></p>
<p>网络环境配置</p>
<div class="highlight"><pre><span></span><code><span class="n">创建基本目录</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span> <span class="n">-p</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span>

<span class="n">获取配置文件</span>
<span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">raw</span><span class="p">.</span><span class="n">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">flannel-io</span><span class="p">/</span><span class="n">flannel</span><span class="p">/</span><span class="n">master</span><span class="p">/</span><span class="n">Documentation</span><span class="p">/</span><span class="n">kube-flannel</span><span class="p">.</span><span class="n">yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有节点获取镜像</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">docker</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">rancher</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel-cni-plugin</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">docker</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">rancher</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">2</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用网络环境配置文件</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">kube-flannel</span><span class="p">.</span><span class="n">yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># kubectl  get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">10m</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">9m56s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">9m52s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<p>命令优化</p>
<div class="highlight"><pre><span></span><code><span class="n">放到当前用户的环境文件中</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># echo &quot;source &lt;(kubeadm completion bash)&quot; &gt;&gt; ~/.bashrc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># source ~/.bashrc</span>

<span class="n">测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get n</span>
<span class="n">namespaces</span>                         <span class="n">networkpolicies</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>  <span class="n">nodes</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm co</span>
<span class="n">completion</span>  <span class="n">config</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="155_rbd">1.5.5 rbd实践<a class="headerlink" href="#155_rbd" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">自从k8s1</span><span class="p">.</span><span class="n">13版本以来</span><span class="err">，</span><span class="n">ceph与k8s的集成越来越紧密</span><span class="err">。</span><span class="n">ceph为k8s提供存储服务主要有两种方式</span><span class="err">，</span><span class="n">cephfs和ceph</span> <span class="n">rdb</span><span class="err">；</span><span class="n">cephfs方式支持k8s的pv的3种访问模式ReadWriteOnce</span><span class="err">，</span><span class="n">ReadOnlyMany</span><span class="err">，</span><span class="n">ReadWriteMany</span> <span class="err">，</span><span class="n">RBD支持ReadWriteOnce</span><span class="err">，</span><span class="n">ReadOnlyMany</span><span class="err">。</span>
</code></pre></div>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">跨主机免密码认证</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># /bin/bash 01_remote_host_auth.sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">同步hosts</span>
 <span class="n">4</span><span class="p">:</span> <span class="n">设定主机名</span> <span class="n">5</span><span class="err">：</span><span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">2</span>
<span class="n">请输入需要批量远程主机认证的主机列表范围</span><span class="p">(</span><span class="n">示例</span><span class="p">:</span> <span class="p">{</span><span class="n">12</span><span class="p">..</span><span class="n">19</span><span class="p">}):</span> <span class="p">{</span><span class="n">19</span><span class="p">..</span><span class="n">21</span><span class="p">}</span>
<span class="n">开始执行免密认证操作</span><span class="p">...</span>
<span class="n">spawn</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ssh-copy-id</span> <span class="n">-i</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span>
<span class="p">...</span>
<span class="n">Now</span> <span class="k">try</span> <span class="n">logging</span> <span class="n">into</span> <span class="n">the</span> <span class="n">machine</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span>   <span class="s2">&quot;ssh &#39;root@10.0.0.21&#39;&quot;</span>
<span class="n">and</span> <span class="n">check</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">only</span> <span class="n">the</span> <span class="n">key</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">you</span> <span class="n">wanted</span> <span class="n">were</span> <span class="n">added</span><span class="p">.</span>

<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">同步hosts</span>
 <span class="n">4</span><span class="p">:</span> <span class="n">设定主机名</span> <span class="n">5</span><span class="err">：</span><span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">5</span>
<span class="n">开始退出管理界面</span><span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ceph环境准备工作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># for i in {19..21}</span>
<span class="k">do</span>
  <span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">repo</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="p">/</span>
  <span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;yum install ceph -y&quot;</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">准备文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@admin</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">]</span><span class="c"># for i in {19..21};do scp 02_create_ceph_user.sh 03_remote_cephadm_auth.sh root@10.0.0.$i:/data/scripts; done</span>

<span class="n">准备专属用户</span>
<span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">02_create_ceph_user</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制数据目录的认证</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_remote_cephadm_auth</span><span class="p">.</span><span class="n">sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">2</span>
<span class="n">请输入需要批量远程主机认证的主机列表范围</span><span class="p">(</span><span class="n">示例</span><span class="p">:</span> <span class="p">{</span><span class="n">12</span><span class="p">..</span><span class="n">19</span><span class="p">}):</span> <span class="p">{</span><span class="n">19</span><span class="p">..</span><span class="n">21</span><span class="p">}</span>
<span class="n">开始执行免密认证操作</span><span class="p">...</span>
<span class="n">spawn</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ssh-copy-id</span> <span class="n">-i</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">cephadm</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="n">cephadm</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">同步配置文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph-deploy</span> <span class="n">config</span> <span class="n">push</span> <span class="n">kubernetes-master</span> <span class="n">kubernetes-node1</span> <span class="n">kubernetes-node2</span>
</code></pre></div>
<p>创建rbd相关的存储池</p>
<div class="highlight"><pre><span></span><code><span class="n">创建存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">kube-rbddata</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">pool</span> <span class="s1">&#39;kube-rbddata&#39;</span> <span class="n">created</span>

<span class="n">启用rbd功能</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">application</span> <span class="n">enable</span> <span class="n">kube-rbddata</span> <span class="n">rbd</span>
<span class="n">enabled</span> <span class="n">application</span> <span class="s1">&#39;rbd&#39;</span> <span class="n">on</span> <span class="n">pool</span> <span class="s1">&#39;kube-rbddata&#39;</span>

<span class="n">存储池初始化</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">init</span> <span class="n">-p</span> <span class="n">kube-rbddata</span>

<span class="n">创建存储镜像</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">create</span> <span class="n">kube-rbddata</span><span class="p">/</span><span class="n">kubeimg</span> <span class="p">-</span><span class="n">-size</span> <span class="n">2Gi</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube-rbddata</span> <span class="n">-l</span>
<span class="n">NAME</span>     <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">kubeimg</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>

<span class="n">查看镜像属性</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">info</span> <span class="n">kube-rbddata</span><span class="p">/</span><span class="n">kubeimg</span>
<span class="n">rbd</span> <span class="n">image</span> <span class="s1">&#39;kubeimg&#39;</span><span class="p">:</span>
        <span class="n">size</span> <span class="n">2</span> <span class="n">GiB</span> <span class="k">in</span> <span class="n">512</span> <span class="n">objects</span>
        <span class="p">...</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">layering</span><span class="p">,</span> <span class="n">exclusive-lock</span><span class="p">,</span> <span class="n">object-map</span><span class="p">,</span> <span class="n">fast-diff</span><span class="p">,</span> <span class="n">deep-flatten</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">有可能在k8s使用rbd的时候</span><span class="err">，</span><span class="n">提示不支持</span> <span class="n">object-map</span><span class="p">,</span> <span class="n">fast-diff</span><span class="p">,</span> <span class="n">deep-flatten</span> <span class="n">属性</span><span class="err">，</span><span class="n">那么我们到时候执行如下命令</span><span class="err">：</span>
    <span class="n">rbd</span> <span class="n">feature</span> <span class="n">disable</span> <span class="n">kube-rbddata</span><span class="p">/</span><span class="n">kubeimg</span> <span class="n">exclusive-lock</span> <span class="n">object-map</span> <span class="n">fast-diff</span> <span class="n">deep-flatten</span>
</code></pre></div>
<p>创建专属的访问存储池的用户账号</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的账号信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">k8s</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow * pool=kube-rbddata&#39;</span> <span class="n">-o</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">查看秘钥环文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.k8s]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQCAR0hj6rCdNhAAFPIDxBTzujdX3SpFDE</span><span class="p">+</span><span class="n">pOQ</span><span class="p">==</span>

<span class="n">完善秘钥环文件</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">k8s</span> <span class="n">-o</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span>
<span class="n">exported</span> <span class="n">keyring</span> <span class="k">for</span> <span class="n">client</span><span class="p">.</span><span class="n">k8s</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.k8s]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQCAR0hj6rCdNhAAFPIDxBTzujdX3SpFDE</span><span class="p">+</span><span class="n">pOQ</span><span class="p">==</span>
        <span class="n">caps</span> <span class="n">mon</span> <span class="p">=</span> <span class="s2">&quot;allow r&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">传递秘钥环文件到所有k8s节点</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">19</span><span class="p">..</span><span class="n">21</span><span class="p">}</span>
<span class="k">do</span>
  <span class="n">scp</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># rbd --user k8s -p kube-rbddata ls</span>
<span class="n">kubeimg</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># ceph --user k8s -s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
            <span class="n">application</span> <span class="n">not</span> <span class="n">enabled</span> <span class="n">on</span> <span class="n">1</span> <span class="n">pool</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="p">...</span>
</code></pre></div>
<p>ceph查看效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前ceph的pool信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># ceph --user k8s osd pool ls | grep kube</span>
<span class="n">kube-rbddata</span>

<span class="n">创建对应的镜像信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># rbd --user k8s create kube-rbddata/podimg02 --size 1G</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># rbd --user k8s ls -p kube-rbddata | grep od</span>
<span class="n">podimg01</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">待测试客户端准备镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node1</span> <span class="p">~]</span><span class="c"># docker pull redis:6.2.5</span>
</code></pre></div>
<p>定制pod测试1 </p>
<div class="highlight"><pre><span></span><code><span class="n">定制专属的pod测试资源清单文件</span> <span class="n">01-ceph-k8s-pod-test</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">redis-with-rdb-test</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeName</span><span class="p">:</span> <span class="n">kubernetes-node1</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">redis</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="n">6</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">5</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">volumeMounts</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/data&quot;</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">redis-cephrbd-vol</span>
  <span class="n">volumes</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">redis-cephrbd-vol</span>
    <span class="n">rbd</span><span class="p">:</span>
      <span class="n">monitors</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span>
      <span class="n">pool</span><span class="p">:</span> <span class="n">kube-rbddata</span>
      <span class="n">image</span><span class="p">:</span> <span class="n">kubeimg</span>
      <span class="n">fsType</span><span class="p">:</span> <span class="n">xfs</span>
      <span class="n">user</span><span class="p">:</span> <span class="n">k8s</span>
      <span class="n">keyring</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span>

<span class="n">应用资源清单文件</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">01-ceph-k8s-pod-test</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">NAME</span>                  <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>           <span class="n">NODE</span>      <span class="p">...</span>
<span class="n">redis-with-rdb-test</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">22s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span>   <span class="n">k8s-node1</span> <span class="p">...</span>

<span class="n">查看信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl describe  pod redis-with-rdb-test</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看宿主机绑定效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node1</span> <span class="p">~]</span><span class="c"># rbd showmapped</span>
<span class="n">id</span> <span class="n">pool</span>         <span class="n">namespace</span> <span class="n">image</span>   <span class="n">snap</span> <span class="n">device</span>
<span class="n">0</span>  <span class="n">kube-rbddata</span>           <span class="n">kubeimg</span> <span class="p">-</span>    <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node1</span> <span class="p">~]</span><span class="c"># mount | grep rbd</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span> <span class="n">on</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kubelet</span><span class="p">/</span><span class="n">plugins</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">mounts</span><span class="p">/</span><span class="n">kube-rbddata-image-kubeimg</span> <span class="nb">type </span><span class="n">xfs</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">attr2</span><span class="p">,</span><span class="n">inode64</span><span class="p">,</span><span class="n">sunit</span><span class="p">=</span><span class="n">8192</span><span class="p">,</span><span class="n">swidth</span><span class="p">=</span><span class="n">8192</span><span class="p">,</span><span class="n">noquota</span><span class="p">)</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span> <span class="n">on</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kubelet</span><span class="p">/</span><span class="n">pods</span><span class="p">/</span><span class="n">006fb6bd</span><span class="p">-</span><span class="n">6623</span><span class="p">-</span><span class="n">4f29</span><span class="p">-</span><span class="n">88d9</span><span class="p">-</span><span class="n">53e6f4fe5222</span><span class="p">/</span><span class="n">volumes</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">~</span><span class="n">rbd</span><span class="p">/</span><span class="n">redis-cephrbd-vol</span> <span class="nb">type </span><span class="n">xfs</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">attr2</span><span class="p">,</span><span class="n">inode64</span><span class="p">,</span><span class="n">sunit</span><span class="p">=</span><span class="n">8192</span><span class="p">,</span><span class="n">swidth</span><span class="p">=</span><span class="n">8192</span><span class="p">,</span><span class="n">noquota</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                  <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">redis-with-rdb-test</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">7m39s</span>

<span class="n">进入pod查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl  exec -it redis-with-rdb-test -- bash</span>
<span class="n">root</span><span class="nv">@redis</span><span class="n">-with-rdb-test</span><span class="p">:/</span><span class="n">data</span><span class="c"># mount | grep rbd</span>
<span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">rbd0</span> <span class="n">on</span> <span class="p">/</span><span class="n">data</span> <span class="nb">type </span><span class="n">xfs</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">attr2</span><span class="p">,</span><span class="n">inode64</span><span class="p">,</span><span class="n">sunit</span><span class="p">=</span><span class="n">8192</span><span class="p">,</span><span class="n">swidth</span><span class="p">=</span><span class="n">8192</span><span class="p">,</span><span class="n">noquota</span><span class="p">)</span>

<span class="n">redis使用rdb效果</span>
<span class="n">root</span><span class="nv">@redis</span><span class="n">-with-rdb-test</span><span class="p">:/</span><span class="n">data</span><span class="c"># ls</span>
<span class="n">lost</span><span class="p">+</span><span class="n">found</span>
<span class="n">root</span><span class="nv">@redis</span><span class="n">-with-rdb-test</span><span class="p">:/</span><span class="n">data</span><span class="c"># redis-cli</span>
<span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">6379</span><span class="p">&gt;</span> <span class="nb">set </span><span class="n">nihao</span> <span class="n">nihao</span>
<span class="n">OK</span>
<span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">6379</span><span class="p">&gt;</span> <span class="nb">set </span><span class="n">buhao</span> <span class="n">buhao</span>
<span class="n">OK</span>
<span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">6379</span><span class="p">&gt;</span> <span class="n">keys</span> <span class="p">*</span>
<span class="n">1</span><span class="p">)</span> <span class="s2">&quot;buhao&quot;</span>
<span class="n">2</span><span class="p">)</span> <span class="s2">&quot;nihao&quot;</span>
<span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">6379</span><span class="p">&gt;</span> <span class="n">BGSAVE</span>
<span class="n">Background</span> <span class="n">saving</span> <span class="n">started</span>
<span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">6379</span><span class="p">&gt;</span> <span class="n">exit</span>
<span class="n">root</span><span class="nv">@redis</span><span class="n">-with-rdb-test</span><span class="p">:/</span><span class="n">data</span><span class="c"># ls</span>
<span class="n">dump</span><span class="p">.</span><span class="n">rdb</span>  <span class="n">lost</span><span class="p">+</span><span class="n">found</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">宿主机确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node1</span> <span class="p">~]</span><span class="c"># ls /var/lib/kubelet/plugins/kubernetes.io/rbd/mounts/kube-rbddata-image-kubeimg</span>
<span class="n">dump</span><span class="p">.</span><span class="n">rdb</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">收尾动作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl  delete -f 01-ceph-k8s-pod-test.yaml</span>
<span class="n">pod</span> <span class="s2">&quot;redis-with-rdb-test&quot;</span> <span class="n">deleted</span>
</code></pre></div>
<p>定制pod实践2</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的镜像磁盘</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">create</span> <span class="n">kube-rbddata</span><span class="p">/</span><span class="n">kubeimg02</span> <span class="p">-</span><span class="n">-size</span> <span class="n">2Gi</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="n">-p</span> <span class="n">kube-rbddata</span> <span class="n">-l</span>
<span class="n">NAME</span>       <span class="n">SIZE</span>   <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">kubeimg</span>    <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>        <span class="n">excl</span>
<span class="n">kubeimg02</span>  <span class="n">2</span> <span class="n">GiB</span>            <span class="n">2</span>

<span class="n">清理磁盘格式</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">feature</span> <span class="n">disable</span> <span class="n">kube-rbddata</span><span class="p">/</span><span class="n">kubeimg02</span> <span class="n">exclusive-lock</span> <span class="n">object-map</span> <span class="n">fast-diff</span> <span class="n">deep-flatten</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看ceph的keyring的信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">keyring</span>
<span class="no">[client.k8s]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQDh47ZhqWklMRAAY</span><span class="p">+</span><span class="n">6UM0wkbSRc2DeLctQY</span><span class="p">+</span><span class="n">A</span><span class="p">==</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">client</span><span class="p">.</span><span class="n">k8s</span>
<span class="n">AQDh47ZhqWklMRAAY</span><span class="p">+</span><span class="n">6UM0wkbSRc2DeLctQY</span><span class="p">+</span><span class="n">A</span><span class="p">==</span>

<span class="n">生成对应的base64编码信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">client</span><span class="p">.</span><span class="n">k8s</span> <span class="p">|</span> <span class="n">base64</span>
<span class="n">QVFEaDQ3WmhxV2tsTVJBQVkrNlVNMHdrYlNSYzJEZUxjdFFZK0E9PQ</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制专属的pod测试资源清单文件</span> <span class="n">02-ceph-k8s-pod-secret</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">ceph-secret</span>
<span class="n">type</span><span class="p">:</span> <span class="s2">&quot;kubernetes.io/rbd&quot;</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">key</span><span class="p">:</span> <span class="n">QVFEaDQ3WmhxV2tsTVJBQVkrNlVNMHdrYlNSYzJEZUxjdFFZK0E9PQ</span><span class="p">==</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">redis-with-secret-test</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeName</span><span class="p">:</span> <span class="n">kubernetes-node1</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">redis</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="n">6</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">5</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">volumeMounts</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/data&quot;</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">redis-cephrbd-vol</span>
  <span class="n">volumes</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">redis-cephrbd-vol</span>
    <span class="n">rbd</span><span class="p">:</span>
      <span class="n">monitors</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span>
      <span class="n">pool</span><span class="p">:</span> <span class="n">kube-rbddata</span>
      <span class="n">image</span><span class="p">:</span> <span class="n">kubeimg02</span>
      <span class="n">fsType</span><span class="p">:</span> <span class="n">xfs</span>
      <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">user</span><span class="p">:</span> <span class="n">k8s</span>
      <span class="n">secretRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">ceph-secret</span>

<span class="n">应用资源清单文件</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">02-ceph-k8s-pod-secret</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl  get pod -o wide</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>           <span class="n">NODE</span>      <span class="p">...</span>
<span class="n">redis-with-secret-test</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">13s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">3</span>   <span class="n">k8s-node2</span> <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">收尾动作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl delete -f 02-ceph-k8s-pod-secret.yaml</span>
<span class="n">secret</span> <span class="s2">&quot;ceph-secret&quot;</span> <span class="n">deleted</span>
<span class="n">pod</span> <span class="s2">&quot;redis-with-secret-test&quot;</span> <span class="n">deleted</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="156_cephfs">1.5.6 CephFS实践<a class="headerlink" href="#156_cephfs" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>需求</p>
<div class="highlight"><pre><span></span><code><span class="n">k8s对ceph</span> <span class="n">rbd模式不支持ReadWriteMany</span><span class="err">（</span><span class="n">RWX</span><span class="err">）</span><span class="p">,</span><span class="n">为了满足k8s的灵活性需求</span><span class="p">,</span><span class="n">采用支持多点挂载的cephfs工作模式</span>
</code></pre></div>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">检查cephfs环境</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span>  <span class="n">fs</span>  <span class="nb">ls</span>
<span class="n">name</span><span class="p">:</span> <span class="n">cephfs</span><span class="p">,</span> <span class="n">metadata</span> <span class="n">pool</span><span class="p">:</span> <span class="n">cephfs-metadata</span><span class="p">,</span> <span class="n">data</span> <span class="n">pools</span><span class="p">:</span> <span class="p">[</span><span class="n">cephfs-data</span> <span class="p">]</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">-s</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">mds</span>
    <span class="n">mds</span><span class="p">:</span> <span class="n">cephfs</span><span class="p">:</span><span class="n">1</span> <span class="p">{</span><span class="n">0</span><span class="p">=</span><span class="n">stor05</span><span class="p">=</span><span class="n">up</span><span class="p">:</span><span class="n">active</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">保存用户账号的密钥信息于secret文件</span><span class="err">，</span><span class="n">用于客户端挂载操作认证之用</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">print-key</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span> <span class="p">&gt;</span> <span class="n">fsclient</span><span class="p">.</span><span class="n">key</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">ceph-cluster</span><span class="p">]$</span> <span class="nb">cat </span><span class="n">fsclient</span><span class="p">.</span><span class="n">key</span>
<span class="n">AQBgdTJj</span><span class="p">+</span><span class="n">LVdFBAAZOjGIsw4t</span><span class="p">+</span><span class="n">o1swZlW4CvKQ</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">将秘钥文件传递给所有的k8s节点主机</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">{</span><span class="n">19</span><span class="p">..</span><span class="n">21</span><span class="p">}</span>
<span class="k">do</span>
  <span class="n">scp</span> <span class="n">fsclient</span><span class="p">.</span><span class="n">key</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的数据目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node2</span> <span class="p">~]</span><span class="c"># mkdir /cephfs-data/</span>

<span class="n">挂载cephFS对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node2</span> <span class="p">~]</span><span class="c"># mount -t ceph 10.0.0.13:6789,10.0.0.14:6789,10.0.0.15:6789:/ /cephfs-data/ -o name=fsclient,secretfile=/etc/ceph/fsclient.key</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">内核空间挂载ceph文件系统</span><span class="err">，</span><span class="n">要求必须指定ceph文件系统的挂载路径</span>

<span class="n">确认挂载效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node2</span> <span class="p">~]</span><span class="c"># mount | grep cephfs</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">:/</span> <span class="n">on</span> <span class="p">/</span><span class="n">cephfs-data</span> <span class="nb">type </span><span class="n">ceph</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">name</span><span class="p">=</span><span class="n">fsclient</span><span class="p">,</span><span class="n">secret</span><span class="p">=&lt;</span><span class="n">hidden</span><span class="p">&gt;,</span><span class="n">acl</span><span class="p">,</span><span class="n">wsize</span><span class="p">=</span><span class="n">16777216</span><span class="p">)</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>创建资源清单文件</p>
<div class="highlight"><pre><span></span><code><span class="n">获取秘钥信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># cat /etc/ceph/fsclient.key</span>
<span class="n">AQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ</span><span class="p">==</span>

<span class="n">生成专属的秘钥信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># echo -n &#39;AQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ==&#39; | base64</span>
<span class="n">QVFEWUNVcGptTGpVRHhBQVlrZk5HVUc1RlVZYUZWRTZqbEZnclE9PQ</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建secret资源清单文件</span> <span class="n">03-cephfs-k8s-test</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">ceph-secret</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">key</span><span class="p">:</span> <span class="n">QVFEWUNVcGptTGpVRHhBQVlrZk5HVUc1RlVZYUZWRTZqbEZnclE9PQ</span><span class="p">==</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolume</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">cephfs-pv</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">cephfs-pv</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">capacity</span><span class="p">:</span>
    <span class="n">storage</span><span class="p">:</span> <span class="n">1Gi</span>
  <span class="n">accessModes</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">ReadWriteMany</span>
  <span class="n">cephfs</span><span class="p">:</span>
    <span class="n">monitors</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span>
      <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">fsclient</span>
    <span class="n">secretRef</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">ceph-secret</span>
    <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="n">Delete</span>
<span class="p">---</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolumeClaim</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">cephfs-pvc</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">accessModes</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">ReadWriteMany</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="n">1Gi</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">cephfs-pv</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制资源清单</span> <span class="n">04-cephfs-k8s-pod-redis</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-redis</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeName</span><span class="p">:</span> <span class="n">kubernetes-node1</span>
  <span class="n">volumes</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">redis-cephfs-vol</span>
      <span class="n">persistentVolumeClaim</span><span class="p">:</span>
        <span class="n">claimName</span><span class="p">:</span> <span class="n">cephfs-pvc</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">redis</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">redis</span><span class="p">:</span><span class="n">6</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">5</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">volumeMounts</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/data&quot;</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">redis-cephfs-vol</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">应用资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl  apply -f 03-cephfs-k8s-test.yaml -f 04-cephfs-k8s-pod-redis.yaml</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl describe pod superopsmsb-redis</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">客户端确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node1</span> <span class="p">~]</span><span class="c"># mount | grep ceph</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">:/</span> <span class="n">on</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kubelet</span><span class="p">/</span><span class="n">pods</span><span class="p">/</span><span class="n">41a1af23-da66</span><span class="p">-</span><span class="n">486c-b80d-a2e084f75edc</span><span class="p">/</span><span class="n">volumes</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">~</span><span class="n">cephfs</span><span class="p">/</span><span class="n">cephfs-pv</span> <span class="nb">type </span><span class="n">ceph</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">name</span><span class="p">=</span><span class="n">fsclient</span><span class="p">,</span><span class="n">secret</span><span class="p">=&lt;</span><span class="n">hidden</span><span class="p">&gt;,</span><span class="n">acl</span><span class="p">,</span><span class="n">wsize</span><span class="p">=</span><span class="n">16777216</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">收尾操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph</span><span class="p">]</span><span class="c"># kubectl  delete -f 04-cephfs-k8s-pod-redis.yaml -f 03-cephfs-k8s-test.yaml</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="157_sc">1.5.7 SC基础<a class="headerlink" href="#157_sc" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>需求</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于手工方式为应用提供指定的存储能力是可行的</span><span class="err">，</span><span class="n">但是在k8s动态变化的场景中</span><span class="err">，</span><span class="n">尤其是面对无状态的集群服务</span><span class="err">，</span><span class="n">如何自由的提供存储能力</span><span class="err">，</span><span class="n">是想当要考量的一个话题</span><span class="err">，</span><span class="n">对于这种场景</span><span class="err">，</span><span class="n">我们可以在SC的基础上</span><span class="err">，</span><span class="n">实现动态的为应用服务提供存储能力</span><span class="err">。</span>
</code></pre></div>
<p>ceph-csi</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph-csi扩展各种存储类型的卷的管理能力</span><span class="err">，</span><span class="n">实现第三方存储ceph的各种操作能力与k8s存储系统的结合</span><span class="err">。</span><span class="n">调用第三方存储ceph的接口或命令</span><span class="err">，</span><span class="n">从而提供ceph数据卷的创建</span><span class="p">/</span><span class="n">删除</span><span class="err">、</span><span class="n">挂载</span><span class="p">/</span><span class="n">解除挂载的具体操作实现</span><span class="err">。</span><span class="n">前面分析组件中的对于数据卷的创建</span><span class="p">/</span><span class="n">删除</span><span class="err">、</span><span class="n">挂载</span><span class="p">/</span><span class="n">解除挂载操作</span><span class="err">，</span><span class="n">全是调用ceph-csi</span><span class="err">，</span><span class="n">然后由ceph-csi调用ceph提供的命令或接口来完成最终的操作</span><span class="err">。</span>
    <span class="n">自从kubernetes</span> <span class="n">1</span><span class="p">.</span><span class="n">13版本之后</span><span class="err">，</span><span class="n">ceph-csi为k8s环境动态地提供相关的存储能力</span><span class="err">。</span>
</code></pre></div>
<p>版本支持</p>
<table>
<thead>
<tr>
<th>Ceph CSI Version</th>
<th>Container Orchestrator Name</th>
<th>Version Tested</th>
</tr>
</thead>
<tbody>
<tr>
<td>v3.7.1</td>
<td>Kubernetes</td>
<td>v1.22, v1.23, v1.24</td>
</tr>
<tr>
<td>v3.7.0</td>
<td>Kubernetes</td>
<td>v1.22, v1.23, v1.24</td>
</tr>
<tr>
<td>v3.6.1</td>
<td>Kubernetes</td>
<td>v1.21, v1.22, v1.23</td>
</tr>
<tr>
<td>v3.6.0</td>
<td>Kubernetes</td>
<td>v1.21, v1.22, v1.23</td>
</tr>
</tbody>
</table>
<p><strong>简单实践</strong></p>
<p>组件功能</p>
<div class="highlight"><pre><span></span><code><span class="n">创建</span> <span class="n">pvc</span><span class="p">:</span>
    <span class="n">external-provisioner组件监听到pvc创建事件后</span><span class="err">，</span><span class="n">负责拼接请求</span><span class="err">，</span><span class="n">然后调用ceph-csi的CreateVolume方法来创建存储</span><span class="err">；</span>
<span class="n">删除</span> <span class="n">pvc</span><span class="p">:</span>
    <span class="n">pv对象状态由bound变为release</span><span class="err">，</span><span class="n">external-provisioner监听到pv更新事件后</span><span class="err">，</span><span class="n">负责调用ceph-csi的DeleteVolume方法来删除存储</span><span class="err">。</span>

<span class="n">pod关联pvc</span><span class="p">:</span>
    <span class="n">kubelet会调用ceph-csi组件将创建好的存储从ceph集群挂载到pod所在的node上</span><span class="err">，</span><span class="n">然后再挂载到pod相应的目录上</span><span class="err">；</span>

<span class="n">pod断开pvc</span><span class="p">:</span>
    <span class="n">kubelet会调用ceph-csi组件相应方法</span><span class="err">，</span><span class="n">解除存储在pod目录上的挂载</span><span class="err">，</span><span class="n">再解除存储在node上的挂载</span><span class="err">。</span>
</code></pre></div>
<p>服务组成</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph-csi含有rbdType</span><span class="err">、</span><span class="n">cephfsType</span><span class="err">、</span><span class="n">livenessType三大类型服务</span><span class="p">,</span><span class="n">它们可以通过启动参数指定一种服务来进行启动</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">rbdType主要进行rbd的操作完成与ceph的交互</span>
    <span class="p">-</span> <span class="n">cephfsType主要进行cephfs的操作完成与ceph交互</span>
    <span class="p">-</span> <span class="n">livenessType该服务主要是定时向csi</span> <span class="n">endpoint探测csi组件的存活</span><span class="err">，</span><span class="n">然后统计到prometheus指标中</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">rbdType</span><span class="err">、</span><span class="n">cephfsType类型的服务可以细分为如下三个子服务</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">ControllerServer</span><span class="err">：</span><span class="n">主要负责创建</span><span class="err">、</span><span class="n">删除cephfs</span><span class="p">/</span><span class="n">rbd存储等操作</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">NodeServer</span><span class="err">：</span><span class="n">部署在k8s中的每个node上</span><span class="err">，</span><span class="n">主要负责cephfs</span><span class="err">、</span><span class="n">rbd在node节点上相关的操作</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">IdentityServer</span><span class="err">：</span><span class="n">主要是返回自身服务的相关信息</span><span class="err">，</span><span class="n">如返回服务身份信息</span><span class="err">、</span><span class="n">服务能力</span><span class="err">、</span><span class="n">暴露存活探测接口等</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">其中NodeServer与ControllerServer只能选其一进行启动</span>
    <span class="n">IdentityServer会伴随着NodeServer或ControllerServer的启动而启动</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20221015174850734" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221015174850734.png" /></p>
<p>应用组件</p>
<div class="highlight"><pre><span></span><code>    <span class="n">ceph-csi</span> <span class="n">在部署的时候</span><span class="err">，</span><span class="n">主要涉及到以下组件</span>
<span class="n">external-provisioner</span><span class="err">（</span><span class="n">csi-provisioner</span><span class="err">）：</span>
    <span class="p">-</span> <span class="n">创建provision环境</span><span class="err">，</span><span class="n">然后负责监听pvc是否需要动态创建和删除存储卷</span>

<span class="n">external-attacher</span><span class="err">（</span><span class="n">csi-attacher</span><span class="err">）：</span>
    <span class="p">-</span> <span class="n">负责获取PV的所有信息</span><span class="err">，</span><span class="n">然后判断是否调用CSI</span> <span class="n">Plugin的ControllerPublish做attach</span><span class="err">，</span><span class="n">还是调用CntrollerUnpublish接口做detach</span>

<span class="n">external-snapshotter</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">对镜像文件进行快照相关操作</span><span class="err">，</span><span class="n">同时负责判断PVC中是否调整需求的存储容量空间大小</span>

<span class="n">node-driver-registrar</span>
    <span class="n">调用CSI</span> <span class="n">Plugin的接口获取插件信息</span><span class="err">，</span><span class="n">通过Kubelet的插件注册机制将CSI</span> <span class="n">Plugin注册到kubelet</span>

<span class="n">livenessprobe</span>
    <span class="n">调用CSI</span> <span class="n">Plugin的Probe接口</span><span class="err">，</span><span class="n">同时在</span><span class="p">/</span><span class="n">healthz暴露HTTP健康检查探针</span>
</code></pre></div>
<p><img alt="image-20221015175059810" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221015175059810.png" /></p>
<p>部署解读</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于ceph-csi环境的部署来说</span><span class="err">，</span><span class="n">主要涉及到两个文件</span><span class="err">：</span>
    <span class="n">csi-xxxplugin-provisioner</span><span class="p">.</span><span class="n">yaml部署的相关组件</span><span class="err">：</span>
        <span class="n">csi-provisioner</span>  <span class="n">核心sc服务能力</span><span class="err">，</span><span class="n">负责根据pvc来管理pv对象</span><span class="err">，</span><span class="n">动态的管理ceph中的image</span>
        <span class="n">csi-snapshotter</span>  <span class="n">负责处理存储快照相关的操作</span>
        <span class="n">csi-attacher</span>     <span class="n">负责操作VolumeAttachment对象</span><span class="err">，</span><span class="n">并没有操作存储</span><span class="err">。</span>
        <span class="n">csi-resizer</span>      <span class="n">负责处理存储扩容相关的操作</span>
        <span class="n">csi-xxxplugin</span>    <span class="n">核心的ceph-csi组件</span><span class="err">，</span><span class="n">负责与kubernetes对接存储相关的操作</span>
        <span class="n">liveness-prometheus</span> <span class="n">负责探测并上报csi-rbdplugin服务的存活情况</span>
    <span class="n">csi-xxxplugin</span><span class="p">.</span><span class="n">yaml部署的相关组件</span><span class="err">：</span>
        <span class="n">driver-registrar</span> <span class="n">向kubelet传入csi-xxxplugin容器提供服务的socket地址等信息</span><span class="err">。</span>
        <span class="n">csi-xxxplugin</span>    <span class="n">负责与kubernetes对接存储相关的操作</span>
        <span class="n">liveness-prometheus</span>  <span class="n">负责探测并上报csi-xxxplugin服务的存活情况</span>    
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">xxx</span> <span class="n">主要有两类</span><span class="err">：</span><span class="n">rdb和cephfs</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="158_sc-rbd">1.5.8 SC-rbd实践<a class="headerlink" href="#158_sc-rbd" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础环境、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">en</span><span class="p">/</span><span class="n">quincy</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">rbd-kubernetes</span><span class="p">/</span>
</code></pre></div>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">获取代码环境</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">ceph</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">.</span><span class="n">git</span>
<span class="nb">cd </span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取基本状态信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mon</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">3</span>
<span class="n">fsid</span> <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
<span class="n">last_changed</span> <span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">30</span> <span class="n">23</span><span class="p">:</span><span class="n">25</span><span class="p">:</span><span class="n">47</span><span class="p">.</span><span class="n">516433</span>
<span class="n">created</span> <span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">30</span> <span class="n">19</span><span class="p">:</span><span class="n">05</span><span class="p">:</span><span class="n">03</span><span class="p">.</span><span class="n">907227</span>
<span class="n">min_mon_release</span> <span class="n">14</span> <span class="p">(</span><span class="n">nautilus</span><span class="p">)</span>
<span class="n">0</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon01</span>
<span class="n">1</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon02</span>
<span class="n">2</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon03</span>
<span class="n">这里重点关注</span><span class="err">：</span>
    <span class="n">fsid-ceph集群的id</span> <span class="n">和</span> <span class="n">mon节点的列表</span>
</code></pre></div>
<p>部署rbd环境</p>
<div class="highlight"><pre><span></span><code><span class="n">修改核心配置文件</span> <span class="n">csi-config-map</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;ceph-csi-config&quot;</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">config</span><span class="p">.</span><span class="n">json</span><span class="p">:</span> <span class="p">|-</span>
    <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;clusterID&quot;</span><span class="p">:</span> <span class="s2">&quot;d932ded6-3765-47c1-b0dc-e6957051e31a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;monitors&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;10.0.0.13:6789&quot;</span><span class="p">,</span>
          <span class="s2">&quot;10.0.0.14:6789&quot;</span><span class="p">,</span>
          <span class="s2">&quot;10.0.0.15:6789&quot;</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">修改</span> <span class="n">clusterID</span> <span class="n">和</span> <span class="n">monitors</span> <span class="n">部分内容</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建依赖的configmap文件</span>
<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;</span> <span class="n">ceph-config-map</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">config</span><span class="p">.</span><span class="n">json</span><span class="p">:</span> <span class="p">|-</span>
    <span class="p">{}</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">ceph-csi-encryption-kms-config</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span><span class="p">:</span> <span class="p">|</span>
    <span class="no">[global]</span>
    <span class="n">auth_cluster_required</span> <span class="p">=</span> <span class="n">cephx</span>
    <span class="n">auth_service_required</span> <span class="p">=</span> <span class="n">cephx</span>
    <span class="n">auth_client_required</span> <span class="p">=</span> <span class="n">cephx</span>
  <span class="n">keyring</span><span class="p">:</span> <span class="p">|</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">ceph-config</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改部署资源清单文件</span> <span class="n">csi-rbdplugin-provisioner</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">...</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">csi-rbdplugin-provisioner</span>
  <span class="c"># replace with non-default namespace name</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>   <span class="c"># 将3修改为2</span>
  <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">部署资源清单文件</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi-config-map</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">ceph-config-map</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csidriver</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi-provisioner-rbac</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi-nodeplugin-rbac</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi-rbdplugin-provisioner</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi-rbdplugin</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">csidriver</span><span class="p">.</span><span class="n">yaml</span> <span class="n">对于pod挂载pvc是非常重要的</span><span class="err">，</span><span class="n">如果不执行会导致挂载失败</span>
</code></pre></div>
<p>确认效果</p>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">]</span><span class="c"># kubectl  get pod</span>
<span class="n">NAME</span>                                         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">csi-rbdplugin</span><span class="p">-</span><span class="n">8xq6m</span>                          <span class="n">3</span><span class="p">/</span><span class="n">3</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">53s</span>
<span class="n">csi-rbdplugin-nbf8g</span>                          <span class="n">3</span><span class="p">/</span><span class="n">3</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">53s</span>
<span class="n">csi-rbdplugin-provisioner</span><span class="p">-</span><span class="n">8599998d64</span><span class="p">-</span><span class="n">77zqd</span>   <span class="n">7</span><span class="p">/</span><span class="n">7</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">54s</span>
<span class="n">csi-rbdplugin-provisioner</span><span class="p">-</span><span class="n">8599998d64-p48wm</span>   <span class="n">7</span><span class="p">/</span><span class="n">7</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">54s</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>ceph环境准备</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的存储池</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">kubernetes</span> <span class="n">64</span>
<span class="n">pool</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="n">created</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="n">pool</span> <span class="n">init</span> <span class="n">kubernetes</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的用户</span> <span class="p">--</span> <span class="n">可选</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">kubernetes</span> <span class="n">mon</span> <span class="s1">&#39;profile rbd&#39;</span> <span class="n">osd</span> <span class="s1">&#39;profile rbd pool=kubernetes&#39;</span> <span class="n">mgr</span> <span class="s1">&#39;profile rbd pool=kubernetes&#39;</span>
<span class="no">[client.kubernetes]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQA7VUpjyHt</span><span class="p">/</span><span class="n">OxAAh1GTn8eWEWBmW2lJ61NmjQ</span><span class="p">==</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">我们这里以admin用户为例</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="n">get</span> <span class="n">client</span><span class="p">.</span><span class="n">admin</span>
<span class="no">[client.admin]</span>
        <span class="n">key</span> <span class="p">=</span> <span class="n">AQByzTZjaEaCCRAAolAFknx1x</span><span class="p">/</span><span class="n">LgTYhNyy50cw</span><span class="p">==</span>
        <span class="p">...</span>
</code></pre></div>
<p>应用测试</p>
<div class="highlight"><pre><span></span><code><span class="n">进入专属测试文件目录</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改secret文件</span>  <span class="n">secret</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">...</span>
<span class="n">stringData</span><span class="p">:</span>
  <span class="n">userID</span><span class="p">:</span> <span class="n">admin</span>
  <span class="n">userKey</span><span class="p">:</span> <span class="n">AQByzTZjaEaCCRAAolAFknx1x</span><span class="p">/</span><span class="n">LgTYhNyy50cw</span><span class="p">==</span>
<span class="p">...</span>
<span class="n">修改</span><span class="err">：</span>
    <span class="n">根据提示信息修改</span> <span class="n">userID</span> <span class="n">和</span> <span class="n">userKey</span> <span class="n">的信息</span>
    <span class="n">这里的userKey无需进行base64加密</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改SC配置</span> <span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">...</span>
<span class="n">parameters</span><span class="p">:</span>
<span class="p">...</span>
  <span class="n">clusterID</span><span class="p">:</span> <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
  <span class="p">...</span>
  <span class="n">pool</span><span class="p">:</span> <span class="n">kubernetes</span>
  <span class="p">...</span>
<span class="n">修改</span><span class="err">：</span>
    <span class="n">根据提示信息修改</span> <span class="n">clusterID</span> <span class="n">和</span> <span class="n">pool</span> <span class="n">的信息</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用资源清单文件</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">secret</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">pvc</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">pod</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">确定pvc和pv的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span><span class="p">]</span><span class="c"># kubectl  get  pvc</span>
<span class="n">NAME</span>      <span class="n">STATUS</span>   <span class="n">VOLUME</span>                                     <span class="n">CAPACITY</span>   <span class="p">...</span>
<span class="n">rbd-pvc</span>   <span class="n">Bound</span>    <span class="n">pvc</span><span class="p">-</span><span class="n">441dbf43</span><span class="p">-</span><span class="n">5051</span><span class="p">-</span><span class="n">4130-b8d7-a539e5395ba1</span>   <span class="n">1Gi</span>        <span class="p">...</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span><span class="p">]</span><span class="c"># kubectl  get  pv</span>
<span class="n">NAME</span>                                       <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="p">...</span>
<span class="n">pvc</span><span class="p">-</span><span class="n">441dbf43</span><span class="p">-</span><span class="n">5051</span><span class="p">-</span><span class="n">4130-b8d7-a539e5395ba1</span>   <span class="n">1Gi</span>        <span class="n">RWO</span>            <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确定pod效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span><span class="p">]</span><span class="c"># kubectl  describe pod csi-rbd-demo-pod  | grep -A3 Volumes:</span>
<span class="n">Volumes</span><span class="p">:</span>
  <span class="n">mypvc</span><span class="p">:</span>
    <span class="n">Type</span><span class="p">:</span>       <span class="n">PersistentVolumeClaim</span> <span class="p">(</span><span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">a</span> <span class="n">PersistentVolumeClaim</span> <span class="k">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="n">ClaimName</span><span class="p">:</span>  <span class="n">rbd-pvc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ceph环境中确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kubernetes</span> <span class="n">-l</span>
<span class="n">NAME</span>                                         <span class="n">SIZE</span>  <span class="n">PARENT</span> <span class="n">FMT</span> <span class="n">PROT</span> <span class="n">LOCK</span>
<span class="n">csi-vol</span><span class="p">-</span><span class="n">0a8bcde0-ddd0</span><span class="p">-</span><span class="n">4ca8-a194</span><span class="p">-</span><span class="n">70bf61aaf691</span> <span class="n">1</span> <span class="n">GiB</span>          <span class="n">2</span>
</code></pre></div>
<p>移除应用</p>
<div class="highlight"><pre><span></span><code><span class="n">移除应用</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="n">pod</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="n">pvc</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">ceph环境中确认效果</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">rbd</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-pool</span> <span class="n">kubernetes</span> <span class="n">-l</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span>
</code></pre></div>
<p>环境收尾</p>
<div class="highlight"><pre><span></span><code><span class="n">清理应用环境</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span> <span class="o">-f</span> <span class="n">secret</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">清理sc环境</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="p">./</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">清理ceph环境</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">kubernetes</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">ceph</span> <span class="n">auth</span> <span class="nb">rm </span><span class="n">client</span><span class="p">.</span><span class="n">kubernetes</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="159_sc-cephfs">1.5.9 SC-cephfs实践<a class="headerlink" href="#159_sc-cephfs" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础环境、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">获取代码环境</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">cephfs</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取基本状态信息</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">mon</span> <span class="n">dump</span>
<span class="n">epoch</span> <span class="n">3</span>
<span class="n">fsid</span> <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
<span class="n">last_changed</span> <span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">30</span> <span class="n">23</span><span class="p">:</span><span class="n">25</span><span class="p">:</span><span class="n">47</span><span class="p">.</span><span class="n">516433</span>
<span class="n">created</span> <span class="n">2062</span><span class="p">-</span><span class="n">09</span><span class="p">-</span><span class="n">30</span> <span class="n">19</span><span class="p">:</span><span class="n">05</span><span class="p">:</span><span class="n">03</span><span class="p">.</span><span class="n">907227</span>
<span class="n">min_mon_release</span> <span class="n">14</span> <span class="p">(</span><span class="n">nautilus</span><span class="p">)</span>
<span class="n">0</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon01</span>
<span class="n">1</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon02</span>
<span class="n">2</span><span class="p">:</span> <span class="p">[</span><span class="n">v2</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">3300</span><span class="p">/</span><span class="n">0</span><span class="p">,</span><span class="n">v1</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">/</span><span class="n">0</span><span class="p">]</span> <span class="n">mon</span><span class="p">.</span><span class="n">mon03</span>
<span class="n">这里重点关注</span><span class="err">：</span>
    <span class="n">fsid-ceph集群的id</span> <span class="n">和</span> <span class="n">mon节点的列表</span>
</code></pre></div>
<p>部署rbd环境</p>
<div class="highlight"><pre><span></span><code><span class="n">修改核心配置文件</span> <span class="n">csi-config-map</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;ceph-csi-config&quot;</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">config</span><span class="p">.</span><span class="n">json</span><span class="p">:</span> <span class="p">|-</span>
    <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;clusterID&quot;</span><span class="p">:</span> <span class="s2">&quot;d932ded6-3765-47c1-b0dc-e6957051e31a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;monitors&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;10.0.0.13:6789&quot;</span><span class="p">,</span>
          <span class="s2">&quot;10.0.0.14:6789&quot;</span><span class="p">,</span>
          <span class="s2">&quot;10.0.0.15:6789&quot;</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">修改</span> <span class="n">clusterID</span> <span class="n">和</span> <span class="n">monitors</span> <span class="n">部分内容</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建依赖的configmap文件</span>
<span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;</span> <span class="n">ceph-config-map</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">ceph</span><span class="p">.</span><span class="n">conf</span><span class="p">:</span> <span class="p">|</span>
    <span class="no">[global]</span>
    <span class="n">auth_cluster_required</span> <span class="p">=</span> <span class="n">cephx</span>
    <span class="n">auth_service_required</span> <span class="p">=</span> <span class="n">cephx</span>
    <span class="n">auth_client_required</span> <span class="p">=</span> <span class="n">cephx</span>
  <span class="n">keyring</span><span class="p">:</span> <span class="p">|</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">ceph-config</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改部署资源清单文件</span> <span class="n">csi-cephfsplugin-provisioner</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">...</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">csi-cephfsplugin-provisioner</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">csi-cephfsplugin-provisioner</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>   <span class="c"># 将3修改为2</span>
  <span class="p">...</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">csi-provisioner</span>
          <span class="p">...</span>
            <span class="p">-</span> <span class="s2">&quot;--extra-create-metadata=false&quot;</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">csi-snapshotter</span>
          <span class="p">...</span>
            <span class="p">-</span> <span class="s2">&quot;--extra-create-metadata=false&quot;</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">一定要将</span> <span class="p">-</span><span class="n">-extra-create-metadata</span> <span class="n">的值设为</span> <span class="n">false</span><span class="err">，</span><span class="n">否则后续对于subvolume要求较高</span><span class="err">，</span><span class="n">报错信息</span><span class="err">：</span>
        <span class="n">API</span> <span class="n">call</span> <span class="n">not</span> <span class="n">implemented</span> <span class="n">server-side</span><span class="p">:</span> <span class="n">No</span> <span class="n">handler</span> <span class="n">found</span> <span class="k">for</span> <span class="s1">&#39;fs subvolume metadata set&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">部署资源清单文件</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="p">./</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">csidriver</span><span class="p">.</span><span class="n">yaml</span> <span class="n">对于pod挂载pvc是非常重要的</span><span class="err">，</span><span class="n">如果不执行会导致挂载失败</span>    
</code></pre></div>
<p>确认效果</p>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">cephfs</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">]</span><span class="c"># kubectl  get pod</span>
<span class="n">NAME</span>                                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">csi-cephfsplugin-dtdsn</span>                          <span class="n">3</span><span class="p">/</span><span class="n">3</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">27s</span>
<span class="n">csi-cephfsplugin-provisioner</span><span class="p">-</span><span class="n">65d8546b95-k2rzt</span>   <span class="n">5</span><span class="p">/</span><span class="n">5</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">27s</span>
<span class="n">csi-cephfsplugin-provisioner</span><span class="p">-</span><span class="n">65d8546b95-zwhws</span>   <span class="n">5</span><span class="p">/</span><span class="n">5</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">26s</span>
<span class="n">csi-cephfsplugin-sd9rk</span>                          <span class="n">3</span><span class="p">/</span><span class="n">3</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">27s</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>ceph环境准备</p>
<div class="highlight"><pre><span></span><code><span class="n">如果没有cephfs环境的话</span><span class="err">，</span><span class="n">执行如下命令</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">cephfs-data</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">cephfs-metadata</span> <span class="n">16</span> <span class="n">16</span>
<span class="n">ceph</span> <span class="n">fs</span> <span class="n">new</span> <span class="n">cephfs</span> <span class="n">cephfs-metadata</span> <span class="n">cephfs-data</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确认当前的cephfs环境</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">fs</span> <span class="nb">ls</span>
<span class="n">name</span><span class="p">:</span> <span class="n">cephfs</span><span class="p">,</span> <span class="n">metadata</span> <span class="n">pool</span><span class="p">:</span> <span class="n">cephfs-metadata</span><span class="p">,</span> <span class="n">data</span> <span class="n">pools</span><span class="p">:</span> <span class="p">[</span><span class="n">cephfs-data</span> <span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建专属的用户</span> <span class="p">--</span> <span class="n">可选</span>
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-or</span><span class="n">-create</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span> <span class="n">mon</span> <span class="s1">&#39;allow r&#39;</span> <span class="n">mds</span> <span class="s1">&#39;allow rw&#39;</span> <span class="n">osd</span> <span class="s1">&#39;allow rwx pool=cephfs-data&#39;</span> <span class="n">-o</span> <span class="n">ceph</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">fsclient</span><span class="p">.</span><span class="n">keyring</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">我们这里以admin</span> <span class="n">和</span> <span class="n">fsclient用户为例</span> 
<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-key</span> <span class="n">client</span><span class="p">.</span><span class="n">fsclient</span>
<span class="n">AQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ</span><span class="p">==</span>

<span class="p">[</span><span class="n">cephadm</span><span class="nv">@admin</span> <span class="n">cephadm-cluster</span><span class="p">]$</span> <span class="n">ceph</span> <span class="n">auth</span> <span class="nb">get-key</span> <span class="n">client</span><span class="p">.</span><span class="n">admin</span>
<span class="n">AQByzTZjaEaCCRAAolAFknx1x</span><span class="p">/</span><span class="n">LgTYhNyy50cw</span><span class="p">==</span>
</code></pre></div>
<p>应用测试</p>
<div class="highlight"><pre><span></span><code><span class="n">进入专属测试文件目录</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">cephfs</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改secret文件</span>  <span class="n">secret</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">...</span>
<span class="n">stringData</span><span class="p">:</span>
  <span class="c"># Required for statically provisioned volumes</span>
  <span class="n">userID</span><span class="p">:</span> <span class="n">fsclient</span>
  <span class="n">userKey</span><span class="p">:</span> <span class="n">AQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ</span><span class="p">==</span>

  <span class="c"># Required for dynamically provisioned volumes</span>
  <span class="n">adminID</span><span class="p">:</span> <span class="n">admin</span>
  <span class="n">adminKey</span><span class="p">:</span> <span class="n">AQByzTZjaEaCCRAAolAFknx1x</span><span class="p">/</span><span class="n">LgTYhNyy50cw</span><span class="p">==</span>
<span class="p">...</span>
<span class="n">修改</span><span class="err">：</span>
    <span class="n">根据提示信息修改</span> <span class="n">userID</span> <span class="n">和</span> <span class="n">userKey</span> <span class="n">的信息</span>
    <span class="n">这里的userKey无需进行base64加密</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改SC配置</span> <span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span>
<span class="p">...</span>
<span class="n">parameters</span><span class="p">:</span>
<span class="p">...</span>
  <span class="n">clusterID</span><span class="p">:</span> <span class="n">d932ded6</span><span class="p">-</span><span class="n">3765</span><span class="p">-</span><span class="n">47c1-b0dc-e6957051e31a</span>
  <span class="p">...</span>
  <span class="n">fsName</span><span class="p">:</span> <span class="n">cephfs</span>
  <span class="c"># (optional) Ceph pool into which volume data shall be stored</span>
  <span class="n">pool</span><span class="p">:</span> <span class="n">cephfs-data</span>
  <span class="p">...</span>
  <span class="n">mounter</span><span class="p">:</span> <span class="n">kernel</span>
  <span class="p">...</span>
<span class="n">mountOptions</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">discard</span>
<span class="n">修改</span><span class="err">：</span>
    <span class="n">根据提示信息修改</span> <span class="n">clusterID</span><span class="err">、</span><span class="n">fsName</span><span class="err">、</span><span class="n">pool</span><span class="err">、</span><span class="n">mounter</span> <span class="n">的信息</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用资源清单文件</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">secret</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">pvc</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">pod</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">确定pvc和pv的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">cephfs</span><span class="p">]</span><span class="c"># kubectl  get  pvc</span>
<span class="n">NAME</span>             <span class="n">STATUS</span>   <span class="n">VOLUME</span>                                     <span class="n">CAPACITY</span>   <span class="p">...</span>
<span class="n">csi-cephfs-pvc</span>   <span class="n">Bound</span>    <span class="n">pvc</span><span class="p">-</span><span class="n">6868b7d4</span><span class="p">-</span><span class="n">5daa</span><span class="p">-</span><span class="n">4c56-ba38</span><span class="p">-</span><span class="n">02334bc7a3aa</span>   <span class="n">1Gi</span>        <span class="p">...</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">cephfs</span><span class="p">]</span><span class="c"># kubectl  get  pv</span>
<span class="n">NAME</span>                                       <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="p">...</span>
<span class="n">pvc</span><span class="p">-</span><span class="n">6868b7d4</span><span class="p">-</span><span class="n">5daa</span><span class="p">-</span><span class="n">4c56-ba38</span><span class="p">-</span><span class="n">02334bc7a3aa</span>   <span class="n">1Gi</span>        <span class="n">RWX</span>            <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确定pod效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span><span class="p">]</span><span class="c"># kubectl  describe pod csi-cephfs-demo-pod  | grep -A3 Volumes:</span>
<span class="n">Volumes</span><span class="p">:</span>
  <span class="n">mypvc</span><span class="p">:</span>
    <span class="n">Type</span><span class="p">:</span>       <span class="n">PersistentVolumeClaim</span> <span class="p">(</span><span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">a</span> <span class="n">PersistentVolumeClaim</span> <span class="k">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="n">ClaimName</span><span class="p">:</span>  <span class="n">csi-cephfs-pvc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">pod环境中确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">cephfs</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">]</span><span class="c"># kubectl  exec -it csi-cephfs-demo-pod -- mount | grep ceph</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6789</span><span class="p">,</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">:</span><span class="n">6789</span><span class="p">:/</span><span class="n">volumes</span><span class="p">/</span><span class="n">csi</span><span class="p">/</span><span class="n">csi-vol-b7cd7860</span><span class="p">-</span><span class="n">8d68</span><span class="p">-</span><span class="n">4a20</span><span class="p">-</span><span class="n">91ee-b3031ef8c3a9</span><span class="p">/</span><span class="n">78b1871c</span><span class="p">-</span><span class="n">1274</span><span class="p">-</span><span class="n">4c47</span><span class="p">-</span><span class="n">8bd6</span><span class="p">-</span><span class="n">1f255a5275ed</span> <span class="n">on</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">www</span> <span class="nb">type </span><span class="n">ceph</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">name</span><span class="p">=</span><span class="n">admin</span><span class="p">,</span><span class="n">secret</span><span class="p">=&lt;</span><span class="n">hidden</span><span class="p">&gt;,</span><span class="n">fsid</span><span class="p">=</span><span class="n">00000000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">0000</span><span class="p">-</span><span class="n">000000000000</span><span class="p">,</span><span class="n">acl</span><span class="p">,</span><span class="n">mds_namespace</span><span class="p">=</span><span class="n">cephfs</span><span class="p">,</span><span class="n">wsize</span><span class="p">=</span><span class="n">16777216</span><span class="p">)</span>
</code></pre></div>
<p>环境收尾</p>
<div class="highlight"><pre><span></span><code><span class="n">清理应用环境</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">examples</span><span class="p">/</span><span class="n">rbd</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="n">pod</span><span class="p">.</span><span class="n">yaml</span> <span class="o">-f</span> <span class="n">pvc</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span> <span class="o">-f</span> <span class="n">secret</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">清理sc环境</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ceph-csi</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">kubectl</span>  <span class="n">delete</span> <span class="o">-f</span> <span class="p">./</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">清理ceph环境</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="nb">rm </span><span class="n">kubernetes</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-yes-i-really-really-mean-it</span>
<span class="n">ceph</span> <span class="n">auth</span> <span class="nb">rm </span><span class="n">client</span><span class="p">.</span><span class="n">kubernetes</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="1510">1.5.10 集群部署<a class="headerlink" href="#1510" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Rook</span> <span class="n">是</span> <span class="n">Kubernetes</span> <span class="n">的开源云原生存储编排器</span><span class="err">，</span><span class="n">为各种存储解决方案提供平台</span><span class="err">、</span><span class="n">框架和支持</span><span class="err">，</span><span class="n">以与云原生环境进行原生集成</span><span class="err">。</span>
    <span class="n">Rook</span> <span class="n">将存储软件转变为自我管理</span><span class="err">、</span><span class="n">自我扩展和自我修复的存储服务</span><span class="err">。</span><span class="n">它通过自动化部署</span><span class="err">、</span><span class="n">引导</span><span class="err">、</span><span class="n">配置</span><span class="err">、</span><span class="n">供应</span><span class="err">、</span><span class="n">扩展</span><span class="err">、</span><span class="n">升级</span><span class="err">、</span><span class="n">迁移</span><span class="err">、</span><span class="n">灾难恢复</span><span class="err">、</span><span class="n">监控和资源管理来实现这一点</span><span class="err">。</span><span class="n">Rook</span> <span class="n">使用底层云原生容器管理</span><span class="err">、</span><span class="n">调度和编排平台提供的设施来履行其职责</span><span class="err">。</span> <span class="n">Rook</span> <span class="n">利用扩展点深度集成到云原生环境中</span><span class="err">，</span><span class="n">并为调度</span><span class="err">、</span><span class="n">生命周期管理</span><span class="err">、</span><span class="n">资源管理</span><span class="err">、</span><span class="n">安全性</span><span class="err">、</span><span class="n">监控和用户体验提供无缝体验</span><span class="err">。</span>
    <span class="n">Rook</span> <span class="n">是用</span> <span class="n">golang</span> <span class="n">实现的</span><span class="err">。</span><span class="n">Ceph</span> <span class="n">是用</span> <span class="n">C</span><span class="p">++</span> <span class="n">实现的</span><span class="err">，</span><span class="n">其中数据路径经过高度优化</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">Rook是一个自管理的分布式存储编排系统</span><span class="err">，</span><span class="n">可以为Kubernetes提供便利的存储解决方案</span><span class="err">，</span><span class="n">Rook本身并不提供存储</span><span class="err">，</span><span class="n">而是在Kubernetes和存储之间提供适配层</span><span class="err">，</span><span class="n">简化存储系统的部署和维护工作</span><span class="err">。</span><span class="n">目前</span><span class="err">，</span><span class="n">主要支持存储系统包括但不限于Ceph</span><span class="p">(</span><span class="n">主推</span><span class="p">)</span><span class="err">、</span><span class="n">Cassandra</span><span class="err">、</span><span class="n">NFS</span><span class="err">。</span>
    <span class="n">从本质上来说</span><span class="err">，</span><span class="n">Rook</span> <span class="n">是一个可以提供</span> <span class="n">Ceph</span> <span class="n">集群管理能力的</span> <span class="n">Operator</span><span class="err">。</span><span class="n">Rook</span> <span class="n">使用</span> <span class="n">CRD</span> <span class="n">一个控制器来对</span> <span class="n">Ceph</span> <span class="n">之类的资源进行部署和管理</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">最新版本</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">3</span>
<span class="n">官方地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">rook</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">v1</span><span class="p">.</span><span class="n">9</span><span class="p">/</span><span class="n">ceph-storage</span><span class="p">.</span><span class="n">html</span>
<span class="n">github</span><span class="p">:</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">rook</span>
</code></pre></div>
<p><img alt="img" src="../../../img/kubernetes/kubernetes_storage_ceph/kubernetes.png" /></p>
<p>环境要求</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span><span class="p">)</span> <span class="n">K8s集群</span><span class="err">，</span><span class="n">1</span><span class="p">.</span><span class="n">16版本</span><span class="p">+</span>
<span class="n">2</span><span class="p">)</span> <span class="n">K8s至少3个工作节点</span>
<span class="n">3</span><span class="p">)</span> <span class="n">每个工作节点有一块未使用的硬盘</span>
<span class="n">4</span><span class="p">)</span> <span class="n">Rook支持部署Ceph</span> <span class="n">Nautilus以上版本</span>
</code></pre></div>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">查看master节点的污点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl describe nodes kubernetes-master | grep Taints:</span>
<span class="n">Taints</span><span class="p">:</span>             <span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">:</span><span class="n">NoSchedule</span>

<span class="n">移除master节点的污点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl taint nodes kubernetes-master node-role.kubernetes.io/master:NoSchedule-</span>
<span class="n">node</span><span class="p">/</span><span class="n">kubernetes-master</span> <span class="n">untainted</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl describe nodes kubernetes-master | grep Taints:</span>
<span class="n">Taints</span><span class="p">:</span>             <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p>部署环境</p>
<div class="highlight"><pre><span></span><code><span class="n">获取软件</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">rook</span><span class="p">.</span><span class="n">git</span>
<span class="nb">cd </span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建rook</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">crds</span><span class="p">.</span><span class="n">yaml</span> <span class="o">-f</span> <span class="n">common</span><span class="p">.</span><span class="n">yaml</span> <span class="o">-f</span> <span class="n">operator</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">部署ceph</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">cluster</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">部署Rook</span> <span class="n">Ceph工具</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">toolbox</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">部署Ceph</span> <span class="n">UI</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">dashboard-external-https</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">检查pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl  get pod -n rook-ceph</span>
<span class="n">NAME</span>                                                          <span class="n">READY</span>   <span class="p">...</span>
<span class="n">csi-cephfsplugin-cs9z7</span>                                        <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">csi-cephfsplugin-l2bgm</span>                                        <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">csi-cephfsplugin-provisioner</span><span class="p">-</span><span class="n">657868fc8c</span><span class="p">-</span><span class="n">66nsc</span>                 <span class="n">5</span><span class="p">/</span><span class="n">5</span>     <span class="p">...</span>
<span class="n">csi-cephfsplugin-provisioner</span><span class="p">-</span><span class="n">657868fc8c-phdxm</span>                 <span class="n">5</span><span class="p">/</span><span class="n">5</span>     <span class="p">...</span>
<span class="n">csi-cephfsplugin-x7d7k</span>                                        <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">csi-rbdplugin</span><span class="p">-</span><span class="n">425nc</span>                                           <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">csi-rbdplugin-kthc2</span>                                           <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">csi-rbdplugin-provisioner</span><span class="p">-</span><span class="n">9d6787bcd</span><span class="p">-</span><span class="n">4pzvf</span>                     <span class="n">5</span><span class="p">/</span><span class="n">5</span>     <span class="p">...</span>
<span class="n">csi-rbdplugin-provisioner</span><span class="p">-</span><span class="n">9d6787bcd-q6gnf</span>                     <span class="n">5</span><span class="p">/</span><span class="n">5</span>     <span class="p">...</span>
<span class="n">csi-rbdplugin-zt2qc</span>                                           <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">rook-ceph-crashcollector-kubernetes-master</span><span class="p">-</span><span class="n">6795cf77b5-k6m98</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-crashcollector-kubernetes-node1</span><span class="p">-</span><span class="n">7986cf44b-m7fdv</span>     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-crashcollector-kubernetes-node2</span><span class="p">-</span><span class="n">7d666d4f7c-lhvcw</span>    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-mgr-a</span><span class="p">-</span><span class="n">567fc6fbf9-tr9kq</span>                              <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">rook-ceph-mgr-b</span><span class="p">-</span><span class="n">56496f5b65</span><span class="p">-</span><span class="n">7mtzb</span>                              <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="p">...</span>
<span class="n">rook-ceph-mon-a</span><span class="p">-</span><span class="n">74dd858bcf-rn6bs</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-mon-b</span><span class="p">-</span><span class="n">7dbffc8dd8-ddvsl</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-mon-c</span><span class="p">-</span><span class="n">6f7567b6dc-n7c47</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-operator</span><span class="p">-</span><span class="n">785cc8f794-l8dc5</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd</span><span class="p">-</span><span class="n">0</span><span class="p">-</span><span class="n">98876dbd6</span><span class="p">-</span><span class="n">49wl4</span>                               <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd</span><span class="p">-</span><span class="n">1-c867b6ddc-clc6c</span>                               <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd</span><span class="p">-</span><span class="n">2-d74bd646-rhwbs</span>                                <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd</span><span class="p">-</span><span class="n">3</span><span class="p">-</span><span class="n">779b6dc974-q6lbm</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd</span><span class="p">-</span><span class="n">4</span><span class="p">-</span><span class="n">5646549855-crjqf</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">7b96ffbf6c-jsdsm</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd-prepare-kubernetes-master-fxtbp</span>                 <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd-prepare-kubernetes-node1-l4f2s</span>                  <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-osd-prepare-kubernetes-node2-k6wx4</span>                  <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
<span class="n">rook-ceph-tools</span><span class="p">-</span><span class="n">7c8ddb978b-sqlj2</span>                              <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查svc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl  get svc -n rook-ceph</span>
<span class="n">NAME</span>                                     <span class="nb">TYPE </span>       <span class="p">...</span>  <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>             <span class="n">AGE</span>
<span class="n">rook-ceph-mgr</span>                            <span class="n">ClusterIP</span>   <span class="p">...</span>  <span class="n">9283</span><span class="p">/</span><span class="n">TCP</span>            <span class="n">26m</span>
<span class="n">rook-ceph-mgr-dashboard</span>                  <span class="n">ClusterIP</span>   <span class="p">...</span>  <span class="n">8443</span><span class="p">/</span><span class="n">TCP</span>            <span class="n">26m</span>
<span class="n">rook-ceph-mgr-dashboard-external-https</span>   <span class="n">NodePort</span>    <span class="p">...</span>  <span class="n">8443</span><span class="p">:</span><span class="n">31825</span><span class="p">/</span><span class="n">TCP</span>      <span class="n">44m</span>
<span class="n">rook-ceph-mon-a</span>                          <span class="n">ClusterIP</span>   <span class="p">...</span>  <span class="n">6789</span><span class="p">/</span><span class="n">TCP</span><span class="p">,</span><span class="n">3300</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">36m</span>
<span class="n">rook-ceph-mon-b</span>                          <span class="n">ClusterIP</span>   <span class="p">...</span>  <span class="n">6789</span><span class="p">/</span><span class="n">TCP</span><span class="p">,</span><span class="n">3300</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">35m</span>
<span class="n">rook-ceph-mon-c</span>                          <span class="n">ClusterIP</span>   <span class="p">...</span>  <span class="n">6789</span><span class="p">/</span><span class="n">TCP</span><span class="p">,</span><span class="n">3300</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">29m</span>
</code></pre></div>
<p>查看dashboard</p>
<div class="highlight"><pre><span></span><code><span class="n">获取Ceph</span> <span class="n">Dashboard登录密码</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=&quot;{[&#39;data&#39;][&#39;password&#39;]}&quot; | base64 -d</span>
<span class="p">^</span><span class="n">B7</span><span class="p">+</span><span class="n">jmpcdh</span><span class="p">+}</span><span class="n">u</span><span class="p">^[*</span><span class="nv">@n</span><span class="p">)</span><span class="n">K</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">浏览器访问</span><span class="err">：</span> <span class="n">https</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span><span class="p">:</span><span class="n">31825</span><span class="err">，</span><span class="n">输入用户名admin</span><span class="err">，</span><span class="n">密码</span><span class="p">^</span><span class="n">B7</span><span class="p">+</span><span class="n">jmpcdh</span><span class="p">+}</span><span class="n">u</span><span class="p">^[*</span><span class="nv">@n</span><span class="p">)</span><span class="n">K</span>
</code></pre></div>
<p><img alt="image-20221016004235785" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221016004235785.png" /></p>
<p>命令环境监测</p>
<div class="highlight"><pre><span></span><code><span class="n">获取ceph-tools工具</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  get pod -n rook-ceph  | grep tools</span>
<span class="n">rook-ceph-tools</span><span class="p">-</span><span class="n">7c8ddb978b-sqlj2</span>     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>     <span class="n">0</span>             <span class="n">18m</span>

<span class="n">进入到专用工具环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl -n rook-ceph exec -it rook-ceph-tools-7c8ddb978b-sqlj2 -- /bin/bash</span>
<span class="n">bash</span><span class="p">-</span><span class="n">4</span><span class="p">.</span><span class="n">4</span><span class="p">$</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查ceph环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl -n rook-ceph exec -it rook-ceph-tools-7c8ddb978b-sqlj2 -- /bin/bash</span>
<span class="n">bash</span><span class="p">-</span><span class="n">4</span><span class="p">.</span><span class="n">4</span><span class="p">$</span> <span class="n">ceph</span> <span class="n">-s</span>
  <span class="n">cluster</span><span class="p">:</span>
    <span class="n">id</span><span class="p">:</span>     <span class="n">d20c23c6</span><span class="p">-</span><span class="n">4d4f</span><span class="p">-</span><span class="n">4926-a0ca-fed583a907a0</span>
    <span class="n">health</span><span class="p">:</span> <span class="n">HEALTH_WARN</span>
            <span class="n">clock</span> <span class="n">skew</span> <span class="n">detected</span> <span class="n">on</span> <span class="n">mon</span><span class="p">.</span><span class="n">c</span>

  <span class="n">services</span><span class="p">:</span>
    <span class="n">mon</span><span class="p">:</span> <span class="n">3</span> <span class="n">daemons</span><span class="p">,</span> <span class="n">quorum</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="p">(</span><span class="n">age</span> <span class="n">17m</span><span class="p">)</span>
    <span class="n">mgr</span><span class="p">:</span> <span class="n">b</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">since</span> <span class="n">19m</span><span class="p">),</span> <span class="n">standbys</span><span class="p">:</span> <span class="n">a</span>
    <span class="n">osd</span><span class="p">:</span> <span class="n">6</span> <span class="n">osds</span><span class="p">:</span> <span class="n">6</span> <span class="n">up</span> <span class="p">(</span><span class="n">since</span> <span class="n">18m</span><span class="p">),</span> <span class="n">6</span> <span class="k">in</span> <span class="p">(</span><span class="n">since</span> <span class="n">22m</span><span class="p">)</span>

  <span class="n">data</span><span class="p">:</span>
    <span class="n">pools</span><span class="p">:</span>   <span class="n">1</span> <span class="n">pools</span><span class="p">,</span> <span class="n">1</span> <span class="n">pgs</span>
    <span class="n">objects</span><span class="p">:</span> <span class="n">2</span> <span class="n">objects</span><span class="p">,</span> <span class="n">449</span> <span class="n">KiB</span>
    <span class="n">usage</span><span class="p">:</span>   <span class="n">92</span> <span class="n">MiB</span> <span class="n">used</span><span class="p">,</span> <span class="n">120</span> <span class="n">GiB</span> <span class="p">/</span> <span class="n">120</span> <span class="n">GiB</span> <span class="n">avail</span>
    <span class="n">pgs</span><span class="p">:</span>     <span class="n">1</span> <span class="n">active</span><span class="p">+</span><span class="n">clean</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">bash</span><span class="p">-</span><span class="n">4</span><span class="p">.</span><span class="n">4</span><span class="p">$</span> <span class="n">ceph</span> <span class="n">df</span>
<span class="p">---</span> <span class="n">RAW</span> <span class="n">STORAGE</span> <span class="p">---</span>
<span class="n">CLASS</span>     <span class="n">SIZE</span>    <span class="n">AVAIL</span>    <span class="n">USED</span>  <span class="n">RAW</span> <span class="n">USED</span>  <span class="k">%</span><span class="n">RAW</span> <span class="n">USED</span>
<span class="n">hdd</span>    <span class="n">120</span> <span class="n">GiB</span>  <span class="n">120</span> <span class="n">GiB</span>  <span class="n">92</span> <span class="n">MiB</span>    <span class="n">92</span> <span class="n">MiB</span>       <span class="n">0</span><span class="p">.</span><span class="n">08</span>
<span class="n">TOTAL</span>  <span class="n">120</span> <span class="n">GiB</span>  <span class="n">120</span> <span class="n">GiB</span>  <span class="n">92</span> <span class="n">MiB</span>    <span class="n">92</span> <span class="n">MiB</span>       <span class="n">0</span><span class="p">.</span><span class="n">08</span>

<span class="p">---</span> <span class="n">POOLS</span> <span class="p">---</span>
<span class="n">POOL</span>  <span class="n">ID</span>  <span class="n">PGS</span>   <span class="n">STORED</span>  <span class="n">OBJECTS</span>     <span class="n">USED</span>  <span class="k">%</span><span class="n">USED</span>  <span class="n">MAX</span> <span class="n">AVAIL</span>
<span class="p">.</span><span class="n">mgr</span>   <span class="n">1</span>    <span class="n">1</span>  <span class="n">449</span> <span class="n">KiB</span>        <span class="n">2</span>  <span class="n">449</span> <span class="n">KiB</span>      <span class="n">0</span>     <span class="n">38</span> <span class="n">GiB</span>
</code></pre></div>
<p>部署rbd 和 cephfs环境</p>
<div class="highlight"><pre><span></span><code><span class="n">部署rbd环境</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi</span><span class="p">/</span><span class="n">rbd</span><span class="p">/</span><span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">部署cephfs环境</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">filesystem</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">csi</span><span class="p">/</span><span class="n">cephfs</span><span class="p">/</span><span class="n">storageclass</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl  get sc</span>
<span class="n">NAME</span>              <span class="n">PROVISIONER</span>                     <span class="n">RECLAIMPOLICY</span>   <span class="p">...</span>
<span class="n">rook-ceph-block</span>   <span class="n">rook-ceph</span><span class="p">.</span><span class="n">rbd</span><span class="p">.</span><span class="n">csi</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span>      <span class="n">Delete</span>          <span class="p">...</span>
<span class="n">rook-cephfs</span>       <span class="n">rook-ceph</span><span class="p">.</span><span class="n">cephfs</span><span class="p">.</span><span class="n">csi</span><span class="p">.</span><span class="n">ceph</span><span class="p">.</span><span class="n">com</span>   <span class="n">Delete</span>          <span class="p">...</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>存储测试</p>
<div class="highlight"><pre><span></span><code><span class="n">定制资源清单文件</span> <span class="n">pvc</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolumeClaim</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mysql-pv-claim</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">wordpress</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">storageClassName</span><span class="p">:</span> <span class="n">rook-ceph-block</span>
  <span class="n">accessModes</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">ReadWriteOnce</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="n">20Gi</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用资源对象文件</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">pvc</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">确定效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl  get pvc</span>
<span class="n">NAME</span>             <span class="n">STATUS</span>        <span class="n">VOLUME</span>                                     <span class="p">...</span>
<span class="n">mysql-pv-claim</span>   <span class="n">Bound</span>         <span class="n">pvc-fa8d837b-a087</span><span class="p">-</span><span class="n">471f</span><span class="p">-</span><span class="n">8d00</span><span class="p">-</span><span class="n">0c8a9fe65835</span>   <span class="p">...</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl -n rook-ceph exec -it rook-ceph-tools-7c8ddb978b-sqlj2 -- rbd ls --pool replicapool -l</span>
<span class="n">NAME</span>                                          <span class="n">SIZE</span>    <span class="n">PARENT</span>  <span class="n">FMT</span>  <span class="n">PROT</span>  <span class="n">LOCK</span>
<span class="n">csi-vol-c7d28742</span><span class="p">-</span><span class="n">4ca9</span><span class="p">-</span><span class="n">11ed-bffb-d22d32d7a8e9</span>  <span class="n">20</span> <span class="n">GiB</span>            <span class="n">2</span>
</code></pre></div>
<p>wordpress测试</p>
<div class="highlight"><pre><span></span><code><span class="n">应用资源对象文件</span>
<span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-f</span> <span class="n">mysql</span><span class="p">.</span><span class="n">yaml</span> <span class="o">-f</span> <span class="n">wordpress</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取pvc的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl get pvc -l app=wordpress</span>
<span class="n">NAME</span>             <span class="n">STATUS</span>   <span class="n">VOLUME</span>                                     <span class="p">...</span>   <span class="n">AGE</span>
<span class="n">mysql-pv-claim</span>   <span class="n">Bound</span>    <span class="n">pvc</span><span class="p">-</span><span class="n">38487272-e3cf</span><span class="p">-</span><span class="n">46a2-be06</span><span class="p">-</span><span class="n">0e20af42054f</span>   <span class="p">...</span>   <span class="n">25s</span>
<span class="n">wp-pv-claim</span>      <span class="n">Bound</span>    <span class="n">pvc</span><span class="p">-</span><span class="n">17da7479-cb6d</span><span class="p">-</span><span class="n">46b5-a4fe</span><span class="p">-</span><span class="n">0f230f0ae780</span>   <span class="p">...</span>   <span class="n">25s</span>

<span class="n">获取pod的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl get pods -l app=wordpress</span>
<span class="n">NAME</span>                               <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">wordpress-b98c66fff-gbxbc</span>          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">38s</span>
<span class="n">wordpress-mysql</span><span class="p">-</span><span class="n">79966d6c5b</span><span class="p">-</span><span class="n">6g82t</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">38s</span>

<span class="n">获取svc的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rook</span><span class="p">/</span><span class="n">deploy</span><span class="p">/</span><span class="n">examples</span><span class="p">]</span><span class="c"># kubectl get svc -l app=wordpress</span>
<span class="n">NAME</span>              <span class="nb">TYPE </span>          <span class="n">CLUSTER-IP</span>      <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>        <span class="n">AGE</span>
<span class="n">wordpress</span>         <span class="n">LoadBalancer</span>   <span class="n">10</span><span class="p">.</span><span class="n">98</span><span class="p">.</span><span class="n">101</span><span class="p">.</span><span class="n">125</span>   <span class="p">&lt;</span><span class="n">pending</span><span class="p">&gt;</span>     <span class="n">80</span><span class="p">:</span><span class="n">31606</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">47s</span>
<span class="n">wordpress-mysql</span>   <span class="n">ClusterIP</span>      <span class="n">None</span>            <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">3306</span><span class="p">/</span><span class="n">TCP</span>       <span class="n">47s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">浏览器访问</span><span class="err">：</span> <span class="n">http</span><span class="p">://</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span><span class="p">:</span><span class="n">31606</span><span class="err">，</span><span class="n">可以看到wordpress的部署页面</span>
</code></pre></div>
<p><img alt="image-20221016011450922" src="../../../img/kubernetes/kubernetes_storage_ceph/image-20221016011450922.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      BurningMyself<a href='https://beian.miit.gov.cn/' target='_blank'>  蜀ICP备15033200号-1</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/burningmyself" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitee.com/burningmyself" target="_blank" rel="noopener" title="gitee.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155084439-1"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155132293-1"></script>
      
        <script src="../../../js/google.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>