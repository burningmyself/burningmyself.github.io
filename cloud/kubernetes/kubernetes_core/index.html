
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content=".net,java,php,python,docker,web">
      
      
        <meta name="author" content="BurningMyself">
      
      
        <link rel="canonical" href="https://burningmyself.gitee.io/cloud/kubernetes/kubernetes_core/">
      
      
        <link rel="prev" href="../kubernetes_cluster/">
      
      
        <link rel="next" href="../kubernetes_ui/">
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>Kubernetes核心概念 - BurningMyself</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="BurningMyself" class="md-header__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BurningMyself
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kubernetes核心概念
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BurningMyself" class="md-nav__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BurningMyself
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          技术博文
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          技术博文
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          .NET
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          .NET
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sharp/" class="md-nav__link">
        C#新特性语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_docker/" class="md-nav__link">
        .Net Core Docker 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sqlserver_nginx/" class="md-nav__link">
        Docker 容器化部署 ASP.NET Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_safety/" class="md-nav__link">
        让你的ASP.NET Core应用程序更安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_study_route/" class="md-nav__link">
        ASP.NET Core开发者指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/feature/" class="md-nav__link">
        Java特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/load-class/" class="md-nav__link">
        Java类加载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/orm/" class="md-nav__link">
        Orm的优缺点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/bio-nio/" class="md-nav__link">
        BIO与NIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/rocketmq/rmq-1/" class="md-nav__link">
        RocketMq下载与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springAnnotation/" class="md-nav__link">
        Spring常用注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/javavm/" class="md-nav__link">
        Java 虚拟机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springdesign/" class="md-nav__link">
        Spring 常用设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/spring-cloud/" class="md-nav__link">
        Spring Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-simple/" class="md-nav__link">
        Java simple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-validator/" class="md-nav__link">
        Java Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-string/" class="md-nav__link">
        Java String
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-utils/" class="md-nav__link">
        Java Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/feature/" class="md-nav__link">
        Python特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/str_joint/" class="md-nav__link">
        Python字符拼接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/syntax_rule/" class="md-nav__link">
        Python语法技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/fabric/" class="md-nav__link">
        远程部署神器 Fabric
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          PHP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          PHP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../php/kj/" class="md-nav__link">
        框架
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/es6/" class="md-nav__link">
        es6语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/ali_js_style/" class="md-nav__link">
        阿里js样式规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/node.js/" class="md-nav__link">
        node.js文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react/" class="md-nav__link">
        React 开发者指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../dart/syntax/" class="md-nav__link">
        Dart语法学习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react_interview/" class="md-nav__link">
        React 面试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/js_tool_method/" class="md-nav__link">
        js 工具函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/vue_cp_react/" class="md-nav__link">
        vue与react比较
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/javascript/" class="md-nav__link">
        JavaScript 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh17/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_log/" class="md-nav__link">
        MySQL日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_index/" class="md-nav__link">
        MySQL索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_pxc/" class="md-nav__link">
        MySQL PXC集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_use/" class="md-nav__link">
        MySQL 数据库应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_backups/" class="md-nav__link">
        MySql 备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/sql_server_master/" class="md-nav__link">
        Sql Server 主从备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/data_split/" class="md-nav__link">
        数据库之互联网常用分库分表方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mybatis/" class="md-nav__link">
        Mybatis使用心德
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/often/" class="md-nav__link">
        常用命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/ope/" class="md-nav__link">
        实用的Linux 命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker/" class="md-nav__link">
        Docker全科
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-compose/" class="md-nav__link">
        docker和docker-compose配置常用环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-jenkins/" class="md-nav__link">
        Docker部署Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-phabricator/" class="md-nav__link">
        Docker部署Phabricator
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          Tool
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Tool
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitusual/" class="md-nav__link">
        Git动画展示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitquestion/" class="md-nav__link">
        Git问题处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitflow/" class="md-nav__link">
        GitFlow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitbook/" class="md-nav__link">
        GitBook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitcmr/" class="md-nav__link">
        Git提交日志规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/markdown/" class="md-nav__link">
        Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cicd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/mkdocs/" class="md-nav__link">
        mkdocs简单使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitstudy/" class="md-nav__link">
        Git的黑魔法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/minio/" class="md-nav__link">
        MinIO 搭建使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cat-monitoring/" class="md-nav__link">
        Cat分布式监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          云架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          云架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../native/" class="md-nav__link">
        云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../virtual/" class="md-nav__link">
        虚拟化技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compute/" class="md-nav__link">
        云计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprelease/" class="md-nav__link">
        应用部署容器化演进
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlinux/" class="md-nav__link">
        容器技术所涉及Linux内核关键技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_native/" class="md-nav__link">
        容器管理工具Docker生态架构及部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_nginx/" class="md-nav__link">
        使用容器运行Nginx应用及Docker命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image/" class="md-nav__link">
        Docker容器镜像
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image_fast/" class="md-nav__link">
        Docker容器镜像加速器及本地容器镜像仓库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container_enterprice/" class="md-nav__link">
        Docker容器化部署企业级应用集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_file/" class="md-nav__link">
        Dockerfile精讲及新型容器镜像构建技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_network/" class="md-nav__link">
        Docker容器网络与通信原理深度解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_date/" class="md-nav__link">
        Docker容器数据持久化存储机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_compose/" class="md-nav__link">
        Docker容器服务编排利器Docker Compose应用实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_swarm/" class="md-nav__link">
        Docker主机集群化方案 Docker Swarm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_devops/" class="md-nav__link">
        基于Docker容器DevOps应用方案 企业业务代码发布系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container/" class="md-nav__link">
        轻量级或工业级容器管理工具
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        kubeadm极速部署Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_introduce/" class="md-nav__link">
        kubernetes介绍与集群架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_way/" class="md-nav__link">
        Kubernetes集群部署方式说明
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_master/" class="md-nav__link">
        kubeadm部署单Master节点kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight/" class="md-nav__link">
        kubeadm部署高可用kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rke/" class="md-nav__link">
        使用RKE构建企业生产级Kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin1/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）一
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin2/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）二
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        Kubernetes集群UI及主机资源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_sealos/" class="md-nav__link">
        使用sealos部署kubernetes集群并实现集群管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        kubernetes集群命令语法
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Kubernetes核心概念
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          微服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          微服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/fbs-lock/" class="md-nav__link">
        分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/design/" class="md-nav__link">
        微服务设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/distrimsg/" class="md-nav__link">
        分布式系统与消息的投递
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/ddd/" class="md-nav__link">
        基于DDD的微服务设计和开发实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/kafka/" class="md-nav__link">
        Kafka架构原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/redis_cluster/" class="md-nav__link">
        Redis Cluster原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/spring-cloud-micro/" class="md-nav__link">
        分布式架构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          经验分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          经验分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/devops/" class="md-nav__link">
        DevOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/micro-service/" class="md-nav__link">
        Micro-Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/raft-gossip/" class="md-nav__link">
        Raft算法和Gossip协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cl/" class="md-nav__link">
        集群和负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/ai/" class="md-nav__link">
        人工智能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/code-principle/" class="md-nav__link">
        代码原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/techbig/" class="md-nav__link">
        如何成为技术大牛
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/learnweetout/" class="md-nav__link">
        程序员如何技术成长
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/pt/" class="md-nav__link">
        产品与技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/four_deep_learning/" class="md-nav__link">
        深度学习框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/tl/" class="md-nav__link">
        在阿里做了5年技术Leader，我总结出这些套路！
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cto/" class="md-nav__link">
        CTO 技能图谱
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          构架
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          构架
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/split/" class="md-nav__link">
        构架拆分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fgb/" class="md-nav__link">
        分布式、高并发、多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/agility/" class="md-nav__link">
        如何理解敏捷开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fwork/" class="md-nav__link">
        走向架构师必备的技能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/data_middle/" class="md-nav__link">
        数据中台的思考与总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/algorithm-ten/" class="md-nav__link">
        必学的 10 大算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          情感
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          情感
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/eq/" class="md-nav__link">
        情商
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/workheard/" class="md-nav__link">
        工作心得
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lookbook/" class="md-nav__link">
        看书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/selfdiscipline/" class="md-nav__link">
        自律
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/livefail/" class="md-nav__link">
        为什么活着失败
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/emotion/" class="md-nav__link">
        情绪管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/losecome/" class="md-nav__link">
        所有的失去，都会以另一种方式归来
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/threeheart/" class="md-nav__link">
        人生有这三种好心态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/onepath/" class="md-nav__link">
        余生，学会一个人走，不管有没有人陪
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/twopath/" class="md-nav__link">
        往后余生还很精彩，别被熬夜拖垮了
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lifetime/" class="md-nav__link">
        心态好的人，一辈子都好
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="kubernetes">Kubernetes核心<a class="headerlink" href="#kubernetes" title="Permanent link">&para;</a></h1>
<h1 id="kubernetes_1">一、kubernetes核心概念<a class="headerlink" href="#kubernetes_1" title="Permanent link">&para;</a></h1>
<h2 id="11_pod">1.1 Pod<a class="headerlink" href="#11_pod" title="Permanent link">&para;</a></h2>
<p>Pod是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。</p>
<p>Pod就像豌豆荚一样，其中包含着一组（一个或多个）容器； 这些容器共享存储、网络、以及怎样运行这些容器的声明。</p>
<p><img alt="image-20220330113151804" src="../../../img/kubernetes/kubernetes_core/image-20220330113151804.png" /></p>
<p>Pod就像一台物理服务器一样，其中包含一个或多个应用容器， 这些容器中运行着用户应用程序。</p>
<p><strong>举例说明Pod、Container、应用程序三者之间的关系：麻屋子,红帐子,里面住着白胖子。Pod就是麻屋子,Container就是红帐子,应用程序就是里面的白胖子。</strong></p>
<p><img alt="image-20220330113046572" src="../../../img/kubernetes/kubernetes_core/image-20220330113046572.png" /></p>
<h2 id="12_controller">1.2 Controller<a class="headerlink" href="#12_controller" title="Permanent link">&para;</a></h2>
<p>在 Kubernetes 中，用于管理和运行Pod的对象</p>
<p>在 Kubernetes 中，控制器通过监控集群的公共状态，并致力于将当前状态转变为期望的状态</p>
<p><strong>举例说明Controller(控制器)作用：房间里的温度自动调节器</strong></p>
<p><strong>当你设置了温度，告诉了温度自动调节器你的*期望状态（Desired State）<em>。 房间的实际温度是*当前状态（Current State）</em>。 通过对设备的开关控制，温度自动调节器让其当前状态接近期望状态。</strong></p>
<p>一个控制器至少追踪一种类型的 Kubernetes 资源。这些对象有一个代表期望状态的 <code>spec</code> 字段。 该资源的控制器负责确保其当前状态接近期望状态。</p>
<p>不同的类型的控制器所实现的控制方式不一样，例如：</p>
<ul>
<li>deployment </li>
<li>部署无状态应用</li>
<li>部署无状态应用: 认为pod 都一样，没有顺序要求， 不用考虑在哪个node 运行，随意进行扩展和伸缩</li>
<li>管理Pod和 ReplicaSet</li>
<li>部署、滚动升级等</li>
<li>典型的像web服务、分布式服务等</li>
<li>StatefulSet </li>
<li>部署有状态应用</li>
<li>有状态应用，每个pod 都独立运行，保持pod 启动顺序和唯一性； 有唯一的网络标识符，持久存储； 有序，比如mysql 主从； 主机名称固定。 而且其扩容以及升级等操作也是按顺序进行的操作。</li>
<li>DaemonSet </li>
<li>部署守护进程</li>
<li>DaemonSet保证在每个Node上都运行一个容器副本，常用来部署一些集群的日志、监控或者其他系统管理应用。 新加入的node 也同样运行在一个pod 里面。</li>
<li>job </li>
<li>一次性任务</li>
<li>Job负责批量处理短暂的一次性任务 (short lived one-off tasks)，即仅执行一次的任务，它保证批处理任务的一个或多个Pod成功结束。</li>
<li>Cronjob </li>
<li>周期性定时任务</li>
</ul>
<h2 id="13_label">1.3 Label<a class="headerlink" href="#13_label" title="Permanent link">&para;</a></h2>
<h3 id="131_label">1.3.1 Label介绍<a class="headerlink" href="#131_label" title="Permanent link">&para;</a></h3>
<p>Label是附着到object上（例如Pod）的键值对。可以在创建object的时候指定，也可以在object创建后随时指定。Labels的值对系统本身并没有什么含义，只是对用户才有意义。</p>
<p>一个Label是一个key=value的键值对，其中key与value由用户自己指定。</p>
<p>Label可以附加到各种资源对象上，例如Node、Pod、Service、RC等，一个资源对象可以定义任意数量的Label，同一个Label也可以被添加到任意数量的资源对象上去，Label通常在资源对象定义时确定，也可以在对象创建后动态添加或者删除。</p>
<p>我们可以通过指定的资源对象捆绑一个或多个不同的Label来实现多维度的资源分组管理功能，以便于灵活、方便地进行资源分配、调度、配置、部署等管理工作。例如：部署不同版本的应用到不同的环境中；或者监控和分析应用（日志记录、监控、告警）等。</p>
<p>一些常用abel示例如下所示:</p>
<p>版本标签："release" : "stable" , "release" : "canary"...</p>
<p>环境标签："environment" : "dev" , "environment" : "production"</p>
<p>架构标签："tier" : "frontend" , "tier" : "backend" , "tier" : "middleware"</p>
<p>分区标签："partition" : "customerA" , "partition" : "customerB"...</p>
<p>质量管控标签："track" : "daily" , "track" : "weekly"</p>
<p>Label相当于我们熟悉的“标签”，给某个资源对象定义一个Label，就相当于给它打了一个标签，随后可以通过Label Selector（标签选择器）查询和筛选拥有某些Label的资源对象，Kubernetes通过这种方式实现了类似SQL的简单又通用的对象查询机制。</p>
<h3 id="132_label">1.3.2 Label语法及字符集<a class="headerlink" href="#132_label" title="Permanent link">&para;</a></h3>
<p>Label key的组成：</p>
<ul>
<li>不得超过63个字符</li>
<li>可以使用前缀，使用/分隔，前缀必须是DNS子域，不得超过253个字符，系统中的自动化组件创建的label必须指定前缀，<code>kubernetes.io/</code>由kubernetes保留</li>
<li>起始必须是字母（大小写都可以）或数字，中间可以有连字符、下划线和点</li>
</ul>
<p>Label value的组成：</p>
<ul>
<li>不得超过63个字符</li>
<li>起始必须是字母（大小写都可以）或数字，中间可以有连字符、下划线和点</li>
</ul>
<h2 id="14_label_selector">1.4 Label Selector<a class="headerlink" href="#14_label_selector" title="Permanent link">&para;</a></h2>
<p>通过label selector，客户端／用户可以指定一个object集合，通过label selector对object的集合进行操作。</p>
<p>Label selector有两种类型：</p>
<ul>
<li><em>equality-based（基于等式）</em> ：可以使用<code>=</code>、<code>==</code>、<code>!=</code>操作符，可以使用逗号分隔多个表达式</li>
<li><em>set-based</em>（基于集合） ：可以使用<code>in</code>、<code>notin</code>、<code>!</code>操作符，另外还可以没有操作符，直接写出某个label的key，表示过滤有某个key的object而不管该key的value是何值，<code>!</code>表示没有该label的object</li>
</ul>
<p><strong>举例说明Label Selector</strong></p>
<p><strong>Label Selector可以被类比为SQL语句中的where查询条件，例如，name=redis-slave这个label Selector作用于Pod时，可以被类比为select * from pod where pod's name = 'redis-slave'这样的语句。</strong></p>
<h2 id="15_service">1.5 Service<a class="headerlink" href="#15_service" title="Permanent link">&para;</a></h2>
<p>将运行在一组 Pods上的应用程序公开为网络服务的抽象方法。</p>
<p>由于Pod是非永久性资源对象，如果你使用Controller运行你的应用程序，你可以动态创建和销毁Pod，这样就会导致无法准确访问到所想要访问的Pod</p>
<p>例如：如果一组 Pod（称为“后端”）为集群内的其他 Pod（称为“前端”）提供功能， 那么前端如何找出并跟踪要连接的 IP 地址，以便前端可以使用提供工作负载的后端部分？</p>
<p>是一组iptables或ipvs规划，通过把客户端的请求转发到服务端（Pod）,如有多个Pod情况，亦可实现负载均衡的效果。</p>
<p>例如：一个图片处理后端，它运行了 3 个副本（Pod）。这些副本是可互换的 —— 前端不需要关心它们调用了哪个后端副本。 然而组成这一组后端程序的 Pod 实际上可能会发生变化， 前端客户端不应该也没必要知道，而且也不需要跟踪这一组后端的状态。</p>
<h2 id="16_endpoints">1.6 Endpoints<a class="headerlink" href="#16_endpoints" title="Permanent link">&para;</a></h2>
<p>为Service管理后端Pod，当后端Pod被创建或销毁时，endpoints列表会更新Pod对应的IP地址，以便Service访问请求能够确保被响应。</p>
<h2 id="17_dns">1.7 DNS<a class="headerlink" href="#17_dns" title="Permanent link">&para;</a></h2>
<p>为kubernetes集群内资源对象的访问提供名称解析，这样就可以实现通过DNS名称而非IP地址来访问服务。</p>
<ul>
<li>实现集群内Service名称解析</li>
<li>实现集群内Pod内Container中应用访问互联网提供域名解析</li>
</ul>
<h1 id="kubernetes_2">二、Kubernetes核心概念之间的关系<a class="headerlink" href="#kubernetes_2" title="Permanent link">&para;</a></h1>
<h2 id="21_podcontroller">2.1 Pod与Controller<a class="headerlink" href="#21_podcontroller" title="Permanent link">&para;</a></h2>
<p>pod 是通过Controller 实现应用的运维，比如伸缩，滚动升级等待。pod 和 controller 通过label 标签建立关系。</p>
<p><img alt="" src="../../../img/kubernetes/kubernetes_core/controller%E4%B8%8Epod.gif" /></p>
<h2 id="22_podservice">2.2 Pod与Service<a class="headerlink" href="#22_podservice" title="Permanent link">&para;</a></h2>
<p>service 是为了防止pod 失联，提供的服务发现，类似于微服务的注册中心。定义一组pod 的访问策略。可以为一组具有相同功能的容器应用提供一个统一的入口地址，并将请求负载分发到后端的各个容器应用上。</p>
<p>service 通过selector 来管控对应的pod。根据label 和 selector 建立关联，通过service 实现pod 的负载均衡。</p>
<p><img alt="image-20220330021556081" src="../../../img/kubernetes/kubernetes_core/image-20220330021556081.png" /></p>
<h2 id="23_servicedns">2.3 Service与DNS<a class="headerlink" href="#23_servicedns" title="Permanent link">&para;</a></h2>
<p>通过DNS实现对Service名称解析，以此达到访问后端Pod目的。</p>
<h1 id="kubernetes_3">三、基于kubernetes集群容器化应用的微服务<a class="headerlink" href="#kubernetes_3" title="Permanent link">&para;</a></h1>
<h2 id="31">3.1 服务部署方式介绍<a class="headerlink" href="#31" title="Permanent link">&para;</a></h2>
<ul>
<li>单体服务架构</li>
<li>所有服务进程运行在同一台主机内</li>
<li>分布式服务架构</li>
<li>服务进程分布于不同的主机，其中一台主机出现故障，不影响其它主机上的服务运行</li>
<li>微服务架构</li>
<li>使用容器化技术把分布式服务架构运行起来，并实现对不同的服务进程的高可用及快速发布等。</li>
</ul>
<h2 id="32_kubernetes">3.2 微服务架构服务组件（kubernetes核心概念）之间关系举例说明<a class="headerlink" href="#32_kubernetes" title="Permanent link">&para;</a></h2>
<p>以在kubernetes集群中运行LNMT应用为例：</p>
<p>把kubernetes集群看做是一个IDC机房，把LNMT Web架构应用以微服务（kubernetes集群资源对象）的方式部署到kubernetes集群中。</p>
<p><img alt="" src="../../../img/kubernetes/kubernetes_core/kubernetes%E9%9B%86%E7%BE%A4%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png" /></p>
<h1 id="kubernetes_pod">Kubernetes集群核心概念 Pod<a class="headerlink" href="#kubernetes_pod" title="Permanent link">&para;</a></h1>
<h1 id="workloads">一、工作负载(workloads)<a class="headerlink" href="#workloads" title="Permanent link">&para;</a></h1>
<p>参考链接：<a href="https://kubernetes.io/zh/docs/concepts/workloads/">https://kubernetes.io/zh/docs/concepts/workloads/</a></p>
<p>工作负载（workload）是在kubernetes集群中运行的应用程序。无论你的工作负载是单一服务还是多个一同工作的服务构成，在kubernetes中都可以使用pod来运行它。</p>
<p><img alt="1604285743110" src="../../../img/kubernetes/kubernetes_core/1.png" /></p>
<p>workloads分为pod与controllers</p>
<ul>
<li>pod通过控制器实现应用的运行，如何伸缩，升级等</li>
<li>controllers 在集群中管理pod</li>
<li>pod与控制器之间通过label-selector相关联，是唯一的关联方式</li>
</ul>
<p><img alt="1564844640416" src="../../../img/kubernetes/kubernetes_core/work_load.png" /></p>
<p>在pod的YAML里指定pod标签</p>
<div class="highlight"><pre><span></span><code><span class="n">定义标签</span>
  <span class="n">labels</span><span class="p">:</span> 
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
</code></pre></div>
<p>在控制器的YAML里指定标签选择器匹配标签</p>
<div class="highlight"><pre><span></span><code><span class="n">通过标签选择器选择对应的pod</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
</code></pre></div>
<h1 id="pod">二、pod介绍<a class="headerlink" href="#pod" title="Permanent link">&para;</a></h1>
<h2 id="21_pod">2.1 pod定义与分类<a class="headerlink" href="#21_pod" title="Permanent link">&para;</a></h2>
<p>参考链接: <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/">https://kubernetes.io/zh/docs/concepts/workloads/pods/</a></p>
<h3 id="211_pod">2.1.1 Pod定义<a class="headerlink" href="#211_pod" title="Permanent link">&para;</a></h3>
<ul>
<li>Pod(豌豆荚) 是Kubernetes集群管理（创建、部署）与调度的最小计算单元，表示处于运行状态的一组容器。</li>
<li>Pod不是进程，而是容器运行的环境。</li>
<li>一个Pod可以封装**一个容器或多个容器(主容器或sidecar边车容器)**</li>
<li>一个pod内的多个容器之间共享部分命名空间，例如：Net Namespace,UTS Namespace,IPC Namespace及存储资源</li>
<li>用户pod默认会被调度运行在node节点之上(不运行在master节点上，但也有例外情况)</li>
<li>pod内的IP不是固定的，集群外不能直接访问pod</li>
</ul>
<h3 id="212_pod">2.1.2 Pod分类<a class="headerlink" href="#212_pod" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>静态Pod</strong> 也称之为“无控制器管理的自主式pod”，直接由特定节点上的 <code>kubelet</code> 守护进程管理， 不需要API 服务器看到它们，尽管大多数 Pod 都是通过控制面（例如，Deployment） 来管理的，对于静态 Pod 而言，<code>kubelet</code> 直接监控每个 Pod，并在其失效时重启之。</li>
<li><strong>控制器管理的pod</strong>   控制器可以控制pod的副本数，扩容与裁剪，版本更新与回滚等</li>
</ul>
<h2 id="22_pod">2.2 查看pod方法<a class="headerlink" href="#22_pod" title="Permanent link">&para;</a></h2>
<p>pod是一种计算资源，可以通过<code>kubectl get pod</code>来查看</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod       # pod或pods都可以，不指定namespace,默认是名为default的namespace</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -n kube-system</span>
</code></pre></div>
<h2 id="23_podyaml">2.3 pod的YAML资源清单格式<a class="headerlink" href="#23_podyaml" title="Permanent link">&para;</a></h2>
<p>先看一个yaml格式的pod定义文件解释</p>
<div class="highlight"><pre><span></span><code><span class="c"># yaml格式的pod定义文件完整内容：</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>       <span class="c">#必选，api版本号，例如v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>           <span class="c">#必选，Pod</span>
<span class="n">metadata</span><span class="p">:</span>           <span class="c">#必选，元数据</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">string</span>       <span class="c">#必选，Pod名称</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">string</span>    <span class="c">#Pod所属的命名空间,默认在default的namespace</span>
  <span class="n">labels</span><span class="p">:</span>            <span class="c"># 自定义标签</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#自定义标签名字</span>
  <span class="n">annotations</span><span class="p">:</span>        <span class="c">#自定义注释列表</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">string</span>
<span class="n">spec</span><span class="p">:</span>         <span class="c">#必选，Pod中容器的详细定义(期望)</span>
  <span class="n">containers</span><span class="p">:</span>      <span class="c">#必选，Pod中容器列表</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#必选，容器名称</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">string</span>    <span class="c">#必选，容器的镜像名称</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="p">[</span><span class="n">Always</span> <span class="p">|</span> <span class="n">Never</span> <span class="p">|</span> <span class="n">IfNotPresent</span><span class="p">]</span> <span class="c">#获取镜像的策略 Alawys表示下载镜像 IfnotPresent表示优先使用本地镜像，否则下载镜像，Nerver表示仅使用本地镜像</span>
    <span class="n">command</span><span class="p">:</span> <span class="no">[string]</span>    <span class="c">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
    <span class="n">args</span><span class="p">:</span> <span class="no">[string]</span>     <span class="c">#容器的启动命令参数列表</span>
    <span class="n">workingDir</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#容器的工作目录</span>
    <span class="n">volumeMounts</span><span class="p">:</span>    <span class="c">#挂载到容器内部的存储卷配置</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
      <span class="n">mountPath</span><span class="p">:</span> <span class="n">string</span>    <span class="c">#存储卷在容器内mount的绝对路径，应少于512字符</span>
      <span class="n">readOnly</span><span class="p">:</span> <span class="n">boolean</span>    <span class="c">#是否为只读模式</span>
    <span class="n">ports</span><span class="p">:</span>       <span class="c">#需要暴露的端口库号列表</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#端口号名称</span>
      <span class="n">containerPort</span><span class="p">:</span> <span class="n">int</span>   <span class="c">#容器需要监听的端口号</span>
      <span class="n">hostPort</span><span class="p">:</span> <span class="n">int</span>    <span class="c">#容器所在主机需要监听的端口号，默认与Container相同</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#端口协议，支持TCP和UDP，默认TCP</span>
    <span class="n">env</span><span class="p">:</span>       <span class="c">#容器运行前需设置的环境变量列表</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#环境变量名称</span>
      <span class="n">value</span><span class="p">:</span> <span class="n">string</span>    <span class="c">#环境变量的值</span>
    <span class="n">resources</span><span class="p">:</span>       <span class="c">#资源限制和请求的设置</span>
      <span class="n">limits</span><span class="p">:</span>      <span class="c">#资源限制的设置</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="n">string</span>    <span class="c">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
      <span class="n">requests</span><span class="p">:</span>      <span class="c">#资源请求的设置</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="n">string</span>    <span class="c">#Cpu请求，容器启动的初始可用数量</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#内存清求，容器启动的初始可用数量</span>
    <span class="n">livenessProbe</span><span class="p">:</span>     <span class="c">#对Pod内个容器健康检查的设置，当探测无响应几次后将自动重启该容器，检查方法有exec、httpGet和tcpSocket，对一个容器只需设置其中一种方法即可</span>
      <span class="n">exec</span><span class="p">:</span>      <span class="c">#对Pod容器内检查方式设置为exec方式</span>
        <span class="n">command</span><span class="p">:</span> <span class="no">[string]</span>  <span class="c">#exec方式需要制定的命令或脚本</span>
      <span class="n">httpGet</span><span class="p">:</span>       <span class="c">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">string</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">number</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">string</span>
        <span class="n">scheme</span><span class="p">:</span> <span class="n">string</span>
        <span class="n">HttpHeaders</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>
          <span class="n">value</span><span class="p">:</span> <span class="n">string</span>
      <span class="n">tcpSocket</span><span class="p">:</span>     <span class="c">#对Pod内个容器健康检查方式设置为tcpSocket方式</span>
         <span class="n">port</span><span class="p">:</span> <span class="n">number</span>
       <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">0</span>  <span class="c">#容器启动完成后首次探测的时间，单位为秒</span>
       <span class="n">timeoutSeconds</span><span class="p">:</span> <span class="n">0</span>   <span class="c">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
       <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">0</span>    <span class="c">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
       <span class="n">successThreshold</span><span class="p">:</span> <span class="n">0</span>
       <span class="n">failureThreshold</span><span class="p">:</span> <span class="n">0</span>
       <span class="n">securityContext</span><span class="p">:</span>
         <span class="n">privileged</span><span class="p">:</span><span class="n">false</span>
    <span class="n">restartPolicy</span><span class="p">:</span> <span class="p">[</span><span class="n">Always</span> <span class="p">|</span> <span class="n">Never</span> <span class="p">|</span> <span class="n">OnFailure</span><span class="p">]</span> <span class="c"># Pod的重启策略，Always表示一旦不管以何种方式终止运行，kubelet都将重启，OnFailure表示只有Pod以非0退出码退出才重启，Nerver表示不再重启该Pod</span>
    <span class="n">nodeSelector</span><span class="p">:</span> <span class="n">obeject</span>  <span class="c"># 设置NodeSelector表示将该Pod调度到包含这个label的node上，以key：value的格式指定</span>
    <span class="n">imagePullSecrets</span><span class="p">:</span>    <span class="c">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>
    <span class="n">hostNetwork</span><span class="p">:</span> <span class="n">false</span>     <span class="c">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
    <span class="n">volumes</span><span class="p">:</span>       <span class="c">#在该pod上定义共享存储卷列表</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#共享存储卷名称 （volumes类型有很多种）</span>
      <span class="n">emptyDir</span><span class="p">:</span> <span class="p">{}</span>     <span class="c">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
      <span class="n">hostPath</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">string</span>     <span class="c">#Pod所在宿主机的目录，将被用于同期中mount的目录</span>
      <span class="n">secret</span><span class="p">:</span>      <span class="c">#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
        <span class="n">scretname</span><span class="p">:</span> <span class="n">string</span>  
        <span class="n">items</span><span class="p">:</span>     
        <span class="p">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">string</span>
          <span class="n">path</span><span class="p">:</span> <span class="n">string</span>
      <span class="n">configMap</span><span class="p">:</span>     <span class="c">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">string</span>
        <span class="n">items</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">string</span>
          <span class="n">path</span><span class="p">:</span> <span class="n">string</span>
</code></pre></div>
<p><strong>YAML格式查找帮助方法回顾</strong></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl explain namespace</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl explain pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl explain pod.spec</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl explain pod.spec.containers</span>
</code></pre></div>
<h1 id="pod_1">三、pod创建与验证<a class="headerlink" href="#pod_1" title="Permanent link">&para;</a></h1>
<h2 id="31_podv118">3.1 命令创建pod(v1.18变化)<a class="headerlink" href="#31_podv118" title="Permanent link">&para;</a></h2>
<ul>
<li>k8s之前版本中, kubectl run命令用于创建deployment控制器</li>
<li>在v1.18版本中, kubectl run命令改为创建pod</li>
</ul>
<h3 id="311_pod-nginxpod">3.1.1 创建一个名为pod-nginx的pod<a class="headerlink" href="#311_pod-nginxpod" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl run nginx1 --image=nginx:1.15-alpine</span>
<span class="n">pod</span><span class="p">/</span><span class="n">nginx1</span> <span class="n">created</span>
</code></pre></div>
<h3 id="312">3.1.2 验证<a class="headerlink" href="#312" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>             <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx1</span>           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">41s</span>
</code></pre></div>
<h2 id="32_yamlpod">3.2 YAML创建pod<a class="headerlink" href="#32_yamlpod" title="Permanent link">&para;</a></h2>
<h3 id="321_yaml">3.2.1 准备yaml文件<a class="headerlink" href="#321_yaml" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod1.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>                  <span class="c"># api版本</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>                       <span class="c"># 资源类型为Pod</span>
<span class="n">metadata</span><span class="p">:</span>                       
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-stress</span>              <span class="c"># 自定义pod的名称</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>                   <span class="c"># 定义pod里包含的容器</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>                    <span class="c"># 自定义pod中的容器名</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>       <span class="c"># 启动容器的镜像名</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>         <span class="c"># 自定义启动容器时要执行的命令(类似dockerfile里的CMD)</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;150M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span> <span class="c"># 自定义启动容器执行命令的参数</span>

<span class="c"># polinux/stress这个镜像用于压力测试,在启动容器时传命令与参数就是相当于分配容器运行时需要的压力</span>
</code></pre></div>
<p>2, 通过yaml文件创建pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod1.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress</span> <span class="n">created</span>
</code></pre></div>
<h3 id="322_pod">3.2.2 查看pod信息<a class="headerlink" href="#322_pod" title="Permanent link">&para;</a></h3>
<p>查看pod信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod-stress</span>    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">45s</span>
</code></pre></div>
<p>查看pod详细信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide</span>
<span class="n">NAME</span>         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>              <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">pod-stress</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">71s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">72</span>   <span class="n">k8s-worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p>描述pod详细信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod pod-stress </span>
<span class="p">......</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>   <span class="n">Reason</span>     <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>     <span class="p">----</span>  <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Scheduled</span>  <span class="n">102s</span>  <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">pod-stress</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>  <span class="n">Pulling</span>    <span class="n">102s</span>  <span class="n">kubelet</span>            <span class="n">Pulling</span> <span class="n">image</span> <span class="s2">&quot;polinux/stress&quot;</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">83s</span>   <span class="n">kubelet</span>            <span class="n">Successfully</span> <span class="n">pulled</span> <span class="n">image</span> <span class="s2">&quot;polinux/stress&quot;</span> <span class="k">in</span> <span class="n">18</span><span class="p">.</span><span class="n">944533343s</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">83s</span>   <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">c1</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">82s</span>   <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">c1</span>
</code></pre></div>
<h2 id="33_pod">3.3 删除pod<a class="headerlink" href="#33_pod" title="Permanent link">&para;</a></h2>
<h3 id="331_pod">3.3.1 单个pod删除<a class="headerlink" href="#331_pod" title="Permanent link">&para;</a></h3>
<p>方法1:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete pod pod-stress</span>
<span class="n">pod</span> <span class="s2">&quot;pod-stress&quot;</span> <span class="n">deleted</span>
</code></pre></div>
<p>方法2:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete -f pod1.yml</span>
</code></pre></div>
<h3 id="332_pod">3.3.2 多个pod删除<a class="headerlink" href="#332_pod" title="Permanent link">&para;</a></h3>
<p>方法1: 后接多个pod名</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete pod pod名1 pod名2 pod名3 ......</span>
</code></pre></div>
<p>方法2: 通过awk截取要删除的pod名称，然后管道给xargs</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods |awk &#39;NR&gt;1 {print $1}&#39; |xargs kubectl  delete pod</span>
</code></pre></div>
<p>方法3: 如果要删除的pod都在同一个非default的命名空间，则可直接删除命名空间</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete ns xxxx</span>
</code></pre></div>
<h2 id="34">3.4 镜像拉取策略<a class="headerlink" href="#34" title="Permanent link">&para;</a></h2>
<p>由imagePullPolicy参数控制</p>
<ul>
<li>Always : 不管本地有没有镜像，都要从仓库中下载镜像</li>
<li>Never : 从来不从仓库下载镜像, 只用本地镜像,本地没有就算了</li>
<li>IfNotPresent: 如果本地存在就直接使用, 不存在才从仓库下载</li>
</ul>
<p>默认的策略是：</p>
<ul>
<li>当镜像标签版本是latest，默认策略就是Always</li>
<li>如果指定特定版本默认拉取策略就是IfNotPresent。</li>
</ul>
<p>1, 将上面的pod删除再创建，使用下面命令查看信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod1.yml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete -f pod1.yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod pod-stress</span>
<span class="p">......</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>   <span class="n">Reason</span>     <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>     <span class="p">----</span>  <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Scheduled</span>  <span class="n">102s</span>  <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">pod-stress</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>  <span class="n">Pulling</span>    <span class="n">102s</span>  <span class="n">kubelet</span>            <span class="n">Pulling</span> <span class="n">image</span> <span class="s2">&quot;polinux/stress&quot;</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">83s</span>   <span class="n">kubelet</span>            <span class="n">Successfully</span> <span class="n">pulled</span> <span class="n">image</span> <span class="s2">&quot;polinux/stress&quot;</span> <span class="k">in</span> <span class="n">18</span><span class="p">.</span><span class="n">944533343s</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">83s</span>   <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">c1</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">82s</span>   <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">c1</span>
</code></pre></div>
<p><strong>说明: 可以看到第二行信息还是<code>pulling image</code>下载镜像</strong></p>
<p>2, 修改YAML</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod1.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-stress</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;150M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>                   <span class="c">#  增加了这一句</span>
</code></pre></div>
<p>3，再次删除再创建</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod pod-stress</span>
<span class="p">......</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>   <span class="n">Reason</span>     <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>     <span class="p">----</span>  <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Scheduled</span>  <span class="n">17s</span>   <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">pod-stress</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">17s</span>   <span class="n">kubelet</span>            <span class="n">Container</span> <span class="n">image</span> <span class="s2">&quot;polinux/stress&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="n">on</span> <span class="n">machine</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">17s</span>   <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">c1</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">17s</span>   <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">c1</span>
</code></pre></div>
<p><strong>说明: 第二行信息是说镜像已经存在，直接使用了</strong></p>
<h2 id="35_pod">3.5 pod的标签<a class="headerlink" href="#35_pod" title="Permanent link">&para;</a></h2>
<ul>
<li>为pod设置label,用于控制器通过label与pod关联</li>
<li>语法与前面学的node标签几乎一致</li>
</ul>
<h3 id="351_pod">3.5.1 通过命令管理Pod标签<a class="headerlink" href="#351_pod" title="Permanent link">&para;</a></h3>
<ol>
<li>查看pod的标签</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods --show-labels</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">LABELS</span>
<span class="n">pod-stress</span>     <span class="n">1</span><span class="p">/</span><span class="n">1</span>    <span class="n">Running</span>   <span class="n">0</span>          <span class="n">7m25s</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<ol>
<li>打标签,再查看</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl label pod pod-stress region=huanai zone=A env=test bussiness=game</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress</span> <span class="n">labeled</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods --show-labels</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">LABELS</span>
<span class="n">pod-stress</span>    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">8m54s</span>   <span class="n">bussiness</span><span class="p">=</span><span class="n">game</span><span class="p">,</span><span class="n">env</span><span class="p">=</span><span class="n">test</span><span class="p">,</span><span class="n">region</span><span class="p">=</span><span class="n">huanai</span><span class="p">,</span><span class="n">zone</span><span class="p">=</span><span class="n">A</span>
</code></pre></div>
<ol>
<li>通过等值关系标签查询</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -l zone=A</span>
<span class="n">NAME</span>         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod-stress</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">9m22s</span>
</code></pre></div>
<ol>
<li>通过集合关系标签查询</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -l &quot;zone in (A,B,C)&quot;</span>
<span class="n">NAME</span>         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod-stress</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">9m55s</span>
</code></pre></div>
<ol>
<li>删除标签后再验证</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl label pod pod-stress region- zone- env- bussiness-</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress</span> <span class="n">labeled</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods --show-labels</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">LABELS</span>
<span class="n">pod-stress</span>    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">16m</span>     <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>小结:</strong></p>
<ul>
<li>pod的label与node的label操作方式几乎相同</li>
<li>node的label用于pod调度到指定label的node节点</li>
<li>pod的label用于controller关联控制的pod</li>
</ul>
<h3 id="352_yamlpod">3.5.2 通过YAML创建Pod时添加标签<a class="headerlink" href="#352_yamlpod" title="Permanent link">&para;</a></h3>
<p>1, 修改yaml</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod1.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-stress</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">dev</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>              <span class="c"># 直接在原来的yaml里加上多个标签</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;150M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
</code></pre></div>
<p>2, 直接apply应用</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod1.yaml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress1</span> <span class="n">configured</span>            <span class="c"># 这里是configured,表示修改了</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods --show-labels</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">LABELS</span>
<span class="n">pod-stress</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">3m5s</span>    <span class="n">app</span><span class="p">=</span><span class="n">nginx</span><span class="p">,</span><span class="n">env</span><span class="p">=</span><span class="n">dev</span>        <span class="c"># 标签有了</span>
</code></pre></div>
<h2 id="36_pod">3.6 pod资源限制<a class="headerlink" href="#36_pod" title="Permanent link">&para;</a></h2>
<p>准备2个不同限制方式的创建pod的yaml文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod2.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Namespace</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">namespace1</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-stress2</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">namespace1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="n">limits</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;200Mi&quot;</span>
      <span class="n">requests</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;100Mi&quot;</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>                 <span class="c"># 启动容器时执行的命令</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;150M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>  <span class="c"># 产生1个进程分配150M内存1秒后释放</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod3.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Namespace</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">namespace1</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-stress3</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">namespace1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="n">limits</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;200Mi&quot;</span>
      <span class="n">requests</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;150Mi&quot;</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;250M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod2.yml</span>
<span class="n">namespace</span><span class="p">/</span><span class="n">namespace1</span> <span class="n">created</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress2</span> <span class="n">created</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod3.yml</span>
<span class="n">namespace</span><span class="p">/</span><span class="n">namespace1</span> <span class="n">unchanged</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress3</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get namespace  |grep namespace1</span>
<span class="n">namespace1</span>        <span class="n">Active</span>   <span class="n">1m28s</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -n namespace1</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>      <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod-stress2</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>     <span class="n">0</span>          <span class="n">2m2s</span>
<span class="n">pod-stress3</span>   <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">OOMKilled</span>   <span class="n">4</span>          <span class="n">115s</span>


<span class="n">查看会发现pod-stress3这个pod状态变为OOMKilled</span><span class="err">，</span><span class="n">因为它是内存不足所以显示Container被杀死</span>
</code></pre></div>
<p>说明:  一旦pod中的容器挂了，容器会有重启策略， 如下：</p>
<ul>
<li>
<p>Always：表示容器挂了总是重启，这是默认策略 </p>
</li>
<li>
<p>OnFailures：表容器状态为错误时才重启，也就是容器正常终止时才重启 </p>
</li>
<li>
<p>Never：表示容器挂了不予重启 </p>
</li>
<li>
<p>对于Always这种策略，容器只要挂了，就会立即重启，这样是很耗费资源的。所以Always重启策略是这么做的：第一次容器挂了立即重启，如果再挂了就要延时10s重启，第三次挂了就等20s重启...... 依次类推 </p>
</li>
</ul>
<p>测试完后删除</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete ns namespace1</span>
</code></pre></div>
<h2 id="37_pod">3.7 pod包含多个容器<a class="headerlink" href="#37_pod" title="Permanent link">&para;</a></h2>
<p>1, 准备yml文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod4.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-stress4</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="n">limits</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;200Mi&quot;</span>
      <span class="n">requests</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;100Mi&quot;</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;150M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>

  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c2</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">polinux</span><span class="p">/</span><span class="n">stress</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="n">limits</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;200Mi&quot;</span>
      <span class="n">requests</span><span class="p">:</span>
        <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;100Mi&quot;</span>
    <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;stress&quot;</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--vm&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;150M&quot;</span><span class="p">,</span> <span class="s2">&quot;--vm-hang&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
</code></pre></div>
<p>2, 应用yml文件创建pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod4.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-stress4</span> <span class="n">created</span>
</code></pre></div>
<p>3, 查看pod在哪个节点</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods  -o wide</span>
<span class="n">NAME</span>          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">IP</span>               <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">pod-stress4</span>   <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">70s</span>     <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">136</span>   <span class="n">k8s-master1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">可以看到有2个容器</span><span class="p">,</span><span class="n">运行在k8s-master1节点</span>
</code></pre></div>
<p>4,在k8s-master1上验证,确实产生了2个容器</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker ps -a |grep stress</span>
<span class="n">d7827a963f9d</span>        <span class="n">df58d15b053d</span>              <span class="s2">&quot;stress --vm 1 --vm-…&quot;</span>   <span class="n">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="n">Up</span> <span class="n">2</span> <span class="n">hours</span>                                      <span class="n">k8s_c2_pod-stress4_default_a534bce1</span><span class="p">-</span><span class="n">3ffe</span><span class="p">-</span><span class="n">45f5</span><span class="p">-</span><span class="n">8128</span><span class="p">-</span><span class="n">34657e289b44_0</span>
<span class="n">ae8e8f8d095b</span>        <span class="n">df58d15b053d</span>              <span class="s2">&quot;stress --vm 1 --vm-…&quot;</span>   <span class="n">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="n">Up</span> <span class="n">2</span> <span class="n">hours</span>                                      <span class="n">k8s_c1_pod-stress4_default_a534bce1</span><span class="p">-</span><span class="n">3ffe</span><span class="p">-</span><span class="n">45f5</span><span class="p">-</span><span class="n">8128</span><span class="p">-</span><span class="n">34657e289b44_0</span>
<span class="n">e66461900426</span>        <span class="n">easzlab</span><span class="p">/</span><span class="n">pause-amd64</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">2</span>   <span class="s2">&quot;/pause&quot;</span>                 <span class="n">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="n">Up</span> <span class="n">2</span> <span class="n">hours</span>                                      <span class="n">k8s_POD_pod-stress4_default_a534bce1</span><span class="p">-</span><span class="n">3ffe</span><span class="p">-</span><span class="n">45f5</span><span class="p">-</span><span class="n">8128</span><span class="p">-</span><span class="n">34657e289b44_0</span>
</code></pre></div>
<p>或</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># crictl ps</span>
<span class="n">CONTAINER</span>           <span class="n">IMAGE</span>               <span class="n">CREATED</span>             <span class="n">STATE</span>               <span class="n">NAME</span>                   <span class="n">ATTEMPT</span>             <span class="n">POD</span> <span class="n">ID</span>
<span class="n">08cd23ac9b416</span>       <span class="n">df58d15b053d1</span>       <span class="n">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="n">Running</span>             <span class="n">c2</span>                     <span class="n">0</span>                   <span class="n">2dd084491f019</span>
<span class="n">65f0ecba8dec3</span>       <span class="n">df58d15b053d1</span>       <span class="n">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="n">Running</span>             <span class="n">c1</span>                     <span class="n">0</span>                   <span class="n">2dd084491f019</span>
</code></pre></div>
<h2 id="38_pod">3.8 对pod里的容器进行操作<a class="headerlink" href="#38_pod" title="Permanent link">&para;</a></h2>
<h3 id="381">3.8.1 命令帮助<a class="headerlink" href="#381" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -h</span>
</code></pre></div>
<h3 id="382">3.8.2 不用交互直接执行命令<a class="headerlink" href="#382" title="Permanent link">&para;</a></h3>
<p>格式为: <code>kubectl exec pod名 -c 容器名 -- 命令</code></p>
<p><strong>注意:</strong> </p>
<ul>
<li>-c 容器名为可选项,如果是1个pod中1个容器,则不用指定;</li>
<li>如果是1个pod中多个容器,不指定默认为第1个。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec pod-stress4 -c c2  -- touch /111</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec pod-stress4 -c c2  -- ls /111</span>
<span class="p">/</span><span class="n">111</span>
</code></pre></div>
<p>不指定容器名,则默认为pod里的第1个容器</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec  pod-stress4  -- touch /222</span>
<span class="n">Defaulting</span> <span class="n">container</span> <span class="n">name</span> <span class="n">to</span> <span class="n">c1</span><span class="p">.</span>
<span class="n">Use</span> <span class="s1">&#39;kubectl describe pod/pod-stress4 -n default&#39;</span> <span class="n">to</span> <span class="n">see</span> <span class="n">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">containers</span> <span class="k">in</span> <span class="n">this</span> <span class="n">pod</span><span class="p">.</span>
</code></pre></div>
<h3 id="383">3.8.3 和容器交互操作<a class="headerlink" href="#383" title="Permanent link">&para;</a></h3>
<p>和docker exec几乎一样</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it pod-stress4 -c c1 -- /bin/bash</span>
<span class="n">bash</span><span class="p">-</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="c"># touch /333</span>
<span class="n">bash</span><span class="p">-</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="c"># ls</span>
<span class="n">222</span>    <span class="n">bin</span>    <span class="n">etc</span>    <span class="n">lib</span>    <span class="n">mnt</span>    <span class="n">proc</span>   <span class="n">run</span>    <span class="n">srv</span>    <span class="n">tmp</span>    <span class="n">var</span>
<span class="n">333</span>    <span class="n">dev</span>    <span class="n">home</span>   <span class="n">media</span>  <span class="n">opt</span>    <span class="n">root</span>   <span class="n">sbin</span>   <span class="n">sys</span>    <span class="n">usr</span>
<span class="n">bash</span><span class="p">-</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="c"># exit</span>
<span class="n">exit</span>       
</code></pre></div>
<h2 id="39_pod">3.9 验证pod中多个容器网络共享<a class="headerlink" href="#39_pod" title="Permanent link">&para;</a></h2>
<p>1, 编写YAML</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-nginx.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx2</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>

  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c2</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
</code></pre></div>
<p>2, 应用YAML</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-nginx.yaml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">nginx2</span> <span class="n">created</span>
</code></pre></div>
<p>3, 查看pod信息与状态</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod nginx2</span>
<span class="p">......</span>
<span class="p">......</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>   <span class="n">Reason</span>     <span class="n">Age</span>              <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>     <span class="p">----</span>             <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Scheduled</span>  <span class="n">25s</span>              <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">nginx2</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>  <span class="n">Pulling</span>    <span class="n">24s</span>              <span class="n">kubelet</span>            <span class="n">Pulling</span> <span class="n">image</span> <span class="s2">&quot;nginx:1.15-alpine&quot;</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">5s</span>               <span class="n">kubelet</span>            <span class="n">Successfully</span> <span class="n">pulled</span> <span class="n">image</span> <span class="s2">&quot;nginx:1.15-alpine&quot;</span> <span class="k">in</span> <span class="n">18</span><span class="p">.</span><span class="n">928009025s</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">5s</span>               <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">c1</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">5s</span>               <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">c1</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">2s</span> <span class="p">(</span><span class="n">x2</span> <span class="n">over</span> <span class="n">5s</span><span class="p">)</span>  <span class="n">kubelet</span>            <span class="n">Container</span> <span class="n">image</span> <span class="s2">&quot;nginx:1.15-alpine&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="n">on</span> <span class="n">machine</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">2s</span> <span class="p">(</span><span class="n">x2</span> <span class="n">over</span> <span class="n">5s</span><span class="p">)</span>  <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">c2</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">2s</span> <span class="p">(</span><span class="n">x2</span> <span class="n">over</span> <span class="n">5s</span><span class="p">)</span>  <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">c2</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods |grep nginx2</span>
<span class="n">nginx2</span>   <span class="n">1</span><span class="p">/</span><span class="n">2</span>     <span class="n">CrashLoopBackOff</span>   <span class="n">3</span>          <span class="n">2m40s</span>
<span class="n">有一个启不来</span><span class="err">，</span><span class="n">因为一个容器中两个pod是共用网络的</span><span class="err">，</span><span class="n">所以不能两个都占用80端口</span>
</code></pre></div>
<p>有一个启不来，因为一个pod中两个容器是共用网络的，所以不能两个都占用80端口</p>
<p>通过查找<code>k8s-worker1</code>上面的容器，然后<code>docker logs或crictl logs containerID</code>查看，得到如下的报错，说明是端口被占用</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker1</span> <span class="p">~]</span><span class="c"># docker logs k8s_c2_nginx2_default_51fd8e81-1c4b-4557-9498-9b25ed8a4c99_4</span>
<span class="n">2020</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">21</span> <span class="n">04</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">12</span> <span class="no">[emerg]</span> <span class="n">1</span><span class="c">#1: bind() to 0.0.0.0:80 failed (98: Address in use)</span>
<span class="n">nginx</span><span class="p">:</span> <span class="no">[emerg]</span> <span class="n">bind</span><span class="p">()</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">80</span> <span class="n">failed</span> <span class="p">(</span><span class="n">98</span><span class="p">:</span> <span class="n">Address</span> <span class="k">in</span> <span class="n">use</span><span class="p">)</span>
<span class="n">2020</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">21</span> <span class="n">04</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">12</span> <span class="no">[emerg]</span> <span class="n">1</span><span class="c">#1: bind() to 0.0.0.0:80 failed (98: Address in use)</span>
<span class="n">nginx</span><span class="p">:</span> <span class="no">[emerg]</span> <span class="n">bind</span><span class="p">()</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">80</span> <span class="n">failed</span> <span class="p">(</span><span class="n">98</span><span class="p">:</span> <span class="n">Address</span> <span class="k">in</span> <span class="n">use</span><span class="p">)</span>
<span class="n">2020</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">21</span> <span class="n">04</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">12</span> <span class="no">[emerg]</span> <span class="n">1</span><span class="c">#1: bind() to 0.0.0.0:80 failed (98: Address in use)</span>
<span class="n">nginx</span><span class="p">:</span> <span class="no">[emerg]</span> <span class="n">bind</span><span class="p">()</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">80</span> <span class="n">failed</span> <span class="p">(</span><span class="n">98</span><span class="p">:</span> <span class="n">Address</span> <span class="k">in</span> <span class="n">use</span><span class="p">)</span>
<span class="n">2020</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">21</span> <span class="n">04</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">12</span> <span class="no">[emerg]</span> <span class="n">1</span><span class="c">#1: bind() to 0.0.0.0:80 failed (98: Address in use)</span>
<span class="n">nginx</span><span class="p">:</span> <span class="no">[emerg]</span> <span class="n">bind</span><span class="p">()</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">80</span> <span class="n">failed</span> <span class="p">(</span><span class="n">98</span><span class="p">:</span> <span class="n">Address</span> <span class="k">in</span> <span class="n">use</span><span class="p">)</span>
<span class="n">2020</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">21</span> <span class="n">04</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">12</span> <span class="no">[emerg]</span> <span class="n">1</span><span class="c">#1: bind() to 0.0.0.0:80 failed (98: Address in use)</span>
<span class="n">nginx</span><span class="p">:</span> <span class="no">[emerg]</span> <span class="n">bind</span><span class="p">()</span> <span class="n">to</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">80</span> <span class="n">failed</span> <span class="p">(</span><span class="n">98</span><span class="p">:</span> <span class="n">Address</span> <span class="k">in</span> <span class="n">use</span><span class="p">)</span>
<span class="n">2020</span><span class="p">/</span><span class="n">11</span><span class="p">/</span><span class="n">21</span> <span class="n">04</span><span class="p">:</span><span class="n">29</span><span class="p">:</span><span class="n">12</span> <span class="no">[emerg]</span> <span class="n">1</span><span class="c">#1: still could not bind()</span>
<span class="n">nginx</span><span class="p">:</span> <span class="no">[emerg]</span> <span class="n">still</span> <span class="n">could</span> <span class="n">not</span> <span class="n">bind</span><span class="p">()</span>
</code></pre></div>
<h1 id="pod_2">四、pod调度<a class="headerlink" href="#pod_2" title="Permanent link">&para;</a></h1>
<h2 id="41_pod">4.1 pod调度流程<a class="headerlink" href="#41_pod" title="Permanent link">&para;</a></h2>
<p><img alt="1564985023369" src="../../../img/kubernetes/kubernetes_core/pod%E8%B0%83%E5%BA%A6.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">Step1</span>
<span class="n">通过kubectl命令应用资源清单文件</span><span class="err">（</span><span class="n">yaml格式</span><span class="err">）</span><span class="n">向api</span> <span class="n">server</span> <span class="n">发起一个create</span> <span class="n">pod</span> <span class="n">请求</span>

<span class="n">Step2</span>
<span class="n">api</span> <span class="n">server接收到pod创建请求后</span><span class="err">，</span><span class="n">生成一个包含创建信息资源清单文件</span>

<span class="n">Step3</span>
<span class="n">apiserver</span> <span class="n">将资源清单文件中信息写入etcd数据库</span>

<span class="n">Step4</span>
<span class="n">Scheduler启动后会一直watch</span> <span class="n">API</span> <span class="n">Server</span><span class="err">，</span><span class="n">获取</span> <span class="n">podSpec</span><span class="p">.</span><span class="n">NodeName为空的Pod</span><span class="p">,</span><span class="n">即判断pod</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">Node</span> <span class="p">==</span> <span class="n">null</span><span class="p">?</span> <span class="n">若为null</span><span class="err">，</span><span class="n">表示这个Pod请求是新的</span><span class="err">，</span><span class="n">需要创建</span><span class="err">，</span><span class="n">因此先进行调度计算</span><span class="err">（</span><span class="n">共计2步</span><span class="err">：</span><span class="n">1</span><span class="err">、</span><span class="n">过滤不满足条件的</span><span class="err">，</span><span class="n">2</span><span class="err">、</span><span class="n">选择优先级高的</span><span class="err">），</span><span class="n">找到合适的node</span><span class="err">，</span><span class="n">然后将信息在etcd数据库中更新分配结果</span><span class="err">：</span><span class="n">pod</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">Node</span> <span class="p">=</span> <span class="n">nodeA</span> <span class="p">(</span><span class="n">设置一个具体的节点</span><span class="p">)</span>

<span class="n">Step5</span>
<span class="n">kubelet</span> <span class="n">通过watch</span> <span class="n">etcd数据库</span><span class="p">(</span><span class="n">即不停地看etcd中的记录</span><span class="p">)</span><span class="err">，</span><span class="n">发现有新的Node出现</span><span class="err">，</span><span class="n">如果这条记录中的Node与所在节点编号相同</span><span class="err">，</span><span class="n">即这个Pod由scheduler分配给自己</span><span class="err">，</span><span class="n">则调用node中的Container</span> <span class="n">Runtime</span><span class="err">，</span><span class="n">进而创建container</span><span class="err">，</span><span class="n">并将创建后的结果返回到给api</span> <span class="n">server用于更新etcd数据库中数据状态</span><span class="err">。</span>
</code></pre></div>
<h2 id="42">4.2 调度约束方法<a class="headerlink" href="#42" title="Permanent link">&para;</a></h2>
<p>我们为了实现容器主机资源平衡使用, 可以使用约束把pod调度到指定的node节点</p>
<ul>
<li>nodeName 用于将pod调度到指定的node名称上</li>
<li>nodeSelector 用于将pod调度到匹配Label的node上</li>
</ul>
<h3 id="421_nodename">4.2.1  nodeName<a class="headerlink" href="#421_nodename" title="Permanent link">&para;</a></h3>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-nodename.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-nodename</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeName</span><span class="p">:</span> <span class="n">k8s-worker1</span>                    <span class="c"># 通过nodeName调度到k8s-worker1节点</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
</code></pre></div>
<p>2, 应用YAML文件创建pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-nodename.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-nodename</span> <span class="n">created</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod pod-nodename |tail -6</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>   <span class="n">Reason</span>   <span class="n">Age</span>    <span class="n">From</span>     <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>   <span class="p">----</span>   <span class="p">----</span>     <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>   <span class="n">2m47s</span>  <span class="n">kubelet</span>  <span class="n">Container</span> <span class="n">image</span> <span class="s2">&quot;nginx:1.15-alpine&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="n">on</span> <span class="n">machine</span>
  <span class="n">Normal</span>  <span class="n">Created</span>  <span class="n">2m47s</span>  <span class="n">kubelet</span>  <span class="n">Created</span> <span class="n">container</span> <span class="n">nginx</span>
  <span class="n">Normal</span>  <span class="n">Started</span>  <span class="n">2m47s</span>  <span class="n">kubelet</span>  <span class="n">Started</span> <span class="n">container</span> <span class="n">nginx</span>

<span class="n">倒数第3行没有使用scheduler</span><span class="p">,</span><span class="n">而是直接给运行了</span><span class="p">,</span><span class="n">说明nodeName约束生效</span>
</code></pre></div>
<h3 id="422_nodeselector">4.2.2 nodeSelector<a class="headerlink" href="#422_nodeselector" title="Permanent link">&para;</a></h3>
<p>1, 为k8s-worker1打标签</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl label nodes k8s-worker1 bussiness=game</span>
<span class="n">node</span><span class="p">/</span><span class="n">k8s-worker1</span> <span class="n">labeled</span>
</code></pre></div>
<p>2, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-nodeselector.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pod-nodeselect</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeSelector</span><span class="p">:</span>                         <span class="c"># nodeSelector节点选择器</span>
    <span class="n">bussiness</span><span class="p">:</span> <span class="n">game</span>                     <span class="c"># 指定调度到标签为bussiness=game的节点</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
</code></pre></div>
<p>3,  应用YAML文件创建pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-nodeselector.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">pod-nodeselect</span> <span class="n">created</span>
</code></pre></div>
<p>4, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod pod-nodeselect |tail -6</span>
 <span class="nb">Type </span>   <span class="n">Reason</span>     <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>     <span class="p">----</span>  <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Scheduled</span>  <span class="n">20s</span>   <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">pod-nodeselect</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">19s</span>   <span class="n">kubelet</span>            <span class="n">Container</span> <span class="n">image</span> <span class="s2">&quot;nginx:1.15-alpine&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="n">on</span> <span class="n">machine</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">19s</span>   <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">nginx</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">19s</span>   <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">nginx</span>

<span class="n">仍然经过了scheduler</span><span class="p">,</span><span class="n">但确实分配到了</span> <span class="n">k8s-worker1上</span>
</code></pre></div>
<p>有兴趣可以再删除后再创建,重复几次验证</p>
<h1 id="pod_3">五、pod的生命周期<a class="headerlink" href="#pod_3" title="Permanent link">&para;</a></h1>
<h2 id="51_pod">5.1 Pod生命周期<a class="headerlink" href="#51_pod" title="Permanent link">&para;</a></h2>
<ul>
<li>有些pod(比如运行httpd服务),正常情况下会一直运行中,但如果手动删除它,此pod会终止</li>
<li>也有些pod(比如执行计算任务)，任务计算完后就会自动终止</li>
</ul>
<p>上面两种场景中,pod从创建到终止的过程就是pod的生命周期。</p>
<p><img alt="" src="../../../img/kubernetes/kubernetes_core/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" /></p>
<h3 id="511">5.1.1 容器启动<a class="headerlink" href="#511" title="Permanent link">&para;</a></h3>
<ol>
<li>pod中的容器在创建前,有初始化容器(init container)来进行初始化环境</li>
<li>
<p>初化完后,主容器(main container)开始启动</p>
</li>
<li>
<p>主容器启动后,有一个**post start**的操作(启动后的触发型操作,或者叫启动后钩子)</p>
</li>
<li>
<p>post start后,就开始做健康检查</p>
</li>
<li>
<p>第一个健康检查叫存活状态检查(liveness probe )，用来检查主容器存活状态的</p>
</li>
<li>
<p>第二个健康检查叫准备就绪检查(readiness probe)，用来检查主容器是否启动就绪</p>
</li>
</ol>
<h3 id="512">5.1.2 容器终止<a class="headerlink" href="#512" title="Permanent link">&para;</a></h3>
<ol>
<li>可以在容器终止前设置**pre stop**操作(终止前的触发型操作,或者叫终止前钩子)</li>
<li>当出现特殊情况不能正常销毁pod时,大概等待30秒会强制终止</li>
<li>终止容器后还可能会重启容器(视容器重启策略而定)。</li>
</ol>
<h3 id="513">5.1.3 回顾容器重启策略<a class="headerlink" href="#513" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Always：表示容器挂了总是重启，这是默认策略 </p>
</li>
<li>
<p>OnFailures：表示容器状态为错误时才重启，也就是容器正常终止时不重启 </p>
</li>
<li>
<p>Never：表示容器挂了不予重启 </p>
</li>
<li>
<p>对于Always这种策略，容器只要挂了，就会立即重启，这样是很耗费资源的。所以Always重启策略是这么做的：第一次容器挂了立即重启，如果再挂了就要延时10s重启，第三次挂了就等20s重启...... 依次类推 </p>
</li>
</ul>
<h2 id="52_healthcheck">5.2 HealthCheck健康检查<a class="headerlink" href="#52_healthcheck" title="Permanent link">&para;</a></h2>
<p>当Pod启动时，容器可能会因为某种错误(服务未启动或端口不正确)而无法访问等。</p>
<h3 id="521_health_check">5.2.1 Health Check方式<a class="headerlink" href="#521_health_check" title="Permanent link">&para;</a></h3>
<p>kubelet拥有两个检测器，它们分别对应不同的触发器(根据触发器的结构执行进一步的动作)</p>
<table>
<thead>
<tr>
<th>方式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Liveness Probe(存活状态探测)</td>
<td>指示容器是否正在运行。如果存活态探测失败，则 kubelet 会杀死容器， 并且容器将根据其<a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">重启策略</a>决定未来。如果容器不提供存活探针， 则默认状态为 <code>Success</code>。</td>
</tr>
<tr>
<td>readiness Probe(就绪型探测)</td>
<td>指示容器是否准备好为请求提供服务。如果就绪态探测失败， 端点控制器将从与 Pod 匹配的所有服务的端点列表中删除该 Pod 的 IP 地址。 初始延迟之前的就绪态的状态值默认为 <code>Failure</code>。 如果容器不提供就绪态探针，则默认状态为 <code>Success</code>。注：检查后不健康，将容器设置为Notready;如果使用service来访问,流量不会转发给此种状态的pod</td>
</tr>
<tr>
<td>startup Probe</td>
<td>指示容器中的应用是否已经启动。如果提供了启动探针，则所有其他探针都会被 禁用，直到此探针成功为止。如果启动探测失败，<code>kubelet</code> 将杀死容器，而容器依其 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">重启策略</a>进行重启。 如果容器没有提供启动探测，则默认状态为 <code>Success</code>。</td>
</tr>
</tbody>
</table>
<h3 id="522_probe">5.2.2 Probe探测方式<a class="headerlink" href="#522_probe" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>方式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Exec</td>
<td>执行命令</td>
</tr>
<tr>
<td>HTTPGet</td>
<td>http请求某一个URL路径</td>
</tr>
<tr>
<td>TCP</td>
<td>tcp连接某一个端口</td>
</tr>
<tr>
<td>gRPC</td>
<td>使用 <a href="https://grpc.io/">gRPC</a> 执行一个远程过程调用。 目标应该实现 <a href="https://grpc.io/grpc/core/md_doc_health-checking.html">gRPC健康检查</a>。 如果响应的状态是 "SERVING"，则认为诊断成功。 gRPC 探针是一个 alpha 特性，只有在你启用了 "GRPCContainerProbe" <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/feature-gate/">特性门控</a>时才能使用。</td>
</tr>
</tbody>
</table>
<h3 id="523_liveness-exec">5.2.3 liveness-exec案例<a class="headerlink" href="#523_liveness-exec" title="Permanent link">&para;</a></h3>
<p>1, 准备YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-liveness-exec.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">liveness-exec</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">liveness</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">busybox</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">args</span><span class="p">:</span>
    <span class="p">-</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">sh</span>
    <span class="p">-</span> <span class="n">-c</span>
    <span class="p">-</span> <span class="n">touch</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span><span class="p">;</span> <span class="nb">sleep </span><span class="n">30</span><span class="p">;</span> <span class="nb">rm </span><span class="n">-rf</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span><span class="p">;</span> <span class="nb">sleep </span><span class="n">600</span>
    <span class="n">livenessProbe</span><span class="p">:</span>
      <span class="n">exec</span><span class="p">:</span>
        <span class="n">command</span><span class="p">:</span>
        <span class="p">-</span> <span class="nb">cat</span>
        <span class="p">-</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">5</span>                <span class="c"># pod启动延迟5秒后探测</span>
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">5</span>                      <span class="c"># 每5秒探测1次</span>
</code></pre></div>
<p>2, 应用YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-liveness-exec.yml</span>
</code></pre></div>
<p>3, 通过下面的命令观察</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod liveness-exec</span>
<span class="p">......</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>    <span class="n">Reason</span>     <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>     <span class="p">------</span>     <span class="p">----</span>  <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>   <span class="n">Scheduled</span>  <span class="n">40s</span>   <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">liveness-exec</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>   <span class="n">Pulled</span>     <span class="n">38s</span>   <span class="n">kubelet</span>    <span class="n">Container</span> <span class="n">image</span> <span class="s2">&quot;busybox&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="n">on</span> <span class="n">machine</span>
  <span class="n">Normal</span>   <span class="n">Created</span>    <span class="n">37s</span>   <span class="n">kubelet</span>     <span class="n">Created</span> <span class="n">container</span> <span class="n">liveness</span>
  <span class="n">Normal</span>   <span class="n">Started</span>    <span class="n">37s</span>   <span class="n">kubelet</span>     <span class="n">Started</span> <span class="n">container</span> <span class="n">liveness</span>
  <span class="n">Warning</span>  <span class="n">Unhealthy</span>  <span class="n">3s</span>    <span class="n">kubelet</span>     <span class="n">Liveness</span> <span class="n">probe</span> <span class="n">failed</span><span class="p">:</span> <span class="n">cat</span><span class="p">:</span> <span class="n">can</span><span class="s1">&#39;t open &#39;</span><span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span><span class="err">&#39;</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>

<span class="n">看到40s前被调度以k8s-worker1节点</span><span class="p">,</span><span class="n">3s前健康检查出问题</span>
</code></pre></div>
<p>4, 过几分钟再观察</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod liveness-exec</span>
<span class="p">......</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>    <span class="n">Reason</span>     <span class="n">Age</span>                  <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>     <span class="p">------</span>     <span class="p">----</span>                 <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>   <span class="n">Scheduled</span>  <span class="n">3m42s</span>                <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">liveness-exec</span> <span class="n">to</span> <span class="n">k8s-worker1</span>
  <span class="n">Normal</span>   <span class="n">Pulled</span>     <span class="n">70s</span> <span class="p">(</span><span class="n">x3</span> <span class="n">over</span> <span class="n">3m40s</span><span class="p">)</span>  <span class="n">kubelet</span>     <span class="n">Container</span> <span class="n">image</span> <span class="s2">&quot;busybox&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="n">on</span> <span class="n">machine</span>
  <span class="n">Normal</span>   <span class="n">Created</span>    <span class="n">70s</span> <span class="p">(</span><span class="n">x3</span> <span class="n">over</span> <span class="n">3m39s</span><span class="p">)</span>  <span class="n">kubelet</span>     <span class="n">Created</span> <span class="n">container</span> <span class="n">liveness</span>
  <span class="n">Normal</span>   <span class="n">Started</span>    <span class="n">69s</span> <span class="p">(</span><span class="n">x3</span> <span class="n">over</span> <span class="n">3m39s</span><span class="p">)</span>  <span class="n">kubelet</span>     <span class="n">Started</span> <span class="n">container</span> <span class="n">liveness</span>
  <span class="n">Warning</span>  <span class="n">Unhealthy</span>  <span class="n">26s</span> <span class="p">(</span><span class="n">x9</span> <span class="n">over</span> <span class="n">3m5s</span><span class="p">)</span>   <span class="n">kubelet</span>     <span class="n">Liveness</span> <span class="n">probe</span> <span class="n">failed</span><span class="p">:</span> <span class="n">cat</span><span class="p">:</span> <span class="n">can</span><span class="s1">&#39;t open &#39;</span><span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span><span class="err">&#39;</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
  <span class="n">Normal</span>   <span class="n">Killing</span>    <span class="n">26s</span> <span class="p">(</span><span class="n">x3</span> <span class="n">over</span> <span class="n">2m55s</span><span class="p">)</span>  <span class="n">kubelet</span>     <span class="n">Container</span> <span class="n">liveness</span> <span class="n">failed</span> <span class="n">liveness</span> <span class="n">probe</span><span class="p">,</span> <span class="n">will</span> <span class="n">be</span> <span class="n">restarted</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">liveness-exec</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">3</span>          <span class="n">4m12s</span>

<span class="n">看到重启3次</span><span class="p">,</span><span class="n">慢慢地重启间隔时间会越来越长</span>
</code></pre></div>
<h3 id="_1">拓展: 容器重启策略验证<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">liveness-exec</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">restartPolicy</span><span class="p">:</span> <span class="n">Never</span>                  <span class="c"># 把容器重启策略由默认的always改为Never</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">liveness</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">busybox</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">args</span><span class="p">:</span>
    <span class="p">-</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">sh</span>
    <span class="p">-</span> <span class="n">-c</span>
    <span class="p">-</span> <span class="n">touch</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span><span class="p">;</span> <span class="nb">sleep </span><span class="n">30</span><span class="p">;</span> <span class="nb">rm </span><span class="n">-rf</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span><span class="p">;</span> <span class="nb">sleep </span><span class="n">600</span>
    <span class="n">livenessProbe</span><span class="p">:</span>
      <span class="n">exec</span><span class="p">:</span>
        <span class="n">command</span><span class="p">:</span>
        <span class="p">-</span> <span class="nb">cat</span>
        <span class="p">-</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">healthy</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">5</span>                         
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">5</span>                                 
</code></pre></div>
<p>请自行验证</p>
<p>验证结果为:</p>
<ul>
<li>容器健康检查出现问题后，不再重启，也不会继续sleep 600秒，而是直接关闭了</li>
</ul>
<h3 id="524_liveness-httpget">5.2.4  liveness-httpget案例<a class="headerlink" href="#524_liveness-httpget" title="Permanent link">&para;</a></h3>
<p>1, 编写YMAL文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-liveness-httpget.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">liveness-httpget</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">liveness</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">ports</span><span class="p">:</span>                              <span class="c"># 指定容器端口，这一段不写也行，端口由镜像决定 </span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>                        <span class="c"># 自定义名称，不需要与下面的port: http对应</span>
      <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>                 <span class="c"># 类似dockerfile里的expose 80</span>
    <span class="n">livenessProbe</span><span class="p">:</span>
      <span class="n">httpGet</span><span class="p">:</span>                          <span class="c"># 使用httpGet方式</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">http</span>                      <span class="c"># http协议,也可以直接写80端口</span>
        <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>               <span class="c"># 探测家目录下的index.html</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">3</span>            <span class="c"># 延迟3秒开始探测</span>
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">5</span>                  <span class="c"># 每隔5s钟探测一次</span>
</code></pre></div>
<p>2, 应用YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-liveness-httpget.yml</span>
</code></pre></div>
<p>3, 验证查看</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>               <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">liveness-httpget</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">9s</span>
</code></pre></div>
<p>4, 交互删除nginx里的主页文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it liveness-httpget -- rm -rf /usr/share/nginx/html/index.html</span>
</code></pre></div>
<p>5, 验证查看会发现</p>
<p><img alt="1564975961146" src="../../../img/kubernetes/kubernetes_core/liveness-httpget.png" /></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>               <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">liveness-httpget</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">1</span>          <span class="n">11m</span>

<span class="n">只restart一次</span>
</code></pre></div>
<h3 id="525_liveness-tcp">5.2.5  liveness-tcp案例<a class="headerlink" href="#525_liveness-tcp" title="Permanent link">&para;</a></h3>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-liveness-tcp.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">liveness-tcp</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">liveness</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">livenessProbe</span><span class="p">:</span>
      <span class="n">tcpSocket</span><span class="p">:</span>                        <span class="c"># 使用tcp连接方式</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">80</span>                        <span class="c"># 连接80端口进行探测</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">3</span>
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">5</span>
</code></pre></div>
<p>2, 应用YAML文件创建pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-liveness-tcp.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">liveness-tcp</span> <span class="n">created</span>
</code></pre></div>
<p>3, 查看验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>               <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">liveness-tcp</span>       <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">14s</span>
</code></pre></div>
<p>4, 交互关闭nginx</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it liveness-tcp -- /usr/sbin/nginx -s stop</span>
</code></pre></div>
<p>5, 再次验证查看</p>
<p><img alt="1564976660465" src="../../../img/kubernetes/kubernetes_core/liveness-tcp.png" /></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>               <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">liveness-tcp</span>       <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">1</span>          <span class="n">5m13s</span>

<span class="n">也只重启1次</span><span class="p">,</span><span class="n">重启后重新初始化了</span>
</code></pre></div>
<h3 id="526_readiness">5.2.6 readiness案例<a class="headerlink" href="#526_readiness" title="Permanent link">&para;</a></h3>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-readiness-httpget.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">readiness-httpget</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">readiness</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">readinessProbe</span><span class="p">:</span>                     <span class="c"># 这里由liveness换成了readiness</span>
      <span class="n">httpGet</span><span class="p">:</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">http</span>
        <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">3</span>
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">5</span>
</code></pre></div>
<p>2, 应用YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-readiness-httpget.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">readiness-httpget</span> <span class="n">created</span>
</code></pre></div>
<p>3, 验证查看</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">readiness-httpget</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">10s</span>
</code></pre></div>
<p>4, 交互删除nginx主页</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it readiness-httpget -- rm -rf /usr/share/nginx/html/index.html</span>
</code></pre></div>
<p>5, 再次验证</p>
<p><img alt="1564978173894" src="../../../img/kubernetes/kubernetes_core/readiness-httpget.png" /></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">readiness-httpget</span>   <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m49s</span>

<span class="n">READY状态为0</span><span class="p">/</span><span class="n">1</span>
</code></pre></div>
<p>6, 交互创建nginx主页文件再验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it readiness-httpget -- touch /usr/share/nginx/html/index.html</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">readiness-httpget</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">3m10s</span>

<span class="n">READY状态又为1</span><span class="p">/</span><span class="n">1了</span>
</code></pre></div>
<h3 id="527_readinessliveness">5.2.7 readiness+liveness综合案例<a class="headerlink" href="#527_readinessliveness" title="Permanent link">&para;</a></h3>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-readiness-liveiness.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">readiness-liveness-httpget</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">readiness-liveness</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">livenessProbe</span><span class="p">:</span>
      <span class="n">httpGet</span><span class="p">:</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">http</span>
        <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">1</span>
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">3</span>
    <span class="n">readinessProbe</span><span class="p">:</span>
      <span class="n">httpGet</span><span class="p">:</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">http</span>
        <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>
      <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">5</span>
      <span class="n">periodSeconds</span><span class="p">:</span> <span class="n">5</span>
</code></pre></div>
<p>2, 应用YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-readiness-liveiness.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">readiness-liveness-httpget</span> <span class="n">created</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod |grep readiness-liveness-httpget</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">readiness-liveness-httpget</span>   <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">6s</span>
</code></pre></div>
<h2 id="53_post-start">5.3 post-start<a class="headerlink" href="#53_post-start" title="Permanent link">&para;</a></h2>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim pod-poststart.yml</span>

<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">poststart</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">poststart</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">lifecycle</span><span class="p">:</span>                                       <span class="c"># 生命周期事件</span>
      <span class="n">postStart</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">:</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mkdir&quot;</span><span class="p">,</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span><span class="s2">&quot;/usr/share/nginx/html/haha&quot;</span><span class="p">]</span>
</code></pre></div>
<p>2, 应用YMAL文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f pod-poststart.yml</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">poststart</span>                    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">25s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it poststart -- ls /usr/share/nginx/html -l</span>
<span class="n">total</span> <span class="n">8</span>
<span class="n">-rw-r</span><span class="p">-</span><span class="n">-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">494</span> <span class="n">Apr</span> <span class="n">16</span> <span class="n">13</span><span class="p">:</span><span class="n">08</span> <span class="n">50x</span><span class="p">.</span><span class="n">html</span>
<span class="n">drwxr-xr-x</span> <span class="n">2</span> <span class="n">root</span> <span class="n">root</span>   <span class="n">6</span> <span class="n">Aug</span>  <span class="n">5</span> <span class="n">05</span><span class="p">:</span><span class="n">33</span> <span class="n">haha</span>            <span class="n">有创建此目录</span>
<span class="n">-rw-r</span><span class="p">-</span><span class="n">-r</span><span class="p">--</span> <span class="n">1</span> <span class="n">root</span> <span class="n">root</span> <span class="n">612</span> <span class="n">Apr</span> <span class="n">16</span> <span class="n">13</span><span class="p">:</span><span class="n">08</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>
</code></pre></div>
<h2 id="54_pre-stop">5.4 pre-stop<a class="headerlink" href="#54_pre-stop" title="Permanent link">&para;</a></h2>
<p>容器终止前执行的命令</p>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim prestop.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">prestop</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">prestop</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
    <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
    <span class="n">lifecycle</span><span class="p">:</span>                                       <span class="c"># 生命周期事件</span>
      <span class="n">preStop</span><span class="p">:</span>                                       <span class="c"># preStop</span>
        <span class="n">exec</span><span class="p">:</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="s2">&quot;sleep 60000000&quot;</span><span class="p">]</span>     <span class="c"># 容器终止前sleep 60000000秒</span>
</code></pre></div>
<p>2, 应用YAML文件创建pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f prestop.yml</span>
<span class="n">pod</span><span class="p">/</span><span class="n">prestop</span> <span class="n">created</span>
</code></pre></div>
<p>3, 删除pod验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete -f prestop.yml</span>
<span class="n">pod</span> <span class="s2">&quot;prestop&quot;</span> <span class="n">deleted</span>       <span class="n">会在这一步等待一定的时间</span><span class="p">(</span><span class="n">大概30s</span><span class="p">-</span><span class="n">60s左右</span><span class="p">)</span><span class="n">才能删除</span><span class="p">,</span><span class="n">说明验证成功</span>
</code></pre></div>
<p><strong>结论:</strong> 当出现特殊情况不能正常销毁pod时,大概等待30秒会强制终止</p>
<h2 id="55_pod">5.5 pod故障排除<a class="headerlink" href="#55_pod" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pending（悬决）</td>
<td>Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</td>
</tr>
<tr>
<td>Running（运行中）</td>
<td>pod已经绑定到一个节点，并且已经创建了所有容器。至少有一个容器正在运行中，或正在启动或重新启动。</td>
</tr>
<tr>
<td>completed（完成）</td>
<td>Pod中的所有容器都已成功终止，不会重新启动。</td>
</tr>
<tr>
<td>Failed（失败）</td>
<td>Pod的所有容器均已终止，且至少有一个容器已在故障中终止。也就是说，容器要么以非零状态退出，要么被系统终止。</td>
</tr>
<tr>
<td>Unknown（未知）</td>
<td>由于某种原因apiserver无法获得Pod的状态，通常是由于Master与Pod所在主机kubelet通信时出错。</td>
</tr>
<tr>
<td>CrashLoopBackOff</td>
<td>多见于CMD语句错误或者找不到container入口语句导致了快速退出,可以用kubectl logs 查看日志进行排错</td>
</tr>
</tbody>
</table>
<ul>
<li>kubectl describe pod  pod名</li>
<li>kubectl logs pod  [-c CONTAINER]</li>
<li>kubectl exec POD [-c CONTAINER] --COMMAND [args...]</li>
</ul>
<h1 id="kubernetes_controller">kubernetes核心概念 Controller<a class="headerlink" href="#kubernetes_controller" title="Permanent link">&para;</a></h1>
<h1 id="podcontroller">一、pod控制器controller<a class="headerlink" href="#podcontroller" title="Permanent link">&para;</a></h1>
<h2 id="11_controller">1.1 Controller作用及分类<a class="headerlink" href="#11_controller" title="Permanent link">&para;</a></h2>
<p>controller用于控制pod</p>
<p>参考: <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/">https://kubernetes.io/zh/docs/concepts/workloads/controllers/</a></p>
<p><img alt="1564844640416" src="../../../img/kubernetes/kubernetes_core/work_load.png" /></p>
<p>控制器主要分为:</p>
<ul>
<li>Deployments   部署无状态应用，控制pod升级,回退</li>
<li>ReplicaSet       副本集,控制pod扩容,裁减</li>
<li>ReplicationController(相当于ReplicaSet的老版本,现在建议使用Deployments加ReplicaSet替代RC)</li>
<li>StatefulSets     部署有状态应用，结合Service、存储等实现对有状态应用部署</li>
<li>DaemonSet     守护进程集，运行在所有集群节点(包括master), 比如使用filebeat,node_exporter</li>
<li>Jobs                  一次性</li>
<li>Cronjob            周期性</li>
</ul>
<h2 id="12_deployment">1.2 Deployment<a class="headerlink" href="#12_deployment" title="Permanent link">&para;</a></h2>
<h3 id="121_replicaset">1.2.1 Replicaset控制器的功能<a class="headerlink" href="#121_replicaset" title="Permanent link">&para;</a></h3>
<ul>
<li>支持新的基于集合的selector(以前的rc里没有这种功能)</li>
<li>通过改变Pod副本数量实现Pod的扩容和缩容</li>
</ul>
<h3 id="122_deployment">1.2.2 Deployment控制器的功能<a class="headerlink" href="#122_deployment" title="Permanent link">&para;</a></h3>
<ul>
<li>Deployment集成了上线部署、滚动升级、创建副本、回滚等功能</li>
<li>Deployment里包含并使用了ReplicaSet</li>
</ul>
<h3 id="123_deployment">1.2.3 Deployment用于部署无状态应用<a class="headerlink" href="#123_deployment" title="Permanent link">&para;</a></h3>
<p>无状态应用的特点:</p>
<ul>
<li>所有pod无差别</li>
<li>所有pod中容器运行同一个image</li>
<li>所有pod可以运行在集群中任意node上</li>
<li>所有pod无启动顺序先后之分</li>
<li>随意pod数量扩容或缩容</li>
<li>例如简单运行一个静态web程序</li>
</ul>
<h3 id="124_deployment">1.2.4 创建deployment类型应用<a class="headerlink" href="#124_deployment" title="Permanent link">&para;</a></h3>
<p>1, 准备YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim deployment-nginx.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">deploy-nginx</span>            <span class="c"># deployment名</span>
<span class="n">spec</span><span class="p">:</span>               
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>                   <span class="c"># 副本集,deployment里使用了replicaset</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>                <span class="c"># 匹配的pod标签,表示deployment和rs控制器控制带有此标签的pod</span>
  <span class="n">template</span><span class="p">:</span>                     <span class="c"># 代表pod的配置模板</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>              <span class="c"># pod的标签</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>               <span class="c"># 以下为pod里的容器定义</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
</code></pre></div>
<p>2, 应用YAML文件创建deployment</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f deployment-nginx.yml</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">created</span>
</code></pre></div>
<p>3, 查看验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get deployment                # deployment可简写成depoly</span>
<span class="n">NAME</span>           <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">deploy-nginx</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">1</span>            <span class="n">1</span>           <span class="n">19s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69-pbc2h</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">75s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get replicasets               # replicasets可简写成rs</span>
<span class="n">NAME</span>                      <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69</span>   <span class="n">1</span>         <span class="n">1</span>         <span class="n">1</span>       <span class="n">2m6s</span>
</code></pre></div>
<h3 id="125_deployment">1.2.5 访问deployment<a class="headerlink" href="#125_deployment" title="Permanent link">&para;</a></h3>
<p>1,查看pod的IP地址</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>               <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6</span><span class="p">-</span><span class="n">88nr8</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">39s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">155</span>   <span class="n">k8s-master1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

<span class="n">pod在k8s-master1节点</span><span class="p">,</span><span class="n">pod的IP为10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">155</span>
</code></pre></div>
<p>2, 查看所有集群节点的网卡</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># ifconfig tunl0 |head -2</span>
<span class="n">tunl0</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">193</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">NOARP</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1480</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">128</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master2</span> <span class="p">~]</span><span class="c"># ifconfig tunl0 |head -2</span>
<span class="n">tunl0</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">193</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">NOARP</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1480</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master3</span> <span class="p">~]</span><span class="c"># ifconfig tunl0 |head -2</span>
<span class="n">tunl0</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">193</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">NOARP</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1480</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">135</span><span class="p">.</span><span class="n">192</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker1</span> <span class="p">~]</span><span class="c"># ifconfig tunl0 |head -2</span>
<span class="n">tunl0</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">193</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">NOARP</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1480</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">64</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>
</code></pre></div>
<ul>
<li>可以看到所有集群节点的IP都为<code>10.244.0.0/16</code>这个大网段内的子网</li>
</ul>
<p>3, 在任意集群节点上都可以访问此deploy里pod</p>
<div class="highlight"><pre><span></span><code><span class="c"># curl 10.244.159.155</span>

<span class="n">结果是任意集群节点都可以访问这个POD</span><span class="p">,</span><span class="n">但集群外部是不能访问的</span>
</code></pre></div>
<h3 id="126_deploymentpod">1.2.6 删除deployment中的pod<a class="headerlink" href="#126_deploymentpod" title="Permanent link">&para;</a></h3>
<p>1, 删除pod（<strong>注意: 是删除deployment中的pod</strong>）</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete pod deploy-nginx-6c9764bb69-pbc2h</span>
<span class="n">pod</span> <span class="s2">&quot;deploy-nginx-6c9764bb69-pbc2h&quot;</span> <span class="n">deleted</span>
</code></pre></div>
<p>2, 再次查看,发现又重新启动了一个pod(<strong>节点由k8s-master1转为k8s-worker1 了,IP地址也变化了</strong>)</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods  -o wide</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>              <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6-f2t6r</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">28s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">94</span>   <span class="n">k8s-worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p>也就是说**<mark>pod的IP不是固定的</mark><strong>,比如把整个集群关闭再启动,pod也会自动启动,但是**IP地址也会变化</strong></p>
<p><strong>既然IP地址不是固定的,所以需要一个固定的访问endpoint给用户,那么这种方式就是service.</strong></p>
<h3 id="127_pod">1.2.7 pod版本升级<a class="headerlink" href="#127_pod" title="Permanent link">&para;</a></h3>
<p>查看帮助</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl set image -h</span>
</code></pre></div>
<p>1, 升级前验证nginx版本</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pods deploy-nginx-6d9d558bb6-f2t6r | grep Image:</span>
    <span class="n">Image</span><span class="p">:</span>          <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec deploy-nginx-6d9d558bb6-f2t6r -- nginx -v</span>
<span class="n">nginx</span> <span class="n">version</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">15</span><span class="p">.</span><span class="n">12</span>
</code></pre></div>
<p>2, 升级为1.16版</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl set image deployment deploy-nginx nginx=nginx:1.16-alpine --record</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">image</span> <span class="n">updated</span>
</code></pre></div>
<p>说明:</p>
<ul>
<li>
<p><code>deployment deploy-nginx</code>代表名为deploy-nginx的deployment</p>
</li>
<li>
<p><code>nginx=nginx:1.16-alpine</code>前面的nginx为容器名</p>
</li>
<li>
<p>--record  表示会记录</p>
</li>
</ul>
<p><strong>容器名怎么查看?</strong></p>
<ul>
<li><code>kubectl describe pod pod名</code>查看</li>
<li><code>kubectl edit deployment deployment名</code>来查看容器名</li>
<li><code>kubectl get deployment deployment名 -o yaml</code>来查看容器名</li>
</ul>
<p>3, 验证</p>
<p>如果升级的pod数量较多，则需要一定时间，可通过下面命令查看是否已经成功</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl rollout status deployment deploy-nginx    </span>
<span class="n">deployment</span> <span class="s2">&quot;deploy-nginx&quot;</span> <span class="n">successfully</span> <span class="n">rolled</span> <span class="n">out</span>
</code></pre></div>
<p>验证 pod</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">5f4749c8c8-nskp9</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">104s</span>     <span class="n">更新后</span><span class="p">,</span><span class="n">后面的id变了</span>
</code></pre></div>
<p>验证版本</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod deploy-nginx-5f4749c8c8-nskp9 |grep Image:</span>
    <span class="n">Image</span><span class="p">:</span>          <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">16-alpine</span>                           <span class="n">升级为1</span><span class="p">.</span><span class="n">16了</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec deploy-nginx-5f4749c8c8-nskp9 -- nginx -v</span>
<span class="n">nginx</span> <span class="n">version</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">1</span>                                     <span class="n">升级为1</span><span class="p">.</span><span class="n">16了</span>
</code></pre></div>
<p><strong>练习:</strong> 再将nginx1升级为1.17版</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl set image deployment deploy-nginx nginx=nginx:1.17-alpine --record</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">image</span> <span class="n">updated</span>
</code></pre></div>
<h3 id="128_pod">1.2.8 pod版本回退<a class="headerlink" href="#128_pod" title="Permanent link">&para;</a></h3>
<p>1, 查看版本历史信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl rollout history deployment deploy-nginx</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span>
<span class="n">REVISION</span>  <span class="n">CHANGE-CAUSE</span>
<span class="n">1</span>         <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                                                <span class="n">原1</span><span class="p">.</span><span class="n">15版</span>
<span class="n">2</span>         <span class="n">kubectl</span> <span class="nb">set </span><span class="n">image</span> <span class="n">deployment</span> <span class="n">deploy-nginx</span> <span class="n">nginx</span><span class="p">=</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">16-alpine</span> <span class="p">-</span><span class="n">-record</span><span class="p">=</span><span class="n">true</span>
<span class="n">3</span>         <span class="n">kubectl</span> <span class="nb">set </span><span class="n">image</span> <span class="n">deployment</span> <span class="n">deploy-nginx</span> <span class="n">nginx</span><span class="p">=</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">17-alpine</span> <span class="p">-</span><span class="n">-record</span><span class="p">=</span><span class="n">true</span>
</code></pre></div>
<p>2, 定义要回退的版本（还需要执行才是真的回退版本)</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl rollout history deployment deploy-nginx --revision=1</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">with</span> <span class="n">revision</span> <span class="c">#1</span>
<span class="n">Pod</span> <span class="n">Template</span><span class="p">:</span>
  <span class="n">Labels</span><span class="p">:</span>       <span class="n">app</span><span class="p">=</span><span class="n">nginx</span>
        <span class="n">pod-template-hash</span><span class="p">=</span><span class="n">6c9764bb69</span>
  <span class="n">Containers</span><span class="p">:</span>
   <span class="n">nginx</span><span class="p">:</span>
    <span class="n">Image</span><span class="p">:</span>      <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>               <span class="n">可以看到这是要回退的1</span><span class="p">.</span><span class="n">15版本</span>
    <span class="n">Port</span><span class="p">:</span>       <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>
    <span class="n">Host</span> <span class="n">Port</span><span class="p">:</span>  <span class="n">0</span><span class="p">/</span><span class="n">TCP</span>
    <span class="n">Environment</span><span class="p">:</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
    <span class="n">Mounts</span><span class="p">:</span>     <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
  <span class="n">Volumes</span><span class="p">:</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p>3, 执行回退</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl rollout undo deployment deploy-nginx --to-revision=1</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">rolled</span> <span class="n">back</span>
</code></pre></div>
<p>4, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl rollout history deployment deploy-nginx</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span>
<span class="n">REVISION</span>  <span class="n">CHANGE-CAUSE</span>
<span class="n">2</span>         <span class="n">kubectl</span> <span class="nb">set </span><span class="n">image</span> <span class="n">deployment</span> <span class="n">deploy-nginx</span> <span class="n">nginx</span><span class="p">=</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">16-alpine</span> <span class="p">-</span><span class="n">-record</span><span class="p">=</span><span class="n">true</span>
<span class="n">3</span>         <span class="n">kubectl</span> <span class="nb">set </span><span class="n">image</span> <span class="n">deployment</span> <span class="n">deploy-nginx</span> <span class="n">nginx</span><span class="p">=</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">17-alpine</span> <span class="p">-</span><span class="n">-record</span><span class="p">=</span><span class="n">true</span>
<span class="n">4</span>         <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                        <span class="n">回到了1</span><span class="p">.</span><span class="n">15版</span><span class="p">,</span><span class="n">但revision的ID变了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69-zgwpj</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">54s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe pod deploy-nginx-6c9764bb69-zgwpj |grep Image:</span>
    <span class="n">Image</span><span class="p">:</span>          <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>               <span class="n">回到了1</span><span class="p">.</span><span class="n">15版</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec deploy-nginx-6c9764bb69-zgwpj -- nginx -v</span>
<span class="n">nginx</span> <span class="n">version</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">15</span><span class="p">.</span><span class="n">12</span>                        <span class="n">回到了1</span><span class="p">.</span><span class="n">15版</span>
</code></pre></div>
<h3 id="129">1.2.9 副本扩容<a class="headerlink" href="#129" title="Permanent link">&para;</a></h3>
<p>查看帮助</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl scale -h</span>
</code></pre></div>
<p>1, 扩容为2个副本</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl scale deployment deploy-nginx --replicas=2</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">scaled</span>
</code></pre></div>
<p>2, 查看</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>               <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6</span><span class="p">-</span><span class="n">4c64l</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">27s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">157</span>   <span class="n">k8s-master1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6-hkq2b</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">71s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">95</span>    <span class="n">k8s-worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

<span class="n">在两个node节点上各1个pod</span>
</code></pre></div>
<p>3, 继续扩容(我们这里只有2个node,但是可以大于node节点数据)</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl scale deployment deploy-nginx --replicas=4</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">extensions</span><span class="p">/</span><span class="n">nginx1</span> <span class="n">scaled</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">IP</span>               <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6</span><span class="p">-</span><span class="n">4c64l</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">87s</span>     <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">157</span>   <span class="n">k8s-master1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6</span><span class="p">-</span><span class="n">586dr</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">31s</span>     <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">135</span><span class="p">.</span><span class="n">197</span>   <span class="n">k8s-master3</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6-hkq2b</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m11s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">95</span>    <span class="n">k8s-worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6-kvgsc</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">31s</span>     <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">13</span>    <span class="n">k8s-master2</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="1210">1.2.10 副本裁减<a class="headerlink" href="#1210" title="Permanent link">&para;</a></h3>
<p>1, 指定副本数为1进行裁减</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl scale deployment deploy-nginx --replicas=1</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">scaled</span>
</code></pre></div>
<p>2, 查看验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6d9d558bb6-hkq2b</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m56s</span>
</code></pre></div>
<h3 id="1211">1.2.11 多副本滚动更新<a class="headerlink" href="#1211" title="Permanent link">&para;</a></h3>
<p>1, 先扩容多点副本</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl scale deployment deploy-nginx --replicas=16</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">scaled</span>
</code></pre></div>
<p>2, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                      <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf</span><span class="p">-</span><span class="n">2hd48</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf</span><span class="p">-</span><span class="n">5m72n</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf</span><span class="p">-</span><span class="n">5w2xr</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf</span><span class="p">-</span><span class="n">5wmdh</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf</span><span class="p">-</span><span class="n">6szjj</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf</span><span class="p">-</span><span class="n">9dgsw</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-dc7qj</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-l52pr</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-m7rt4</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">26m</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-mdkj2</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-s79kp</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-shhvk</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-sv8gb</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-xbhf4</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-zgdgd</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx1</span><span class="p">-</span><span class="n">7d9b8757cf-zzljl</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">61s</span>
<span class="n">nginx2</span><span class="p">-</span><span class="n">559567f789</span><span class="p">-</span><span class="n">8hstz</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">1</span>          <span class="n">114m</span>
</code></pre></div>
<p>3, 滚动更新</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl set image deployment deploy-nginx nginx=nginx:1.17-alpine --record</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">image</span> <span class="n">updated</span>
</code></pre></div>
<p>4, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl rollout status deployment deploy-nginx</span>
<span class="p">......</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">deployment</span> <span class="s2">&quot;deploy-nginx&quot;</span> <span class="n">rollout</span> <span class="n">to</span> <span class="n">finish</span><span class="p">:</span> <span class="n">13</span> <span class="n">of</span> <span class="n">16</span> <span class="n">updated</span> <span class="n">replicas</span> <span class="n">are</span> <span class="n">available</span><span class="p">...</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">deployment</span> <span class="s2">&quot;deploy-nginx&quot;</span> <span class="n">rollout</span> <span class="n">to</span> <span class="n">finish</span><span class="p">:</span> <span class="n">14</span> <span class="n">of</span> <span class="n">16</span> <span class="n">updated</span> <span class="n">replicas</span> <span class="n">are</span> <span class="n">available</span><span class="p">...</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">deployment</span> <span class="s2">&quot;deploy-nginx&quot;</span> <span class="n">rollout</span> <span class="n">to</span> <span class="n">finish</span><span class="p">:</span> <span class="n">15</span> <span class="n">of</span> <span class="n">16</span> <span class="n">updated</span> <span class="n">replicas</span> <span class="n">are</span> <span class="n">available</span><span class="p">...</span>
<span class="n">deployment</span> <span class="s2">&quot;deploy-nginx&quot;</span> <span class="n">successfully</span> <span class="n">rolled</span> <span class="n">out</span>
</code></pre></div>
<h3 id="1212_deployment">1.2.12 删除deployment<a class="headerlink" href="#1212_deployment" title="Permanent link">&para;</a></h3>
<p>如果使用 <code>kubectl delete deployment deploy-nginx</code>命令删除deployment,那么里面的pod也会被自动删除</p>
<h2 id="13_replicaset">1.3 Replicaset<a class="headerlink" href="#13_replicaset" title="Permanent link">&para;</a></h2>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># vim rs-nginx.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ReplicaSet</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">rs-nginx</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>                    <span class="c"># replicaset的spec</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>            <span class="c"># 副本数</span>
  <span class="n">selector</span><span class="p">:</span>              <span class="c"># 标签选择器,对应pod的标签</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>         <span class="c"># 匹配的label</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>       <span class="c"># pod名</span>
      <span class="n">labels</span><span class="p">:</span>           <span class="c"># 对应上面定义的标签选择器selector里面的内容</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>               <span class="c"># pod的spec</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
          <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
</code></pre></div>
<p>2, 应用YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f rs-nginx.yml</span>
<span class="n">replicaset</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">rs-nginx</span> <span class="n">created</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get rs</span>
<span class="n">NAME</span>       <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">rs-nginx</span>   <span class="n">2</span>         <span class="n">2</span>         <span class="n">2</span>       <span class="n">26s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>             <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">rs-nginx</span><span class="p">-</span><span class="n">7j9hz</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">44s</span>
<span class="n">rs-nginx-pncsk</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">43s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get deployment</span>
<span class="n">No</span> <span class="n">resources</span> <span class="n">found</span><span class="p">.</span>

<span class="n">找不到deployment</span><span class="p">,</span><span class="n">说明创建rs并没有创建deployment</span>
</code></pre></div>
<h1 id="podcontroller_1">二、pod控制器Controller进阶<a class="headerlink" href="#podcontroller_1" title="Permanent link">&para;</a></h1>
<h2 id="21_daemonset">2.1 DaemonSet<a class="headerlink" href="#21_daemonset" title="Permanent link">&para;</a></h2>
<h3 id="211_daemonset">2.1.1 DaemonSet介绍<a class="headerlink" href="#211_daemonset" title="Permanent link">&para;</a></h3>
<ul>
<li>DaemonSet能够让所有（或者特定）的节点运行同一个pod。</li>
<li>当节点加入到K8S集群中，pod会被（DaemonSet）调度到该节点上运行，当节点从K8S集群中被移除，被DaemonSet调度的pod会被移除</li>
<li>如果删除DaemonSet，所有跟这个DaemonSet相关的pods都会被删除。</li>
<li>如果一个DaemonSet的Pod被杀死、停止、或者崩溃，那么DaemonSet将会重新创建一个新的副本在这台计算节点上。</li>
<li>DaemonSet一般应用于日志收集、监控采集、分布式存储守护进程等</li>
</ul>
<h3 id="212_daemonset">2.1.2 DaemonSet应用案例<a class="headerlink" href="#212_daemonset" title="Permanent link">&para;</a></h3>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># vim daemonset-nginx.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">DaemonSet</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">daemonset-nginx</span>         
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">nginx-ds</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">nginx-ds</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">tolerations</span><span class="p">:</span>                      <span class="c"># tolerations代表容忍</span>
      <span class="p">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span>  <span class="c"># 能容忍的污点key</span>
        <span class="n">effect</span><span class="p">:</span> <span class="n">NoSchedule</span>   <span class="c"># kubectl explain pod.spec.tolerations查看(能容忍的污点effect)</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">resources</span><span class="p">:</span>    <span class="c"># resources资源限制是为了防止master节点的资源被占太多(根据实际情况配置)</span>
          <span class="n">limits</span><span class="p">:</span>
            <span class="n">memory</span><span class="p">:</span> <span class="n">100Mi</span>
          <span class="n">requests</span><span class="p">:</span>
            <span class="n">memory</span><span class="p">:</span> <span class="n">100Mi</span>
</code></pre></div>
<p>2, apply应用YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f daemonset-nginx.yml</span>
<span class="n">daemonset</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">daemonset-nginx</span> <span class="n">created</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get daemonset              # daemonset可简写为ds</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get ds</span>
<span class="n">NAME</span>              <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">NODE</span> <span class="n">SELECTOR</span>   <span class="n">AGE</span>
<span class="n">daemonset-nginx</span>   <span class="n">4</span>         <span class="n">4</span>         <span class="n">4</span>       <span class="n">4</span>            <span class="n">4</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>          <span class="n">114s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide</span>
<span class="n">NAME</span>                    <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>               <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">daemonset-nginx</span><span class="p">-</span><span class="n">94z6d</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">6s</span>    <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">104</span>   <span class="n">k8s-worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">daemonset-nginx-hs9mk</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">6s</span>    <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">135</span><span class="p">.</span><span class="n">206</span>   <span class="n">k8s-master3</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">daemonset-nginx-jrcf5</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">6s</span>    <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">167</span>   <span class="n">k8s-master1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">daemonset-nginx-sslpl</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">6s</span>    <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">22</span>    <span class="n">k8s-master2</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

<span class="n">k8s集群中每个节点都会运行一个pod</span>
</code></pre></div>
<h2 id="22_job">2.2 Job<a class="headerlink" href="#22_job" title="Permanent link">&para;</a></h2>
<h3 id="221_job">2.2.1 Job介绍<a class="headerlink" href="#221_job" title="Permanent link">&para;</a></h3>
<ul>
<li>对于ReplicaSet而言，它希望pod保持预期数目、持久运行下去，除非用户明确删除，否则这些对象一直存在，它们针对的是耐久性任务，如web服务等。</li>
<li>对于非耐久性任务，比如压缩文件，任务完成后，pod需要结束运行，不需要pod继续保持在系统中，这个时候就要用到Job。</li>
<li>Job负责批量处理短暂的一次性任务 (short lived one-off tasks)，即仅执行一次的任务，它保证批处理任务的一个或多个Pod成功结束。</li>
</ul>
<h3 id="222_job">2.2.2 Job应用案例<a class="headerlink" href="#222_job" title="Permanent link">&para;</a></h3>
<h4 id="2221_2000">2.2.2.1 计算圆周率2000位<a class="headerlink" href="#2221_2000" title="Permanent link">&para;</a></h4>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># vim job1.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">batch</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pi</span>          <span class="c"># job名</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">pi</span>      <span class="c"># pod名</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">pi</span>       <span class="c"># 容器名</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">perl</span>    <span class="c"># 此镜像有800多M,可提前导入到所有节点,也可能指定导入到某一节点然后指定调度到此节点</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;perl&quot;</span><span class="p">,</span>  <span class="s2">&quot;-Mbignum=bpi&quot;</span><span class="p">,</span> <span class="s2">&quot;-wle&quot;</span><span class="p">,</span> <span class="s2">&quot;print bpi(2000)&quot;</span><span class="p">]</span>
      <span class="n">restartPolicy</span><span class="p">:</span> <span class="n">Never</span>   <span class="c"># 执行完后不再重启</span>
</code></pre></div>
<p>2, 应用YAML文件创建job</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl apply -f job1.yml</span>
<span class="n">job</span><span class="p">.</span><span class="n">batch</span><span class="p">/</span><span class="n">pi</span> <span class="n">created</span>
</code></pre></div>
<p>3,  验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get jobs</span>
<span class="n">NAME</span>   <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">pi</span>     <span class="n">1</span><span class="p">/</span><span class="n">1</span>           <span class="n">11s</span>        <span class="n">18s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pi-tjq9b</span>                     <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>         <span class="n">27s</span>

<span class="n">Completed状态</span><span class="p">,</span><span class="n">也不再是ready状态</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl logs pi-tjq9b</span>
<span class="n">3</span><span class="p">.</span><span class="n">1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275901</span>
</code></pre></div>
<h4 id="2222_job">2.2.2.2  创建固定次数job<a class="headerlink" href="#2222_job" title="Permanent link">&para;</a></h4>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># vim job2.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">batch</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">busybox-job</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">completions</span><span class="p">:</span> <span class="n">10</span>                                               <span class="c"># 执行job的次数</span>
  <span class="n">parallelism</span><span class="p">:</span> <span class="n">1</span>                                                <span class="c"># 执行job的并发数</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">busybox-job-pod</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">busybox</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">busybox</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">]</span>
      <span class="n">restartPolicy</span><span class="p">:</span> <span class="n">Never</span>
</code></pre></div>
<p>2, 应用YAML文件创建job</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f job2.yml</span>
<span class="n">job</span><span class="p">.</span><span class="n">batch</span><span class="p">/</span><span class="n">busybox-job</span> <span class="n">created</span>
</code></pre></div>
<p>3, 验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get job</span>
<span class="n">NAME</span>          <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">busybox-job</span>   <span class="n">2</span><span class="p">/</span><span class="n">10</span>          <span class="n">9s</span>         <span class="n">9s</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get job</span>
<span class="n">NAME</span>          <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">busybox-job</span>   <span class="n">3</span><span class="p">/</span><span class="n">10</span>          <span class="n">12s</span>        <span class="n">12s</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get job</span>
<span class="n">NAME</span>          <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">busybox-job</span>   <span class="n">4</span><span class="p">/</span><span class="n">10</span>          <span class="n">15s</span>        <span class="n">15s</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get job</span>
<span class="n">NAME</span>          <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">busybox-job</span>   <span class="n">10</span><span class="p">/</span><span class="n">10</span>         <span class="n">34s</span>        <span class="n">48s</span>

<span class="n">34秒左右结束</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">busybox-job</span><span class="p">-</span><span class="n">5zn6l</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">34s</span>
<span class="n">busybox-job-cm9kw</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">29s</span>
<span class="n">busybox-job-fmpgt</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">38s</span>
<span class="n">busybox-job-gjjvh</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">45s</span>
<span class="n">busybox-job-krxpd</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">25s</span>
<span class="n">busybox-job-m2vcq</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">41s</span>
<span class="n">busybox-job-ncg78</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">47s</span>
<span class="n">busybox-job-tbzz8</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">51s</span>
<span class="n">busybox-job-vb99r</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">21s</span>
<span class="n">busybox-job-wnch7</span>            <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">32s</span>
</code></pre></div>
<h4 id="2223_mysql">2.2.2.3 一次性备份MySQL数据库<a class="headerlink" href="#2223_mysql" title="Permanent link">&para;</a></h4>
<blockquote>
<p>通过Job控制器创建应用备份MySQL数据库</p>
</blockquote>
<h5 id="22231_mysql">2.2.2.3.1  MySQL数据库准备<a class="headerlink" href="#22231_mysql" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nginx</span> <span class="n">jobcontroller</span><span class="p">]</span><span class="c"># cat 00_mysql.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mysql-test</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">3306</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">mysql</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">mysql-dump</span>

<span class="p">---</span>

<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">db</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">mysql-dump</span>
  <span class="n">serviceName</span><span class="p">:</span> <span class="s2">&quot;mysql-test&quot;</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">mysql-dump</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">nodeName</span><span class="p">:</span> <span class="n">k8s-master3</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="n">5</span><span class="p">.</span><span class="n">7</span>
        <span class="n">env</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">MYSQL_ROOT_PASSWORD</span>
          <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;abc123&quot;</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">3306</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/var/lib/mysql&quot;</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
        <span class="n">hostPath</span><span class="p">:</span>
          <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">mysqldata</span>
</code></pre></div>
<h5 id="22232">2.2.2.3.2  创建用于实现任务的资源清单文件<a class="headerlink" href="#22232" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nginx</span> <span class="n">jobcontroller</span><span class="p">]</span><span class="c"># cat 03_job.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">batch</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mysql-dump</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">mysql-dump</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">nodeName</span><span class="p">:</span> <span class="n">k8s-master2</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql-dump</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="n">5</span><span class="p">.</span><span class="n">7</span>
        <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="s2">&quot;mysqldump --host=mysql-test -uroot -pabc123 --databases mysql &gt; /root/mysql2022.sql&quot;</span><span class="p">]</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/root&quot;</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
      <span class="n">restartPolicy</span><span class="p">:</span> <span class="n">Never</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
        <span class="n">hostPath</span><span class="p">:</span>
          <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">mysqldump</span>
</code></pre></div>
<h2 id="23_cronjob">2.3 CronJob<a class="headerlink" href="#23_cronjob" title="Permanent link">&para;</a></h2>
<h3 id="231_cronjob">2.3.1 CronJob介绍<a class="headerlink" href="#231_cronjob" title="Permanent link">&para;</a></h3>
<ul>
<li>类似于Linux系统的crontab，在指定的时间周期运行相关的任务</li>
<li>时间格式：分时日月周</li>
</ul>
<h3 id="232_cronjob">2.3.2 CronJob应用案例<a class="headerlink" href="#232_cronjob" title="Permanent link">&para;</a></h3>
<h4 id="2321">2.3.2.1 周期性输出字符<a class="headerlink" href="#2321" title="Permanent link">&para;</a></h4>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim cronjob.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">batch</span><span class="p">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">CronJob</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">cronjob1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">schedule</span><span class="p">:</span> <span class="s2">&quot;* * * * *&quot;</span>                 <span class="c"># 分时日月周</span>
  <span class="n">jobTemplate</span><span class="p">:</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">template</span><span class="p">:</span>
        <span class="n">spec</span><span class="p">:</span>
          <span class="n">containers</span><span class="p">:</span>
          <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">hello</span>
            <span class="n">image</span><span class="p">:</span> <span class="n">busybox</span>
            <span class="n">args</span><span class="p">:</span>
            <span class="p">-</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">sh</span>
            <span class="p">-</span> <span class="n">-c</span>
            <span class="p">-</span> <span class="n">date</span><span class="p">;</span> <span class="nb">echo </span><span class="n">hello</span> <span class="n">kubernetes</span>
            <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
          <span class="n">restartPolicy</span><span class="p">:</span> <span class="n">OnFailure</span>
</code></pre></div>
<p>2, 应用YAML文件创建cronjob</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f cronjob.yml</span>
<span class="n">cronjob</span><span class="p">.</span><span class="n">batch</span><span class="p">/</span><span class="n">cronjob1</span> <span class="n">created</span>
</code></pre></div>
<p>3, 查看验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get cronjob</span>
<span class="n">NAME</span>       <span class="n">SCHEDULE</span>    <span class="n">SUSPEND</span>   <span class="n">ACTIVE</span>   <span class="n">LAST</span> <span class="n">SCHEDULE</span>   <span class="n">AGE</span>
<span class="n">cronjob1</span>   <span class="p">*</span> <span class="p">*</span> <span class="p">*</span> <span class="p">*</span> <span class="p">*</span>   <span class="n">False</span>     <span class="n">0</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>          <span class="n">21s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">cronjob</span><span class="p">-</span><span class="n">1564993080-qlbgv</span>     <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">2m10s</span>
<span class="n">cronjob</span><span class="p">-</span><span class="n">1564993140-zbv7f</span>     <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">70s</span>
<span class="n">cronjob</span><span class="p">-</span><span class="n">1564993200-gx5xz</span>     <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Completed</span>          <span class="n">0</span>          <span class="n">10s</span>

<span class="n">看AGE时间</span><span class="p">,</span><span class="n">每分钟整点执行一次</span>
</code></pre></div>
<h4 id="2322_mysql">2.3.2.2 周期性备份MySQL数据库<a class="headerlink" href="#2322_mysql" title="Permanent link">&para;</a></h4>
<h5 id="23221_mysql">2.3.2.2.1 MySQL数据库准备<a class="headerlink" href="#23221_mysql" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nginx</span> <span class="n">jobcontroller</span><span class="p">]</span><span class="c"># cat 00_mysql.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mysql-test</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">3306</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">mysql</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">mysql-dump</span>

<span class="p">---</span>

<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">db</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">mysql-dump</span>
  <span class="n">serviceName</span><span class="p">:</span> <span class="s2">&quot;mysql-test&quot;</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">mysql-dump</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">nodeName</span><span class="p">:</span> <span class="n">worker03</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="n">5</span><span class="p">.</span><span class="n">7</span>
        <span class="n">env</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">MYSQL_ROOT_PASSWORD</span>
          <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;abc123&quot;</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">3306</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/var/lib/mysql&quot;</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
        <span class="n">hostPath</span><span class="p">:</span>
          <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">mysqldata</span>
</code></pre></div>
<h5 id="23222_cronjob">2.3.2.2.2 Cronjob控制器类型应用资源清单文件<a class="headerlink" href="#23222_cronjob" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nginx</span> <span class="n">jobcontroller</span><span class="p">]</span><span class="c"># cat 05_cronjob.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">batch</span><span class="p">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">CronJob</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mysql-dump</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">schedule</span><span class="p">:</span> <span class="s2">&quot;*/1 * * * *&quot;</span>
  <span class="n">jobTemplate</span><span class="p">:</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">template</span><span class="p">:</span>
        <span class="n">spec</span><span class="p">:</span>
          <span class="n">nodeName</span><span class="p">:</span> <span class="n">worker02</span>
          <span class="n">containers</span><span class="p">:</span>
          <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
            <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="n">5</span><span class="p">.</span><span class="n">7</span>
            <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="s2">&quot;mysqldump --host=mysql-test -uroot -pabc123 --databases mysql &gt; /root/mysql`date +%Y%m%d%H%M`.sql&quot;</span><span class="p">]</span>
            <span class="n">volumeMounts</span><span class="p">:</span>
              <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
                <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/root&quot;</span>
          <span class="n">restartPolicy</span><span class="p">:</span> <span class="n">Never</span>
          <span class="n">volumes</span><span class="p">:</span>
            <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mysql-data</span>
              <span class="n">hostPath</span><span class="p">:</span>
                <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">mysqldump</span>
</code></pre></div>
<h1 id="kubernetes_controllerstatefulset">Kubernetes核心概念 Controller之StatefulSet控制器<a class="headerlink" href="#kubernetes_controllerstatefulset" title="Permanent link">&para;</a></h1>
<h1 id="statefulset">一、StatefulSet控制器作用<a class="headerlink" href="#statefulset" title="Permanent link">&para;</a></h1>
<ul>
<li>
<p>StatefulSet 是用来管理有状态应用的控制器。</p>
</li>
<li>
<p>StatefulSet 用来管理某Pod集合的部署和扩缩， 并为这些 Pod 提供持久存储和持久标识符。</p>
</li>
<li>
<p>参考: <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/</a></p>
</li>
</ul>
<h1 id="_2">二、无状态应用与有状态应用<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h1>
<h2 id="21">2.1 无状态应用<a class="headerlink" href="#21" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>如nginx</p>
</li>
<li>
<p>请求本身包含了响应端为响应这一请求所需的全部信息。每一个请求都像首次执行一样，不会依赖之前的数据进行响应。</p>
</li>
<li>不需要持久化的数据</li>
<li>无状态应用的多个实例之间互不依赖，可以无序的部署、删除或伸缩</li>
</ul>
<h2 id="22">2.2 有状态应用<a class="headerlink" href="#22" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>如mysql</p>
</li>
<li>
<p>前后请求有关联与依赖</p>
</li>
<li>需要持久化的数据</li>
<li>有状态应用的多个实例之间有依赖，不能相互替换：无论怎么调度，每个 Pod 都有一个永久不变的 ID。</li>
</ul>
<h1 id="statefulset_1">三、StatefulSet的特点<a class="headerlink" href="#statefulset_1" title="Permanent link">&para;</a></h1>
<ul>
<li>稳定的、唯一的网络标识符。     (通过headless服务实现)</li>
<li>稳定的、持久的存储。                   (通过PV，PVC，storageclass实现)</li>
<li>有序的、优雅的部署和缩放。       </li>
<li>有序的、自动的滚动更新。           </li>
</ul>
<h1 id="statefulsetyaml">四、StatefulSet的YAML组成<a class="headerlink" href="#statefulsetyaml" title="Permanent link">&para;</a></h1>
<p>需要三个组成部分:</p>
<ol>
<li>headless service:                 实现稳定，唯一的网络标识</li>
<li>statefulset类型资源:            写法和deployment几乎一致，就是类型不一样</li>
<li>volumeClaimTemplate :     指定存储卷</li>
</ol>
<h1 id="statefulset_2">五、创建StatefulSet应用<a class="headerlink" href="#statefulset_2" title="Permanent link">&para;</a></h1>
<ul>
<li>参考: <a href="https://kubernetes.io/zh/docs/tutorials/stateful-application/basic-stateful-set/">https://kubernetes.io/zh/docs/tutorials/stateful-application/basic-stateful-set/</a></li>
</ul>
<h2 id="51_yaml">5.1 编辑YAML资源清单文件<a class="headerlink" href="#51_yaml" title="Permanent link">&para;</a></h2>
<blockquote>
<p>创建statelfulset应用来调用名为nfs-client的storageclass,以实现动态供给</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim nginx-storageclass-nfs.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">web</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">None</span>                                  <span class="c"># 无头服务</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">web</span>                                         <span class="c"># statefulset的名称</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">serviceName</span><span class="p">:</span> <span class="s2">&quot;nginx&quot;</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">3</span>                                       <span class="c"># 3个副本</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">web</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">www</span>
          <span class="n">mountPath</span><span class="p">:</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span>
  <span class="n">volumeClaimTemplates</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">metadata</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">www</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">accessModes</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;ReadWriteOnce&quot;</span> <span class="p">]</span>
      <span class="n">storageClassName</span><span class="p">:</span> <span class="s2">&quot;nfs-client&quot;</span>        <span class="c"># 与前面定义的storageclass名称对应</span>
      <span class="n">resources</span><span class="p">:</span>
        <span class="n">requests</span><span class="p">:</span>
          <span class="n">storage</span><span class="p">:</span> <span class="n">1Gi</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f nginx-storageclass-nfs.yml</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx</span> <span class="n">created</span>
<span class="n">statefulset</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">web</span> <span class="n">created</span>
</code></pre></div>
<h2 id="52">5.2 应用部署后验证<a class="headerlink" href="#52" title="Permanent link">&para;</a></h2>
<h3 id="521_pod">5.2.1 验证pod<a class="headerlink" href="#521_pod" title="Permanent link">&para;</a></h3>
<blockquote>
<p>产生了3个pod</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods |grep web</span>
<span class="n">web</span><span class="p">-</span><span class="n">0</span>                                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">1m15s</span>
<span class="n">web</span><span class="p">-</span><span class="n">1</span>                                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">1m7s</span>
<span class="n">web</span><span class="p">-</span><span class="n">2</span>                                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">57s</span>
</code></pre></div>
<h3 id="522_pv">5.2.2 验证pv<a class="headerlink" href="#522_pv" title="Permanent link">&para;</a></h3>
<blockquote>
<p>自动产生了3个pv</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span> <span class="c"># kubectl get pv</span>
<span class="n">pvc</span><span class="p">-</span><span class="n">2436b20d</span><span class="p">-</span><span class="n">1be3</span><span class="p">-</span><span class="n">4c2e</span><span class="p">-</span><span class="n">87a9</span><span class="p">-</span><span class="n">5533e5c5e2c6</span>  <span class="n">1Gi</span>  <span class="n">RWO</span>   <span class="n">Delete</span>  <span class="n">Bound</span>  <span class="k">default</span><span class="p">/</span><span class="n">www-web</span><span class="p">-</span><span class="n">0</span>   <span class="n">nfs-client</span>       <span class="n">3m</span>
<span class="n">pvc</span><span class="p">-</span><span class="n">3114be74</span><span class="p">-</span><span class="n">5969</span><span class="p">-</span><span class="n">40eb-aeb3</span><span class="p">-</span><span class="n">87a3b9ae17bc</span>  <span class="n">1Gi</span>  <span class="n">RWO</span>   <span class="n">Delete</span>  <span class="n">Bound</span>  <span class="k">default</span><span class="p">/</span><span class="n">www-web</span><span class="p">-</span><span class="n">1</span>   <span class="n">nfs-client</span>       <span class="n">2m</span>
<span class="n">pvc</span><span class="p">-</span><span class="n">43afb71d</span><span class="p">-</span><span class="n">1d02</span><span class="p">-</span><span class="n">4699-b00c</span><span class="p">-</span><span class="n">71679fd75fc3</span>  <span class="n">1Gi</span>  <span class="n">RWO</span>   <span class="n">Delete</span>  <span class="n">ound</span>   <span class="k">default</span><span class="p">/</span><span class="n">www-web</span><span class="p">-</span><span class="n">2</span>   <span class="n">nfs-client</span>       <span class="n">2m</span>
</code></pre></div>
<h3 id="523_pvc">5.2.3 验证pvc<a class="headerlink" href="#523_pvc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>自动产生了3个PVC</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pvc |grep web</span>
<span class="n">www-web</span><span class="p">-</span><span class="n">0</span>  <span class="n">Bound</span>   <span class="n">pvc</span><span class="p">-</span><span class="n">2436b20d</span><span class="p">-</span><span class="n">1be3</span><span class="p">-</span><span class="n">4c2e</span><span class="p">-</span><span class="n">87a9</span><span class="p">-</span><span class="n">5533e5c5e2c6</span>   <span class="n">1Gi</span>   <span class="n">RWO</span>  <span class="n">nfs-client</span>  <span class="n">3m</span>
<span class="n">www-web</span><span class="p">-</span><span class="n">1</span>  <span class="n">Bound</span>   <span class="n">pvc</span><span class="p">-</span><span class="n">3114be74</span><span class="p">-</span><span class="n">5969</span><span class="p">-</span><span class="n">40eb-aeb3</span><span class="p">-</span><span class="n">87a3b9ae17bc</span>   <span class="n">1Gi</span>   <span class="n">RWO</span>  <span class="n">nfs-client</span>  <span class="n">2m</span>
<span class="n">www-web</span><span class="p">-</span><span class="n">2</span>  <span class="n">Bound</span>   <span class="n">pvc</span><span class="p">-</span><span class="n">43afb71d</span><span class="p">-</span><span class="n">1d02</span><span class="p">-</span><span class="n">4699-b00c</span><span class="p">-</span><span class="n">71679fd75fc3</span>   <span class="n">1Gi</span>   <span class="n">RWO</span>  <span class="n">nfs-client</span>  <span class="n">2m</span>
</code></pre></div>
<h3 id="524_nfs">5.2.4 验证nfs服务目录<a class="headerlink" href="#524_nfs" title="Permanent link">&para;</a></h3>
<p>在nfs服务器（这里为hostos)的共享目录中发现自动产生了3个子目录</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nfsserver</span> <span class="p">~]</span><span class="c"># ls /data/nfs/</span>
<span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">0-pvc</span><span class="p">-</span><span class="n">2436b20d</span><span class="p">-</span><span class="n">1be3</span><span class="p">-</span><span class="n">4c2e</span><span class="p">-</span><span class="n">87a9</span><span class="p">-</span><span class="n">5533e5c5e2c6</span>  
<span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">2-pvc</span><span class="p">-</span><span class="n">43afb71d</span><span class="p">-</span><span class="n">1d02</span><span class="p">-</span><span class="n">4699-b00c</span><span class="p">-</span><span class="n">71679fd75fc3</span>
<span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">1-pvc</span><span class="p">-</span><span class="n">3114be74</span><span class="p">-</span><span class="n">5969</span><span class="p">-</span><span class="n">40eb-aeb3</span><span class="p">-</span><span class="n">87a3b9ae17bc</span>  
</code></pre></div>
<p>3个子目录默认都为空目录</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nfsserver</span> <span class="p">~]</span><span class="c"># tree /data/nfs/</span>
<span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">nfs</span><span class="p">/</span>
<span class="err">├──</span> <span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">0-pvc</span><span class="p">-</span><span class="n">2436b20d</span><span class="p">-</span><span class="n">1be3</span><span class="p">-</span><span class="n">4c2e</span><span class="p">-</span><span class="n">87a9</span><span class="p">-</span><span class="n">5533e5c5e2c6</span>
<span class="err">├──</span> <span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">1-pvc</span><span class="p">-</span><span class="n">3114be74</span><span class="p">-</span><span class="n">5969</span><span class="p">-</span><span class="n">40eb-aeb3</span><span class="p">-</span><span class="n">87a3b9ae17bc</span>
<span class="err">└──</span> <span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">2-pvc</span><span class="p">-</span><span class="n">43afb71d</span><span class="p">-</span><span class="n">1d02</span><span class="p">-</span><span class="n">4699-b00c</span><span class="p">-</span><span class="n">71679fd75fc3</span>
</code></pre></div>
<h3 id="525">5.2.5 验证存储持久性<a class="headerlink" href="#525" title="Permanent link">&para;</a></h3>
<p>在3个pod中其中一个创建一个主页文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it web-0 -- /bin/sh</span>
<span class="p">/</span> <span class="c"># echo &quot;haha&quot; &gt;  /usr/share/nginx/html/index.html</span>
<span class="p">/</span> <span class="c"># exit</span>
</code></pre></div>
<p>在nfs服务器上发现文件被创建到了对应的目录中</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nfsserver</span> <span class="p">~]</span><span class="c"># tree /data/nfs/</span>
<span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">nfs</span><span class="p">/</span>
<span class="err">├──</span> <span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">0-pvc</span><span class="p">-</span><span class="n">2436b20d</span><span class="p">-</span><span class="n">1be3</span><span class="p">-</span><span class="n">4c2e</span><span class="p">-</span><span class="n">87a9</span><span class="p">-</span><span class="n">5533e5c5e2c6</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>                              <span class="c"># 此目录里多了index.html文件，对应刚才在web-0的pod中的创建</span>
<span class="err">├──</span> <span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">1-pvc</span><span class="p">-</span><span class="n">3114be74</span><span class="p">-</span><span class="n">5969</span><span class="p">-</span><span class="n">40eb-aeb3</span><span class="p">-</span><span class="n">87a3b9ae17bc</span>
<span class="err">└──</span> <span class="k">default</span><span class="n">-www-web</span><span class="p">-</span><span class="n">2-pvc</span><span class="p">-</span><span class="n">43afb71d</span><span class="p">-</span><span class="n">1d02</span><span class="p">-</span><span class="n">4699-b00c</span><span class="p">-</span><span class="n">71679fd75fc3</span>


<span class="p">[</span><span class="n">root</span><span class="nv">@nfsserver</span> <span class="p">~]</span><span class="c"># cat /data/nfs/default-www-web-0-pvc-2436b20d-1be3-4c2e-87a9-5533e5c5e2c6/index.html</span>
<span class="n">haha</span>                                            <span class="c"># 文件内的内容也与web-0的pod中创建的一致</span>
</code></pre></div>
<p>删除web-0这个pod,再验证</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete pod web-0</span>
<span class="n">pod</span> <span class="s2">&quot;web-0&quot;</span> <span class="n">deleted</span>


<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pods |grep web            # 因为控制器的原因，会迅速再拉起web-0这个pod</span>
<span class="n">web</span><span class="p">-</span><span class="n">0</span>                                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">9s</span>     <span class="c"># 时间上看到是新拉起的pod</span>
<span class="n">web</span><span class="p">-</span><span class="n">1</span>                                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">37m</span>
<span class="n">web</span><span class="p">-</span><span class="n">2</span>                                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">37m</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl exec -it web-0 -- cat /usr/share/nginx/html/index.html</span>
<span class="n">haha</span>                                                    <span class="c"># 新拉起的pod仍然是相同的存储数据</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@nfsserver</span> <span class="p">~]</span><span class="c"># cat /data/nfs/default-www-web-0-pvc-2436b20d-1be3-4c2e-87a9-5533e5c5e2c6/index.html</span>
<span class="n">haha</span>                                                    <span class="c"># nfs服务器上的数据还在</span>
</code></pre></div>
<p><strong>结论: 说明数据可持久化</strong></p>
<h3 id="526">5.2.6 访问验证<a class="headerlink" href="#526" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">验证Coredns是否可用</span>
<span class="c"># kubectl get svc -n kube-system</span>
<span class="n">NAME</span>       <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>   <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>                  <span class="n">AGE</span>
<span class="n">kube-dns</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">53</span><span class="p">/</span><span class="n">UDP</span><span class="p">,</span><span class="n">53</span><span class="p">/</span><span class="n">TCP</span><span class="p">,</span><span class="n">9153</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">6d23h</span>

<span class="c"># dig -t a www.baidu.com @10.96.0.10</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># dig -t a nginx.default.svc.cluster.local. @10.96.0.10</span>

<span class="p">....</span>
<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">nginx</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="n">30</span> <span class="k">IN</span>  <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">75</span>
<span class="n">nginx</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="n">30</span> <span class="k">IN</span>  <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">159</span><span class="p">.</span><span class="n">141</span>
<span class="n">nginx</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="n">30</span> <span class="k">IN</span>  <span class="n">A</span>       <span class="n">10</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">126</span><span class="p">.</span><span class="n">6</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># dig -t a web-0.nginx.default.svc.cluster.local. @10.96.0.10</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在kubernetes集群内创建pod访问</span>
<span class="c"># kubectl run -it busybox --image=radial/busyboxplus</span>
<span class="p">/</span> <span class="c"># curl nginx.default.svc.cluster.local.</span>
<span class="n">web</span><span class="p">-</span><span class="n">0</span>
<span class="p">/</span> <span class="c"># curl web-0.nginx.default.svc.cluster.local.</span>
<span class="n">web</span><span class="p">-</span><span class="n">0</span>
</code></pre></div>
<h1 id="_3">六、已部署应用滚动更新(含金丝雀发布)<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h1>
<blockquote>
<p>它将按照与 Pod 终止相同的顺序（从最大序号到最小序号）进行，每次更新一个 Pod。</p>
<p>StatefulSet可以使用partition参数来实现金丝雀更新，partition参数可以控制StatefulSet控制器更新的Pod。下面，我们就进行StatefulSet控制器的金丝雀更新实战。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">patch</span> <span class="n">sts</span> <span class="n">web</span> <span class="n">-p</span> <span class="s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:2}}}}&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">使用patch参数来指定了StatefulSet控制器的partition参数为2</span><span class="err">，</span><span class="n">表示当更新时</span><span class="err">，</span><span class="n">只有Pod的编号大于等于2的才更新</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl exec -it web-0 -- nginx -v</span>
<span class="n">nginx</span> <span class="n">version</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">15</span><span class="p">.</span><span class="n">12</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="nb">set </span><span class="n">image</span> <span class="n">sts</span><span class="p">/</span><span class="n">web</span> <span class="n">nginx</span><span class="p">=</span><span class="n">nginx</span><span class="p">:</span><span class="n">latest</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="n">-w</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl exec -it web-2 -- nginx -v</span>
<span class="n">nginx</span> <span class="n">version</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">6</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -o custom-columns=Name:metadata.name,Image:spec.containers[0].image</span>
<span class="n">Name</span>                                     <span class="n">Image</span>
<span class="n">web</span><span class="p">-</span><span class="n">0</span>                                    <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
<span class="n">web</span><span class="p">-</span><span class="n">1</span>                                    <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
<span class="n">web</span><span class="p">-</span><span class="n">2</span>                                    <span class="n">nginx</span><span class="p">:</span><span class="n">latest</span>
</code></pre></div>
<p><strong>如何实现全部更新呢？</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">patch</span> <span class="n">sts</span> <span class="n">web</span> <span class="n">-p</span> <span class="s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:0}}}}&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="nb">set </span><span class="n">image</span> <span class="n">sts</span><span class="p">/</span><span class="n">web</span> <span class="n">nginx</span><span class="p">=</span><span class="n">nginx</span><span class="p">:</span><span class="n">latest</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -o custom-columns=Name:metadata.name,Image:spec.containers[0].image</span>
</code></pre></div>
<h1 id="_4">七、已部署应用扩容与缩容<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h1>
<p>在StatefulSet扩容时，会创建一个新的Pod，该Pod与之前的所有Pod都是有顺序的，并且新Pod的序号最大。在缩容时，StatefulSet控制器删除的也是序号最大的Pod。</p>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl scale sts web --replicas=4</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -w</span>
</code></pre></div>
<h1 id="kubernetes_service">kubernetes核心概念 Service<a class="headerlink" href="#kubernetes_service" title="Permanent link">&para;</a></h1>
<h1 id="service">一、 service作用<a class="headerlink" href="#service" title="Permanent link">&para;</a></h1>
<p>使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。</p>
<ul>
<li>通过service为pod客户端提供访问pod方法，即可客户端访问pod入口</li>
<li>通过标签动态感知pod IP地址变化等</li>
<li>防止pod失联</li>
<li>定义访问pod访问策略</li>
<li>通过label-selector相关联</li>
<li>通过Service实现Pod的负载均衡（TCP/UDP 4层）</li>
<li>底层实现由kube-proxy通过userspace、iptables、ipvs三种代理模式</li>
</ul>
<h1 id="kube-proxy">二、kube-proxy三种代理模式<a class="headerlink" href="#kube-proxy" title="Permanent link">&para;</a></h1>
<ul>
<li>kubernetes集群中有三层网络，一类是真实存在的，例如Node Network、Pod Network,提供真实IP地址;一类是虚拟的，例如Cluster Network或Service Network，提供虚拟IP地址，不会出现在接口上，仅会出现在Service当中</li>
<li>
<p>kube-proxy始终watch（监控）kube-apiserver上关于Service相关的资源变动状态，一旦获取相关信息kube-proxy都要把相关信息转化为当前节点之上的，能够实现Service资源调度到特定Pod之上的规则，进而实现访问Service就能够获取Pod所提供的服务</p>
</li>
<li>
<p>kube-proxy三种代理模式：UserSpace模式、iptables模式、ipvs模式</p>
</li>
</ul>
<h2 id="21_userspace">2.1 UserSpace模式<a class="headerlink" href="#21_userspace" title="Permanent link">&para;</a></h2>
<p>userspace 模式是 kube-proxy 使用的第一代模式，该模式在 kubernetes v1.0 版本开始支持使用。</p>
<p>userspace 模式的实现原理图示如下：</p>
<p><img alt="image-20220402102113765" src="../../../img/kubernetes/kubernetes_core/image-20220402102113765.png" /></p>
<p>kube-proxy 会为每个 Service 随机监听一个端口(proxy port)，并增加一条 iptables 规则。所以通过 ClusterIP:Port 访问 Service 的报文都 redirect 到 proxy port，kube-proxy 从它监听的 proxy port 收到报文以后，走 round robin(默认) 或是 session affinity(会话亲和力，即同一 client IP 都走同一链路给同一 pod 服务)，分发给对应的 pod。</p>
<p>由于 userspace 模式会造成所有报文都走一遍用户态（也就是 Service 请求会先从用户空间进入内核 iptables，然后再回到用户空间，由 kube-proxy 完成后端 Endpoints 的选择和代理工作），需要在内核空间和用户空间转换，流量从用户空间进出内核会带来性能损耗，所以这种模式效率低、性能不高，不推荐使用。</p>
<p><img alt="" src="../../../img/kubernetes/kubernetes_core/service-userspace.png" /></p>
<h2 id="22_iptables">2.2 iptables模式<a class="headerlink" href="#22_iptables" title="Permanent link">&para;</a></h2>
<p>iptables 模式是 kube-proxy 使用的第二代模式，该模式在 kubernetes v1.1 版本开始支持，从 v1.2 版本开始成为 kube-proxy 的默认模式。</p>
<p>iptables 模式的负载均衡模式是通过底层 netfilter/iptables 规则来实现的，通过 Informer 机制 Watch 接口实时跟踪 Service 和 Endpoint 的变更事件，并触发对 iptables 规则的同步更新。</p>
<p>iptables 模式的实现原理图示如下：</p>
<p><img alt="image-20220402102306186" src="../../../img/kubernetes/kubernetes_core/image-20220402102306186.png" /></p>
<p>通过图示我们可以发现在 iptables 模式下，kube-proxy 只是作为 controller，而不是 server，真正服务的是内核的 netfilter，体现在用户态的是 iptables。所以整体的效率会比 userspace 模式高。</p>
<p><img alt="" src="../../../img/kubernetes/kubernetes_core/service-iptables.png" /></p>
<h2 id="23_ipvs">2.3 ipvs模式<a class="headerlink" href="#23_ipvs" title="Permanent link">&para;</a></h2>
<p>ipvs 模式被 kube-proxy 采纳为第三代模式，模式在 kubernetes v1.8 版本开始引入，在 v1.9 版本中处于 beta 阶段，在 v1.11 版本中正式开始使用。</p>
<p>ipvs(IP Virtual Server) 实现了传输层负载均衡，也就是 4 层交换，作为 Linux 内核的一部分。<code>ipvs</code>运行在主机上，在真实服务器前充当负载均衡器。ipvs 可以将基于 TCP 和 UDP 的服务请求转发到真实服务器上，并使真实服务器上的服务在单个 IP 地址上显示为虚拟服务。</p>
<p>ipvs 模式的实现原理图示如下：</p>
<p><img alt="image-20220402102614692" src="../../../img/kubernetes/kubernetes_core/image-20220402102614692.png" /></p>
<p><img alt="" src="../../../img/kubernetes/kubernetes_core/service-ipvs.png" /></p>
<p>ipvs 和 iptables 都是基于 netfilter 的，那么 ipvs 模式有哪些更好的性能呢？</p>
<ul>
<li>ipvs 为大型集群提供了更好的可拓展性和性能</li>
<li>ipvs 支持比 iptables 更复杂的负载均衡算法（包括：最小负载、最少连接、加权等）</li>
<li>ipvs 支持服务器健康检查和连接重试等功能</li>
<li>可以动态修改 ipset 的集合，即使 iptables 的规则正在使用这个集合</li>
</ul>
<p>ipvs 依赖于 iptables。ipvs 会使用 iptables 进行包过滤、airpin-masquerade tricks(地址伪装)、SNAT 等功能，但是使用的是 iptables 的扩展 ipset，并不是直接调用 iptables 来生成规则链。通过 ipset 来存储需要 DROP 或 masquerade 的流量的源或目标地址，用于确保 iptables 规则的数量是恒定的，这样我们就不需要关心有多少 Service 或是 Pod 了。</p>
<p>使用 ipset 相较于 iptables 有什么优点呢？iptables 是线性的数据结构，而 ipset 引入了带索引的数据结构，当规则很多的时候，ipset 依然可以很高效的查找和匹配。我们可以将 ipset 简单理解为一个 IP(段) 的集合，这个集合的内容可以是 IP 地址、IP 网段、端口等，iptables 可以直接添加规则对这个“可变的集合进行操作”，这样就可以大大减少 iptables 规则的数量，从而减少性能损耗。</p>
<p>举一个例子，如果我们要禁止成千上万个 IP 访问我们的服务器，如果使用 iptables 就需要一条一条的添加规则，这样会在 iptables 中生成大量的规则；如果用 ipset 就只需要将相关的 IP 地址(网段)加入到 ipset 集合中，然后只需要设置少量的 iptables 规则就可以实现这个目标。</p>
<p>下面的表格是 ipvs 模式下维护的 ipset 表集合：</p>
<table>
<thead>
<tr>
<th align="left">设置名称</th>
<th align="left">成员</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">KUBE-CLUSTER-IP</td>
<td align="left">所有服务 IP + 端口</td>
<td align="left">在 masquerade-all=true 或 clusterCIDR 指定的情况下对 Service Cluster IP 地址进行伪装，解决数据包欺骗问题</td>
</tr>
<tr>
<td align="left">KUBE-LOOP-BACK</td>
<td align="left">所有服务 IP + 端口 + IP</td>
<td align="left">解决数据包欺骗问题</td>
</tr>
<tr>
<td align="left">KUBE-EXTERNAL-IP</td>
<td align="left">服务外部 IP + 端口</td>
<td align="left">将数据包伪装成 Service 的外部 IP 地址</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER</td>
<td align="left">负载均衡器入口 IP + 端口</td>
<td align="left">将数据包伪装成 Load Balancer 类型的 Service</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-LOCAL</td>
<td align="left">负载均衡器入口 IP + 端口 以及<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 Load Balancer externalTrafficPolicy=local</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-FW</td>
<td align="left">负载均衡器入口 IP + 端口 以及<code>loadBalancerSourceRanges</code></td>
<td align="left">使用指定的 loadBalancerSourceRanges 丢弃 Load Balancer 类型 Service 的数据包</td>
</tr>
<tr>
<td align="left">KUBE-LOAD-BALANCER-SOURCE-CIDR</td>
<td align="left">负载均衡器入口 IP + 端口 + 源 CIDR</td>
<td align="left">接受 Load Balancer 类型 Service 的数据包，并指定 loadBalancerSourceRanges</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-TCP</td>
<td align="left">NodePort 类型服务 TCP 端口</td>
<td align="left">将数据包伪装成 NodePort（TCP）</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-LOCAL-TCP</td>
<td align="left">NodePort 类型服务 TCP 端口，带有<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-UDP</td>
<td align="left">NodePort 类型服务 UDP 端口</td>
<td align="left">将数据包伪装成 NodePort(UDP)</td>
</tr>
<tr>
<td align="left">KUBE-NODE-PORT-LOCAL-UDP</td>
<td align="left">NodePort 类型服务 UDP 端口，使用<code>externalTrafficPolicy=local</code></td>
<td align="left">接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local</td>
</tr>
</tbody>
</table>
<h2 id="24_iptablesipvs">2.4 iptables与ipvs对比<a class="headerlink" href="#24_iptablesipvs" title="Permanent link">&para;</a></h2>
<ul>
<li>iptables</li>
<li>工作在内核空间</li>
<li>优点<ul>
<li>灵活，功能强大（可以在数据包不同阶段对包进行操作）</li>
</ul>
</li>
<li>缺点<ul>
<li>表中规则过多时，响应变慢，即规则遍历匹配和更新，呈线性时延</li>
</ul>
</li>
<li>ipvs</li>
<li>工作在内核空间</li>
<li>优点<ul>
<li>转发效率高</li>
<li>调度算法丰富：rr，wrr，lc，wlc，ip hash...</li>
</ul>
</li>
<li>
<p>缺点</p>
<ul>
<li>内核支持不全,低版本内核不能使用，需要升级到4.0或5.0以上。</li>
</ul>
</li>
<li>
<p>使用iptables与ipvs时机</p>
</li>
<li>1.10版本之前使用iptables(1.1版本之前使用UserSpace进行转发)</li>
<li>1.11版本之后同时支持iptables与ipvs，默认使用ipvs，如果ipvs模块没有加载时，会自动降级至iptables</li>
</ul>
<h1 id="service_1">三、 service类型<a class="headerlink" href="#service_1" title="Permanent link">&para;</a></h1>
<p>Service类型决定了访问Service的方法</p>
<h2 id="31_service">3.1 service类型<a class="headerlink" href="#31_service" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>ClusterIP</p>
</li>
<li>
<p>默认，分配一个集群内部可以访问的虚拟IP</p>
</li>
<li>
<p>NodePort</p>
</li>
<li>
<p>在每个Node上分配一个端口作为外部访问入口</p>
</li>
<li>
<p>nodePort端口范围为:30000-32767</p>
</li>
<li>
<p>LoadBalancer</p>
</li>
<li>
<p>工作在特定的Cloud Provider上，例如Google Cloud，AWS，OpenStack</p>
</li>
<li>
<p>ExternalName</p>
</li>
<li>
<p>表示把集群外部的服务引入到集群内部中来，即实现了集群内部pod和集群外部的服务进行通信</p>
</li>
</ul>
<h2 id="32_service">3.2 Service参数<a class="headerlink" href="#32_service" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>port             访问service使用的端口</p>
</li>
<li>
<p>targetPort  Pod中容器端口</p>
</li>
<li>
<p>nodePort   通过Node实现外网用户访问k8s集群内service (30000-32767)</p>
</li>
</ul>
<h1 id="service_2">四、 Service创建<a class="headerlink" href="#service_2" title="Permanent link">&para;</a></h1>
<blockquote>
<p>Service的创建在工作中有两种方式，一是命令行创建，二是通过资源清单文件YAML文件创建。</p>
</blockquote>
<h2 id="41_clusterip">4.1 ClusterIP类型<a class="headerlink" href="#41_clusterip" title="Permanent link">&para;</a></h2>
<p>ClusterIP根据是否生成ClusterIP又可分为普通Service和Headless Service</p>
<p>Service两类：</p>
<ul>
<li>普通Service: </li>
</ul>
<p>为Kubernetes的Service分配一个集群内部可访问的固定虚拟IP(Cluster IP), 实现集群内的访问。</p>
<ul>
<li>Headless Service: </li>
</ul>
<p>该服务不会分配Cluster IP, 也不通过kube-proxy做反向代理和负载均衡。而是通过DNS提供稳定的网络ID来访问，DNS会将headless service的后端直接解析为pod IP列表。</p>
<p><img alt="image-20200531203549337" src="../../../img/kubernetes/kubernetes_core/image-20200531203549337.png" /></p>
<h3 id="411_clusterip_service">4.1.1 普通ClusterIP Service创建<a class="headerlink" href="#411_clusterip_service" title="Permanent link">&para;</a></h3>
<h4 id="4111_service">4.1.1.1 命令行创建Service<a class="headerlink" href="#4111_service" title="Permanent link">&para;</a></h4>
<ul>
<li>创建Deployment类型的应用</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># cat 01_create_deployment_app_nginx.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-server1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
     <span class="n">metadata</span><span class="p">:</span>
       <span class="n">labels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
     <span class="n">spec</span><span class="p">:</span>
       <span class="n">containers</span><span class="p">:</span>
       <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
         <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
         <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
         <span class="n">ports</span><span class="p">:</span>
         <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
</code></pre></div>
<ul>
<li>应用资源清单文件</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f 01_create_deployment_app_nginx.yaml</span>
</code></pre></div>
<ul>
<li>验证Deployment类型的创建情况</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get deployment.apps</span>
<span class="n">NAME</span>            <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">nginx-server1</span>   <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="n">2</span>            <span class="n">2</span>           <span class="n">13s</span>
</code></pre></div>
<ul>
<li>创建ClusterIP类型service与Deployment类型应用关联</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">命令创建service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl expose deployment.apps nginx-server1 --type=ClusterIP --target-port=80 --port=80</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">输出</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx-server1</span> <span class="n">exposed</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span>
<span class="n">expose</span> <span class="n">创建service</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span> <span class="n">控制器类型</span>
<span class="n">nginx-server1</span> <span class="n">应用名称</span><span class="err">，</span><span class="n">也是service名称</span>
<span class="p">-</span><span class="n">-type</span><span class="p">=</span><span class="n">ClusterIP</span> <span class="n">指定service类型</span>
<span class="p">-</span><span class="n">-target-port</span><span class="p">=</span><span class="n">80</span> <span class="n">指定Pod中容器端口</span>
<span class="p">-</span><span class="n">-port</span><span class="p">=</span><span class="n">80</span> <span class="n">指定service端口</span>
</code></pre></div>
<h4 id="4112_service">4.1.1.2 通过资源清单文件创建Service<a class="headerlink" href="#4112_service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># cat 02_create_deployment_app_nginx_with_service.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-server1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
     <span class="n">metadata</span><span class="p">:</span>
       <span class="n">labels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
     <span class="n">spec</span><span class="p">:</span>
       <span class="n">containers</span><span class="p">:</span>
       <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx-smart</span>
         <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
         <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
         <span class="n">ports</span><span class="p">:</span>
         <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-svc</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">ClusterIP</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl  apply -f 02_create_deployment_app_nginx_with_service.yaml</span>
</code></pre></div>
<ul>
<li>验证</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">查看service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get service</span>
<span class="n">NAME</span>         <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>       <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>    <span class="n">AGE</span>
<span class="n">kubernetes</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>    <span class="n">4d15h</span>
<span class="n">nginx-svc</span>    <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">101</span><span class="p">.</span><span class="n">153</span><span class="p">.</span><span class="n">50</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>    <span class="n">3s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看endpoints</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get endpoints</span>
<span class="n">NAME</span>         <span class="n">ENDPOINTS</span>                            <span class="n">AGE</span>
<span class="n">kubernetes</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">30</span><span class="p">:</span><span class="n">6443</span>                  <span class="n">4d15h</span>
<span class="n">nginx-svc</span>    <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">189</span><span class="p">.</span><span class="n">74</span><span class="p">:</span><span class="n">80</span><span class="p">,</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">235</span><span class="p">.</span><span class="n">150</span><span class="p">:</span><span class="n">80</span>   <span class="n">8s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看Pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -l app=nginx</span>
<span class="n">NAME</span>                             <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx-server1</span><span class="p">-</span><span class="n">77d4c485d8-gsrmq</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">12s</span>
<span class="n">nginx-server1</span><span class="p">-</span><span class="n">77d4c485d8-mmc52</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">12s</span>
</code></pre></div>
<h4 id="4113">4.1.1.3 访问<a class="headerlink" href="#4113" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl http://10.101.153.50:80</span>
<span class="p">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">title</span><span class="p">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">nginx</span><span class="p">!&lt;/</span><span class="n">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">style</span><span class="p">&gt;</span>
    <span class="n">body</span> <span class="p">{</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">35em</span><span class="p">;</span>
        <span class="n">margin</span><span class="p">:</span> <span class="n">0</span> <span class="n">auto</span><span class="p">;</span>
        <span class="n">font-family</span><span class="p">:</span> <span class="n">Tahoma</span><span class="p">,</span> <span class="n">Verdana</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="n">sans-serif</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="n">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">h1</span><span class="p">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">nginx</span><span class="p">!&lt;/</span><span class="n">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">If</span> <span class="n">you</span> <span class="n">see</span> <span class="n">this</span> <span class="n">page</span><span class="p">,</span> <span class="n">the</span> <span class="n">nginx</span> <span class="n">web</span> <span class="n">server</span> <span class="n">is</span> <span class="n">successfully</span> <span class="n">installed</span> <span class="n">and</span>
<span class="n">working</span><span class="p">.</span> <span class="n">Further</span> <span class="n">configuration</span> <span class="n">is</span> <span class="n">required</span><span class="p">.&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">For</span> <span class="n">online</span> <span class="n">documentation</span> <span class="n">and</span> <span class="n">support</span> <span class="n">please</span> <span class="n">refer</span> <span class="n">to</span>
<span class="p">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="p">=</span><span class="s2">&quot;http://nginx.org/&quot;</span><span class="p">&gt;</span><span class="n">nginx</span><span class="p">.</span><span class="n">org</span><span class="p">&lt;/</span><span class="n">a</span><span class="p">&gt;.&lt;</span><span class="n">br</span><span class="p">/&gt;</span>
<span class="n">Commercial</span> <span class="n">support</span> <span class="n">is</span> <span class="n">available</span> <span class="n">at</span>
<span class="p">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="p">=</span><span class="s2">&quot;http://nginx.com/&quot;</span><span class="p">&gt;</span><span class="n">nginx</span><span class="p">.</span><span class="n">com</span><span class="p">&lt;/</span><span class="n">a</span><span class="p">&gt;.&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;&lt;</span><span class="n">em</span><span class="p">&gt;</span><span class="n">Thank</span> <span class="n">you</span> <span class="k">for</span> <span class="n">using</span> <span class="n">nginx</span><span class="p">.&lt;/</span><span class="n">em</span><span class="p">&gt;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">html</span><span class="p">&gt;</span>
</code></pre></div>
<h4 id="4114_pod">4.1.1.4 两个pod里做成不同的主页方便测试负载均衡<a class="headerlink" href="#4114_pod" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it nginx-server1-77d4c485d8-gsrmq -- /bin/bash</span>
<span class="n">root</span><span class="nv">@deployment</span><span class="n">-nginx</span><span class="p">-</span><span class="n">6fcfb67547-nv7dn</span><span class="p">:/</span><span class="c"># cd /usr/share/nginx/html/</span>
<span class="n">root</span><span class="nv">@deployment</span><span class="n">-nginx</span><span class="p">-</span><span class="n">6fcfb67547-nv7dn</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="c"># echo web1 &gt; index.html</span>
<span class="n">root</span><span class="nv">@deployment</span><span class="n">-nginx</span><span class="p">-</span><span class="n">6fcfb67547-nv7dn</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="c"># exit</span>
<span class="n">exit</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it nginx-server1-77d4c485d8-mmc52 -- /bin/bash</span>
<span class="n">root</span><span class="nv">@deployment</span><span class="n">-nginx</span><span class="p">-</span><span class="n">6fcfb67547-rqrcw</span><span class="p">:/</span><span class="c"># cd /usr/share/nginx/html/</span>
<span class="n">root</span><span class="nv">@deployment</span><span class="n">-nginx</span><span class="p">-</span><span class="n">6fcfb67547-rqrcw</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="c"># echo web2 &gt; index.html</span>
<span class="n">root</span><span class="nv">@deployment</span><span class="n">-nginx</span><span class="p">-</span><span class="n">6fcfb67547-rqrcw</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="c"># exit</span>
<span class="n">exit</span>
</code></pre></div>
<h4 id="4115">4.1.1.5 测试<a class="headerlink" href="#4115" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl 10.101.153.50</span>
<span class="n">或</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># while true;do curl 10.101.153.50;sleep 1; done</span>
</code></pre></div>
<h3 id="412_headless_service">4.1.2 Headless Service<a class="headerlink" href="#412_headless_service" title="Permanent link">&para;</a></h3>
<ul>
<li>普通的ClusterIP service是service name解析为cluster ip,然后cluster ip对应到后面的pod ip</li>
<li>Headless service是指service name 直接解析为后面的pod ip</li>
</ul>
<h4 id="4121_deployment">4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件<a class="headerlink" href="#4121_deployment" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># cat 03_create_deployment_app_nginx.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-server1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
     <span class="n">metadata</span><span class="p">:</span>
       <span class="n">labels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
     <span class="n">spec</span><span class="p">:</span>
       <span class="n">containers</span><span class="p">:</span>
       <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx-smart</span>
         <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
         <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
         <span class="n">ports</span><span class="p">:</span>
         <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
</code></pre></div>
<h4 id="4122_headless_service">4.1.2.2 通过资源清单文件创建headless Service<a class="headerlink" href="#4122_headless_service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">编写YAML文件</span>
<span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># vim 04_headless-service.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">headless-service</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">ClusterIP</span>     <span class="c"># ClusterIP类型,也是默认类型</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">None</span>     <span class="c"># None就代表是无头service</span>
  <span class="n">ports</span><span class="p">:</span>                                <span class="c"># 指定service 端口及容器端口</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">80</span>                            <span class="c"># service ip中的端口</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>                      <span class="c"># pod中的端口</span>
  <span class="n">selector</span><span class="p">:</span>                             <span class="c"># 指定后端pod标签</span>
     <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>                    <span class="c"># 可通过kubectl get pod -l app=nginx查看哪些pod在使用此标签</span>
</code></pre></div>
<h4 id="4123_headless_service">4.1.2.3 应用资源清单文件创建headless Service<a class="headerlink" href="#4123_headless_service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl apply -f 04_headless_service.yml</span>
<span class="n">输出</span>
<span class="n">service</span><span class="p">/</span><span class="n">headless-service</span> <span class="n">created</span>
</code></pre></div>
<h4 id="4124_headless_service">4.1.2.4 查看已创建的headless Service<a class="headerlink" href="#4124_headless_service" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get svc</span>
<span class="n">输出</span>
<span class="n">NAME</span>               <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>       <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>          <span class="n">AGE</span>
<span class="n">headless-service</span>   <span class="n">ClusterIP</span>   <span class="n">None</span>             <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>           <span class="n">2m18s</span>
<span class="n">kubernetes</span>         <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>          <span class="n">5d9h</span>
<span class="n">可以看到headless-service没有CLUSTER-IP</span><span class="p">,</span><span class="n">用None表示</span>
</code></pre></div>
<h4 id="4125_dns">4.1.2.5 DNS<a class="headerlink" href="#4125_dns" title="Permanent link">&para;</a></h4>
<p>DNS服务监视Kubernetes API,为每一个Service创建DNS记录用于域名解析</p>
<p>headless service需要DNS来解决访问问题</p>
<p>DNS记录格式为: <service-name>.<namespace-name>.svc.cluster.local.</p>
<h5 id="41251_kube-dnsip">4.1.2.5.1 查看kube-dns服务的IP<a class="headerlink" href="#41251_kube-dnsip" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master1</span> <span class="p">~]</span><span class="c"># kubectl get svc -n kube-system</span>


<span class="n">输出</span>
<span class="n">NAME</span>             <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>      <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>                  <span class="n">AGE</span>
<span class="n">kube-dns</span>         <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">53</span><span class="p">/</span><span class="n">UDP</span><span class="p">,</span><span class="n">53</span><span class="p">/</span><span class="n">TCP</span><span class="p">,</span><span class="n">9153</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">5d9h</span>
<span class="n">metrics-server</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">105</span><span class="p">.</span><span class="n">219</span><span class="p">.</span><span class="n">44</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>                  <span class="n">45h</span>
<span class="n">查看到coreDNS的服务地址是10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span>
</code></pre></div>
<h5 id="41252_dnsdns">4.1.2.5.2 在集群主机通过DNS服务地址查找无头服务的dns解析<a class="headerlink" href="#41252_dnsdns" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># dig -t A headless-service.default.svc.cluster.local. @10.96.0.2</span>


<span class="n">输出</span>
<span class="p">;</span> <span class="p">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4-P2-RedHat</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">11</span><span class="p">.</span><span class="n">4</span><span class="p">-</span><span class="n">16</span><span class="p">.</span><span class="n">P2</span><span class="p">.</span><span class="n">el7_8</span><span class="p">.</span><span class="n">2</span> <span class="p">&lt;&lt;&gt;&gt;</span> <span class="n">-t</span> <span class="n">A</span> <span class="n">headless-service</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="nv">@10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span>
<span class="p">;;</span> <span class="n">global</span> <span class="n">options</span><span class="p">:</span> <span class="p">+</span><span class="n">cmd</span>
<span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
<span class="p">;;</span> <span class="n">WARNING</span><span class="p">:</span> <span class="p">.</span><span class="n">local</span> <span class="n">is</span> <span class="n">reserved</span> <span class="k">for</span> <span class="n">Multicast</span> <span class="n">DNS</span>
<span class="p">;;</span> <span class="n">You</span> <span class="n">are</span> <span class="n">currently</span> <span class="n">testing</span> <span class="n">what</span> <span class="n">happens</span> <span class="n">when</span> <span class="n">an</span> <span class="n">mDNS</span> <span class="n">query</span> <span class="n">is</span> <span class="n">leaked</span> <span class="n">to</span> <span class="n">DNS</span>
<span class="p">;;</span> <span class="p">-&gt;&gt;</span><span class="n">HEADER</span><span class="p">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="n">id</span><span class="p">:</span> <span class="n">31371</span>
<span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">qr</span> <span class="n">aa</span> <span class="n">rd</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="n">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="n">1</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="n">1</span>
<span class="p">;;</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">recursion</span> <span class="n">requested</span> <span class="n">but</span> <span class="n">not</span> <span class="n">available</span>

<span class="p">;;</span> <span class="n">OPT</span> <span class="n">PSEUDOSECTION</span><span class="p">:</span>
<span class="p">;</span> <span class="n">EDNS</span><span class="p">:</span> <span class="n">version</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">:;</span> <span class="n">udp</span><span class="p">:</span> <span class="n">4096</span>
<span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="p">;</span><span class="n">headless-service</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="k">IN</span> <span class="n">A</span> <span class="c">#被解析域名</span>

<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">headless-service</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="n">30</span> <span class="k">IN</span> <span class="n">A</span> <span class="n">10</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">235</span><span class="p">.</span><span class="n">147</span> <span class="c">#注意这里IP</span>

<span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="n">0</span> <span class="n">msec</span>
<span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53(10.96.0.2)</span>
<span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">May</span> <span class="n">17</span> <span class="n">10</span><span class="p">:</span><span class="n">58</span><span class="p">:</span><span class="n">50</span> <span class="n">CST</span> <span class="n">2020</span>
<span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="n">129</span>
</code></pre></div>
<h5 id="41253_podip">4.1.2.5.3  验证pod的IP<a class="headerlink" href="#41253_podip" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">输出</span>
<span class="n">NAME</span>                                <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>               <span class="n">NODE</span>      <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">nginx-deployment</span><span class="p">-</span><span class="n">56bf6c9c8c-jmk7r</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>            <span class="n">0</span>          <span class="n">35m</span>   <span class="n">10</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">235</span><span class="p">.</span><span class="n">147</span>   <span class="n">worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<h5 id="41254_pod">4.1.2.5.4 在集群中创建一个pod验证<a class="headerlink" href="#41254_pod" title="Permanent link">&para;</a></h5>
<blockquote>
<p>创建一个镜像为busyboxplus:curl的pod，pod名称为bb2,用来解析域名</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl run bbp --image=busyboxplus:curl -it</span>

<span class="n">或</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl run bbp --image=1.28 -it</span>

<span class="n">输出</span>
<span class="k">If</span> <span class="n">you</span> <span class="n">don</span><span class="s1">&#39;t see a command prompt, try pressing enter.</span>

<span class="s1">解析域名</span>
<span class="s1">nslookup headless-service.default.svc.cluster.local.</span>
<span class="s1">访问命令</span>
<span class="s1">[ root@bbp:/ ]$ curl http://headless-service.default.svc.cluster.local.</span>

<span class="s1">输出</span>
<span class="s1">&lt;!DOCTYPE html&gt;</span>
<span class="s1">&lt;html&gt;</span>
<span class="s1">&lt;head&gt;</span>
<span class="s1">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span>
<span class="s1">&lt;style&gt;</span>
<span class="s1">    body {</span>
<span class="s1">        width: 35em;</span>
<span class="s1">        margin: 0 auto;</span>
<span class="s1">        font-family: Tahoma, Verdana, Arial, sans-serif;</span>
<span class="s1">    }</span>
<span class="s1">&lt;/style&gt;</span>
<span class="s1">&lt;/head&gt;</span>
<span class="s1">&lt;body&gt;</span>
<span class="s1">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span>
<span class="s1">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span>
<span class="s1">working. Further configuration is required.&lt;/p&gt;</span>

<span class="s1">&lt;p&gt;For online documentation and support please refer to</span>
<span class="s1">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span>
<span class="s1">Commercial support is available at</span>
<span class="s1">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span>

<span class="s1">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span>
<span class="s1">&lt;/body&gt;</span>
<span class="s1">&lt;/html&gt;</span>
<span class="s1">[ root@bbp:/ ]$ exit</span>
<span class="s1">Session ended, resume using &#39;</span><span class="n">kubectl</span> <span class="n">attach</span> <span class="n">bbp</span> <span class="n">-c</span> <span class="n">bbp</span> <span class="n">-i</span> <span class="n">-t</span><span class="err">&#39;</span> <span class="n">command</span> <span class="n">when</span> <span class="n">the</span> <span class="n">pod</span> <span class="n">is</span> <span class="n">running</span>
</code></pre></div>
<h2 id="42_nodeport">4.2 NodePort类型<a class="headerlink" href="#42_nodeport" title="Permanent link">&para;</a></h2>
<ul>
<li>创建资源清单文件</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># cat 05_create_nodeport_service_app.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-app</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx-app</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx-app</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx-app</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-app</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx-app</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="n">30001</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">8060</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
</code></pre></div>
<ul>
<li>应用资源清单文件</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f 05_create_nodeport_service_app.yaml</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx-app</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx-app</span> <span class="n">created</span>
</code></pre></div>
<ul>
<li>验证service创建</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get deployment.apps</span>
<span class="n">NAME</span>         <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">nginx-app</span>    <span class="n">2</span><span class="p">/</span><span class="n">2</span>     <span class="n">2</span>            <span class="n">2</span>           <span class="n">26s</span>


<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get svc</span>
<span class="n">NAME</span>         <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>       <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>          <span class="n">AGE</span>
<span class="n">kubernetes</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>          <span class="n">2d22h</span>
<span class="n">nginx-app</span>    <span class="n">NodePort</span>    <span class="n">10</span><span class="p">.</span><span class="n">104</span><span class="p">.</span><span class="n">157</span><span class="p">.</span><span class="n">20</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">8060</span><span class="p">:</span><span class="n">30001</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">36s</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get endpoints</span>
<span class="n">NAME</span>         <span class="n">ENDPOINTS</span>                       <span class="n">AGE</span>
<span class="n">kubernetes</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">10</span><span class="p">:</span><span class="n">6443</span>             <span class="n">2d22h</span>
<span class="n">nginx-app</span>    <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">24</span><span class="p">:</span><span class="n">80</span><span class="p">,</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">20</span><span class="p">:</span><span class="n">80</span>   <span class="n">2m10s</span>


<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># ss -anput | grep &quot;:30001&quot;</span>
<span class="n">tcp</span>    <span class="n">LISTEN</span>     <span class="n">0</span>      <span class="n">128</span>      <span class="p">:::</span><span class="n">30001</span>                <span class="p">:::*</span>                   <span class="n">users</span><span class="p">:((</span><span class="s2">&quot;kube-proxy&quot;</span><span class="p">,</span><span class="n">pid</span><span class="p">=</span><span class="n">5826</span><span class="p">,</span><span class="n">fd</span><span class="p">=</span><span class="n">9</span><span class="p">))</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@worker01</span> <span class="p">~]</span><span class="c"># ss -anput | grep &quot;:30001&quot;</span>
<span class="n">tcp</span>    <span class="n">LISTEN</span>     <span class="n">0</span>      <span class="n">128</span>      <span class="p">:::</span><span class="n">30001</span>                <span class="p">:::*</span>                   <span class="n">users</span><span class="p">:((</span><span class="s2">&quot;kube-proxy&quot;</span><span class="p">,</span><span class="n">pid</span><span class="p">=</span><span class="n">4937</span><span class="p">,</span><span class="n">fd</span><span class="p">=</span><span class="n">11</span><span class="p">))</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@worker02</span> <span class="p">~]</span><span class="c"># ss -anput | grep &quot;:30001&quot;</span>
<span class="n">tcp</span>    <span class="n">LISTEN</span>     <span class="n">0</span>      <span class="n">128</span>      <span class="p">:::</span><span class="n">30001</span>                <span class="p">:::*</span>                   <span class="n">users</span><span class="p">:((</span><span class="s2">&quot;kube-proxy&quot;</span><span class="p">,</span><span class="n">pid</span><span class="p">=</span><span class="n">5253</span><span class="p">,</span><span class="n">fd</span><span class="p">=</span><span class="n">11</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx-app-ffd5ccc78-cnwbx</span>    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">8m59s</span>
<span class="n">nginx-app-ffd5ccc78-mz77g</span>    <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">8m59s</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it nginx-app-ffd5ccc78-cnwbx -- bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-app-ffd5ccc78-cnwbx</span><span class="p">:/</span><span class="c"># echo &quot;nginx-app-1&quot; &gt; /usr/share/nginx/html/index.html</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-app-ffd5ccc78-cnwbx</span><span class="p">:/</span><span class="c"># exit</span>
<span class="n">exit</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it nginx-app-ffd5ccc78-mz77g -- bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-app-ffd5ccc78-mz77g</span><span class="p">:/</span><span class="c"># echo &quot;nginx-app-2&quot; &gt; /usr/share/nginx/html/index.html</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-app-ffd5ccc78-mz77g</span><span class="p">:/</span><span class="c"># exit</span>
<span class="n">exit</span>
</code></pre></div>
<ul>
<li>在与kubernetes 节点同一网络主机中访问k8s集群内service</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@bogon</span> <span class="p">~]</span><span class="c"># curl http://192.168.10.12:30001</span>
<span class="n">nginx-app</span><span class="p">-</span><span class="n">2</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@bogon</span> <span class="p">~]</span><span class="c"># curl http://192.168.10.13:30001</span>
<span class="n">nginx-app</span><span class="p">-</span><span class="n">1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@bogon</span> <span class="p">~]</span><span class="c"># curl http://192.168.10.14:30001</span>
<span class="n">nginx-app</span><span class="p">-</span><span class="n">1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@bogon</span> <span class="p">~]</span><span class="c"># curl http://192.168.10.15:30001</span>
<span class="n">nginx-app</span><span class="p">-</span><span class="n">2</span>
</code></pre></div>
<h2 id="43_loadbalancer">4.3 LoadBalancer<a class="headerlink" href="#43_loadbalancer" title="Permanent link">&para;</a></h2>
<h3 id="431">4.3.1 集群外访问过程<a class="headerlink" href="#431" title="Permanent link">&para;</a></h3>
<ul>
<li>
<h4 id="_5">用户<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
</li>
<li>
<h4 id="_6">域名<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
</li>
<li>
<h4 id="lb">云服务提供商提供LB服务<a class="headerlink" href="#lb" title="Permanent link">&para;</a></h4>
</li>
<li>
<h4 id="nodeipportservice_ip">NodeIP:Port(service IP)<a class="headerlink" href="#nodeipportservice_ip" title="Permanent link">&para;</a></h4>
</li>
<li>
<h4 id="pod_ip">Pod IP：端口<a class="headerlink" href="#pod_ip" title="Permanent link">&para;</a></h4>
</li>
</ul>
<p><img alt="image-20200531203510735" src="../../../img/kubernetes/kubernetes_core/image-20200531203510735.png" /></p>
<h3 id="432_kubernetesloadbalancer-metallb">4.3.2  自建Kubernetes的LoadBalancer类型服务方案-MetalLB<a class="headerlink" href="#432_kubernetesloadbalancer-metallb" title="Permanent link">&para;</a></h3>
<p>MetalLB可以为kubernetes集群中的Service提供网络负载均衡功能。</p>
<p>MetalLB两大功能为:</p>
<ul>
<li>地址分配，类似于DHCP</li>
<li>外部通告，一旦MetalLB为服务分配了外部IP地址，它就需要使群集之外的网络意识到该IP在群集中“存在”。MetalLB使用标准路由协议来实现此目的：ARP，NDP或BGP。</li>
</ul>
<h4 id="4321">4.3.2.1  参考资料<a class="headerlink" href="#4321" title="Permanent link">&para;</a></h4>
<p>参考网址： <a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></p>
<h4 id="4322">4.3.2.2  应用资源清单文件<a class="headerlink" href="#4322" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">资源清单文件下载</span><span class="err">：</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml</span>
<span class="c"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml</span>
</code></pre></div>
<h4 id="4323_metallb">4.3.2.3 准备metallb配置文件<a class="headerlink" href="#4323_metallb" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nginx</span> <span class="n">metallb</span><span class="p">]</span><span class="c"># cat metallb-conf.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">metallb-system</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">config</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">config</span><span class="p">:</span> <span class="p">|</span>
    <span class="n">address-pools</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">default</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">layer2</span>
      <span class="n">addresses</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span><span class="p">-</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span>

<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span><span class="p">-</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100是集群节点服务器IP同一段</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在master01节点应用资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f metallb-conf.yaml   </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">验证配置</span>
<span class="c"># kubectl describe configmap config -n metallb-system</span>
<span class="n">Name</span><span class="p">:</span>         <span class="n">config</span>
<span class="n">Namespace</span><span class="p">:</span>    <span class="n">metallb-system</span>
<span class="n">Labels</span><span class="p">:</span>       <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">Annotations</span><span class="p">:</span>  <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

<span class="n">Data</span>
<span class="p">====</span>
<span class="n">config</span><span class="p">:</span>
<span class="p">----</span>
<span class="n">address-pools</span><span class="p">:</span>
<span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">default</span>
  <span class="n">protocol</span><span class="p">:</span> <span class="n">layer2</span>
  <span class="n">addresses</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span><span class="p">-</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span>

<span class="n">Events</span><span class="p">:</span>  <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<h4 id="4324serviceloadbalancerdeployment">4.3.2.4发布Service类型为LoadBalancer的Deployment控制器类型应用<a class="headerlink" href="#4324serviceloadbalancerdeployment" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">创建Deployment控制器类型应用nginx-metallb及service</span><span class="err">，</span><span class="n">service类型为LoadBalancer</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># vim 02_nginx-metabllb.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-metallb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx-metallb1</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>

<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-metallb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">8090</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">LoadBalancer</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f nginx.yaml</span>
</code></pre></div>
<h4 id="4325">4.3.2.5 验证<a class="headerlink" href="#4325" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get ns</span>
<span class="n">NAME</span>                   <span class="n">STATUS</span>   <span class="n">AGE</span>
<span class="k">default</span>                <span class="n">Active</span>   <span class="n">16d</span>
<span class="n">kube-node-lease</span>        <span class="n">Active</span>   <span class="n">16d</span>
<span class="n">kube-public</span>            <span class="n">Active</span>   <span class="n">16d</span>
<span class="n">kube-system</span>            <span class="n">Active</span>   <span class="n">16d</span>
<span class="n">kubernetes-dashboard</span>   <span class="n">Active</span>   <span class="n">13d</span>
<span class="n">metallb-system</span>         <span class="n">Active</span>   <span class="n">130m</span>
<span class="n">test1</span>                  <span class="n">Active</span>   <span class="n">12d</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -n metallb-system</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">controller</span><span class="p">-</span><span class="n">64f8f944d-qdf8m</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">110m</span>
<span class="n">speaker-cwzq7</span>                <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">110m</span>
<span class="n">speaker-qk5fb</span>                <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">110m</span>
<span class="n">speaker-wsllb</span>                <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">110m</span>
<span class="n">speaker-x4bwt</span>                <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">110m</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get svc</span>
<span class="n">NAME</span>            <span class="nb">TYPE </span>          <span class="n">CLUSTER-IP</span>      <span class="n">EXTERNAL-IP</span>      <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>          <span class="n">AGE</span>
<span class="n">kubernetes</span>      <span class="n">ClusterIP</span>      <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>       <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>          <span class="n">16d</span>
<span class="n">nginx-metallb</span>   <span class="n">LoadBalancer</span>   <span class="n">10</span><span class="p">.</span><span class="n">105</span><span class="p">.</span><span class="n">239</span><span class="p">.</span><span class="n">69</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span>   <span class="n">8090</span><span class="p">:</span><span class="n">31372</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">106m</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># ping 192.168.10.90</span>
<span class="n">PING</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span> <span class="p">(</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">64</span> <span class="n">time</span><span class="p">=</span><span class="n">3</span><span class="p">.</span><span class="n">45</span> <span class="n">ms</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">90</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">2</span> <span class="n">ttl</span><span class="p">=</span><span class="n">64</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">040</span> <span class="n">ms</span>
</code></pre></div>
<h4 id="4326">4.3.2.6 访问<a class="headerlink" href="#4326" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl http://192.168.122.90:8090</span>
<span class="p">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">title</span><span class="p">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">nginx</span><span class="p">!&lt;/</span><span class="n">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">style</span><span class="p">&gt;</span>
    <span class="n">body</span> <span class="p">{</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">35em</span><span class="p">;</span>
        <span class="n">margin</span><span class="p">:</span> <span class="n">0</span> <span class="n">auto</span><span class="p">;</span>
        <span class="n">font-family</span><span class="p">:</span> <span class="n">Tahoma</span><span class="p">,</span> <span class="n">Verdana</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="n">sans-serif</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="n">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">h1</span><span class="p">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">nginx</span><span class="p">!&lt;/</span><span class="n">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">If</span> <span class="n">you</span> <span class="n">see</span> <span class="n">this</span> <span class="n">page</span><span class="p">,</span> <span class="n">the</span> <span class="n">nginx</span> <span class="n">web</span> <span class="n">server</span> <span class="n">is</span> <span class="n">successfully</span> <span class="n">installed</span> <span class="n">and</span>
<span class="n">working</span><span class="p">.</span> <span class="n">Further</span> <span class="n">configuration</span> <span class="n">is</span> <span class="n">required</span><span class="p">.&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span><span class="k">For</span> <span class="n">online</span> <span class="n">documentation</span> <span class="n">and</span> <span class="n">support</span> <span class="n">please</span> <span class="n">refer</span> <span class="n">to</span>
<span class="p">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="p">=</span><span class="s2">&quot;http://nginx.org/&quot;</span><span class="p">&gt;</span><span class="n">nginx</span><span class="p">.</span><span class="n">org</span><span class="p">&lt;/</span><span class="n">a</span><span class="p">&gt;.&lt;</span><span class="n">br</span><span class="p">/&gt;</span>
<span class="n">Commercial</span> <span class="n">support</span> <span class="n">is</span> <span class="n">available</span> <span class="n">at</span>
<span class="p">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="p">=</span><span class="s2">&quot;http://nginx.com/&quot;</span><span class="p">&gt;</span><span class="n">nginx</span><span class="p">.</span><span class="n">com</span><span class="p">&lt;/</span><span class="n">a</span><span class="p">&gt;.&lt;/</span><span class="n">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;&lt;</span><span class="n">em</span><span class="p">&gt;</span><span class="n">Thank</span> <span class="n">you</span> <span class="k">for</span> <span class="n">using</span> <span class="n">nginx</span><span class="p">.&lt;/</span><span class="n">em</span><span class="p">&gt;&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">html</span><span class="p">&gt;</span>
</code></pre></div>
<p><img alt="image-20220402101421824" src="../../../img/kubernetes/kubernetes_core/image-20220402101421824.png" /></p>
<p><strong>注意：使用kubeadm部署kubernetes集群修改方法</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">如果在IPVS模式下使用kube-proxy</span><span class="err">，</span><span class="n">从Kubernetes</span> <span class="n">v1</span><span class="p">.</span><span class="n">14</span><span class="p">.</span><span class="n">2开始</span><span class="err">，</span><span class="n">必须启用ARP模式</span><span class="err">。</span>

<span class="n">可以通过在当前集群中编辑kube-proxy配置来实现</span><span class="err">：</span>
<span class="c"># kubectl edit configmap -n kube-system kube-proxy</span>

<span class="n">并设置</span><span class="err">：</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeproxy</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1alpha1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">KubeProxyConfiguration</span>
<span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;ipvs&quot;</span>
<span class="n">ipvs</span><span class="p">:</span>
  <span class="n">strictARP</span><span class="p">:</span> <span class="n">true</span>
</code></pre></div>
<h2 id="44_externalname">4.4 ExternalName<a class="headerlink" href="#44_externalname" title="Permanent link">&para;</a></h2>
<h3 id="441_externalname">4.4.1 ExternalName作用<a class="headerlink" href="#441_externalname" title="Permanent link">&para;</a></h3>
<ul>
<li>把集群外部的服务引入到集群内部中来，实现了集群内部pod和集群外部的服务进行通信</li>
<li>ExternalName 类型的服务适用于外部服务使用域名的方式，缺点是不能指定端口</li>
<li>还有一点要注意: 集群内的Pod会继承Node上的DNS解析规则。所以只要Node可以访问的服务，Pod中也可以访问到, 这就实现了集群内服务访问集群外服务</li>
</ul>
<h3 id="442">4.4.2   将公网域名引入<a class="headerlink" href="#442" title="Permanent link">&para;</a></h3>
<p>1, 编写YAML文件</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># vim externelname.yml</span>

<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">my-externalname</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">ExternalName</span>
  <span class="n">externalName</span><span class="p">:</span> <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span>                  <span class="c"># 对应的外部域名为www.baidu.com</span>
</code></pre></div>
<p>2, 应用YAML文件</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f externelname.yml</span>
 <span class="n">service</span><span class="p">/</span><span class="n">my-externalname</span> <span class="n">created</span>
</code></pre></div>
<p>3, 查看service</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get svc |grep exter</span>
 <span class="n">my-externalname</span>    <span class="n">ExternalName</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>         <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>         <span class="n">69s</span>
</code></pre></div>
<p>4, 查看my-service的dns解析</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># dig -t A my-externalname.default.svc.cluster.local. @10.96.0.2</span>

 <span class="p">;</span> <span class="p">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="n">9</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">4-RedHat</span><span class="p">-</span><span class="n">9</span><span class="p">.</span><span class="n">9</span><span class="p">.</span><span class="n">4</span><span class="p">-</span><span class="n">72</span><span class="p">.</span><span class="n">el7</span> <span class="p">&lt;&lt;&gt;&gt;</span> <span class="n">-t</span> <span class="n">A</span> <span class="n">my-externalname</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="nv">@10</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span>
 <span class="p">;;</span> <span class="n">global</span> <span class="n">options</span><span class="p">:</span> <span class="p">+</span><span class="n">cmd</span>
 <span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
 <span class="p">;;</span> <span class="p">-&gt;&gt;</span><span class="n">HEADER</span><span class="p">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="n">id</span><span class="p">:</span> <span class="n">31378</span>
 <span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">qr</span> <span class="n">aa</span> <span class="n">rd</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="n">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="n">4</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="n">1</span>
 <span class="p">;;</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">recursion</span> <span class="n">requested</span> <span class="n">but</span> <span class="n">not</span> <span class="n">available</span>

 <span class="p">;;</span> <span class="n">OPT</span> <span class="n">PSEUDOSECTION</span><span class="p">:</span>
 <span class="p">;</span> <span class="n">EDNS</span><span class="p">:</span> <span class="n">version</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">:;</span> <span class="n">udp</span><span class="p">:</span> <span class="n">4096</span>
 <span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
 <span class="p">;</span><span class="n">my-externalname</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="k">IN</span> <span class="n">A</span>

 <span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
 <span class="n">my-externalname</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span> <span class="n">5</span> <span class="k">IN</span> <span class="n">CNAME</span> <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>
 <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>          <span class="n">5</span>       <span class="k">IN</span>      <span class="n">CNAME</span>   <span class="n">www</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">shifen</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>
 <span class="n">www</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">shifen</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>       <span class="n">5</span>       <span class="k">IN</span>      <span class="n">A</span>       <span class="n">14</span><span class="p">.</span><span class="n">215</span><span class="p">.</span><span class="n">177</span><span class="p">.</span><span class="n">38</span>           <span class="n">解析的是百度的IP</span>
 <span class="n">www</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">shifen</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>       <span class="n">5</span>       <span class="k">IN</span>      <span class="n">A</span>       <span class="n">14</span><span class="p">.</span><span class="n">215</span><span class="p">.</span><span class="n">177</span><span class="p">.</span><span class="n">39</span>           <span class="n">解析的是百度的IP</span>

 <span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="n">32</span> <span class="n">msec</span>
 <span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span><span class="c">#53(10.96.0.2)</span>
 <span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Nov</span> <span class="n">05</span> <span class="n">11</span><span class="p">:</span><span class="n">23</span><span class="p">:</span><span class="n">41</span> <span class="n">CST</span> <span class="n">2020</span>
 <span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="n">245</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it deploy-nginx-6c9764bb69-86gwj -- /bin/sh</span>
 <span class="p">/</span> <span class="c"># nslookup www.baidu.com</span>
 <span class="p">......</span>
 <span class="n">Name</span><span class="p">:</span>      <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span>
 <span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">14</span><span class="p">.</span><span class="n">215</span><span class="p">.</span><span class="n">177</span><span class="p">.</span><span class="n">39</span>
 <span class="n">Address</span> <span class="n">2</span><span class="p">:</span> <span class="n">14</span><span class="p">.</span><span class="n">215</span><span class="p">.</span><span class="n">177</span><span class="p">.</span><span class="n">38</span>


 <span class="p">/</span> <span class="c"># nslookup my-externalname.default.svc.cluster.local         </span>
 <span class="p">......</span>
 <span class="n">Name</span><span class="p">:</span>      <span class="n">my-externalname</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
 <span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">14</span><span class="p">.</span><span class="n">215</span><span class="p">.</span><span class="n">177</span><span class="p">.</span><span class="n">38</span>
 <span class="n">Address</span> <span class="n">2</span><span class="p">:</span> <span class="n">14</span><span class="p">.</span><span class="n">215</span><span class="p">.</span><span class="n">177</span><span class="p">.</span><span class="n">39</span>
</code></pre></div>
<p>解析此<code>my-externalname.default.svc.cluster.local</code>域名和解析<code>www.baidu.com</code>是一样的结果</p>
<h3 id="443">4.4.3 不同命名空间访问<a class="headerlink" href="#443" title="Permanent link">&para;</a></h3>
<p>1， 创建ns1命名空间和相关deploy, pod,service</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># vim ns1-nginx.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>                                                  
<span class="n">kind</span><span class="p">:</span> <span class="n">Namespace</span>                                                 
<span class="n">metadata</span><span class="p">:</span>                                                             
  <span class="n">name</span><span class="p">:</span> <span class="n">ns1</span>                                                     <span class="c"># 创建ns1命名空间</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">deploy-nginx</span>                    
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns1</span>                                                <span class="c"># 属于ns1命名空间</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>                                  
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>                                
  <span class="n">template</span><span class="p">:</span>                                        
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>                             
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>                              
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">svc1</span>                                <span class="c"># 服务名</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns1</span>                            <span class="c"># 属于ns1命名空间</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">None</span>                           <span class="c"># 无头service</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">80</span>                         
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>                  
<span class="p">---</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">external-svc1</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns1</span>                            <span class="c">#  属于ns1命名空间</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">ExternalName</span>
  <span class="n">externalName</span><span class="p">:</span> <span class="n">svc2</span><span class="p">.</span><span class="n">ns2</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>   <span class="c"># 将ns2空间的svc2服务引入到ns1命名空间</span>


 <span class="p">[</span><span class="n">root</span><span class="nv">@master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f ns1-nginx.yml</span>
 <span class="n">namespace</span><span class="p">/</span><span class="n">ns1</span> <span class="n">created</span>
 <span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">created</span>
 <span class="n">service</span><span class="p">/</span><span class="n">svc1</span> <span class="n">created</span>
</code></pre></div>
<p>2， 创建ns2命名空间和相关deploy, pod,service</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># vim ns1-nginx.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>                                                  
<span class="n">kind</span><span class="p">:</span> <span class="n">Namespace</span>                                                 
<span class="n">metadata</span><span class="p">:</span>                                                             
  <span class="n">name</span><span class="p">:</span> <span class="n">ns2</span>                                                     <span class="c"># 创建ns2命名空间</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">deploy-nginx</span>                    
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns2</span>                                                <span class="c"># 属于ns2命名空间</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>                                  
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>                                
  <span class="n">template</span><span class="p">:</span>                                        
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>                             
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>                              
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">svc2</span>                                <span class="c"># 服务名</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns2</span>                            <span class="c"># 属于ns2命名空间</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">None</span>                           <span class="c"># 无头service</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">80</span>                         
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>                  
<span class="p">---</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">external-svc1</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">ns2</span>                            <span class="c">#  属于ns2命名空间</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">ExternalName</span>
  <span class="n">externalName</span><span class="p">:</span> <span class="n">svc1</span><span class="p">.</span><span class="n">ns1</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>   <span class="c"># 将ns1空间的svc1服务引入到ns2命名空间</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f ns2-nginx.yml</span>
 <span class="n">namespace</span><span class="p">/</span><span class="n">ns2</span> <span class="n">created</span>
 <span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">deploy-nginx</span> <span class="n">created</span>
 <span class="n">service</span><span class="p">/</span><span class="n">svc2</span> <span class="n">created</span>
 <span class="n">service</span><span class="p">/</span><span class="n">external-svc2</span> <span class="n">created</span>
</code></pre></div>
<p>3,  在ns1命名空间的pod里验证</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -n ns1</span>
 <span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
 <span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69-g5xl8</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">8m10s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span>
 <span class="p">/</span> <span class="c"># nslookup svc1</span>
 <span class="p">......</span>
 <span class="n">Name</span><span class="p">:</span>      <span class="n">svc1</span>
 <span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">140</span> <span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69-g5xl8</span>       <span class="n">IP与ns1里的podIP一致</span><span class="p">(</span><span class="n">见下面的查询结果</span><span class="p">)</span>

 <span class="p">/</span> <span class="c"># nslookup svc2.ns2.svc.cluster.local</span>
 <span class="p">.....</span>
 <span class="n">Name</span><span class="p">:</span>      <span class="n">svc2</span><span class="p">.</span><span class="n">ns2</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
 <span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">104</span><span class="p">.</span><span class="n">17</span> <span class="n">10</span><span class="p">-</span><span class="n">3</span><span class="p">-</span><span class="n">104</span><span class="p">-</span><span class="n">17</span><span class="p">.</span><span class="n">svc2</span><span class="p">.</span><span class="n">ns2</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>   <span class="n">IP与ns2里的podIP一致</span><span class="p">(</span><span class="n">见下面的查询结果</span><span class="p">)</span>

 <span class="p">/</span> <span class="c"># exit</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide -n ns1</span>
 <span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>             <span class="n">NODE</span>             <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
 <span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69-g5xl8</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">70m</span>   <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">140</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">13</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
 <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -o wide -n ns2</span>
 <span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>            <span class="n">NODE</span>             <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READI</span>            <span class="n">NESS</span> <span class="n">GATES</span>
 <span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69</span><span class="p">-</span><span class="n">8psxl</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">68m</span>   <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">104</span><span class="p">.</span><span class="n">17</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">14</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p>反之，在ns2命名空间的pod里访问<code>svc1.ns1.svc.cluster.local</code>，解析的IP是ns1命名空间里的pod的IP(请自行验证)</p>
<p>4， 验证ns2中的pod的IP变化, ns1中的pod仍然可以使用<code>svc2.ns2.svc.cluster.local</code>访问</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pod -n ns2</span>
 <span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
 <span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69</span><span class="p">-</span><span class="n">8psxl</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">81m</span>

 <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl delete pod deploy-nginx-6c9764bb69-8psxl -n ns2</span>
 <span class="n">pod</span> <span class="s2">&quot;deploy-nginx-6c9764bb69-8psxl&quot;</span> <span class="n">deleted</span>                   <span class="n">因为有replicas控制器</span><span class="err">，</span><span class="n">所以删除pod会自动拉一个起来</span>

 <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide -n ns2</span>
 <span class="n">NAME</span>                            <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">IP</span>             <span class="n">NODE</span>             <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
 <span class="n">deploy-nginx</span><span class="p">-</span><span class="n">6c9764bb69</span><span class="p">-</span><span class="n">8qbz2</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">5m36s</span>   <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">141</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">13</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

 <span class="n">pod名称变了</span><span class="p">,</span><span class="n">IP也变成了10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">141</span>
</code></pre></div>
<p>回到ns1中的pod验证</p>
<div class="highlight"><pre><span></span><code> <span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span>

 <span class="p">/</span> <span class="c"># ping svc2.ns2.svc.cluster.local -c 2</span>
 <span class="n">PING</span> <span class="n">svc2</span><span class="p">.</span><span class="n">ns2</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">141</span><span class="p">):</span> <span class="n">56</span> <span class="n">data</span> <span class="n">bytes</span>    <span class="n">解析的IP就是ns2中pod的新IP</span>
 <span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">141</span><span class="p">:</span> <span class="n">seq</span><span class="p">=</span><span class="n">0</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">181</span> <span class="n">ms</span>
 <span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">166</span><span class="p">.</span><span class="n">141</span><span class="p">:</span> <span class="n">seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">186</span> <span class="n">ms</span>

 <span class="p">---</span> <span class="n">svc2</span><span class="p">.</span><span class="n">ns2</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="p">---</span>
 <span class="n">2</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="n">2</span> <span class="n">packets</span> <span class="n">received</span><span class="p">,</span> <span class="n">0</span><span class="p">%</span> <span class="n">packet</span> <span class="n">loss</span>
 <span class="n">round-trip</span> <span class="n">min</span><span class="p">/</span><span class="n">avg</span><span class="p">/</span><span class="n">max</span> <span class="p">=</span> <span class="n">0</span><span class="p">.</span><span class="n">181</span><span class="p">/</span><span class="n">0</span><span class="p">.</span><span class="n">183</span><span class="p">/</span><span class="n">0</span><span class="p">.</span><span class="n">186</span> <span class="n">ms</span>
 <span class="p">/</span> <span class="c"># exit</span>
</code></pre></div>
<h1 id="sessionaffinity">五、sessionAffinity<a class="headerlink" href="#sessionaffinity" title="Permanent link">&para;</a></h1>
<blockquote>
<p>会话粘贴</p>
</blockquote>
<p>设置sessionAffinity为Clientip  (类似nginx的ip_hash算法,lvs的sh算法)</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@nginx</span> <span class="p">~]</span><span class="c"># cat 02_create_deployment_app_nginx_with_service.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-server1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
     <span class="n">metadata</span><span class="p">:</span>
       <span class="n">labels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
     <span class="n">spec</span><span class="p">:</span>
       <span class="n">containers</span><span class="p">:</span>
       <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c1</span>
         <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">15-alpine</span>
         <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
         <span class="n">ports</span><span class="p">:</span>
         <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-svc</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">ClusterIP</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl apply -f 02_create_deployment_app_nginx_with_service.yaml</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx-server1</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx-svc</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods</span>
<span class="n">NAME</span>                             <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx-server1</span><span class="p">-</span><span class="n">58845f75f4</span><span class="p">-</span><span class="n">9zlnw</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m11s</span>
<span class="n">nginx-server1</span><span class="p">-</span><span class="n">58845f75f4-ffqdt</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m11s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it nginx-server1-58845f75f4-9zlnw bash</span>
<span class="n">kubectl</span> <span class="n">exec</span> <span class="no">[POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD]</span> <span class="p">--</span> <span class="no">[COMMAND]</span> <span class="n">instead</span><span class="p">.</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-server1</span><span class="p">-</span><span class="n">58845f75f4</span><span class="p">-</span><span class="n">9zlnw</span><span class="p">:/</span><span class="c"># echo web1 &gt; /usr/share/nginx/html/index.html</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-server1</span><span class="p">-</span><span class="n">58845f75f4</span><span class="p">-</span><span class="n">9zlnw</span><span class="p">:/</span><span class="c"># exit</span>
<span class="n">exit</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl exec -it nginx-server1-58845f75f4-ffqdt bash</span>
<span class="n">kubectl</span> <span class="n">exec</span> <span class="no">[POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD]</span> <span class="p">--</span> <span class="no">[COMMAND]</span> <span class="n">instead</span><span class="p">.</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-server1</span><span class="p">-</span><span class="n">58845f75f4-ffqdt</span><span class="p">:/</span><span class="c"># echo web2 &gt; /usr/share/nginx/html/index.html</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-server1</span><span class="p">-</span><span class="n">58845f75f4-ffqdt</span><span class="p">:/</span><span class="c"># exit</span>
<span class="n">exit</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get svc</span>
<span class="n">NAME</span>         <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>     <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>   <span class="n">AGE</span>
<span class="n">kubernetes</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">16d</span>
<span class="n">nginx-svc</span>    <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">.</span><span class="n">53</span><span class="p">.</span><span class="n">31</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>    <span class="n">3m53s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl http://10.100.53.31</span>
<span class="n">web1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl http://10.100.53.31</span>
<span class="n">web2</span>
<span class="n">或</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># while true;do curl 10.100.53.31;sleep 1; done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl patch svc nginx-svc -p &#39;{&quot;spec&quot;:{&quot;sessionAffinity&quot;:&quot;ClientIP&quot;}}&#39;</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx-svc</span> <span class="n">patched</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl 10.100.53.31</span>
<span class="n">web1</span>
<span class="n">多次访问</span><span class="p">,</span><span class="n">会话粘贴</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">设置回sessionAffinity为None</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl patch svc nginx-svc -p &#39;{&quot;spec&quot;:{&quot;sessionAffinity&quot;:&quot;None&quot;}}&#39;</span>
<span class="n">service</span><span class="p">/</span><span class="n">my-service</span> <span class="n">patched</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">测试</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># curl 10.100.53.31</span>
<span class="n">web1</span>
<span class="n">多次访问</span><span class="p">,</span><span class="n">回到负载均衡</span>
<span class="n">或</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># while true;do curl 10.100.53.31;sleep 1; done</span>
<span class="n">web1</span>
<span class="n">多次访问</span><span class="p">,</span><span class="n">会话粘贴</span>
</code></pre></div>
<h1 id="ipvs">六、修改为ipvs调度方式（拓展）<a class="headerlink" href="#ipvs" title="Permanent link">&para;</a></h1>
<blockquote>
<p>部署方式不同，修改方法不一样。</p>
<p>本次主要介绍使用kubeadm部署集群方式，二进制部署较为简单。</p>
<p>二进制部署修改：/etc/kubernetes/kube-proxy.yaml文件即可。</p>
</blockquote>
<p>从kubernetes1.8版本开始，新增了kube-proxy对ipvs的支持，在kubernetes1.11版本中被纳入了GA.</p>
<h2 id="61_ipvs">6.1 修改为IPVS调度方式前升级内核<a class="headerlink" href="#61_ipvs" title="Permanent link">&para;</a></h2>
<blockquote>
<p>现使用Centos7u6发布版本，默认内核版本为3.10.0，使用kubernetes为1.18.0时，可升级内核版本至4.18.0或5.6.0版本。</p>
<p>在所有节点中安装,需要重启操作系统更换内核。以下升级方法供参考。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum -y install perl</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum  --enablerepo=&quot;elrepo-kernel&quot;  -y install kernel-ml.x86_64 </span>
<span class="n">此处升级为5</span><span class="p">.</span><span class="n">0以上版本</span><span class="err">。</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># grub2-set-default 0</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># grub2-mkconfig -o /boot/grub2/grub.cfg</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># reboot</span>
</code></pre></div>
<h2 id="62_kube-proxy">6.2 修改kube-proxy的配置文件<a class="headerlink" href="#62_kube-proxy" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl edit configmap kube-proxy -n kube-system</span>
     <span class="n">26</span>     <span class="n">iptables</span><span class="p">:</span>
     <span class="n">27</span>       <span class="n">masqueradeAll</span><span class="p">:</span> <span class="n">false</span>
     <span class="n">28</span>       <span class="n">masqueradeBit</span><span class="p">:</span> <span class="n">14</span>
     <span class="n">29</span>       <span class="n">minSyncPeriod</span><span class="p">:</span> <span class="n">0s</span>
     <span class="n">30</span>       <span class="n">syncPeriod</span><span class="p">:</span> <span class="n">30s</span>
     <span class="n">31</span>     <span class="n">ipvs</span><span class="p">:</span>
     <span class="n">32</span>       <span class="n">excludeCIDRs</span><span class="p">:</span> <span class="n">null</span>
     <span class="n">33</span>       <span class="n">minSyncPeriod</span><span class="p">:</span> <span class="n">0s</span>
     <span class="n">34</span>       <span class="n">scheduler</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>   <span class="c"># 可以在这里修改ipvs的算法,默认为rr轮循算法</span>
     <span class="n">35</span>       <span class="n">strictARP</span><span class="p">:</span> <span class="n">false</span>
     <span class="n">36</span>       <span class="n">syncPeriod</span><span class="p">:</span> <span class="n">30s</span>
     <span class="n">37</span>     <span class="n">kind</span><span class="p">:</span> <span class="n">KubeProxyConfiguration</span>
     <span class="n">38</span>     <span class="n">metricsBindAddress</span><span class="p">:</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">10249</span>
     <span class="n">39</span>     <span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;ipvs&quot;</span>      <span class="c"># 默认&quot;&quot;号里为空,加上ipvs</span>
</code></pre></div>
<h2 id="63_kube-systemnamespacekube-proxypod">6.3  查看kube-system的namespace中kube-proxy有关的pod<a class="headerlink" href="#63_kube-systemnamespacekube-proxypod" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -n kube-system |grep kube-proxy</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">69mv6</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">6</span>          <span class="n">2d18h</span>
<span class="n">kube-proxy-jpc6c</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">4</span>          <span class="n">4d16h</span>
<span class="n">kube-proxy-kq65l</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">4</span>          <span class="n">4d16h</span>
<span class="n">kube-proxy-lmphf</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">5</span>          <span class="n">4d16h</span>
</code></pre></div>
<h2 id="64_kube-proxy-xxxpod">6.4 验证kube-proxy-xxx的pod中的信息<a class="headerlink" href="#64_kube-proxy-xxxpod" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl logs kube-proxy-jpc6c -n kube-system</span>
<span class="n">W0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">914754</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">559</span><span class="p">]</span> <span class="n">Unknown</span> <span class="n">proxy</span> <span class="n">mode</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">assuming</span> <span class="n">iptables</span> <span class="n">proxy</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">923228</span>       <span class="n">1</span> <span class="n">node</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">136</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">retrieved</span> <span class="n">node</span> <span class="n">IP</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">32</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">923264</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">186</span><span class="p">]</span> <span class="n">Using</span> <span class="n">iptables</span> <span class="n">Proxier</span><span class="p">.</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">923567</span>       <span class="n">1</span> <span class="n">server</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">583</span><span class="p">]</span> <span class="n">Version</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">18</span><span class="p">.</span><span class="n">2</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">923965</span>       <span class="n">1</span> <span class="n">conntrack</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">100</span><span class="p">]</span> <span class="nb">Set </span><span class="n">sysctl</span> <span class="s1">&#39;net/netfilter/nf_conntrack_max&#39;</span> <span class="n">to</span> <span class="n">131072</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">924001</span>       <span class="n">1</span> <span class="n">conntrack</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">52</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">nf_conntrack_max</span> <span class="n">to</span> <span class="n">131072</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">924258</span>       <span class="n">1</span> <span class="n">conntrack</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">83</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">conntrack</span> <span class="n">hashsize</span> <span class="n">to</span> <span class="n">32768</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">927041</span>       <span class="n">1</span> <span class="n">conntrack</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">100</span><span class="p">]</span> <span class="nb">Set </span><span class="n">sysctl</span> <span class="s1">&#39;net/netfilter/nf_conntrack_tcp_timeout_established&#39;</span> <span class="n">to</span> <span class="n">86400</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">927086</span>       <span class="n">1</span> <span class="n">conntrack</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">100</span><span class="p">]</span> <span class="nb">Set </span><span class="n">sysctl</span> <span class="s1">&#39;net/netfilter/nf_conntrack_tcp_timeout_close_wait&#39;</span> <span class="n">to</span> <span class="n">3600</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">927540</span>       <span class="n">1</span> <span class="n">config</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">315</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">service</span> <span class="n">config</span> <span class="n">controller</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">927556</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">223</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">caches</span> <span class="n">to</span> <span class="n">sync</span> <span class="k">for</span> <span class="n">service</span> <span class="n">config</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">927576</span>       <span class="n">1</span> <span class="n">config</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">133</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">endpoints</span> <span class="n">config</span> <span class="n">controller</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">927594</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">223</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">caches</span> <span class="n">to</span> <span class="n">sync</span> <span class="k">for</span> <span class="n">endpoints</span> <span class="n">config</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">11</span><span class="p">.</span><span class="n">027749</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">230</span><span class="p">]</span> <span class="n">Caches</span> <span class="n">are</span> <span class="n">synced</span> <span class="k">for</span> <span class="n">service</span> <span class="n">config</span>
<span class="n">I0517</span> <span class="n">00</span><span class="p">:</span><span class="n">55</span><span class="p">:</span><span class="n">11</span><span class="p">.</span><span class="n">027858</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">230</span><span class="p">]</span> <span class="n">Caches</span> <span class="n">are</span> <span class="n">synced</span> <span class="k">for</span> <span class="n">endpoints</span> <span class="n">config</span>
</code></pre></div>
<h2 id="65_kube-proxy">6.5 重新启动kube-proxy<a class="headerlink" href="#65_kube-proxy" title="Permanent link">&para;</a></h2>
<blockquote>
<p>删除kube-proxy-xxx的所有pod，让它重新拉取新的kube-proxy-xxx的pod</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl delete pod kube-proxy-69mv6 -n kube-system</span>
<span class="n">pod</span> <span class="s2">&quot;kube-proxy-69mv6&quot;</span> <span class="n">deleted</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl delete pod kube-proxy-jpc6c -n kube-system</span>
<span class="n">pod</span> <span class="s2">&quot;kube-proxy-jpc6c&quot;</span> <span class="n">deleted</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl delete pod kube-proxy-kq65l -n kube-system</span>
<span class="n">pod</span> <span class="s2">&quot;kube-proxy-kq65l&quot;</span> <span class="n">deleted</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl delete pod kube-proxy-lmphf -n kube-system</span>
<span class="n">pod</span> <span class="s2">&quot;kube-proxy-lmphf&quot;</span> <span class="n">deleted</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@master01</span> <span class="p">~]</span><span class="c"># kubectl get pods -n kube-system |grep kube-proxy</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">2mk2b</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m23s</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">5bj87</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">30s</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">7qq9l</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">52s</span>
<span class="n">kube-proxy-tjtqf</span>                           <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">80s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">随意查看其中1个或3个kube-proxy-xxx的pod</span><span class="p">,</span><span class="n">验证是否为IPVS方式了</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@master1</span> <span class="p">~]</span><span class="c"># kubectl logs kube-proxy-tjtqf -n kube-system</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">557696</span>       <span class="n">1</span> <span class="n">node</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">136</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">retrieved</span> <span class="n">node</span> <span class="n">IP</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">122</span><span class="p">.</span><span class="n">32</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">557745</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">259</span><span class="p">]</span> <span class="n">Using</span> <span class="n">ipvs</span> <span class="n">Proxier</span><span class="p">.</span>
<span class="n">W0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">557912</span>       <span class="n">1</span> <span class="n">proxier</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">429</span><span class="p">]</span> <span class="n">IPVS</span> <span class="n">scheduler</span> <span class="n">not</span> <span class="n">specified</span><span class="p">,</span> <span class="n">use</span> <span class="n">rr</span> <span class="n">by</span> <span class="k">default</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">560008</span>       <span class="n">1</span> <span class="n">server</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">583</span><span class="p">]</span> <span class="n">Version</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">18</span><span class="p">.</span><span class="n">2</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">560428</span>       <span class="n">1</span> <span class="n">conntrack</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">52</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">nf_conntrack_max</span> <span class="n">to</span> <span class="n">131072</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">561094</span>       <span class="n">1</span> <span class="n">config</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">315</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">service</span> <span class="n">config</span> <span class="n">controller</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">562251</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">223</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">caches</span> <span class="n">to</span> <span class="n">sync</span> <span class="k">for</span> <span class="n">service</span> <span class="n">config</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">561579</span>       <span class="n">1</span> <span class="n">config</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">133</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">endpoints</span> <span class="n">config</span> <span class="n">controller</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">562271</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">223</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">caches</span> <span class="n">to</span> <span class="n">sync</span> <span class="k">for</span> <span class="n">endpoints</span> <span class="n">config</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">662541</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">230</span><span class="p">]</span> <span class="n">Caches</span> <span class="n">are</span> <span class="n">synced</span> <span class="k">for</span> <span class="n">service</span> <span class="n">config</span>
<span class="n">I0517</span> <span class="n">02</span><span class="p">:</span><span class="n">32</span><span class="p">:</span><span class="n">26</span><span class="p">.</span><span class="n">662566</span>       <span class="n">1</span> <span class="n">shared_informer</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">230</span><span class="p">]</span> <span class="n">Caches</span> <span class="n">are</span> <span class="n">synced</span> <span class="k">for</span> <span class="n">endpoints</span> <span class="n">config</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      BurningMyself<a href='https://beian.miit.gov.cn/' target='_blank'>  蜀ICP备15033200号-1</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/burningmyself" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitee.com/burningmyself" target="_blank" rel="noopener" title="gitee.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155084439-1"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155132293-1"></script>
      
        <script src="../../../js/google.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>