
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content=".net,java,php,python,docker,web">
      
      
        <meta name="author" content="BurningMyself">
      
      
        <link rel="canonical" href="https://burningmyself.gitee.io/cloud/kubernetes/kubernetes_flannel/">
      
      
        <link rel="prev" href="../kubernetes_kustomize/">
      
      
        <link rel="next" href="../kubernetes_calico/">
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>kubernetes集群网络解决方案 flannel - BurningMyself</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="BurningMyself" class="md-header__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BurningMyself
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes集群网络解决方案 flannel
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BurningMyself" class="md-nav__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BurningMyself
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          技术博文
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          技术博文
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          .NET
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          .NET
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sharp/" class="md-nav__link">
        C#新特性语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_docker/" class="md-nav__link">
        .Net Core Docker 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sqlserver_nginx/" class="md-nav__link">
        Docker 容器化部署 ASP.NET Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_safety/" class="md-nav__link">
        让你的ASP.NET Core应用程序更安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_study_route/" class="md-nav__link">
        ASP.NET Core开发者指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/feature/" class="md-nav__link">
        Java特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/load-class/" class="md-nav__link">
        Java类加载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/orm/" class="md-nav__link">
        Orm的优缺点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/bio-nio/" class="md-nav__link">
        BIO与NIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/rocketmq/rmq-1/" class="md-nav__link">
        RocketMq下载与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springAnnotation/" class="md-nav__link">
        Spring常用注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/javavm/" class="md-nav__link">
        Java 虚拟机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springdesign/" class="md-nav__link">
        Spring 常用设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/spring-cloud/" class="md-nav__link">
        Spring Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-simple/" class="md-nav__link">
        Java simple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-validator/" class="md-nav__link">
        Java Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-string/" class="md-nav__link">
        Java String
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-utils/" class="md-nav__link">
        Java Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/feature/" class="md-nav__link">
        Python特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/str_joint/" class="md-nav__link">
        Python字符拼接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/syntax_rule/" class="md-nav__link">
        Python语法技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/fabric/" class="md-nav__link">
        远程部署神器 Fabric
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          Go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../go/go_base/" class="md-nav__link">
        Go基础语法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          PHP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          PHP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../php/kj/" class="md-nav__link">
        框架
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/es6/" class="md-nav__link">
        es6语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/ali_js_style/" class="md-nav__link">
        阿里js样式规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/node.js/" class="md-nav__link">
        node.js文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react/" class="md-nav__link">
        React 开发者指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../dart/syntax/" class="md-nav__link">
        Dart语法学习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react_interview/" class="md-nav__link">
        React 面试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/js_tool_method/" class="md-nav__link">
        js 工具函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/vue_cp_react/" class="md-nav__link">
        vue与react比较
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/javascript/" class="md-nav__link">
        JavaScript 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh17/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_log/" class="md-nav__link">
        MySQL日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_index/" class="md-nav__link">
        MySQL索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_pxc/" class="md-nav__link">
        MySQL PXC集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_use/" class="md-nav__link">
        MySQL 数据库应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_backups/" class="md-nav__link">
        MySql 备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/sql_server_master/" class="md-nav__link">
        Sql Server 主从备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/data_split/" class="md-nav__link">
        数据库之互联网常用分库分表方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mybatis/" class="md-nav__link">
        Mybatis使用心德
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/linux/" class="md-nav__link">
        Linux学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/often/" class="md-nav__link">
        常用命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/ope/" class="md-nav__link">
        实用的Linux 命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker/" class="md-nav__link">
        Docker全科
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker_core/" class="md-nav__link">
        Docker 核心技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-compose/" class="md-nav__link">
        docker和docker-compose配置常用环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-jenkins/" class="md-nav__link">
        Docker部署Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-phabricator/" class="md-nav__link">
        Docker部署Phabricator
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_fw_rule_and_object_design/" class="md-nav__link">
        Kubernetes架构原则和对象设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_etcd/" class="md-nav__link">
        Kubernetes控制平面组件etcd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_kube_APIServer/" class="md-nav__link">
        深入理解Kube-APIServer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_controller_manager/" class="md-nav__link">
        kubernetes控制平面组件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
      
      
      
        <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
          Tool
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_11">
          <span class="md-nav__icon md-icon"></span>
          Tool
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitusual/" class="md-nav__link">
        Git动画展示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitquestion/" class="md-nav__link">
        Git问题处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitflow/" class="md-nav__link">
        GitFlow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitbook/" class="md-nav__link">
        GitBook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitcmr/" class="md-nav__link">
        Git提交日志规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/markdown/" class="md-nav__link">
        Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cicd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/mkdocs/" class="md-nav__link">
        mkdocs简单使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitstudy/" class="md-nav__link">
        Git的黑魔法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/minio/" class="md-nav__link">
        MinIO 搭建使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cat-monitoring/" class="md-nav__link">
        Cat分布式监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          云架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          云架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../native/" class="md-nav__link">
        云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../virtual/" class="md-nav__link">
        虚拟化技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compute/" class="md-nav__link">
        云计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprelease/" class="md-nav__link">
        应用部署容器化演进
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlinux/" class="md-nav__link">
        容器技术所涉及Linux内核关键技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_native/" class="md-nav__link">
        容器管理工具Docker生态架构及部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_nginx/" class="md-nav__link">
        使用容器运行Nginx应用及Docker命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image/" class="md-nav__link">
        Docker容器镜像
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image_fast/" class="md-nav__link">
        Docker容器镜像加速器及本地容器镜像仓库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container_enterprice/" class="md-nav__link">
        Docker容器化部署企业级应用集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_file/" class="md-nav__link">
        Dockerfile精讲及新型容器镜像构建技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_network/" class="md-nav__link">
        Docker容器网络与通信原理深度解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_date/" class="md-nav__link">
        Docker容器数据持久化存储机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_compose/" class="md-nav__link">
        Docker容器服务编排利器Docker Compose应用实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_swarm/" class="md-nav__link">
        Docker主机集群化方案 Docker Swarm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_devops/" class="md-nav__link">
        基于Docker容器DevOps应用方案 企业业务代码发布系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container/" class="md-nav__link">
        轻量级或工业级容器管理工具
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        kubeadm极速部署Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_introduce/" class="md-nav__link">
        kubernetes介绍与集群架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_way/" class="md-nav__link">
        Kubernetes集群部署方式说明
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_master/" class="md-nav__link">
        kubeadm部署单Master节点kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight/" class="md-nav__link">
        kubeadm部署高可用kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rke/" class="md-nav__link">
        使用RKE构建企业生产级Kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin1/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin2/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Containerd）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        Kubernetes集群UI及主机资源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_sealos/" class="md-nav__link">
        使用sealos部署kubernetes集群并实现集群管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        kubernetes集群命令语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_core/" class="md-nav__link">
        Kubernetes核心概念
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_nginx_ingress_controller/" class="md-nav__link">
        Kubernetes集群 服务暴露 Nginx Ingress Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_traefik/" class="md-nav__link">
        Kubernetes集群 服务暴露 Traefik
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_configMap_secret/" class="md-nav__link">
        Kubernetes配置与密钥管理 ConfigMap&Secret
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_harbor/" class="md-nav__link">
        Kubernetes集群使用容器镜像仓库Harbor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_safety/" class="md-nav__link">
        Kubernetes集群安全管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_volume/" class="md-nav__link">
        kubernetes持久化存储卷
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_ceph/" class="md-nav__link">
        kubernetes存储解决方案Ceph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster_serve/" class="md-nav__link">
        Kubernetes集群公共服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_java/" class="md-nav__link">
        kubernetes集群java项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_python/" class="md-nav__link">
        kubernetes集群Python项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_golang/" class="md-nav__link">
        Kubernetes集群golang项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_helm_prometheus/" class="md-nav__link">
        helm部署prometheus监控系统及应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_logs_collect/" class="md-nav__link">
        kubernetes日志收集方案ELK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_zookeeper/" class="md-nav__link">
        企业级中间件上云部署zookeeper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kafka/" class="md-nav__link">
        kubernetes云原生中间件上云部署kafka
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rokectmq/" class="md-nav__link">
        rocketmq部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_helm/" class="md-nav__link">
        Kubernetes集群包管理解决方案 Helm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kustomize/" class="md-nav__link">
        Kubernetes原生配置管理利器 kustomize
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          kubernetes集群网络解决方案 flannel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        kubernetes集群网络解决方案 flannel
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1 单主集群
  </a>
  
    <nav class="md-nav" aria-label="1.1 单主集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    1.1.1 基础环境部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    1.1.2 集群基础环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    1.1.3 容器环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114" class="md-nav__link">
    1.1.4 仓库环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#115_master" class="md-nav__link">
    1.1.5 master环境部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116_node" class="md-nav__link">
    1.1.6 node环境部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#117" class="md-nav__link">
    1.1.7 集群环境实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#118" class="md-nav__link">
    1.1.8 资源对象解读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#119" class="md-nav__link">
    1.1.9 资源对象实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    1.2 多主集群
  </a>
  
    <nav class="md-nav" aria-label="1.2 多主集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121" class="md-nav__link">
    1.2.1 集群环境解读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122" class="md-nav__link">
    1.2.2 高可用环境实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123" class="md-nav__link">
    1.2.3 集群初始化实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124" class="md-nav__link">
    1.2.4 工作节点实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125" class="md-nav__link">
    1.2.5 集群初始化解读
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    1.3 综合实践
  </a>
  
    <nav class="md-nav" aria-label="1.3 综合实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131" class="md-nav__link">
    1.3.1 应用案例解读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132" class="md-nav__link">
    1.3.2 应用环境定制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133" class="md-nav__link">
    1.3.3 应用环境实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#134" class="md-nav__link">
    1.3.4 应用环境升级
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_calico/" class="md-nav__link">
        kubernetes集群网络解决方案 calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hybridnet/" class="md-nav__link">
        kubernetes集群 underlay 网络方案 hybridnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ipv4_and_ipv6/" class="md-nav__link">
        kubernetes版本双栈协议（IPv4&IPv6）集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rancher/" class="md-nav__link">
        Rancher容器云管理平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubeconfig/" class="md-nav__link">
        使用kubeconfig管理多集群方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_karmada/" class="md-nav__link">
        karmada实现k8s集群联邦
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubesphere/" class="md-nav__link">
        安装kubesphere使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ack/" class="md-nav__link">
        阿里云容器服务ACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_devops/" class="md-nav__link">
        基于kubernetes集群构建大中型企业CICD应用平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubesphere_devops/" class="md-nav__link">
        基于KubeSphere实现DevOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_gitops/" class="md-nav__link">
        云原生多云持续交付GitOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_velero/" class="md-nav__link">
        kubernetes集群备份与恢复管理利器Velero
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kurator/" class="md-nav__link">
        kubernetes集群舰队管理Kurator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_openfass/" class="md-nav__link">
        Serverless之OpenFaaS函数即服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_flink/" class="md-nav__link">
        Flink基于Kubernetes部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hdfs/" class="md-nav__link">
        大数据HDFS分布式文件系统搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_spark/" class="md-nav__link">
        Spark与Kubernetes整合
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          微服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          微服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/fbs-lock/" class="md-nav__link">
        分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/design/" class="md-nav__link">
        微服务设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/distrimsg/" class="md-nav__link">
        分布式系统与消息的投递
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/ddd/" class="md-nav__link">
        基于DDD的微服务设计和开发实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/kafka/" class="md-nav__link">
        Kafka架构原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/redis_cluster/" class="md-nav__link">
        Redis Cluster原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/spring-cloud-micro/" class="md-nav__link">
        分布式架构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          经验分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          经验分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/devops/" class="md-nav__link">
        DevOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/micro-service/" class="md-nav__link">
        Micro-Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/raft-gossip/" class="md-nav__link">
        Raft算法和Gossip协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cl/" class="md-nav__link">
        集群和负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/ai/" class="md-nav__link">
        人工智能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/code-principle/" class="md-nav__link">
        代码原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/techbig/" class="md-nav__link">
        如何成为技术大牛
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/learnweetout/" class="md-nav__link">
        程序员如何技术成长
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/pt/" class="md-nav__link">
        产品与技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/four_deep_learning/" class="md-nav__link">
        深度学习框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/tl/" class="md-nav__link">
        在阿里做了5年技术Leader，我总结出这些套路！
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cto/" class="md-nav__link">
        CTO 技能图谱
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          构架
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          构架
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/split/" class="md-nav__link">
        构架拆分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fgb/" class="md-nav__link">
        分布式、高并发、多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/agility/" class="md-nav__link">
        如何理解敏捷开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fwork/" class="md-nav__link">
        走向架构师必备的技能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/data_middle/" class="md-nav__link">
        数据中台的思考与总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/algorithm-ten/" class="md-nav__link">
        必学的 10 大算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          情感
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          情感
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/eq/" class="md-nav__link">
        情商
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/workheard/" class="md-nav__link">
        工作心得
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lookbook/" class="md-nav__link">
        看书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/selfdiscipline/" class="md-nav__link">
        自律
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/livefail/" class="md-nav__link">
        为什么活着失败
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/emotion/" class="md-nav__link">
        情绪管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/losecome/" class="md-nav__link">
        所有的失去，都会以另一种方式归来
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/threeheart/" class="md-nav__link">
        人生有这三种好心态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/onepath/" class="md-nav__link">
        余生，学会一个人走，不管有没有人陪
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/twopath/" class="md-nav__link">
        往后余生还很精彩，别被熬夜拖垮了
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lifetime/" class="md-nav__link">
        心态好的人，一辈子都好
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1 单主集群
  </a>
  
    <nav class="md-nav" aria-label="1.1 单主集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    1.1.1 基础环境部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    1.1.2 集群基础环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    1.1.3 容器环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114" class="md-nav__link">
    1.1.4 仓库环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#115_master" class="md-nav__link">
    1.1.5 master环境部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116_node" class="md-nav__link">
    1.1.6 node环境部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#117" class="md-nav__link">
    1.1.7 集群环境实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#118" class="md-nav__link">
    1.1.8 资源对象解读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#119" class="md-nav__link">
    1.1.9 资源对象实践
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    1.2 多主集群
  </a>
  
    <nav class="md-nav" aria-label="1.2 多主集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121" class="md-nav__link">
    1.2.1 集群环境解读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122" class="md-nav__link">
    1.2.2 高可用环境实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123" class="md-nav__link">
    1.2.3 集群初始化实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124" class="md-nav__link">
    1.2.4 工作节点实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125" class="md-nav__link">
    1.2.5 集群初始化解读
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    1.3 综合实践
  </a>
  
    <nav class="md-nav" aria-label="1.3 综合实践">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131" class="md-nav__link">
    1.3.1 应用案例解读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132" class="md-nav__link">
    1.3.2 应用环境定制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133" class="md-nav__link">
    1.3.3 应用环境实践
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#134" class="md-nav__link">
    1.3.4 应用环境升级
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="1">1 集群环境实践<a class="headerlink" href="#1" title="Permanent link">&para;</a></h1>
<h2 id="11">1.1 单主集群<a class="headerlink" href="#11" title="Permanent link">&para;</a></h2>
<h3 id="111">1.1.1 基础环境部署<a class="headerlink" href="#111" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 集群规划、主机认证、小结 三个方面来学习。</p>
<p><strong>集群规划</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">在这里</span><span class="err">，</span><span class="n">我们以单主分布式的主机节点效果来演示kubernetes的最新版本的集群环境部署</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220715092558666" src="../../../img/kubernetes/kubernetes_flannel/image-20220715092558666.png" /></p>
<p>节点集群组件规划</p>
<p><img alt="image-20220715093007357" src="../../../img/kubernetes/kubernetes_flannel/image-20220715093007357.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">master节点</span>
    <span class="n">kubeadm</span><span class="p">(</span><span class="n">集群环境</span><span class="p">)</span><span class="err">、</span><span class="n">kubectl</span><span class="p">(</span><span class="n">集群管理</span><span class="p">)</span><span class="err">、</span><span class="n">kubelet</span><span class="p">(</span><span class="n">节点状态</span><span class="p">)</span>
    <span class="n">kube-apiserver</span><span class="err">、</span><span class="n">kube-controller-manager</span><span class="err">、</span><span class="n">kube-scheduler</span><span class="err">、</span><span class="n">etcd</span>
    <span class="n">containerd</span><span class="p">(</span><span class="n">docker方式部署</span><span class="p">)</span><span class="err">、</span><span class="n">flannel</span><span class="p">(</span><span class="n">插件部署</span><span class="p">)</span>
<span class="n">node节点</span>
    <span class="n">kubeadm</span><span class="p">(</span><span class="n">集群环境</span><span class="p">)</span><span class="err">、</span><span class="n">kubelet</span><span class="p">(</span><span class="n">节点状态</span><span class="p">)</span>
    <span class="n">kube-proxy</span><span class="err">、</span><span class="n">containerd</span><span class="p">(</span><span class="n">docker方式部署</span><span class="p">)</span><span class="err">、</span><span class="n">flannel</span><span class="p">(</span><span class="n">插件部署</span><span class="p">)</span>
</code></pre></div>
<p>主机名规划</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>主机ip</th>
<th>主机名规划</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10.0.0.12</td>
<td>kubernetes-master.superopsmsb.com  kubernetes-master</td>
</tr>
<tr>
<td>2</td>
<td>10.0.0.15</td>
<td>kubernetes-node1.superopsmsb.com  kubernetes-node1</td>
</tr>
<tr>
<td>3</td>
<td>10.0.0.16</td>
<td>kubernetes-node2.superopsmsb.com  kubernetes-node2</td>
</tr>
<tr>
<td>4</td>
<td>10.0.0.17</td>
<td>kubernetes-node3.superopsmsb.com  kubernetes-node3</td>
</tr>
<tr>
<td>5</td>
<td>10.0.0.20</td>
<td>kubernetes-register.superopsmsb.com  kubernetes-register</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">修改master节点主机的hosts文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /etc/hosts</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">kubernetes-master</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">kubernetes-master</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">kubernetes-node1</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">kubernetes-node2</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node2</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">kubernetes-node3</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node3</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-register</span>
</code></pre></div>
<p><strong>主机认证</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">因为整个集群节点中的很多文件配置都是一样的</span><span class="err">，</span><span class="n">所以我们需要配置跨主机免密码认证方式来定制集群的认证通信机制</span><span class="err">，</span><span class="n">这样后续在批量操作命令的时候</span><span class="err">，</span><span class="n">就非常轻松了</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">为了让ssh通信速度更快一些</span><span class="err">，</span><span class="n">我们需要对ssh的配置文件进行一些基本的改造</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># egrep &#39;APIA|DNS&#39; /etc/ssh/sshd_config</span>
<span class="n">GSSAPIAuthentication</span> <span class="n">no</span>
<span class="n">UseDNS</span> <span class="n">no</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># systemctl restart sshd</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">这部分的操作</span><span class="err">，</span><span class="n">应该在所有集群主机环境初始化的时候进行设定</span>
</code></pre></div>
<p>脚本内容</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/01_remote_host_auth.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 批量设定远程主机免密码认证</span>
<span class="c"># 版本: v0.2</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>
<span class="n">user_dir</span><span class="p">=</span><span class="s1">&#39;/root&#39;</span>
<span class="n">host_file</span><span class="p">=</span><span class="s1">&#39;/etc/hosts&#39;</span>
<span class="n">login_user</span><span class="p">=</span><span class="s1">&#39;root&#39;</span>
<span class="n">login_pass</span><span class="p">=</span><span class="s1">&#39;123456&#39;</span>
<span class="n">target_type</span><span class="p">=(</span><span class="n">部署</span> <span class="n">免密</span> <span class="n">同步</span> <span class="n">主机名</span> <span class="n">退出</span><span class="p">)</span>

<span class="c"># 菜单</span>
<span class="n">menu</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[31m批量设定远程主机免密码认证管理界面\e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 1: 部署环境   2: 免密认证   3: 同步hosts \e[0m&quot;</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[32m 4: 设定主机名 5：退出操作 \e[0m&quot;</span>
  <span class="nb">echo </span><span class="s2">&quot;=====================================================&quot;</span>
<span class="p">}</span>
<span class="c"># expect环境</span>
<span class="n">expect_install</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">[</span> <span class="o">-f</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">expect</span> <span class="p">]</span>
  <span class="n">then</span>
     <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect环境已经部署完毕\e[0m&quot;</span>
  <span class="k">else</span>
     <span class="n">yum</span> <span class="n">install</span> <span class="n">expect</span> <span class="n">-y</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">null</span> <span class="n">2</span><span class="p">&gt;&amp;</span><span class="n">1</span> <span class="p">&amp;&amp;</span> <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装完毕\e[0m&quot;</span> <span class="p">||</span> <span class="p">(</span><span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33mexpect软件安装失败\e[0m&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">exit</span><span class="p">)</span>
  <span class="n">fi</span>
<span class="p">}</span>
<span class="c"># 秘钥文件生成环境</span>
<span class="n">create_authkey</span><span class="p">(){</span>
  <span class="c"># 保证历史文件清空</span>
  <span class="p">[</span> <span class="n">-d</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span> <span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="nb">rm </span><span class="n">-rf</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/*</span>
  <span class="c"># 构建秘钥文件对</span>
  <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">ssh-keygen</span> <span class="n">-t</span> <span class="n">rsa</span> <span class="n">-P</span> <span class="s2">&quot;&quot;</span> <span class="o">-f</span> <span class="p">${</span><span class="n">user_dir</span><span class="p">}/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span>
  <span class="nb">echo </span><span class="n">-e</span> <span class="s2">&quot;\e[33m秘钥文件已经创建完毕\e[0m&quot;</span>
<span class="p">}</span>
<span class="c"># expect自动匹配逻辑</span>
<span class="n">expect_autoauth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部参数</span>
  <span class="n">command</span><span class="p">=</span><span class="s2">&quot;$@&quot;</span>
  <span class="n">expect</span> <span class="n">-c</span> <span class="s2">&quot;</span>
<span class="s2">    spawn ${command}</span>
<span class="s2">    expect {</span>
<span class="s2">      \&quot;</span><span class="n">yes</span><span class="p">/</span><span class="n">no</span><span class="p">\</span><span class="s2">&quot; {send \&quot;</span><span class="n">yes</span><span class="p">\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;; exp_continue}</span>
<span class="s2">      \&quot;</span><span class="p">*</span><span class="n">password</span><span class="p">*\</span><span class="s2">&quot; {send \&quot;</span><span class="p">${</span><span class="n">login_pass</span><span class="p">}\</span><span class="n">r</span><span class="p">\</span><span class="s2">&quot;}</span>
<span class="s2">   }&quot;</span>
<span class="p">}</span>
<span class="c"># 跨主机传输文件认证</span>
<span class="n">sshkey_auth_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="c"># /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12</span>
     <span class="n">cmd</span><span class="p">=</span><span class="s2">&quot;/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub&quot;</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">expect_autoauth_func</span> <span class="p">${</span><span class="n">cmd</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 跨主机同步hosts文件</span>
<span class="n">scp_hosts_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">scp</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}:${</span><span class="n">host_file</span><span class="p">}</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 跨主机设定主机名规划</span>
<span class="n">set_hostname_func</span><span class="p">(){</span>
  <span class="c"># 接收外部的参数</span>
  <span class="n">local</span> <span class="n">host_list</span><span class="p">=</span><span class="s2">&quot;$*&quot;</span>
  <span class="k">for</span> <span class="n">ip</span> <span class="k">in</span> <span class="p">${</span><span class="n">host_list</span><span class="p">}</span>
  <span class="k">do</span>
     <span class="n">host_name</span><span class="p">=$(</span><span class="n">grep</span> <span class="p">${</span><span class="n">ip</span><span class="p">}</span> <span class="p">${</span><span class="n">host_file</span><span class="p">}|</span><span class="n">awk</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
     <span class="n">remote_host</span><span class="p">=</span><span class="s2">&quot;${login_user}@${ip}&quot;</span>
     <span class="n">ssh</span> <span class="p">${</span><span class="n">remote_host</span><span class="p">}</span> <span class="s2">&quot;hostnamectl set-hostname ${host_name}&quot;</span>
  <span class="n">done</span>
<span class="p">}</span>
<span class="c"># 帮助信息逻辑</span>
<span class="n">Usage</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="s2">&quot;请输入有效的操作id&quot;</span>
<span class="p">}</span>
<span class="c"># 逻辑入口</span>
<span class="k">while</span> <span class="n">true</span>
<span class="k">do</span>
  <span class="n">menu</span>
  <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入有效的操作id: &quot;</span> <span class="n">target_id</span>
  <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="c">#target_type[@]} -ge ${target_id} ]</span>
  <span class="n">then</span>
    <span class="k">if</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;部署&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始部署环境操作...&quot;</span>
       <span class="n">expect_install</span>
       <span class="n">create_authkey</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;免密&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行免密认证操作...&quot;</span>
       <span class="n">sshkey_auth_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;同步&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行同步hosts文件操作...&quot;</span>
       <span class="n">scp_hosts_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;主机名&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): &quot;</span> <span class="n">num_list</span>
       <span class="n">ip_list</span><span class="p">=$(</span><span class="n">eval</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$num_list</span><span class="p">)</span>
       <span class="nb">echo </span><span class="s2">&quot;开始执行设定主机名操作...&quot;</span>
       <span class="n">set_hostname_func</span> <span class="p">${</span><span class="n">ip_list</span><span class="p">}</span>
    <span class="n">elif</span> <span class="p">[</span> <span class="p">${</span><span class="n">target_type</span><span class="p">[${</span><span class="n">target_id</span><span class="p">}-</span><span class="n">1</span><span class="p">]}</span> <span class="p">==</span> <span class="s2">&quot;退出&quot;</span> <span class="p">]</span>
    <span class="n">then</span>
       <span class="nb">echo </span><span class="s2">&quot;开始退出管理界面...&quot;</span>
       <span class="n">exit</span>
    <span class="n">fi</span>
  <span class="k">else</span>
    <span class="n">Usage</span>
  <span class="n">fi</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">为了更好的把环境部署成功</span><span class="err">，</span><span class="n">最好提前更新一下软件源信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum makecache</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看脚本执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/01_remote_host_auth.sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">同步hosts</span>
 <span class="n">4</span><span class="p">:</span> <span class="n">设定主机名</span> <span class="n">5</span><span class="err">：</span><span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">1</span>
<span class="n">开始部署环境操作</span><span class="p">...</span>
<span class="n">expect环境已经部署完毕</span>
<span class="n">Generating</span> <span class="n">public</span><span class="p">/</span><span class="n">private</span> <span class="n">rsa</span> <span class="n">key</span> <span class="n">pair</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">identification</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">public</span> <span class="n">key</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">ssh</span><span class="p">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span><span class="p">.</span>
<span class="n">The</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="n">is</span><span class="p">:</span>
<span class="n">SHA256</span><span class="p">:</span><span class="n">u</span><span class="p">/</span><span class="n">Tzk0d9sNtG6r9Kx</span><span class="p">+</span><span class="n">6xPaENNqT3Lw178XWXQhX1yMw</span> <span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span>
<span class="n">The</span> <span class="n">key</span><span class="s1">&#39;s randomart image is:</span>
<span class="s1">+---[RSA 2048]----+</span>
<span class="s1">|               .+|</span>
<span class="s1">|             + o.|</span>
<span class="s1">|              E .|</span>
<span class="s1">|             o.  |</span>
<span class="s1">|        S   +  +.|</span>
<span class="s1">|         . . *=+B|</span>
<span class="s1">|        o   o+B%O|</span>
<span class="s1">|       . o. +.O+X|</span>
<span class="s1">|        . .o.=+XB|</span>
<span class="s1">+----[SHA256]-----+</span>
<span class="s1">秘钥文件已经创建完毕</span>
<span class="s1">批量设定远程主机免密码认证管理界面</span>
<span class="s1">=====================================================</span>
<span class="s1"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s1"> 4: 设定主机名 5：退出操作</span>
<span class="s1">=====================================================</span>
<span class="s1">请输入有效的操作id: 2</span>
<span class="s1">请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): 12</span>
<span class="s1">开始执行免密认证操作...</span>
<span class="s1">spawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.12</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="s1">&#39;&quot;</span>
<span class="s1">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s1">批量设定远程主机免密码认证管理界面</span>
<span class="s1">=====================================================</span>
<span class="s1"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s1"> 4: 设定主机名 5：退出操作</span>
<span class="s1">=====================================================</span>
<span class="s1">请输入有效的操作id: 2</span>
<span class="s1">请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {15..17}</span>
<span class="s1">开始执行免密认证操作...</span>
<span class="s1">spawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.15</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="s1">&#39;&quot;</span>
<span class="s1">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s1">spawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.16</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="s1">&#39;&quot;</span>
<span class="s1">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s1">spawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.17</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span><span class="s1">&#39;&quot;</span>
<span class="s1">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s1">批量设定远程主机免密码认证管理界面</span>
<span class="s1">=====================================================</span>
<span class="s1"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s1"> 4: 设定主机名 5：退出操作</span>
<span class="s1">=====================================================</span>
<span class="s1">请输入有效的操作id: 2</span>
<span class="s1">请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): 20</span>
<span class="s1">开始执行免密认证操作...</span>
<span class="s1">spawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.20</span>
<span class="s1">...</span>
<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span><span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span><span class="err">&#39;</span><span class="s2">&quot;</span>
<span class="s2">and check to make sure that only the key(s) you wanted were added.</span>

<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 3</span>
<span class="s2">请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): 12</span>
<span class="s2">开始执行同步hosts文件操作...</span>
<span class="s2">hosts                                                               100%  470     1.2MB/s   00:00</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 3</span>
<span class="s2">请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): {15..17}</span>
<span class="s2">开始执行同步hosts文件操作...</span>
<span class="s2">hosts                                                               100%  470   226.5KB/s   00:00</span>
<span class="s2">hosts                                                               100%  470   458.8KB/s   00:00</span>
<span class="s2">hosts                                                               100%  470   533.1KB/s   00:00</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 3</span>
<span class="s2">请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): 20</span>
<span class="s2">开始执行同步hosts文件操作...</span>
<span class="s2">hosts                                                               100%  470   287.8KB/s   00:00</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 4</span>
<span class="s2">请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): 12</span>
<span class="s2">开始执行设定主机名操作...</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 4</span>
<span class="s2">请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): {15..17}</span>
<span class="s2">开始执行设定主机名操作...</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 4</span>
<span class="s2">请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): 20</span>
<span class="s2">开始执行设定主机名操作...</span>
<span class="s2">批量设定远程主机免密码认证管理界面</span>
<span class="s2">=====================================================</span>
<span class="s2"> 1: 部署环境   2: 免密认证   3: 同步hosts</span>
<span class="s2"> 4: 设定主机名 5：退出操作</span>
<span class="s2">=====================================================</span>
<span class="s2">请输入有效的操作id: 5</span>
<span class="s2">开始退出管理界面...</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># exec /bin/bash</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in 12 {15..17} 20</span>
<span class="p">&gt;</span> <span class="k">do</span>
<span class="p">&gt;</span> <span class="n">name</span><span class="p">=$(</span><span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;hostname&quot;</span><span class="p">)</span>
<span class="p">&gt;</span> <span class="nb">echo </span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="nv">$name</span>
<span class="p">&gt;</span> <span class="n">done</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">kubernetes-master</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">kubernetes-node1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">kubernetes-node2</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">kubernetes-node3</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">kubernetes-register</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="112">1.1.2 集群基础环境<a class="headerlink" href="#112" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 内核调整、软件源配置、小结 三个方面来学习。</p>
<p><strong>内核调整</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">根据kubernetes官方资料的相关信息</span><span class="err">，</span><span class="n">我们需要对kubernetes集群是所有主机进行内核参数的调整</span><span class="err">。</span>
</code></pre></div>
<p>禁用swap</p>
<div class="highlight"><pre><span></span><code>    <span class="n">部署集群时</span><span class="err">，</span><span class="n">kubeadm默认会预先检查当前主机是否禁用了Swap设备</span><span class="err">，</span><span class="n">并在未禁用时强制终止部署过程</span><span class="err">。</span><span class="n">因此</span><span class="err">，</span><span class="n">在主机内存资源充裕的条件下</span><span class="err">，</span><span class="n">需要禁用所有的Swap设备</span><span class="err">，</span><span class="n">否则</span><span class="err">，</span><span class="n">就需要在后文的kubeadm</span> <span class="n">init及kubeadm</span> <span class="n">join命令执行时额外使用相关的选项忽略检查错误</span>

<span class="n">关闭Swap设备</span><span class="err">，</span><span class="n">需要分两步完成</span><span class="err">。</span>
<span class="n">首先是关闭当前已启用的所有Swap设备</span><span class="err">：</span>
<span class="n">swapoff</span> <span class="n">-a</span>

<span class="n">而后编辑</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab配置文件</span><span class="err">，</span><span class="n">注释用于挂载Swap设备的所有行</span><span class="err">。</span>
<span class="n">方法一</span><span class="err">：</span><span class="n">手工编辑</span>
<span class="n">vim</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
<span class="c"># UUID=0a55fdb5-a9d8-4215-80f7-f42f75644f69 none  swap    sw      0       0</span>

<span class="n">方法二</span><span class="err">：</span>
<span class="n">sed</span> <span class="n">-i</span> <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span> 
    <span class="n">替换后位置的</span><span class="p">&amp;</span><span class="n">代表前面匹配的整行内容</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">只需要注释掉自动挂载SWAP分区项即可</span><span class="err">，</span><span class="n">防止机子重启后swap启用</span>

<span class="n">内核</span><span class="p">(</span><span class="n">禁用swap</span><span class="p">)</span><span class="n">参数</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="p">=</span><span class="n">0</span>
<span class="n">EOF</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<p>网络参数</p>
<div class="highlight"><pre><span></span><code><span class="n">配置iptables参数</span><span class="err">，</span><span class="n">使得流经网桥的流量也经过iptables</span><span class="p">/</span><span class="n">netfilter防火墙</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">EOF</span>

<span class="n">配置生效</span>
<span class="n">modprobe</span> <span class="n">br_netfilter</span>
<span class="n">modprobe</span> <span class="n">overlay</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">脚本方式</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/02_kubernetes_kernel_conf.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 批量设定kubernetes的内核参数调整</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 禁用swap</span>
<span class="n">swapoff</span> <span class="n">-a</span>
<span class="n">sed</span> <span class="n">-i</span> <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="p">=</span><span class="n">0</span>
<span class="n">EOF</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>

<span class="c"># 打开网络转发</span>
<span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">EOF</span>

<span class="c"># 加载相应的模块</span>
<span class="n">modprobe</span> <span class="n">br_netfilter</span>
<span class="n">modprobe</span> <span class="n">overlay</span>
<span class="n">sysctl</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<p>脚本执行</p>
<div class="highlight"><pre><span></span><code><span class="n">master主机执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/02_kubernetes_kernel_conf.sh</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">node主机执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in {15..17};do ssh root@10.0.0.$i mkdir /data/scripts -p; scp /data/scripts/02_kubernetes_kernel_conf.sh root@10.0.0.$i:/data/scripts/02_kubernetes_kernel_conf.sh;ssh root@10.0.0.$i &quot;/bin/bash /data/scripts/02_kubernetes_kernel_conf.sh&quot;;done</span>
<span class="n">02_kubernetes_kernel_conf</span><span class="p">.</span><span class="n">sh</span>                                        <span class="n">100</span><span class="p">%</span>  <span class="n">537</span>   <span class="n">160</span><span class="p">.</span><span class="n">6KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">02_kubernetes_kernel_conf</span><span class="p">.</span><span class="n">sh</span>                                        <span class="n">100</span><span class="p">%</span>  <span class="n">537</span>   <span class="n">374</span><span class="p">.</span><span class="n">4KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">02_kubernetes_kernel_conf</span><span class="p">.</span><span class="n">sh</span>                                        <span class="n">100</span><span class="p">%</span>  <span class="n">537</span>   <span class="n">154</span><span class="p">.</span><span class="n">5KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
</code></pre></div>
<p><strong>软件源配置</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">由于我们需要在多台主机上初始化kubernetes主机环境</span><span class="err">，</span><span class="n">所以我们需要在多台主机上配置kubernetes的软件源</span><span class="err">，</span><span class="n">以最简便的方式部署kubernetes环境</span><span class="err">。</span>
</code></pre></div>
<p>定制阿里云软件源</p>
<div class="highlight"><pre><span></span><code><span class="n">定制阿里云的关于kubernetes的软件源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span>
<span class="no">[kubernetes]</span>
<span class="n">name</span><span class="p">=</span><span class="n">Kubernetes</span>
<span class="n">baseurl</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">repos</span><span class="p">/</span><span class="n">kubernetes-el7-x86_64</span>
<span class="n">enabled</span><span class="p">=</span><span class="n">1</span>
<span class="n">gpgcheck</span><span class="p">=</span><span class="n">0</span>
<span class="n">repo_gpgcheck</span><span class="p">=</span><span class="n">0</span>
<span class="n">gpgkey</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">yum-key</span><span class="p">.</span><span class="n">gpg</span> <span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">rpm-package-key</span><span class="p">.</span><span class="n">gpg</span>
<span class="n">EOF</span>

<span class="n">更新软件源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum makecache fast</span>
</code></pre></div>
<p>其他节点主机同步软件源</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in {15..17};do scp /etc/yum.repos.d/kubernetes.repo root@10.0.0.$i:/etc/yum.repos.d/kubernetes.repo;ssh root@10.0.0.$i &quot;yum makecache fast&quot;;done</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="113">1.1.3 容器环境<a class="headerlink" href="#113" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 Docker环境、环境配置、小结 三个方面来学习。</p>
<p><strong>Docker环境</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">由于kubernetes1</span><span class="p">.</span><span class="n">24版本才开始将默认支持的容器引擎转换为了Containerd了</span><span class="err">，</span><span class="n">所以这里我们还是以Docker软件作为后端容器的引擎</span><span class="err">，</span><span class="n">因为目前的CKA考试环境是以kubernetes1</span><span class="p">.</span><span class="n">23版本为基准的</span><span class="err">。</span>
</code></pre></div>
<p>软件源配置</p>
<div class="highlight"><pre><span></span><code><span class="n">安装基础依赖软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum install -y yum-utils device-mapper-persistent-data lvm2</span>

<span class="n">定制专属的软件源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
</code></pre></div>
<p>安装软件</p>
<div class="highlight"><pre><span></span><code><span class="n">确定最新版本的docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum list docker-ce --showduplicates | sort -r</span>

<span class="n">安装最新版本的docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum install -y docker-ce</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">启动docker服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># systemctl restart docker</span>

<span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker version</span>
<span class="n">Client</span><span class="p">:</span> <span class="n">Docker</span> <span class="n">Engine</span> <span class="p">-</span> <span class="n">Community</span>
 <span class="n">Version</span><span class="p">:</span>           <span class="n">20</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">17</span>
 <span class="n">API</span> <span class="n">version</span><span class="p">:</span>       <span class="n">1</span><span class="p">.</span><span class="n">41</span>
 <span class="n">Go</span> <span class="n">version</span><span class="p">:</span>        <span class="n">go1</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">11</span>
 <span class="n">Git</span> <span class="n">commit</span><span class="p">:</span>        <span class="n">100c701</span>
 <span class="n">Built</span><span class="p">:</span>             <span class="n">Mon</span> <span class="n">Jun</span>  <span class="n">6</span> <span class="n">23</span><span class="p">:</span><span class="n">05</span><span class="p">:</span><span class="n">12</span> <span class="n">2022</span>
 <span class="n">OS</span><span class="p">/</span><span class="n">Arch</span><span class="p">:</span>           <span class="n">linux</span><span class="p">/</span><span class="n">amd64</span>
 <span class="n">Context</span><span class="p">:</span>           <span class="k">default</span>
 <span class="n">Experimental</span><span class="p">:</span>      <span class="n">true</span>

<span class="n">Server</span><span class="p">:</span> <span class="n">Docker</span> <span class="n">Engine</span> <span class="p">-</span> <span class="n">Community</span>
 <span class="n">Engine</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">20</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">17</span>
  <span class="n">API</span> <span class="n">version</span><span class="p">:</span>      <span class="n">1</span><span class="p">.</span><span class="n">41</span> <span class="p">(</span><span class="n">minimum</span> <span class="n">version</span> <span class="n">1</span><span class="p">.</span><span class="n">12</span><span class="p">)</span>
  <span class="n">Go</span> <span class="n">version</span><span class="p">:</span>       <span class="n">go1</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">11</span>
  <span class="n">Git</span> <span class="n">commit</span><span class="p">:</span>       <span class="n">a89b842</span>
  <span class="n">Built</span><span class="p">:</span>            <span class="n">Mon</span> <span class="n">Jun</span>  <span class="n">6</span> <span class="n">23</span><span class="p">:</span><span class="n">03</span><span class="p">:</span><span class="n">33</span> <span class="n">2022</span>
  <span class="n">OS</span><span class="p">/</span><span class="n">Arch</span><span class="p">:</span>          <span class="n">linux</span><span class="p">/</span><span class="n">amd64</span>
  <span class="n">Experimental</span><span class="p">:</span>     <span class="n">false</span>
 <span class="n">containerd</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">1</span><span class="p">.</span><span class="n">6</span><span class="p">.</span><span class="n">6</span>
  <span class="n">GitCommit</span><span class="p">:</span>        <span class="n">10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span>
 <span class="n">runc</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span>
  <span class="n">GitCommit</span><span class="p">:</span>        <span class="n">v1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">-</span><span class="n">0-ga916309</span>
 <span class="n">docker-init</span><span class="p">:</span>
  <span class="n">Version</span><span class="p">:</span>          <span class="n">0</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">0</span>
  <span class="n">GitCommit</span><span class="p">:</span>        <span class="n">de40ad0</span>
</code></pre></div>
<p><strong>环境配置</strong></p>
<p>需求</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">镜像仓库</span>
    <span class="n">默认安装的docker会从官方网站上获取docker镜像</span><span class="err">，</span><span class="n">有时候会因为网络因素无法获取</span><span class="err">，</span><span class="n">所以我们需要配置国内镜像仓库的加速器</span>
<span class="n">2</span> <span class="n">kubernetes的改造</span>
    <span class="n">kubernetes的创建容器</span><span class="err">，</span><span class="n">需要借助于kubelet来管理Docker</span><span class="err">，</span><span class="n">而默认的Docker服务进程的管理方式不是kubelet的类型</span><span class="err">，</span><span class="n">所以需要改造Docker的服务启动类型为systemd方式</span><span class="err">。</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">默认情况下</span><span class="err">，</span><span class="n">Docker的服务修改有两种方式</span><span class="err">：</span>
        <span class="n">1</span> <span class="n">Docker服务</span> <span class="p">-</span> <span class="n">需要修改启动服务文件</span><span class="err">，</span><span class="n">需要重载服务文件</span><span class="err">，</span><span class="n">比较繁琐</span><span class="err">。</span>
        <span class="n">2</span> <span class="n">daemon</span><span class="p">.</span><span class="n">json文件</span> <span class="p">-</span> <span class="n">修改文件后</span><span class="err">，</span><span class="n">只需要重启docker服务即可</span><span class="err">，</span><span class="n">该文件默认情况下不存在</span><span class="err">。</span>
</code></pre></div>
<p>定制docker配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">定制配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># cat &gt;&gt; /etc/docker/daemon.json &lt;&lt;-EOF</span>
<span class="p">{</span>
  <span class="s2">&quot;registry-mirrors&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;http://74f21445.m.daocloud.io&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://registry.docker-cn.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http://hub-mirror.c.163.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
  <span class="p">],</span> 
  <span class="s2">&quot;insecure-registries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.0.0.20:80&quot;</span><span class="p">],</span> 
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="n">重启docker服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># systemctl restart docker</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看配置效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker info</span>
<span class="n">Client</span><span class="p">:</span>
 <span class="p">...</span>

<span class="n">Server</span><span class="p">:</span>
 <span class="p">...</span>
 <span class="n">Cgroup</span> <span class="n">Driver</span><span class="p">:</span> <span class="n">systemd</span>
 <span class="p">...</span>
 <span class="n">Insecure</span> <span class="n">Registries</span><span class="p">:</span>
  <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span><span class="p">:</span><span class="n">80</span>
  <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">8</span>
 <span class="n">Registry</span> <span class="n">Mirrors</span><span class="p">:</span>
  <span class="n">http</span><span class="p">://</span><span class="n">74f21445</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">daocloud</span><span class="p">.</span><span class="n">io</span><span class="p">/</span>
  <span class="n">https</span><span class="p">://</span><span class="n">registry</span><span class="p">.</span><span class="n">docker-cn</span><span class="p">.</span><span class="n">com</span><span class="p">/</span>
  <span class="n">http</span><span class="p">://</span><span class="n">hub-mirror</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">163</span><span class="p">.</span><span class="n">com</span><span class="p">/</span>
  <span class="n">https</span><span class="p">://</span><span class="n">docker</span><span class="p">.</span><span class="n">mirrors</span><span class="p">.</span><span class="n">ustc</span><span class="p">.</span><span class="n">edu</span><span class="p">.</span><span class="n">cn</span><span class="p">/</span>
 <span class="n">Live</span> <span class="n">Restore</span> <span class="n">Enabled</span><span class="p">:</span> <span class="n">false</span>
</code></pre></div>
<p>docker环境定制脚本</p>
<div class="highlight"><pre><span></span><code><span class="n">查看脚本内容</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/03_kubernetes_docker_install.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 安装部署Docker容器环境</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 准备工作</span>

<span class="c"># 软件源配置</span>
<span class="n">softs_base</span><span class="p">(){</span>
  <span class="c"># 安装基础软件</span>
  <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">yum-utils</span> <span class="n">device-mapper-persistent-data</span> <span class="n">lvm2</span>
  <span class="c"># 定制软件仓库源</span>
  <span class="n">yum-config-manager</span> <span class="p">-</span><span class="n">-add-repo</span> <span class="n">http</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">centos</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span>
  <span class="c"># 更新软件源</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">network</span>
  <span class="n">yum</span> <span class="n">makecache</span> <span class="n">fast</span>
<span class="p">}</span>

<span class="c"># 软件安装</span>
<span class="n">soft_install</span><span class="p">(){</span>
  <span class="c"># 安装最新版的docker软件</span>
  <span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">docker-ce</span>
  <span class="c"># 重启docker服务</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="p">}</span>

<span class="c"># 加速器配置</span>
<span class="n">speed_config</span><span class="p">(){</span>
  <span class="c"># 定制加速器配置</span>
<span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">docker</span><span class="p">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="n">-EOF</span>
<span class="p">{</span>
  <span class="s2">&quot;registry-mirrors&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;http://74f21445.m.daocloud.io&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://registry.docker-cn.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;http://hub-mirror.c.163.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;insecure-registries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.0.0.20:80&quot;</span><span class="p">],</span>
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
  <span class="c"># 重启docker服务</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="p">}</span>

<span class="c"># 环境监测</span>
<span class="n">docker_check</span><span class="p">(){</span>
  <span class="n">process_name</span><span class="p">=$(</span><span class="n">docker</span> <span class="n">info</span> <span class="p">|</span> <span class="n">grep</span> <span class="s1">&#39;p D&#39;</span> <span class="p">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
  <span class="p">[</span> <span class="s2">&quot;${process_name}&quot;</span> <span class="p">==</span> <span class="s2">&quot;systemd&quot;</span> <span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="nb">echo </span><span class="s2">&quot;Docker软件部署完毕&quot;</span> <span class="p">||</span> <span class="p">(</span><span class="nb">echo </span><span class="s2">&quot;Docker软件部署失败&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">exit</span><span class="p">)</span>
<span class="p">}</span>

<span class="c"># 软件部署</span>
<span class="n">main</span><span class="p">(){</span>
  <span class="n">softs_base</span>
  <span class="n">soft_install</span>
  <span class="n">speed_config</span>
  <span class="n">docker_check</span>
<span class="p">}</span>

<span class="c"># 调用主函数</span>
<span class="n">main</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其他主机环境部署docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in {15..17} 20; do ssh root@10.0.0.$i &quot;mkdir -p /data/scripts&quot;; scp /data/scripts/03_kubernetes_docker_install.sh root@10.0.0.$i:/data/scripts/03_kubernetes_docker_install.sh; done</span>

<span class="n">其他主机各自执行下面的脚本</span>
<span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_kubernetes_docker_install</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="114">1.1.4 仓库环境<a class="headerlink" href="#114" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 容器仓库、Harbor实践、小结 三个方面来学习。</p>
<p><strong>容器仓库</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器</span><span class="err">，</span><span class="n">虽然Docker官方也提供了公共的镜像仓库</span><span class="err">，</span><span class="n">但是从安全和效率等方面考虑</span><span class="err">，</span><span class="n">部署企业内部的私有环境Registry是非常必要的</span><span class="err">，</span><span class="n">Harbor除了存储和分发镜像外还具有用户管理</span><span class="err">，</span><span class="n">项目管理</span><span class="err">，</span><span class="n">配置管理和日志查询</span><span class="err">，</span><span class="n">高可用部署等主要功能</span><span class="err">。</span>
    <span class="n">在本地搭建一个Harbor服务</span><span class="err">，</span><span class="n">其他在同一局域网的机器可以使用Harbor进行镜像提交和拉取</span><span class="err">，</span><span class="n">搭建前需要本地安装docker服务和docker-compose服务</span><span class="err">。</span>
    <span class="n">最新的软件版本是</span> <span class="n">2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">3</span><span class="err">，</span><span class="n">我们这里采用</span> <span class="n">2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0版本</span><span class="err">。</span>
</code></pre></div>
<p>compose部署</p>
<div class="highlight"><pre><span></span><code><span class="n">安装docker-compose</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">~]</span><span class="c"># yum install -y docker-compose</span>
</code></pre></div>
<p>harbor部署</p>
<div class="highlight"><pre><span></span><code><span class="n">下载软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">~]</span><span class="c"># mkdir /data/{softs,server} -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">~]</span><span class="c"># cd /data/softs</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">~]</span><span class="c"># wget https://github.com/goharbor/harbor/releases/download/v2.5.0/harbor-offline-installer-v2.5.0.tgz</span>

<span class="n">解压软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">~]</span><span class="c"># tar -zxvf harbor-offline-installer-v2.5.0.tgz -C  /data/server/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">~]</span><span class="c"># cd /data/server/harbor/</span>

<span class="n">加载镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># docker load &lt; harbor.v2.5.0.tar.gz</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># docker images</span>
<span class="n">REPOSITORY</span>                      <span class="n">TAG</span>       <span class="n">IMAGE</span> <span class="n">ID</span>       <span class="n">CREATED</span>        <span class="n">SIZE</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-exporter</span>        <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">36396f138dfb</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">86</span><span class="p">.</span><span class="n">7MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">chartmuseum-photon</span>     <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">eaedcf1f700b</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">225MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">redis-photon</span>           <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">1e00fcc9ae63</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">156MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">trivy-adapter-photon</span>   <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">4e24a6327c97</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">164MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">notary-server-photon</span>   <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">6d5fe726af7f</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">112MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">notary-signer-photon</span>   <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">932eed8b6e8d</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">109MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-registryctl</span>     <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">90ef6b10ab31</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">136MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">registry-photon</span>        <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">30e130148067</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">77</span><span class="p">.</span><span class="n">5MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">nginx-photon</span>           <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">5041274b8b8a</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">44MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-log</span>             <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">89fd73f9714d</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">160MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-jobservice</span>      <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">1d097e877be4</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">226MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-core</span>            <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">42a54bc05b02</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">202MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-portal</span>          <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">c206e936f4f9</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">52</span><span class="p">.</span><span class="n">3MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-db</span>              <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">d40a1ae87646</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">223MB</span>
<span class="n">goharbor</span><span class="p">/</span><span class="n">prepare</span>                <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>    <span class="n">36539574668f</span>   <span class="n">3</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">268MB</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">备份配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># cp harbor.yml.tmpl harbor.yml</span>

<span class="n">修改配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># vim harbor.yml.tmpl</span>
    <span class="c"># 修改主机名</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
    <span class="n">http</span><span class="p">:</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
    <span class="c">#https:  注释ssl相关的部分</span>
      <span class="c">#  port: 443</span>
      <span class="c">#  certificate: /your/certificate/path</span>
      <span class="c">#  private_key: /your/private/key/path</span>
    <span class="c"># 修改harbor的登录密码</span>
    <span class="n">harbor_admin_password</span><span class="p">:</span> <span class="n">123456</span>
    <span class="c"># 设定harbor的数据存储目录</span>
    <span class="n">data_volume</span><span class="p">:</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">data</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">配置harbor</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># ./prepare</span>
<span class="n">prepare</span> <span class="n">base</span> <span class="nb">dir </span><span class="n">is</span> <span class="nb">set </span><span class="n">to</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span>
<span class="n">WARNING</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="n">WARNING</span><span class="p">:</span> <span class="n">HTTP</span> <span class="n">protocol</span> <span class="n">is</span> <span class="n">insecure</span><span class="p">.</span> <span class="n">Harbor</span> <span class="n">will</span> <span class="n">deprecate</span> <span class="n">http</span> <span class="n">protocol</span> <span class="k">in</span> <span class="n">the</span> <span class="n">future</span><span class="p">.</span> <span class="n">Please</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">upgrade</span> <span class="n">to</span> <span class="n">https</span>
<span class="p">...</span>
<span class="n">Generated</span> <span class="n">configuration</span> <span class="n">file</span><span class="p">:</span> <span class="p">/</span><span class="n">compose_location</span><span class="p">/</span><span class="n">docker-compose</span><span class="p">.</span><span class="n">yml</span>
<span class="n">Clean</span> <span class="n">up</span> <span class="n">the</span> <span class="n">input</span> <span class="nb">dir</span>

<span class="n">启动harbor</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># ./install.sh</span>
<span class="no">[Step 0]</span><span class="p">:</span> <span class="n">checking</span> <span class="k">if</span> <span class="n">docker</span> <span class="n">is</span> <span class="n">installed</span> <span class="p">...</span>
<span class="p">...</span>
<span class="no">[Step 1]</span><span class="p">:</span> <span class="n">checking</span> <span class="n">docker-compose</span> <span class="n">is</span> <span class="n">installed</span> <span class="p">...</span>
<span class="p">...</span>
<span class="no">[Step 2]</span><span class="p">:</span> <span class="n">loading</span> <span class="n">Harbor</span> <span class="n">images</span> <span class="p">...</span>
<span class="p">...</span>
<span class="n">Loaded</span> <span class="n">image</span><span class="p">:</span> <span class="n">goharbor</span><span class="p">/</span><span class="n">harbor-exporter</span><span class="p">:</span><span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>
<span class="no">[Step 3]</span><span class="p">:</span> <span class="n">preparing</span> <span class="n">environment</span> <span class="p">...</span>
<span class="p">...</span>
<span class="no">[Step 4]</span><span class="p">:</span> <span class="n">preparing</span> <span class="n">harbor</span> <span class="n">configs</span> <span class="p">...</span>
<span class="p">...</span>
<span class="no">[Step 5]</span><span class="p">:</span> <span class="n">starting</span> <span class="n">Harbor</span> <span class="p">...</span>
<span class="p">...</span>
<span class="err">✔</span> <span class="p">---</span><span class="n">-Harbor</span> <span class="n">has</span> <span class="n">been</span> <span class="n">installed</span> <span class="n">and</span> <span class="n">started</span> <span class="n">successfully</span><span class="p">.----</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># docker-compose ps</span>
      <span class="n">Name</span>                     <span class="n">Command</span>               <span class="n">State</span>                  <span class="n">Ports</span>
<span class="p">-------------------------------------------------------------------------------------------------</span>
<span class="n">harbor-core</span>         <span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">entrypoint</span><span class="p">.</span><span class="n">sh</span>            <span class="n">Up</span>
<span class="n">harbor-db</span>           <span class="p">/</span><span class="n">docker-entrypoint</span><span class="p">.</span><span class="n">sh</span> <span class="n">96</span> <span class="n">13</span>      <span class="n">Up</span>
<span class="n">harbor-jobservice</span>   <span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">entrypoint</span><span class="p">.</span><span class="n">sh</span>            <span class="n">Up</span>
<span class="n">harbor-log</span>          <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">sh</span> <span class="n">-c</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span> <span class="p">...</span>   <span class="n">Up</span>      <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">1514</span><span class="p">-&gt;</span><span class="n">10514</span><span class="p">/</span><span class="n">tcp</span>
<span class="n">harbor-portal</span>       <span class="n">nginx</span> <span class="n">-g</span> <span class="n">daemon</span> <span class="n">off</span><span class="p">;</span>             <span class="n">Up</span>
<span class="n">nginx</span>               <span class="n">nginx</span> <span class="n">-g</span> <span class="n">daemon</span> <span class="n">off</span><span class="p">;</span>             <span class="n">Up</span>      <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">80</span><span class="p">-&gt;</span><span class="n">8080</span><span class="p">/</span><span class="n">tcp</span><span class="p">,:::</span><span class="n">80</span><span class="p">-&gt;</span><span class="n">8080</span><span class="p">/</span><span class="n">tcp</span>
<span class="n">redis</span>               <span class="n">redis-server</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">redis</span><span class="p">.</span><span class="n">conf</span>     <span class="n">Up</span>
<span class="n">registry</span>            <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">entrypoint</span><span class="p">.</span><span class="n">sh</span>       <span class="n">Up</span>
<span class="n">registryctl</span>         <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span>            <span class="n">Up</span>
</code></pre></div>
<p>定制服务启动脚本</p>
<div class="highlight"><pre><span></span><code><span class="n">定制服务启动脚本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># cat /lib/systemd/system/harbor.service</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Harbor</span>
<span class="n">After</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span> <span class="n">systemd-networkd</span><span class="p">.</span><span class="n">service</span> <span class="n">systemd-resolved</span><span class="p">.</span><span class="n">service</span>
<span class="n">Requires</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">http</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">vmware</span><span class="p">/</span><span class="n">harbor</span>

<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">simple</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>
<span class="c">#需要注意harbor的安装位置</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">docker-compose</span> <span class="p">-</span><span class="o">-file</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">docker-compose</span><span class="p">.</span><span class="n">yml</span> <span class="n">up</span>
<span class="n">ExecStop</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">docker-compose</span> <span class="p">-</span><span class="o">-file</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">/</span><span class="n">docker-compose</span><span class="p">.</span><span class="n">yml</span> <span class="n">down</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">加载服务配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># systemctl daemon-reload</span>

<span class="n">启动服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># systemctl start harbor</span>

<span class="n">检查状态</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># systemctl status harbor</span>

<span class="n">设置开机自启动</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-register</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">harbor</span><span class="p">]</span><span class="c"># systemctl enable harbor</span>
</code></pre></div>
<p><strong>Harbor实践</strong></p>
<p>windows定制harbor的访问域名</p>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p>浏览器访问域名，用户名: admin, 密码：123456</p>
<p><img alt="image-20220715125357778" src="../../../img/kubernetes/kubernetes_flannel/image-20220715125357778.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">输入用户名和密码后</span><span class="err">，</span><span class="n">点击登录</span><span class="err">，</span><span class="n">查看harbor的首页效果</span>
</code></pre></div>
<p><img alt="image-20220715125531167" src="../../../img/kubernetes/kubernetes_flannel/image-20220715125531167.png" /></p>
<p>创建工作账号</p>
<div class="highlight"><pre><span></span><code><span class="n">点击用户管理</span><span class="err">，</span><span class="n">进入用户创建界面</span>
</code></pre></div>
<p><img alt="image-20220715125606669" src="../../../img/kubernetes/kubernetes_flannel/image-20220715125606669.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">点击创建用户</span><span class="err">，</span><span class="n">进入用户创建界面</span>
</code></pre></div>
<p><img alt="image-20220715125758524" src="../../../img/kubernetes/kubernetes_flannel/image-20220715125758524.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">点击确定后</span><span class="err">，</span><span class="n">查看创建用户效果</span>
</code></pre></div>
<p><img alt="image-20220715125834969" src="../../../img/kubernetes/kubernetes_flannel/image-20220715125834969.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">点击左上角的管理员名称</span><span class="err">，</span><span class="n">退出终端页面</span>
</code></pre></div>
<p>仓库管理</p>
<div class="highlight"><pre><span></span><code><span class="n">采用普通用户登录到harbor中</span>
</code></pre></div>
<p><img alt="image-20220715130019232" src="../../../img/kubernetes/kubernetes_flannel/image-20220715130019232.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">创建shuji用户专用的项目仓库</span><span class="err">，</span><span class="n">名称为</span> <span class="n">superopsmsb</span><span class="err">，</span><span class="n">权限为公开的</span>
</code></pre></div>
<p><img alt="image-20220715130129241" src="../../../img/kubernetes/kubernetes_flannel/image-20220715130129241.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">点击确定后</span><span class="err">，</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20220715130201235" src="../../../img/kubernetes/kubernetes_flannel/image-20220715130201235.png" /></p>
<p>提交镜像</p>
<div class="highlight"><pre><span></span><code><span class="n">准备docker的配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># grep insecure /etc/docker/daemon.json</span>
  <span class="s2">&quot;insecure-registries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;kubernetes-register.superopsmsb.com&quot;</span><span class="p">],</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># systemctl restart docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker info | grep -A2 Insecure</span>
 <span class="n">Insecure</span> <span class="n">Registries</span><span class="p">:</span>
  <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
  <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">8</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">登录仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker login kubernetes-register.superopsmsb.com -u shuji</span>
<span class="n">Password</span><span class="p">:</span>   <span class="c"># 输入登录密码 A12345678a</span>
<span class="n">WARNING</span><span class="p">!</span> <span class="n">Your</span> <span class="n">password</span> <span class="n">will</span> <span class="n">be</span> <span class="n">stored</span> <span class="n">unencrypted</span> <span class="k">in</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">docker</span><span class="p">/</span><span class="n">config</span><span class="p">.</span><span class="n">json</span><span class="p">.</span>
<span class="n">Configure</span> <span class="n">a</span> <span class="n">credential</span> <span class="n">helper</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">this</span> <span class="n">warning</span><span class="p">.</span> <span class="n">See</span>
<span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">docker</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">engine</span><span class="p">/</span><span class="n">reference</span><span class="p">/</span><span class="n">commandline</span><span class="p">/</span><span class="n">login</span><span class="p">/</span><span class="c">#credentials-store</span>

<span class="n">Login</span> <span class="n">Succeeded</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">下载镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker pull busybox</span>

<span class="n">定制镜像标签</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker tag busybox kubernetes-register.superopsmsb.com/superopsmsb/busybox:v0.1</span>

<span class="n">推送镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker push kubernetes-register.superopsmsb.com/superopsmsb/busybox:v0.1</span>
<span class="n">The</span> <span class="n">push</span> <span class="n">refers</span> <span class="n">to</span> <span class="n">repository</span> <span class="p">[</span><span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">busybox</span><span class="p">]</span>
<span class="n">7ad00cd55506</span><span class="p">:</span> <span class="n">Pushed</span>
<span class="n">v0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">digest</span><span class="p">:</span> <span class="n">sha256</span><span class="p">:</span><span class="n">dcdf379c574e1773d703f0c0d56d67594e7a91d6b84d11ff46799f60fb081c52</span> <span class="n">size</span><span class="p">:</span> <span class="n">527</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">删除镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker rmi busybox kubernetes-register.superopsmsb.com/superopsmsb/busybox:v0.1</span>

<span class="n">下载镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker pull kubernetes-register.superopsmsb.com/superopsmsb/busybox:v0.1</span>
<span class="n">v0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">Pulling</span> <span class="n">from</span> <span class="n">superopsmsb</span><span class="p">/</span><span class="n">busybox</span>
<span class="n">19d511225f94</span><span class="p">:</span> <span class="n">Pull</span> <span class="n">complete</span>
<span class="n">Digest</span><span class="p">:</span> <span class="n">sha256</span><span class="p">:</span><span class="n">dcdf379c574e1773d703f0c0d56d67594e7a91d6b84d11ff46799f60fb081c52</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Downloaded</span> <span class="n">newer</span> <span class="n">image</span> <span class="k">for</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">busybox</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">1</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">busybox</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">1</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">我们的harbor私有仓库就构建好了</span>
</code></pre></div>
<p>同步所有的docker配置</p>
<div class="highlight"><pre><span></span><code><span class="n">同步所有主机的docker配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in 15 16 17;do scp /etc/docker/daemon.json root@10.0.0.$i:/etc/docker/daemon.json; ssh root@10.0.0.$i &quot;systemctl restart docker&quot;; done</span>
<span class="n">daemon</span><span class="p">.</span><span class="n">json</span>                                                                      <span class="n">100</span><span class="p">%</span>  <span class="n">299</span>   <span class="n">250</span><span class="p">.</span><span class="n">0KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
<span class="n">daemon</span><span class="p">.</span><span class="n">json</span>                                                                      <span class="n">100</span><span class="p">%</span>  <span class="n">299</span>   <span class="n">249</span><span class="p">.</span><span class="n">6KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
<span class="n">daemon</span><span class="p">.</span><span class="n">json</span>                                                                      <span class="n">100</span><span class="p">%</span>  <span class="n">299</span>   <span class="n">243</span><span class="p">.</span><span class="n">5KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="115_master">1.1.5 master环境部署<a class="headerlink" href="#115_master" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 软件安装、环境初始化、小结 三个方面来学习。</p>
<p><strong>软件安装</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">我们已经把kubernetes集群所有主机的软件源配置完毕了</span><span class="err">，</span><span class="n">所以接下来</span><span class="err">，</span><span class="n">我们需要做的就是如何部署kubernetes环境</span>
</code></pre></div>
<p>软件安装</p>
<div class="highlight"><pre><span></span><code><span class="n">查看默认的最新版本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum list kubeadm</span>
<span class="n">已加载插件</span><span class="err">：</span><span class="n">fastestmirror</span>
<span class="n">Loading</span> <span class="n">mirror</span> <span class="n">speeds</span> <span class="n">from</span> <span class="n">cached</span> <span class="n">hostfile</span>
<span class="n">可安装的软件包</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                                   <span class="n">1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">3</span><span class="p">-</span><span class="n">0</span>                                   <span class="n">kubernetes</span>

<span class="n">查看软件的最近版本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum list kubeadm --showduplicates | sort -r | grep 1.2</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                       <span class="n">1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">3</span><span class="p">-</span><span class="n">0</span>                         <span class="n">kubernetes</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                       <span class="n">1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">2</span><span class="p">-</span><span class="n">0</span>                         <span class="n">kubernetes</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                       <span class="n">1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span><span class="p">-</span><span class="n">0</span>                         <span class="n">kubernetes</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                       <span class="n">1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">0</span>                         <span class="n">kubernetes</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                       <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span><span class="p">-</span><span class="n">0</span>                         <span class="n">kubernetes</span>
<span class="n">kubeadm</span><span class="p">.</span><span class="n">x86_64</span>                       <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span><span class="p">-</span><span class="n">0</span>                         <span class="n">kubernetes</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">安装制定版本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># yum install kubeadm-1.23.9-0 kubectl-1.23.9-0 kubelet-1.23.9-0 -y</span>

<span class="n">注意</span><span class="err">：</span>
</code></pre></div>
<p><img alt="image-20220715160251133" src="../../../img/kubernetes/kubernetes_flannel/image-20220715160251133.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">核心软件解析</span>
    <span class="n">kubeadm</span> <span class="n">主要是对k8s集群来进行管理的</span><span class="err">，</span><span class="n">所以在master角色主机上安装</span>
    <span class="n">kubelet</span> <span class="n">是以服务的方式来进行启动</span><span class="err">，</span><span class="n">主要用于收集节点主机的信息</span>
    <span class="n">kubectl</span> <span class="n">主要是用来对集群中的资源对象进行管控</span><span class="err">，</span><span class="n">一半情况下</span><span class="err">，</span><span class="n">node角色的节点是不需要安装的</span><span class="err">。</span>
<span class="n">依赖软件解析</span>
    <span class="n">libnetfilter_xxx是Linux系统下网络数据包过滤的配置工具</span>
    <span class="n">kubernetes-cni是容器网络通信的软件</span>
    <span class="n">socat是kubelet的依赖</span>
    <span class="n">cri-tools是CRI容器运行时接口的命令行工具</span>
</code></pre></div>
<p>命令解读</p>
<div class="highlight"><pre><span></span><code><span class="n">查看集群初始化命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm version</span>
<span class="n">kubeadm</span> <span class="n">version</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">version</span><span class="p">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;23&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.23.9&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;c1de2d70269039fe55efb98e737d9a29f9155246&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2022-07-13T14:25:37Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.17.11&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/amd64&quot;</span><span class="p">}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm --help</span>


    <span class="err">┌──────────────────────────────────────────────────────────┐</span>
    <span class="err">│</span> <span class="n">KUBEADM</span>                                                  <span class="err">│</span>
    <span class="err">│</span> <span class="n">Easily</span> <span class="n">bootstrap</span> <span class="n">a</span> <span class="n">secure</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>             <span class="err">│</span>
    <span class="err">│</span>                                                          <span class="err">│</span>
    <span class="err">│</span> <span class="n">Please</span> <span class="n">give</span> <span class="n">us</span> <span class="n">feedback</span> <span class="n">at</span><span class="p">:</span>                              <span class="err">│</span>
    <span class="err">│</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubeadm</span><span class="p">/</span><span class="n">issues</span>             <span class="err">│</span>
    <span class="err">└──────────────────────────────────────────────────────────┘</span>

<span class="n">Example</span> <span class="n">usage</span><span class="p">:</span>

    <span class="n">Create</span> <span class="n">a</span> <span class="n">two-machine</span> <span class="n">cluster</span> <span class="n">with</span> <span class="n">one</span> <span class="n">control-plane</span> <span class="n">node</span>
    <span class="p">(</span><span class="n">which</span> <span class="n">controls</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">),</span> <span class="n">and</span> <span class="n">one</span> <span class="n">worker</span> <span class="n">node</span>
    <span class="p">(</span><span class="nb">where </span><span class="n">your</span> <span class="n">workloads</span><span class="p">,</span> <span class="n">like</span> <span class="n">Pods</span> <span class="n">and</span> <span class="n">Deployments</span> <span class="n">run</span><span class="p">).</span>

    <span class="err">┌──────────────────────────────────────────────────────────┐</span>
    <span class="err">│</span> <span class="n">On</span> <span class="n">the</span> <span class="n">first</span> <span class="n">machine</span><span class="p">:</span>                                    <span class="err">│</span>
    <span class="err">├──────────────────────────────────────────────────────────┤</span>
    <span class="err">│</span> <span class="n">control-plane</span><span class="c"># kubeadm init                              │</span>
    <span class="err">└──────────────────────────────────────────────────────────┘</span>

    <span class="err">┌──────────────────────────────────────────────────────────┐</span>
    <span class="err">│</span> <span class="n">On</span> <span class="n">the</span> <span class="n">second</span> <span class="n">machine</span><span class="p">:</span>                                   <span class="err">│</span>
    <span class="err">├──────────────────────────────────────────────────────────┤</span>
    <span class="err">│</span> <span class="n">worker</span><span class="c"># kubeadm join &lt;arguments-returned-from-init&gt;      │</span>
    <span class="err">└──────────────────────────────────────────────────────────┘</span>

    <span class="n">You</span> <span class="n">can</span> <span class="n">then</span> <span class="n">repeat</span> <span class="n">the</span> <span class="n">second</span> <span class="n">step</span> <span class="n">on</span> <span class="n">as</span> <span class="n">many</span> <span class="n">other</span> <span class="n">machines</span> <span class="n">as</span> <span class="n">you</span> <span class="n">like</span><span class="p">.</span>

<span class="n">Usage</span><span class="p">:</span>
  <span class="n">kubeadm</span> <span class="no">[command]</span>

<span class="n">Available</span> <span class="n">Commands</span><span class="p">:</span>
  <span class="n">certs</span>       <span class="n">Commands</span> <span class="n">related</span> <span class="n">to</span> <span class="n">handling</span> <span class="n">kubernetes</span> <span class="n">certificates</span>
  <span class="n">completion</span>  <span class="n">Output</span> <span class="n">shell</span> <span class="n">completion</span> <span class="n">code</span> <span class="k">for</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">shell</span> <span class="p">(</span><span class="n">bash</span> <span class="n">or</span> <span class="n">zsh</span><span class="p">)</span>
  <span class="n">config</span>      <span class="n">Manage</span> <span class="n">configuration</span> <span class="k">for</span> <span class="n">a</span> <span class="n">kubeadm</span> <span class="n">cluster</span> <span class="n">persisted</span> <span class="k">in</span> <span class="n">a</span> <span class="n">ConfigMap</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
  <span class="n">help</span>        <span class="n">Help</span> <span class="n">about</span> <span class="n">any</span> <span class="n">command</span>
  <span class="n">init</span>        <span class="n">Run</span> <span class="n">this</span> <span class="n">command</span> <span class="k">in</span> <span class="n">order</span> <span class="n">to</span> <span class="nb">set </span><span class="n">up</span> <span class="n">the</span> <span class="n">Kubernetes</span> <span class="n">control</span> <span class="n">plane</span>
  <span class="n">join</span>        <span class="n">Run</span> <span class="n">this</span> <span class="n">on</span> <span class="n">any</span> <span class="n">machine</span> <span class="n">you</span> <span class="n">wish</span> <span class="n">to</span> <span class="n">join</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">cluster</span>
  <span class="n">kubeconfig</span>  <span class="n">Kubeconfig</span> <span class="n">file</span> <span class="n">utilities</span>
  <span class="n">reset</span>       <span class="n">Performs</span> <span class="n">a</span> <span class="n">best</span> <span class="n">effort</span> <span class="n">revert</span> <span class="n">of</span> <span class="n">changes</span> <span class="n">made</span> <span class="n">to</span> <span class="n">this</span> <span class="n">host</span> <span class="n">by</span> <span class="s1">&#39;kubeadm init&#39;</span> <span class="n">or</span> <span class="s1">&#39;kubeadm join&#39;</span>
  <span class="n">token</span>       <span class="n">Manage</span> <span class="n">bootstrap</span> <span class="n">tokens</span>
  <span class="n">upgrade</span>     <span class="n">Upgrade</span> <span class="n">your</span> <span class="n">cluster</span> <span class="n">smoothly</span> <span class="n">to</span> <span class="n">a</span> <span class="n">newer</span> <span class="n">version</span> <span class="n">with</span> <span class="n">this</span> <span class="n">command</span>
  <span class="n">version</span>     <span class="n">Print</span> <span class="n">the</span> <span class="n">version</span> <span class="n">of</span> <span class="n">kubeadm</span>

<span class="n">Flags</span><span class="p">:</span>
      <span class="p">-</span><span class="n">-add-dir-header</span>           <span class="k">If</span> <span class="n">true</span><span class="p">,</span> <span class="n">adds</span> <span class="n">the</span> <span class="n">file</span> <span class="n">directory</span> <span class="n">to</span> <span class="n">the</span> <span class="n">header</span> <span class="n">of</span> <span class="n">the</span> <span class="n">log</span> <span class="n">messages</span>
  <span class="n">-h</span><span class="p">,</span> <span class="p">-</span><span class="n">-help</span>                     <span class="n">help</span> <span class="k">for</span> <span class="n">kubeadm</span>
      <span class="p">-</span><span class="n">-log</span><span class="o">-file</span> <span class="n">string</span>          <span class="k">If</span> <span class="n">non-empty</span><span class="p">,</span> <span class="n">use</span> <span class="n">this</span> <span class="n">log</span> <span class="n">file</span>
      <span class="p">-</span><span class="n">-log</span><span class="o">-file</span><span class="n">-max-size</span> <span class="n">uint</span>   <span class="n">Defines</span> <span class="n">the</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">a</span> <span class="n">log</span> <span class="n">file</span> <span class="n">can</span> <span class="n">grow</span> <span class="n">to</span><span class="p">.</span> <span class="n">Unit</span> <span class="n">is</span> <span class="n">megabytes</span><span class="p">.</span> <span class="k">If</span> <span class="n">the</span> <span class="n">value</span> <span class="n">is</span> <span class="n">0</span><span class="p">,</span> <span class="n">the</span> <span class="n">maximum</span> <span class="n">file</span> <span class="n">size</span> <span class="n">is</span> <span class="n">unlimited</span><span class="p">.</span> <span class="p">(</span><span class="k">default</span> <span class="n">1800</span><span class="p">)</span>
      <span class="p">-</span><span class="n">-one-output</span>               <span class="k">If</span> <span class="n">true</span><span class="p">,</span> <span class="n">only</span> <span class="nb">write </span><span class="n">logs</span> <span class="n">to</span> <span class="n">their</span> <span class="n">native</span> <span class="n">severity</span> <span class="n">level</span> <span class="p">(</span><span class="n">vs</span> <span class="n">also</span> <span class="n">writing</span> <span class="n">to</span> <span class="n">each</span> <span class="n">lower</span> <span class="n">severity</span> <span class="n">level</span><span class="p">)</span>
      <span class="p">-</span><span class="n">-rootfs</span> <span class="n">string</span>            <span class="no">[EXPERIMENTAL]</span> <span class="n">The</span> <span class="n">path</span> <span class="n">to</span> <span class="n">the</span> <span class="s1">&#39;real&#39;</span> <span class="n">host</span> <span class="n">root</span> <span class="n">filesystem</span><span class="p">.</span>
      <span class="p">-</span><span class="n">-skip-headers</span>             <span class="k">If</span> <span class="n">true</span><span class="p">,</span> <span class="n">avoid</span> <span class="n">header</span> <span class="n">prefixes</span> <span class="k">in</span> <span class="n">the</span> <span class="n">log</span> <span class="n">messages</span>
      <span class="p">-</span><span class="n">-skip-log-headers</span>         <span class="k">If</span> <span class="n">true</span><span class="p">,</span> <span class="n">avoid</span> <span class="n">headers</span> <span class="n">when</span> <span class="n">opening</span> <span class="n">log</span> <span class="n">files</span>
  <span class="n">-v</span><span class="p">,</span> <span class="p">-</span><span class="n">-v</span> <span class="n">Level</span>                  <span class="n">number</span> <span class="k">for</span> <span class="n">the</span> <span class="n">log</span> <span class="n">level</span> <span class="n">verbosity</span>

<span class="n">Additional</span> <span class="n">help</span> <span class="n">topics</span><span class="p">:</span>
  <span class="n">kubeadm</span> <span class="n">alpha</span>      <span class="n">Kubeadm</span> <span class="n">experimental</span> <span class="n">sub-commands</span>

<span class="n">Use</span> <span class="s2">&quot;kubeadm [command] --help&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span> <span class="n">about</span> <span class="n">a</span> <span class="n">command</span><span class="p">.</span>
</code></pre></div>
<p>信息查看</p>
<div class="highlight"><pre><span></span><code><span class="n">查看集群初始化时候的默认配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm config print init-defaults</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta3</span>
<span class="n">bootstrapTokens</span><span class="p">:</span>
<span class="p">-</span> <span class="n">groups</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">system</span><span class="p">:</span><span class="n">bootstrappers</span><span class="p">:</span><span class="n">kubeadm</span><span class="p">:</span><span class="k">default</span><span class="n">-node-token</span>
  <span class="n">token</span><span class="p">:</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span>
  <span class="n">ttl</span><span class="p">:</span> <span class="n">24h0m0s</span>
  <span class="n">usages</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">signing</span>
  <span class="p">-</span> <span class="n">authentication</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">InitConfiguration</span>
<span class="n">localAPIEndpoint</span><span class="p">:</span>
  <span class="n">advertiseAddress</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">4</span>
  <span class="n">bindPort</span><span class="p">:</span> <span class="n">6443</span>
<span class="n">nodeRegistration</span><span class="p">:</span>
  <span class="n">criSocket</span><span class="p">:</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">dockershim</span><span class="p">.</span><span class="n">sock</span>
  <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">node</span>
  <span class="n">taints</span><span class="p">:</span> <span class="n">null</span>
<span class="p">---</span>
<span class="n">apiServer</span><span class="p">:</span>
  <span class="n">timeoutForControlPlane</span><span class="p">:</span> <span class="n">4m0s</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta3</span>
<span class="n">certificatesDir</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">pki</span>
<span class="n">clusterName</span><span class="p">:</span> <span class="n">kubernetes</span>
<span class="n">controllerManager</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">dns</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">etcd</span><span class="p">:</span>
  <span class="n">local</span><span class="p">:</span>
    <span class="n">dataDir</span><span class="p">:</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span>
<span class="n">imageRepository</span><span class="p">:</span> <span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterConfiguration</span>
<span class="n">kubernetesVersion</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="n">networking</span><span class="p">:</span>
  <span class="n">dnsDomain</span><span class="p">:</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
  <span class="n">serviceSubnet</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span>
<span class="n">scheduler</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">可以重点关注</span><span class="err">，</span><span class="n">master和node的注释信息</span><span class="err">、</span><span class="n">镜像仓库和子网信息</span>
    <span class="n">这条命令可以生成定制的kubeadm</span><span class="p">.</span><span class="n">conf认证文件</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查当前版本的kubeadm所依赖的镜像版本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm config images list</span>
<span class="n">I0715</span> <span class="n">16</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">07</span><span class="p">.</span><span class="n">269149</span>    <span class="n">7605</span> <span class="n">version</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">255</span><span class="p">]</span> <span class="n">remote</span> <span class="n">version</span> <span class="n">is</span> <span class="n">much</span> <span class="n">newer</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">3</span><span class="p">;</span> <span class="n">falling</span> <span class="n">back</span> <span class="n">to</span><span class="p">:</span> <span class="n">stable</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-scheduler</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">pause</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">etcd</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span><span class="p">-</span><span class="n">0</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">coredns</span><span class="p">/</span><span class="n">coredns</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">6</span>

<span class="n">检查指定版本的kubeadm所依赖的镜像版本</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm config images list --kubernetes-version=v1.23.6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-scheduler</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">pause</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">6</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">etcd</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span><span class="p">-</span><span class="n">0</span>
<span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">coredns</span><span class="p">/</span><span class="n">coredns</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">6</span>
</code></pre></div>
<p>拉取环境依赖的镜像</p>
<div class="highlight"><pre><span></span><code><span class="n">预拉取镜像文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm config images pull</span>
<span class="n">I0715</span> <span class="n">16</span><span class="p">:</span><span class="n">09</span><span class="p">:</span><span class="n">24</span><span class="p">.</span><span class="n">185598</span>    <span class="n">7624</span> <span class="n">version</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">255</span><span class="p">]</span> <span class="n">remote</span> <span class="n">version</span> <span class="n">is</span> <span class="n">much</span> <span class="n">newer</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">3</span><span class="p">;</span> <span class="n">falling</span> <span class="n">back</span> <span class="n">to</span><span class="p">:</span> <span class="n">stable</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span>
<span class="n">failed</span> <span class="n">to</span> <span class="n">pull</span> <span class="n">image</span> <span class="s2">&quot;k8s.gcr.io/kube-apiserver:v1.23.9&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">:</span> <span class="n">Error</span> <span class="n">response</span> <span class="n">from</span> <span class="n">daemon</span><span class="p">:</span> <span class="n">Get</span> <span class="s2">&quot;https://k8s.gcr.io/v2/&quot;</span><span class="p">:</span> <span class="n">dial</span> <span class="n">tcp</span> <span class="n">142</span><span class="p">.</span><span class="n">250</span><span class="p">.</span><span class="n">157</span><span class="p">.</span><span class="n">82</span><span class="p">:</span><span class="n">443</span><span class="p">:</span> <span class="n">connect</span><span class="p">:</span> <span class="n">connection</span> <span class="n">timed</span> <span class="n">out</span>
<span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="n">exit</span> <span class="n">status</span> <span class="n">1</span>
<span class="n">To</span> <span class="n">see</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">of</span> <span class="n">this</span> <span class="n">error</span> <span class="n">execute</span> <span class="n">with</span> <span class="p">-</span><span class="n">-v</span><span class="p">=</span><span class="n">5</span> <span class="n">or</span> <span class="n">higher</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">由于默认情况下</span><span class="err">，</span><span class="n">这些镜像是从一个我们访问不到的网站上拉取的</span><span class="err">，</span><span class="n">所以这一步在没有实现科学上网的前提下</span><span class="err">，</span><span class="n">不要执行</span><span class="err">。</span>
    <span class="n">推荐在初始化之前</span><span class="err">，</span><span class="n">更换一下镜像仓库</span><span class="err">，</span><span class="n">提前获取文件</span><span class="p">,</span><span class="n">比如我们可以从</span> 
        <span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">镜像名称</span> <span class="n">获取镜像文件</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">镜像获取脚本内容</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /data/scripts/04_kubernetes_get_images.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: 获取kubernetes依赖的Docker镜像文件</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>
<span class="c"># 定制普通环境变量</span>
<span class="n">ali_mirror</span><span class="p">=</span><span class="s1">&#39;registry.aliyuncs.com&#39;</span>
<span class="n">harbor_mirror</span><span class="p">=</span><span class="s1">&#39;kubernetes-register.superopsmsb.com&#39;</span>
<span class="n">harbor_repo</span><span class="p">=</span><span class="s1">&#39;google_containers&#39;</span>

<span class="c"># 环境定制</span>
<span class="n">kubernetes_image_get</span><span class="p">(){</span>
  <span class="c"># 获取脚本参数</span>
  <span class="n">kubernetes_version</span><span class="p">=</span><span class="s2">&quot;$1&quot;</span>
  <span class="c"># 获取制定kubernetes版本所需镜像</span>
  <span class="n">images</span><span class="p">=$(</span><span class="n">kubeadm</span> <span class="n">config</span> <span class="n">images</span> <span class="n">list</span> <span class="p">-</span><span class="n">-kubernetes-version</span><span class="p">=${</span><span class="n">kubernetes_version</span><span class="p">}</span> <span class="p">|</span> <span class="n">awk</span> <span class="o">-F</span> <span class="s2">&quot;/&quot;</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>

  <span class="c"># 获取依赖镜像</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">${</span><span class="n">images</span><span class="p">}</span>
  <span class="k">do</span>
    <span class="n">docker</span> <span class="n">pull</span> <span class="p">${</span><span class="n">ali_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">tag</span> <span class="p">${</span><span class="n">ali_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>  <span class="p">${</span><span class="n">harbor_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">rmi</span> <span class="p">${</span><span class="n">ali_mirror</span><span class="p">}/${</span><span class="n">harbor_repo</span><span class="p">}/</span><span class="nv">$i</span>
  <span class="n">done</span>
<span class="p">}</span>

<span class="c"># 脚本的帮助</span>
<span class="n">Usage</span><span class="p">(){</span>
  <span class="nb">echo </span><span class="s2">&quot;/bin/bash $0 &quot;</span>
<span class="p">}</span>

<span class="c"># 脚本主流程</span>
<span class="k">if</span> <span class="p">[</span> <span class="p">$</span><span class="c"># -eq 0 ]</span>
<span class="n">then</span>
   <span class="n">read</span> <span class="n">-p</span> <span class="s2">&quot;请输入要获取kubernetes镜像的版本(示例: v1.23.9): &quot;</span> <span class="n">kubernetes_version</span>
   <span class="n">kubernetes_image_get</span> <span class="p">${</span><span class="n">kubernetes_version</span><span class="p">}</span>
<span class="k">else</span>
   <span class="n">Usage</span>
<span class="n">fi</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">脚本执行效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/04_kubernetes_get_images.sh</span>
<span class="n">请输入要获取kubernetes镜像的版本</span><span class="p">(</span><span class="n">示例</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span><span class="p">):</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker images</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker images | awk &#39;{print $1,$2}&#39;</span>
<span class="n">REPOSITORY</span> <span class="n">TAG</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">kube-apiserver</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">kube-controller-manager</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">kube-scheduler</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">kube-proxy</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">etcd</span> <span class="n">3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span><span class="p">-</span><span class="n">0</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">coredns</span> <span class="n">v1</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">6</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">pause</span> <span class="n">3</span><span class="p">.</span><span class="n">6</span>

<span class="n">harbor创建仓库</span>
    <span class="n">登录harbor仓库</span><span class="err">，</span><span class="n">创建一个google_containers的公开仓库</span>

<span class="n">登录仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker login kubernetes-register.superopsmsb.com -u shuji</span>
<span class="n">Password</span><span class="p">:</span> <span class="c"># 输入A12345678a</span>

<span class="n">提交镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in $(docker images | grep -v TAG | awk &#39;{print $1&quot;:&quot;$2}&#39;);do docker push $i;done</span>
</code></pre></div>
<p><strong>环境初始化</strong></p>
<p>master主机环境初始化</p>
<div class="highlight"><pre><span></span><code><span class="n">环境初始化命令</span>
<span class="n">kubeadm</span> <span class="n">init</span> <span class="p">-</span><span class="n">-kubernetes-version</span><span class="p">=</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-apiserver-advertise-address</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-image-repository</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-service-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-pod-network-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-ignore-preflight-errors</span><span class="p">=</span><span class="n">Swap</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">参数解析</span><span class="err">：</span>
     <span class="p">-</span><span class="n">-apiserver-advertise-address</span> <span class="n">要设定为当前集群的master地址</span><span class="err">，</span><span class="n">而且必须为ipv4</span><span class="p">|</span><span class="n">ipv6地址</span>
<span class="n">由于kubeadm</span> <span class="n">init命令默认去外网获取镜像</span><span class="err">，</span><span class="n">这里我们使用</span><span class="p">-</span><span class="n">-image-repository来指定使用国内镜像</span>
    <span class="p">-</span><span class="n">-kubernetes-version选项的版本号用于指定要部署的Kubenretes程序版本</span><span class="err">，</span><span class="n">它需要与当前的kubeadm支持的版本保持一致</span><span class="err">；</span><span class="n">该参数是必须的</span>
    <span class="p">-</span><span class="n">-pod-network-cidr选项用于指定分Pod分配使用的网络地址</span><span class="err">，</span><span class="n">它通常应该与要部署使用的网络插件</span><span class="err">（</span><span class="n">例如flannel</span><span class="err">、</span><span class="n">calico等</span><span class="err">）</span><span class="n">的默认设定保持一致</span><span class="err">，</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16是flannel默认使用的网络</span><span class="err">；</span>
    <span class="p">-</span><span class="n">-service-cidr用于指定为Service分配使用的网络地址</span><span class="err">，</span><span class="n">它由kubernetes管理</span><span class="err">，</span><span class="n">默认即为10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span><span class="err">；</span>
    <span class="p">-</span><span class="n">-ignore-preflight-errors</span><span class="p">=</span><span class="n">Swap</span> <span class="n">如果没有该项</span><span class="err">，</span><span class="n">必须保证系统禁用Swap设备的状态</span><span class="err">。</span><span class="n">一般最好加上</span>  
    <span class="p">-</span><span class="n">-image-repository</span> <span class="n">用于指定我们在安装kubernetes环境的时候</span><span class="err">，</span><span class="n">从哪个镜像里面下载相关的docker镜像</span><span class="err">，</span><span class="n">如果需要用本地的仓库</span><span class="err">，</span><span class="n">那么就用本地的仓库地址即可</span>   
</code></pre></div>
<p>环境初始化过程</p>
<div class="highlight"><pre><span></span><code><span class="n">环境初始化命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm init --kubernetes-version=1.23.9 \</span>
<span class="p">&gt;</span> <span class="p">-</span><span class="n">-apiserver-advertise-address</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">\</span>
<span class="p">&gt;</span> <span class="p">-</span><span class="n">-image-repository</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span> <span class="p">\</span>
<span class="p">&gt;</span> <span class="p">-</span><span class="n">-service-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span> <span class="p">\</span>
<span class="p">&gt;</span> <span class="p">-</span><span class="n">-pod-network-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span> <span class="p">\</span>
<span class="p">&gt;</span> <span class="p">-</span><span class="n">-ignore-preflight-errors</span><span class="p">=</span><span class="n">Swap</span>

<span class="c"># 环境初始化过程</span>
<span class="no">[init]</span> <span class="n">Using</span> <span class="n">Kubernetes</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="no">[preflight]</span> <span class="n">Running</span> <span class="n">pre-flight</span> <span class="n">checks</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Docker</span><span class="p">]:</span> <span class="n">docker</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable docker.service&#39;</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Kubelet</span><span class="p">]:</span> <span class="n">kubelet</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable kubelet.service&#39;</span>
<span class="no">[preflight]</span> <span class="n">Pulling</span> <span class="n">images</span> <span class="n">required</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">a</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>
<span class="no">[preflight]</span> <span class="n">This</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">or</span> <span class="n">two</span><span class="p">,</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">the</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">your</span> <span class="n">internet</span> <span class="n">connection</span>
<span class="no">[preflight]</span> <span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">action</span> <span class="k">in</span> <span class="n">beforehand</span> <span class="n">using</span> <span class="s1">&#39;kubeadm config images pull&#39;</span>
<span class="no">[certs]</span> <span class="n">Using</span> <span class="n">certificateDir</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/pki&quot;</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">apiserver</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes</span> <span class="n">kubernetes-master</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-kubelet-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/server&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">etcd</span><span class="p">/</span><span class="n">server</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes-master</span> <span class="n">localhost</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">::</span><span class="n">1</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/peer&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">etcd</span><span class="p">/</span><span class="n">peer</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes-master</span> <span class="n">localhost</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">::</span><span class="n">1</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/healthcheck-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-etcd-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;sa&quot;</span> <span class="n">key</span> <span class="n">and</span> <span class="n">public</span> <span class="n">key</span>
<span class="no">[kubeconfig]</span> <span class="n">Using</span> <span class="n">kubeconfig</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes&quot;</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;admin.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;kubelet.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;controller-manager.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;scheduler.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">environment</span> <span class="n">file</span> <span class="n">with</span> <span class="n">flags</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">the</span> <span class="n">kubelet</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Using</span> <span class="n">manifest</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-apiserver&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-controller-manager&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-scheduler&quot;</span>
<span class="no">[etcd]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="n">local</span> <span class="n">etcd</span> <span class="k">in</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="nb">wait-control</span><span class="n">-plane</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">boot</span> <span class="n">up</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">as</span> <span class="n">static</span> <span class="n">Pods</span> <span class="n">from</span> <span class="n">directory</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span><span class="p">.</span> <span class="n">This</span> <span class="n">can</span> <span class="n">take</span> <span class="n">up</span> <span class="n">to</span> <span class="n">4m0s</span>
<span class="no">[apiclient]</span> <span class="n">All</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">components</span> <span class="n">are</span> <span class="n">healthy</span> <span class="n">after</span> <span class="n">11</span><span class="p">.</span><span class="n">006830</span> <span class="n">seconds</span>
<span class="p">[</span><span class="n">upload-config</span><span class="p">]</span> <span class="n">Storing</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">used</span> <span class="k">in</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubeadm-config&quot;</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
<span class="no">[kubelet]</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubelet-config-1.23&quot;</span> <span class="k">in</span> <span class="n">namespace</span> <span class="n">kube-system</span> <span class="n">with</span> <span class="n">the</span> <span class="n">configuration</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelets</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">NOTE</span><span class="p">:</span> <span class="n">The</span> <span class="s2">&quot;kubelet-config-1.23&quot;</span> <span class="n">naming</span> <span class="n">of</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">ConfigMap</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">.</span> <span class="n">Once</span> <span class="n">the</span> <span class="n">UnversionedKubeletConfigMap</span> <span class="n">feature</span> <span class="n">gate</span> <span class="n">graduates</span> <span class="n">to</span> <span class="n">Beta</span> <span class="n">the</span> <span class="k">default</span> <span class="n">name</span> <span class="n">will</span> <span class="n">become</span> <span class="n">just</span> <span class="s2">&quot;kubelet-config&quot;</span><span class="p">.</span> <span class="n">Kubeadm</span> <span class="n">upgrade</span> <span class="n">will</span> <span class="n">handle</span> <span class="n">this</span> <span class="n">transition</span> <span class="n">transparently</span><span class="p">.</span>
<span class="p">[</span><span class="n">upload-certs</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">phase</span><span class="p">.</span> <span class="n">Please</span> <span class="n">see</span> <span class="p">-</span><span class="n">-upload-certs</span>
<span class="p">[</span><span class="n">mark-control-plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubernetes-master</span> <span class="n">as</span> <span class="n">control-plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">labels</span><span class="p">:</span> <span class="p">[</span><span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">(</span><span class="n">deprecated</span><span class="p">)</span> <span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">control-plane</span> <span class="n">node</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">exclude-from-external-load-balancers</span><span class="p">]</span>
<span class="p">[</span><span class="n">mark-control-plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubernetes-master</span> <span class="n">as</span> <span class="n">control-plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">taints</span> <span class="p">[</span><span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">:</span><span class="n">NoSchedule</span><span class="p">]</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Using</span> <span class="n">token</span><span class="p">:</span> <span class="n">vudfvt</span><span class="p">.</span><span class="n">fwpohpbb7yw2qy49</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Configuring</span> <span class="n">bootstrap</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">cluster-info</span> <span class="n">ConfigMap</span><span class="p">,</span> <span class="n">RBAC</span> <span class="n">Roles</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">get</span> <span class="n">nodes</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">post</span> <span class="n">CSRs</span> <span class="k">in</span> <span class="n">order</span> <span class="k">for</span> <span class="n">nodes</span> <span class="n">to</span> <span class="n">get</span> <span class="n">long</span> <span class="n">term</span> <span class="n">certificate</span> <span class="n">credentials</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">the</span> <span class="n">csrapprover</span> <span class="n">controller</span> <span class="n">automatically</span> <span class="n">approve</span> <span class="n">CSRs</span> <span class="n">from</span> <span class="n">a</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">Token</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">certificate</span> <span class="n">rotation</span> <span class="k">for</span> <span class="n">all</span> <span class="n">node</span> <span class="n">client</span> <span class="n">certificates</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">the</span> <span class="s2">&quot;cluster-info&quot;</span> <span class="n">ConfigMap</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-public&quot;</span> <span class="n">namespace</span>
<span class="p">[</span><span class="n">kubelet-finalize</span><span class="p">]</span> <span class="n">Updating</span> <span class="s2">&quot;/etc/kubernetes/kubelet.conf&quot;</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="n">a</span> <span class="n">rotatable</span> <span class="n">kubelet</span> <span class="n">client</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[addons]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">CoreDNS</span>
<span class="no">[addons]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">kube-proxy</span>
<span class="c"># 基本初始化完毕后，需要做的一些事情</span>
<span class="n">Your</span> <span class="n">Kubernetes</span> <span class="n">control-plane</span> <span class="n">has</span> <span class="n">initialized</span> <span class="n">successfully</span><span class="p">!</span>

<span class="n">To</span> <span class="nb">start </span><span class="n">using</span> <span class="n">your</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">as</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">user</span><span class="p">:</span>
  <span class="c"># 定制kubernetes的登录权限</span>
  <span class="n">mkdir</span> <span class="n">-p</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span>
  <span class="n">sudo</span> <span class="nb">cp </span><span class="n">-i</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
  <span class="n">sudo</span> <span class="n">chown</span> <span class="p">$(</span><span class="n">id</span> <span class="n">-u</span><span class="p">):$(</span><span class="n">id</span> <span class="n">-g</span><span class="p">)</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>

<span class="n">Alternatively</span><span class="p">,</span> <span class="k">if</span> <span class="n">you</span> <span class="n">are</span> <span class="n">the</span> <span class="n">root</span> <span class="n">user</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">run</span><span class="p">:</span>

  <span class="n">export</span> <span class="n">KUBECONFIG</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span>
<span class="c"># 定制kubernetes的网络配置</span>
<span class="n">You</span> <span class="n">should</span> <span class="n">now</span> <span class="n">deploy</span> <span class="n">a</span> <span class="n">pod</span> <span class="n">network</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
<span class="n">Run</span> <span class="s2">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="n">with</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">options</span> <span class="n">listed</span> <span class="n">at</span><span class="p">:</span>
  <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">concepts</span><span class="p">/</span><span class="n">cluster-administration</span><span class="p">/</span><span class="n">addons</span><span class="p">/</span>

<span class="n">Then</span> <span class="n">you</span> <span class="n">can</span> <span class="n">join</span> <span class="n">any</span> <span class="n">number</span> <span class="n">of</span> <span class="n">worker</span> <span class="n">nodes</span> <span class="n">by</span> <span class="n">running</span> <span class="n">the</span> <span class="n">following</span> <span class="n">on</span> <span class="n">each</span> <span class="n">as</span> <span class="n">root</span><span class="p">:</span>
<span class="c"># node节点注册到master节点</span>
<span class="n">kubeadm</span> <span class="n">join</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-token</span> <span class="n">vudfvt</span><span class="p">.</span><span class="n">fwpohpbb7yw2qy49</span> <span class="p">\</span>
        <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">110b1efec63971fda17154782dc1179fa93ef90a8804be381e5a83a8a7748545</span>
</code></pre></div>
<p>确认效果</p>
<div class="highlight"><pre><span></span><code><span class="n">未设定权限前操作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">The</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span> <span class="n">localhost</span><span class="p">:</span><span class="n">8080</span> <span class="n">was</span> <span class="n">refused</span> <span class="p">-</span> <span class="n">did</span> <span class="n">you</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">right</span> <span class="n">host</span> <span class="n">or</span> <span class="n">port</span><span class="p">?</span>

<span class="n">设定kubernetes的认证权限</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># mkdir -p $HOME/.kube</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>

<span class="n">再次检测</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>     <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">4m10s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="116_node">1.1.6 node环境部署<a class="headerlink" href="#116_node" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 节点初始化、网络环境配置、小结 三个方面来学习。</p>
<p><strong>节点初始化</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于node节点来说</span><span class="err">，</span><span class="n">我们无需对集群环境进行管理</span><span class="err">，</span><span class="n">所以不需要安装和部署kubectl软件</span><span class="err">，</span><span class="n">其他的正常安装</span><span class="err">，</span><span class="n">然后根据master节点的认证通信</span><span class="err">，</span><span class="n">我们可以进行节点加入集群的配置</span><span class="err">。</span>
</code></pre></div>
<p>安装软件</p>
<div class="highlight"><pre><span></span><code><span class="n">所有node节点都执行如下步骤</span><span class="err">：</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in {15..17}; do ssh root@10.0.0.$i &quot;yum install kubeadm-1.23.9-0 kubelet-1.23.9-0 -y&quot;;done</span>
</code></pre></div>
<p>节点初始化(以node1为例)</p>
<div class="highlight"><pre><span></span><code><span class="n">节点1进行环境初始化</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node1</span> <span class="p">~]</span><span class="c"># kubeadm join 10.0.0.12:6443 --token vudfvt.fwpohpbb7yw2qy49 \</span>
<span class="p">&gt;</span>         <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">110b1efec63971fda17154782dc1179fa93ef90a8804be381e5a83a8a7748545</span>
<span class="no">[preflight]</span> <span class="n">Running</span> <span class="n">pre-flight</span> <span class="n">checks</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Docker</span><span class="p">]:</span> <span class="n">docker</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable docker.service&#39;</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Kubelet</span><span class="p">]:</span> <span class="n">kubelet</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable kubelet.service&#39;</span>
<span class="no">[preflight]</span> <span class="n">Reading</span> <span class="n">configuration</span> <span class="n">from</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">...</span>
<span class="no">[preflight]</span> <span class="n">FYI</span><span class="p">:</span> <span class="n">You</span> <span class="n">can</span> <span class="n">look</span> <span class="n">at</span> <span class="n">this</span> <span class="n">config</span> <span class="n">file</span> <span class="n">with</span> <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">environment</span> <span class="n">file</span> <span class="n">with</span> <span class="n">flags</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">the</span> <span class="n">kubelet</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">the</span> <span class="n">TLS</span> <span class="n">Bootstrap</span><span class="p">...</span>

<span class="n">This</span> <span class="n">node</span> <span class="n">has</span> <span class="n">joined</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">:</span>
<span class="p">*</span> <span class="n">Certificate</span> <span class="n">signing</span> <span class="n">request</span> <span class="n">was</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">apiserver</span> <span class="n">and</span> <span class="n">a</span> <span class="n">response</span> <span class="n">was</span> <span class="n">received</span><span class="p">.</span>
<span class="p">*</span> <span class="n">The</span> <span class="n">Kubelet</span> <span class="n">was</span> <span class="n">informed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">new</span> <span class="n">secure</span> <span class="n">connection</span> <span class="n">details</span><span class="p">.</span>

<span class="n">Run</span> <span class="s1">&#39;kubectl get nodes&#39;</span> <span class="n">on</span> <span class="n">the</span> <span class="n">control-plane</span> <span class="n">to</span> <span class="n">see</span> <span class="n">this</span> <span class="n">node</span> <span class="n">join</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">回到master节点主机查看节点效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>     <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">17m</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">2m10s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>

<span class="n">所有节点都做完后</span><span class="err">，</span><span class="n">再次查看master的节点效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>     <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">21m</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">110s</span>    <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">6m17s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node3</span>    <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">17s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<p><strong>网络环境配置</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">根据master节点初始化的效果</span><span class="err">，</span><span class="n">我们这里需要单独将网络插件的功能实现</span>
</code></pre></div>
<p>插件环境部署</p>
<div class="highlight"><pre><span></span><code><span class="n">创建基本目录</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span> <span class="n">-p</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span>

<span class="n">获取配置文件</span>
<span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">raw</span><span class="p">.</span><span class="n">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">flannel-io</span><span class="p">/</span><span class="n">flannel</span><span class="p">/</span><span class="n">master</span><span class="p">/</span><span class="n">Documentation</span><span class="p">/</span><span class="n">kube-flannel</span><span class="p">.</span><span class="n">yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取相关镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># grep image kube-flannel.yml | grep -v &#39;#&#39;</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">rancher</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel-cni-plugin</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">rancher</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">18</span><span class="p">.</span><span class="n">1</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">rancher</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">18</span><span class="p">.</span><span class="n">1</span>

<span class="n">定制镜像标签</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">$(</span><span class="n">grep</span> <span class="n">image</span> <span class="n">kube-flannel</span><span class="p">.</span><span class="n">yml</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">-v</span> <span class="s1">&#39;#&#39;</span> <span class="p">|</span> <span class="n">awk</span> <span class="o">-F</span> <span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
<span class="k">do</span>
    <span class="n">docker</span> <span class="n">pull</span> <span class="n">rancher</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">tag</span> <span class="n">rancher</span><span class="p">/</span><span class="nv">$i</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">push</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">rmi</span> <span class="n">rancher</span><span class="p">/</span><span class="nv">$i</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">备份配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># cp kube-flannel.yml{,.bak}</span>

<span class="n">修改配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># sed -i &#39;/ image:/s/rancher/kubernetes-register.superopsmsb.com\/google_containers/&#39; kube-flannel.yml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># sed -n &#39;/ image:/p&#39; kube-flannel.yml</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel-cni-plugin</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">18</span><span class="p">.</span><span class="n">1</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">mirrored-flannelcni-flannel</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">18</span><span class="p">.</span><span class="n">1</span>

<span class="n">应用配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># kubectl apply -f kube-flannel.yml</span>
<span class="n">namespace</span><span class="p">/</span><span class="n">kube-flannel</span> <span class="n">created</span>
<span class="n">clusterrole</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">serviceaccount</span><span class="p">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">configmap</span><span class="p">/</span><span class="n">kube-flannel-cfg</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">kube-flannel-ds</span> <span class="n">created</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看集群节点效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># kubectl  get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">62m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">42m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">47m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node3</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">41m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>

<span class="n">查看集群pod效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># kubectl  get pod -n kube-system</span>
<span class="n">NAME</span>                                        <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">coredns</span><span class="p">-</span><span class="n">5d555c984-gt4w9</span>                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
<span class="n">coredns</span><span class="p">-</span><span class="n">5d555c984-t4gps</span>                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
<span class="n">etcd-kubernetes-master</span>                      <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
<span class="n">kube-apiserver-kubernetes-master</span>            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
<span class="n">kube-controller-manager-kubernetes-master</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">48txz</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">43m</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">5vdhv</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">41m</span>
<span class="n">kube-proxy-cblk7</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">47m</span>
<span class="n">kube-proxy-hglfm</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
<span class="n">kube-scheduler-kubernetes-master</span>            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">62m</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="117">1.1.7 集群环境实践<a class="headerlink" href="#117" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础功能、节点管理、小结 三个方面来学习。</p>
<p><strong>基础功能</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">目前kubernetes的集群环境已经部署完毕了</span><span class="err">，</span><span class="n">但是有些基础功能配置还是需要来梳理一下的</span><span class="err">。</span><span class="n">默认情况下</span><span class="err">，</span><span class="n">我们在master上执行命令的时候</span><span class="err">，</span><span class="n">没有办法直接使用tab方式补全命令</span><span class="err">，</span><span class="n">我们可以采取下面方式来实现</span><span class="err">。</span>
</code></pre></div>
<p>命令补全</p>
<div class="highlight"><pre><span></span><code><span class="n">获取相关环境配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl completion bash</span>

<span class="n">加载这些配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># source &lt;(kubectl completion bash)</span>
    <span class="n">注意</span><span class="p">:</span> <span class="s2">&quot;&lt;(&quot;</span> <span class="n">两个符号之间没有空格</span>

<span class="n">放到当前用户的环境文件中</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># echo &quot;source &lt;(kubeadm completion bash)&quot; &gt;&gt; ~/.bashrc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># source ~/.bashrc</span>

<span class="n">测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get n</span>
<span class="n">namespaces</span>                         <span class="n">networkpolicies</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>  <span class="n">nodes</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm co</span>
<span class="n">completion</span>  <span class="n">config</span>
</code></pre></div>
<p><strong>命令简介</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">kubectl是kubernetes集群内部管理各种资源对象的核心命令</span><span class="err">，</span><span class="n">一般情况下</span><span class="err">，</span><span class="n">只有master主机才有</span>
</code></pre></div>
<p>命令帮助</p>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span><span class="n">虽然kubernetes的kubectl命令的一些参数发生了变化</span><span class="err">，</span><span class="n">甚至是移除</span><span class="err">，</span><span class="n">但是不影响旧有命令的正常使用</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl --help</span>
<span class="n">kubectl</span> <span class="n">controls</span> <span class="n">the</span> <span class="n">Kubernetes</span> <span class="n">cluster</span> <span class="n">manager</span><span class="p">.</span>

 <span class="n">Find</span> <span class="n">more</span> <span class="n">information</span> <span class="n">at</span><span class="p">:</span> <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">reference</span><span class="p">/</span><span class="n">kubectl</span><span class="p">/</span><span class="n">overview</span><span class="p">/</span>

<span class="n">Basic</span> <span class="n">Commands</span> <span class="p">(</span><span class="n">Beginner</span><span class="p">):</span>  <span class="n">资源对象核心的基础命令</span>
  <span class="n">create</span>        <span class="n">Create</span> <span class="n">a</span> <span class="n">resource</span> <span class="n">from</span> <span class="n">a</span> <span class="n">file</span> <span class="n">or</span> <span class="n">from</span> <span class="n">stdin</span>
  <span class="n">expose</span>        <span class="n">Take</span> <span class="n">a</span> <span class="n">replication</span> <span class="n">controller</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">deployment</span> <span class="n">or</span> <span class="n">pod</span> <span class="n">and</span> <span class="n">expose</span> <span class="n">it</span> <span class="n">as</span> <span class="n">a</span> <span class="n">new</span>
<span class="n">Kubernetes</span> <span class="n">service</span>
  <span class="n">run</span>           <span class="n">在集群中运行一个指定的镜像</span>
  <span class="nb">set </span>          <span class="n">为</span> <span class="n">objects</span> <span class="n">设置一个指定的特征</span>

<span class="n">Basic</span> <span class="n">Commands</span> <span class="p">(</span><span class="n">Intermediate</span><span class="p">):</span>   <span class="n">资源对象的一些基本操作命令</span>
  <span class="n">explain</span>       <span class="n">Get</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">a</span> <span class="n">resource</span>
  <span class="n">get</span>           <span class="n">显示一个或更多</span> <span class="n">resources</span>
  <span class="n">edit</span>          <span class="n">在服务器上编辑一个资源</span>
  <span class="n">delete</span>        <span class="n">Delete</span> <span class="n">resources</span> <span class="n">by</span> <span class="n">file</span> <span class="n">names</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">resources</span> <span class="n">and</span> <span class="n">names</span><span class="p">,</span> <span class="n">or</span> <span class="n">by</span> <span class="n">resources</span> <span class="n">and</span>
<span class="n">label</span> <span class="n">selector</span>

<span class="n">Deploy</span> <span class="n">Commands</span><span class="p">:</span>   <span class="n">应用部署相关的命令</span>
  <span class="n">rollout</span>       <span class="n">Manage</span> <span class="n">the</span> <span class="n">rollout</span> <span class="n">of</span> <span class="n">a</span> <span class="n">resource</span>
  <span class="n">scale</span>         <span class="nb">Set </span><span class="n">a</span> <span class="n">new</span> <span class="n">size</span> <span class="k">for</span> <span class="n">a</span> <span class="n">deployment</span><span class="p">,</span> <span class="n">replica</span> <span class="n">set</span><span class="p">,</span> <span class="n">or</span> <span class="n">replication</span> <span class="n">controller</span>
  <span class="n">autoscale</span>     <span class="n">Auto-scale</span> <span class="n">a</span> <span class="n">deployment</span><span class="p">,</span> <span class="n">replica</span> <span class="n">set</span><span class="p">,</span> <span class="n">stateful</span> <span class="n">set</span><span class="p">,</span> <span class="n">or</span> <span class="n">replication</span> <span class="n">controller</span>

<span class="n">Cluster</span> <span class="n">Management</span> <span class="n">Commands</span><span class="p">:</span>  <span class="n">集群管理相关的命令</span>
  <span class="n">certificate</span>   <span class="n">修改</span> <span class="n">certificate</span> <span class="n">资源</span><span class="p">.</span>
  <span class="n">cluster-info</span>  <span class="n">Display</span> <span class="n">cluster</span> <span class="n">information</span>
  <span class="n">top</span>           <span class="n">Display</span> <span class="n">resource</span> <span class="p">(</span><span class="n">CPU</span><span class="p">/</span><span class="n">memory</span><span class="p">)</span> <span class="n">usage</span>
  <span class="n">cordon</span>        <span class="n">标记</span> <span class="n">node</span> <span class="n">为</span> <span class="n">unschedulable</span>
  <span class="n">uncordon</span>      <span class="n">标记</span> <span class="n">node</span> <span class="n">为</span> <span class="n">schedulable</span>
  <span class="n">drain</span>         <span class="n">Drain</span> <span class="n">node</span> <span class="k">in</span> <span class="n">preparation</span> <span class="k">for</span> <span class="n">maintenance</span>
  <span class="n">taint</span>         <span class="n">更新一个或者多个</span> <span class="n">node</span> <span class="n">上的</span> <span class="n">taints</span>

<span class="n">Troubleshooting</span> <span class="n">and</span> <span class="n">Debugging</span> <span class="n">Commands</span><span class="p">:</span>  <span class="n">集群故障管理相关的命令</span>
  <span class="n">describe</span>      <span class="n">显示一个指定</span> <span class="n">resource</span> <span class="n">或者</span> <span class="nb">group </span><span class="n">的</span> <span class="n">resources</span> <span class="n">详情</span>
  <span class="n">logs</span>          <span class="n">输出容器在</span> <span class="n">pod</span> <span class="n">中的日志</span>
  <span class="n">attach</span>        <span class="n">Attach</span> <span class="n">到一个运行中的</span> <span class="n">container</span>
  <span class="n">exec</span>          <span class="n">在一个</span> <span class="n">container</span> <span class="n">中执行一个命令</span>
  <span class="n">port-forward</span>  <span class="n">Forward</span> <span class="n">one</span> <span class="n">or</span> <span class="n">more</span> <span class="n">local</span> <span class="n">ports</span> <span class="n">to</span> <span class="n">a</span> <span class="n">pod</span>
  <span class="n">proxy</span>         <span class="n">运行一个</span> <span class="n">proxy</span> <span class="n">到</span> <span class="n">Kubernetes</span> <span class="n">API</span> <span class="n">server</span>
  <span class="nb">cp </span>           <span class="nb">Copy </span><span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">to</span> <span class="n">and</span> <span class="n">from</span> <span class="n">containers</span>
  <span class="n">auth</span>          <span class="n">Inspect</span> <span class="n">authorization</span>
  <span class="n">debug</span>         <span class="n">Create</span> <span class="n">debugging</span> <span class="n">sessions</span> <span class="k">for</span> <span class="n">troubleshooting</span> <span class="n">workloads</span> <span class="n">and</span> <span class="n">nodes</span>

<span class="n">Advanced</span> <span class="n">Commands</span><span class="p">:</span>  <span class="n">集群管理高阶命令</span><span class="err">，</span><span class="n">一般用一个apply即可</span>
  <span class="nb">diff </span>         <span class="nb">Diff </span><span class="n">the</span> <span class="n">live</span> <span class="n">version</span> <span class="n">against</span> <span class="n">a</span> <span class="n">would-be</span> <span class="n">applied</span> <span class="n">version</span>
  <span class="n">apply</span>         <span class="n">Apply</span> <span class="n">a</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">a</span> <span class="n">resource</span> <span class="n">by</span> <span class="n">file</span> <span class="n">name</span> <span class="n">or</span> <span class="n">stdin</span>
  <span class="n">patch</span>         <span class="n">Update</span> <span class="n">fields</span> <span class="n">of</span> <span class="n">a</span> <span class="n">resource</span>
  <span class="n">replace</span>       <span class="n">Replace</span> <span class="n">a</span> <span class="n">resource</span> <span class="n">by</span> <span class="n">file</span> <span class="n">name</span> <span class="n">or</span> <span class="n">stdin</span>
  <span class="n">wait</span>          <span class="n">Experimental</span><span class="p">:</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">condition</span> <span class="n">on</span> <span class="n">one</span> <span class="n">or</span> <span class="n">many</span> <span class="n">resources</span>
  <span class="n">kustomize</span>     <span class="n">Build</span> <span class="n">a</span> <span class="n">kustomization</span> <span class="n">target</span> <span class="n">from</span> <span class="n">a</span> <span class="n">directory</span> <span class="n">or</span> <span class="n">URL</span><span class="p">.</span>

<span class="n">Settings</span> <span class="n">Commands</span><span class="p">:</span>  <span class="n">集群的一些设置性命令</span>
  <span class="n">label</span>         <span class="n">更新在这个资源上的</span> <span class="n">labels</span>
  <span class="n">annotate</span>      <span class="n">更新一个资源的注解</span>
  <span class="n">completion</span>    <span class="n">Output</span> <span class="n">shell</span> <span class="n">completion</span> <span class="n">code</span> <span class="k">for</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">shell</span> <span class="p">(</span><span class="n">bash</span><span class="p">,</span> <span class="n">zsh</span> <span class="n">or</span> <span class="n">fish</span><span class="p">)</span>

<span class="n">Other</span> <span class="n">Commands</span><span class="p">:</span>  <span class="n">其他的相关命令</span>
  <span class="n">alpha</span>         <span class="n">Commands</span> <span class="k">for</span> <span class="n">features</span> <span class="k">in</span> <span class="n">alpha</span>
  <span class="n">api-resources</span> <span class="n">Print</span> <span class="n">the</span> <span class="n">supported</span> <span class="n">API</span> <span class="n">resources</span> <span class="n">on</span> <span class="n">the</span> <span class="n">server</span>
  <span class="n">api-versions</span>  <span class="n">Print</span> <span class="n">the</span> <span class="n">supported</span> <span class="n">API</span> <span class="n">versions</span> <span class="n">on</span> <span class="n">the</span> <span class="n">server</span><span class="p">,</span> <span class="k">in</span> <span class="n">the</span> <span class="n">form</span> <span class="n">of</span> <span class="s2">&quot;group/version&quot;</span>
  <span class="n">config</span>        <span class="n">修改</span> <span class="n">kubeconfig</span> <span class="n">文件</span>
  <span class="n">plugin</span>        <span class="n">Provides</span> <span class="n">utilities</span> <span class="k">for</span> <span class="n">interacting</span> <span class="n">with</span> <span class="n">plugins</span>
  <span class="n">version</span>       <span class="n">输出</span> <span class="n">client</span> <span class="n">和</span> <span class="n">server</span> <span class="n">的版本信息</span>

<span class="n">Usage</span><span class="p">:</span>
  <span class="n">kubectl</span> <span class="no">[flags] [options]</span>

<span class="n">Use</span> <span class="s2">&quot;kubectl &lt;command&gt; --help&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span> <span class="n">about</span> <span class="n">a</span> <span class="n">given</span> <span class="n">command</span><span class="p">.</span>
<span class="n">Use</span> <span class="s2">&quot;kubectl options&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="n">list</span> <span class="n">of</span> <span class="n">global</span> <span class="n">command-line</span> <span class="n">options</span> <span class="p">(</span><span class="n">applies</span> <span class="n">to</span> <span class="n">all</span> <span class="n">commands</span><span class="p">).</span>
</code></pre></div>
<p>命令的帮助</p>
<div class="highlight"><pre><span></span><code><span class="n">查看子命令的帮助信息</span>
<span class="n">样式1</span><span class="err">：</span><span class="n">kubectl</span> <span class="n">子命令</span> <span class="p">-</span><span class="n">-help</span>
<span class="n">样式2</span><span class="err">：</span><span class="n">kubectl</span> <span class="n">help</span> <span class="n">子命令</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">样式1实践</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl version --help</span>
<span class="n">Print</span> <span class="n">the</span> <span class="n">client</span> <span class="n">and</span> <span class="n">server</span> <span class="n">version</span> <span class="n">information</span> <span class="k">for</span> <span class="n">the</span> <span class="n">current</span> <span class="n">context</span><span class="p">.</span>

<span class="n">Examples</span><span class="p">:</span>
  <span class="c"># Print the client and server versions for the current context</span>
  <span class="n">kubectl</span> <span class="n">version</span>
  <span class="p">...</span>

<span class="n">样式2实践</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl help version</span>
<span class="n">Print</span> <span class="n">the</span> <span class="n">client</span> <span class="n">and</span> <span class="n">server</span> <span class="n">version</span> <span class="n">information</span> <span class="k">for</span> <span class="n">the</span> <span class="n">current</span> <span class="n">context</span><span class="p">.</span>

<span class="n">Examples</span><span class="p">:</span>
  <span class="c"># Print the client and server versions for the current context</span>
  <span class="n">kubectl</span> <span class="n">version</span>
</code></pre></div>
<p>简单实践</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前节点效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">77m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">57m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">62m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node3</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">56m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>

<span class="n">移除节点3</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  delete node kubernetes-node3</span>
<span class="n">node</span> <span class="s2">&quot;kubernetes-node3&quot;</span> <span class="n">deleted</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">77m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">57m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">62m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">节点环境重置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node3</span> <span class="p">~]</span><span class="c"># kubeadm reset</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node3</span> <span class="p">~]</span><span class="c"># systemctl restart kubelet docker</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node3</span> <span class="p">~]</span><span class="c"># kubeadm join 10.0.0.12:6443 --token vudfvt.fwpohpbb7yw2qy49 --discovery-token-ca-cert-hash sha256:110b1efec63971fda17154782dc1179fa93ef90a8804be381e5a83a8a7748545</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">master节点查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">82m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">62m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">67m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node3</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">55s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="118">1.1.8 资源对象解读<a class="headerlink" href="#118" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 资源对象、命令解读、小结 三个方面来学习。</p>
<p><strong>资源对象</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">根据之前的对于kubernetes的简介</span><span class="err">，</span><span class="n">我们知道kubernetes之所以在大规模的容器场景下的管理效率非常好</span><span class="err">，</span><span class="n">原因在于它将我们人工对于容器的手工操作全部整合到的各种资源对象里面</span><span class="err">。</span>
<span class="n">在进行资源对象解读之前</span><span class="err">，</span><span class="n">我们需要给大家灌输一个基本的认识</span><span class="err">：</span>
    <span class="n">kubernetes的资源对象有两种</span><span class="err">：</span>
        <span class="n">默认的资源对象</span> <span class="p">-</span> <span class="n">默认的有五六十种</span><span class="err">，</span><span class="n">但是常用的也就那么一二十个</span><span class="err">。</span>
        <span class="n">自定义的资源对象</span> <span class="p">-</span> <span class="n">用户想怎么定义就怎么定义</span><span class="err">，</span><span class="n">数量无法统计</span><span class="err">，</span><span class="n">仅需要了解想要了解的即可</span>
</code></pre></div>
<p><img alt="image-20220715012035435" src="../../../img/kubernetes/kubernetes_flannel/image-20220715012035435.png" /></p>
<p>常见资源缩写</p>
<table>
<thead>
<tr>
<th>最基础资源对象</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>资源对象全称</td>
<td>缩写</td>
<td>资源对象全称</td>
<td>缩写</td>
</tr>
<tr>
<td>pod/pods</td>
<td>po</td>
<td>node/nodes</td>
<td>no</td>
</tr>
<tr>
<td><strong>最常见资源对象</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>资源对象全称</td>
<td>缩写</td>
<td>资源对象全称</td>
<td>缩写</td>
</tr>
<tr>
<td>replication controllers</td>
<td>rc</td>
<td>horizontal pod autoscalers</td>
<td>hpa</td>
</tr>
<tr>
<td>replica sets</td>
<td>rs</td>
<td>persistent volume</td>
<td>pv</td>
</tr>
<tr>
<td>deployment</td>
<td>deploy</td>
<td>persistent volume claims</td>
<td>pvc</td>
</tr>
<tr>
<td>services</td>
<td>svc</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>其他资源对象</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>namespaces</td>
<td>ns</td>
<td>storage classes</td>
<td>sc</td>
</tr>
<tr>
<td>config maps</td>
<td>cm</td>
<td>clusters</td>
<td></td>
</tr>
<tr>
<td>daemon sets</td>
<td>ds</td>
<td>stateful sets</td>
<td></td>
</tr>
<tr>
<td>endpoints</td>
<td>ep</td>
<td>secrets</td>
<td></td>
</tr>
<tr>
<td>events</td>
<td>ev</td>
<td>jobs</td>
<td></td>
</tr>
<tr>
<td>ingresses</td>
<td>ing</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>命令解读</strong></p>
<p>语法解读</p>
<div class="highlight"><pre><span></span><code><span class="n">命令格式</span><span class="err">：</span>
    <span class="n">kubectl</span> <span class="p">[</span><span class="n">子命令</span><span class="p">]</span> <span class="p">[</span><span class="n">资源类型</span><span class="p">]</span> <span class="p">[</span><span class="n">资源名称</span><span class="p">]</span> <span class="p">[</span><span class="n">其他标识</span><span class="p">-</span><span class="n">可选</span><span class="p">]</span>
<span class="n">参数解析</span><span class="err">：</span>
    <span class="n">子命令</span><span class="err">：</span><span class="n">操作Kubernetes资源对象的子命令</span><span class="err">，</span><span class="n">常见的有create</span><span class="err">、</span><span class="n">delete</span><span class="err">、</span><span class="n">describe</span><span class="err">、</span><span class="n">get等</span>
        <span class="n">create</span>  <span class="n">创建资源对象</span>  <span class="n">describe</span> <span class="n">查找资源的详细信息</span>
        <span class="n">delete</span>  <span class="n">删除资源对象</span>  <span class="n">get</span> <span class="n">获取资源基本信息</span>
    <span class="n">资源类型</span><span class="err">：</span><span class="n">Kubernetes资源类型</span><span class="err">，</span><span class="n">举例</span><span class="err">：</span><span class="n">结点的资源类型是nodes</span><span class="err">，</span><span class="n">缩写no</span>
    <span class="n">资源名称</span><span class="p">:</span> <span class="n">Kubernetes资源对象的名称</span><span class="err">，</span><span class="n">可以省略</span><span class="err">。</span>
    <span class="n">其他标识</span><span class="p">:</span> <span class="n">可选参数</span><span class="err">，</span><span class="n">一般用于信息的扩展信息展示</span>
</code></pre></div>
<p>资源对象基本信息</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源类型基本信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  api-resources | head -2</span>
<span class="n">NAME</span>               <span class="n">SHORTNAMES</span>   <span class="n">APIVERSION</span>       <span class="n">NAMESPACED</span>   <span class="n">KIND</span>
<span class="n">bindings</span>                        <span class="n">v1</span>               <span class="n">true</span>         <span class="n">Binding</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  api-resources | grep -v NAME | wc -l</span>
<span class="n">56</span>

<span class="n">查看资源类型的版本信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  api-versions | head -n2</span>
<span class="n">admissionregistration</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">apiextensions</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
</code></pre></div>
<p>常见资源对象查看</p>
<div class="highlight"><pre><span></span><code><span class="n">获取资源所在命名空间</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get ns</span>
<span class="n">NAME</span>              <span class="n">STATUS</span>   <span class="n">AGE</span>
<span class="k">default</span>           <span class="n">Active</span>   <span class="n">94m</span>
<span class="n">kube-flannel</span>      <span class="n">Active</span>   <span class="n">32m</span>
<span class="n">kube-node-lease</span>   <span class="n">Active</span>   <span class="n">94m</span>
<span class="n">kube-public</span>       <span class="n">Active</span>   <span class="n">94m</span>
<span class="n">kube-system</span>       <span class="n">Active</span>   <span class="n">94m</span>

<span class="n">获取命名空间的资源对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  get pod</span>
<span class="n">No</span> <span class="n">resources</span> <span class="n">found</span> <span class="k">in</span> <span class="k">default</span> <span class="n">namespace</span><span class="p">.</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  get pod -n kube-system</span>
<span class="n">NAME</span>                                        <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>      <span class="n">AGE</span>
<span class="n">coredns</span><span class="p">-</span><span class="n">5d555c984-gt4w9</span>                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
<span class="n">coredns</span><span class="p">-</span><span class="n">5d555c984-t4gps</span>                     <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
<span class="n">etcd-kubernetes-master</span>                      <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
<span class="n">kube-apiserver-kubernetes-master</span>            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
<span class="n">kube-controller-manager-kubernetes-master</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
<span class="n">kube-proxy</span><span class="p">-</span><span class="n">48txz</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">129m</span>
<span class="n">kube-proxy-cblk7</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">134m</span>
<span class="n">kube-proxy-ds8x5</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">2</span> <span class="p">(</span><span class="n">69m</span> <span class="n">ago</span><span class="p">)</span>   <span class="n">70m</span>
<span class="n">kube-proxy-hglfm</span>                            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
<span class="n">kube-scheduler-kubernetes-master</span>            <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>             <span class="n">149m</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">cs</span> <span class="n">获取集群组件相关资源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get cs</span>
<span class="n">Warning</span><span class="p">:</span> <span class="n">v1</span> <span class="n">ComponentStatus</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="k">in</span> <span class="n">v1</span><span class="p">.</span><span class="n">19</span><span class="p">+</span>
<span class="n">NAME</span>                 <span class="n">STATUS</span>    <span class="n">MESSAGE</span>                         <span class="n">ERROR</span>
<span class="n">controller-manager</span>   <span class="n">Healthy</span>   <span class="n">ok</span>
<span class="n">scheduler</span>            <span class="n">Healthy</span>   <span class="n">ok</span>
<span class="n">etcd</span><span class="p">-</span><span class="n">0</span>               <span class="n">Healthy</span>   <span class="p">{</span><span class="s2">&quot;health&quot;</span><span class="p">:</span><span class="s2">&quot;true&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sa</span> <span class="n">和</span> <span class="n">secrets</span> <span class="n">获取集群相关的用户相关信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get sa</span>
<span class="n">NAME</span>      <span class="n">SECRETS</span>   <span class="n">AGE</span>
<span class="k">default</span>   <span class="n">1</span>         <span class="n">150m</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get secrets</span>
<span class="n">NAME</span>                  <span class="nb">TYPE </span>                                 <span class="n">DATA</span>   <span class="n">AGE</span>
<span class="k">default</span><span class="n">-token-nc8rg</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">service-account-token</span>   <span class="n">3</span>      <span class="n">150m</span>
</code></pre></div>
<p>信息查看命令</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源对象</span>
    <span class="n">kubectl</span> <span class="n">get</span> <span class="n">资源类型</span> <span class="n">资源名称</span> <span class="p">&lt;</span><span class="n">-o</span> <span class="n">yaml</span><span class="p">/</span><span class="n">json</span><span class="p">/</span><span class="n">wide</span> <span class="p">|</span> <span class="n">-w</span><span class="p">&gt;</span>
    <span class="n">参数解析</span><span class="err">：</span>
        <span class="n">-w</span> <span class="n">是实时查看资源的状态</span><span class="err">。</span>
        <span class="n">-o</span> <span class="n">是以多种格式查看资源的属性信息</span>
        <span class="p">-</span><span class="n">-raw</span> <span class="n">从api地址中获取相关资源信息</span>

<span class="n">描述资源对象</span>
    <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">资源类型</span> <span class="n">资源名称</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">这个命令非常重要</span><span class="err">，</span><span class="n">一般我们应用部署排错时候</span><span class="err">，</span><span class="n">就用它</span><span class="err">。</span>

<span class="n">查看资源应用的访问日志</span>
    <span class="n">kubectl</span> <span class="n">logs</span> <span class="n">资源类型</span> <span class="n">资源名称</span>
    <span class="n">注意</span><span class="err">：</span>
        <span class="n">这个命令非常重要</span><span class="err">，</span><span class="n">一般我们服务排错时候</span><span class="err">，</span><span class="n">就用它</span><span class="err">。</span>
</code></pre></div>
<p>查看信息基本信息</p>
<div class="highlight"><pre><span></span><code><span class="n">基本的资源对象简要信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>    <span class="n">VERSION</span>
<span class="n">kubernetes-master</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">157m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node1</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">137m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node2</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">142m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
<span class="n">kubernetes-node3</span>    <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">75m</span>    <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes kubernetes-node1</span>
<span class="n">NAME</span>               <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>    <span class="n">VERSION</span>
<span class="n">kubernetes-node1</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">137m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看资源对象的属性信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes kubernetes-node1 -o yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Node</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">annotations</span><span class="p">:</span>
  <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看资源对象的扩展信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get nodes kubernetes-node1 -o wide</span>
<span class="n">NAME</span>               <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>    <span class="n">VERSION</span>   <span class="n">INTERNAL-IP</span>   <span class="n">EXTERNAL-IP</span>   <span class="n">OS-IMAGE</span>                <span class="n">KERNEL-VERSION</span>           <span class="n">CONTAINER-RUNTIME</span>
<span class="n">kubernetes-node1</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">139m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span>   <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>     <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">CentOS</span> <span class="n">Linux</span> <span class="n">7</span> <span class="p">(</span><span class="n">Core</span><span class="p">)</span>   <span class="n">3</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">-</span><span class="n">1160</span><span class="p">.</span><span class="n">el7</span><span class="p">.</span><span class="n">x86_64</span>   <span class="n">docker</span><span class="p">://</span><span class="n">20</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">17</span>
</code></pre></div>
<p>查看资源的描述信息</p>
<div class="highlight"><pre><span></span><code><span class="n">describe</span> <span class="n">查看资源对象的描述信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  describe namespaces default</span>
<span class="n">Name</span><span class="p">:</span>         <span class="k">default</span>
<span class="n">Labels</span><span class="p">:</span>       <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">metadata</span><span class="p">.</span><span class="n">name</span><span class="p">=</span><span class="k">default</span>
<span class="n">Annotations</span><span class="p">:</span>  <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">Status</span><span class="p">:</span>       <span class="n">Active</span>

<span class="n">No</span> <span class="n">resource</span> <span class="n">quota</span><span class="p">.</span>

<span class="n">No</span> <span class="n">LimitRange</span> <span class="n">resource</span><span class="p">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">logs</span> <span class="n">查看对象的应用访问日志</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl -n kube-system logs kube-proxy-hglfm</span>
<span class="n">I0715</span> <span class="n">08</span><span class="p">:</span><span class="n">35</span><span class="p">:</span><span class="n">01</span><span class="p">.</span><span class="n">883435</span>       <span class="n">1</span> <span class="n">node</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">163</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">retrieved</span> <span class="n">node</span> <span class="n">IP</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
<span class="n">I0715</span> <span class="n">08</span><span class="p">:</span><span class="n">35</span><span class="p">:</span><span class="n">01</span><span class="p">.</span><span class="n">883512</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">138</span><span class="p">]</span> <span class="s2">&quot;Detected node IP&quot;</span> <span class="n">address</span><span class="p">=</span><span class="s2">&quot;10.0.0.12&quot;</span>
<span class="n">I0715</span> <span class="n">08</span><span class="p">:</span><span class="n">35</span><span class="p">:</span><span class="n">01</span><span class="p">.</span><span class="n">883536</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">561</span><span class="p">]</span> <span class="s2">&quot;Unknown proxy mode, assuming iptables proxy&quot;</span> <span class="n">proxyMode</span><span class="p">=</span><span class="s2">&quot;&quot;</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="119">1.1.9 资源对象实践<a class="headerlink" href="#119" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 命令实践、应用实践、小结 三个方面来学习。</p>
<p><strong>命令实践</strong></p>
<p>准备资源</p>
<div class="highlight"><pre><span></span><code><span class="n">从网上获取镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker pull nginx</span>

<span class="n">镜像打标签</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker tag nginx:latest kubernetes-register.superopsmsb.com/superopsmsb/nginx:1.23.0</span>

<span class="n">提交镜像到仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker push kubernetes-register.superopsmsb.com/superopsmsb/nginx:1.23.0</span>

<span class="n">删除镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># docker rmi nginx</span>
</code></pre></div>
<p>创建资源对象</p>
<div class="highlight"><pre><span></span><code><span class="n">创建一个应用</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl create deployment nginx --image=kubernetes-register.superopsmsb.com/superopsmsb/nginx:1.23.0</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">NAME</span>                   <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>           <span class="n">NODE</span>               <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">13s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>   <span class="n">kubernetes-node3</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

<span class="n">访问效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># curl 10.244.5.2 -I</span>
<span class="n">HTTP</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">为应用暴露流量入口</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --port=80 --type=NodePort</span>

<span class="n">查看基本信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --port=80 --type=NodePort</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx</span> <span class="n">exposed</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  get service nginx</span>
<span class="n">NAME</span>    <span class="nb">TYPE </span>      <span class="n">CLUSTER-IP</span>      <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>        <span class="n">AGE</span>
<span class="n">nginx</span>   <span class="n">NodePort</span>   <span class="n">10</span><span class="p">.</span><span class="n">105</span><span class="p">.</span><span class="n">31</span><span class="p">.</span><span class="n">160</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">:</span><span class="n">32505</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">8s</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里的</span> <span class="n">NodePort</span> <span class="n">代表在所有的节点主机上都开启一个能够被外网访问的端口</span> <span class="n">32505</span>

<span class="n">访问效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># curl 10.105.31.160 -I</span>
<span class="n">HTTP</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:32505 -I</span>
<span class="n">HTTP</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<p>查看容器基本信息</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源的访问日志</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                   <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">9m47s</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  logs nginx-f44f65dc-99dvt</span>
<span class="p">...</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span> <span class="p">-</span> <span class="p">-</span> <span class="p">[</span><span class="n">15</span><span class="p">/</span><span class="n">Jul</span><span class="p">/</span><span class="n">2022</span><span class="p">:</span><span class="n">12</span><span class="p">:</span><span class="n">45</span><span class="p">:</span><span class="n">57</span> <span class="p">+</span><span class="n">0000</span><span class="p">]</span> <span class="s2">&quot;HEAD / HTTP/1.1&quot;</span> <span class="n">200</span> <span class="n">0</span> <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;curl/7.29.0&quot;</span> <span class="s2">&quot;-&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看资源的详情信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl describe pod nginx-f44f65dc-99dvt</span>
<span class="c"># 资源对象的基本属性信息</span>
<span class="n">Name</span><span class="p">:</span>         <span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>
<span class="n">Namespace</span><span class="p">:</span>    <span class="k">default</span>
<span class="n">Priority</span><span class="p">:</span>     <span class="n">0</span>
<span class="n">Node</span><span class="p">:</span>         <span class="n">kubernetes-node3</span><span class="p">/</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span>
<span class="nb">Start </span><span class="n">Time</span><span class="p">:</span>   <span class="n">Fri</span><span class="p">,</span> <span class="n">15</span> <span class="n">Jul</span> <span class="n">2022</span> <span class="n">20</span><span class="p">:</span><span class="n">44</span><span class="p">:</span><span class="n">17</span> <span class="p">+</span><span class="n">0800</span>
<span class="n">Labels</span><span class="p">:</span>       <span class="n">app</span><span class="p">=</span><span class="n">nginx</span>
              <span class="n">pod-template-hash</span><span class="p">=</span><span class="n">f44f65dc</span>
<span class="n">Annotations</span><span class="p">:</span>  <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">Status</span><span class="p">:</span>       <span class="n">Running</span>
<span class="n">IP</span><span class="p">:</span>           <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>
<span class="n">IPs</span><span class="p">:</span>
  <span class="n">IP</span><span class="p">:</span>           <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>
<span class="n">Controlled</span> <span class="n">By</span><span class="p">:</span>  <span class="n">ReplicaSet</span><span class="p">/</span><span class="n">nginx-f44f65dc</span>
<span class="c"># pod内部的容器相关信息</span>
<span class="n">Containers</span><span class="p">:</span>
  <span class="n">nginx</span><span class="p">:</span>  <span class="c"># 容器的名称</span>
    <span class="n">Container</span> <span class="n">ID</span><span class="p">:</span>   <span class="n">docker</span><span class="p">://</span><span class="n">8c0d89c8ab48e02495a2db4a2b2133c86811bd8064f800a16739f9532670d854</span>
    <span class="n">Image</span><span class="p">:</span>          <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
    <span class="n">Image</span> <span class="n">ID</span><span class="p">:</span>       <span class="n">docker-pullable</span><span class="p">://</span><span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span><span class="nv">@sha256</span><span class="p">:</span><span class="n">33cef86aae4e8487ff23a6ca16012fac28ff9e7a5e9759d291a7da06e36ac958</span>
    <span class="n">Port</span><span class="p">:</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
    <span class="n">Host</span> <span class="n">Port</span><span class="p">:</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
    <span class="n">State</span><span class="p">:</span>          <span class="n">Running</span>
      <span class="n">Started</span><span class="p">:</span>      <span class="n">Fri</span><span class="p">,</span> <span class="n">15</span> <span class="n">Jul</span> <span class="n">2022</span> <span class="n">20</span><span class="p">:</span><span class="n">44</span><span class="p">:</span><span class="n">24</span> <span class="p">+</span><span class="n">0800</span>
    <span class="n">Ready</span><span class="p">:</span>          <span class="n">True</span>
    <span class="n">Restart</span> <span class="n">Count</span><span class="p">:</span>  <span class="n">0</span>
    <span class="n">Environment</span><span class="p">:</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
    <span class="n">Mounts</span><span class="p">:</span>
      <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">secrets</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">serviceaccount</span> <span class="n">from</span> <span class="n">kube-api-access</span><span class="p">-</span><span class="n">7sxtx</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span>
<span class="n">Conditions</span><span class="p">:</span>
  <span class="nb">Type </span>             <span class="n">Status</span>
  <span class="n">Initialized</span>       <span class="n">True</span>
  <span class="n">Ready</span>             <span class="n">True</span>
  <span class="n">ContainersReady</span>   <span class="n">True</span>
  <span class="n">PodScheduled</span>      <span class="n">True</span>

<span class="c"># pod内部数据相关的信息</span>
<span class="n">Volumes</span><span class="p">:</span>
  <span class="n">kube-api-access</span><span class="p">-</span><span class="n">7sxtx</span><span class="p">:</span>
    <span class="n">Type</span><span class="p">:</span>                    <span class="n">Projected</span> <span class="p">(</span><span class="n">a</span> <span class="n">volume</span> <span class="n">that</span> <span class="n">contains</span> <span class="n">injected</span> <span class="n">data</span> <span class="n">from</span> <span class="n">multiple</span> <span class="n">sources</span><span class="p">)</span>
    <span class="n">TokenExpirationSeconds</span><span class="p">:</span>  <span class="n">3607</span>
    <span class="n">ConfigMapName</span><span class="p">:</span>           <span class="n">kube-root-ca</span><span class="p">.</span><span class="n">crt</span>
    <span class="n">ConfigMapOptional</span><span class="p">:</span>       <span class="p">&lt;</span><span class="n">nil</span><span class="p">&gt;</span>
    <span class="n">DownwardAPI</span><span class="p">:</span>             <span class="n">true</span>
<span class="n">QoS</span> <span class="n">Class</span><span class="p">:</span>                   <span class="n">BestEffort</span>
<span class="n">Node-Selectors</span><span class="p">:</span>              <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">Tolerations</span><span class="p">:</span>                 <span class="n">node</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">not-ready</span><span class="p">:</span><span class="n">NoExecute</span> <span class="n">op</span><span class="p">=</span><span class="n">Exists</span> <span class="k">for</span> <span class="n">300s</span>
                             <span class="n">node</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">unreachable</span><span class="p">:</span><span class="n">NoExecute</span> <span class="n">op</span><span class="p">=</span><span class="n">Exists</span> <span class="k">for</span> <span class="n">300s</span>
<span class="c"># 资源对象在创建过程中遇到的各种信息，这段信息是非常重要的                             </span>
<span class="n">Events</span><span class="p">:</span>
  <span class="nb">Type </span>   <span class="n">Reason</span>     <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="p">----</span>    <span class="p">------</span>     <span class="p">----</span>  <span class="p">----</span>               <span class="p">-------</span>
  <span class="n">Normal</span>  <span class="n">Scheduled</span>  <span class="n">10m</span>   <span class="k">default</span><span class="n">-scheduler</span>  <span class="n">Successfully</span> <span class="n">assigned</span> <span class="k">default</span><span class="p">/</span><span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span> <span class="n">to</span> <span class="n">kubernetes-node3</span>
  <span class="n">Normal</span>  <span class="n">Pulling</span>    <span class="n">10m</span>   <span class="n">kubelet</span>            <span class="n">Pulling</span> <span class="n">image</span> <span class="s2">&quot;kubernetes-register.superopsmsb.com/superopsmsb/nginx:1.23.0&quot;</span>
  <span class="n">Normal</span>  <span class="n">Pulled</span>     <span class="n">10m</span>   <span class="n">kubelet</span>            <span class="n">Successfully</span> <span class="n">pulled</span> <span class="n">image</span> <span class="s2">&quot;kubernetes-register.superopsmsb.com/superopsmsb/nginx:1.23.0&quot;</span> <span class="k">in</span> <span class="n">4</span><span class="p">.</span><span class="n">335869479s</span>
  <span class="n">Normal</span>  <span class="n">Created</span>    <span class="n">10m</span>   <span class="n">kubelet</span>            <span class="n">Created</span> <span class="n">container</span> <span class="n">nginx</span>
  <span class="n">Normal</span>  <span class="n">Started</span>    <span class="n">10m</span>   <span class="n">kubelet</span>            <span class="n">Started</span> <span class="n">container</span> <span class="n">nginx</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">资源对象内部的容器信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl  exec -it nginx-f44f65dc-99dvt -- /bin/bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span><span class="p">:/</span><span class="c"># env</span>
<span class="n">KUBERNETES_SERVICE_PORT_HTTPS</span><span class="p">=</span><span class="n">443</span>
<span class="n">KUBERNETES_SERVICE_PORT</span><span class="p">=</span><span class="n">443</span>
<span class="n">HOSTNAME</span><span class="p">=</span><span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>
<span class="p">...</span>

<span class="n">修改nginx的页面信息</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span><span class="p">:/</span><span class="c"># grep -A1 &#39;location /&#39; /etc/nginx/conf.d/default.conf</span>
    <span class="n">location</span> <span class="p">/</span> <span class="p">{</span>
        <span class="n">root</span>   <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="p">;</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span><span class="p">:/</span><span class="c"># echo $HOSTNAME &gt; /usr/share/nginx/html/index.html</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span><span class="p">:/</span><span class="c"># exit</span>
<span class="n">exit</span>

<span class="n">访问应用效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># curl 10.244.5.2</span>
<span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:32505</span>
<span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>
</code></pre></div>
<p><strong>应用实践</strong></p>
<p>资源的扩容缩容</p>
<div class="highlight"><pre><span></span><code><span class="n">pod的容量扩充</span> 
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl help scale</span>

<span class="n">调整pod数量为3</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl scale --replicas=3 deployment nginx</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx</span> <span class="n">scaled</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get deployment</span>
<span class="n">NAME</span>    <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">nginx</span>   <span class="n">1</span><span class="p">/</span><span class="n">3</span>     <span class="n">3</span>            <span class="n">1</span>           <span class="n">20m</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">NAME</span>                   <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>           <span class="n">NODE</span>               <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">nginx-f44f65dc</span><span class="p">-</span><span class="n">99dvt</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">20m</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span>   <span class="n">kubernetes-node3</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">nginx-f44f65dc-rskvx</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">16s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">4</span>   <span class="n">kubernetes-node1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">nginx-f44f65dc-xpkgq</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">16s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span>   <span class="n">kubernetes-node2</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">pod的容量收缩</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl scale --replicas=1 deployment nginx</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx</span> <span class="n">scaled</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get deployment</span>
<span class="n">NAME</span>    <span class="n">READY</span>   <span class="n">UP-TO-DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">nginx</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">1</span>            <span class="n">1</span>           <span class="n">20m</span>
</code></pre></div>
<p>资源的删除</p>
<div class="highlight"><pre><span></span><code><span class="n">删除资源有两种方式</span>
<span class="n">方法1</span><span class="err">：</span>
    <span class="n">kubectl</span> <span class="n">delete</span> <span class="n">资源类型</span> <span class="n">资源1</span> <span class="n">资源2</span> <span class="p">...</span> <span class="n">资源n</span>
    <span class="n">因为限制了资源类型</span><span class="err">，</span><span class="n">所以这种方法只能删除一种资源</span>
<span class="n">方法2</span><span class="err">：</span>
    <span class="n">kubectl</span> <span class="n">delete</span> <span class="n">资源类型</span><span class="p">/</span><span class="n">资源</span>
    <span class="n">因为删除对象的时候</span><span class="err">，</span><span class="n">指定了资源类型</span><span class="err">，</span><span class="n">所以我们可以通过这种资源类型限制的方式同时删除多种类型资源</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">删除deployment资源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl delete deployments nginx</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span> <span class="s2">&quot;nginx&quot;</span> <span class="n">deleted</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get deployment</span>
<span class="n">No</span> <span class="n">resources</span> <span class="n">found</span> <span class="k">in</span> <span class="k">default</span> <span class="n">namespace</span><span class="p">.</span>

<span class="n">删除svc资源</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl delete svc nginx</span>
<span class="n">service</span> <span class="s2">&quot;nginx&quot;</span> <span class="n">deleted</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl get svc nginx</span>
<span class="n">Error</span> <span class="n">from</span> <span class="n">server</span> <span class="p">(</span><span class="n">NotFound</span><span class="p">):</span> <span class="n">services</span> <span class="s2">&quot;nginx&quot;</span> <span class="n">not</span> <span class="n">found</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="12">1.2 多主集群<a class="headerlink" href="#12" title="Permanent link">&para;</a></h2>
<h3 id="121">1.2.1 集群环境解读<a class="headerlink" href="#121" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 集群规划、环境解读、小结 三个方面来学习。</p>
<p><strong>集群规划</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在生产中</span><span class="err">，</span><span class="n">因为kubernetes的主角色主机对于整个集群的重要性不可估量</span><span class="err">，</span><span class="n">我们的kubernetes集群一般都会采用多主分布式效果</span><span class="err">。</span>
    <span class="n">另外因为大规模环境下</span><span class="err">，</span><span class="n">涉及到的资源对象过于繁多</span><span class="err">，</span><span class="n">所以</span><span class="err">，</span><span class="n">kubernetes集群环境部署的时候</span><span class="err">，</span><span class="n">一般会采用属性高度定制的方式来实现</span><span class="err">。</span>
    <span class="n">为了方便后续的集群环境升级的管理操作</span><span class="err">，</span><span class="n">我们在高可用的时候</span><span class="err">，</span><span class="n">部署</span> <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8的软件版本</span><span class="p">(</span><span class="n">当然只需要1</span><span class="p">.</span><span class="n">22</span><span class="p">+</span><span class="n">版本都可以</span><span class="err">，</span><span class="n">不允许出现大跨版本的出现</span><span class="err">。</span><span class="p">)</span>
</code></pre></div>
<p>实验环境的效果图</p>
<p><img alt="image-20220715213302865" src="../../../img/kubernetes/kubernetes_flannel/image-20220715213302865.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">修改master节点主机的hosts文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /etc/hosts</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">kubernetes-master1</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">kubernetes-master1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">kubernetes-master2</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">kubernetes-master2</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="n">kubernetes-master3</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span> <span class="n">kubernetes-master3</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">kubernetes-node1</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">kubernetes-node2</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node2</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">kubernetes-node3</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-node3</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18</span> <span class="n">kubernetes-ha1</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-ha1</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19</span> <span class="n">kubernetes-ha2</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-ha2</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>  <span class="n">kubernetes-register</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">脚本执行实现跨主机免密码认证和hosts文件同步</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/01_remote_host_auth.sh</span>
<span class="n">批量设定远程主机免密码认证管理界面</span>
<span class="p">=====================================================</span>
 <span class="n">1</span><span class="p">:</span> <span class="n">部署环境</span>   <span class="n">2</span><span class="p">:</span> <span class="n">免密认证</span>   <span class="n">3</span><span class="p">:</span> <span class="n">同步hosts</span>
 <span class="n">4</span><span class="p">:</span> <span class="n">设定主机名</span> <span class="n">5</span><span class="err">：</span><span class="n">退出操作</span>
<span class="p">=====================================================</span>
<span class="n">请输入有效的操作id</span><span class="p">:</span> <span class="n">1</span>
</code></pre></div>
<p>另外两台master主机的基本配置</p>
<div class="highlight"><pre><span></span><code><span class="n">kubernetes的内核参数调整</span>
<span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">02_kubernetes_kernel_conf</span><span class="p">.</span><span class="n">sh</span>

<span class="n">底层docker环境的部署</span>
<span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">03_kubernetes_docker_install</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">同步docker环境的基本配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in 13 14</span>
<span class="p">&gt;</span> <span class="k">do</span>
<span class="p">&gt;</span>   <span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">docker</span><span class="p">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">docker</span><span class="p">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span>
<span class="p">&gt;</span>   <span class="n">ssh</span> <span class="n">root</span><span class="nv">@10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="nv">$i</span> <span class="s2">&quot;systemctl restart docker&quot;</span>
<span class="p">&gt;</span> <span class="n">done</span>
<span class="n">daemon</span><span class="p">.</span><span class="n">json</span>                    <span class="n">100</span><span class="p">%</span>  <span class="n">299</span>    <span class="n">86</span><span class="p">.</span><span class="n">3KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
<span class="n">daemon</span><span class="p">.</span><span class="n">json</span>                    <span class="n">100</span><span class="p">%</span>  <span class="n">299</span>    <span class="n">86</span><span class="p">.</span><span class="n">3KB</span><span class="p">/</span><span class="n">s</span>   <span class="n">00</span><span class="p">:</span><span class="n">00</span>
</code></pre></div>
<p><strong>环境解读</strong></p>
<p>环境组成</p>
<div class="highlight"><pre><span></span><code>    <span class="n">多主分布式集群的效果是在单主分布式的基础上</span><span class="err">，</span><span class="n">将master主机扩充到3台</span><span class="err">，</span><span class="n">作为一个主角色集群来存在</span><span class="err">，</span><span class="n">这个时候我们需要考虑数据的接入和输出</span><span class="err">。</span>
    <span class="n">数据接入</span><span class="err">：</span>
        <span class="n">三台master主机需要一个专属的控制平面来统一处理数据来源</span>
            <span class="p">-</span> <span class="n">在k8s中</span><span class="err">，</span><span class="n">这入口一般是以port方式存在</span>
    <span class="n">数据流出</span><span class="err">：</span>
        <span class="n">在kubernetes集群中</span><span class="err">，</span><span class="n">所有的数据都是以etcd的方式来单独存储的</span><span class="err">，</span><span class="n">所以这里无序过度干预</span><span class="err">。</span>
</code></pre></div>
<p>高可用梳理</p>
<div class="highlight"><pre><span></span><code>    <span class="n">为了保证所有数据都能够访问master主机</span><span class="err">，</span><span class="n">同时避免单台master出现异常</span><span class="err">，</span><span class="n">我们一般会通过高可用的方式将流量转交个后端</span><span class="err">，</span><span class="n">这里采用常见的</span> <span class="n">keepalived</span> <span class="n">和</span> <span class="n">haproxy的方式来实现</span><span class="err">。</span>
</code></pre></div>
<p><img alt="1627541947686" src="../../../img/kubernetes/kubernetes_flannel/1627541947686.png" /></p>
<p>其他功能</p>
<div class="highlight"><pre><span></span><code>    <span class="n">一般来说</span><span class="err">，</span><span class="n">对于大型集群来说</span><span class="err">，</span><span class="n">其内部的时间同步</span><span class="err">、</span><span class="n">域名解析</span><span class="err">、</span><span class="n">配置管理</span><span class="err">、</span><span class="n">持续交付等功能</span><span class="err">，</span><span class="n">都需要单独的主机来进行实现</span><span class="err">。</span><span class="n">由于我们这里主要来演示核心的多主集群环境</span><span class="err">，</span><span class="n">所以其他的功能</span><span class="err">，</span><span class="n">大家可以自由的向当前环境中补充</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="122">1.2.2 高可用环境实践<a class="headerlink" href="#122" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 高可用、高负载、高可用升级、小结 四个方面来学习。</p>
<p><strong>高可用</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">所谓的高可用</span><span class="err">，</span><span class="n">将核心业务使用多台</span><span class="p">(</span><span class="n">一般是2台</span><span class="p">)</span><span class="n">主机共同工作</span><span class="err">，</span><span class="n">支撑并保障核心业务的正常运行</span><span class="err">，</span><span class="n">尤其是业务的对外不间断的对外提供服务</span><span class="err">。</span><span class="n">核心特点就是</span><span class="s2">&quot;冗余&quot;</span><span class="err">，</span><span class="n">它存在的目的就是为了解决单点故障</span><span class="p">(</span><span class="n">Single</span> <span class="n">Point</span> <span class="n">of</span> <span class="n">Failure</span><span class="p">)</span><span class="n">问题的</span><span class="err">。</span>
    <span class="n">高可用集群是基于高扩展基础上的一个更高层次的网站稳定性解决方案</span><span class="err">。</span><span class="n">网站的稳定性体现在两个方面</span><span class="err">：</span><span class="n">网站可用性和恢复能力</span>
</code></pre></div>
<p>keepalived简介</p>
<p><img alt="1627542432899" src="../../../img/kubernetes/kubernetes_flannel/1627542432899.png" /></p>
<p>软件安装</p>
<div class="highlight"><pre><span></span><code><span class="n">我们在</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18和10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机上部署keepalived软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># yum install keepalived -y</span>

<span class="n">查看配置文件模板</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># rpm -ql keepalived | grep sample</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="n">keepalived</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">5</span><span class="p">/</span><span class="n">samples</span>
</code></pre></div>
<p>软件配置</p>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机配置高可用从节点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># cp /etc/keepalived/keepalived.conf{,.bak}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># cat /etc/keepalived/keepalived.conf</span>
<span class="n">global_defs</span> <span class="p">{</span>
   <span class="n">router_id</span> <span class="n">kubernetes_ha2</span>
<span class="p">}</span>

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">BACKUP</span>   <span class="c"># 当前节点为高可用从角色</span>
    <span class="n">interface</span> <span class="n">eth0</span>
    <span class="n">virtual_router_id</span> <span class="n">51</span>
    <span class="n">priority</span> <span class="n">90</span>
    <span class="n">advert_int</span> <span class="n">1</span>   <span class="c"># 主备通讯时间间隔</span>
    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="n">1111</span>
    <span class="p">}</span>
    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">label</span> <span class="n">eth0</span><span class="p">:</span><span class="n">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">重启服务后查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl restart keepalived.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">24</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">0e</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">高可用功能已经开启了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18主机配置高可用主节点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cp /etc/keepalived/keepalived.conf{,.bak}</span>
<span class="n">从10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机拉取配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># scp root@10.0.0.19:/etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf </span>

<span class="n">修改配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cat /etc/keepalived/keepalived.conf</span>
<span class="n">global_defs</span> <span class="p">{</span>
   <span class="n">router_id</span> <span class="n">kubernetes_ha1</span>
<span class="p">}</span>

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">MASTER</span>   <span class="c"># 当前节点为高可用主角色</span>
    <span class="n">interface</span> <span class="n">eth0</span>
    <span class="n">virtual_router_id</span> <span class="n">51</span>
    <span class="n">priority</span> <span class="n">100</span>
    <span class="n">advert_int</span> <span class="n">1</span>
    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="n">1111</span>
    <span class="p">}</span>
    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">label</span> <span class="n">eth0</span><span class="p">:</span><span class="n">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">启动服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl start keepalived.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">24</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">0e</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">高可用的主节点把从节点的ip地址给夺过来了</span><span class="err">，</span><span class="n">实现了节点的漂移</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">主角色关闭服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl stop keepalived.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>

<span class="n">从节点查看vip效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">24</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">0e</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>

<span class="n">主角色把vip抢过来</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl start keepalived.service</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">在演示实验环境的时候</span><span class="err">，</span><span class="n">如果你的主机资源不足</span><span class="err">，</span><span class="n">可以只开一台keepalived</span>
</code></pre></div>
<p><strong>高负载</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">所谓的高负载集群</span><span class="err">，</span><span class="n">指的是在当前业务环境集群中</span><span class="err">，</span><span class="n">所有的主机节点都处于正常的工作活动状态</span><span class="err">，</span><span class="n">它们共同承担起用户的请求带来的工作负载压力</span><span class="err">，</span><span class="n">保证用户的正常访问</span><span class="err">。</span><span class="n">支持高可用的软件很多</span><span class="err">，</span><span class="n">比如nginx</span><span class="err">、</span><span class="n">lvs</span><span class="err">、</span><span class="n">haproxy</span><span class="err">、</span><span class="n">等</span><span class="err">，</span><span class="n">我们这里用的是haproxy</span><span class="err">。</span>
    <span class="n">HAProxy是法国开发者</span> <span class="n">威利塔罗</span><span class="p">(</span><span class="n">Willy</span> <span class="n">Tarreau</span><span class="p">)</span> <span class="n">在2000年使用C语言开发的一个开源软件</span><span class="err">，</span><span class="n">是一款具备高并发</span><span class="p">(</span><span class="n">一万以上</span><span class="p">)</span><span class="err">、</span><span class="n">高性能的TCP和HTTP负载均衡器</span><span class="err">，</span><span class="n">支持基于cookie的持久性</span><span class="err">，</span><span class="n">自动故障切换</span><span class="err">，</span><span class="n">支持正则表达式及web状态统计</span><span class="err">、</span><span class="n">它也支持基于数据库的反向代理</span><span class="err">。</span>
</code></pre></div>
<p>软件安装</p>
<div class="highlight"><pre><span></span><code><span class="n">我们在</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18和10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机上部署haproxy软件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># yum install haproxy -y</span>
</code></pre></div>
<p>软件配置</p>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18主机配置高负载</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cp /etc/haproxy/haproxy.cfg{,.bak}</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cat /etc/haproxy/haproxy.cfg</span>
<span class="p">...</span>
<span class="n">listen</span> <span class="n">status</span>
        <span class="n">bind</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">9999</span>
        <span class="n">mode</span> <span class="n">http</span>
        <span class="n">log</span> <span class="n">global</span>
        <span class="n">stats</span> <span class="n">enable</span>
        <span class="n">stats</span> <span class="n">uri</span> <span class="p">/</span><span class="n">haproxy-status</span>
        <span class="n">stats</span> <span class="n">auth</span> <span class="n">superopsmsb</span><span class="p">:</span><span class="n">123456</span>

<span class="n">listen</span> <span class="n">kubernetes-api</span><span class="p">-</span><span class="n">6443</span>
        <span class="n">bind</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span>
        <span class="n">mode</span> <span class="n">tcp</span>
        <span class="n">server</span> <span class="n">kubernetes-master1</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">6443</span> <span class="n">check</span> <span class="n">inter</span> <span class="n">3s</span> <span class="n">fall</span> <span class="n">3</span> <span class="n">rise</span> <span class="n">5</span>
        <span class="n">server</span> <span class="n">kubernetes-master2</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6443</span> <span class="n">check</span> <span class="n">inter</span> <span class="n">3s</span> <span class="n">fall</span> <span class="n">3</span> <span class="n">rise</span> <span class="n">5</span>
        <span class="n">server</span> <span class="n">kubernetes-master3</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6443</span> <span class="n">check</span> <span class="n">inter</span> <span class="n">3s</span> <span class="n">fall</span> <span class="n">3</span> <span class="n">rise</span> <span class="n">5</span>

<span class="n">重启服务后查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl start haproxy.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># netstat -tnulp | head -n4</span>
<span class="n">Active</span> <span class="n">Internet</span> <span class="n">connections</span> <span class="p">(</span><span class="n">only</span> <span class="n">servers</span><span class="p">)</span>
<span class="n">Proto</span> <span class="n">Recv-Q</span> <span class="nb">Send-Q</span> <span class="n">Local</span> <span class="n">Address</span>    <span class="n">Foreign</span> <span class="n">Address</span>   <span class="n">State</span>       <span class="n">PID</span><span class="p">/</span><span class="n">Program</span> <span class="n">name</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span>  <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">2790</span><span class="p">/</span><span class="n">haproxy</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">9999</span>  <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">2790</span><span class="p">/</span><span class="n">haproxy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">浏览器查看haproxy的页面效果</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">9999</span><span class="p">/</span><span class="n">haproxy-status</span><span class="p">,</span><span class="n">输入用户名和密码后效果如下</span>
</code></pre></div>
<p><img alt="image-20220716075320996" src="../../../img/kubernetes/kubernetes_flannel/image-20220716075320996.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机配置高可用主节点</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># cp /etc/haproxy/haproxy.cfg{,.bak}</span>
<span class="n">把10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18主机配置传递到10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># scp /etc/haproxy/haproxy.cfg root@10.0.0.19:/etc/haproxy/haproxy.cfg</span>

<span class="n">默认情况下</span><span class="err">，</span><span class="n">没有vip的节点是无法启动haproxy的</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl start haproxy</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl status haproxy.service</span>
<span class="err">●</span> <span class="n">haproxy</span><span class="p">.</span><span class="n">service</span> <span class="p">-</span> <span class="n">HAProxy</span> <span class="n">Load</span> <span class="n">Balancer</span>
   <span class="n">Loaded</span><span class="p">:</span> <span class="n">loaded</span> <span class="p">(/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">service</span><span class="p">;</span> <span class="n">disabled</span><span class="p">;</span> <span class="n">vendor</span> <span class="n">preset</span><span class="p">:</span> <span class="n">disabled</span><span class="p">)</span>
   <span class="n">Active</span><span class="p">:</span> <span class="n">failed</span> <span class="p">(</span><span class="n">Result</span><span class="p">:</span> <span class="nb">exit-code</span><span class="p">)</span>
   <span class="p">...</span>

<span class="n">通过修改内核的方式</span><span class="err">，</span><span class="n">让haproxy绑定一个不存在的ip地址从而启动成功</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># sysctl -a | grep nonlocal</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_nonlocal_bind</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv6</span><span class="p">.</span><span class="n">ip_nonlocal_bind</span> <span class="p">=</span> <span class="n">0</span>

<span class="n">开启nonlocal的内核参数</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># echo &#39;net.ipv4.ip_nonlocal_bind = 1&#39; &gt;&gt; /etc/sysctl.conf</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># sysctl -p</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_nonlocal_bind</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这一步最好在ha1上也做一下</span>

<span class="n">再次启动haproxy服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl start haproxy</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl status haproxy | grep Active</span>
   <span class="n">Active</span><span class="p">:</span> <span class="n">active</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span> <span class="n">since</span> <span class="n">六</span> <span class="n">2062</span><span class="p">-</span><span class="n">07</span><span class="p">-</span><span class="n">16</span> <span class="n">08</span><span class="p">:</span><span class="n">05</span><span class="p">:</span><span class="n">00</span> <span class="n">CST</span><span class="p">;</span> <span class="n">14s</span> <span class="n">ago</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># netstat -tnulp | head -n4</span>
<span class="n">Active</span> <span class="n">Internet</span> <span class="n">connections</span> <span class="p">(</span><span class="n">only</span> <span class="n">servers</span><span class="p">)</span>
<span class="n">Proto</span> <span class="n">Recv-Q</span> <span class="nb">Send-Q</span> <span class="n">Local</span> <span class="n">Address</span>    <span class="n">Foreign</span> <span class="n">Address</span>   <span class="n">State</span>       <span class="n">PID</span><span class="p">/</span><span class="n">Program</span> <span class="n">name</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span>  <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">3062</span><span class="p">/</span><span class="n">haproxy</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">9999</span>  <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">3062</span><span class="p">/</span><span class="n">haproxy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">主角色关闭服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl stop keepalived.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>

<span class="n">从节点查看vip效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">24</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">0e</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
</code></pre></div>
<p><strong>高可用升级</strong></p>
<p>问题</p>
<div class="highlight"><pre><span></span><code>    <span class="n">目前我们实现了高可用的环境</span><span class="err">，</span><span class="n">无论keepalived是否在哪台主机存活</span><span class="err">，</span><span class="n">都有haproxy能够提供服务</span><span class="err">，</span><span class="n">但是在后续处理的时候</span><span class="err">，</span><span class="n">会出现一种问题</span><span class="err">，</span><span class="n">haproxy一旦故障</span><span class="err">，</span><span class="n">而keepalived没有同时关闭的话</span><span class="err">，</span><span class="n">会导致服务无法访问</span><span class="err">。</span><span class="n">效果如下</span>
</code></pre></div>
<p><img alt="image-20220716081105875" src="../../../img/kubernetes/kubernetes_flannel/image-20220716081105875.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">所以我们有必要对keeaplived进行升级</span><span class="err">，</span><span class="n">需要借助于其内部的脚本探测机制实现对后端haproxy进行探测</span><span class="err">，</span><span class="n">如果后端haproxy异常就直接把当前的keepalived服务关闭</span><span class="err">。</span>
</code></pre></div>
<p>制作keepalived的脚本文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># cat /etc/keepalived/check_haproxy.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 功能: keepalived检测后端haproxy的状态</span>
<span class="c"># 版本: v0.1</span>
<span class="c"># 作者: 书记</span>
<span class="c"># 联系: superopsmsb.com</span>

<span class="c"># 检测后端haproxy的状态</span>
<span class="n">haproxy_status</span><span class="p">=$(</span><span class="nb">ps </span><span class="n">-C</span> <span class="n">haproxy</span> <span class="p">-</span><span class="n">-no-header</span> <span class="p">|</span> <span class="n">wc</span> <span class="n">-l</span><span class="p">)</span>
<span class="c"># 如果后端没有haproxy服务，则尝试启动一次haproxy</span>
<span class="k">if</span> <span class="p">[</span> <span class="nv">$haproxy_status</span> <span class="o">-eq</span> <span class="n">0</span> <span class="p">];</span><span class="n">then</span>
        <span class="n">systemctl</span> <span class="nb">start </span><span class="n">haproxy</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">null</span> <span class="n">2</span><span class="p">&gt;&amp;</span><span class="n">1</span>
        <span class="nb">sleep </span><span class="n">3</span>
        <span class="c"># 如果重启haproxy还不成功的话，则关闭keepalived服务</span>
        <span class="k">if</span> <span class="p">[</span> <span class="p">$(</span><span class="nb">ps </span><span class="n">-C</span> <span class="n">haproxy</span> <span class="p">-</span><span class="n">-no-header</span> <span class="p">|</span> <span class="n">wc</span> <span class="n">-l</span><span class="p">)</span> <span class="o">-eq</span> <span class="n">0</span> <span class="p">]</span>
        <span class="n">then</span>
           <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">keepalived</span>
        <span class="n">fi</span>
<span class="n">fi</span>

<span class="n">脚本赋予执行权限</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># chmod +x /etc/keepalived/check_haproxy.sh</span>
</code></pre></div>
<p>改造keepalived的配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">查看10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18主机的高可用配置修改</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cat /etc/keepalived/keepalived.conf</span>
<span class="n">global_defs</span> <span class="p">{</span>
   <span class="n">router_id</span> <span class="n">kubernetes_ha1</span>
<span class="p">}</span>
<span class="c"># 定制keepalive检测后端haproxy服务</span>
<span class="n">vrrp_script</span> <span class="n">chk_haproxy</span> <span class="p">{</span>
  <span class="n">script</span> <span class="s2">&quot;/bin/bash /etc/keepalived/check_haproxy.sh&quot;</span>
  <span class="n">interval</span> <span class="n">2</span>
  <span class="n">weight</span> <span class="p">-</span><span class="n">20</span>   <span class="c"># 每次检测失败都降低权重值</span>
<span class="p">}</span>
<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">MASTER</span>
    <span class="n">interface</span> <span class="n">eth0</span>
    <span class="n">virtual_router_id</span> <span class="n">51</span>
    <span class="n">priority</span> <span class="n">100</span>
    <span class="n">advert_int</span> <span class="n">1</span>
    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="n">1111</span>
    <span class="p">}</span>
    <span class="c"># 应用内部的检测机制</span>
    <span class="n">track_script</span> <span class="p">{</span>
        <span class="n">chk_haproxy</span>
    <span class="p">}</span>
    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">label</span> <span class="n">eth0</span><span class="p">:</span><span class="n">1</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">keepalived所有配置后面不允许有任何空格</span><span class="err">，</span><span class="n">否则启动有可能出现异常</span>

<span class="n">重启keepalived服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl restart keepalived</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">传递检测脚本给10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># scp /etc/keepalived/check_haproxy.sh root@10.0.0.19:/etc/keepalived/check_haproxy.sh</span>

<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机</span><span class="err">，</span><span class="n">也将这两部分修改配置添加上</span><span class="err">，</span><span class="n">并重启keepalived服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl restart keepalived</span>
</code></pre></div>
<p>服务检测</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前vip效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">因为haproxy内置的强制保证服务启动机制</span><span class="err">，</span><span class="n">无法通过stop的方式关闭</span><span class="err">，</span><span class="n">通过移除配置文件方式强制关闭haproxy</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># mv /etc/haproxy/haproxy.cfg ./</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl stop haproxy.service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl status haproxy.service | grep Active</span>
   <span class="n">Active</span><span class="p">:</span> <span class="n">failed</span> <span class="p">(</span><span class="n">Result</span><span class="p">:</span> <span class="nb">exit-code</span><span class="p">)</span>

<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18主机检查vip效果</span>   
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>

<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机检测vip效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">24</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">0e</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">到此为止</span><span class="err">，</span><span class="n">我们所有的高可用环境都梳理完毕了</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="123">1.2.3 集群初始化实践<a class="headerlink" href="#123" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 配置解读、文件实践、小结 三个方面来学习。</p>
<p><strong>配置解读</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于kubernetes来说</span><span class="err">，</span><span class="n">它提供了高度定制配置的方式来设定集群环境</span><span class="err">，</span><span class="n">为了方便后续集群的升级等操作</span><span class="err">，</span><span class="n">我们这里安装</span> <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8版本</span><span class="err">。</span>
</code></pre></div>
<p>环境准备</p>
<div class="highlight"><pre><span></span><code><span class="n">所有kubernetes主机节点上都安装1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8版本的软件</span><span class="err">：</span>
    <span class="n">yum</span> <span class="n">remove</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span> <span class="n">-y</span>
    <span class="n">yum</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span><span class="p">-</span><span class="n">0</span> <span class="n">kubectl</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span><span class="p">-</span><span class="n">0</span> <span class="n">kubelet</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span><span class="p">-</span><span class="n">0</span> <span class="n">-y</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">执行脚本获取制定版本的kubernetes依赖的docker镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># /bin/bash /data/scripts/04_kubernetes_get_images.sh</span>
<span class="n">请输入要获取kubernetes镜像的版本</span><span class="p">(</span><span class="n">示例</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">9</span><span class="p">):</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="p">...</span>

<span class="n">提交镜像到远程仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># for i in $(docker images | grep -v TAG | awk &#39;{print $1&quot;:&quot;$2}&#39;);do docker push $i;done</span>
</code></pre></div>
<p>配置文件解读</p>
<div class="highlight"><pre><span></span><code><span class="n">kubernetes的集群初始化两种方式</span><span class="err">：</span>
    <span class="n">方法1</span><span class="err">：</span><span class="n">命令方式灵活</span><span class="err">，</span><span class="n">但是后期配置不可追溯</span>
    <span class="n">方法2</span><span class="err">：</span><span class="n">文件方式繁琐</span><span class="err">，</span><span class="n">但是所有配置都可以控制</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看集群初始化时候的默认配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm config print init-defaults</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta3</span>   <span class="c"># 不同版本的api版本不一样</span>
<span class="c"># 认证授权相关的基本信息</span>
<span class="n">bootstrapTokens</span><span class="p">:</span>
<span class="p">-</span> <span class="n">groups</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">system</span><span class="p">:</span><span class="n">bootstrappers</span><span class="p">:</span><span class="n">kubeadm</span><span class="p">:</span><span class="k">default</span><span class="n">-node-token</span>
  <span class="n">token</span><span class="p">:</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span>
  <span class="n">ttl</span><span class="p">:</span> <span class="n">24h0m0s</span>
  <span class="n">usages</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">signing</span>
  <span class="p">-</span> <span class="n">authentication</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">InitConfiguration</span>
<span class="c"># 第一个master节点配置的入口</span>
<span class="n">localAPIEndpoint</span><span class="p">:</span>
  <span class="n">advertiseAddress</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">4</span>
  <span class="n">bindPort</span><span class="p">:</span> <span class="n">6443</span>
<span class="c"># node节点注册到master集群的通信方式</span>
<span class="n">nodeRegistration</span><span class="p">:</span>
  <span class="n">criSocket</span><span class="p">:</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">dockershim</span><span class="p">.</span><span class="n">sock</span>
  <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">node</span>
  <span class="n">taints</span><span class="p">:</span> <span class="n">null</span>
<span class="p">---</span>
<span class="c"># 基本的集群属性信息</span>
<span class="n">apiServer</span><span class="p">:</span>
  <span class="n">timeoutForControlPlane</span><span class="p">:</span> <span class="n">4m0s</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta3</span>
<span class="n">certificatesDir</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">pki</span>
<span class="n">clusterName</span><span class="p">:</span> <span class="n">kubernetes</span>
<span class="n">controllerManager</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">dns</span><span class="p">:</span> <span class="p">{}</span>
<span class="c"># kubernetes的数据管理方式</span>
<span class="n">etcd</span><span class="p">:</span>
  <span class="n">local</span><span class="p">:</span>
    <span class="n">dataDir</span><span class="p">:</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span>
<span class="c"># 镜像仓库的配置</span>
<span class="n">imageRepository</span><span class="p">:</span> <span class="n">k8s</span><span class="p">.</span><span class="n">gcr</span><span class="p">.</span><span class="n">io</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterConfiguration</span>
<span class="c"># kubernetes版本的定制</span>
<span class="n">kubernetesVersion</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="c"># kubernetes的网络基本信息</span>
<span class="n">networking</span><span class="p">:</span>
  <span class="n">dnsDomain</span><span class="p">:</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
  <span class="n">serviceSubnet</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span>
<span class="n">scheduler</span><span class="p">:</span> <span class="p">{}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改配置文件</span><span class="err">，</span><span class="n">让其支持新master的内容</span>
    <span class="n">bootstrapTokens</span><span class="p">.</span><span class="n">groups</span><span class="p">.</span><span class="n">ttl</span> <span class="n">修改为48h或者更大</span>
    <span class="n">localAPIEndpoint</span><span class="p">.</span><span class="n">advertiseAddress</span> <span class="n">修改为当前主机的真实ip地址</span>
    <span class="n">controlPlanelEndpoint</span> <span class="n">如果涉及到haproxy的方式</span><span class="err">，</span><span class="n">需要额外添加基于VIP的Endpoint地址</span>
        <span class="n">注意</span><span class="err">：</span><span class="n">该项一般是在</span> <span class="n">dns</span><span class="p">{}</span> <span class="n">的上一行</span>
    <span class="n">imageRepository</span> <span class="n">修改为我们能够访问到镜像的仓库地址</span>
    <span class="n">kubernetesVersion</span> <span class="n">修改为当前的</span> <span class="n">k8s</span> <span class="n">的版本信息</span>
    <span class="n">networking</span><span class="p">.</span><span class="n">serviceSubnet</span> <span class="n">改为自己的规划中的service地址信息</span><span class="err">，</span><span class="n">最好是大一点的私网地址段</span>
</code></pre></div>
<p>配置文件变动</p>
<div class="highlight"><pre><span></span><code><span class="n">创建专属目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># mkdir -p /data/kubernetes/cluster_init</span>

<span class="n">在集群初始化节点上生成通信认证的配置信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm config print init-defaults &gt; /data/kubernetes/cluster_init/kubeadm-init-1-23-8.yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># cat /data/kubernetes/cluster_init/kubeadm-init-1-23-8.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta3</span>
<span class="n">bootstrapTokens</span><span class="p">:</span>
<span class="p">-</span> <span class="n">groups</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">system</span><span class="p">:</span><span class="n">bootstrappers</span><span class="p">:</span><span class="n">kubeadm</span><span class="p">:</span><span class="k">default</span><span class="n">-node-token</span>
  <span class="n">token</span><span class="p">:</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span>
  <span class="n">ttl</span><span class="p">:</span> <span class="n">48h0m0s</span>
  <span class="n">usages</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">signing</span>
  <span class="p">-</span> <span class="n">authentication</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">InitConfiguration</span>
<span class="n">localAPIEndpoint</span><span class="p">:</span>
  <span class="n">advertiseAddress</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>
  <span class="n">bindPort</span><span class="p">:</span> <span class="n">6443</span>
<span class="n">nodeRegistration</span><span class="p">:</span>
  <span class="n">criSocket</span><span class="p">:</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">dockershim</span><span class="p">.</span><span class="n">sock</span>
  <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">kubernetes-master1</span>
  <span class="n">taints</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">effect</span><span class="p">:</span> <span class="n">NoSchedule</span>
      <span class="n">key</span><span class="p">:</span> <span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span>
<span class="p">---</span>
<span class="n">apiServer</span><span class="p">:</span>
  <span class="n">timeoutForControlPlane</span><span class="p">:</span> <span class="n">4m0s</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1beta3</span>
<span class="n">certificatesDir</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">pki</span>
<span class="n">clusterName</span><span class="p">:</span> <span class="n">kubernetes</span>
<span class="n">controllerManager</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">controlPlaneEndpoint</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span>
<span class="n">dns</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">etcd</span><span class="p">:</span>
  <span class="n">local</span><span class="p">:</span>
    <span class="n">dataDir</span><span class="p">:</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span>
<span class="n">imageRepository</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterConfiguration</span>
<span class="n">kubernetesVersion</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">networking</span><span class="p">:</span>
  <span class="n">dnsDomain</span><span class="p">:</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
  <span class="n">serviceSubnet</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">12</span>
  <span class="n">podSubnet</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
<span class="n">scheduler</span><span class="p">:</span> <span class="p">{}</span>
</code></pre></div>
<p><strong>文件实践</strong></p>
<p>环境初始化</p>
<div class="highlight"><pre><span></span><code><span class="n">初始化集群环境</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm init --config /data/kubernetes/cluster_init/kubeadm-init-1-23-8.yml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubeadm init --config /data/kubernetes/cluster_init/kubeadm-init-1-23-8.yml</span>
<span class="no">[init]</span> <span class="n">Using</span> <span class="n">Kubernetes</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="no">[preflight]</span> <span class="n">Running</span> <span class="n">pre-flight</span> <span class="n">checks</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Docker</span><span class="p">]:</span> <span class="n">docker</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable docker.service&#39;</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Kubelet</span><span class="p">]:</span> <span class="n">kubelet</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable kubelet.service&#39;</span>
<span class="no">[preflight]</span> <span class="n">Pulling</span> <span class="n">images</span> <span class="n">required</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">a</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>
<span class="no">[preflight]</span> <span class="n">This</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">or</span> <span class="n">two</span><span class="p">,</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">the</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">your</span> <span class="n">internet</span> <span class="n">connection</span>
<span class="no">[preflight]</span> <span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">action</span> <span class="k">in</span> <span class="n">beforehand</span> <span class="n">using</span> <span class="s1">&#39;kubeadm config images pull&#39;</span>
<span class="no">[certs]</span> <span class="n">Using</span> <span class="n">certificateDir</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/pki&quot;</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">apiserver</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes</span> <span class="n">kubernetes-master1</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-kubelet-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/server&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">etcd</span><span class="p">/</span><span class="n">server</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes-master1</span> <span class="n">localhost</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">::</span><span class="n">1</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/peer&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">etcd</span><span class="p">/</span><span class="n">peer</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes-master1</span> <span class="n">localhost</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">::</span><span class="n">1</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/healthcheck-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-etcd-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;sa&quot;</span> <span class="n">key</span> <span class="n">and</span> <span class="n">public</span> <span class="n">key</span>
<span class="no">[kubeconfig]</span> <span class="n">Using</span> <span class="n">kubeconfig</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes&quot;</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;admin.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;kubelet.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;controller-manager.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;scheduler.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">environment</span> <span class="n">file</span> <span class="n">with</span> <span class="n">flags</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">the</span> <span class="n">kubelet</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Using</span> <span class="n">manifest</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-apiserver&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-controller-manager&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-scheduler&quot;</span>
<span class="no">[etcd]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="n">local</span> <span class="n">etcd</span> <span class="k">in</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="nb">wait-control</span><span class="n">-plane</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">boot</span> <span class="n">up</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">as</span> <span class="n">static</span> <span class="n">Pods</span> <span class="n">from</span> <span class="n">directory</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span><span class="p">.</span> <span class="n">This</span> <span class="n">can</span> <span class="n">take</span> <span class="n">up</span> <span class="n">to</span> <span class="n">4m0s</span>
<span class="no">[apiclient]</span> <span class="n">All</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">components</span> <span class="n">are</span> <span class="n">healthy</span> <span class="n">after</span> <span class="n">15</span><span class="p">.</span><span class="n">554614</span> <span class="n">seconds</span>
<span class="p">[</span><span class="n">upload-config</span><span class="p">]</span> <span class="n">Storing</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">used</span> <span class="k">in</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubeadm-config&quot;</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
<span class="no">[kubelet]</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubelet-config-1.23&quot;</span> <span class="k">in</span> <span class="n">namespace</span> <span class="n">kube-system</span> <span class="n">with</span> <span class="n">the</span> <span class="n">configuration</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelets</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">NOTE</span><span class="p">:</span> <span class="n">The</span> <span class="s2">&quot;kubelet-config-1.23&quot;</span> <span class="n">naming</span> <span class="n">of</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">ConfigMap</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">.</span> <span class="n">Once</span> <span class="n">the</span> <span class="n">UnversionedKubeletConfigMap</span> <span class="n">feature</span> <span class="n">gate</span> <span class="n">graduates</span> <span class="n">to</span> <span class="n">Beta</span> <span class="n">the</span> <span class="k">default</span> <span class="n">name</span> <span class="n">will</span> <span class="n">become</span> <span class="n">just</span> <span class="s2">&quot;kubelet-config&quot;</span><span class="p">.</span> <span class="n">Kubeadm</span> <span class="n">upgrade</span> <span class="n">will</span> <span class="n">handle</span> <span class="n">this</span> <span class="n">transition</span> <span class="n">transparently</span><span class="p">.</span>
<span class="p">[</span><span class="n">upload-certs</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">phase</span><span class="p">.</span> <span class="n">Please</span> <span class="n">see</span> <span class="p">-</span><span class="n">-upload-certs</span>
<span class="p">[</span><span class="n">mark-control-plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubernetes-master1</span> <span class="n">as</span> <span class="n">control-plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">labels</span><span class="p">:</span> <span class="p">[</span><span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">(</span><span class="n">deprecated</span><span class="p">)</span> <span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">control-plane</span> <span class="n">node</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">exclude-from-external-load-balancers</span><span class="p">]</span>
<span class="p">[</span><span class="n">mark-control-plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubernetes-master1</span> <span class="n">as</span> <span class="n">control-plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">taints</span> <span class="p">[</span><span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">:</span><span class="n">NoSchedule</span><span class="p">]</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Using</span> <span class="n">token</span><span class="p">:</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Configuring</span> <span class="n">bootstrap</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">cluster-info</span> <span class="n">ConfigMap</span><span class="p">,</span> <span class="n">RBAC</span> <span class="n">Roles</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">get</span> <span class="n">nodes</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">post</span> <span class="n">CSRs</span> <span class="k">in</span> <span class="n">order</span> <span class="k">for</span> <span class="n">nodes</span> <span class="n">to</span> <span class="n">get</span> <span class="n">long</span> <span class="n">term</span> <span class="n">certificate</span> <span class="n">credentials</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">the</span> <span class="n">csrapprover</span> <span class="n">controller</span> <span class="n">automatically</span> <span class="n">approve</span> <span class="n">CSRs</span> <span class="n">from</span> <span class="n">a</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">Token</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">certificate</span> <span class="n">rotation</span> <span class="k">for</span> <span class="n">all</span> <span class="n">node</span> <span class="n">client</span> <span class="n">certificates</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">the</span> <span class="s2">&quot;cluster-info&quot;</span> <span class="n">ConfigMap</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-public&quot;</span> <span class="n">namespace</span>
<span class="p">[</span><span class="n">kubelet-finalize</span><span class="p">]</span> <span class="n">Updating</span> <span class="s2">&quot;/etc/kubernetes/kubelet.conf&quot;</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="n">a</span> <span class="n">rotatable</span> <span class="n">kubelet</span> <span class="n">client</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[addons]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">CoreDNS</span>
<span class="no">[addons]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">kube-proxy</span>

<span class="n">Your</span> <span class="n">Kubernetes</span> <span class="n">control-plane</span> <span class="n">has</span> <span class="n">initialized</span> <span class="n">successfully</span><span class="p">!</span>

<span class="n">To</span> <span class="nb">start </span><span class="n">using</span> <span class="n">your</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">as</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">user</span><span class="p">:</span>

  <span class="n">mkdir</span> <span class="n">-p</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span>
  <span class="n">sudo</span> <span class="nb">cp </span><span class="n">-i</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
  <span class="n">sudo</span> <span class="n">chown</span> <span class="p">$(</span><span class="n">id</span> <span class="n">-u</span><span class="p">):$(</span><span class="n">id</span> <span class="n">-g</span><span class="p">)</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>

<span class="n">Alternatively</span><span class="p">,</span> <span class="k">if</span> <span class="n">you</span> <span class="n">are</span> <span class="n">the</span> <span class="n">root</span> <span class="n">user</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">run</span><span class="p">:</span>

  <span class="n">export</span> <span class="n">KUBECONFIG</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span>

<span class="n">You</span> <span class="n">should</span> <span class="n">now</span> <span class="n">deploy</span> <span class="n">a</span> <span class="n">pod</span> <span class="n">network</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
<span class="n">Run</span> <span class="s2">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="n">with</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">options</span> <span class="n">listed</span> <span class="n">at</span><span class="p">:</span>
  <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">concepts</span><span class="p">/</span><span class="n">cluster-administration</span><span class="p">/</span><span class="n">addons</span><span class="p">/</span>

<span class="c"># 这里多了一个主角色节点加入集群的步骤</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">now</span> <span class="n">join</span> <span class="n">any</span> <span class="n">number</span> <span class="n">of</span> <span class="n">control-plane</span> <span class="n">nodes</span> <span class="n">by</span> <span class="n">copying</span> <span class="n">certificate</span> <span class="n">authorities</span>
<span class="n">and</span> <span class="n">service</span> <span class="n">account</span> <span class="n">keys</span> <span class="n">on</span> <span class="n">each</span> <span class="n">node</span> <span class="n">and</span> <span class="n">then</span> <span class="n">running</span> <span class="n">the</span> <span class="n">following</span> <span class="n">as</span> <span class="n">root</span><span class="p">:</span>

  <span class="n">kubeadm</span> <span class="n">join</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-token</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span> <span class="p">\</span>
        <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">bfaed502274988b5615006e91337db9252707f2dd033e9d32670175bf8445d67</span> <span class="p">\</span>
        <span class="p">-</span><span class="n">-control-plane</span>

<span class="n">Then</span> <span class="n">you</span> <span class="n">can</span> <span class="n">join</span> <span class="n">any</span> <span class="n">number</span> <span class="n">of</span> <span class="n">worker</span> <span class="n">nodes</span> <span class="n">by</span> <span class="n">running</span> <span class="n">the</span> <span class="n">following</span> <span class="n">on</span> <span class="n">each</span> <span class="n">as</span> <span class="n">root</span><span class="p">:</span>

<span class="n">kubeadm</span> <span class="n">join</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-token</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span> <span class="p">\</span>
        <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">bfaed502274988b5615006e91337db9252707f2dd033e9d32670175bf8445d67</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">设定主角色主机的权限文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir -p $HOME/.kube</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</code></pre></div>
<p>master节点的集群加入</p>
<div class="highlight"><pre><span></span><code><span class="n">获取master集群节点添加到控制平面的基本认证信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubeadm init phase upload-certs --upload-certs</span>
<span class="n">I0716</span> <span class="n">10</span><span class="p">:</span><span class="n">13</span><span class="p">:</span><span class="n">59</span><span class="p">.</span><span class="n">447562</span>  <span class="n">119631</span> <span class="n">version</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">255</span><span class="p">]</span> <span class="n">remote</span> <span class="n">version</span> <span class="n">is</span> <span class="n">much</span> <span class="n">newer</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">3</span><span class="p">;</span> <span class="n">falling</span> <span class="n">back</span> <span class="n">to</span><span class="p">:</span> <span class="n">stable</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span>
<span class="p">[</span><span class="n">upload-certs</span><span class="p">]</span> <span class="n">Storing</span> <span class="n">the</span> <span class="n">certificates</span> <span class="k">in</span> <span class="n">Secret</span> <span class="s2">&quot;kubeadm-certs&quot;</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
<span class="p">[</span><span class="n">upload-certs</span><span class="p">]</span> <span class="n">Using</span> <span class="n">certificate</span> <span class="n">key</span><span class="p">:</span>
<span class="n">120fe6a5baad0ec32da4ae185728f5273e415aeb28e36de3b92ad4e1ecd7d69a</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">构造master节点添加到控制平面的命令</span><span class="err">，</span><span class="n">在剩余的maste2和master3上执行</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master2</span> <span class="p">~]</span><span class="c"># kubeadm join 10.0.0.200:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:bfaed502274988b5615006e91337db9252707f2dd033e9d32670175bf8445d67 --control-plane --certificate-key 120fe6a5baad0ec32da4ae185728f5273e415aeb28e36de3b92ad4e1ecd7d69a</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有master节点执行命令完毕后查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master3</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                 <span class="n">STATUS</span>     <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master1</span>   <span class="n">Ready</span>      <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">16m</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-master2</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">2m13s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-master3</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">68s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="124">1.2.4 工作节点实践<a class="headerlink" href="#124" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 节点实践、dashboard实践、小结 三个方面来学习。</p>
<p><strong>节点实践</strong></p>
<p>将三个工作节点添加到kubernetes集群中</p>
<div class="highlight"><pre><span></span><code><span class="n">三个节点执行的命令一致</span>
<span class="n">kubeadm</span> <span class="n">join</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-token</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span>  <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">bfaed502274988b5615006e91337db9252707f2dd033e9d32670175bf8445d67</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">节点执行命令完毕后</span><span class="err">，</span><span class="n">回到任意一台master上查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master3</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>                 <span class="n">STATUS</span>     <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master1</span>   <span class="n">Ready</span>      <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">16m</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-master2</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">2m13s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-master3</span>   <span class="n">NotReady</span>   <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">68s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-node1</span>     <span class="n">Ready</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">44s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-node2</span>     <span class="n">Ready</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">25s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-node3</span>     <span class="n">Ready</span>      <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">35s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">有的节点状态是Ready</span><span class="err">，</span><span class="n">有的不是</span><span class="err">，</span><span class="n">原因是我们的flannel环境还没有定制</span>
</code></pre></div>
<p>定制网络环境</p>
<div class="highlight"><pre><span></span><code><span class="n">master1节点上执行网络配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl apply -f /data/kubernetes/flannel/kube-flannel.yml</span>
<span class="n">namespace</span><span class="p">/</span><span class="n">kube-flannel</span> <span class="n">created</span>
<span class="n">clusterrole</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">serviceaccount</span><span class="p">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">configmap</span><span class="p">/</span><span class="n">kube-flannel-cfg</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">kube-flannel-ds</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">再次查看节点效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  get nodes</span>
<span class="n">NAME</span>                 <span class="n">STATUS</span>   <span class="n">ROLES</span>                  <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">kubernetes-master1</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">18m</span>     <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-master2</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">3m48s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-master3</span>   <span class="n">Ready</span>    <span class="n">control-plane</span><span class="p">,</span><span class="n">master</span>   <span class="n">2m43s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-node1</span>     <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">2m19s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-node2</span>     <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">2m</span>      <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="n">kubernetes-node3</span>     <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>                 <span class="n">2m10s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
</code></pre></div>
<p><strong>dashboard实践</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">目前来说</span><span class="err">，</span><span class="n">kubernetes的dashboard插件版本没有通用的</span><span class="err">，</span><span class="n">只能找到适合当前kubernetes版本的软件</span><span class="err">。</span><span class="n">另外</span><span class="err">，</span><span class="n">默认的dashboard有可能会受到各种因素的限制</span><span class="err">，</span><span class="n">我们还是希望去安装专门的kubernetes的可视化界面软件</span><span class="err">。</span>

<span class="n">参考资料</span><span class="p">:</span> <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">concepts</span><span class="p">/</span><span class="n">cluster-administration</span><span class="p">/</span><span class="n">addons</span><span class="p">/</span>
</code></pre></div>
<p><img alt="image-20220716103544284" src="../../../img/kubernetes/kubernetes_flannel/image-20220716103544284.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">在这里</span><span class="err">，</span><span class="n">我们选择v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1版本</span><span class="err">，</span><span class="n">这个版本对于1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">x版本支持没有太大的问题</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/kubernetes/dashboard -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cd /data/kubernetes/dashboard/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># mv recommended.yaml dashboard-2.5.1.yaml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># cp dashboard-2.5.1.yaml{，.bak}</span>
</code></pre></div>
<p>修改配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">添加相关配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># vim dashboard-2.5.1.yaml</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="p">...</span> 
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">443</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">8443</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">30443</span>     <span class="c"># 增加此行</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>          <span class="c"># 增加此行</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">k8s-app</span><span class="p">:</span> <span class="n">kubernetes-dashboard</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制依赖镜像</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">$(</span><span class="n">grep</span> <span class="s1">&#39;image:&#39;</span> <span class="n">dashboard</span><span class="p">-</span><span class="n">2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">yaml</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">-v</span> <span class="s1">&#39;#&#39;</span> <span class="p">|</span> <span class="n">awk</span> <span class="o">-F</span> <span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
<span class="k">do</span>
    <span class="n">docker</span> <span class="n">pull</span> <span class="n">kubernetesui</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">tag</span> <span class="n">kubernetesui</span><span class="p">/</span><span class="nv">$i</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">push</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">rmi</span> <span class="n">kubernetesui</span><span class="p">/</span><span class="nv">$i</span>
<span class="n">done</span>

<span class="n">确认镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># docker images | egrep  &#39;dashboard|scr&#39; | awk &#39;{print $1,$2}&#39;</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">dashboard</span> <span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">metrics-scraper</span> <span class="n">v1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">7</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># sed -i &#39;/ image:/s/kubernetesui/kubernetes-register.superopsmsb.com\/google_containers/&#39; dashboard-2.5.1.yaml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># sed -n &#39;/ image:/p&#39; dashboard-2.5.1.yaml</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">dashboard</span><span class="p">:</span><span class="n">v2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">metrics-scraper</span><span class="p">:</span><span class="n">v1</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">7</span>
</code></pre></div>
<p>应用配置文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">dashboard</span><span class="p">]</span><span class="c"># kubectl  apply -f dashboard-2.5.1.yaml</span>
<span class="n">namespace</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">serviceaccount</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">secret</span><span class="p">/</span><span class="n">kubernetes-dashboard-certs</span> <span class="n">created</span>
<span class="n">secret</span><span class="p">/</span><span class="n">kubernetes-dashboard-csrf</span> <span class="n">created</span>
<span class="n">secret</span><span class="p">/</span><span class="n">kubernetes-dashboard-key-holder</span> <span class="n">created</span>
<span class="n">configmap</span><span class="p">/</span><span class="n">kubernetes-dashboard-settings</span> <span class="n">created</span>
<span class="n">role</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">clusterrole</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">rolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">kubernetes-dashboard</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">dashboard-metrics-scraper</span> <span class="n">created</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">dashboard-metrics-scraper</span> <span class="n">created</span>

<span class="n">查看环境的准备效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get all -n kubernetes-dashboard</span>
</code></pre></div>
<p><img alt="image-20220716105728014" src="../../../img/kubernetes/kubernetes_flannel/image-20220716105728014.png" /></p>
<p>浏览器访问效果</p>
<p><img alt="image-20220716105728014" src="../../../img/kubernetes/kubernetes_flannel/image-20220716105844575.png" /></p>
<p>dashboard界面登录</p>
<div class="highlight"><pre><span></span><code><span class="n">由于涉及到后续我们还没有整理的资料</span><span class="err">，</span><span class="n">所以大家执行执行一条命令即可</span><span class="err">，</span><span class="n">之余涉及到具体知识点</span><span class="err">，</span><span class="n">我们后续再说</span><span class="err">。</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">serviceaccount</span>  <span class="n">dashboard-admin</span> <span class="n">-n</span> <span class="n">kube-system</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span>  <span class="n">dashboard-admin</span> <span class="p">-</span><span class="n">-clusterrole</span><span class="p">=</span><span class="n">cluster-admin</span> <span class="p">-</span><span class="n">-serviceaccount</span><span class="p">=</span><span class="n">kube-system</span><span class="p">:</span><span class="n">dashboard-admin</span>
<span class="n">kubernetes_user</span><span class="p">=$(</span><span class="n">kubectl</span> <span class="n">-n</span> <span class="n">kube-system</span> <span class="n">get</span> <span class="n">secret</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">dashboard-admin</span> <span class="p">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $1}&#39;</span><span class="p">)</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">secrets</span> <span class="n">-n</span> <span class="n">kube-system</span> <span class="p">${</span><span class="n">kubernetes_user</span><span class="p">}</span>
</code></pre></div>
<p><img alt="image-20220716110204077" src="../../../img/kubernetes/kubernetes_flannel/image-20220716110204077.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">拷贝token信息</span><span class="err">，</span><span class="n">然后粘贴到浏览器界面的输入框中</span><span class="err">，</span><span class="n">然后点击登录</span><span class="err">，</span><span class="n">查看效果</span>
</code></pre></div>
<p><img alt="image-20220716110306390" src="../../../img/kubernetes/kubernetes_flannel/image-20220716110306390.png" /></p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="125">1.2.5 集群初始化解读<a class="headerlink" href="#125" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 流程简介、流程解读、小结 三个方面来学习。</p>
<div class="highlight"><pre><span></span><code><span class="n">参考资料</span><span class="p">:</span> <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">reference</span><span class="p">/</span><span class="n">setup-tools</span><span class="p">/</span><span class="n">kubeadm</span><span class="p">/</span><span class="n">kubeadm-init</span><span class="p">/</span><span class="c">#init-workflow</span>
</code></pre></div>
<p><strong>流程简介</strong></p>
<p>参考资料</p>
<div class="highlight"><pre><span></span><code><span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">reference</span><span class="p">/</span><span class="n">setup-tools</span><span class="p">/</span><span class="n">kubeadm</span><span class="p">/</span><span class="n">kubeadm-init</span><span class="p">/</span><span class="c">#init-workflow</span>
</code></pre></div>
<p>流程简介</p>
<div class="highlight"><pre><span></span><code><span class="n">master节点启动</span><span class="err">：</span>
    <span class="n">当前环境检查</span><span class="err">，</span><span class="n">确保当前主机可以部署kubernetes</span>
    <span class="n">生成kubernetes对外提供服务所需要的各种私钥以及数字证书</span>
    <span class="n">生成kubernetes控制组件的kubeconfig文件</span>
    <span class="n">生成kubernetes控制组件的pod对象需要的manifest文件</span>
    <span class="n">为集群控制节点添加相关的标识</span><span class="err">，</span><span class="n">不让主节点参与node角色工作</span>
    <span class="n">生成集群的统一认证的token信息</span><span class="err">，</span><span class="n">方便其他节点加入到当前的集群</span>
    <span class="n">进行基于TLS的安全引导相关的配置</span><span class="err">、</span><span class="n">角色策略</span><span class="err">、</span><span class="n">签名请求</span><span class="err">、</span><span class="n">自动配置策略</span>
    <span class="n">为集群安装DNS和kube-porxy插件</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">node节点加入</span>
    <span class="n">当前环境检查</span><span class="err">，</span><span class="n">读取相关集群配置信息</span>
    <span class="n">获取集群相关数据后启动kubelet服务</span>
    <span class="n">获取认证信息后</span><span class="err">，</span><span class="n">基于证书方式进行通信</span>
</code></pre></div>
<p><strong>流程解读</strong></p>
<p>master节点初始化流程</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">当前环境检查</span><span class="err">，</span><span class="n">确保当前主机可以部署kubernetes</span>
<span class="no">[init]</span> <span class="n">Using</span> <span class="n">Kubernetes</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span>
<span class="no">[preflight]</span> <span class="n">Running</span> <span class="n">pre-flight</span> <span class="n">checks</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Docker</span><span class="p">]:</span> <span class="n">docker</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable docker.s             ervice&#39;</span>
        <span class="p">[</span><span class="n">WARNING</span> <span class="n">Service-Kubelet</span><span class="p">]:</span> <span class="n">kubelet</span> <span class="n">service</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">please</span> <span class="n">run</span> <span class="s1">&#39;systemctl enable kubele             t.service&#39;</span>
<span class="no">[preflight]</span> <span class="n">Pulling</span> <span class="n">images</span> <span class="n">required</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">a</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>
<span class="no">[preflight]</span> <span class="n">This</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">or</span> <span class="n">two</span><span class="p">,</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">the</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">your</span> <span class="n">internet</span> <span class="n">connection</span>
<span class="no">[preflight]</span> <span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">action</span> <span class="k">in</span> <span class="n">beforehand</span> <span class="n">using</span> <span class="s1">&#39;kubeadm config images pull&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">生成kubernetes对外提供服务所需要的各种私钥以及数字证书</span>
<span class="no">[certs]</span> <span class="n">Using</span> <span class="n">certificateDir</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/pki&quot;</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">apiserver</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes</span> <span class="n">kubernetes-master1</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span> <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-kubelet-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/ca&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/server&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">etcd</span><span class="p">/</span><span class="n">server</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes-master1</span> <span class="n">localhost</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">::</span><span class="n">1</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/peer&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">etcd</span><span class="p">/</span><span class="n">peer</span> <span class="n">serving</span> <span class="n">cert</span> <span class="n">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubernetes-master1</span> <span class="n">localhost</span><span class="p">]</span> <span class="n">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">::</span><span class="n">1</span><span class="p">]</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/healthcheck-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-etcd-client&quot;</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
<span class="no">[certs]</span> <span class="n">Generating</span> <span class="s2">&quot;sa&quot;</span> <span class="n">key</span> <span class="n">and</span> <span class="n">public</span> <span class="n">key</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span> <span class="n">生成kubernetes控制组件的kubeconfig文件及相关的启动配置文件</span>
<span class="no">[kubeconfig]</span> <span class="n">Using</span> <span class="n">kubeconfig</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes&quot;</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;admin.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;kubelet.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;controller-manager.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="no">[kubeconfig]</span> <span class="n">Writing</span> <span class="s2">&quot;scheduler.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">environment</span> <span class="n">file</span> <span class="n">with</span> <span class="n">flags</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">the</span> <span class="n">kubelet</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span> <span class="n">生成kubernetes控制组件的pod对象需要的manifest文件</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Using</span> <span class="n">manifest</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-apiserver&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-controller-manager&quot;</span>
<span class="p">[</span><span class="n">control-plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-scheduler&quot;</span>
<span class="no">[etcd]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="n">local</span> <span class="n">etcd</span> <span class="k">in</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="nb">wait-control</span><span class="n">-plane</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">boot</span> <span class="n">up</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">as</span> <span class="n">static</span> <span class="n">Pods</span> <span class="n">from</span> <span class="n">directory</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span><span class="p">.</span> <span class="n">This</span> <span class="n">can</span> <span class="n">take</span> <span class="n">up</span> <span class="n">to</span> <span class="n">4m0s</span>
<span class="no">[apiclient]</span> <span class="n">All</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">components</span> <span class="n">are</span> <span class="n">healthy</span> <span class="n">after</span> <span class="n">15</span><span class="p">.</span><span class="n">554614</span> <span class="n">seconds</span>
<span class="p">[</span><span class="n">upload-config</span><span class="p">]</span> <span class="n">Storing</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">used</span> <span class="k">in</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubeadm-config&quot;</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
<span class="no">[kubelet]</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubelet-config-1.23&quot;</span> <span class="k">in</span> <span class="n">namespace</span> <span class="n">kube-system</span> <span class="n">with</span> <span class="n">the</span> <span class="n">configuration</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelets</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">NOTE</span><span class="p">:</span> <span class="n">The</span> <span class="s2">&quot;kubelet-config-1.23&quot;</span> <span class="n">naming</span> <span class="n">of</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">ConfigMap</span> <span class="n">is</span> <span class="n">deprecated</span><span class="p">.</span> <span class="n">Once</span> <span class="n">the</span> <span class="n">UnversionedKubeletConfigMap</span> <span class="n">feature</span> <span class="n">gate</span> <span class="n">graduates</span> <span class="n">to</span> <span class="n">Beta</span> <span class="n">the</span> <span class="k">default</span> <span class="n">name</span> <span class="n">will</span> <span class="n">become</span> <span class="n">just</span> <span class="s2">&quot;kubelet-config&quot;</span><span class="p">.</span> <span class="n">Kubeadm</span> <span class="n">upgrade</span> <span class="n">will</span> <span class="n">handle</span> <span class="n">this</span> <span class="n">transition</span> <span class="n">transparently</span><span class="p">.</span>
<span class="p">[</span><span class="n">upload-certs</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">phase</span><span class="p">.</span> <span class="n">Please</span> <span class="n">see</span> <span class="p">-</span><span class="n">-upload-certs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">5</span> <span class="n">为集群控制节点添加相关的标识</span><span class="err">，</span><span class="n">不让主节点参与node角色工作</span>
<span class="p">[</span><span class="n">mark-control-plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubernetes-master1</span> <span class="n">as</span> <span class="n">control-plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">labels</span><span class="p">:</span> <span class="p">[</span><span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">(</span><span class="n">deprecated</span><span class="p">)</span> <span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">control-plane</span> <span class="n">node</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">exclude-from-external-load-balancers</span><span class="p">]</span>
<span class="p">[</span><span class="n">mark-control-plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubernetes-master1</span> <span class="n">as</span> <span class="n">control-plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">taints</span> <span class="p">[</span><span class="n">node-role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">master</span><span class="p">:</span><span class="n">NoSchedule</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">6</span> <span class="n">生成集群的统一认证的token信息</span><span class="err">，</span><span class="n">方便其他节点加入到当前的集群</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Using</span> <span class="n">token</span><span class="p">:</span> <span class="n">abcdef</span><span class="p">.</span><span class="n">0123456789abcdef</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Configuring</span> <span class="n">bootstrap</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">cluster-info</span> <span class="n">ConfigMap</span><span class="p">,</span> <span class="n">RBAC</span> <span class="n">Roles</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">get</span> <span class="n">nodes</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">post</span> <span class="n">CSRs</span> <span class="k">in</span> <span class="n">order</span> <span class="k">for</span> <span class="n">nodes</span> <span class="n">to</span> <span class="n">get</span> <span class="n">long</span> <span class="n">term</span> <span class="n">certificate</span> <span class="n">credentials</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">the</span> <span class="n">csrapprover</span> <span class="n">controller</span> <span class="n">automatically</span> <span class="n">approve</span> <span class="n">CSRs</span> <span class="n">from</span> <span class="n">a</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">Token</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">certificate</span> <span class="n">rotation</span> <span class="k">for</span> <span class="n">all</span> <span class="n">node</span> <span class="n">client</span> <span class="n">certificates</span> <span class="k">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="p">[</span><span class="n">bootstrap-token</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">the</span> <span class="s2">&quot;cluster-info&quot;</span> <span class="n">ConfigMap</span> <span class="k">in</span> <span class="n">the</span> <span class="s2">&quot;kube-public&quot;</span> <span class="n">namespace</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">7</span> <span class="n">进行基于TLS的安全引导相关的配置</span><span class="err">、</span><span class="n">角色策略</span><span class="err">、</span><span class="n">签名请求</span><span class="err">、</span><span class="n">自动配置策略</span>
<span class="p">[</span><span class="n">kubelet-finalize</span><span class="p">]</span> <span class="n">Updating</span> <span class="s2">&quot;/etc/kubernetes/kubelet.conf&quot;</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="n">a</span> <span class="n">rotatable</span> <span class="n">kubelet</span> <span class="n">client</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">8</span> <span class="n">为集群安装DNS和kube-porxy插件</span>
<span class="no">[addons]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">CoreDNS</span>
<span class="no">[addons]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">kube-proxy</span>
</code></pre></div>
<p>node节点初始化流程</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">当前环境检查</span><span class="err">，</span><span class="n">读取相关集群配置信息</span>
<span class="no">[preflight]</span> <span class="n">Running</span> <span class="n">pre-flight</span> <span class="n">checks</span>
<span class="no">[preflight]</span> <span class="n">Reading</span> <span class="n">configuration</span> <span class="n">from</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">...</span>
<span class="no">[preflight]</span> <span class="n">FYI</span><span class="p">:</span> <span class="n">You</span> <span class="n">can</span> <span class="n">look</span> <span class="n">at</span> <span class="n">this</span> <span class="n">config</span> <span class="n">file</span> <span class="n">with</span> <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">获取集群相关数据后启动kubelet服务</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">environment</span> <span class="n">file</span> <span class="n">with</span> <span class="n">flags</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">the</span> <span class="n">kubelet</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span> <span class="n">获取认证信息后</span><span class="err">，</span><span class="n">基于证书方式进行通信</span>
<span class="p">[</span><span class="n">kubelet-start</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">the</span> <span class="n">TLS</span> <span class="n">Bootstrap</span><span class="p">...</span>

<span class="n">This</span> <span class="n">node</span> <span class="n">has</span> <span class="n">joined</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">:</span>
<span class="p">*</span> <span class="n">Certificate</span> <span class="n">signing</span> <span class="n">request</span> <span class="n">was</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">apiserver</span> <span class="n">and</span> <span class="n">a</span> <span class="n">response</span> <span class="n">was</span> <span class="n">received</span><span class="p">.</span>
<span class="p">*</span> <span class="n">The</span> <span class="n">Kubelet</span> <span class="n">was</span> <span class="n">informed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">new</span> <span class="n">secure</span> <span class="n">connection</span> <span class="n">details</span><span class="p">.</span>

<span class="n">Run</span> <span class="s1">&#39;kubectl get nodes&#39;</span> <span class="n">on</span> <span class="n">the</span> <span class="n">control-plane</span> <span class="n">to</span> <span class="n">see</span> <span class="n">this</span> <span class="n">node</span> <span class="n">join</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="13">1.3 综合实践<a class="headerlink" href="#13" title="Permanent link">&para;</a></h2>
<h3 id="131">1.3.1 应用案例解读<a class="headerlink" href="#131" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 环境规划、实践解读、小结 三个方面来学习。</p>
<p><strong>环境规划</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">为了让大家对于kubernetes在生产中如何工作</span><span class="err">，</span><span class="n">我们这里从0创建容器环境</span><span class="err">，</span><span class="n">然后迁移到kubernetes环境上</span><span class="err">，</span><span class="n">因为还没有涉及到kubernetes本身的功能学习</span><span class="err">，</span><span class="n">所以涉及到部分的资源清单文件</span><span class="err">，</span><span class="n">我们会直接粘贴复制</span><span class="err">，</span><span class="n">后面的资源清单信息</span><span class="err">，</span><span class="n">我们会依次进行手工编写处理</span><span class="err">。</span>
</code></pre></div>
<p>环境规划</p>
<p><img alt="image-20220716135622610" src="../../../img/kubernetes/kubernetes_flannel/image-20220716135622610.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">这里定制一个nginx代理后端的一个简单应用</span><span class="err">，</span><span class="n">后面所有的知识点应用</span><span class="err">，</span><span class="n">基本上都是基于这个架构进行上下延伸的</span><span class="err">。</span>
</code></pre></div>
<p>访问分析</p>
<div class="highlight"><pre><span></span><code><span class="n">用户访问</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">201</span><span class="err">，</span>
    <span class="n">如果后面url关键字是</span> <span class="p">/,</span><span class="n">则将流量转交给</span> <span class="n">Nginx</span><span class="p">,</span><span class="n">应用返回</span> <span class="n">Hello</span> <span class="n">Nginx</span> <span class="n">容器名</span><span class="p">-</span><span class="n">版本号</span>
    <span class="n">如果后面url关键字是</span> <span class="p">/</span><span class="n">django</span><span class="p">/,</span><span class="n">则将流量转交给</span> <span class="n">Django</span><span class="p">,</span><span class="n">应用返回</span> <span class="n">Hello</span> <span class="n">Django</span> <span class="n">容器名</span><span class="p">-</span><span class="n">版本号</span>
    <span class="n">如果后面url关键字是</span> <span class="p">/</span><span class="n">tomcat</span><span class="p">/,</span><span class="n">则将流量转交给</span> <span class="n">Tomcat</span><span class="p">,</span><span class="n">应用返回</span> <span class="n">Hello</span> <span class="n">Tomcat</span> <span class="n">容器名</span><span class="p">-</span><span class="n">版本号</span>
</code></pre></div>
<p>基本思路</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">定制各个专用的Docker镜像文件</span>
<span class="n">2</span> <span class="n">定制kubernetes的专属资源清单文件</span>
<span class="n">3</span> <span class="n">调试kubernetes的资源清单文件</span>
<span class="n">4</span> <span class="n">开放外部高可用数据入口</span>
</code></pre></div>
<p><strong>实践解读</strong></p>
<p>获取基本镜像</p>
<div class="highlight"><pre><span></span><code><span class="n">获取依赖的基准镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># for i in nginx django tomcat</span>
<span class="k">do</span>
    <span class="n">docker</span> <span class="n">pull</span> <span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">tag</span> <span class="nv">$i</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">push</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="nv">$i</span>
    <span class="n">docker</span> <span class="n">rmi</span> <span class="nv">$i</span>
<span class="n">done</span>
<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker images | egrep &#39;nginx|djan|tom&#39; | awk &#39;{print $1,$2}&#39;</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span> <span class="n">latest</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">tomcat</span> <span class="n">latest</span>
<span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">django</span> <span class="n">latest</span>
</code></pre></div>
<p>nginx镜像基本环境</p>
<div class="highlight"><pre><span></span><code><span class="n">启动容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker run -d -P --name nginx-test kubernetes-register.superopsmsb.com/superopsmsb/nginx</span>
<span class="n">538acda8cef9d834915b0953fc353d24f922d592d72a26595c0c6604377c6ab9</span>

<span class="n">进入容器查看基本信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker exec -it nginx-test /bin/bash</span>
<span class="n">root</span><span class="nv">@538acda8cef9</span><span class="p">:/</span><span class="c"># env | egrep &#39;HOSTNAME|NGINX_VERSION&#39;</span>
<span class="n">HOSTNAME</span><span class="p">=</span><span class="n">538acda8cef9</span>
<span class="n">NGINX_VERSION</span><span class="p">=</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="n">root</span><span class="nv">@538acda8cef9</span><span class="p">:/</span><span class="c"># grep root /etc/nginx/conf.d/default.conf</span>
        <span class="n">root</span>   <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="p">;</span>
<span class="n">root</span><span class="nv">@fc943556ab2b</span><span class="p">:/</span><span class="c"># echo &quot;Hello Nginx, $HOSTNAME-$NGINX_VERSION&quot; &gt; /usr/share/nginx/html/index.html</span>
<span class="n">root</span><span class="nv">@fc943556ab2b</span><span class="p">:/</span><span class="c"># curl localhost</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">fc943556ab2b</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>

<span class="n">移除容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker rm -f nginx-test</span>
<span class="n">nginx-test</span>
</code></pre></div>
<p>django基本环境</p>
<div class="highlight"><pre><span></span><code><span class="n">准备外置目录</span><span class="err">，</span><span class="n">方便文件留存</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/code -p</span>

<span class="n">启动容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker run -it -p 8000:8000 -v /data/code:/data/code --name django-test kubernetes-register.superopsmsb.com/superopsmsb/django /bin/bash</span>
<span class="n">root</span><span class="nv">@9db574d98e95</span><span class="p">:/</span><span class="c"># cd /data/code/</span>

<span class="n">创建项目和应用</span>
<span class="n">root</span><span class="nv">@9db574d98e95</span><span class="p">:/</span><span class="n">data</span><span class="p">/</span><span class="n">code</span><span class="c"># django-admin startproject blog</span>
<span class="n">root</span><span class="nv">@9db574d98e95</span><span class="p">:/</span><span class="n">data</span><span class="p">/</span><span class="n">code</span><span class="c"># cd blog/</span>
<span class="n">root</span><span class="nv">@9db574d98e95</span><span class="p">:/</span><span class="n">data</span><span class="p">/</span><span class="n">code</span><span class="p">/</span><span class="n">blog</span><span class="c"># python manage.py startapp app1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">由于容器内部环境不足</span><span class="err">，</span><span class="n">我们在宿主机环境下编辑文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/code/blog/app1/views.py</span>
<span class="n">from</span> <span class="n">django</span><span class="p">.</span><span class="n">http</span> <span class="n">import</span> <span class="n">HttpResponse</span>
<span class="n">import</span> <span class="n">os</span>
<span class="n">def</span> <span class="n">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># 获取系统环境变量</span>
    <span class="n">hostname</span><span class="p">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HOSTNAME&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DJANGO_VERSION&quot;</span><span class="p">)</span>
    <span class="c"># 定制专属的信息输出</span>
    <span class="n">message</span><span class="p">=</span><span class="s2">&quot;{}, {}-{}\n&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Hello Django&quot;</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="n">定制应用的注册效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/code/blog/blog/settings.py</span>
<span class="p">...</span>
<span class="n">ALLOWED_HOSTS</span> <span class="p">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
<span class="p">...</span>
<span class="n">INSTALLED_APPS</span> <span class="p">=</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="s1">&#39;app1&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">定制数据流转效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/code/blog/blog/urls.py</span>
<span class="p">...</span>
<span class="n">from</span> <span class="n">app1</span><span class="p">.</span><span class="n">views</span> <span class="n">import</span> <span class="p">*</span>
<span class="n">urlpatterns</span> <span class="p">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="n">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="n">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">容器内部启动服务</span>
<span class="n">root</span><span class="nv">@9db574d98e95</span><span class="p">:/</span><span class="n">data</span><span class="p">/</span><span class="n">code</span><span class="p">/</span><span class="n">blog</span><span class="c"># python manage.py runserver 0.0.0.0:8000</span>
<span class="p">...</span>
<span class="n">Starting</span> <span class="n">development</span> <span class="n">server</span> <span class="n">at</span> <span class="n">http</span><span class="p">://</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8000</span><span class="p">/</span>
<span class="n">Quit</span> <span class="n">the</span> <span class="n">server</span> <span class="n">with</span> <span class="n">CONTROL-C</span><span class="p">.</span>

<span class="n">容器外部访问效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:8000</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">2894f12ebd0c</span> <span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>

<span class="n">移除容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker rm -f django-test</span>
<span class="n">django-test</span>
</code></pre></div>
<p>tomcat基本环境</p>
<div class="highlight"><pre><span></span><code><span class="n">启动容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker run -d -P --name tomcat-test kubernetes-register.superopsmsb.com/superopsmsb/tomcat</span>
<span class="n">8190d3afaa448142e573e826593258316e3480e38c575c864ec5c2708d132a33</span>

<span class="n">进入容器查看基本信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker exec -it tomcat-test /bin/bash</span>
<span class="n">root</span><span class="nv">@8190d3afaa44</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">tomcat</span><span class="c"># env | egrep &#39;HOSTNAME|TOMCAT_VERSION&#39;</span>
<span class="n">HOSTNAME</span><span class="p">=</span><span class="n">8190d3afaa44</span>
<span class="n">TOMCAT_VERSION</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
<span class="n">root</span><span class="nv">@8190d3afaa44</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">tomcat</span><span class="c"># mv webapps webapps-bak</span>
<span class="n">root</span><span class="nv">@8190d3afaa44</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">tomcat</span><span class="c"># mv webapps.dist webapps</span>
<span class="n">root</span><span class="nv">@8190d3afaa44</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">tomcat</span><span class="c"># echo &quot;Hello Tomcat, $HOSTNAME-$TOMCAT_VERSION&quot; &gt; webapps/ROOT/index.jsp</span>
<span class="n">root</span><span class="nv">@8190d3afaa44</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">tomcat</span><span class="c"># curl localhost:8080</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">8190d3afaa44</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>

<span class="n">移除容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker rm -f tomcat-test</span>
<span class="n">tomcat-test</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="132">1.3.2 应用环境定制<a class="headerlink" href="#132" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 Nginx构建、Django构建、Tomcat构建、小结 四个方面来学习。</p>
<p><strong>Nginx构建</strong></p>
<p>创建镜像构建文件</p>
<div class="highlight"><pre><span></span><code><span class="n">创建基准目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/images/web/{nginx,tomcat,django} -p</span>
</code></pre></div>
<p>定制Nginx镜像</p>
<p>创建准备文件</p>
<div class="highlight"><pre><span></span><code><span class="n">准备基准代码文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/images/web/nginx/scripts -p</span>

<span class="n">创建服务启动文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/web/nginx/scripts/startup.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 定制容器里面的nginx服务启动脚本</span>

<span class="c"># 定制tomcat的首页内容</span>
<span class="nb">echo </span><span class="s2">&quot;Hello Nginx, $HOSTNAME-$NGINX_VERSION&quot;</span> <span class="p">&gt;</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="p">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>

<span class="c"># 启动nginx</span>
<span class="n">nginx</span> <span class="n">-g</span> <span class="s2">&quot;daemon off;&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制Dockerfile文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/web/nginx/Dockerfile</span>
<span class="c"># 构建一个基于nginx的定制镜像</span>
<span class="c"># 基础镜像</span>
<span class="n">FROM</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span>
<span class="c"># 镜像作者</span>
<span class="n">MAINTAINER</span> <span class="n">shuji</span><span class="nv">@superopsmsb</span><span class="p">.</span><span class="n">com</span>

<span class="c"># 添加文件</span>
<span class="n">ADD</span> <span class="n">scripts</span><span class="p">/</span><span class="n">startup</span><span class="p">.</span><span class="n">sh</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">startup</span><span class="p">.</span><span class="n">sh</span>

<span class="c"># 执行命令</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;/data/scripts/startup.sh&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制构造镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker build -t kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1 /data/images/web/nginx/</span>

<span class="n">测试构造镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker run -d --name nginx-test -p 666:80 kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>
<span class="n">58b84726ff29b87e3c8e6a6489e4bead4d298bdd17ac08d90a05a8ad8674906e</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:666</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">58b84726ff29</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker rm -f nginx-test</span>
<span class="n">nginx-test</span>

<span class="n">提交镜像到远程仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker push kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>
</code></pre></div>
<p><strong>Django构建</strong></p>
<p>创建准备文件</p>
<div class="highlight"><pre><span></span><code><span class="n">准备基准代码文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mv /data/code/blog /data/images/web/django/</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/images/web/nginx/scripts -p</span>

<span class="n">创建服务启动文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/web/django/scripts/startup.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 定制容器里面的django服务启动脚本</span>

<span class="c"># 定制服务启动命令</span>
<span class="n">python</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">code</span><span class="p">/</span><span class="n">blog</span><span class="p">/</span><span class="n">manage</span><span class="p">.</span><span class="n">py</span> <span class="n">runserver</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">8000</span>
</code></pre></div>
<p>定制Dockerfile</p>
<div class="highlight"><pre><span></span><code><span class="n">定制Dockerfile文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/web/django/Dockerfile</span>
<span class="c"># 构建一个基于django的定制镜像</span>
<span class="c"># 基础镜像</span>
<span class="n">FROM</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">django</span>
<span class="c"># 镜像作者</span>
<span class="n">MAINTAINER</span> <span class="n">shuji</span><span class="nv">@superopsmsb</span><span class="p">.</span><span class="n">com</span>

<span class="c"># 拷贝文件</span>
<span class="n">ADD</span> <span class="n">blog</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">code</span><span class="p">/</span><span class="n">blog</span>
<span class="n">ADD</span> <span class="n">scripts</span><span class="p">/</span><span class="n">startup</span><span class="p">.</span><span class="n">sh</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">startup</span><span class="p">.</span><span class="n">sh</span>

<span class="c"># 暴露django端口</span>
<span class="n">EXPOSE</span> <span class="n">8000</span>

<span class="c"># 定制容器的启动命令</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;/data/scripts/startup.sh&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制构造镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker build -t kubernetes-register.superopsmsb.com/superopsmsb/django_web:v0.1 /data/images/web/django/</span>

<span class="n">测试构造镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker run -d --name django-test -p 666:8000 kubernetes-register.superopsmsb.com/superopsmsb/django_web:v0.1</span>
<span class="n">d8f6a1a237f9276917ffc6e233315d02940437f91c64f43894fb3fab8fd50783</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:666</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">d8f6a1a237f9</span> <span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker rm -f django-test</span>
<span class="n">nginx-test</span>

<span class="n">提交镜像到远程仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker push kubernetes-register.superopsmsb.com/superopsmsb/django_web:v0.1</span>
</code></pre></div>
<p><strong>Tomcat构建</strong></p>
<p>创建准备文件</p>
<div class="highlight"><pre><span></span><code><span class="n">准备基准代码文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/images/web/tomcat/scripts -p</span>

<span class="n">创建服务启动文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/web/tomcat/scripts/startup.sh</span>
<span class="c">#!/bin/bash</span>
<span class="c"># 定制容器里面的tomcat服务启动脚本</span>

<span class="c"># 定制tomcat的首页内容</span>
<span class="nb">echo </span><span class="s2">&quot;Hello Tomcat, $HOSTNAME-$TOMCAT_VERSION&quot;</span> <span class="p">&gt;</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">tomcat</span><span class="p">/</span><span class="n">webapps</span><span class="p">/</span><span class="n">ROOT</span><span class="p">/</span><span class="n">index</span><span class="p">.</span><span class="n">jsp</span>
<span class="c"># 启动tomcat</span>
<span class="n">catalina</span><span class="p">.</span><span class="n">sh</span> <span class="n">run</span>
</code></pre></div>
<p>定制Dockerfile</p>
<div class="highlight"><pre><span></span><code><span class="n">定制Dockerfile文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/web/tomcat/Dockerfile</span>
<span class="c"># 构建一个基于tomcat的定制镜像</span>
<span class="c"># 基础镜像</span>
<span class="n">FROM</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">tomcat</span>
<span class="c"># 镜像作者</span>
<span class="n">MAINTAINER</span> <span class="n">shuji</span><span class="nv">@superopsmsb</span><span class="p">.</span><span class="n">com</span>

<span class="c"># 拷贝文件</span>
<span class="n">RUN</span> <span class="nb">mv </span><span class="n">webapps</span><span class="p">.</span><span class="n">dist</span><span class="p">/*</span> <span class="n">webapps</span><span class="p">/</span>

<span class="c"># 添加文件</span>
<span class="n">ADD</span> <span class="n">scripts</span><span class="p">/</span><span class="n">startup</span><span class="p">.</span><span class="n">sh</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">scripts</span><span class="p">/</span><span class="n">startup</span><span class="p">.</span><span class="n">sh</span>

<span class="c"># 执行命令</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;/data/scripts/startup.sh&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制构造镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker build -t kubernetes-register.superopsmsb.com/superopsmsb/tomcat_web:v0.1 /data/images/web/tomcat/</span>

<span class="n">测试构造镜像</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker run -d --name tomcat-test -p 666:8080 kubernetes-register.superopsmsb.com/superopsmsb/tomcat_web:v0.1</span>
<span class="n">e46eb26c49ab873351219e98d6e236fd0445aa39edb8edb0bf86560a808614fb</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:666</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">e46eb26c49ab</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker rm -f tomcat-test</span>
<span class="n">tomcat-test</span>

<span class="n">提交镜像到远程仓库</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker push kubernetes-register.superopsmsb.com/superopsmsb/tomcat_web:v0.1</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="133">1.3.3 应用环境实践<a class="headerlink" href="#133" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 资源清单解读、应用环境实践、小结 三个方面来学习。</p>
<p><strong>资源清单解读</strong></p>
<p>创建基准配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">创建基准目录</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/kubernetes/cluster_test -p</span>
</code></pre></div>
<p>nginx入口资源清单</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/kubernetes/cluster_test/01_kubernetes-nginx-proxy.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-proxy</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-proxy</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">superopsmsb-nginx-proxy</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">30080</span>
</code></pre></div>
<p>nginx静态web资源清单</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/kubernetes/cluster_test/02_kubernetes-nginx-web.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-web</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx-web</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx-web</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx-web</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx_web</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">1</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-web</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx-web</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx-web</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">31080</span>
</code></pre></div>
<p>Django动态web资源清单</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/kubernetes/cluster_test/03_kubernetes-django-web.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-django-web</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">django</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">django</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">django</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">django</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">django_web</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">1</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">8000</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-django-web</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">django-web</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">django</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">8000</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">8000</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">31800</span>
</code></pre></div>
<p>Tomcat动态web资源清单</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/kubernetes/cluster_test/04_kubernetes-tomcat-web.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-tomcat-web</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">tomcat</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">tomcat</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">tomcat</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">django</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">tomcat_web</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">1</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">8080</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-tomcat-web</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">tomcat-web</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">tomcat</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">8080</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">8080</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">31880</span>
</code></pre></div>
<p><strong>应用环境实践</strong></p>
<p>创建环境应用</p>
<div class="highlight"><pre><span></span><code><span class="n">应用所有的资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  apply -f /data/kubernetes/cluster_test</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">superopsmsb-nginx-proxy</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-nginx-proxy</span> <span class="n">created</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">superopsmsb-nginx-web</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-nginx-web</span> <span class="n">created</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">superopsmsb-django-web</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-django-web</span> <span class="n">created</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">superopsmsb-tomcat-web</span> <span class="n">created</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-tomcat-web</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查资源对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  get svc,deployment,pod</span>
</code></pre></div>
<p><img alt="image-20220716142721779" src="../../../img/kubernetes/kubernetes_flannel/image-20220716142721779.png" /></p>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:31800</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">superopsmsb-django-web</span><span class="p">-</span><span class="n">5bbcb646df</span><span class="p">-</span><span class="n">44hcz</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:31080</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">00cfe7d5a6e8</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.12:31880</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">1734569458ff</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl -I -s 10.0.0.12:30080 | head -n2</span>
<span class="n">HTTP</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="134">1.3.4 应用环境升级<a class="headerlink" href="#134" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 需求定制、清单升级、小结 三个方面来学习。</p>
<p><strong>需求定制</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">需求解析</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">nginx需要实现反向代理的功能</span>
    <span class="n">2</span> <span class="n">nginx</span><span class="err">、</span><span class="n">tomcat和django的web应用不对外暴露端口</span>
</code></pre></div>
<p>命令简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">我们需要在nginx-proxy的pod中定制各个反向代理的基本配置</span><span class="err">，</span><span class="n">这就需要连接到pod内部进行基本的操作</span><span class="err">。</span><span class="n">我们可以借助于</span> <span class="n">exec命令来实现</span><span class="err">。</span>

<span class="n">命令格式</span><span class="err">：</span>
    <span class="n">kubectl</span> <span class="n">exec</span> <span class="n">-it</span> <span class="n">资源对象</span> <span class="p">--</span> <span class="n">容器命令</span>
</code></pre></div>
<p>进入到容器内容进行操作</p>
<div class="highlight"><pre><span></span><code><span class="n">进入nginx代理容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  exec -it superopsmsb-nginx-proxy-7dcd57d844-z89qr -- /bin/bash</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c">#</span>

<span class="n">安装基本测试环境命令</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># apt update</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># apt install vim net-tools iputils-ping dnsutils curl -y</span>

<span class="n">在pod内部可以看到所有的后端应用的service地址</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># env | grep &#39;_HOST&#39;</span>
<span class="n">SUPEROPSMSB_TOMCAT_WEB_SERVICE_HOST</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">111</span><span class="p">.</span><span class="n">147</span><span class="p">.</span><span class="n">205</span>
<span class="n">SUPEROPSMSB_NGINX_WEB_SERVICE_HOST</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">111</span><span class="p">.</span><span class="n">115</span><span class="p">.</span><span class="n">222</span>
<span class="n">KUBERNETES_SERVICE_HOST</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
<span class="n">SUPEROPSMSB_NGINX_PROXY_SERVICE_HOST</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">102</span><span class="p">.</span><span class="n">253</span><span class="p">.</span><span class="n">91</span>
<span class="n">SUPEROPSMSB_DJANGO_WEB_SERVICE_HOST</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">108</span><span class="p">.</span><span class="n">200</span><span class="p">.</span><span class="n">190</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubernetes内部提供了dns服务的能力</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># nslookup superopsmsb-django-web</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-django-web</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">108</span><span class="p">.</span><span class="n">200</span><span class="p">.</span><span class="n">190</span>

<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># nslookup superopsmsb-nginx-web</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-nginx-web</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">111</span><span class="p">.</span><span class="n">115</span><span class="p">.</span><span class="n">222</span>

<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># nslookup superopsmsb-tomcat-web</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-tomcat-web</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">111</span><span class="p">.</span><span class="n">147</span><span class="p">.</span><span class="n">205</span>

<span class="n">后端服务可以直接通过域名来访问</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># curl superopsmsb-django-web:8000</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">superopsmsb-django-web</span><span class="p">-</span><span class="n">5bbcb646df</span><span class="p">-</span><span class="n">44hcz</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># curl superopsmsb-tomcat-web:8080</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">1734569458ff</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-web</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">00cfe7d5a6e8</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<p>定制反向配置</p>
<div class="highlight"><pre><span></span><code><span class="n">定制nginx的代理配置文件</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># grep -Env &#39;#|^$&#39; /etc/nginx/conf.d/default.conf</span>
<span class="n">1</span><span class="p">:</span><span class="n">server</span> <span class="p">{</span>
<span class="n">2</span><span class="p">:</span>    <span class="n">listen</span>       <span class="n">80</span><span class="p">;</span>
<span class="n">3</span><span class="p">:</span>    <span class="n">listen</span>  <span class="p">[::]:</span><span class="n">80</span><span class="p">;</span>
<span class="n">4</span><span class="p">:</span>    <span class="n">server_name</span>  <span class="n">localhost</span><span class="p">;</span>
<span class="n">8</span><span class="p">:</span>    <span class="n">location</span> <span class="p">/</span> <span class="p">{</span>
<span class="n">9</span><span class="p">:</span>      <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">://</span><span class="n">superopsmsb-nginx-web</span><span class="p">/;</span>
<span class="n">10</span><span class="p">:</span>    <span class="p">}</span>
<span class="n">11</span><span class="p">:</span>    <span class="n">location</span> <span class="p">/</span><span class="n">django</span><span class="p">/</span> <span class="p">{</span>
<span class="n">12</span><span class="p">:</span>      <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">://</span><span class="n">superopsmsb-django-web</span><span class="p">:</span><span class="n">8000</span><span class="p">/;</span>
<span class="n">13</span><span class="p">:</span>    <span class="p">}</span>
<span class="n">14</span><span class="p">:</span>    <span class="n">location</span> <span class="p">/</span><span class="n">tomcat</span><span class="p">/</span> <span class="p">{</span>
<span class="n">15</span><span class="p">:</span>      <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">://</span><span class="n">superopsmsb-tomcat-web</span><span class="p">:</span><span class="n">8080</span><span class="p">/;</span>
<span class="n">16</span><span class="p">:</span>    <span class="p">}</span>
<span class="n">21</span><span class="p">:</span>    <span class="n">error_page</span>   <span class="n">500</span> <span class="n">502</span> <span class="n">503</span> <span class="n">504</span>  <span class="p">/</span><span class="n">50x</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>
<span class="n">22</span><span class="p">:</span>    <span class="n">location</span> <span class="p">=</span> <span class="p">/</span><span class="n">50x</span><span class="p">.</span><span class="n">html</span> <span class="p">{</span>
<span class="n">23</span><span class="p">:</span>        <span class="n">root</span>   <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="p">;</span>
<span class="n">24</span><span class="p">:</span>    <span class="p">}</span>
<span class="n">48</span><span class="p">:}</span>

<span class="n">检测配置文件</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># nginx -t</span>
<span class="n">nginx</span><span class="p">:</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">file</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span> <span class="n">syntax</span> <span class="n">is</span> <span class="n">ok</span>
<span class="n">nginx</span><span class="p">:</span> <span class="n">configuration</span> <span class="n">file</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span> <span class="n">test</span> <span class="n">is</span> <span class="n">successful</span>

<span class="n">重载配置文件</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># nginx -s reload</span>
<span class="n">2022</span><span class="p">/</span><span class="n">07</span><span class="p">/</span><span class="n">16</span> <span class="n">07</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">46</span> <span class="no">[notice]</span> <span class="n">634</span><span class="c">#634: signal process started</span>
</code></pre></div>
<p>外部主机测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">测试nginx代理的数据跳转效果</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-proxy</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">00cfe7d5a6e8</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-proxy/django/</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">superopsmsb-django-web</span><span class="p">-</span><span class="n">5bbcb646df</span><span class="p">-</span><span class="n">44hcz</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>
<span class="n">root</span><span class="nv">@superopsmsb</span><span class="n">-nginx-proxy</span><span class="p">-</span><span class="n">7dcd57d844-z89qr</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-proxy/tomcat/</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">1734569458ff</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
</code></pre></div>
<p><strong>清单升级</strong></p>
<p>镜像构造</p>
<div class="highlight"><pre><span></span><code><span class="n">定制nginx的配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/images/proxy/nginx/conf -p</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># vim /data/images/proxy/nginx/conf/default.conf</span>
<span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span>       <span class="n">80</span><span class="p">;</span>
    <span class="n">listen</span>  <span class="p">[::]:</span><span class="n">80</span><span class="p">;</span>
    <span class="n">server_name</span>  <span class="n">localhost</span><span class="p">;</span>
    <span class="n">location</span> <span class="p">/</span> <span class="p">{</span>
      <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">://</span><span class="n">superopsmsb-nginx-web</span><span class="p">/;</span>
    <span class="p">}</span>
    <span class="n">location</span> <span class="p">/</span><span class="n">django</span><span class="p">/</span> <span class="p">{</span>
      <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">://</span><span class="n">superopsmsb-django-web</span><span class="p">:</span><span class="n">8000</span><span class="p">/;</span>
    <span class="p">}</span>
    <span class="n">location</span> <span class="p">/</span><span class="n">tomcat</span><span class="p">/</span> <span class="p">{</span>
      <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">://</span><span class="n">superopsmsb-tomcat-web</span><span class="p">:</span><span class="n">8080</span><span class="p">/;</span>
    <span class="p">}</span>
    <span class="n">error_page</span>   <span class="n">500</span> <span class="n">502</span> <span class="n">503</span> <span class="n">504</span>  <span class="p">/</span><span class="n">50x</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>
    <span class="n">location</span> <span class="p">=</span> <span class="p">/</span><span class="n">50x</span><span class="p">.</span><span class="n">html</span> <span class="p">{</span>
        <span class="n">root</span>   <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">html</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制镜像的Dockerfile文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/images/proxy/nginx/Dockerfile</span>
<span class="c"># 构建一个基于nginx的定制镜像</span>
<span class="c"># 基础镜像</span>
<span class="n">FROM</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span>
<span class="c"># 镜像作者</span>
<span class="n">MAINTAINER</span> <span class="n">shuji</span><span class="nv">@superopsmsb</span><span class="p">.</span><span class="n">com</span>

<span class="c"># 增加相关文件</span>
<span class="n">ADD</span> <span class="n">conf</span><span class="p">/</span><span class="k">default</span><span class="p">.</span><span class="n">conf</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">nginx</span><span class="p">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="k">default</span><span class="p">.</span><span class="n">conf</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">镜像的构建</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker build -t kubernetes-register.superopsmsb.com/superopsmsb/nginx_proxy:v0.1 /data/images/proxy/nginx/</span>

<span class="n">镜像提交</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># docker push register.superopsmsb.com/superopsmsb/nginx_proxy:v0.1</span>
</code></pre></div>
<p>改造资源清单文件</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /data/kubernetes/cluster_test/01_kubernetes-nginx-proxy-update.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-proxy</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx_proxy</span><span class="p">:</span><span class="n">v0</span><span class="p">.</span><span class="n">1</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-proxy</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">superopsmsb-nginx-proxy</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">30080</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">应用资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cluster_test</span><span class="p">]</span><span class="c"># kubectl  delete -f 01_kubernetes-nginx-proxy.yml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cluster_test</span><span class="p">]</span><span class="c"># kubectl  apply -f 01_kubernetes-nginx-proxy-update.yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cluster_test</span><span class="p">]</span><span class="c"># curl 10.0.0.12:30080</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">00cfe7d5a6e8</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cluster_test</span><span class="p">]</span><span class="c"># curl 10.0.0.12:30080/django/</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">superopsmsb-django-web</span><span class="p">-</span><span class="n">5bbcb646df</span><span class="p">-</span><span class="n">44hcz</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">cluster_test</span><span class="p">]</span><span class="c"># curl 10.0.0.12:30080/tomcat/</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">1734569458ff</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
</code></pre></div>
<p><strong>高可用</strong></p>
<p>改造keepalived配置</p>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18主机修改配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cat /etc/keepalived/keepalived.conf</span>
<span class="p">...</span>
<span class="n">vrrp_instance</span> <span class="n">VI_2</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">BACKUP</span>
    <span class="n">interface</span> <span class="n">eth0</span>
    <span class="n">virtual_router_id</span> <span class="n">52</span>
    <span class="n">priority</span> <span class="n">100</span>
    <span class="n">advert_int</span> <span class="n">1</span>
    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="n">2222</span>
    <span class="p">}</span>
    <span class="n">track_script</span> <span class="p">{</span>
        <span class="n">chk_haproxy</span>
    <span class="p">}</span>
    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">201</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">label</span> <span class="n">eth0</span><span class="p">:</span><span class="n">2</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18重启服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl restart keepalived.service</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19主机修改配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># cat /etc/keepalived/keepalived.conf</span>
<span class="p">...</span>
<span class="n">vrrp_instance</span> <span class="n">VI_2</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">MASTER</span>
    <span class="n">interface</span> <span class="n">eth0</span>
    <span class="n">virtual_router_id</span> <span class="n">52</span>
    <span class="n">priority</span> <span class="n">100</span>
    <span class="n">advert_int</span> <span class="n">1</span>
    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="n">2222</span>
    <span class="p">}</span>
    <span class="n">track_script</span> <span class="p">{</span>
        <span class="n">chk_haproxy</span>
    <span class="p">}</span>
    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">201</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">label</span> <span class="n">eth0</span><span class="p">:</span><span class="n">2</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">19重启服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># systemctl restart keepalived.service</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># ifconfig eth0:1</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">2d</span><span class="p">:</span><span class="n">d9</span><span class="p">:</span><span class="n">0a</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha2</span> <span class="p">~]</span><span class="c"># ifconfig eth0:2</span>
<span class="n">eth0</span><span class="p">:</span><span class="n">2</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1500</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">201</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">ether</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">24</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">0e</span>  <span class="n">txqueuelen</span> <span class="n">1000</span>  <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
</code></pre></div>
<p>改造haproxy配置 - 两台主机的配置内容一样</p>
<div class="highlight"><pre><span></span><code><span class="n">以10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">18为例</span><span class="err">，</span><span class="n">修改配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># cat /etc/haproxy/haproxy.cfg</span>
<span class="p">...</span>
<span class="n">listen</span> <span class="n">kubernetes-nginx</span><span class="p">-</span><span class="n">30080</span>
        <span class="n">bind</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">201</span><span class="p">:</span><span class="n">80</span>
        <span class="n">mode</span> <span class="n">tcp</span>
        <span class="n">server</span> <span class="n">kubernetes-master1</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">30080</span> <span class="n">check</span> <span class="n">inter</span> <span class="n">3s</span> <span class="n">fall</span> <span class="n">3</span> <span class="n">rise</span> <span class="n">5</span>
        <span class="n">server</span> <span class="n">kubernetes-master2</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">30080</span> <span class="n">check</span> <span class="n">inter</span> <span class="n">3s</span> <span class="n">fall</span> <span class="n">3</span> <span class="n">rise</span> <span class="n">5</span>
        <span class="n">server</span> <span class="n">kubernetes-master3</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">30080</span> <span class="n">check</span> <span class="n">inter</span> <span class="n">3s</span> <span class="n">fall</span> <span class="n">3</span> <span class="n">rise</span> <span class="n">5</span>

<span class="n">重启haproxy服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># systemctl restart haproxy.service</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">haproxy检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-ha1</span> <span class="p">~]</span><span class="c"># netstat -tnulp</span>
<span class="n">Active</span> <span class="n">Internet</span> <span class="n">connections</span> <span class="p">(</span><span class="n">only</span> <span class="n">servers</span><span class="p">)</span>
<span class="n">Proto</span> <span class="n">Recv-Q</span> <span class="nb">Send-Q</span> <span class="n">Local</span> <span class="n">Address</span>   <span class="n">Foreign</span> <span class="n">Address</span>   <span class="n">State</span>       <span class="n">PID</span><span class="p">/</span><span class="n">Program</span> <span class="n">name</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">6443</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">71198</span><span class="p">/</span><span class="n">haproxy</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">200</span><span class="p">:</span><span class="n">9999</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">71198</span><span class="p">/</span><span class="n">haproxy</span>
<span class="n">tcp</span>        <span class="n">0</span>      <span class="n">0</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">201</span><span class="p">:</span><span class="n">80</span>   <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:*</span>         <span class="n">LISTEN</span>      <span class="n">71198</span><span class="p">/</span><span class="n">haproxy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">浏览器访问haproxy的状态页面效果</span>
</code></pre></div>
<p><img alt="image-20220716153757411" src="../../../img/kubernetes/kubernetes_flannel/image-20220716153757411.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">找一个客户端访问vip</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.201</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">superopsmsb-nginx-web</span><span class="p">-</span><span class="n">757bcb8fc9-lz6fh</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.201/tomcat/</span>
<span class="n">Hello</span> <span class="n">Tomcat</span><span class="p">,</span> <span class="n">superopsmsb-tomcat-web</span><span class="p">-</span><span class="n">66c86cb7bc-l2ml2</span><span class="p">-</span><span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">22</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># curl 10.0.0.201/django/</span>
<span class="n">Hello</span> <span class="n">Django</span><span class="p">,</span> <span class="n">superopsmsb-django-web</span><span class="p">-</span><span class="n">5bbcb646df-xm8jf</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">4</span>
</code></pre></div>
<h1 id="1_1">1 网络管理<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h1>
<h2 id="11service">1.1Service<a class="headerlink" href="#11service" title="Permanent link">&para;</a></h2>
<h3 id="111_1">1.1.1 网络体系<a class="headerlink" href="#111_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 应用流程、细节解读、小结 三个方面来学习。</p>
<p><strong>应用流程</strong></p>
<p>资源对象体系</p>
<p><img alt="image-20220715012035435" src="../../../img/kubernetes/kubernetes_flannel/image-20220715012035435.png" /></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">通过对Pod及其管理资源RC和Deployment的实践</span><span class="err">，</span><span class="n">我们知道</span><span class="err">，</span><span class="n">我们所有的应用服务都是工作在pod资源中</span><span class="err">，</span><span class="n">由于每个Pod都有独立的ip地址</span><span class="err">，</span><span class="n">而大量的动态创建和销毁操作后</span><span class="err">，</span><span class="n">虽然pod资源的数量是控制住了</span><span class="err">，</span><span class="n">但是由于pod重新启动</span><span class="err">，</span><span class="n">导致他的IP很有可能发生了变化</span><span class="err">，</span><span class="n">假设我们这里有前段应用的pod和后端应用的pod</span><span class="err">，</span><span class="n">那么再剧烈变动的场景中</span><span class="err">，</span><span class="n">两个应用该如何自由通信呢</span><span class="err">？</span><span class="n">难道是让我们以类似nginx负载均衡的方式手工定制pod</span> <span class="n">ip然后进行一一管理么</span><span class="err">？</span><span class="n">但是这是做不到的</span><span class="err">。</span> 

    <span class="n">Kubernetes集群就为我们提供了这样的一个对象</span><span class="p">-</span><span class="n">-Service</span><span class="err">，</span><span class="n">它定义了一组Pod的逻辑集合和一个用于访问它们的策略</span><span class="err">，</span><span class="n">它可以基于标签的方式自动找到对应的pod应用</span><span class="err">，</span><span class="n">而无需关心pod的ip地址变化与否</span><span class="err">，</span><span class="n">从而实现了类似负载均衡的效果</span><span class="p">.</span>
    <span class="n">这个资源在master端的Controller组件中</span><span class="err">，</span><span class="n">由Service</span> <span class="n">Controller</span> <span class="n">来进行统一管理</span><span class="err">。</span>
</code></pre></div>
<p>service</p>
<div class="highlight"><pre><span></span><code>    <span class="n">service是Kubernetes里最核心的资源对象之一</span><span class="err">，</span><span class="n">每一个Service都是一个完整的业务服务</span><span class="err">，</span><span class="n">我们之前学到的Pod</span><span class="err">、</span><span class="n">RC</span><span class="err">、</span><span class="n">Deployment等资源对象都是为Service服务的</span><span class="err">。</span><span class="n">他们之间的关系如下图</span><span class="err">：</span>
</code></pre></div>
<p><img alt="image-20210922135912555" src="../../../img/kubernetes/kubernetes_flannel/image-20210922135912555.png" /></p>
<p>解析</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Kubernetes</span> <span class="n">的</span> <span class="n">Service定义了一个服务的访问入口地址</span><span class="err">，</span><span class="n">前端的应用Pod通过Service访问其背后一组有Pod副本组成的集群示例</span><span class="err">，</span><span class="n">Service通过Label</span> <span class="n">Selector访问指定的后端Pod</span><span class="err">，</span><span class="n">RC保证Service的服务能力和服务质量处于预期状态</span><span class="err">。</span>

    <span class="n">Service是Kubernetes中最高一级的抽象资源对象</span><span class="err">，</span><span class="n">每个Service提供一个独立的服务</span><span class="err">，</span><span class="n">集群Service彼此间使用TCP</span><span class="p">/</span><span class="n">IP进行通信</span><span class="err">，</span><span class="n">将不同的服务组合在一起运行起来</span><span class="err">，</span><span class="n">就行了我们所谓的</span><span class="s2">&quot;系统&quot;</span><span class="err">，</span><span class="n">效果如下图</span>
</code></pre></div>
<p><img alt="image-20220721090648605" src="../../../img/kubernetes/kubernetes_flannel/image-20220721090648605.png" /></p>
<p><strong>细节解读</strong></p>
<p>Pod入口</p>
<div class="highlight"><pre><span></span><code>    <span class="n">我们知道每个Pod都有一个专用的IP地址</span><span class="err">，</span><span class="n">加上Pod内部容器的Port端口</span><span class="err">，</span><span class="n">就组成了一个访问Pod专用的EndPoint</span><span class="p">(</span><span class="n">Pod</span> <span class="n">IP</span><span class="p">+</span><span class="n">Container</span> <span class="n">Port</span><span class="p">)</span><span class="err">，</span><span class="n">从而实现了用户外部资源访问Pod内部应用的效果</span><span class="err">。</span><span class="n">这个EndPoint资源在master端的Controller组件中</span><span class="err">，</span><span class="n">由EndPoint</span> <span class="n">Controller</span> <span class="n">来进行统一管理</span><span class="err">。</span>
</code></pre></div>
<p>kube-proxy</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Pod是工作在不同的Node节点上</span><span class="err">，</span><span class="n">而Node节点上有一个kube-proxy组件</span><span class="err">，</span><span class="n">它本身就是一个软件负载均衡器</span><span class="err">，</span><span class="n">在内部有一套专有的负载均衡与会话保持机制</span><span class="err">，</span><span class="n">可以达到</span><span class="err">，</span><span class="n">接收到所有对Service请求</span><span class="err">，</span><span class="n">进而转发到后端的某个具体的Pod实例上</span><span class="err">，</span><span class="n">相应该请求</span><span class="err">。</span>
    <span class="p">--</span> <span class="n">kube-proxy</span> <span class="n">其实就是</span> <span class="n">Service</span> <span class="n">Controller位于各节点上的agent</span><span class="err">。</span>
</code></pre></div>
<p>service表现</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Kubernetes给Service分配一个全局唯一的虚拟ip地址</span><span class="p">-</span><span class="n">-cluster</span> <span class="n">IP</span><span class="err">，</span><span class="n">它不存在任何网络设备上</span><span class="err">，</span><span class="n">Service通过内容的标签选择器</span><span class="err">，</span><span class="n">指定相应该Service的Pod资源</span><span class="err">，</span><span class="n">这样以来</span><span class="err">，</span><span class="n">请求发给cluster</span> <span class="n">IP</span><span class="err">，</span><span class="n">后端的Pod资源收到请求后</span><span class="err">，</span><span class="n">就会响应请求</span><span class="err">。</span>

<span class="n">这种情况下</span><span class="err">，</span><span class="n">每个Service都有一个全局唯一通信地址</span><span class="err">，</span><span class="n">整个系统的内部服务间调用就变成了最基础的TCP</span><span class="p">/</span><span class="n">IP网络通信问题</span><span class="err">。</span><span class="n">如果我们的集群内部的服务想要和外部的网络进行通信</span><span class="err">，</span><span class="n">方法很多</span><span class="err">，</span><span class="n">比如</span><span class="err">：</span>
    <span class="n">NodePort类型</span><span class="err">，</span><span class="n">通过在所有结点上增加一个对外的端口</span><span class="err">，</span><span class="n">用于接入集群外部请求</span>
    <span class="n">ingress类型</span><span class="err">，</span><span class="n">通过集群附加服务功能</span><span class="err">，</span><span class="n">将外部的域名流量转交到集群内部</span><span class="err">。</span>
</code></pre></div>
<p>service vs endpoint</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">当创建</span> <span class="n">Service资源的时候</span><span class="err">，</span><span class="n">最重要的就是为Service指定能够提供服务的标签选择器</span><span class="err">，</span>
<span class="n">2</span> <span class="n">Service</span> <span class="n">Controller就会根据标签选择器创建一个同名的Endpoint资源对象</span><span class="err">。</span>
<span class="n">3</span> <span class="n">Endpoint</span> <span class="n">Controller开始介入</span><span class="err">，</span><span class="n">使用Endpoint的标签选择器</span><span class="p">(</span><span class="n">继承自Service标签选择器</span><span class="p">)</span><span class="err">，</span><span class="n">筛选符合条件的pod资源</span>
<span class="n">4</span> <span class="n">Endpoint</span> <span class="n">Controller</span> <span class="n">将符合要求的pod资源绑定到Endpoint上</span><span class="err">，</span><span class="n">并告知给Service资源</span><span class="err">，</span><span class="n">谁可以正常提供服务</span><span class="err">。</span>
<span class="n">5</span> <span class="n">Service</span> <span class="n">根据自身的cluster</span> <span class="n">IP向外提供由Endpoint提供的服务资源</span><span class="err">。</span>

<span class="p">--</span> <span class="n">所以Service</span> <span class="n">其实就是</span> <span class="n">为动态的一组pod资源对象</span> <span class="n">提供一个固定的访问入口</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="112_1">1.1.2 工作模型<a class="headerlink" href="#112_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 模型解读、类型解读、小结 三个方面来学习。</p>
<p><strong>模型解读</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Service对象</span><span class="err">，</span><span class="n">对于当前集群的节点来说</span><span class="err">，</span><span class="n">本质上就是工作节点的一些iptables或ipvs规则</span><span class="err">，</span><span class="n">这些规则由kube-proxy进行实时维护</span><span class="err">，</span><span class="n">站在kubernetes的发展脉络上来说</span><span class="err">，</span><span class="n">kube-proxy将请求代理至相应端点的方式有三种</span><span class="err">：</span><span class="n">userspace</span><span class="p">/</span><span class="n">iptables</span><span class="p">/</span><span class="n">ipvs</span><span class="err">。</span><span class="n">目前我们主要用的是</span> <span class="n">iptables</span><span class="p">/</span><span class="n">ipvs</span> <span class="n">两种</span><span class="err">。</span>
</code></pre></div>
<p>模式解析</p>
<p><img alt="image-20220721093742953" src="../../../img/kubernetes/kubernetes_flannel/image-20220721093742953.png" /></p>
<div class="highlight"><pre><span></span><code>    <span class="n">userspace模型是k8s</span><span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">)</span><span class="n">最早的一种工作模型</span><span class="err">，</span><span class="n">作用就是将service的策略转换成iptables规则</span><span class="err">，</span><span class="n">这些规则仅仅做请求的拦截</span><span class="err">，</span><span class="n">而不对请求进行调度处理</span><span class="err">。</span>
    <span class="n">该模型中</span><span class="err">，</span><span class="n">请求流量到达内核空间后</span><span class="err">，</span><span class="n">由套接字送往用户空间的kube-proxy</span><span class="err">，</span><span class="n">再由它送回内核空间</span><span class="err">，</span><span class="n">并调度至后端Pod</span><span class="err">。</span><span class="n">因为涉及到来回转发</span><span class="err">，</span><span class="n">效率不高</span><span class="err">，</span><span class="n">另外用户空间的转发</span><span class="err">，</span><span class="n">默认开启了会话粘滞</span><span class="err">，</span><span class="n">会导致流量转发给无效的pod上</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">iptables模式是k8s</span><span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">-</span><span class="n">至今</span><span class="p">)</span><span class="n">默认的一种模式</span><span class="err">，</span><span class="n">作用是将service的策略转换成iptables规则</span><span class="err">，</span><span class="n">不仅仅包括拦截</span><span class="err">，</span><span class="n">还包括调度</span><span class="err">，</span><span class="n">捕获到达ClusterIP和Port的流量</span><span class="err">，</span><span class="n">并重定向至当前Service的代理的后端Pod资源</span><span class="err">。</span><span class="n">性能比userspace更加高效和可靠</span>
<span class="n">缺点</span><span class="err">：</span>
    <span class="n">不会在后端Pod无响应时自动重定向</span><span class="err">，</span><span class="n">而userspace可以</span>
    <span class="n">中量级k8s集群</span><span class="p">(</span><span class="n">service有几百个</span><span class="p">)</span><span class="n">能够承受</span><span class="err">，</span><span class="n">但是大量级k8s集群</span><span class="p">(</span><span class="n">service有几千个</span><span class="p">)</span><span class="n">维护达几万条规则</span><span class="err">，</span><span class="n">难度较大</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">ipvs是自1</span><span class="p">.</span><span class="n">8版本引入</span><span class="err">，</span><span class="n">1</span><span class="p">.</span><span class="n">11版本起为默认设置</span><span class="err">，</span><span class="n">通过内核的Netlink接口创建相应的ipvs规则</span>
<span class="n">请求流量的转发和调度功能由ipvs实现</span><span class="err">，</span><span class="n">余下的其他功能仍由iptables完成</span><span class="err">。</span><span class="n">ipvs流量转发速度快</span><span class="err">，</span><span class="n">规则同步性能好</span><span class="err">，</span><span class="n">且支持众多调度算法</span><span class="err">，</span><span class="n">如rr</span><span class="p">/</span><span class="n">lc</span><span class="p">/</span><span class="n">dh</span><span class="p">/</span><span class="n">sh</span><span class="p">/</span><span class="n">sed</span><span class="p">/</span><span class="n">nq等</span><span class="err">。</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">对于我们kubeadm方式安装k8s集群来说</span><span class="err">，</span><span class="n">他会首先检测当前主机上是否已经包含了ipvs模块</span><span class="err">，</span><span class="n">如果加载了</span><span class="err">，</span><span class="n">就直接用ipvs模式</span><span class="err">，</span><span class="n">如果没有加载ipvs模块的话</span><span class="err">，</span><span class="n">会自动使用iptables模式</span><span class="err">。</span>
</code></pre></div>
<p><strong>类型解读</strong></p>
<p>service类型</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于k8s来说</span><span class="err">，</span><span class="n">内部服务的自由通信可以满足我们环境的稳定运行</span><span class="err">，</span><span class="n">但是我们作为一个平台</span><span class="err">，</span><span class="n">其核心功能还是将平台内部的服务发布到外部环境</span><span class="err">，</span><span class="n">那么在k8s环境平台上</span><span class="err">，</span><span class="n">Service主要有四种样式来满足我们的需求</span><span class="err">，</span><span class="n">种类如下</span><span class="err">：</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ClusterIP</span>
    <span class="n">这是service默认的服务暴露模式</span><span class="err">，</span><span class="n">主要针对的对象是集群内部</span><span class="err">。</span>
<span class="n">NodePort</span>
    <span class="n">在ClusterIP的基础上</span><span class="err">，</span><span class="n">以</span><span class="p">&lt;</span><span class="n">NodeIP</span><span class="p">&gt;:&lt;</span><span class="n">NodePort</span><span class="p">&gt;</span><span class="n">方式对外提供服务</span><span class="err">，</span><span class="n">默认端口范围沿用Docker初期的随机端口范围</span> <span class="n">30000</span><span class="p">~</span><span class="n">32767</span><span class="err">，</span><span class="n">但是NodePort设定的时候</span><span class="err">，</span><span class="n">会在集群所有节点上实现相同的端口</span><span class="err">。</span>

<span class="n">LoadBalancer</span>
    <span class="n">基于NodePort之上</span><span class="err">，</span><span class="n">使用运营商负载均衡器方式实现对外提供服务底层是基于IaaS云创建一个k8s云</span><span class="err">，</span><span class="n">同时该平台也支持LBaaS产品服务</span><span class="err">。</span>

<span class="n">ExternalName</span>
    <span class="n">当前k8s集群依赖集群外部的服务</span><span class="err">，</span><span class="n">那么通过externalName将外部主机引入到k8s集群内部外部主机名以</span> <span class="n">DNS方式解析为一个</span> <span class="n">CNAME记录给k8s集群的其他主机来使用这种Service既不会有ClusterIP</span><span class="err">，</span><span class="n">也不会有NodePort</span><span class="p">.</span><span class="n">而且依赖于内部的CoreDNS功能</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="113_svc">1.1.3 SVC实践<a class="headerlink" href="#113_svc" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 资源实践、NodePort实践、小结 三个方面来学习。</p>
<p><strong>资源实践</strong></p>
<p>资源属性</p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="err">…</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="err">…</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">key1</span><span class="p">:</span> <span class="n">value1</span>
    <span class="n">key2</span><span class="p">:</span> <span class="n">value2</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type </span><span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>                     <span class="c"># Service类型，默认为ClusterIP</span>
  <span class="n">selector</span> <span class="p">&lt;</span><span class="n">map</span><span class="no">[string]</span><span class="n">string</span><span class="p">&gt;</span>      <span class="c"># 等值类型的标签选择器，内含“与”逻辑</span>
  <span class="n">ports</span><span class="err">：</span>                           <span class="c"># Service的端口对象列表</span>
  <span class="p">-</span> <span class="n">name</span> <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>                   <span class="c"># 端口名称</span>
    <span class="n">protocol</span> <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>               <span class="c"># 协议，目前仅支持TCP、UDP和SCTP，默认为TCP</span>
    <span class="n">port</span> <span class="p">&lt;</span><span class="n">integer</span><span class="p">&gt;</span>                  <span class="c"># Service的端口号</span>
    <span class="n">targetPort</span>  <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>            <span class="c"># 后端目标进程的端口号或名称，名称需由Pod规范定义</span>
    <span class="n">nodePort</span> <span class="p">&lt;</span><span class="n">integer</span><span class="p">&gt;</span>              <span class="c"># 节点端口号，仅适用于NodePort和LoadBalancer类型</span>
  <span class="n">clusterIP</span>  <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>               <span class="c"># Service的集群IP，建议由系统自动分配</span>
  <span class="n">externalTrafficPolicy</span>  <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>   <span class="c"># 外部流量策略处理方式，Local表示由当前节点处理，Cluster表示向集群范围调度</span>
  <span class="n">loadBalancerIP</span>  <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>          <span class="c"># 外部负载均衡器使用的IP地址，仅适用于LoadBlancer</span>
  <span class="n">externalName</span> <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>             <span class="c"># 外部服务名称，该名称将作为Service的DNS CNAME值</span>
</code></pre></div>
<p>手工方法</p>
<div class="highlight"><pre><span></span><code><span class="n">创建一个应用</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl create deployment nginx --image=kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>

<span class="n">创建多种类型svc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --port=80</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --name=svc-default --port=80</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --name=svc-nodeport --port=80 --type=NodePort</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx --name=svc-loadblancer --port=80 --type=LoadBalancer</span>

<span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get svc</span>
<span class="n">NAME</span>             <span class="nb">TYPE </span>          <span class="n">CLUSTER-IP</span>       <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>          <span class="n">AGE</span>
<span class="n">nginx</span>            <span class="n">ClusterIP</span>      <span class="n">10</span><span class="p">.</span><span class="n">99</span><span class="p">.</span><span class="n">57</span><span class="p">.</span><span class="n">240</span>     <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>           <span class="n">4m31s</span>
<span class="n">svc-default</span>      <span class="n">ClusterIP</span>      <span class="n">10</span><span class="p">.</span><span class="n">103</span><span class="p">.</span><span class="n">54</span><span class="p">.</span><span class="n">139</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>           <span class="n">3m2s</span>
<span class="n">svc-loadblancer</span>  <span class="n">LoadBalancer</span>   <span class="n">10</span><span class="p">.</span><span class="n">104</span><span class="p">.</span><span class="n">39</span><span class="p">.</span><span class="n">177</span>    <span class="p">&lt;</span><span class="n">pending</span><span class="p">&gt;</span>     <span class="n">80</span><span class="p">:</span><span class="n">30778</span><span class="p">/</span><span class="n">TCP</span>     <span class="n">2m44s</span>
<span class="n">svc-nodeport</span>     <span class="n">NodePort</span>       <span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">.</span><span class="n">104</span><span class="p">.</span><span class="n">140</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">:</span><span class="n">32335</span><span class="p">/</span><span class="n">TCP</span>     <span class="n">2m54s</span>
</code></pre></div>
<p>资源对象方式</p>
<div class="highlight"><pre><span></span><code><span class="n">查看对象标签</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod --show-labels</span>
<span class="n">NAME</span>                                      <span class="n">READY</span>   <span class="n">STATUS</span>        <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">LABELS</span>
<span class="n">nginx-f44f65dc-pbht6</span>                      <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>       <span class="n">0</span>          <span class="n">8h</span>      <span class="n">app</span><span class="p">=</span><span class="n">nginx</span><span class="p">,</span><span class="n">pod-template-hash</span><span class="p">=</span><span class="n">f44f65dc</span>
</code></pre></div>
<p>简单实践</p>
<div class="highlight"><pre><span></span><code><span class="n">定制资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># mkdir /data/kubernetes/service -p ; cd /data/kubernetes/service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c">#</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># vim 01_kubernetes-service_test.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-service</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">80</span>

<span class="n">应用资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  apply -f 01_kubernetes-service_test.yml</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-nginx-service</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看service效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  describe svc superopsmsb-nginx-service</span>
<span class="n">Name</span><span class="p">:</span>              <span class="n">superopsmsb-nginx-service</span>
<span class="p">...</span>
<span class="n">IP</span><span class="p">:</span>                <span class="n">10</span><span class="p">.</span><span class="n">109</span><span class="p">.</span><span class="n">240</span><span class="p">.</span><span class="n">56</span>
<span class="n">IPs</span><span class="p">:</span>               <span class="n">10</span><span class="p">.</span><span class="n">109</span><span class="p">.</span><span class="n">240</span><span class="p">.</span><span class="n">56</span>
<span class="n">Port</span><span class="p">:</span>              <span class="n">http</span>  <span class="n">8000</span><span class="p">/</span><span class="n">TCP</span>
<span class="n">TargetPort</span><span class="p">:</span>        <span class="n">8000</span><span class="p">/</span><span class="n">TCP</span>
<span class="n">Endpoints</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">63</span><span class="p">:</span><span class="n">8000</span>
<span class="p">...</span>

<span class="n">访问service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># curl -s  10.101.25.116 -I | head -n1</span>
<span class="n">HTTP</span><span class="p">/</span><span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">200</span> <span class="n">OK</span>
</code></pre></div>
<p><strong>NodePort实践</strong></p>
<p>属性解读</p>
<div class="highlight"><pre><span></span><code><span class="n">NodePort会在所有的节点主机上</span><span class="err">，</span><span class="n">暴露一个指定或者随机的端口</span><span class="err">，</span><span class="n">供外部的服务能够正常的访问pod内部的资源</span><span class="err">。</span>
</code></pre></div>
<p>简单实践</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># vim 02_kubernetes-service_nodePort.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-nodeport</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="n">30080</span>

<span class="n">应用资源清单文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  apply -f 02_kubernetes-service_nodePort.yml</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-nginx-nodeport</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">检查效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  describe  svc superopsmsb-nginx-nodeport</span>
<span class="n">Name</span><span class="p">:</span>                     <span class="n">superopsmsb-nginx-nodeport</span>
<span class="p">...</span>
<span class="n">Type</span><span class="p">:</span>                     <span class="n">NodePort</span>
<span class="n">IP</span> <span class="n">Family</span> <span class="n">Policy</span><span class="p">:</span>         <span class="n">SingleStack</span>
<span class="n">IP</span> <span class="n">Families</span><span class="p">:</span>              <span class="n">IPv4</span>
<span class="n">IP</span><span class="p">:</span>                       <span class="n">10</span><span class="p">.</span><span class="n">102</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">177</span>
<span class="n">IPs</span><span class="p">:</span>                      <span class="n">10</span><span class="p">.</span><span class="n">102</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">177</span>
<span class="n">Port</span><span class="p">:</span>                     <span class="n">http</span>  <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>
<span class="n">TargetPort</span><span class="p">:</span>               <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>
<span class="n">NodePort</span><span class="p">:</span>                 <span class="n">http</span>  <span class="n">30080</span><span class="p">/</span><span class="n">TCP</span>
<span class="p">...</span>

<span class="n">访问效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># curl 10.0.0.12:30080             Hello Nginx, nginx-6944855df5-8zjdn-1.23.0</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="114_ipvs">1.1.4 IPVS实践<a class="headerlink" href="#114_ipvs" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<p><img alt="image-20220721093742953" src="../../../img/kubernetes/kubernetes_flannel/image-20220721093742953.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">关键点</span><span class="err">：</span>
    <span class="n">ipvs会在每个节点上创建一个名为kube-ipvs0的虚拟接口</span><span class="err">，</span><span class="n">并将集群所有Service对象的ClusterIP和ExternalIP都配置在该接口</span><span class="err">；</span> 
        <span class="p">-</span> <span class="n">所以每增加一个ClusterIP</span> <span class="n">或者</span> <span class="n">EternalIP</span><span class="err">，</span><span class="n">就相当于为</span> <span class="n">kube-ipvs0</span> <span class="n">关联了一个地址罢了</span><span class="err">。</span>
    <span class="n">kube-proxy为每个service生成一个虚拟服务器</span><span class="p">(</span> <span class="n">IPVS</span> <span class="n">Virtual</span> <span class="n">Server</span><span class="p">)</span><span class="n">的定义</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">基本流程</span><span class="err">：</span>
    <span class="n">所以当前节点接收到外部流量后</span><span class="err">，</span><span class="n">如果该数据包是交给当前节点上的clusterIP</span><span class="err">，</span><span class="n">则会直接将数据包交给kube-ipvs0</span><span class="err">，</span><span class="n">而这个接口是内核虚拟出来的</span><span class="err">，</span><span class="n">而kube-proxy定义的VS直接关联到kube-ipvs0上</span><span class="err">。</span>
    <span class="n">如果是本地节点pod发送的请求</span><span class="err">，</span><span class="n">基本上属于本地通信</span><span class="err">，</span><span class="n">效率是非常高的</span><span class="err">。</span>
    <span class="n">默认情况下</span><span class="err">，</span><span class="n">这里的ipvs使用的是nat转发模型</span><span class="err">，</span><span class="n">而且支持更多的后端调度算法</span><span class="err">。</span><span class="n">仅仅在涉及到源地址转换的场景中</span><span class="err">，</span><span class="n">会涉及到极少量的iptables规则</span><span class="p">(</span><span class="n">应该不会超过20条</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">前提</span><span class="err">：</span><span class="n">当前操作系统需要提前加载ipvs模块</span>
    <span class="n">yum</span> <span class="n">install</span> <span class="n">ipvsadm</span> <span class="n">-y</span>
</code></pre></div>
<p>kube-proxy</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于k8s来说</span><span class="err">，</span><span class="n">默认情况下</span><span class="err">，</span><span class="n">支持的规则是</span> <span class="n">iptables</span><span class="err">，</span><span class="n">我们可以通过多种方式对我们的代理模式进行更改</span><span class="err">，</span><span class="n">因为这些规则都是基于kube-proxy来定制的</span><span class="err">，</span><span class="n">所以</span><span class="err">，</span><span class="n">我们如果要更改代理模式的话</span><span class="err">，</span><span class="n">就需要调整kube-proxy的属性</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在k8s集群中</span><span class="err">，</span><span class="n">关于kube-proxy的所有属性信息</span><span class="err">，</span><span class="n">我们可以通过一个</span> <span class="n">configmap</span> <span class="n">的资源对象来了解一下</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe configmap kube-proxy -n kube-system</span>
<span class="n">Name</span><span class="p">:</span>         <span class="n">kube-proxy</span>
<span class="n">Namespace</span><span class="p">:</span>    <span class="n">kube-system</span>
<span class="n">Labels</span><span class="p">:</span>       <span class="n">app</span><span class="p">=</span><span class="n">kube-proxy</span>
<span class="p">...</span>
<span class="n">iptables</span><span class="p">:</span>
  <span class="n">masqueradeAll</span><span class="p">:</span> <span class="n">false</span>              <span class="c"># 这个属性打开的话，会对所有的请求都进行源地址转换</span>
  <span class="p">...</span>
<span class="n">ipvs</span><span class="p">:</span>
  <span class="n">excludeCIDRs</span><span class="p">:</span> <span class="n">null</span>
  <span class="n">minSyncPeriod</span><span class="p">:</span> <span class="n">0s</span>
  <span class="n">scheduler</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>                     <span class="c"># 调度算法，默认是randomrobin</span>
  <span class="p">...</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">KubeProxyConfiguration</span>
<span class="n">metricsBindAddress</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>                            <span class="c"># 默认没有指定，就是使用 iptables 规则</span>
<span class="p">...</span>
</code></pre></div>
<p>查看默认模式</p>
<div class="highlight"><pre><span></span><code><span class="n">通过kube-proxy-b8dpc的pod日志查看模式</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl logs kube-proxy-b8dpc -n kube-system</span>
<span class="p">...</span>
<span class="n">I0719</span> <span class="n">08</span><span class="p">:</span><span class="n">39</span><span class="p">:</span><span class="n">44</span><span class="p">.</span><span class="n">410078</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">561</span><span class="p">]</span> <span class="s2">&quot;Unknown proxy mode, assuming iptables proxy&quot;</span> <span class="n">proxyMode</span><span class="p">=</span><span class="s2">&quot;&quot;</span>
<span class="n">I0719</span> <span class="n">08</span><span class="p">:</span><span class="n">39</span><span class="p">:</span><span class="n">44</span><span class="p">.</span><span class="n">462438</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">206</span><span class="p">]</span> <span class="s2">&quot;Using iptables Proxier&quot;</span>
<span class="p">...</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>准备</p>
<div class="highlight"><pre><span></span><code><span class="n">清理所有svc</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># for i in $(kubectl  get svc | egrep -v &#39;NAME|kubernetes&#39; | awk &#39;{print $1}&#39;)</span>
<span class="p">&gt;</span> <span class="k">do</span>
<span class="p">&gt;</span> <span class="n">kubectl</span> <span class="n">delete</span> <span class="n">svc</span> <span class="nv">$i</span>
<span class="p">&gt;</span> <span class="n">done</span>
</code></pre></div>
<p>修改kube-proxy模式</p>
<div class="highlight"><pre><span></span><code><span class="n">我们在测试环境中</span><span class="err">，</span><span class="n">临时修改一下configmap中proxy的基本属性</span> <span class="p">-</span> <span class="n">临时环境推荐</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl edit configmap kube-proxy -n kube-system</span>
    <span class="p">...</span>
    <span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;ipvs&quot;</span>
    <span class="p">...</span>

<span class="n">重启所有的kube-proxy</span> <span class="n">pod对象</span> 
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl delete pod -n kube-system -l k8s-app=kube-proxy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">通过kube-proxy的pod日志查看模式</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl logs kube-proxy-fb9pz -n kube-system</span>
<span class="p">...</span>
<span class="n">I0721</span> <span class="n">10</span><span class="p">:</span><span class="n">31</span><span class="p">:</span><span class="n">40</span><span class="p">.</span><span class="n">408116</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">269</span><span class="p">]</span> <span class="s2">&quot;Using ipvs Proxier&quot;</span>
<span class="n">I0721</span> <span class="n">10</span><span class="p">:</span><span class="n">31</span><span class="p">:</span><span class="n">40</span><span class="p">.</span><span class="n">408155</span>       <span class="n">1</span> <span class="n">server_others</span><span class="p">.</span><span class="n">go</span><span class="p">:</span><span class="n">271</span><span class="p">]</span> <span class="s2">&quot;Creating dualStackProxier for ipvs&quot;</span>
<span class="p">...</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">安装参考命令</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># yum install ipvsadm -y</span>

<span class="n">查看规则效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># ipvsadm -Ln</span>
<span class="n">IP</span> <span class="n">Virtual</span> <span class="n">Server</span> <span class="n">version</span> <span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">1</span> <span class="p">(</span><span class="n">size</span><span class="p">=</span><span class="n">4096</span><span class="p">)</span>
<span class="n">Prot</span> <span class="n">LocalAddress</span><span class="p">:</span><span class="n">Port</span> <span class="n">Scheduler</span> <span class="n">Flags</span>
  <span class="p">-&gt;</span> <span class="n">RemoteAddress</span><span class="p">:</span><span class="n">Port</span>           <span class="n">Forward</span> <span class="n">Weight</span> <span class="n">ActiveConn</span> <span class="n">InActConn</span>
<span class="n">TCP</span>  <span class="n">172</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">30443</span> <span class="n">rr</span>
  <span class="p">-&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">:</span><span class="n">8443</span>              <span class="n">Masq</span>    <span class="n">1</span>      <span class="n">0</span>          <span class="n">0</span>
  <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建一个service</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  apply -f 02_kubernetes-service_nodePort.yml</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-nginx-nodeport</span> <span class="n">created</span>

<span class="n">查看svc的ip</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  get svc superopsmsb-nginx-nodeport -o wide</span>
<span class="n">NAME</span>                         <span class="nb">TYPE </span>      <span class="n">CLUSTER-IP</span>       <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>        <span class="n">AGE</span>   <span class="n">SELECTOR</span>
<span class="n">superopsmsb-nginx-nodeport</span>   <span class="n">NodePort</span>   <span class="n">10</span><span class="p">.</span><span class="n">106</span><span class="p">.</span><span class="n">138</span><span class="p">.</span><span class="n">242</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">:</span><span class="n">30080</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">23s</span>   <span class="n">app</span><span class="p">=</span><span class="n">nginx</span>

<span class="n">查看ipvsadm规则</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># ipvsadm -Ln | grep -A1 10.106.138.242</span>
<span class="n">TCP</span>  <span class="n">10</span><span class="p">.</span><span class="n">106</span><span class="p">.</span><span class="n">138</span><span class="p">.</span><span class="n">242</span><span class="p">:</span><span class="n">80</span> <span class="n">rr</span>
  <span class="p">-&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">64</span><span class="p">:</span><span class="n">80</span>               <span class="n">Masq</span>    <span class="n">1</span>      <span class="n">0</span>          <span class="n">0</span>

<span class="n">查看防火墙规则</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># iptables -t nat -S KUBE-NODE-PORT</span>
<span class="n">-N</span> <span class="n">KUBE-NODE-PORT</span>
<span class="n">-A</span> <span class="n">KUBE-NODE-PORT</span> <span class="n">-p</span> <span class="n">tcp</span> <span class="n">-m</span> <span class="n">comment</span> <span class="p">-</span><span class="n">-comment</span> <span class="s2">&quot;Kubernetes nodeport TCP port for masquerade purpose&quot;</span> <span class="n">-m</span> <span class="nb">set </span><span class="p">-</span><span class="o">-match</span><span class="n">-set</span> <span class="n">KUBE-NODE-PORT-TCP</span> <span class="n">dst</span> <span class="n">-j</span> <span class="n">KUBE-MARK-MASQ</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">没有生成对应的防火墙规则</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="12_1">1.2 其他资源<a class="headerlink" href="#12_1" title="Permanent link">&para;</a></h2>
<h3 id="121_1">1.2.1 域名服务<a class="headerlink" href="#121_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 场景需求、域名测试、小结 三个方面来学习。</p>
<p><strong>场景需求</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在传统的系统部署中</span><span class="err">，</span><span class="n">服务运行在一个固定的已知的</span> <span class="n">IP</span> <span class="n">和端口上</span><span class="err">，</span><span class="n">如果一个服务需要调用另外一个服务</span><span class="err">，</span><span class="n">可以通过地址直接调用</span><span class="err">，</span><span class="n">但是</span><span class="err">，</span><span class="n">在虚拟化或容器话的环境中</span><span class="err">，</span><span class="n">以我们的k8s集群为例</span><span class="err">，</span><span class="n">如果存在个位数个service我们可以很快的找到对应的clusterip地址</span><span class="err">，</span><span class="n">进而找到指定的资源</span><span class="err">，</span><span class="n">虽然ip地址不容易记住</span><span class="err">，</span><span class="n">因为service在创建的时候会为每个clusterip分配一个名称</span><span class="err">，</span><span class="n">我们同样可以根据这个名称找到对应的服务</span><span class="err">。</span><span class="n">但是</span><span class="err">，</span><span class="n">如果我们的集群中有1000个Service</span><span class="err">，</span><span class="n">我们如何找到指定的service呢</span><span class="err">？</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">虽然我们可以借助于传统的DNS机制来实现</span><span class="err">，</span><span class="n">但是在k8s集群中</span><span class="err">，</span><span class="n">服务实例的启动和销毁是很频繁的</span><span class="err">，</span><span class="n">服务地址在动态的变化</span><span class="err">，</span><span class="n">所以传统的方式配置DNS解析记录就不太好实现了</span><span class="err">。</span><span class="n">所以针对于这种场景</span><span class="err">，</span><span class="n">我们如果需要将请求发送到动态变化的服务实例上</span><span class="err">，</span><span class="n">可以通过一下两个步骤来实现</span><span class="err">：</span>
    <span class="n">服务注册</span> <span class="err">—</span> <span class="n">创建服务实例后</span><span class="err">，</span><span class="n">主动将当前服务实例的信息</span><span class="err">，</span><span class="n">存储到一个集中式的服务管理中心</span><span class="err">。</span>
    <span class="n">服务发现</span> <span class="err">—</span> <span class="n">当A服务需要找未知的B服务时</span><span class="err">，</span><span class="n">先去服务管理中心查找B服务地址</span><span class="err">，</span><span class="n">然后根据该地址找到B服务</span>
</code></pre></div>
<p>DNS方案</p>
<div class="highlight"><pre><span></span><code>    <span class="n">专用于kubernetes集群中的服务注册和发现的解决方案就是KubeDNS</span><span class="err">。</span><span class="n">kubeDNS自从k8s诞生以来</span><span class="err">，</span><span class="n">其方案的具体实现样式前后经历了三代</span><span class="err">，</span><span class="n">分别是</span> <span class="n">SkyDNS</span><span class="err">、</span><span class="n">KubeDNS</span><span class="err">、</span><span class="n">CoreDNS</span><span class="p">(</span><span class="n">目前默认的</span><span class="p">)</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220721185041526" src="../../../img/kubernetes/kubernetes_flannel/image-20220721185041526.png" /></p>
<p>域名解析记录</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Kubelet会为创建的每一个容器于</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">resolv</span><span class="p">.</span><span class="n">conf配置文件中生成DNS查询客户端依赖到的必要配置</span><span class="err">，</span><span class="n">相关的配置信息源自于kubelet的配置参数</span><span class="err">，</span><span class="n">容器的DNS服务器由clusterDNS参数的值设定</span><span class="err">，</span><span class="n">它的取值为kube-system名称空间中的Service对象kube-dns的ClusterIP</span><span class="err">，</span><span class="n">默认为10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="p">.</span>
    <span class="n">DNS搜索域的值由clusterDomain参数的值设定</span><span class="err">，</span><span class="n">若部署Kubernetes集群时未特别指定</span><span class="err">，</span><span class="n">其值将为cluster</span><span class="p">.</span><span class="n">local</span><span class="err">、</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local和NAMESPACENAME</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubeadm</span> <span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">8</span> <span class="n">环境初始化配置文件中与dns相关的检索信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># grep -A1 networking /data/kubernetes/cluster_init/kubeadm_init_1.23.8.yml</span>
<span class="n">networking</span><span class="p">:</span>
  <span class="n">dnsDomain</span><span class="p">:</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
</code></pre></div>
<p>资源对象的dns记录</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于kubernetes的内部资源对象来说</span><span class="err">，</span><span class="n">为了更好的绕过变化频率更高的ip地址的限制</span><span class="err">，</span><span class="n">它可以在内部以dns记录的方式进行对象发现</span><span class="err">，</span><span class="n">dns记录具有标准的名称格式</span><span class="err">：</span>
    <span class="n">资源对象名</span><span class="p">.</span><span class="n">命名空间名</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
</code></pre></div>
<p><strong>域名测试</strong></p>
<p>创建一个svc记录</p>
<div class="highlight"><pre><span></span><code>[root@kubernetes-master1 /data/kubernetes/service]# kubectl  apply -f 01_kubernetes-service_test.yml
service/superopsmsb-nginx-service created
[root@kubernetes-master1 /data/kubernetes/service]# kubectl  get svc superopsmsb-nginx-service -o wide             NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
superopsmsb-nginx-service   ClusterIP   10.97.135.126   &lt;none&gt;        80/TCP    23s   app=nginx
</code></pre></div>
<p>资源对象的名称记录</p>
<div class="highlight"><pre><span></span><code><span class="n">查看本地的pod效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">38m</span>

<span class="n">查看pod内部的resolv</span><span class="p">.</span><span class="n">conf文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  exec -it nginx-6944855df5-8zjdn -- cat /etc/resolv.conf</span>
<span class="n">nameserver</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">search</span> <span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="n">localhost</span>
<span class="n">options</span> <span class="n">ndots</span><span class="p">:</span><span class="n">5</span>
<span class="n">可以看到</span><span class="err">：</span>
    <span class="n">资源对象的查看dns的后缀主要有四种</span><span class="err">：</span>
        <span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
        <span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
        <span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
        <span class="n">localhost</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看内部的资源对象完整域名</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  exec -it nginx-6944855df5-8zjdn -- /bin/bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># curl</span>
<span class="n">curl</span><span class="p">:</span> <span class="k">try</span> <span class="s1">&#39;curl --help&#39;</span> <span class="n">or</span> <span class="s1">&#39;curl --manual&#39;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-service</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-service.default.svc.cluster.local</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># curl superopsmsb-nginx-service.default.svc.cluster.local.</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<p>内部dns测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">安装dns测试工具</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># apt update</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># apt install dnsutils -y</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">资源对象的查看效果</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup superopsmsb-nginx-service</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-nginx-service</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">97</span><span class="p">.</span><span class="n">135</span><span class="p">.</span><span class="n">126</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup 10.97.135.126</span>
<span class="n">126</span><span class="p">.</span><span class="n">135</span><span class="p">.</span><span class="n">97</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="k">in</span><span class="n">-addr</span><span class="p">.</span><span class="n">arpa</span>      <span class="n">name</span> <span class="p">=</span> <span class="n">superopsmsb-nginx-service</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup kubernetes</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看跨命名空间的资源对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  get svc -n kube-system</span>
<span class="n">NAME</span>       <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>   <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>                  <span class="n">AGE</span>
<span class="n">kube-dns</span>   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">53</span><span class="p">/</span><span class="n">UDP</span><span class="p">,</span><span class="n">53</span><span class="p">/</span><span class="n">TCP</span><span class="p">,</span><span class="n">9153</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">2d2h</span>

<span class="n">回到pod终端查看效果</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup kube-dns.kube-system.svc.cluster.local</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">kube-dns</span><span class="p">.</span><span class="n">kube-system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup 10.96.0.10</span>
<span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="k">in</span><span class="n">-addr</span><span class="p">.</span><span class="n">arpa</span> <span class="n">name</span> <span class="p">=</span> <span class="n">kube-dns</span><span class="p">.</span><span class="n">kube-system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="p">.</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup kube-dns</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="p">**</span> <span class="n">server</span> <span class="n">can</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">find</span> <span class="n">kube-dns</span><span class="p">:</span> <span class="n">NXDOMAIN</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">对于跨命名空间的资源对象必须使用完整的名称格式</span>
</code></pre></div>
<p>pod资源对象解析</p>
<div class="highlight"><pre><span></span><code><span class="n">查看pod资源对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>            <span class="p">...</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">56m</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">64</span>   <span class="p">...</span>

<span class="n">构造资源对象名</span><span class="err">，</span><span class="n">pod的ip名称转换</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span><span class="p">:/</span><span class="c"># nslookup 10-244-3-64.superopsmsb-nginx-service.default.svc.cluster.local.           Server:         10.96.0.10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">10</span><span class="p">-</span><span class="n">244</span><span class="p">-</span><span class="n">3</span><span class="p">-</span><span class="n">64</span><span class="p">.</span><span class="n">superopsmsb-nginx-service</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">64</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="122_coredns">1.2.2 CoreDNS<a class="headerlink" href="#122_coredns" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">coredns是一个用go语言编写的开源的DNS服务</span><span class="err">，</span><span class="n">coredns是首批加入CNCF组织的云原生开源项目</span><span class="err">，</span><span class="n">并且作为已经在CNCF毕业的项目</span><span class="err">，</span><span class="n">coredns还是目前kubernetes中默认的dns服务</span><span class="err">。</span><span class="n">同时</span><span class="err">，</span><span class="n">由于coredns可以集成插件</span><span class="err">，</span><span class="n">它还能够实现服务发现的功能</span><span class="err">。</span>

    <span class="n">coredns和其他的诸如bind</span><span class="err">、</span><span class="n">knot</span><span class="err">、</span><span class="n">powerdns</span><span class="err">、</span><span class="n">unbound等DNS服务不同的是</span><span class="err">：</span><span class="n">coredns非常的灵活</span><span class="err">，</span><span class="n">并且几乎把所有的核心功能实现都外包给了插件</span><span class="err">。</span><span class="n">如果你想要在coredns中加入Prometheus的监控支持</span><span class="err">，</span><span class="n">那么只需要安装对应的prometheus插件并且启用即可</span><span class="err">。</span>
</code></pre></div>
<p>配置解析</p>
<div class="highlight"><pre><span></span><code><span class="n">coredns的配置依然是存放在</span> <span class="n">configmap中</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get cm coredns -n kube-system</span>
<span class="n">NAME</span>      <span class="n">DATA</span>   <span class="n">AGE</span>
<span class="n">coredns</span>   <span class="n">1</span>      <span class="n">2d2h</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看配置详情</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl describe cm coredns -n kube-system</span>
<span class="n">Name</span><span class="p">:</span>         <span class="n">coredns</span>
<span class="n">Namespace</span><span class="p">:</span>    <span class="n">kube-system</span>
<span class="n">Labels</span><span class="p">:</span>       <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">Annotations</span><span class="p">:</span>  <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>

<span class="n">Data</span>
<span class="p">====</span>
<span class="n">Corefile</span><span class="p">:</span>
<span class="p">----</span>
<span class="p">.:</span><span class="n">53</span> <span class="p">{</span>
    <span class="n">errors</span>
    <span class="n">health</span> <span class="p">{</span>                                            <span class="c"># 健康检测</span>
       <span class="n">lameduck</span> <span class="n">5s</span>
    <span class="p">}</span>
    <span class="n">ready</span>
    <span class="n">kubernetes</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="k">in</span><span class="n">-addr</span><span class="p">.</span><span class="n">arpa</span> <span class="n">ip6</span><span class="p">.</span><span class="n">arpa</span> <span class="p">{</span>    <span class="c"># 解析配置</span>
       <span class="n">pods</span> <span class="n">insecure</span>
       <span class="n">fallthrough</span> <span class="k">in</span><span class="n">-addr</span><span class="p">.</span><span class="n">arpa</span> <span class="n">ip6</span><span class="p">.</span><span class="n">arpa</span>
       <span class="n">ttl</span> <span class="n">30</span>
    <span class="p">}</span>
    <span class="n">prometheus</span> <span class="p">:</span><span class="n">9153</span>
    <span class="n">forward</span> <span class="p">.</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">resolv</span><span class="p">.</span><span class="n">conf</span> <span class="p">{</span>                        <span class="c"># 转发配置  </span>
       <span class="n">max_concurrent</span> <span class="n">1000</span>
    <span class="p">}</span>
    <span class="n">cache</span> <span class="n">30</span>
    <span class="n">loop</span>
    <span class="n">reload</span>                                              <span class="c"># 自动加载</span>
    <span class="n">loadbalance</span>
<span class="p">}</span>

<span class="n">BinaryData</span>
<span class="p">====</span>

<span class="n">Events</span><span class="p">:</span>  <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">其他属性和示例</span><span class="err">：</span>
    <span class="n">except</span>  <span class="n">domain</span>                  <span class="n">排除的域名</span>

<span class="n">添加dns解析</span>
    <span class="n">hosts</span> <span class="p">{</span>
        <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">100</span> <span class="n">www</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span>
        <span class="n">fallthrough</span>         <span class="c"># 在CoreDNS里面表示如果自己无法处理，则交由下个插件处理。</span>
    <span class="p">}</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>修改实践</p>
<div class="highlight"><pre><span></span><code><span class="n">修改配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl edit cm coredns -n kube-system</span>
<span class="p">...</span>
        <span class="n">forward</span> <span class="p">.</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">resolv</span><span class="p">.</span><span class="n">conf</span> <span class="p">{</span>
           <span class="n">max_concurrent</span> <span class="n">1000</span>
           <span class="n">except</span> <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>
        <span class="p">}</span>
        <span class="n">hosts</span> <span class="p">{</span>
           <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span> <span class="n">harbor</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
           <span class="n">fallthrough</span>
        <span class="p">}</span>
        <span class="p">...</span>
        <span class="n">注意</span><span class="err">：</span>
            <span class="n">多个dns地址间用空格隔开</span>
            <span class="n">排除的域名最好在末尾添加</span> <span class="err">“</span><span class="p">.</span><span class="err">”，</span><span class="n">对于之前的旧版本来说可能会出现无法保存的现象</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">同步dns的配置信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl delete pod -l k8s-app=kube-dns -n kube-system</span>
<span class="n">pod</span> <span class="s2">&quot;coredns-5d555c984-fmrht&quot;</span> <span class="n">deleted</span>
<span class="n">pod</span> <span class="s2">&quot;coredns-5d555c984-scvjh&quot;</span> <span class="n">deleted</span>

<span class="n">删除旧pod</span><span class="err">，</span><span class="n">使用新pod测试</span> <span class="err">（</span><span class="n">可以忽略</span><span class="err">）</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  get pod</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">8zjdn</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">70m</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  delete pod nginx-6944855df5-8zjdn</span>
<span class="n">pod</span> <span class="s2">&quot;nginx-6944855df5-8zjdn&quot;</span> <span class="n">deleted</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">pod中测试效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  exec -it nginx-6944855df5-9s4bd -- /bin/bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">9s4bd</span><span class="p">:/</span><span class="c"># apt update ; apt install dnsutils -y</span>

<span class="n">测试效果</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">9s4bd</span><span class="p">:/</span><span class="c"># nslookup www.baidu.com</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="p">**</span> <span class="n">server</span> <span class="n">can</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">find</span> <span class="n">www</span><span class="p">.</span><span class="n">baidu</span><span class="p">.</span><span class="n">com</span><span class="p">:</span> <span class="n">SERVFAIL</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">9s4bd</span><span class="p">:/</span><span class="c"># nslookup harbor.superopsmsb.com</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">harbor</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">20</span>
</code></pre></div>
<p>清理环境</p>
<div class="highlight"><pre><span></span><code><span class="n">将之前的配置清理掉</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="123_1">1.2.3 无头服务<a class="headerlink" href="#123_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在kubernetes中</span><span class="err">，</span><span class="n">有一种特殊的无头service</span><span class="err">，</span><span class="n">它本身是Service</span><span class="err">，</span><span class="n">但是没有ClusterIP</span><span class="err">，</span><span class="n">这种svc在一些有状态的场景中非常重要</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">无头服务场景下</span><span class="err">，</span><span class="n">k8s会将一个集群内部的所有成员提供唯一的DNS域名来作为每个成员的网络标识</span><span class="err">，</span><span class="n">集群内部成员之间使用域名通信</span><span class="err">，</span><span class="n">这个时候</span><span class="err">，</span><span class="n">就特别依赖service的selector属性配置了</span><span class="err">。</span>
    <span class="n">无头服务管理的域名是如下的格式</span><span class="err">：</span><span class="p">$(</span><span class="n">service_name</span><span class="p">).$(</span><span class="n">k8s_namespace</span><span class="p">).</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span><span class="err">。</span>
</code></pre></div>
<p>pod资源对象的解析记录</p>
<div class="highlight"><pre><span></span><code><span class="n">dns解析记录</span>
    <span class="n">A记录</span>
        <span class="p">&lt;</span><span class="n">a</span><span class="p">&gt;-&lt;</span><span class="n">b</span><span class="p">&gt;-&lt;</span><span class="n">c</span><span class="p">&gt;-&lt;</span><span class="n">d</span><span class="p">&gt;.&lt;</span><span class="n">service</span><span class="p">&gt;.&lt;</span><span class="n">ns</span><span class="p">&gt;.</span><span class="n">svc</span><span class="p">.&lt;</span><span class="n">zone</span><span class="p">&gt;</span>  <span class="n">A</span>  <span class="n">PodIP</span>
<span class="n">关键点</span><span class="err">：</span>
      <span class="n">svc_name的解析结果从常规Service的ClusterIP</span><span class="err">，</span><span class="n">转为各个Pod的IP地址</span><span class="err">；</span>
      <span class="n">反解</span><span class="err">，</span><span class="n">则从常规的clusterip解析为service</span> <span class="n">name</span><span class="err">，</span><span class="n">转为从podip到hostname</span><span class="p">,</span> <span class="p">&lt;</span><span class="n">a</span><span class="p">&gt;-&lt;</span><span class="n">b</span><span class="p">&gt;-&lt;</span><span class="n">c</span><span class="p">&gt;-&lt;</span><span class="n">d</span><span class="p">&gt;.&lt;</span><span class="n">service</span><span class="p">&gt;.&lt;</span><span class="n">ns</span><span class="p">&gt;.</span><span class="n">svc</span><span class="p">.&lt;</span><span class="n">zone</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="n">hostname</span><span class="p">&gt;</span><span class="n">指的是a-b-c-d格式</span><span class="err">，</span><span class="n">而非Pod自己的主机名</span><span class="err">；</span> 
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">扩展pod对象数量</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl scale deployment nginx --replicas=3</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx</span> <span class="n">scaled</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>            <span class="p">...</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">9m44b</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">5s</span>    <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">4</span>   <span class="p">...</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5</span><span class="p">-</span><span class="n">9s4bd</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">14m</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span>   <span class="n">kubernetes-node3</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">nginx</span><span class="p">-</span><span class="n">6944855df5-mswl4</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">5s</span>    <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">3</span>   <span class="n">kubernetes-node2</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<p>定制无头服务</p>
<div class="highlight"><pre><span></span><code><span class="n">手工定制无头服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl create service clusterip service-headless --clusterip=&quot;None&quot;</span>
<span class="n">service</span><span class="p">/</span><span class="n">service-headless-cmd</span> <span class="n">created</span>

<span class="n">查看无头服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get svc service-headless</span>
<span class="n">NAME</span>                   <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>   <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>   <span class="n">AGE</span>
<span class="n">service-headless</span>       <span class="n">ClusterIP</span>   <span class="n">None</span>         <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>    <span class="n">6s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">资源清单文件定制无头服务</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># cat 03_kubernetes-service_headless.yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">superopsmsb-nginx-headless</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span>

<span class="n">应用资源对象</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  apply -f 03_kubernetes-service_headless.yml</span>
<span class="n">service</span><span class="p">/</span><span class="n">superopsmsb-nginx-headless</span> <span class="n">created</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl  get svc</span>
<span class="n">NAME</span>                         <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>   <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>   <span class="n">AGE</span>
<span class="n">kubernetes</span>                   <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">6m33s</span>
<span class="n">service-headless</span>             <span class="n">ClusterIP</span>   <span class="n">None</span>         <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>    <span class="n">61s</span>
<span class="n">superopsmsb-nginx-headless</span>   <span class="n">ClusterIP</span>   <span class="n">None</span>         <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">/</span><span class="n">TCP</span>    <span class="n">7s</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">进入测试容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">service</span><span class="p">]</span><span class="c"># kubectl exec -it nginx-fd669dcb-h5d9d -- /bin/bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-fd669dcb-h5d9d</span><span class="p">:/</span><span class="c"># nslookup superopsmsb-nginx-headless</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-nginx-headless</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">4</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-nginx-headless</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">3</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">superopsmsb-nginx-headless</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span>
<span class="n">结果显式</span><span class="err">：</span>
    <span class="n">由于我们没有对域名做定向解析</span><span class="err">，</span><span class="n">那么找请求的时候</span><span class="err">，</span><span class="n">就像无头苍蝇似的</span><span class="err">，</span><span class="n">到处乱串</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="13_flannel">1.3 flannel方案<a class="headerlink" href="#13_flannel" title="Permanent link">&para;</a></h2>
<h3 id="131_1">1.3.1 网络方案<a class="headerlink" href="#131_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 存储原理、方案解读、小结 三个方面来学习。</p>
<p><strong>存储原理</strong></p>
<p>容器实现网络访问样式</p>
<p><img alt="1633650192071" src="../../../img/kubernetes/kubernetes_flannel/1633650192071.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">1</span>  <span class="n">虚拟网桥</span><span class="err">：</span>
    <span class="n">brdige</span><span class="err">，</span><span class="n">用纯软件的方式实现一个虚拟网络</span><span class="err">，</span><span class="n">用一个虚拟网卡接入到我们虚拟网桥上去</span><span class="err">。</span><span class="n">这样就能保证每一个容器和每一个pod都能有一个专用的网络接口</span><span class="err">，</span><span class="n">从而实现每一主机组件有网络接口</span><span class="err">。</span>

<span class="n">2</span>  <span class="n">多路复用</span><span class="err">：</span>
    <span class="n">MacVLAN</span><span class="err">，</span><span class="n">借助于linux内核级的VLAN模块</span><span class="err">，</span><span class="n">在同一个物理网卡上配置多个</span> <span class="n">MAC</span> <span class="n">地址</span><span class="err">，</span><span class="n">每个</span> <span class="n">MAC</span> <span class="n">给一个Pod使用</span><span class="err">，</span><span class="n">然后借助物理网卡中的MacVLAN机制进行跨节点之间进行通信了</span><span class="err">。</span>

<span class="n">3</span>  <span class="n">硬件交换</span><span class="err">：</span>
    <span class="n">很多网卡都已经支持</span><span class="s2">&quot;单根IOV的虚拟化&quot;</span><span class="n">了</span><span class="err">，</span><span class="n">借助于单根IOV</span><span class="err">（</span><span class="n">SR-IOV</span><span class="err">）</span><span class="n">的方式</span><span class="err">，</span><span class="n">直接在物理主机虚拟出多个接口来</span><span class="err">，</span><span class="n">通信性能很高</span><span class="err">，</span><span class="n">然后每个虚拟网卡能够分配给容器使用</span><span class="err">。</span> 
</code></pre></div>
<p>容器网络方案</p>
<div class="highlight"><pre><span></span><code><span class="n">任何一种能够让容器自由通信的网络解决方案</span><span class="err">，</span><span class="n">必须包含三个功能</span><span class="err">：</span>
    <span class="n">1</span> <span class="n">构建一个网络</span>
    <span class="n">2</span> <span class="n">将容器接入到这个网络中</span>
    <span class="n">3</span> <span class="n">实时维护所有节点上的路由信息</span><span class="err">，</span><span class="n">实现容器的通信</span>
</code></pre></div>
<p>CNI方案</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">所有节点的内核都启用了VXLAN的功能模块</span>
    <span class="n">每个节点都启动一个cni网卡</span><span class="err">，</span><span class="n">并维护所有节点所在的网段的路由列表</span>
<span class="n">2</span> <span class="n">node上的pod发出请求到达cni0</span>
    <span class="n">根据内核的路由列表判断对端网段的节点位置</span>
    <span class="n">经由</span> <span class="n">隧道设备</span> <span class="n">对数据包进行封装标识</span><span class="err">，</span><span class="n">对端节点的隧道设备解封标识数据包</span><span class="err">，</span>
    <span class="n">当前数据包一看当前节点的路由表发现有自身的ip地址</span><span class="err">，</span><span class="n">这直接交给本地的pod</span>
<span class="n">3</span> <span class="n">多个节点上的路由表信息维护</span><span class="err">，</span><span class="n">就是各种网络解决方案的工作位置</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">我们可以部署多个网络解决方案</span><span class="err">，</span><span class="n">但是对于CNI来说</span><span class="err">，</span><span class="n">只会有一个生效</span><span class="err">。</span><span class="n">如果网络信息过多会导致冲突</span>
</code></pre></div>
<p><img alt="1633651873150" src="../../../img/kubernetes/kubernetes_flannel/1633651873150.png" /></p>
<p><strong>方案解读</strong></p>
<p>CNI插件</p>
<div class="highlight"><pre><span></span><code>    <span class="n">根据我们刚才对pod通信的回顾</span><span class="err">，</span><span class="n">多节点内的pod通信</span><span class="err">，</span><span class="n">k8s是通过CNI接口来实现网络通信的</span><span class="err">。</span><span class="n">CNI基本思想</span><span class="err">：</span><span class="n">创建容器时</span><span class="err">，</span><span class="n">先创建好网络名称空间</span><span class="err">，</span><span class="n">然后调用CNI插件配置这个网络</span><span class="err">，</span><span class="n">而后启动容器内的进程</span>

<span class="n">CNI插件类别</span><span class="err">：</span><span class="n">main</span><span class="err">、</span><span class="n">meta</span><span class="err">、</span><span class="n">ipam</span>
    <span class="n">main</span><span class="err">，</span><span class="n">实现某种特定的网络功能</span><span class="err">，</span><span class="n">如loopback</span><span class="err">、</span><span class="n">bridge</span><span class="err">、</span><span class="n">macvlan</span><span class="err">、</span><span class="n">ipvlan</span>
    <span class="n">meta</span><span class="err">，</span><span class="n">自身不提供任何网络实现</span><span class="err">，</span><span class="n">而是调用其他插件</span><span class="err">，</span><span class="n">如flannel</span>
    <span class="n">ipam</span><span class="err">，</span><span class="n">仅用于分配IP地址</span><span class="err">，</span><span class="n">不提供网络实现</span>
</code></pre></div>
<p>常见方案</p>
<div class="highlight"><pre><span></span><code><span class="n">Flannel</span>
    <span class="n">提供叠加网络</span><span class="err">，</span><span class="n">基于linux</span> <span class="n">TUN</span><span class="p">/</span><span class="n">TAP</span><span class="err">，</span><span class="n">使用UDP封装IP报文来创建叠加网络</span><span class="err">，</span><span class="n">并借助etcd维护网络分配情况</span>

<span class="n">Calico</span>
    <span class="n">基于BGP的三层网络</span><span class="err">，</span><span class="n">支持网络策略实现网络的访问控制</span><span class="err">。</span><span class="n">在每台机器上运行一个vRouter</span><span class="err">，</span><span class="n">利用内核转发数据包</span><span class="err">，</span><span class="n">并借助iptables实现防火墙等功能</span>

<span class="n">kube-router</span>
    <span class="n">K8s网络一体化解决方案</span><span class="err">，</span><span class="n">可取代kube-proxy实现基于ipvs的Service</span><span class="err">，</span><span class="n">支持网络策略</span><span class="err">、</span><span class="n">完美兼容BGP的高级特性</span> 

<span class="n">其他网络解决方案</span><span class="err">：</span>
    <span class="n">Canal</span><span class="p">:</span> <span class="n">由Flannel和Calico联合发布的一个统一网络插件</span><span class="err">，</span><span class="n">支持网络策略</span>
    <span class="n">Weave</span> <span class="n">Net</span><span class="p">:</span> <span class="n">多主机容器的网络方案</span><span class="err">，</span><span class="n">支持去中心化的控制平面</span>
    <span class="n">Contiv</span><span class="p">:</span><span class="n">思科方案</span><span class="err">，</span><span class="n">直接提供多租户网络</span><span class="err">，</span><span class="n">支持L2</span><span class="p">(</span><span class="n">VLAN</span><span class="p">)</span><span class="err">、</span><span class="n">L3</span><span class="p">(</span><span class="n">BGP</span><span class="p">)</span><span class="err">、</span><span class="n">Overlay</span><span class="p">(</span><span class="n">VXLAN</span><span class="p">)</span>

<span class="n">更多的解决方案</span><span class="err">，</span><span class="n">大家可以参考</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">concepts</span><span class="p">/</span><span class="n">cluster-administration</span><span class="p">/</span><span class="n">addons</span><span class="p">/</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="132_flannel">1.3.2 flannel<a class="headerlink" href="#132_flannel" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 信息查看、原理解读、小结 三个方面来学习。</p>
<p><strong>信息查看</strong></p>
<p>查看网络配置</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /etc/kubernetes/manifests/kube-controller-manager.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="p">...</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">command</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">kube-controller-manager</span>
    <span class="p">-</span> <span class="p">-</span><span class="n">-allocate-node-cidrs</span><span class="p">=</span><span class="n">true</span>        
    <span class="p">...</span>
    <span class="p">-</span> <span class="p">-</span><span class="n">-cluster-cidr</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
 <span class="n">配置解析</span><span class="err">：</span>
    <span class="n">allocate-node-cidrs属性表示</span><span class="err">，</span><span class="n">每增加一个新的节点</span><span class="err">，</span><span class="n">都从cluster-cidr子网中切分一个新的子网网段分配给对应的节点上</span><span class="err">。</span>
    <span class="n">这些相关的网络状态属性信息</span><span class="err">，</span><span class="n">会经过</span> <span class="n">kube-apiserver</span> <span class="n">存储到etcd中</span><span class="err">。</span>
</code></pre></div>
<p>CNI配置</p>
<div class="highlight"><pre><span></span><code>    <span class="n">使用CNI插件编排网络</span><span class="err">，</span><span class="n">Pod初始化或删除时</span><span class="err">，</span><span class="n">kubelet会调用默认CNI插件</span><span class="err">，</span><span class="n">创建虚拟设备接口附加到相关的底层网络</span><span class="err">，</span><span class="n">设置IP</span><span class="err">、</span><span class="n">路由并映射到Pod对象网络名称空间</span><span class="p">.</span>
    <span class="n">kubelet在</span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">cni</span><span class="p">/</span><span class="n">net</span><span class="p">.</span><span class="n">d目录查找cni</span> <span class="n">json配置文件</span><span class="err">，</span><span class="n">基于type属性到</span><span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">cni</span><span class="p">/</span><span class="n">bin中查找相关插件的二进制文件</span><span class="err">，</span><span class="n">然后调用相应插件设置网络</span>
</code></pre></div>
<p>网段配置</p>
<div class="highlight"><pre><span></span><code><span class="n">查看网段配置</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># cat /run/flannel/subnet.env</span>
<span class="n">FLANNEL_NETWORK</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
<span class="n">FLANNEL_SUBNET</span><span class="p">=</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">24</span>
<span class="n">FLANNEL_MTU</span><span class="p">=</span><span class="n">1450</span>
<span class="n">FLANNEL_IPMASQ</span><span class="p">=</span><span class="n">true</span>
</code></pre></div>
<p>网段分配原理</p>
<div class="highlight"><pre><span></span><code><span class="n">分配原理解读</span>
    <span class="n">集群的</span> <span class="n">kube-controller-manager</span> <span class="n">负责控制每个节点的网段分配</span>
    <span class="n">集群的</span> <span class="n">etcd</span> <span class="n">负责存储所有节点的网络配置存储</span>
    <span class="n">集群的</span> <span class="n">flannel</span> <span class="n">负责各个节点的路由表定制及其数据包的拆分和封装</span>
    <span class="p">--</span> <span class="n">所以flannel各个节点是平等的</span><span class="err">，</span><span class="n">仅负责数据平面的操作</span><span class="err">。</span><span class="n">网络功能相对来说比较简单</span><span class="err">。</span>
    <span class="n">另外一种插件</span> <span class="n">calico相对于flannel来说</span><span class="err">，</span><span class="n">多了一个控制节点</span><span class="err">，</span><span class="n">来管控所有的网络节点的服务进程</span><span class="err">。</span>
</code></pre></div>
<p>flannel网络</p>
<div class="highlight"><pre><span></span><code><span class="n">pod效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -n kube-flannel  -o wide</span>
<span class="n">NAME</span>                    <span class="n">READY</span> <span class="n">STATUS</span>    <span class="p">...</span> <span class="n">IP</span>          <span class="n">NODE</span>               <span class="p">...</span>
<span class="n">kube-flannel-ds-b6hxm</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>   <span class="n">Running</span>   <span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>   <span class="n">kubernetes-node1</span>   <span class="p">...</span>
<span class="n">kube-flannel-ds-bx7rq</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>   <span class="n">Running</span>   <span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span>   <span class="n">kubernetes-master1</span> <span class="p">...</span>
<span class="n">kube-flannel-ds-hqwrk</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>   <span class="n">Running</span>   <span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span>   <span class="n">kubernetes-master2</span> <span class="p">...</span>
<span class="n">kube-flannel-ds-npcw6</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>   <span class="n">Running</span>   <span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span>   <span class="n">kubernetes-node3</span>   <span class="p">...</span>
<span class="n">kube-flannel-ds-sx427</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>   <span class="n">Running</span>   <span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>   <span class="n">kubernetes-master3</span> <span class="p">...</span>
<span class="n">kube-flannel-ds-v5f4p</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>   <span class="n">Running</span>   <span class="p">...</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>   <span class="n">kubernetes-node2</span>   <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">网卡效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># for i in {12..17};do ssh root@10.0.0.$i ifconfig | grep -A1 flannel ;done</span>
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
<span class="n">flannel</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">flags</span><span class="p">=</span><span class="n">4163</span><span class="p">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">&gt;</span>  <span class="n">mtu</span> <span class="n">1450</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">后面的</span><span class="p">.</span><span class="n">1</span> <span class="n">就是</span> <span class="n">vxlan的网络标识</span><span class="err">。</span><span class="n">便于隧道正常通信</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">路由效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># ip route list | grep flannel</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
</code></pre></div>
<p><strong>原理解读</strong></p>
<p>flannel模型</p>
<div class="highlight"><pre><span></span><code><span class="n">vxlan模型</span>
    <span class="n">pod与Pod经由隧道封装后通信</span><span class="err">，</span><span class="n">各节点彼此间能通信就行</span><span class="err">，</span><span class="n">不要求在同一个二层网络</span>
    <span class="n">这是默认采用的方式</span>
<span class="n">host-gw模型</span>
    <span class="n">Pod与Pod不经隧道封装而直接通信</span><span class="err">，</span><span class="n">要求各节点位于同一个二层网络</span>   

<span class="n">vxlan</span> <span class="n">directrouting模型</span>
    <span class="n">它是vxlan和host-gw自由组合的一种模型</span>
    <span class="n">位于同一个二层网络上的</span><span class="err">、</span><span class="n">但不同节点上的Pod间通信</span><span class="err">，</span><span class="n">无须隧道封装</span><span class="err">；</span><span class="n">但非同一个二层网络上的节点上的Pod间通信</span><span class="err">，</span><span class="n">仍须隧道封装</span>
</code></pre></div>
<p><img alt="image-20220722073310706" src="../../../img/kubernetes/kubernetes_flannel/image-20220722073310706.png" /></p>
<p>vxlan原理</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">节点上的pod通过虚拟网卡对</span><span class="err">，</span><span class="n">连接到cni0的虚拟网络交换机上</span>
    <span class="n">当有外部网络通信的时候</span><span class="err">，</span><span class="n">借助于</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1网卡向外发出数据包</span>
<span class="n">2</span> <span class="n">经过</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">网卡的数据包</span><span class="err">，</span><span class="n">借助于flanneld实现数据包的封装和解封</span>
    <span class="n">最后送给宿主机的物理接口</span><span class="err">，</span><span class="n">发送出去</span>
<span class="n">3</span> <span class="n">对于pod来说</span><span class="err">，</span><span class="n">它以为是通过</span> <span class="n">flannel</span><span class="p">.</span><span class="n">x</span> <span class="p">-&gt;</span> <span class="n">vxlan</span> <span class="n">tunnel</span> <span class="p">-&gt;</span> <span class="n">flannel</span><span class="p">.</span><span class="n">x</span> <span class="n">实现数据通信</span>
    <span class="n">因为它们的隧道标识都是</span><span class="s2">&quot;.1&quot;</span><span class="err">，</span><span class="n">所以认为是一个vxlan</span><span class="err">，</span><span class="n">直接路由过去了</span><span class="err">，</span><span class="n">没有意识到底层的通信机制</span><span class="err">。</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">由于这种方式</span><span class="err">，</span><span class="n">是对数据报文进行了多次的封装</span><span class="err">，</span><span class="n">降低了当个数据包的有效载荷</span><span class="err">。</span><span class="n">所以效率降低了</span>
</code></pre></div>
<p>host-gw原理</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">节点上的pod通过虚拟网卡对</span><span class="err">，</span><span class="n">连接到cni0的虚拟网络交换机上</span><span class="err">。</span>
<span class="n">2</span> <span class="n">pod向外通信的时候</span><span class="err">，</span><span class="n">到达CNI0的时候</span><span class="err">，</span><span class="n">不再直接交给flannel</span><span class="p">.</span><span class="n">1由flanneld来进行打包处理了</span><span class="err">。</span>
<span class="n">3</span> <span class="n">cni0直接借助于内核中的路由表</span><span class="err">，</span><span class="n">通过宿主机的网卡交给同网段的其他主机节点</span>
<span class="n">4</span> <span class="n">对端节点查看内核中的路由表</span><span class="err">，</span><span class="n">发现目标就是当前节点</span><span class="err">，</span><span class="n">所以交给对应的cni0</span><span class="err">，</span><span class="n">进而找到对应的pod</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="133_1">1.3.3 主机网络<a class="headerlink" href="#133_1" title="Permanent link">&para;</a></h3>
<p>学习目标</p>
<p>这一节，我们从 配置解读、简单实践、小结 三个方面来学习。</p>
<p><strong>配置解读</strong></p>
<p>配置文件</p>
<div class="highlight"><pre><span></span><code><span class="n">我们在部署flannel的时候</span><span class="err">，</span><span class="n">有一个配置文件</span><span class="err">，</span><span class="n">在这个配置文件中的configmap中就定义了虚拟网络的接入功能</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># cat kube-flannel.yml</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="p">...</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">cni-conf</span><span class="p">.</span><span class="n">json</span><span class="p">:</span> <span class="p">|</span>                      <span class="n">cni插件的功能配置</span>
    <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cbr0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;cniVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;0.3.1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;flannel&quot;</span><span class="p">,</span>            <span class="n">基于flannel实现网络通信</span>
          <span class="s2">&quot;delegate&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;hairpinMode&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
            <span class="s2">&quot;isDefaultGateway&quot;</span><span class="p">:</span> <span class="n">true</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;portmap&quot;</span><span class="p">,</span>            <span class="n">来实现端口映射的功能</span>
          <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;portMappings&quot;</span><span class="p">:</span> <span class="n">true</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="n">net-conf</span><span class="p">.</span><span class="n">json</span><span class="p">:</span> <span class="p">|</span>                      <span class="n">flannel的网址分配</span>            
    <span class="p">{</span>
      <span class="s2">&quot;Network&quot;</span><span class="p">:</span> <span class="s2">&quot;10.244.0.0/16&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Backend&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;vxlan&quot;</span>                 <span class="n">来新节点的时候</span><span class="err">，</span><span class="n">基于vxlan从network中获取子网</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>路由表信息</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># ip route list | grep flannel</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">onlink</span>

<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">如果数据包的目标是当前节点</span><span class="err">，</span><span class="n">这直接通过cni来进行处理</span>
    <span class="n">如果数据包的目标是其他节点</span><span class="err">，</span><span class="n">这根据路由配置</span><span class="err">，</span><span class="n">交给对应节点上的flannel</span><span class="p">.</span><span class="n">1网卡来进行处理</span>
        <span class="n">然后交给配套的flanneld对数据包进行封装</span>
</code></pre></div>
<p>数据包转发解析</p>
<div class="highlight"><pre><span></span><code><span class="n">发现目标地址</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># ip neigh | grep flannel</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">lladdr</span> <span class="n">ca</span><span class="p">:</span><span class="n">d2</span><span class="p">:</span><span class="n">1b</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">40</span><span class="p">:</span><span class="n">c2</span> <span class="n">PERMANENT</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">lladdr</span> <span class="n">92</span><span class="p">:</span><span class="n">d8</span><span class="p">:</span><span class="n">04</span><span class="p">:</span><span class="n">76</span><span class="p">:</span><span class="n">cf</span><span class="p">:</span><span class="n">af</span> <span class="n">PERMANENT</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">lladdr</span> <span class="n">ae</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">68</span><span class="p">:</span><span class="n">7d</span><span class="p">:</span><span class="n">fa</span><span class="p">:</span><span class="n">31</span> <span class="n">PERMANENT</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">lladdr</span> <span class="n">c2</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="n">a6</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="n">04</span> <span class="n">PERMANENT</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">lladdr</span> <span class="n">ee</span><span class="p">:</span><span class="n">dd</span><span class="p">:</span><span class="n">92</span><span class="p">:</span><span class="n">60</span><span class="p">:</span><span class="n">41</span><span class="p">:</span><span class="n">8a</span> <span class="n">PERMANENT</span>

<span class="n">转发给指定主机</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">flannel</span><span class="p">]</span><span class="c"># bridge fdb show flannel.1 | grep flannel.1</span>
<span class="n">ee</span><span class="p">:</span><span class="n">dd</span><span class="p">:</span><span class="n">92</span><span class="p">:</span><span class="n">60</span><span class="p">:</span><span class="n">41</span><span class="p">:</span><span class="n">8a</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">dst</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">self</span> <span class="n">permanent</span>
<span class="n">ae</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">68</span><span class="p">:</span><span class="n">7d</span><span class="p">:</span><span class="n">fa</span><span class="p">:</span><span class="n">31</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">dst</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">self</span> <span class="n">permanent</span>
<span class="n">c2</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="n">a6</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="n">04</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">dst</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">self</span> <span class="n">permanent</span>
<span class="n">ca</span><span class="p">:</span><span class="n">d2</span><span class="p">:</span><span class="n">1b</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">40</span><span class="p">:</span><span class="n">c2</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">dst</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">self</span> <span class="n">permanent</span>
<span class="n">92</span><span class="p">:</span><span class="n">d8</span><span class="p">:</span><span class="n">04</span><span class="p">:</span><span class="n">76</span><span class="p">:</span><span class="n">cf</span><span class="p">:</span><span class="n">af</span> <span class="n">dev</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span> <span class="n">dst</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="n">self</span> <span class="n">permanent</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">准备工作</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl scale deployment nginx --replicas=1</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="p">/</span><span class="n">nginx</span> <span class="n">scaled</span>

<span class="n">开启测试容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl run flannel-test --image=&quot;kubernetes-register.superopsmsb.com/superopsmsb/busybox:1.28&quot; -it --rm --command -- /bin/sh</span>

<span class="n">pod现状</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -o wide</span>
<span class="n">NAME</span>                  <span class="p">...</span>  <span class="n">IP</span>           <span class="n">NODE</span>             <span class="p">...</span>
<span class="n">flannel-test</span>          <span class="p">...</span>  <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span>   <span class="n">kubernetes-node1</span> <span class="p">...</span>
<span class="n">nginx-fd669dcb-h5d9d</span>  <span class="p">...</span>  <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span>   <span class="n">kubernetes-node3</span> <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">测试容器发送测试数据</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl run flannel-test --image=&quot;kubernetes-register.superopsmsb.com/superopsmsb/busybox:1.28&quot; -it --rm --command -- /bin/sh</span>
<span class="k">If</span> <span class="n">you</span> <span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">see</span> <span class="n">a</span> <span class="n">command</span> <span class="n">prompt</span><span class="p">,</span> <span class="k">try</span> <span class="n">pressing</span> <span class="n">enter</span><span class="p">.</span>
<span class="p">/</span> <span class="c"># ping -c 1 10.244.3.2</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">):</span> <span class="n">56</span> <span class="n">data</span> <span class="n">bytes</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">:</span> <span class="n">seq</span><span class="p">=</span><span class="n">0</span> <span class="n">ttl</span><span class="p">=</span><span class="n">62</span> <span class="n">time</span><span class="p">=</span><span class="n">1</span><span class="p">.</span><span class="n">479</span> <span class="n">ms</span>
<span class="p">...</span>

<span class="n">Flannel默认使用8285端口作为UDP封装报文的端口</span><span class="err">，</span><span class="n">VxLan使用8472端口</span><span class="p">,</span><span class="n">我们在node3上抓取node1的数据包</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node3</span> <span class="p">~]</span><span class="c"># tcpdump -i eth0 -en host 10.0.0.15  and udp port 8472</span>
<span class="p">...</span>
<span class="n">07</span><span class="p">:</span><span class="n">46</span><span class="p">:</span><span class="n">40</span><span class="p">.</span><span class="n">104526</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">37</span><span class="p">:</span><span class="n">14</span><span class="p">:</span><span class="n">42</span> <span class="p">&gt;</span> <span class="n">00</span><span class="p">:</span><span class="n">50</span><span class="p">:</span><span class="n">56</span><span class="p">:</span><span class="n">37</span><span class="p">:</span><span class="n">ed</span><span class="p">:</span><span class="n">73</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">IPv4</span> <span class="p">(</span><span class="n">0x0800</span><span class="p">),</span> <span class="n">length</span> <span class="n">148</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span><span class="p">.</span><span class="n">53162</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span><span class="p">.</span><span class="n">otv</span><span class="p">:</span> <span class="n">OTV</span><span class="p">,</span> <span class="n">flags</span> <span class="no">[I]</span> <span class="p">(</span><span class="n">0x08</span><span class="p">),</span> <span class="n">overlay</span> <span class="n">0</span><span class="p">,</span> <span class="n">instance</span> <span class="n">1</span>
<span class="n">ee</span><span class="p">:</span><span class="n">dd</span><span class="p">:</span><span class="n">92</span><span class="p">:</span><span class="n">60</span><span class="p">:</span><span class="n">41</span><span class="p">:</span><span class="n">8a</span> <span class="p">&gt;</span> <span class="n">ae</span><span class="p">:</span><span class="n">08</span><span class="p">:</span><span class="n">68</span><span class="p">:</span><span class="n">7d</span><span class="p">:</span><span class="n">fa</span><span class="p">:</span><span class="n">31</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">IPv4</span> <span class="p">(</span><span class="n">0x0800</span><span class="p">),</span> <span class="n">length</span> <span class="n">98</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">:</span> <span class="n">ICMP</span> <span class="nb">echo </span><span class="n">reply</span><span class="p">,</span> <span class="n">id</span> <span class="n">1792</span><span class="p">,</span> <span class="n">seq</span> <span class="n">0</span><span class="p">,</span> <span class="n">length</span> <span class="n">64</span>

<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">这里面每一条数据</span><span class="err">，</span><span class="n">都包括了两层ip数据包</span>
</code></pre></div>
<p>host-gw实践</p>
<div class="highlight"><pre><span></span><code><span class="n">修改flannel的配置文件</span><span class="err">，</span><span class="n">将其转换为</span> <span class="n">host-gw</span> <span class="n">模型</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get cm -n kube-flannel</span>
<span class="n">NAME</span>               <span class="n">DATA</span>   <span class="n">AGE</span>
<span class="n">kube-flannel-cfg</span>   <span class="n">2</span>      <span class="n">82m</span>

<span class="n">修改资源配置文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  edit cm kube-flannel-cfg -n kube-flannel</span>
<span class="p">...</span>
  <span class="n">net-conf</span><span class="p">.</span><span class="n">json</span><span class="p">:</span> <span class="p">|</span>
    <span class="p">{</span>
      <span class="s2">&quot;Network&quot;</span><span class="p">:</span> <span class="s2">&quot;10.244.0.0/16&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Backend&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;host-gw&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>

<span class="n">重启pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  delete pod -n kube-flannel -l app</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl get pod -n kube-flannel</span>
<span class="n">NAME</span>                    <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube-flannel-ds</span><span class="p">-</span><span class="n">5dw2r</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">21s</span>
<span class="n">kube-flannel-ds-d9bh2</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">21s</span>
<span class="n">kube-flannel-ds-jvn2f</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">21s</span>
<span class="n">kube-flannel-ds-kcrb4</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">22s</span>
<span class="n">kube-flannel-ds-ptlx8</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">21s</span>
<span class="n">kube-flannel-ds-wxqd7</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">22s</span>
</code></pre></div>
<p>检查信息</p>
<div class="highlight"><pre><span></span><code><span class="n">查看路由信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># ip route list | grep 244</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">dev</span> <span class="n">eth0</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">dev</span> <span class="n">eth0</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">dev</span> <span class="n">eth0</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">dev</span> <span class="n">eth0</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="n">dev</span> <span class="n">eth0</span>

<span class="n">在flannel-test中继续wget测试</span>
<span class="p">/</span> <span class="c"># wget 10.244.3.2</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">:</span><span class="n">80</span><span class="p">)</span>
<span class="n">index</span><span class="p">.</span><span class="n">html</span>           <span class="n">100</span><span class="p">%</span> <span class="p">|***|</span>    <span class="n">41</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span><span class="p">:</span><span class="n">00</span> <span class="n">ETA</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在node3中继续抓包</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node3</span> <span class="p">~]</span><span class="c"># tcpdump -i eth0 -nn host 10.244.1.4 and tcp port 80</span>
<span class="p">...</span>
<span class="n">08</span><span class="p">:</span><span class="n">01</span><span class="p">:</span><span class="n">46</span><span class="p">.</span><span class="n">930340</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">80</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">59026</span><span class="p">:</span> <span class="n">Flags</span> <span class="no">[FP.]</span><span class="p">,</span> <span class="n">seq</span> <span class="n">232</span><span class="p">:</span><span class="n">273</span><span class="p">,</span> <span class="n">ack</span> <span class="n">74</span><span class="p">,</span> <span class="n">win</span> <span class="n">56</span><span class="p">,</span> <span class="n">length</span> <span class="n">41</span><span class="p">:</span> <span class="n">HTTP</span>
<span class="n">08</span><span class="p">:</span><span class="n">01</span><span class="p">:</span><span class="n">46</span><span class="p">.</span><span class="n">930481</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">59026</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">80</span><span class="p">:</span> <span class="n">Flags</span> <span class="p">[.],</span> <span class="n">ack</span> <span class="n">232</span><span class="p">,</span> <span class="n">win</span> <span class="n">58</span><span class="p">,</span> <span class="n">length</span> <span class="n">0</span>
<span class="n">08</span><span class="p">:</span><span class="n">01</span><span class="p">:</span><span class="n">46</span><span class="p">.</span><span class="n">931619</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">59026</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">80</span><span class="p">:</span> <span class="n">Flags</span> <span class="no">[F.]</span><span class="p">,</span> <span class="n">seq</span> <span class="n">74</span><span class="p">,</span> <span class="n">ack</span> <span class="n">274</span><span class="p">,</span> <span class="n">win</span> <span class="n">58</span><span class="p">,</span> <span class="n">length</span> <span class="n">0</span>
<span class="n">08</span><span class="p">:</span><span class="n">01</span><span class="p">:</span><span class="n">46</span><span class="p">.</span><span class="n">931685</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">80</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">59026</span><span class="p">:</span> <span class="n">Flags</span> <span class="p">[.],</span> <span class="n">ack</span> <span class="n">75</span><span class="p">,</span> <span class="n">win</span> <span class="n">56</span><span class="p">,</span> <span class="n">length</span> <span class="n">0</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">两个pod形成了直接的通信效果</span><span class="err">。</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      BurningMyself<a href='https://beian.miit.gov.cn/' target='_blank'>  蜀ICP备15033200号-1</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/burningmyself" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitee.com/burningmyself" target="_blank" rel="noopener" title="gitee.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155084439-1"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155132293-1"></script>
      
        <script src="../../../js/google.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>