
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content=".net,java,php,python,docker,web">
      
      
        <meta name="author" content="BurningMyself">
      
      
        <link rel="canonical" href="https://burningmyself.gitee.io/cloud/kubernetes/kubernetes_hight_bin1/">
      
      
        <link rel="prev" href="../kubernetes_rke/">
      
      
        <link rel="next" href="../kubernetes_hight_bin2/">
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>Kubernetes高可用集群二进制部署（Runtime Docker）一 - BurningMyself</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetesruntime_docker" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="BurningMyself" class="md-header__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BurningMyself
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kubernetes高可用集群二进制部署（Runtime Docker）一
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BurningMyself" class="md-nav__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BurningMyself
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          技术博文
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          技术博文
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          .NET
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          .NET
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sharp/" class="md-nav__link">
        C#新特性语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_docker/" class="md-nav__link">
        .Net Core Docker 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sqlserver_nginx/" class="md-nav__link">
        Docker 容器化部署 ASP.NET Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_safety/" class="md-nav__link">
        让你的ASP.NET Core应用程序更安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_study_route/" class="md-nav__link">
        ASP.NET Core开发者指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/feature/" class="md-nav__link">
        Java特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/load-class/" class="md-nav__link">
        Java类加载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/orm/" class="md-nav__link">
        Orm的优缺点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/bio-nio/" class="md-nav__link">
        BIO与NIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/rocketmq/rmq-1/" class="md-nav__link">
        RocketMq下载与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springAnnotation/" class="md-nav__link">
        Spring常用注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/javavm/" class="md-nav__link">
        Java 虚拟机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springdesign/" class="md-nav__link">
        Spring 常用设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/spring-cloud/" class="md-nav__link">
        Spring Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-simple/" class="md-nav__link">
        Java simple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-validator/" class="md-nav__link">
        Java Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-string/" class="md-nav__link">
        Java String
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-utils/" class="md-nav__link">
        Java Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/feature/" class="md-nav__link">
        Python特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/str_joint/" class="md-nav__link">
        Python字符拼接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/syntax_rule/" class="md-nav__link">
        Python语法技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/fabric/" class="md-nav__link">
        远程部署神器 Fabric
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          Go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../go/go_base/" class="md-nav__link">
        Go基础语法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          PHP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          PHP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../php/kj/" class="md-nav__link">
        框架
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/es6/" class="md-nav__link">
        es6语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/ali_js_style/" class="md-nav__link">
        阿里js样式规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/node.js/" class="md-nav__link">
        node.js文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react/" class="md-nav__link">
        React 开发者指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../dart/syntax/" class="md-nav__link">
        Dart语法学习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react_interview/" class="md-nav__link">
        React 面试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/js_tool_method/" class="md-nav__link">
        js 工具函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/vue_cp_react/" class="md-nav__link">
        vue与react比较
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/javascript/" class="md-nav__link">
        JavaScript 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh17/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_log/" class="md-nav__link">
        MySQL日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_index/" class="md-nav__link">
        MySQL索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_pxc/" class="md-nav__link">
        MySQL PXC集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_use/" class="md-nav__link">
        MySQL 数据库应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_backups/" class="md-nav__link">
        MySql 备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/sql_server_master/" class="md-nav__link">
        Sql Server 主从备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/data_split/" class="md-nav__link">
        数据库之互联网常用分库分表方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mybatis/" class="md-nav__link">
        Mybatis使用心德
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/linux/" class="md-nav__link">
        Linux学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/often/" class="md-nav__link">
        常用命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/ope/" class="md-nav__link">
        实用的Linux 命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker/" class="md-nav__link">
        Docker全科
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker_core/" class="md-nav__link">
        Docker 核心技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-compose/" class="md-nav__link">
        docker和docker-compose配置常用环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-jenkins/" class="md-nav__link">
        Docker部署Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-phabricator/" class="md-nav__link">
        Docker部署Phabricator
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_fw_rule_and_object_design/" class="md-nav__link">
        Kubernetes架构原则和对象设计
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
      
      
      
        <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
          Tool
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_11">
          <span class="md-nav__icon md-icon"></span>
          Tool
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitusual/" class="md-nav__link">
        Git动画展示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitquestion/" class="md-nav__link">
        Git问题处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitflow/" class="md-nav__link">
        GitFlow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitbook/" class="md-nav__link">
        GitBook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitcmr/" class="md-nav__link">
        Git提交日志规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/markdown/" class="md-nav__link">
        Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cicd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/mkdocs/" class="md-nav__link">
        mkdocs简单使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitstudy/" class="md-nav__link">
        Git的黑魔法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/minio/" class="md-nav__link">
        MinIO 搭建使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cat-monitoring/" class="md-nav__link">
        Cat分布式监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          云架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          云架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../native/" class="md-nav__link">
        云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../virtual/" class="md-nav__link">
        虚拟化技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compute/" class="md-nav__link">
        云计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprelease/" class="md-nav__link">
        应用部署容器化演进
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlinux/" class="md-nav__link">
        容器技术所涉及Linux内核关键技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_native/" class="md-nav__link">
        容器管理工具Docker生态架构及部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_nginx/" class="md-nav__link">
        使用容器运行Nginx应用及Docker命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image/" class="md-nav__link">
        Docker容器镜像
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image_fast/" class="md-nav__link">
        Docker容器镜像加速器及本地容器镜像仓库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container_enterprice/" class="md-nav__link">
        Docker容器化部署企业级应用集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_file/" class="md-nav__link">
        Dockerfile精讲及新型容器镜像构建技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_network/" class="md-nav__link">
        Docker容器网络与通信原理深度解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_date/" class="md-nav__link">
        Docker容器数据持久化存储机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_compose/" class="md-nav__link">
        Docker容器服务编排利器Docker Compose应用实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_swarm/" class="md-nav__link">
        Docker主机集群化方案 Docker Swarm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_devops/" class="md-nav__link">
        基于Docker容器DevOps应用方案 企业业务代码发布系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container/" class="md-nav__link">
        轻量级或工业级容器管理工具
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        kubeadm极速部署Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_introduce/" class="md-nav__link">
        kubernetes介绍与集群架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_way/" class="md-nav__link">
        Kubernetes集群部署方式说明
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_master/" class="md-nav__link">
        kubeadm部署单Master节点kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight/" class="md-nav__link">
        kubeadm部署高可用kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rke/" class="md-nav__link">
        使用RKE构建企业生产级Kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Kubernetes高可用集群二进制部署（Runtime Docker）一
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin2/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）二
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        Kubernetes集群UI及主机资源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_sealos/" class="md-nav__link">
        使用sealos部署kubernetes集群并实现集群管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        kubernetes集群命令语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_core/" class="md-nav__link">
        Kubernetes核心概念
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_nginx_ingress_controller/" class="md-nav__link">
        Kubernetes集群 服务暴露 Nginx Ingress Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_traefik/" class="md-nav__link">
        Kubernetes集群 服务暴露 Traefik
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_configMap_secret/" class="md-nav__link">
        Kubernetes配置与密钥管理 ConfigMap&Secret
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_harbor/" class="md-nav__link">
        Kubernetes集群使用容器镜像仓库Harbor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_safety/" class="md-nav__link">
        Kubernetes集群安全管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_volume/" class="md-nav__link">
        kubernetes持久化存储卷
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_ceph/" class="md-nav__link">
        kubernetes存储解决方案Ceph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster_serve/" class="md-nav__link">
        Kubernetes集群公共服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_java/" class="md-nav__link">
        kubernetes集群java项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_python/" class="md-nav__link">
        kubernetes集群Python项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_golang/" class="md-nav__link">
        Kubernetes集群golang项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_logs_collect/" class="md-nav__link">
        kubernetes日志收集方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_zookeeper/" class="md-nav__link">
        企业级中间件上云部署 zookeeper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kafka/" class="md-nav__link">
        kubernetes云原生中间件上云部署 kafka
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rokectmq/" class="md-nav__link">
        rocketmq部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_helm/" class="md-nav__link">
        Kubernetes集群包管理解决方案 Helm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kustomize/" class="md-nav__link">
        Kubernetes原生配置管理利器 kustomize
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_flannel/" class="md-nav__link">
        kubernetes集群网络解决方案 flannel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_calico/" class="md-nav__link">
        kubernetes集群网络解决方案 calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hybridnet/" class="md-nav__link">
        kubernetes集群 underlay 网络方案 hybridnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ipv4_and_ipv6/" class="md-nav__link">
        kubernetes版本双栈协议（IPv4&IPv6）集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rancher/" class="md-nav__link">
        Rancher容器云管理平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubeconfig/" class="md-nav__link">
        使用kubeconfig管理多集群方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_karmada/" class="md-nav__link">
        karmada实现k8s集群联邦
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_csdn/" class="md-nav__link">
        《将博客搬至CSDN》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          微服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          微服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/fbs-lock/" class="md-nav__link">
        分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/design/" class="md-nav__link">
        微服务设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/distrimsg/" class="md-nav__link">
        分布式系统与消息的投递
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/ddd/" class="md-nav__link">
        基于DDD的微服务设计和开发实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/kafka/" class="md-nav__link">
        Kafka架构原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/redis_cluster/" class="md-nav__link">
        Redis Cluster原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/spring-cloud-micro/" class="md-nav__link">
        分布式架构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          经验分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          经验分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/devops/" class="md-nav__link">
        DevOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/micro-service/" class="md-nav__link">
        Micro-Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/raft-gossip/" class="md-nav__link">
        Raft算法和Gossip协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cl/" class="md-nav__link">
        集群和负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/ai/" class="md-nav__link">
        人工智能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/code-principle/" class="md-nav__link">
        代码原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/techbig/" class="md-nav__link">
        如何成为技术大牛
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/learnweetout/" class="md-nav__link">
        程序员如何技术成长
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/pt/" class="md-nav__link">
        产品与技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/four_deep_learning/" class="md-nav__link">
        深度学习框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/tl/" class="md-nav__link">
        在阿里做了5年技术Leader，我总结出这些套路！
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cto/" class="md-nav__link">
        CTO 技能图谱
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          构架
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          构架
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/split/" class="md-nav__link">
        构架拆分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fgb/" class="md-nav__link">
        分布式、高并发、多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/agility/" class="md-nav__link">
        如何理解敏捷开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fwork/" class="md-nav__link">
        走向架构师必备的技能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/data_middle/" class="md-nav__link">
        数据中台的思考与总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/algorithm-ten/" class="md-nav__link">
        必学的 10 大算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          情感
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          情感
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/eq/" class="md-nav__link">
        情商
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/workheard/" class="md-nav__link">
        工作心得
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lookbook/" class="md-nav__link">
        看书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/selfdiscipline/" class="md-nav__link">
        自律
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/livefail/" class="md-nav__link">
        为什么活着失败
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/emotion/" class="md-nav__link">
        情绪管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/losecome/" class="md-nav__link">
        所有的失去，都会以另一种方式归来
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/threeheart/" class="md-nav__link">
        人生有这三种好心态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/onepath/" class="md-nav__link">
        余生，学会一个人走，不管有没有人陪
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/twopath/" class="md-nav__link">
        往后余生还很精彩，别被熬夜拖垮了
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lifetime/" class="md-nav__link">
        心态好的人，一辈子都好
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="kubernetesruntime_docker">Kubernetes高可用集群二进制部署（Runtime Docker）<a class="headerlink" href="#kubernetesruntime_docker" title="Permanent link">&para;</a></h1>
<p>Kubernetes（简称为：k8s）是Google在2014年6月开源的一个容器集群管理系统，使用Go语言开发，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效,Kubernetes提供了资源调度、部署管理、服务发现、扩容缩容、监控，维护等一整套功能，努力成为跨主机集群的自动部署、扩展以及运行应用程序容器的平台。 它支持一系列容器工具, 包括Docker、Containerd等。</p>
<h1 id="_1">一、集群环境准备<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="11">1.1 主机规划<a class="headerlink" href="#11" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>主机IP地址</th>
<th>主机名</th>
<th>主机配置</th>
<th>主机角色</th>
<th>软件列表</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.10.12</td>
<td>k8s-master1</td>
<td>2C4G</td>
<td>master</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy、docker-ce</td>
</tr>
<tr>
<td>192.168.10.13</td>
<td>k8s-master2</td>
<td>2C4G</td>
<td>master</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy、docker-ce</td>
</tr>
<tr>
<td>192.168.10.14</td>
<td>k8s-master3</td>
<td>2C4G</td>
<td>master</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy、docker-ce</td>
</tr>
<tr>
<td>192.168.10.15</td>
<td>k8s-worker1</td>
<td>2C4G</td>
<td>worker</td>
<td>kubelet、kube-proxy、docker-ce</td>
</tr>
<tr>
<td>192.168.10.10</td>
<td>ha1</td>
<td>1C2G</td>
<td>LB</td>
<td>haproxy、keepalived</td>
</tr>
<tr>
<td>192.168.10.11</td>
<td>ha2</td>
<td>1C2G</td>
<td>LB</td>
<td>haproxy、keepalived</td>
</tr>
<tr>
<td>192.168.10.100</td>
<td>/</td>
<td>/</td>
<td>VIP(虚拟IP)</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="12">1.2 软件版本<a class="headerlink" href="#12" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>软件名称</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS7</td>
<td>kernel版本：5.16</td>
<td></td>
</tr>
<tr>
<td>kubernetes</td>
<td>v1.21.10</td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td>v3.5.2</td>
<td>最新版本</td>
</tr>
<tr>
<td>calico</td>
<td>v3.19.4</td>
<td></td>
</tr>
<tr>
<td>coredns</td>
<td>v1.8.4</td>
<td></td>
</tr>
<tr>
<td>docker-ce</td>
<td>20.10.13</td>
<td>YUM源默认</td>
</tr>
<tr>
<td>haproxy</td>
<td>5.18</td>
<td>YUM源默认</td>
</tr>
<tr>
<td>keepalived</td>
<td>3.5</td>
<td>YUM源默认</td>
</tr>
</tbody>
</table>
<h2 id="13">1.3 网络分配<a class="headerlink" href="#13" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>网络名称</th>
<th>网段</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node网络</td>
<td>192.168.10.0/24</td>
<td></td>
</tr>
<tr>
<td>Service网络</td>
<td>10.96.0.0/16</td>
<td></td>
</tr>
<tr>
<td>Pod网络</td>
<td>10.244.0.0/16</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="_2">二、集群部署<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h1>
<h2 id="21">2.1主机准备<a class="headerlink" href="#21" title="Permanent link">&para;</a></h2>
<h3 id="211">2.1.1 主机名设置<a class="headerlink" href="#211" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">hostnamectl</span> <span class="nb">set-hostname</span> <span class="n">xxx</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">关于主机名参见1</span><span class="p">.</span><span class="n">1小节主机规划表</span>
</code></pre></div>
<h3 id="212_ip">2.1.2 主机与IP地址解析<a class="headerlink" href="#212_ip" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">hosts</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">ha1</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">11</span> <span class="n">ha2</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span> <span class="n">k8s-master1</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">13</span> <span class="n">k8s-master2</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span> <span class="n">k8s-master3</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">15</span> <span class="n">k8s-worker1</span>
<span class="n">EOF</span>
</code></pre></div>
<h3 id="213">2.1.3 主机安全设置<a class="headerlink" href="#213" title="Permanent link">&para;</a></h3>
<h4 id="2131">2.1.3.1 关闭防火墙<a class="headerlink" href="#2131" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">firewalld</span>
<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">firewalld</span>
<span class="n">firewall-cmd</span> <span class="p">-</span><span class="n">-state</span>
</code></pre></div>
<h4 id="2132_selinux">2.1.3.2 关闭selinux<a class="headerlink" href="#2132_selinux" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">setenforce</span> <span class="n">0</span>
<span class="n">sed</span> <span class="n">-ri</span> <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">selinux</span><span class="p">/</span><span class="n">config</span>
<span class="n">sestatus</span>
</code></pre></div>
<h3 id="214">2.1.4 交换分区设置<a class="headerlink" href="#214" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">swapoff</span> <span class="n">-a</span>
<span class="n">sed</span> <span class="n">-ri</span> <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
<span class="nb">echo </span><span class="s2">&quot;vm.swappiness=0&quot;</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="n">-p</span>
</code></pre></div>
<h3 id="215">2.1.5 主机系统时间同步<a class="headerlink" href="#215" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">安装软件</span>
<span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">ntpdate</span>

<span class="n">制定时间同步计划任务</span>
<span class="n">crontab</span> <span class="n">-e</span>
<span class="n">0</span> <span class="p">*/</span><span class="n">1</span> <span class="p">*</span> <span class="p">*</span> <span class="p">*</span> <span class="n">ntpdate</span> <span class="n">time1</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<h3 id="216">2.1.6 主机系统优化<a class="headerlink" href="#216" title="Permanent link">&para;</a></h3>
<blockquote>
<p>limit优化</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">ulimit</span> <span class="n">-SHn</span> <span class="n">65535</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">security</span><span class="p">/</span><span class="n">limits</span><span class="p">.</span><span class="n">conf</span>
<span class="p">*</span> <span class="n">soft</span> <span class="n">nofile</span> <span class="n">655360</span>
<span class="p">*</span> <span class="n">hard</span> <span class="n">nofile</span> <span class="n">131072</span>
<span class="p">*</span> <span class="n">soft</span> <span class="n">nproc</span> <span class="n">655350</span>
<span class="p">*</span> <span class="n">hard</span> <span class="n">nproc</span> <span class="n">655350</span>
<span class="p">*</span> <span class="n">soft</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="p">*</span> <span class="n">hard</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="n">EOF</span>
</code></pre></div>
<h3 id="217_ipvs">2.1.7 ipvs管理工具安装及模块加载<a class="headerlink" href="#217_ipvs" title="Permanent link">&para;</a></h3>
<blockquote>
<p>为集群节点安装，负载均衡节点不用安装</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">ipvsadm</span> <span class="n">ipset</span> <span class="n">sysstat</span> <span class="n">conntrack</span> <span class="n">libseccomp</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有节点配置ipvs模块</span><span class="err">，</span><span class="n">在内核4</span><span class="p">.</span><span class="n">19</span><span class="p">+</span><span class="n">版本nf_conntrack_ipv4已经改为nf_conntrack</span><span class="err">，</span> <span class="n">4</span><span class="p">.</span><span class="n">18以下使用nf_conntrack_ipv4即可</span><span class="err">：</span> 

<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_rr</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_wrr</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_sh</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">nf_conntrack</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">modules-load</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">ipvs</span><span class="p">.</span><span class="n">conf</span> <span class="n">并加入以下内容</span><span class="err">：</span> 
<span class="nb">cat </span><span class="p">&gt;/</span><span class="n">etc</span><span class="p">/</span><span class="n">modules-load</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">ipvs</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span> 
<span class="n">ip_vs</span> 
<span class="n">ip_vs_lc</span> 
<span class="n">ip_vs_wlc</span> 
<span class="n">ip_vs_rr</span> 
<span class="n">ip_vs_wrr</span> 
<span class="n">ip_vs_lblc</span> 
<span class="n">ip_vs_lblcr</span> 
<span class="n">ip_vs_dh</span> 
<span class="n">ip_vs_sh</span> 
<span class="n">ip_vs_fo</span> 
<span class="n">ip_vs_nq</span> 
<span class="n">ip_vs_sed</span> 
<span class="n">ip_vs_ftp</span> 
<span class="n">ip_vs_sh</span> 
<span class="n">nf_conntrack</span> 
<span class="n">ip_tables</span> 
<span class="n">ip_set</span> 
<span class="n">xt_set</span> 
<span class="n">ipt_set</span> 
<span class="n">ipt_rpfilter</span> 
<span class="n">ipt_REJECT</span> 
<span class="n">ipip</span> 
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">设置为开机启动</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">systemd-modules-load</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<h3 id="218_linux">2.1.8 Linux内核升级<a class="headerlink" href="#218_linux" title="Permanent link">&para;</a></h3>
<blockquote>
<p>在所有节点中安装,需要重新操作系统更换内核。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum -y install perl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum  --enablerepo=&quot;elrepo-kernel&quot;  -y install kernel-ml.x86_64</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># grub2-set-default 0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># grub2-mkconfig -o /boot/grub2/grub.cfg</span>
</code></pre></div>
<h3 id="219_linux">2.1.9 Linux内核优化<a class="headerlink" href="#219_linux" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">fs</span><span class="p">.</span><span class="n">may_detach_mounts</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">vm</span><span class="p">.</span><span class="n">overcommit_memory</span><span class="p">=</span><span class="n">1</span>
<span class="n">vm</span><span class="p">.</span><span class="n">panic_on_oom</span><span class="p">=</span><span class="n">0</span>
<span class="n">fs</span><span class="p">.</span><span class="n">inotify</span><span class="p">.</span><span class="n">max_user_watches</span><span class="p">=</span><span class="n">89100</span>
<span class="n">fs</span><span class="p">.</span><span class="n">file-max</span><span class="p">=</span><span class="n">52706963</span>
<span class="n">fs</span><span class="p">.</span><span class="n">nr_open</span><span class="p">=</span><span class="n">52706963</span>
<span class="n">net</span><span class="p">.</span><span class="n">netfilter</span><span class="p">.</span><span class="n">nf_conntrack_max</span><span class="p">=</span><span class="n">2310720</span>

<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_time</span> <span class="p">=</span> <span class="n">600</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_probes</span> <span class="p">=</span> <span class="n">3</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_intvl</span> <span class="p">=</span><span class="n">15</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_tw_buckets</span> <span class="p">=</span> <span class="n">36000</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_tw_reuse</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_orphans</span> <span class="p">=</span> <span class="n">327680</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_orphan_retries</span> <span class="p">=</span> <span class="n">3</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_syncookies</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_syn_backlog</span> <span class="p">=</span> <span class="n">16384</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_conntrack_max</span> <span class="p">=</span> <span class="n">131072</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_syn_backlog</span> <span class="p">=</span> <span class="n">16384</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_timestamps</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">somaxconn</span> <span class="p">=</span> <span class="n">16384</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sysctl</span> <span class="p">-</span><span class="n">-system</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有节点配置完内核后</span><span class="err">，</span><span class="n">重启服务器</span><span class="err">，</span><span class="n">保证重启后内核依旧加载</span>
<span class="n">reboot</span> <span class="n">-h</span> <span class="n">now</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启后查看结果</span><span class="err">：</span>
<span class="n">lsmod</span> <span class="p">|</span> <span class="n">grep</span> <span class="p">-</span><span class="n">-color</span><span class="p">=</span><span class="n">auto</span> <span class="n">-e</span> <span class="n">ip_vs</span> <span class="n">-e</span> <span class="n">nf_conntrack</span>
</code></pre></div>
<h3 id="2110">2.1.10 其它工具安装(选装)<a class="headerlink" href="#2110" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">install</span> <span class="nb">wget </span><span class="n">jq</span> <span class="n">psmisc</span> <span class="n">vim</span> <span class="n">net-tools</span> <span class="n">telnet</span> <span class="n">yum-utils</span> <span class="n">device-mapper-persistent-data</span> <span class="n">lvm2</span> <span class="n">git</span> <span class="n">lrzsz</span> <span class="n">-y</span>
</code></pre></div>
<h2 id="22">2.2 负载均衡器准备<a class="headerlink" href="#22" title="Permanent link">&para;</a></h2>
<h3 id="221_haproxykeepalived">2.2.1 安装haproxy与keepalived<a class="headerlink" href="#221_haproxykeepalived" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">haproxy</span> <span class="n">keepalived</span>
</code></pre></div>
<h3 id="222_haproxy">2.2.2 HAProxy配置<a class="headerlink" href="#222_haproxy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;/</span><span class="n">etc</span><span class="p">/</span><span class="n">haproxy</span><span class="p">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span><span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="n">global</span>
 <span class="n">maxconn</span> <span class="n">2000</span>
 <span class="n">ulimit-n</span> <span class="n">16384</span>
 <span class="n">log</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="n">local0</span> <span class="n">err</span>
 <span class="n">stats</span> <span class="n">timeout</span> <span class="n">30s</span>

<span class="n">defaults</span>
 <span class="n">log</span> <span class="n">global</span>
 <span class="n">mode</span> <span class="n">http</span>
 <span class="n">option</span> <span class="n">httplog</span>
 <span class="n">timeout</span> <span class="n">connect</span> <span class="n">5000</span>
 <span class="n">timeout</span> <span class="n">client</span> <span class="n">50000</span>
 <span class="n">timeout</span> <span class="n">server</span> <span class="n">50000</span>
 <span class="n">timeout</span> <span class="n">http-request</span> <span class="n">15s</span>
 <span class="n">timeout</span> <span class="n">http-keep-alive</span> <span class="n">15s</span>

<span class="n">frontend</span> <span class="n">monitor-in</span>
 <span class="n">bind</span> <span class="p">*:</span><span class="n">33305</span>
 <span class="n">mode</span> <span class="n">http</span>
 <span class="n">option</span> <span class="n">httplog</span>
 <span class="n">monitor-uri</span> <span class="p">/</span><span class="n">monitor</span>

<span class="n">frontend</span> <span class="n">k8s-master</span>
 <span class="n">bind</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">:</span><span class="n">6443</span>
 <span class="n">bind</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">6443</span>
 <span class="n">mode</span> <span class="n">tcp</span>
 <span class="n">option</span> <span class="n">tcplog</span>
 <span class="n">tcp-request</span> <span class="n">inspect-delay</span> <span class="n">5s</span>
 <span class="n">default_backend</span> <span class="n">k8s-master</span>

<span class="n">backend</span> <span class="n">k8s-master</span>
 <span class="n">mode</span> <span class="n">tcp</span>
 <span class="n">option</span> <span class="n">tcplog</span>
 <span class="n">option</span> <span class="n">tcp-check</span>
 <span class="n">balance</span> <span class="n">roundrobin</span>
 <span class="k">default</span><span class="n">-server</span> <span class="n">inter</span> <span class="n">10s</span> <span class="n">downinter</span> <span class="n">5s</span> <span class="n">rise</span> <span class="n">2</span> <span class="n">fall</span> <span class="n">2</span> <span class="n">slowstart</span> <span class="n">60s</span> <span class="n">maxconn</span> <span class="n">250</span> <span class="n">maxqueue</span> <span class="n">256</span> <span class="n">weight</span> <span class="n">100</span>
 <span class="n">server</span>  <span class="n">k8s-master1</span>  <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">6443</span> <span class="n">check</span>
 <span class="n">server</span>  <span class="n">k8s-master2</span>  <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6443</span> <span class="n">check</span>
 <span class="n">server</span>  <span class="n">k8s-master3</span>  <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6443</span> <span class="n">check</span>
<span class="n">EOF</span>
</code></pre></div>
<h3 id="223_keepalived">2.2.3 KeepAlived<a class="headerlink" href="#223_keepalived" title="Permanent link">&para;</a></h3>
<blockquote>
<p>主从配置不一致，需要注意。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">ha1</span><span class="p">:</span>

<span class="nb">cat </span><span class="p">&gt;/</span><span class="n">etc</span><span class="p">/</span><span class="n">keepalived</span><span class="p">/</span><span class="n">keepalived</span><span class="p">.</span><span class="n">conf</span><span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="p">!</span> <span class="n">Configuration</span> <span class="n">File</span> <span class="k">for</span> <span class="n">keepalived</span>
<span class="n">global_defs</span> <span class="p">{</span>
   <span class="n">router_id</span> <span class="n">LVS_DEVEL</span>
<span class="n">script_user</span> <span class="n">root</span>
   <span class="n">enable_script_security</span>
<span class="p">}</span>
<span class="n">vrrp_script</span> <span class="n">chk_apiserver</span> <span class="p">{</span>
   <span class="n">script</span> <span class="s2">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
   <span class="n">interval</span> <span class="n">5</span>
   <span class="n">weight</span> <span class="p">-</span><span class="n">5</span>
   <span class="n">fall</span> <span class="n">2</span> 
<span class="n">rise</span> <span class="n">1</span>
<span class="p">}</span>
<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
   <span class="n">state</span> <span class="n">MASTER</span>
   <span class="n">interface</span> <span class="n">ens33</span>
   <span class="n">mcast_src_ip</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span>
   <span class="n">virtual_router_id</span> <span class="n">51</span>
   <span class="n">priority</span> <span class="n">100</span>
   <span class="n">advert_int</span> <span class="n">2</span>
   <span class="n">authentication</span> <span class="p">{</span>
       <span class="n">auth_type</span> <span class="n">PASS</span>
       <span class="n">auth_pass</span> <span class="n">K8SHA_KA_AUTH</span>
   <span class="p">}</span>
   <span class="n">virtual_ipaddress</span> <span class="p">{</span>
       <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span>
   <span class="p">}</span>
   <span class="n">track_script</span> <span class="p">{</span>
      <span class="n">chk_apiserver</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ha2</span><span class="p">:</span>

<span class="nb">cat </span><span class="p">&gt;/</span><span class="n">etc</span><span class="p">/</span><span class="n">keepalived</span><span class="p">/</span><span class="n">keepalived</span><span class="p">.</span><span class="n">conf</span><span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="p">!</span> <span class="n">Configuration</span> <span class="n">File</span> <span class="k">for</span> <span class="n">keepalived</span>
<span class="n">global_defs</span> <span class="p">{</span>
   <span class="n">router_id</span> <span class="n">LVS_DEVEL</span>
<span class="n">script_user</span> <span class="n">root</span>
   <span class="n">enable_script_security</span>
<span class="p">}</span>
<span class="n">vrrp_script</span> <span class="n">chk_apiserver</span> <span class="p">{</span>
   <span class="n">script</span> <span class="s2">&quot;/etc/keepalived/check_apiserver.sh&quot;</span>
  <span class="n">interval</span> <span class="n">5</span>
   <span class="n">weight</span> <span class="p">-</span><span class="n">5</span>
   <span class="n">fall</span> <span class="n">2</span> 
<span class="n">rise</span> <span class="n">1</span>
<span class="p">}</span>
<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
   <span class="n">state</span> <span class="n">BACKUP</span>
   <span class="n">interface</span> <span class="n">ens33</span>
   <span class="n">mcast_src_ip</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">11</span>
   <span class="n">virtual_router_id</span> <span class="n">51</span>
   <span class="n">priority</span> <span class="n">99</span>
   <span class="n">advert_int</span> <span class="n">2</span>
   <span class="n">authentication</span> <span class="p">{</span>
       <span class="n">auth_type</span> <span class="n">PASS</span>
       <span class="n">auth_pass</span> <span class="n">K8SHA_KA_AUTH</span>
   <span class="p">}</span>
   <span class="n">virtual_ipaddress</span> <span class="p">{</span>
       <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span>
   <span class="p">}</span>
   <span class="n">track_script</span> <span class="p">{</span>
      <span class="n">chk_apiserver</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<h3 id="224">2.2.4 健康检查脚本<a class="headerlink" href="#224" title="Permanent link">&para;</a></h3>
<blockquote>
<p>ha1及ha2均要配置</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">keepalived</span><span class="p">/</span><span class="n">check_apiserver</span><span class="p">.</span><span class="n">sh</span> <span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="c">#!/bin/bash</span>
<span class="n">err</span><span class="p">=</span><span class="n">0</span>
<span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="p">$(</span><span class="n">seq</span> <span class="n">1</span> <span class="n">3</span><span class="p">)</span>
<span class="k">do</span>
   <span class="n">check_code</span><span class="p">=$(</span><span class="n">pgrep</span> <span class="n">haproxy</span><span class="p">)</span>
   <span class="k">if</span> <span class="p">[[</span> <span class="nv">$check_code</span> <span class="p">==</span> <span class="s2">&quot;&quot;</span> <span class="p">]];</span> <span class="n">then</span>
       <span class="n">err</span><span class="p">=$(</span><span class="n">expr</span> <span class="nv">$err</span> <span class="p">+</span> <span class="n">1</span><span class="p">)</span>
       <span class="nb">sleep </span><span class="n">1</span>
       <span class="k">continue</span>
   <span class="k">else</span>
       <span class="n">err</span><span class="p">=</span><span class="n">0</span>
       <span class="k">break</span>
   <span class="n">fi</span>
<span class="n">done</span>

<span class="k">if</span> <span class="p">[[</span> <span class="nv">$err</span> <span class="p">!=</span> <span class="s2">&quot;0&quot;</span> <span class="p">]];</span> <span class="n">then</span>
   <span class="nb">echo </span><span class="s2">&quot;systemctl stop keepalived&quot;</span>
   <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">keepalived</span>
   <span class="n">exit</span> <span class="n">1</span>
<span class="k">else</span>
   <span class="n">exit</span> <span class="n">0</span>
<span class="n">fi</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">chmod</span> <span class="p">+</span><span class="n">x</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">keepalived</span><span class="p">/</span><span class="n">check_apiserver</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>
<h3 id="225">2.2.5 启动服务并验证<a class="headerlink" href="#225" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">haproxy</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">keepalived</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ip</span> <span class="n">address</span> <span class="n">show</span>
</code></pre></div>
<h2 id="23">2.3 配置免密登录<a class="headerlink" href="#23" title="Permanent link">&para;</a></h2>
<blockquote>
<p>在k8s-master1上操作</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">ssh-keygen</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ssh-copy-id</span> <span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span>
<span class="n">ssh-copy-id</span> <span class="n">root</span><span class="nv">@k8s</span><span class="n">-master2</span>
<span class="n">ssh-copy-id</span> <span class="n">root</span><span class="nv">@k8s</span><span class="n">-master3</span>
<span class="n">ssh-copy-id</span> <span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ssh</span> <span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span>
</code></pre></div>
<h2 id="24_etcd">2.4 部署ETCD集群<a class="headerlink" href="#24_etcd" title="Permanent link">&para;</a></h2>
<blockquote>
<p>在k8s-master1上操作。</p>
</blockquote>
<h3 id="241">2.4.1 创建工作目录<a class="headerlink" href="#241" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">k8s-work</span>
</code></pre></div>
<h3 id="242_cfssl">2.4.2 获取cfssl工具<a class="headerlink" href="#242_cfssl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">k8s-work</span>
<span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">pkg</span><span class="p">.</span><span class="n">cfssl</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">R1</span><span class="p">.</span><span class="n">2</span><span class="p">/</span><span class="n">cfssl_linux-amd64</span>
<span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">pkg</span><span class="p">.</span><span class="n">cfssl</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">R1</span><span class="p">.</span><span class="n">2</span><span class="p">/</span><span class="n">cfssljson_linux-amd64</span>
<span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">pkg</span><span class="p">.</span><span class="n">cfssl</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">R1</span><span class="p">.</span><span class="n">2</span><span class="p">/</span><span class="n">cfssl-certinfo_linux-amd64</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">cfssl是使用go编写</span><span class="err">，</span><span class="n">由CloudFlare开源的一款PKI</span><span class="p">/</span><span class="n">TLS工具</span><span class="err">。</span><span class="n">主要程序有</span><span class="err">：</span>

<span class="p">-</span> <span class="n">cfssl</span><span class="err">，</span><span class="n">是CFSSL的命令行工具</span>
<span class="p">-</span> <span class="n">cfssljson用来从cfssl程序获取JSON输出</span><span class="err">，</span><span class="n">并将证书</span><span class="err">，</span><span class="n">密钥</span><span class="err">，</span><span class="n">CSR和bundle写入文件中</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">chmod</span> <span class="p">+</span><span class="n">x</span> <span class="n">cfssl</span><span class="p">*</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">mv </span><span class="n">cfssl_linux-amd64</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">cfssl</span>
<span class="nb">mv </span><span class="n">cfssljson_linux-amd64</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">cfssljson</span>
<span class="nb">mv </span><span class="n">cfssl-certinfo_linux-amd64</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">cfssl-certinfo</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># cfssl version</span>
<span class="n">Version</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span>
<span class="n">Revision</span><span class="p">:</span> <span class="n">dev</span>
<span class="n">Runtime</span><span class="p">:</span> <span class="n">go1</span><span class="p">.</span><span class="n">6</span>
</code></pre></div>
<h3 id="243_ca">2.4.3 创建CA证书<a class="headerlink" href="#243_ca" title="Permanent link">&para;</a></h3>
<h4 id="2431_ca">2.4.3.1 配置ca证书请求文件<a class="headerlink" href="#2431_ca" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">ca-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
  <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;kubernetes&quot;</span><span class="p">,</span>
  <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;kubemsb&quot;</span><span class="p">,</span>
      <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">&quot;ca&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;87600h&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2432_ca">2.4.3.2 创建ca证书<a class="headerlink" href="#2432_ca" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-initca</span> <span class="n">ca-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">ca</span>
</code></pre></div>
<h4 id="2433_ca">2.4.3.3 配置ca证书策略<a class="headerlink" href="#2433_ca" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
  <span class="s2">&quot;signing&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;87600h&quot;</span>
        <span class="p">},</span>
      <span class="s2">&quot;profiles&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;kubernetes&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;usages&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;signing&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;key encipherment&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;server auth&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;client auth&quot;</span>
              <span class="p">],</span>
              <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;87600h&quot;</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">server</span> <span class="n">auth</span> <span class="n">表示client可以对使用该ca对server提供的证书进行验证</span>

<span class="n">client</span> <span class="n">auth</span> <span class="n">表示server可以使用该ca对client提供的证书进行验证</span>
</code></pre></div>
<h3 id="244_etcd">2.4.4 创建etcd证书<a class="headerlink" href="#244_etcd" title="Permanent link">&para;</a></h3>
<h4 id="2441_etcd">2.4.4.1 配置etcd请求文件<a class="headerlink" href="#2441_etcd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">etcd-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
  <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;etcd&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.12&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.13&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.14&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;kubemsb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span>
  <span class="p">}]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2442_etcd">2.4.4.2 生成etcd证书<a class="headerlink" href="#2442_etcd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">etcd-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span>  <span class="n">-bare</span> <span class="n">etcd</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># ls</span>
<span class="n">输出</span>
<span class="n">ca-config</span><span class="p">.</span><span class="n">json</span>  <span class="n">ca</span><span class="p">.</span><span class="n">csr</span>  <span class="n">ca-csr</span><span class="p">.</span><span class="n">json</span>  <span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">ca</span><span class="p">.</span><span class="n">pem</span>  <span class="n">etcd</span><span class="p">.</span><span class="n">csr</span>  <span class="n">etcd-csr</span><span class="p">.</span><span class="n">json</span>  <span class="n">etcd-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">etcd</span><span class="p">.</span><span class="n">pem</span>
</code></pre></div>
<h3 id="245_etcd">2.4.5  部署etcd集群<a class="headerlink" href="#245_etcd" title="Permanent link">&para;</a></h3>
<h4 id="2451_etcd">2.4.5.1 下载etcd软件包<a class="headerlink" href="#2451_etcd" title="Permanent link">&para;</a></h4>
<p><img alt="image-20220319090935574" src="../../../img/kubernetes/kubernetes_hight_bin/image-20220319090935574.png" /></p>
<p><img alt="image-20220319091008943" src="../../../img/kubernetes/kubernetes_hight_bin/image-20220319091008943.png" /></p>
<p><img alt="image-20220319091037753" src="../../../img/kubernetes/kubernetes_hight_bin/image-20220319091037753.png" /></p>
<div class="highlight"><pre><span></span><code><span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">etcd-io</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">v3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2</span><span class="p">/</span><span class="n">etcd-v3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</code></pre></div>
<h4 id="2452_etcd">2.4.5.2 安装etcd软件<a class="headerlink" href="#2452_etcd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">tar</span> <span class="n">-xvf</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="nb">cp </span><span class="n">-p</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-linux-amd64</span><span class="p">/</span><span class="n">etcd</span><span class="p">*</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>
</code></pre></div>
<h4 id="2453_etcd">2.4.5.3 分发etcd软件<a class="headerlink" href="#2453_etcd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-linux-amd64</span><span class="p">/</span><span class="n">etcd</span><span class="p">*</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>

<span class="n">scp</span> <span class="n">etcd-v3</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">2-linux-amd64</span><span class="p">/</span><span class="n">etcd</span><span class="p">*</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>
</code></pre></div>
<h4 id="2454">2.4.5.4 创建配置文件<a class="headerlink" href="#2454" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span>  <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="c">#[Member]</span>
<span class="n">ETCD_NAME</span><span class="p">=</span><span class="s2">&quot;etcd1&quot;</span>
<span class="n">ETCD_DATA_DIR</span><span class="p">=</span><span class="s2">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="n">ETCD_LISTEN_PEER_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.12:2380&quot;</span>
<span class="n">ETCD_LISTEN_CLIENT_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.12:2379,http://127.0.0.1:2379&quot;</span>

<span class="c">#[Clustering]</span>
<span class="n">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.12:2380&quot;</span>
<span class="n">ETCD_ADVERTISE_CLIENT_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.12:2379&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER</span><span class="p">=</span><span class="s2">&quot;etcd1=https://192.168.10.12:2380,etcd2=https://192.168.10.13:2380,etcd3=https://192.168.10.14:2380&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="p">=</span><span class="s2">&quot;etcd-cluster&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_STATE</span><span class="p">=</span><span class="s2">&quot;new&quot;</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">ETCD_NAME</span><span class="err">：</span><span class="n">节点名称</span><span class="err">，</span><span class="n">集群中唯一</span>
<span class="n">ETCD_DATA_DIR</span><span class="err">：</span><span class="n">数据目录</span>
<span class="n">ETCD_LISTEN_PEER_URLS</span><span class="err">：</span><span class="n">集群通信监听地址</span>
<span class="n">ETCD_LISTEN_CLIENT_URLS</span><span class="err">：</span><span class="n">客户端访问监听地址</span>
<span class="n">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="err">：</span><span class="n">集群通告地址</span>
<span class="n">ETCD_ADVERTISE_CLIENT_URLS</span><span class="err">：</span><span class="n">客户端通告地址</span>
<span class="n">ETCD_INITIAL_CLUSTER</span><span class="err">：</span><span class="n">集群节点地址</span>
<span class="n">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="err">：</span><span class="n">集群Token</span>
<span class="n">ETCD_INITIAL_CLUSTER_STATE</span><span class="err">：</span><span class="n">加入集群的当前状态</span><span class="err">，</span><span class="n">new是新集群</span><span class="err">，</span><span class="n">existing表示加入已有集群</span>
</code></pre></div>
<h4 id="2455">2.4.5.5 创建服务配置文件<a class="headerlink" href="#2455" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span>
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="k">default</span><span class="p">.</span><span class="n">etcd</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">k8s-work</span>
<span class="nb">cp </span><span class="n">ca</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span>
<span class="nb">cp </span><span class="n">etcd</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">service</span> <span class="p">&lt;&lt;</span><span class="s2">&quot;EOF&quot;</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Etcd</span> <span class="n">Server</span>
<span class="n">After</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>
<span class="n">After</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span>
<span class="n">Wants</span><span class="p">=</span><span class="n">network-online</span><span class="p">.</span><span class="n">target</span>

<span class="no">[Service]</span>
<span class="n">Type</span><span class="p">=</span><span class="n">notify</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">WorkingDirectory</span><span class="p">=/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">etcd</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-cert</span><span class="o">-file</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-key</span><span class="o">-file</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">etcd-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-trusted-ca</span><span class="o">-file</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-peer-cert</span><span class="o">-file</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-peer-key</span><span class="o">-file</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">etcd-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-peer-trusted-ca</span><span class="o">-file</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-peer-client-cert-auth</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-client-cert-auth</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>
<span class="n">LimitNOFILE</span><span class="p">=</span><span class="n">65536</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2456_etcdmaster">2.4.5.6 同步etcd配置到集群其它master节点<a class="headerlink" href="#2456_etcdmaster" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">创建目录</span>
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span>
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span>
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="k">default</span><span class="p">.</span><span class="n">etcd</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">服务配置文件</span><span class="p">,</span><span class="n">需要修改etcd节点名称及IP地址</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="p">\</span>
<span class="k">do</span> <span class="p">\</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">conf</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span> <span class="p">\</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">k8s-master2</span><span class="p">:</span>

<span class="nb">cat </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">conf</span>
<span class="c">#[Member]</span>
<span class="n">ETCD_NAME</span><span class="p">=</span><span class="s2">&quot;etcd2&quot;</span>
<span class="n">ETCD_DATA_DIR</span><span class="p">=</span><span class="s2">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="n">ETCD_LISTEN_PEER_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.13:2380&quot;</span>
<span class="n">ETCD_LISTEN_CLIENT_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.13:2379,http://127.0.0.1:2379&quot;</span>

<span class="c">#[Clustering]</span>
<span class="n">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.13:2380&quot;</span>
<span class="n">ETCD_ADVERTISE_CLIENT_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.13:2379&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER</span><span class="p">=</span><span class="s2">&quot;etcd1=https://192.168.10.12:2380,etcd2=https://192.168.10.13:2380,etcd3=https://192.168.10.14:2380&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="p">=</span><span class="s2">&quot;etcd-cluster&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_STATE</span><span class="p">=</span><span class="s2">&quot;new&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">k8s-master3</span><span class="p">:</span>

<span class="nb">cat </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">conf</span>
<span class="c">#[Member]</span>
<span class="n">ETCD_NAME</span><span class="p">=</span><span class="s2">&quot;etcd3&quot;</span>
<span class="n">ETCD_DATA_DIR</span><span class="p">=</span><span class="s2">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="n">ETCD_LISTEN_PEER_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.14:2380&quot;</span>
<span class="n">ETCD_LISTEN_CLIENT_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.14:2379,http://127.0.0.1:2379&quot;</span>

<span class="c">#[Clustering]</span>
<span class="n">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.14:2380&quot;</span>
<span class="n">ETCD_ADVERTISE_CLIENT_URLS</span><span class="p">=</span><span class="s2">&quot;https://192.168.10.14:2379&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER</span><span class="p">=</span><span class="s2">&quot;etcd1=https://192.168.10.12:2380,etcd2=https://192.168.10.13:2380,etcd3=https://192.168.10.14:2380&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="p">=</span><span class="s2">&quot;etcd-cluster&quot;</span>
<span class="n">ETCD_INITIAL_CLUSTER_STATE</span><span class="p">=</span><span class="s2">&quot;new&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">证书文件</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="p">\</span>
<span class="k">do</span> <span class="p">\</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/*</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span> <span class="p">\</span>
<span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">服务启动配置文件</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="p">\</span>
<span class="k">do</span> <span class="p">\</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">service</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span> <span class="p">\</span>
<span class="n">done</span>
</code></pre></div>
<h4 id="2457_etcd">2.4.5.7 启动etcd集群<a class="headerlink" href="#2457_etcd" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">etcd</span><span class="p">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">etcd</span>
</code></pre></div>
<h4 id="2458">2.4.5.8 验证集群状态<a class="headerlink" href="#2458" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">ETCDCTL_API</span><span class="p">=</span><span class="n">3</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">etcdctl</span> <span class="p">-</span><span class="n">-write-out</span><span class="p">=</span><span class="n">table</span> <span class="p">-</span><span class="n">-cacert</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-cert</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">etcd</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-key</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">etcd</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">etcd-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-endpoints</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">2379</span><span class="p">,</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">2379</span><span class="p">,</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">2379</span> <span class="n">endpoint</span> <span class="n">health</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">+----------------------------+--------+-------------+-------+</span>
<span class="p">|</span>          <span class="n">ENDPOINT</span>          <span class="p">|</span> <span class="n">HEALTH</span> <span class="p">|</span>    <span class="n">TOOK</span>     <span class="p">|</span> <span class="n">ERROR</span> <span class="p">|</span>
<span class="p">+----------------------------+--------+-------------+-------+</span>
<span class="p">|</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">2379</span> <span class="p">|</span>   <span class="n">true</span> <span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">393062ms</span> <span class="p">|</span>       <span class="p">|</span>
<span class="p">|</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">2379</span> <span class="p">|</span>   <span class="n">true</span> <span class="p">|</span>  <span class="n">15</span><span class="p">.</span><span class="n">70437ms</span> <span class="p">|</span>       <span class="p">|</span>
<span class="p">|</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">2379</span> <span class="p">|</span>   <span class="n">true</span> <span class="p">|</span> <span class="n">15</span><span class="p">.</span><span class="n">871684ms</span> <span class="p">|</span>       <span class="p">|</span>
<span class="p">+----------------------------+--------+-------------+-------+</span>
</code></pre></div>
<h2 id="25_kubernetes">2.5 Kubernetes集群部署<a class="headerlink" href="#25_kubernetes" title="Permanent link">&para;</a></h2>
<h3 id="251_kubernetes">2.5.1 Kubernetes软件包下载<a class="headerlink" href="#251_kubernetes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">dl</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span><span class="p">/</span><span class="n">kubernetes-server-linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
</code></pre></div>
<h3 id="252_kubernetes">2.5.2 Kubernetes软件包安装<a class="headerlink" href="#252_kubernetes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">tar</span> <span class="n">-xvf</span> <span class="n">kubernetes-server-linux-amd64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>

<span class="nb">cd </span><span class="n">kubernetes</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>

<span class="nb">cp </span><span class="n">kube-apiserver</span> <span class="n">kube-controller-manager</span> <span class="n">kube-scheduler</span> <span class="n">kubectl</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>
</code></pre></div>
<h3 id="253_kubernetes">2.5.3 Kubernetes软件分发<a class="headerlink" href="#253_kubernetes" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="n">kube-apiserver</span> <span class="n">kube-controller-manager</span> <span class="n">kube-scheduler</span> <span class="n">kubectl</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>
<span class="n">scp</span> <span class="n">kube-apiserver</span> <span class="n">kube-controller-manager</span> <span class="n">kube-scheduler</span> <span class="n">kubectl</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="n">kubelet</span> <span class="n">kube-proxy</span> <span class="n">k8s-master1</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span>
<span class="n">scp</span> <span class="n">kubelet</span> <span class="n">kube-proxy</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span>
<span class="n">scp</span> <span class="n">kubelet</span> <span class="n">kube-proxy</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span>
<span class="n">scp</span> <span class="n">kubelet</span> <span class="n">kube-proxy</span> <span class="n">k8s-worker1</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span>
</code></pre></div>
<h3 id="254">2.5.4 在集群节点上创建目录<a class="headerlink" href="#254" title="Permanent link">&para;</a></h3>
<blockquote>
<p>所有节点</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>        
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span>     
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">kubernetes</span> 
</code></pre></div>
<h3 id="255_api-server">2.5.5 部署api-server<a class="headerlink" href="#255_api-server" title="Permanent link">&para;</a></h3>
<h4 id="2551_apiserver">2.5.5.1 创建apiserver证书请求文件<a class="headerlink" href="#2551_apiserver" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-apiserver-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
<span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;kubernetes&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.12&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.13&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.14&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.15&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.16&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.18&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.19&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.20&quot;</span><span class="p">,</span>
    <span class="s2">&quot;192.168.10.100&quot;</span><span class="p">,</span>
    <span class="s2">&quot;10.96.0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kubernetes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kubernetes.default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kubernetes.default.svc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kubernetes.default.svc.cluster&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kubernetes.default.svc.cluster.local&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;kubemsb&quot;</span><span class="p">,</span>
      <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">如果</span> <span class="n">hosts</span> <span class="n">字段不为空则需要指定授权使用该证书的</span> <span class="n">IP</span><span class="err">（</span><span class="n">含VIP</span><span class="err">）</span> <span class="n">或域名列表</span><span class="err">。</span><span class="n">由于该证书被</span> <span class="n">集群使用</span><span class="err">，</span><span class="n">需要将节点的IP都填上</span><span class="err">，</span><span class="n">为了方便后期扩容可以多写几个预留的IP</span><span class="err">。</span>
<span class="n">同时还需要填写</span> <span class="n">service</span> <span class="n">网络的首个IP</span><span class="p">(</span><span class="n">一般是</span> <span class="n">kube-apiserver</span> <span class="n">指定的</span> <span class="n">service-cluster-ip-range</span> <span class="n">网段的第一个IP</span><span class="err">，</span><span class="n">如</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">)</span><span class="err">。</span>
</code></pre></div>
<h4 id="2552_apiservertoken">2.5.5.2 生成apiserver证书及token文件<a class="headerlink" href="#2552_apiservertoken" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">kube-apiserver-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">kube-apiserver</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">token</span><span class="p">.</span><span class="n">csv</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="p">$(</span><span class="n">head</span> <span class="n">-c</span> <span class="n">16</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">urandom</span> <span class="p">|</span> <span class="n">od</span> <span class="n">-An</span> <span class="n">-t</span> <span class="n">x</span> <span class="p">|</span> <span class="n">tr</span> <span class="n">-d</span> <span class="s1">&#39; &#39;</span><span class="p">),</span><span class="n">kubelet-bootstrap</span><span class="p">,</span><span class="n">10001</span><span class="p">,</span><span class="s2">&quot;system:kubelet-bootstrap&quot;</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">创建TLS机制所需TOKEN</span>
<span class="n">TLS</span> <span class="n">Bootstraping</span><span class="err">：</span><span class="n">Master</span> <span class="n">apiserver启用TLS认证后</span><span class="err">，</span><span class="n">Node节点kubelet和kube-proxy与kube-apiserver进行通信</span><span class="err">，</span><span class="n">必须使用CA签发的有效证书才可以</span><span class="err">，</span><span class="n">当Node节点很多时</span><span class="err">，</span><span class="n">这种客户端证书颁发需要大量工作</span><span class="err">，</span><span class="n">同样也会增加集群扩展复杂度</span><span class="err">。</span><span class="n">为了简化流程</span><span class="err">，</span><span class="n">Kubernetes引入了TLS</span> <span class="n">bootstraping机制来自动颁发客户端证书</span><span class="err">，</span><span class="n">kubelet会以一个低权限用户自动向apiserver申请证书</span><span class="err">，</span><span class="n">kubelet的证书由apiserver动态签署</span><span class="err">。</span><span class="n">所以强烈建议在Node上使用这种方式</span><span class="err">，</span><span class="n">目前主要用于kubelet</span><span class="err">，</span><span class="n">kube-proxy还是由我们统一颁发一个证书</span><span class="err">。</span>
</code></pre></div>
<h4 id="2553_apiserver">2.5.5.3 创建apiserver服务配置文件<a class="headerlink" href="#2553_apiserver" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="n">KUBE_APISERVER_OPTS</span><span class="p">=</span><span class="s2">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span>
<span class="s2">  --anonymous-auth=false \</span>
<span class="s2">  --bind-address=192.168.10.12 \</span>
<span class="s2">  --secure-port=6443 \</span>
<span class="s2">  --advertise-address=192.168.10.12 \</span>
<span class="s2">  --insecure-port=0 \</span>
<span class="s2">  --authorization-mode=Node,RBAC \</span>
<span class="s2">  --runtime-config=api/all=true \</span>
<span class="s2">  --enable-bootstrap-token-auth \</span>
<span class="s2">  --service-cluster-ip-range=10.96.0.0/16 \</span>
<span class="s2">  --token-auth-file=/etc/kubernetes/token.csv \</span>
<span class="s2">  --service-node-port-range=30000-32767 \</span>
<span class="s2">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span>
<span class="s2">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span>
<span class="s2">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span>
<span class="s2">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span>
<span class="s2">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span>
<span class="s2">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span>
<span class="s2">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span>
<span class="s2">  --service-account-issuer=api \</span>
<span class="s2">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span>
<span class="s2">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span>
<span class="s2">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span>
<span class="s2">  --etcd-servers=https://192.168.10.12:2379,https://192.168.10.13:2379,https://192.168.10.14:2379 \</span>
<span class="s2">  --enable-swagger-ui=true \</span>
<span class="s2">  --allow-privileged=true \</span>
<span class="s2">  --apiserver-count=3 \</span>
<span class="s2">  --audit-log-maxage=30 \</span>
<span class="s2">  --audit-log-maxbackup=3 \</span>
<span class="s2">  --audit-log-maxsize=100 \</span>
<span class="s2">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span>
<span class="s2">  --event-ttl=1h \</span>
<span class="s2">  --alsologtostderr=true \</span>
<span class="s2">  --logtostderr=false \</span>
<span class="s2">  --log-dir=/var/log/kubernetes \</span>
<span class="s2">  --v=4&quot;</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2554_apiserver">2.5.5.4 创建apiserver服务管理配置文件<a class="headerlink" href="#2554_apiserver" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">API</span> <span class="n">Server</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">After</span><span class="p">=</span><span class="n">etcd</span><span class="p">.</span><span class="n">service</span>
<span class="n">Wants</span><span class="p">=</span><span class="n">etcd</span><span class="p">.</span><span class="n">service</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">conf</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-apiserver</span> <span class="nv">$KUBE_APISERVER_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>
<span class="n">Type</span><span class="p">=</span><span class="n">notify</span>
<span class="n">LimitNOFILE</span><span class="p">=</span><span class="n">65536</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2555_master">2.5.5.5 同步文件到集群master节点<a class="headerlink" href="#2555_master" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">ca</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">kube-apiserver</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">token</span><span class="p">.</span><span class="n">csv</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">token</span><span class="p">.</span><span class="n">csv</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">token</span><span class="p">.</span><span class="n">csv</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">ca</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">ca</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">conf</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">conf</span>

<span class="c"># cat /etc/kubernetes/kube-apiserver.conf</span>
<span class="n">KUBE_APISERVER_OPTS</span><span class="p">=</span><span class="s2">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span>
<span class="s2">  --anonymous-auth=false \</span>
<span class="s2">  --bind-address=192.168.10.13 \</span>
<span class="s2">  --secure-port=6443 \</span>
<span class="s2">  --advertise-address=192.168.10.13 \</span>
<span class="s2">  --insecure-port=0 \</span>
<span class="s2">  --authorization-mode=Node,RBAC \</span>
<span class="s2">  --runtime-config=api/all=true \</span>
<span class="s2">  --enable-bootstrap-token-auth \</span>
<span class="s2">  --service-cluster-ip-range=10.96.0.0/16 \</span>
<span class="s2">  --token-auth-file=/etc/kubernetes/token.csv \</span>
<span class="s2">  --service-node-port-range=30000-32767 \</span>
<span class="s2">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span>
<span class="s2">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span>
<span class="s2">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span>
<span class="s2">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span>
<span class="s2">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span>
<span class="s2">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span>
<span class="s2">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span>
<span class="s2">  --service-account-issuer=api \</span>
<span class="s2">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span>
<span class="s2">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span>
<span class="s2">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span>
<span class="s2">  --etcd-servers=https://192.168.10.12:2379,https://192.168.10.13:2379,https://192.168.10.14:2379 \</span>
<span class="s2">  --enable-swagger-ui=true \</span>
<span class="s2">  --allow-privileged=true \</span>
<span class="s2">  --apiserver-count=3 \</span>
<span class="s2">  --audit-log-maxage=30 \</span>
<span class="s2">  --audit-log-maxbackup=3 \</span>
<span class="s2">  --audit-log-maxsize=100 \</span>
<span class="s2">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span>
<span class="s2">  --event-ttl=1h \</span>
<span class="s2">  --alsologtostderr=true \</span>
<span class="s2">  --logtostderr=false \</span>
<span class="s2">  --log-dir=/var/log/kubernetes \</span>
<span class="s2">  --v=4&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">conf</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">conf</span>

<span class="c"># cat /etc/kubernetes/kube-apiserver.conf</span>
<span class="n">KUBE_APISERVER_OPTS</span><span class="p">=</span><span class="s2">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span>
<span class="s2">  --anonymous-auth=false \</span>
<span class="s2">  --bind-address=192.168.10.14 \</span>
<span class="s2">  --secure-port=6443 \</span>
<span class="s2">  --advertise-address=192.168.10.14 \</span>
<span class="s2">  --insecure-port=0 \</span>
<span class="s2">  --authorization-mode=Node,RBAC \</span>
<span class="s2">  --runtime-config=api/all=true \</span>
<span class="s2">  --enable-bootstrap-token-auth \</span>
<span class="s2">  --service-cluster-ip-range=10.96.0.0/16 \</span>
<span class="s2">  --token-auth-file=/etc/kubernetes/token.csv \</span>
<span class="s2">  --service-node-port-range=30000-32767 \</span>
<span class="s2">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span>
<span class="s2">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span>
<span class="s2">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span>
<span class="s2">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span>
<span class="s2">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span>
<span class="s2">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span>
<span class="s2">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span>
<span class="s2">  --service-account-issuer=api \</span>
<span class="s2">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span>
<span class="s2">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span>
<span class="s2">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span>
<span class="s2">  --etcd-servers=https://192.168.10.12:2379,https://192.168.10.13:2379,https://192.168.10.14:2379 \</span>
<span class="s2">  --enable-swagger-ui=true \</span>
<span class="s2">  --allow-privileged=true \</span>
<span class="s2">  --apiserver-count=3 \</span>
<span class="s2">  --audit-log-maxage=30 \</span>
<span class="s2">  --audit-log-maxbackup=3 \</span>
<span class="s2">  --audit-log-maxsize=100 \</span>
<span class="s2">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span>
<span class="s2">  --event-ttl=1h \</span>
<span class="s2">  --alsologtostderr=true \</span>
<span class="s2">  --logtostderr=false \</span>
<span class="s2">  --log-dir=/var/log/kubernetes \</span>
<span class="s2">  --v=4&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span>

<span class="n">scp</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">kube-apiserver</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<h4 id="2556_apiserver">2.5.5.6 启动apiserver服务<a class="headerlink" href="#2556_apiserver" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">kube-apiserver</span>

<span class="n">systemctl</span> <span class="n">status</span> <span class="n">kube-apiserver</span>

<span class="c"># 测试</span>
<span class="nb">curl </span><span class="p">-</span><span class="n">-insecure</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">6443</span><span class="p">/</span>
<span class="nb">curl </span><span class="p">-</span><span class="n">-insecure</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">13</span><span class="p">:</span><span class="n">6443</span><span class="p">/</span>
<span class="nb">curl </span><span class="p">-</span><span class="n">-insecure</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span><span class="p">:</span><span class="n">6443</span><span class="p">/</span>
<span class="nb">curl </span><span class="p">-</span><span class="n">-insecure</span> <span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">6443</span><span class="p">/</span>
</code></pre></div>
<h3 id="256_kubectl">2.5.6 部署kubectl<a class="headerlink" href="#256_kubectl" title="Permanent link">&para;</a></h3>
<h4 id="2561_kubectl">2.5.6.1 创建kubectl证书请求文件<a class="headerlink" href="#2561_kubectl" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">admin-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
  <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;system:masters&quot;</span><span class="p">,</span>             
      <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>

<span class="n">后续</span> <span class="n">kube-apiserver</span> <span class="n">使用</span> <span class="n">RBAC</span> <span class="n">对客户端</span><span class="p">(</span><span class="n">如</span> <span class="n">kubelet</span><span class="err">、</span><span class="n">kube-proxy</span><span class="err">、</span><span class="n">Pod</span><span class="p">)</span><span class="n">请求进行授权</span><span class="err">；</span>
<span class="n">kube-apiserver</span> <span class="n">预定义了一些</span> <span class="n">RBAC</span> <span class="n">使用的</span> <span class="n">RoleBindings</span><span class="err">，</span><span class="n">如</span> <span class="n">cluster-admin</span> <span class="n">将</span> <span class="nb">Group </span><span class="n">system</span><span class="p">:</span><span class="n">masters</span> <span class="n">与</span> <span class="n">Role</span> <span class="n">cluster-admin</span> <span class="n">绑定</span><span class="err">，</span><span class="n">该</span> <span class="n">Role</span> <span class="n">授予了调用kube-apiserver</span> <span class="n">的所有</span> <span class="n">API的权限</span><span class="err">；</span>
<span class="n">O指定该证书的</span> <span class="nb">Group </span><span class="n">为</span> <span class="n">system</span><span class="p">:</span><span class="n">masters</span><span class="err">，</span><span class="n">kubelet</span> <span class="n">使用该证书访问</span> <span class="n">kube-apiserver</span> <span class="n">时</span> <span class="err">，</span><span class="n">由于证书被</span> <span class="n">CA</span> <span class="n">签名</span><span class="err">，</span><span class="n">所以认证通过</span><span class="err">，</span><span class="n">同时由于证书用户组为经过预授权的</span> <span class="n">system</span><span class="p">:</span><span class="n">masters</span><span class="err">，</span><span class="n">所以被授予访问所有</span> <span class="n">API</span> <span class="n">的权限</span><span class="err">；</span>
<span class="n">注</span><span class="err">：</span>
<span class="n">这个admin</span> <span class="n">证书</span><span class="err">，</span><span class="n">是将来生成管理员用的kubeconfig</span> <span class="n">配置文件用的</span><span class="err">，</span><span class="n">现在我们一般建议使用RBAC</span> <span class="n">来对kubernetes</span> <span class="n">进行角色权限控制</span><span class="err">，</span> <span class="n">kubernetes</span> <span class="n">将证书中的CN</span> <span class="n">字段</span> <span class="n">作为User</span><span class="err">，</span> <span class="n">O</span> <span class="n">字段作为</span> <span class="n">Group</span><span class="err">；</span>
<span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;system:masters&quot;</span><span class="p">,</span> <span class="n">必须是system</span><span class="p">:</span><span class="n">masters</span><span class="err">，</span><span class="n">否则后面kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding报错</span><span class="err">。</span>
</code></pre></div>
<h4 id="2562">2.5.6.2 生成证书文件<a class="headerlink" href="#2562" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">admin-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">admin</span>
</code></pre></div>
<h4 id="2563">2.5.6.3 复制文件到指定目录<a class="headerlink" href="#2563" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">admin</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
</code></pre></div>
<h4 id="2564_kubeconfig">2.5.6.4 生成kubeconfig配置文件<a class="headerlink" href="#2564_kubeconfig" title="Permanent link">&para;</a></h4>
<p>kube.config 为 kubectl 的配置文件，包含访问 apiserver 的所有信息，如 apiserver 地址、CA 证书和自身使用的证书</p>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-server</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube</span><span class="p">.</span><span class="n">config</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">admin</span> <span class="p">-</span><span class="n">-client-certificate</span><span class="p">=</span><span class="n">admin</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-client-key</span><span class="p">=</span><span class="n">admin-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube</span><span class="p">.</span><span class="n">config</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">admin</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube</span><span class="p">.</span><span class="n">config</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube</span><span class="p">.</span><span class="n">config</span>
</code></pre></div>
<h4 id="2565_kubectl">2.5.6.5 准备kubectl配置文件并进行角色绑定<a class="headerlink" href="#2565_kubectl" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="p">~/.</span><span class="n">kube</span>
<span class="nb">cp </span><span class="n">kube</span><span class="p">.</span><span class="n">config</span> <span class="p">~/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">kube-apiserver</span><span class="p">:</span><span class="n">kubelet-apis</span> <span class="p">-</span><span class="n">-clusterrole</span><span class="p">=</span><span class="n">system</span><span class="p">:</span><span class="n">kubelet-api-admin</span> <span class="p">-</span><span class="n">-user</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
</code></pre></div>
<h4 id="2566">2.5.6.6 查看集群状态<a class="headerlink" href="#2566" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">export</span> <span class="n">KUBECONFIG</span><span class="p">=</span><span class="nv">$HOME</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">cluster-info</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">componentstatuses</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">all</span> <span class="p">-</span><span class="n">-all-namespaces</span>
</code></pre></div>
<h4 id="2567_kubectlmaster">2.5.6.7 同步kubectl配置文件到集群其它master节点<a class="headerlink" href="#2567_kubectlmaster" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">k8s-master2</span><span class="p">:</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span>

<span class="n">k8s-master3</span><span class="p">:</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
<span class="n">scp</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span>
</code></pre></div>
<h4 id="2568_kubectl">2.5.6.8 配置kubectl命令补全(可选)<a class="headerlink" href="#2568_kubectl" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">install</span> <span class="n">-y</span> <span class="n">bash-completion</span>
<span class="n">source</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">bash-completion</span><span class="p">/</span><span class="n">bash_completion</span>
<span class="n">source</span> <span class="p">&lt;(</span><span class="n">kubectl</span> <span class="n">completion</span> <span class="n">bash</span><span class="p">)</span>
<span class="n">kubectl</span> <span class="n">completion</span> <span class="n">bash</span> <span class="p">&gt;</span> <span class="p">~/.</span><span class="n">kube</span><span class="p">/</span><span class="n">completion</span><span class="p">.</span><span class="n">bash</span><span class="p">.</span><span class="n">inc</span>
<span class="n">source</span> <span class="s1">&#39;/root/.kube/completion.bash.inc&#39;</span>  
<span class="n">source</span> <span class="nv">$HOME</span><span class="p">/.</span><span class="n">bash_profile</span>
</code></pre></div>
<h3 id="257_kube-controller-manager">2.5.7  部署kube-controller-manager<a class="headerlink" href="#257_kube-controller-manager" title="Permanent link">&para;</a></h3>
<h4 id="2571_kube-controller-manager">2.5.7.1 创建kube-controller-manager证书请求文件<a class="headerlink" href="#2571_kube-controller-manager" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-controller-manager-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
    <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;system:kube-controller-manager&quot;</span><span class="p">,</span>
    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
    <span class="p">},</span>
    <span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;192.168.10.12&quot;</span><span class="p">,</span>
      <span class="s2">&quot;192.168.10.13&quot;</span><span class="p">,</span>
      <span class="s2">&quot;192.168.10.14&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;system:kube-controller-manager&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>

<span class="n">hosts</span> <span class="n">列表包含所有</span> <span class="n">kube-controller-manager</span> <span class="n">节点</span> <span class="n">IP</span><span class="err">；</span>
<span class="n">CN</span> <span class="n">为</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span><span class="err">、</span><span class="n">O</span> <span class="n">为</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span><span class="err">，</span><span class="n">kubernetes</span> <span class="n">内置的</span> <span class="n">ClusterRoleBindings</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span> <span class="n">赋予</span> <span class="n">kube-controller-manager</span> <span class="n">工作所需的权限</span>
</code></pre></div>
<h4 id="2572_kube-controller-manager">2.5.7.2 创建kube-controller-manager证书文件<a class="headerlink" href="#2572_kube-controller-manager" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">kube-controller-manager-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">kube-controller-manager</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># ls</span>

<span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">csr</span>     
<span class="n">kube-controller-manager-csr</span><span class="p">.</span><span class="n">json</span>
<span class="n">kube-controller-manager-key</span><span class="p">.</span><span class="n">pem</span>
<span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">pem</span>
</code></pre></div>
<h4 id="2573_kube-controller-managerkube-controller-managerkubeconfig">2.5.7.3  创建kube-controller-manager的kube-controller-manager.kubeconfig<a class="headerlink" href="#2573_kube-controller-managerkube-controller-managerkubeconfig" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-server</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span> <span class="p">-</span><span class="n">-client-certificate</span><span class="p">=</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-client-key</span><span class="p">=</span><span class="n">kube-controller-manager-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-controller-manager</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span>
</code></pre></div>
<h4 id="2574_kube-controller-manager">2.5.7.4 创建kube-controller-manager配置文件<a class="headerlink" href="#2574_kube-controller-manager" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="n">KUBE_CONTROLLER_MANAGER_OPTS</span><span class="p">=</span><span class="s2">&quot;--port=10252 \</span>
<span class="s2">  --secure-port=10257 \</span>
<span class="s2">  --bind-address=127.0.0.1 \</span>
<span class="s2">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span>
<span class="s2">  --service-cluster-ip-range=10.96.0.0/16 \</span>
<span class="s2">  --cluster-name=kubernetes \</span>
<span class="s2">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span>
<span class="s2">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span>
<span class="s2">  --allocate-node-cidrs=true \</span>
<span class="s2">  --cluster-cidr=10.244.0.0/16 \</span>
<span class="s2">  --experimental-cluster-signing-duration=87600h \</span>
<span class="s2">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span>
<span class="s2">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span>
<span class="s2">  --leader-elect=true \</span>
<span class="s2">  --feature-gates=RotateKubeletServerCertificate=true \</span>
<span class="s2">  --controllers=*,bootstrapsigner,tokencleaner \</span>
<span class="s2">  --horizontal-pod-autoscaler-use-rest-clients=true \</span>
<span class="s2">  --horizontal-pod-autoscaler-sync-period=10s \</span>
<span class="s2">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span>
<span class="s2">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span>
<span class="s2">  --use-service-account-credentials=true \</span>
<span class="s2">  --alsologtostderr=true \</span>
<span class="s2">  --logtostderr=false \</span>
<span class="s2">  --log-dir=/var/log/kubernetes \</span>
<span class="s2">  --v=2&quot;</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2575">2.5.7.5 创建服务启动文件<a class="headerlink" href="#2575" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Controller</span> <span class="n">Manager</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">conf</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-controller-manager</span> <span class="nv">$KUBE_CONTROLLER_MANAGER_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2576_master">2.5.7.6 同步文件到集群master节点<a class="headerlink" href="#2576_master" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">kube-controller-manager</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">conf</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span>  <span class="n">kube-controller-manager</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-controller-manager</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">conf</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">conf</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c">#查看证书</span>
<span class="n">openssl</span> <span class="n">x509</span> <span class="n">-in</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">kube-controller-manager</span><span class="p">.</span><span class="n">pem</span> <span class="n">-noout</span> <span class="n">-text</span>
</code></pre></div>
<h4 id="2577">2.5.7.7 启动服务<a class="headerlink" href="#2577" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon-reload</span> 
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">kube-controller-manager</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">kube-controller-manager</span>
</code></pre></div>
<h3 id="258_kube-scheduler">2.5.8 部署kube-scheduler<a class="headerlink" href="#258_kube-scheduler" title="Permanent link">&para;</a></h3>
<h4 id="2581_kube-scheduler">2.5.8.1 创建kube-scheduler证书请求文件<a class="headerlink" href="#2581_kube-scheduler" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-scheduler-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
    <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;system:kube-scheduler&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;192.168.10.12&quot;</span><span class="p">,</span>
      <span class="s2">&quot;192.168.10.13&quot;</span><span class="p">,</span>
      <span class="s2">&quot;192.168.10.14&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
    <span class="p">},</span>
    <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;system:kube-scheduler&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2582_kube-scheduler">2.5.8.2 生成kube-scheduler证书<a class="headerlink" href="#2582_kube-scheduler" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">kube-scheduler-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">kube-scheduler</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># ls</span>
<span class="n">kube-scheduler</span><span class="p">.</span><span class="n">csr</span>
<span class="n">kube-scheduler-csr</span><span class="p">.</span><span class="n">json</span>
<span class="n">kube-scheduler-key</span><span class="p">.</span><span class="n">pem</span>
<span class="n">kube-scheduler</span><span class="p">.</span><span class="n">pem</span>
</code></pre></div>
<h4 id="2583_kube-schedulerkubeconfig">2.5.8.3 创建kube-scheduler的kubeconfig<a class="headerlink" href="#2583_kube-schedulerkubeconfig" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-server</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-scheduler</span> <span class="p">-</span><span class="n">-client-certificate</span><span class="p">=</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-client-key</span><span class="p">=</span><span class="n">kube-scheduler-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-scheduler</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">system</span><span class="p">:</span><span class="n">kube-scheduler</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="n">system</span><span class="p">:</span><span class="n">kube-scheduler</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span>
</code></pre></div>
<h4 id="2584">2.5.8.4 创建服务配置文件<a class="headerlink" href="#2584" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="n">KUBE_SCHEDULER_OPTS</span><span class="p">=</span><span class="s2">&quot;--address=127.0.0.1 \</span>
<span class="s2">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span>
<span class="s2">--leader-elect=true \</span>
<span class="s2">--alsologtostderr=true \</span>
<span class="s2">--logtostderr=false \</span>
<span class="s2">--log-dir=/var/log/kubernetes \</span>
<span class="s2">--v=2&quot;</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2585">2.5.8.5创建服务启动配置文件<a class="headerlink" href="#2585" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Scheduler</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>

<span class="no">[Service]</span>
<span class="n">EnvironmentFile</span><span class="p">=-/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">conf</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-scheduler</span> <span class="nv">$KUBE_SCHEDULER_OPTS</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2586_master">2.5.8.6 同步文件至集群master节点<a class="headerlink" href="#2586_master" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">kube-scheduler</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">conf</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span>  <span class="n">kube-scheduler</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-scheduler</span><span class="p">*.</span><span class="n">pem</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">conf</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">conf</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-master2</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-scheduler</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-master3</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<h4 id="2587">2.5.8.7 启动服务<a class="headerlink" href="#2587" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">kube-scheduler</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">kube-scheduler</span>
</code></pre></div>
<h3 id="259_worker_node">2.5.9 工作节点（worker node）部署<a class="headerlink" href="#259_worker_node" title="Permanent link">&para;</a></h3>
<h4 id="2591_docker">2.5.9.1 docker安装及配置<a class="headerlink" href="#2591_docker" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">wget </span><span class="n">-O</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span> <span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">centos</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">docker-ce</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">docker</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">docker</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">|</span> <span class="n">sudo</span> <span class="nb">tee </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">docker</span><span class="p">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span>
<span class="p">{</span>
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
</code></pre></div>
<h4 id="2592_kubelet">2.5.9.2 部署kubelet<a class="headerlink" href="#2592_kubelet" title="Permanent link">&para;</a></h4>
<blockquote>
<p>在k8s-master1上操作</p>
</blockquote>
<h5 id="25921_kubelet-bootstrapkubeconfig">2.5.9.2.1 创建kubelet-bootstrap.kubeconfig<a class="headerlink" href="#25921_kubelet-bootstrapkubeconfig" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">BOOTSTRAP_TOKEN</span><span class="p">=$(</span><span class="n">awk</span> <span class="o">-F</span> <span class="s2">&quot;,&quot;</span> <span class="s1">&#39;{print $1}&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">token</span><span class="p">.</span><span class="n">csv</span><span class="p">)</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-server</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">kubelet-bootstrap</span> <span class="p">-</span><span class="n">-token</span><span class="p">=${</span><span class="n">BOOTSTRAP_TOKEN</span><span class="p">}</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="k">default</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">kubelet-bootstrap</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="k">default</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">cluster-system-anonymous</span> <span class="p">-</span><span class="n">-clusterrole</span><span class="p">=</span><span class="n">cluster-admin</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">kubelet-bootstrap</span>

<span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">kubelet-bootstrap</span> <span class="p">-</span><span class="n">-clusterrole</span><span class="p">=</span><span class="n">system</span><span class="p">:</span><span class="n">node-bootstrapper</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">kubelet-bootstrap</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">clusterrolebinding</span> <span class="n">cluster-system-anonymous</span>

<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">clusterrolebinding</span> <span class="n">kubelet-bootstrap</span>
</code></pre></div>
<h5 id="25922_kubelet">2.5.9.2.2 创建kubelet配置文件<a class="headerlink" href="#25922_kubelet" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
  <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;KubeletConfiguration&quot;</span><span class="p">,</span>
  <span class="s2">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;kubelet.config.k8s.io/v1beta1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;authentication&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;x509&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;clientCAFile&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;webhook&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;cacheTTL&quot;</span><span class="p">:</span> <span class="s2">&quot;2m0s&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;anonymous&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;authorization&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;Webhook&quot;</span><span class="p">,</span>
    <span class="s2">&quot;webhook&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;cacheAuthorizedTTL&quot;</span><span class="p">:</span> <span class="s2">&quot;5m0s&quot;</span><span class="p">,</span>
      <span class="s2">&quot;cacheUnauthorizedTTL&quot;</span><span class="p">:</span> <span class="s2">&quot;30s&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.10.12&quot;</span><span class="p">,</span>
  <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">10250</span><span class="p">,</span>
  <span class="s2">&quot;readOnlyPort&quot;</span><span class="p">:</span> <span class="n">10255</span><span class="p">,</span>
  <span class="s2">&quot;cgroupDriver&quot;</span><span class="p">:</span> <span class="s2">&quot;systemd&quot;</span><span class="p">,</span>                    
  <span class="s2">&quot;hairpinMode&quot;</span><span class="p">:</span> <span class="s2">&quot;promiscuous-bridge&quot;</span><span class="p">,</span>
  <span class="s2">&quot;serializeImagePulls&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;clusterDomain&quot;</span><span class="p">:</span> <span class="s2">&quot;cluster.local.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;clusterDNS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.96.0.2&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<h5 id="25923_kubelet">2.5.9.2.3 创建kubelet配置文件<a class="headerlink" href="#25923_kubelet" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">service</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Kubelet</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">After</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>
<span class="n">Requires</span><span class="p">=</span><span class="n">docker</span><span class="p">.</span><span class="n">service</span>

<span class="no">[Service]</span>
<span class="n">WorkingDirectory</span><span class="p">=/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kubelet</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kubelet</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-bootstrap-kubeconfig</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-cert-dir</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-config</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">json</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-network-plugin</span><span class="p">=</span><span class="n">cni</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-rotate-certificates</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-pod-infra-container-image</span><span class="p">=</span><span class="n">registry</span><span class="p">.</span><span class="n">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">pause</span><span class="p">:</span><span class="n">3</span><span class="p">.</span><span class="n">2</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-alsologtostderr</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-logtostderr</span><span class="p">=</span><span class="n">false</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-log-dir</span><span class="p">=/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">kubernetes</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-v</span><span class="p">=</span><span class="n">2</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</code></pre></div>
<h5 id="25924">2.5.9.2.4 同步文件到集群节点<a class="headerlink" href="#25924" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kubelet</span><span class="p">.</span><span class="n">json</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="k">in</span>  <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="n">k8s-worker1</span><span class="p">;</span><span class="k">do</span> <span class="n">scp</span> <span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">json</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/;</span><span class="n">done</span>

<span class="k">for</span> <span class="n">i</span> <span class="k">in</span>  <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="n">k8s-worker1</span><span class="p">;</span><span class="k">do</span> <span class="n">scp</span> <span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/;</span><span class="n">done</span>

<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="n">k8s-worker1</span><span class="p">;</span><span class="k">do</span> <span class="n">scp</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">service</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/;</span><span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">kubelet</span><span class="p">.</span><span class="n">json中address需要修改为当前主机IP地址</span><span class="err">。</span>
</code></pre></div>
<h5 id="25925">2.5.9.2.5 创建目录及启动服务<a class="headerlink" href="#25925" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kubelet</span>
<span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">kubernetes</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">kubelet</span>

<span class="n">systemctl</span> <span class="n">status</span> <span class="n">kubelet</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>          <span class="n">STATUS</span>     <span class="n">ROLES</span>    <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">k8s-master1</span>   <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">2m55s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-master2</span>   <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">45s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-master3</span>   <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">39s</span>     <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-worker1</span>   <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">5m1s</span>    <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get csr</span>
<span class="n">NAME</span>        <span class="n">AGE</span>     <span class="n">SIGNERNAME</span>                                    <span class="n">REQUESTOR</span>           <span class="n">CONDITION</span>
<span class="n">csr-b949p</span>   <span class="n">7m55s</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver-client-kubelet</span>   <span class="n">kubelet-bootstrap</span>   <span class="n">Approved</span><span class="p">,</span><span class="n">Issued</span>
<span class="n">csr-c9hs4</span>   <span class="n">3m34s</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver-client-kubelet</span>   <span class="n">kubelet-bootstrap</span>   <span class="n">Approved</span><span class="p">,</span><span class="n">Issued</span>
<span class="n">csr-r8vhp</span>   <span class="n">5m50s</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver-client-kubelet</span>   <span class="n">kubelet-bootstrap</span>   <span class="n">Approved</span><span class="p">,</span><span class="n">Issued</span>
<span class="n">csr-zb4sr</span>   <span class="n">3m40s</span>   <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">kube-apiserver-client-kubelet</span>   <span class="n">kubelet-bootstrap</span>   <span class="n">Approved</span><span class="p">,</span><span class="n">Issued</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">确认kubelet服务启动成功后</span><span class="err">，</span><span class="n">接着到master上Approve一下bootstrap请求</span><span class="err">。</span>
</code></pre></div>
<h4 id="2593_kube-proxy">2.5.9.3 部署kube-proxy<a class="headerlink" href="#2593_kube-proxy" title="Permanent link">&para;</a></h4>
<h5 id="25931_kube-proxy">2.5.9.3.1 创建kube-proxy证书请求文件<a class="headerlink" href="#25931_kube-proxy" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-proxy-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">{</span>
  <span class="s2">&quot;CN&quot;</span><span class="p">:</span> <span class="s2">&quot;system:kube-proxy&quot;</span><span class="p">,</span>
  <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;algo&quot;</span><span class="p">:</span> <span class="s2">&quot;rsa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">2048</span>
  <span class="p">},</span>
  <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Beijing&quot;</span><span class="p">,</span>
      <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;kubemsb&quot;</span><span class="p">,</span>
      <span class="s2">&quot;OU&quot;</span><span class="p">:</span> <span class="s2">&quot;CN&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<h5 id="25932">2.5.9.3.2 生成证书<a class="headerlink" href="#25932" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">cfssl</span> <span class="n">gencert</span> <span class="n">-ca</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">-ca-key</span><span class="p">=</span><span class="n">ca-key</span><span class="p">.</span><span class="n">pem</span> <span class="n">-config</span><span class="p">=</span><span class="n">ca-config</span><span class="p">.</span><span class="n">json</span> <span class="n">-profile</span><span class="p">=</span><span class="n">kubernetes</span> <span class="n">kube-proxy-csr</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="n">cfssljson</span> <span class="n">-bare</span> <span class="n">kube-proxy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># ls kube-proxy*</span>
<span class="n">kube-proxy</span><span class="p">.</span><span class="n">csr</span>  <span class="n">kube-proxy-csr</span><span class="p">.</span><span class="n">json</span>  <span class="n">kube-proxy-key</span><span class="p">.</span><span class="n">pem</span>  <span class="n">kube-proxy</span><span class="p">.</span><span class="n">pem</span>
</code></pre></div>
<h5 id="25933_kubeconfig">2.5.9.3.3 创建kubeconfig文件<a class="headerlink" href="#25933_kubeconfig" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-cluster</span> <span class="n">kubernetes</span> <span class="p">-</span><span class="n">-certificate-authority</span><span class="p">=</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-server</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">100</span><span class="p">:</span><span class="n">6443</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-credentials</span> <span class="n">kube-proxy</span> <span class="p">-</span><span class="n">-client-certificate</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-client-key</span><span class="p">=</span><span class="n">kube-proxy-key</span><span class="p">.</span><span class="n">pem</span> <span class="p">-</span><span class="n">-embed-certs</span><span class="p">=</span><span class="n">true</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set-context</span> <span class="k">default</span> <span class="p">-</span><span class="n">-cluster</span><span class="p">=</span><span class="n">kubernetes</span> <span class="p">-</span><span class="n">-user</span><span class="p">=</span><span class="n">kube-proxy</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>

<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">use-context</span> <span class="k">default</span> <span class="p">-</span><span class="n">-kubeconfig</span><span class="p">=</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>
</code></pre></div>
<h5 id="25934">2.5.9.3.4 创建服务配置文件<a class="headerlink" href="#25934" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">yaml</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeproxy</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1alpha1</span>
<span class="n">bindAddress</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span>
<span class="n">clientConnection</span><span class="p">:</span>
  <span class="n">kubeconfig</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>
<span class="n">clusterCIDR</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
<span class="n">healthzBindAddress</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">10256</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">KubeProxyConfiguration</span>
<span class="n">metricsBindAddress</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span><span class="p">:</span><span class="n">10249</span>
<span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;ipvs&quot;</span>
<span class="n">EOF</span>
</code></pre></div>
<h5 id="25935">2.5.9.3.5 创建服务启动管理文件<a class="headerlink" href="#25935" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span>  <span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="no">[Unit]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">Kubernetes</span> <span class="n">Kube-Proxy</span> <span class="n">Server</span>
<span class="n">Documentation</span><span class="p">=</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kubernetes</span>
<span class="n">After</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="no">[Service]</span>
<span class="n">WorkingDirectory</span><span class="p">=/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kube-proxy</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-proxy</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-config</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">yaml</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-alsologtostderr</span><span class="p">=</span><span class="n">true</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-logtostderr</span><span class="p">=</span><span class="n">false</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-log-dir</span><span class="p">=/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">kubernetes</span> <span class="p">\</span>
  <span class="p">-</span><span class="n">-v</span><span class="p">=</span><span class="n">2</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on-failure</span>
<span class="n">RestartSec</span><span class="p">=</span><span class="n">5</span>
<span class="n">LimitNOFILE</span><span class="p">=</span><span class="n">65536</span>

<span class="no">[Install]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
<span class="n">EOF</span>
</code></pre></div>
<h5 id="25936">2.5.9.3.6 同步文件到集群工作节点主机<a class="headerlink" href="#25936" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="nb">cp </span><span class="n">kube-proxy</span><span class="p">*.</span><span class="n">pem</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">yaml</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="nb">cp </span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="n">k8s-worker1</span><span class="p">;</span><span class="k">do</span> <span class="n">scp</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">yaml</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/;</span><span class="n">done</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">k8s-master2</span> <span class="n">k8s-master3</span> <span class="n">k8s-worker1</span><span class="p">;</span><span class="k">do</span> <span class="n">scp</span>  <span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span> <span class="nv">$i</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/;</span><span class="n">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">说明</span><span class="err">：</span>
<span class="n">修改kube-proxy</span><span class="p">.</span><span class="n">yaml中IP地址为当前主机IP</span><span class="p">.</span>
</code></pre></div>
<h5 id="25937">2.5.9.3.7 服务启动<a class="headerlink" href="#25937" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">kube-proxy</span>
<span class="n">systemctl</span> <span class="n">daemon-reload</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">kube-proxy</span>

<span class="n">systemctl</span> <span class="n">status</span> <span class="n">kube-proxy</span>
</code></pre></div>
<h3 id="2510_calico">2.5.10 网络组件部署 Calico<a class="headerlink" href="#2510_calico" title="Permanent link">&para;</a></h3>
<h4 id="25101">2.5.10.1 下载<a class="headerlink" href="#25101" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">wget </span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v3</span><span class="p">.</span><span class="n">19</span><span class="p">/</span><span class="n">manifests</span><span class="p">/</span><span class="n">calico</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<h4 id="25102">2.5.10.2 修改文件<a class="headerlink" href="#25102" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">3683</span>             <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">CALICO_IPV4POOL_CIDR</span>
<span class="n">3684</span>               <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;10.244.0.0/16&quot;</span>
</code></pre></div>
<h4 id="25103">2.5.10.3 应用文件<a class="headerlink" href="#25103" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">calico</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<h4 id="25104">2.5.10.4 验证应用结果<a class="headerlink" href="#25104" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -A</span>
<span class="n">NAMESPACE</span>     <span class="n">NAME</span>                                       <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube-system</span>   <span class="n">calico-kube-controllers</span><span class="p">-</span><span class="n">7cc8dd57d9-tf2m5</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">72s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-llw5w</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">72s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-mhh6g</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">72s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-twj99</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">72s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-zh6xl</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">72s</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>          <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">k8s-master1</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">55m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-master2</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">53m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-master3</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">53m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-worker1</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">57m</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
</code></pre></div>
<h3 id="2510_coredns">2.5.10 部署CoreDNS<a class="headerlink" href="#2510_coredns" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span>  <span class="n">coredns</span><span class="p">.</span><span class="n">yaml</span> <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">coredns</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube-system</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">bootstrapping</span><span class="p">:</span> <span class="n">rbac-defaults</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">system</span><span class="p">:</span><span class="n">coredns</span>
<span class="n">rules</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">apiGroups</span><span class="p">:</span>
    <span class="p">-</span> <span class="s2">&quot;&quot;</span>
    <span class="n">resources</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">endpoints</span>
    <span class="p">-</span> <span class="n">services</span>
    <span class="p">-</span> <span class="n">pods</span>
    <span class="p">-</span> <span class="n">namespaces</span>
    <span class="n">verbs</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">list</span>
    <span class="p">-</span> <span class="n">watch</span>
  <span class="p">-</span> <span class="n">apiGroups</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">discovery</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>
    <span class="n">resources</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">endpointslices</span>
    <span class="n">verbs</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">list</span>
    <span class="p">-</span> <span class="n">watch</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRoleBinding</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">annotations</span><span class="p">:</span>
    <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">autoupdate</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">bootstrapping</span><span class="p">:</span> <span class="n">rbac-defaults</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">system</span><span class="p">:</span><span class="n">coredns</span>
<span class="n">roleRef</span><span class="p">:</span>
  <span class="n">apiGroup</span><span class="p">:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">system</span><span class="p">:</span><span class="n">coredns</span>
<span class="n">subjects</span><span class="p">:</span>
<span class="p">-</span> <span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">coredns</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube-system</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">coredns</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube-system</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">Corefile</span><span class="p">:</span> <span class="p">|</span>
    <span class="p">.:</span><span class="n">53</span> <span class="p">{</span>
        <span class="n">errors</span>
        <span class="n">health</span> <span class="p">{</span>
          <span class="n">lameduck</span> <span class="n">5s</span>
        <span class="p">}</span>
        <span class="n">ready</span>
        <span class="n">kubernetes</span> <span class="n">cluster</span><span class="p">.</span><span class="n">local</span>  <span class="k">in</span><span class="n">-addr</span><span class="p">.</span><span class="n">arpa</span> <span class="n">ip6</span><span class="p">.</span><span class="n">arpa</span> <span class="p">{</span>
          <span class="n">fallthrough</span> <span class="k">in</span><span class="n">-addr</span><span class="p">.</span><span class="n">arpa</span> <span class="n">ip6</span><span class="p">.</span><span class="n">arpa</span>
        <span class="p">}</span>
        <span class="n">prometheus</span> <span class="p">:</span><span class="n">9153</span>
        <span class="n">forward</span> <span class="p">.</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">resolv</span><span class="p">.</span><span class="n">conf</span> <span class="p">{</span>
          <span class="n">max_concurrent</span> <span class="n">1000</span>
        <span class="p">}</span>
        <span class="n">cache</span> <span class="n">30</span>
        <span class="n">loop</span>
        <span class="n">reload</span>
        <span class="n">loadbalance</span>
    <span class="p">}</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">coredns</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube-system</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s-app</span><span class="p">:</span> <span class="n">kube-dns</span>
    <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;CoreDNS&quot;</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="c"># replicas: not specified here:</span>
  <span class="c"># 1. Default is 1.</span>
  <span class="c"># 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span>
  <span class="n">strategy</span><span class="p">:</span>
    <span class="n">type</span><span class="p">:</span> <span class="n">RollingUpdate</span>
    <span class="n">rollingUpdate</span><span class="p">:</span>
      <span class="n">maxUnavailable</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">k8s-app</span><span class="p">:</span> <span class="n">kube-dns</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">k8s-app</span><span class="p">:</span> <span class="n">kube-dns</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">priorityClassName</span><span class="p">:</span> <span class="n">system-cluster-critical</span>
      <span class="n">serviceAccountName</span><span class="p">:</span> <span class="n">coredns</span>
      <span class="n">tolerations</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">key</span><span class="p">:</span> <span class="s2">&quot;CriticalAddonsOnly&quot;</span>
          <span class="n">operator</span><span class="p">:</span> <span class="s2">&quot;Exists&quot;</span>
      <span class="n">nodeSelector</span><span class="p">:</span>
        <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">os</span><span class="p">:</span> <span class="n">linux</span>
      <span class="n">affinity</span><span class="p">:</span>
         <span class="n">podAntiAffinity</span><span class="p">:</span>
           <span class="n">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
           <span class="p">-</span> <span class="n">weight</span><span class="p">:</span> <span class="n">100</span>
             <span class="n">podAffinityTerm</span><span class="p">:</span>
               <span class="n">labelSelector</span><span class="p">:</span>
                 <span class="n">matchExpressions</span><span class="p">:</span>
                   <span class="p">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">k8s-app</span>
                     <span class="n">operator</span><span class="p">:</span> <span class="k">In</span>
                     <span class="n">values</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;kube-dns&quot;</span><span class="p">]</span>
               <span class="n">topologyKey</span><span class="p">:</span> <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">hostname</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">coredns</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">coredns</span><span class="p">/</span><span class="n">coredns</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">4</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
        <span class="n">resources</span><span class="p">:</span>
          <span class="n">limits</span><span class="p">:</span>
            <span class="n">memory</span><span class="p">:</span> <span class="n">170Mi</span>
          <span class="n">requests</span><span class="p">:</span>
            <span class="n">cpu</span><span class="p">:</span> <span class="n">100m</span>
            <span class="n">memory</span><span class="p">:</span> <span class="n">70Mi</span>
        <span class="n">args</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;-conf&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/coredns/Corefile&quot;</span> <span class="p">]</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config-volume</span>
          <span class="n">mountPath</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">coredns</span>
          <span class="n">readOnly</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">53</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">dns</span>
          <span class="n">protocol</span><span class="p">:</span> <span class="n">UDP</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">53</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">dns-tcp</span>
          <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
        <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">9153</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span>
          <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
        <span class="n">securityContext</span><span class="p">:</span>
          <span class="n">allowPrivilegeEscalation</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">capabilities</span><span class="p">:</span>
            <span class="n">add</span><span class="p">:</span>
            <span class="p">-</span> <span class="n">NET_BIND_SERVICE</span>
            <span class="n">drop</span><span class="p">:</span>
            <span class="p">-</span> <span class="n">all</span>
          <span class="n">readOnlyRootFilesystem</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">livenessProbe</span><span class="p">:</span>
          <span class="n">httpGet</span><span class="p">:</span>
            <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">health</span>
            <span class="n">port</span><span class="p">:</span> <span class="n">8080</span>
            <span class="n">scheme</span><span class="p">:</span> <span class="n">HTTP</span>
          <span class="n">initialDelaySeconds</span><span class="p">:</span> <span class="n">60</span>
          <span class="n">timeoutSeconds</span><span class="p">:</span> <span class="n">5</span>
          <span class="n">successThreshold</span><span class="p">:</span> <span class="n">1</span>
          <span class="n">failureThreshold</span><span class="p">:</span> <span class="n">5</span>
        <span class="n">readinessProbe</span><span class="p">:</span>
          <span class="n">httpGet</span><span class="p">:</span>
            <span class="n">path</span><span class="p">:</span> <span class="p">/</span><span class="n">ready</span>
            <span class="n">port</span><span class="p">:</span> <span class="n">8181</span>
            <span class="n">scheme</span><span class="p">:</span> <span class="n">HTTP</span>
      <span class="n">dnsPolicy</span><span class="p">:</span> <span class="k">Default</span>
      <span class="n">volumes</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config-volume</span>
          <span class="n">configMap</span><span class="p">:</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">coredns</span>
            <span class="n">items</span><span class="p">:</span>
            <span class="p">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">Corefile</span>
              <span class="n">path</span><span class="p">:</span> <span class="n">Corefile</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">kube-dns</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube-system</span>
  <span class="n">annotations</span><span class="p">:</span>
    <span class="n">prometheus</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">port</span><span class="p">:</span> <span class="s2">&quot;9153&quot;</span>
    <span class="n">prometheus</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">scrape</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s-app</span><span class="p">:</span> <span class="n">kube-dns</span>
    <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">cluster-service</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;CoreDNS&quot;</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">k8s-app</span><span class="p">:</span> <span class="n">kube-dns</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">dns</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">53</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">UDP</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">dns-tcp</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">53</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
  <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span>
    <span class="n">port</span><span class="p">:</span> <span class="n">9153</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>

<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">coredns</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -A</span>
<span class="n">NAMESPACE</span>     <span class="n">NAME</span>                                       <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube-system</span>   <span class="n">calico-kube-controllers</span><span class="p">-</span><span class="n">7cc8dd57d9-tf2m5</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">4m7s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-llw5w</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">4m7s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-mhh6g</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">4m7s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-twj99</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">4m7s</span>
<span class="n">kube-system</span>   <span class="n">calico-node-zh6xl</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">4m7s</span>
<span class="n">kube-system</span>   <span class="n">coredns</span><span class="p">-</span><span class="n">675db8b7cc-ncnf6</span>                   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">26s</span>
</code></pre></div>
<h3 id="2511">2.5.11 部署应用验证<a class="headerlink" href="#2511" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span>  <span class="n">nginx</span><span class="p">.</span><span class="n">yaml</span>  <span class="p">&lt;&lt;</span> <span class="s2">&quot;EOF&quot;</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ReplicationController</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-web</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">6</span>
          <span class="n">ports</span><span class="p">:</span>
            <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-service-nodeport</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">30001</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">nginx</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -o wide</span>
<span class="n">NAME</span>                     <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>              <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">nginx-web-qzvw4</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">58s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">194</span><span class="p">.</span><span class="n">65</span>   <span class="n">k8s-worker1</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
<span class="n">nginx-web-spw5t</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">58s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">224</span><span class="p">.</span><span class="n">1</span>    <span class="n">k8s-master2</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get all</span>
<span class="n">NAME</span>                         <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod</span><span class="p">/</span><span class="n">nginx-web-qzvw4</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m2s</span>
<span class="n">pod</span><span class="p">/</span><span class="n">nginx-web-spw5t</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">2m2s</span>

<span class="n">NAME</span>                                     <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">replicationcontroller</span><span class="p">/</span><span class="n">nginx-web</span>   <span class="n">2</span>         <span class="n">2</span>         <span class="n">2</span>       <span class="n">2m2s</span>

<span class="n">NAME</span>                             <span class="nb">TYPE </span>       <span class="n">CLUSTER-IP</span>      <span class="n">EXTERNAL-IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>        <span class="n">AGE</span>
<span class="n">service</span><span class="p">/</span><span class="n">kubernetes</span>               <span class="n">ClusterIP</span>   <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>       <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">443</span><span class="p">/</span><span class="n">TCP</span>        <span class="n">3h37m</span>
<span class="n">service</span><span class="p">/</span><span class="n">nginx-service-nodeport</span>   <span class="n">NodePort</span>    <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">165</span><span class="p">.</span><span class="n">114</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>        <span class="n">80</span><span class="p">:</span><span class="n">30001</span><span class="p">/</span><span class="n">TCP</span>   <span class="n">2m2s</span>
</code></pre></div>
<p><img alt="image-20220319014727332" src="../../../img/kubernetes/kubernetes_hight_bin/image-20220319014727332.png" /></p>
<h2 id="26_kubernetes">2.6 Kubernetes集群节点管理<a class="headerlink" href="#26_kubernetes" title="Permanent link">&para;</a></h2>
<blockquote>
<p>本小节主要介绍worker节点管理</p>
</blockquote>
<h3 id="261">2.6.1 主机准备<a class="headerlink" href="#261" title="Permanent link">&para;</a></h3>
<h4 id="2611">2.6.1.1 主机名设置<a class="headerlink" href="#2611" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">hostnamectl</span> <span class="nb">set-hostname</span> <span class="n">k8s-worker4</span>
</code></pre></div>
<h4 id="2612_ip">2.6.1.2 主机与IP地址解析<a class="headerlink" href="#2612_ip" title="Permanent link">&para;</a></h4>
<blockquote>
<p>集群中已有节点也需要添加新节点的解析。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">hosts</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">10</span> <span class="n">ha1</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">11</span> <span class="n">ha2</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">12</span> <span class="n">k8s-master1</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">13</span> <span class="n">k8s-master2</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">14</span> <span class="n">k8s-master3</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">15</span> <span class="n">k8s-worker1</span>
<span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">19</span> <span class="n">k8s-worker4</span>

<span class="n">EOF</span>
</code></pre></div>
<h4 id="2613">2.6.1.3 主机安全设置<a class="headerlink" href="#2613" title="Permanent link">&para;</a></h4>
<h5 id="26131">2.6.1.3.1 关闭防火墙<a class="headerlink" href="#26131" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">firewalld</span>
<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">firewalld</span>
<span class="n">firewall-cmd</span> <span class="p">-</span><span class="n">-state</span>
</code></pre></div>
<h5 id="26132_selinux">2.6.1.3.2 关闭selinux<a class="headerlink" href="#26132_selinux" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="n">setenforce</span> <span class="n">0</span>
<span class="n">sed</span> <span class="n">-ri</span> <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">selinux</span><span class="p">/</span><span class="n">config</span>
<span class="n">sestatus</span>
</code></pre></div>
<h4 id="2614">2.6.1.4 交换分区设置<a class="headerlink" href="#2614" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">swapoff</span> <span class="n">-a</span>
<span class="n">sed</span> <span class="n">-ri</span> <span class="s1">&#39;s/.*swap.*/#&amp;/&#39;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
<span class="nb">echo </span><span class="s2">&quot;vm.swappiness=0&quot;</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">sysctl</span> <span class="n">-p</span>
</code></pre></div>
<h4 id="2615">2.6.1.5 主机系统时间同步<a class="headerlink" href="#2615" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">安装软件</span>
<span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">ntpdate</span>

<span class="n">制定时间同步计划任务</span>
<span class="n">crontab</span> <span class="n">-e</span>
<span class="n">0</span> <span class="p">*/</span><span class="n">1</span> <span class="p">*</span> <span class="p">*</span> <span class="p">*</span> <span class="n">ntpdate</span> <span class="n">time1</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<h4 id="2616">2.6.1.6 主机系统优化<a class="headerlink" href="#2616" title="Permanent link">&para;</a></h4>
<blockquote>
<p>limit优化</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">ulimit</span> <span class="n">-SHn</span> <span class="n">65535</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">security</span><span class="p">/</span><span class="n">limits</span><span class="p">.</span><span class="n">conf</span>
<span class="p">*</span> <span class="n">soft</span> <span class="n">nofile</span> <span class="n">655360</span>
<span class="p">*</span> <span class="n">hard</span> <span class="n">nofile</span> <span class="n">131072</span>
<span class="p">*</span> <span class="n">soft</span> <span class="n">nproc</span> <span class="n">655350</span>
<span class="p">*</span> <span class="n">hard</span> <span class="n">nproc</span> <span class="n">655350</span>
<span class="p">*</span> <span class="n">soft</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="p">*</span> <span class="n">hard</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="n">EOF</span>
</code></pre></div>
<h4 id="2617_ipvs">2.6.1.7 ipvs管理工具安装及模块加载<a class="headerlink" href="#2617_ipvs" title="Permanent link">&para;</a></h4>
<blockquote>
<p>为集群节点安装，负载均衡节点不用安装</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">ipvsadm</span> <span class="n">ipset</span> <span class="n">sysstat</span> <span class="n">conntrack</span> <span class="n">libseccomp</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有节点配置ipvs模块</span><span class="err">，</span><span class="n">在内核4</span><span class="p">.</span><span class="n">19</span><span class="p">+</span><span class="n">版本nf_conntrack_ipv4已经改为nf_conntrack</span><span class="err">，</span> <span class="n">4</span><span class="p">.</span><span class="n">18以下使用nf_conntrack_ipv4即可</span><span class="err">：</span> 

<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_rr</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_wrr</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_sh</span> 
<span class="n">modprobe</span> <span class="p">--</span> <span class="n">nf_conntrack</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">modules-load</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">ipvs</span><span class="p">.</span><span class="n">conf</span> <span class="n">并加入以下内容</span><span class="err">：</span> 
<span class="nb">cat </span><span class="p">&gt;/</span><span class="n">etc</span><span class="p">/</span><span class="n">modules-load</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">ipvs</span><span class="p">.</span><span class="n">conf</span> <span class="p">&lt;&lt;</span><span class="n">EOF</span> 
<span class="n">ip_vs</span> 
<span class="n">ip_vs_lc</span> 
<span class="n">ip_vs_wlc</span> 
<span class="n">ip_vs_rr</span> 
<span class="n">ip_vs_wrr</span> 
<span class="n">ip_vs_lblc</span> 
<span class="n">ip_vs_lblcr</span> 
<span class="n">ip_vs_dh</span> 
<span class="n">ip_vs_sh</span> 
<span class="n">ip_vs_fo</span> 
<span class="n">ip_vs_nq</span> 
<span class="n">ip_vs_sed</span> 
<span class="n">ip_vs_ftp</span> 
<span class="n">ip_vs_sh</span> 
<span class="n">nf_conntrack</span> 
<span class="n">ip_tables</span> 
<span class="n">ip_set</span> 
<span class="n">xt_set</span> 
<span class="n">ipt_set</span> 
<span class="n">ipt_rpfilter</span> 
<span class="n">ipt_REJECT</span> 
<span class="n">ipip</span> 
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">设置为开机启动</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="p">-</span><span class="n">-now</span> <span class="n">systemd-modules-load</span><span class="p">.</span><span class="n">service</span>
</code></pre></div>
<h4 id="2618_linux">2.6.1.8 Linux内核升级<a class="headerlink" href="#2618_linux" title="Permanent link">&para;</a></h4>
<blockquote>
<p>在所有节点中安装,需要重新操作系统更换内核。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum -y install perl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># yum  --enablerepo=&quot;elrepo-kernel&quot;  -y install kernel-ml.x86_64</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># grub2-set-default 0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@localhost</span> <span class="p">~]</span><span class="c"># grub2-mkconfig -o /boot/grub2/grub.cfg</span>
</code></pre></div>
<h4 id="2619_linux">2.6.1.9 Linux内核优化<a class="headerlink" href="#2619_linux" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">&gt;</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">k8s</span><span class="p">.</span><span class="n">conf</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-iptables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="n">bridge-nf-call-ip6tables</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">fs</span><span class="p">.</span><span class="n">may_detach_mounts</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">vm</span><span class="p">.</span><span class="n">overcommit_memory</span><span class="p">=</span><span class="n">1</span>
<span class="n">vm</span><span class="p">.</span><span class="n">panic_on_oom</span><span class="p">=</span><span class="n">0</span>
<span class="n">fs</span><span class="p">.</span><span class="n">inotify</span><span class="p">.</span><span class="n">max_user_watches</span><span class="p">=</span><span class="n">89100</span>
<span class="n">fs</span><span class="p">.</span><span class="n">file-max</span><span class="p">=</span><span class="n">52706963</span>
<span class="n">fs</span><span class="p">.</span><span class="n">nr_open</span><span class="p">=</span><span class="n">52706963</span>
<span class="n">net</span><span class="p">.</span><span class="n">netfilter</span><span class="p">.</span><span class="n">nf_conntrack_max</span><span class="p">=</span><span class="n">2310720</span>

<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_time</span> <span class="p">=</span> <span class="n">600</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_probes</span> <span class="p">=</span> <span class="n">3</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_keepalive_intvl</span> <span class="p">=</span><span class="n">15</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_tw_buckets</span> <span class="p">=</span> <span class="n">36000</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_tw_reuse</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_orphans</span> <span class="p">=</span> <span class="n">327680</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_orphan_retries</span> <span class="p">=</span> <span class="n">3</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_syncookies</span> <span class="p">=</span> <span class="n">1</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_syn_backlog</span> <span class="p">=</span> <span class="n">16384</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_conntrack_max</span> <span class="p">=</span> <span class="n">131072</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_max_syn_backlog</span> <span class="p">=</span> <span class="n">16384</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_timestamps</span> <span class="p">=</span> <span class="n">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">somaxconn</span> <span class="p">=</span> <span class="n">16384</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sysctl</span> <span class="p">-</span><span class="n">-system</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">所有节点配置完内核后</span><span class="err">，</span><span class="n">重启服务器</span><span class="err">，</span><span class="n">保证重启后内核依旧加载</span>
<span class="n">reboot</span> <span class="n">-h</span> <span class="n">now</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">重启后查看结果</span><span class="err">：</span>
<span class="n">lsmod</span> <span class="p">|</span> <span class="n">grep</span> <span class="p">-</span><span class="n">-color</span><span class="p">=</span><span class="n">auto</span> <span class="n">-e</span> <span class="n">ip_vs</span> <span class="n">-e</span> <span class="n">nf_conntrack</span>
</code></pre></div>
<h4 id="26110">2.6.1.10 其它工具安装(选装)<a class="headerlink" href="#26110" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">install</span> <span class="nb">wget </span><span class="n">jq</span> <span class="n">psmisc</span> <span class="n">vim</span> <span class="n">net-tools</span> <span class="n">telnet</span> <span class="n">yum-utils</span> <span class="n">device-mapper-persistent-data</span> <span class="n">lvm2</span> <span class="n">git</span> <span class="n">lrzsz</span> <span class="n">-y</span>
</code></pre></div>
<h3 id="262">2.6.2 配置免密登录<a class="headerlink" href="#262" title="Permanent link">&para;</a></h3>
<blockquote>
<p>在k8s-master1节点操作</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">ssh-copy-id</span> <span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span>
</code></pre></div>
<h3 id="263_kubernetes">2.6.3 Kubernetes软件包获取<a class="headerlink" href="#263_kubernetes" title="Permanent link">&para;</a></h3>
<h4 id="2631">2.6.3.1 软件包获取<a class="headerlink" href="#2631" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="n">bin</span><span class="p">]</span><span class="c"># pwd</span>
<span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">k8s-work</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">server</span><span class="p">/</span><span class="n">bin</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="n">kubelet</span> <span class="n">kube-proxy</span> <span class="n">k8s-worker4</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># ls /usr/local/bin/kube*</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kubelet</span>
<span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">kube-proxy</span>
</code></pre></div>
<h4 id="2632_docker-ce">2.6.3.2 docker-ce安装及配置<a class="headerlink" href="#2632_docker-ce" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nb">wget </span><span class="n">-O</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">yum</span><span class="p">.</span><span class="n">repos</span><span class="p">.</span><span class="n">d</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span> <span class="n">https</span><span class="p">://</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">/</span><span class="n">linux</span><span class="p">/</span><span class="n">centos</span><span class="p">/</span><span class="n">docker-ce</span><span class="p">.</span><span class="n">repo</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">yum</span> <span class="n">-y</span> <span class="n">install</span> <span class="n">docker-ce</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">docker</span>
<span class="n">systemctl</span> <span class="nb">start </span><span class="n">docker</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&lt;&lt;</span><span class="n">EOF</span> <span class="p">|</span> <span class="n">sudo</span> <span class="nb">tee </span><span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">docker</span><span class="p">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span>
<span class="p">{</span>
  <span class="s2">&quot;exec-opts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;native.cgroupdriver=systemd&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
</code></pre></div>
<h4 id="2633_kubelet">2.6.3.3 部署kubelet<a class="headerlink" href="#2633_kubelet" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># mkdir -p /etc/kubernetes</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># mkdir -p /etc/kubernetes/ssl</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># mkdir -p /var/lib/kubelet</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># mkdir -p /var/log/kubernetes</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-master1</span> <span class="n">k8s-work</span><span class="p">]</span><span class="c"># pwd</span>
<span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">k8s-work</span>

<span class="n">scp</span> <span class="n">kubelet-bootstrap</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">json</span> <span class="n">k8s-worker4</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>

<span class="n">scp</span> <span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="n">k8s-worker4</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span>

<span class="n">scp</span> <span class="n">kubelet</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-worker4</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">修改kubelet</span><span class="p">.</span><span class="n">json文件</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># vim /etc/kubernetes/kubelet.json</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># cat /etc/kubernetes/kubelet.json</span>
<span class="p">{</span>
  <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;KubeletConfiguration&quot;</span><span class="p">,</span>
  <span class="s2">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;kubelet.config.k8s.io/v1beta1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;authentication&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;x509&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;clientCAFile&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;webhook&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;cacheTTL&quot;</span><span class="p">:</span> <span class="s2">&quot;2m0s&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;anonymous&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;authorization&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;Webhook&quot;</span><span class="p">,</span>
    <span class="s2">&quot;webhook&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;cacheAuthorizedTTL&quot;</span><span class="p">:</span> <span class="s2">&quot;5m0s&quot;</span><span class="p">,</span>
      <span class="s2">&quot;cacheUnauthorizedTTL&quot;</span><span class="p">:</span> <span class="s2">&quot;30s&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.10.19&quot;</span><span class="p">,</span>
  <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">10250</span><span class="p">,</span>
  <span class="s2">&quot;readOnlyPort&quot;</span><span class="p">:</span> <span class="n">10255</span><span class="p">,</span>
  <span class="s2">&quot;cgroupDriver&quot;</span><span class="p">:</span> <span class="s2">&quot;systemd&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hairpinMode&quot;</span><span class="p">:</span> <span class="s2">&quot;promiscuous-bridge&quot;</span><span class="p">,</span>
  <span class="s2">&quot;serializeImagePulls&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;clusterDomain&quot;</span><span class="p">:</span> <span class="s2">&quot;cluster.local.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;clusterDNS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.96.0.2&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># systemctl enable --now kubelet</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># systemctl status kubelet</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get nodes</span>
<span class="n">NAME</span>          <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">k8s-master1</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">41h</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-master2</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">41h</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-master3</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">41h</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-worker1</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">41h</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
<span class="n">k8s-worker4</span>   <span class="n">Ready</span>    <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>   <span class="n">55s</span>   <span class="n">v1</span><span class="p">.</span><span class="n">21</span><span class="p">.</span><span class="n">10</span>
</code></pre></div>
<h4 id="2634_kube-proxy">2.6.3.4 部署kube-proxy<a class="headerlink" href="#2634_kube-proxy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">scp</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span> <span class="n">kube-proxy</span><span class="p">.</span><span class="n">yaml</span> <span class="n">k8s-worker4</span><span class="p">:/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span>
<span class="n">scp</span>  <span class="n">kube-proxy</span><span class="p">.</span><span class="n">service</span> <span class="n">k8s-worker4</span><span class="p">:/</span><span class="n">usr</span><span class="p">/</span><span class="n">lib</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker2</span> <span class="p">~]</span><span class="c"># vim /etc/kubernetes/kube-proxy.yaml</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker2</span> <span class="p">~]</span><span class="c"># cat /etc/kubernetes/kube-proxy.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">kubeproxy</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1alpha1</span>
<span class="n">bindAddress</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">19</span>
<span class="n">clientConnection</span><span class="p">:</span>
  <span class="n">kubeconfig</span><span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">kube-proxy</span><span class="p">.</span><span class="n">kubeconfig</span>
<span class="n">clusterCIDR</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
<span class="n">healthzBindAddress</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">19</span><span class="p">:</span><span class="n">10256</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">KubeProxyConfiguration</span>
<span class="n">metricsBindAddress</span><span class="p">:</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">19</span><span class="p">:</span><span class="n">10249</span>
<span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;ipvs&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># mkdir -p /var/lib/kube-proxy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># systemctl daemon-reload</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># systemctl enable --now kube-proxy</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@k8s</span><span class="n">-worker4</span> <span class="p">~]</span><span class="c"># systemctl status kube-proxy</span>
</code></pre></div>
<h3 id="264">2.6.4  验证<a class="headerlink" href="#264" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c"># kubectl get pods -n kube-system -o wide</span>
<span class="n">NAME</span>                                       <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>               <span class="n">NODE</span>          <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>

<span class="n">calico-node-dkndr</span>                          <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">19s</span>   <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">10</span><span class="p">.</span><span class="n">19</span>    <span class="n">k8s-worker4</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>           <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">kubectl</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">k8s-worker3</span> <span class="n">deploy</span><span class="p">.</span><span class="n">type</span><span class="p">=</span><span class="n">nginxapp</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cat </span><span class="p">&gt;</span> <span class="n">nginx</span><span class="p">.</span><span class="n">yaml</span> <span class="p">&lt;&lt;</span> <span class="n">EOF</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ReplicationController</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-web</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="n">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">nodeSelector</span><span class="p">:</span>
        <span class="n">deploy</span><span class="p">.</span><span class="n">type</span><span class="p">:</span> <span class="n">nginxapp</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">19</span><span class="p">.</span><span class="n">6</span>
          <span class="n">ports</span><span class="p">:</span>
            <span class="p">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="n">80</span>
<span class="p">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx-service-nodeport</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="n">80</span>
      <span class="n">nodePort</span><span class="p">:</span> <span class="n">30001</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
  <span class="n">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
<span class="n">EOF</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      BurningMyself<a href='https://beian.miit.gov.cn/' target='_blank'>  蜀ICP备15033200号-1</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/burningmyself" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitee.com/burningmyself" target="_blank" rel="noopener" title="gitee.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155084439-1"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155132293-1"></script>
      
        <script src="../../../js/google.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>