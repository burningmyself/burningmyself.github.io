
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content=".net,java,php,python,docker,web">
      
      
        <meta name="author" content="BurningMyself">
      
      
        <link rel="canonical" href="https://burningmyself.gitee.io/cloud/kubernetes/kubernetes_calico/">
      
      
        <link rel="prev" href="../kubernetes_flannel/">
      
      
        <link rel="next" href="../kubernetes_hybridnet/">
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>kubernetes集群网络解决方案 calico - BurningMyself</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kubernetes_calico" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="BurningMyself" class="md-header__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BurningMyself
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              kubernetes集群网络解决方案 calico
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BurningMyself" class="md-nav__button md-logo" aria-label="BurningMyself" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BurningMyself
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/burningmyself/burningmyself.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    burningmyself.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          技术博文
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          技术博文
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          .NET
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          .NET
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sharp/" class="md-nav__link">
        C#新特性语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_docker/" class="md-nav__link">
        .Net Core Docker 部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_sqlserver_nginx/" class="md-nav__link">
        Docker 容器化部署 ASP.NET Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_safety/" class="md-nav__link">
        让你的ASP.NET Core应用程序更安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../net/c_core_study_route/" class="md-nav__link">
        ASP.NET Core开发者指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/feature/" class="md-nav__link">
        Java特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/load-class/" class="md-nav__link">
        Java类加载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/orm/" class="md-nav__link">
        Orm的优缺点
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/bio-nio/" class="md-nav__link">
        BIO与NIO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/rocketmq/rmq-1/" class="md-nav__link">
        RocketMq下载与安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springAnnotation/" class="md-nav__link">
        Spring常用注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/javavm/" class="md-nav__link">
        Java 虚拟机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/springdesign/" class="md-nav__link">
        Spring 常用设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/spring-cloud/" class="md-nav__link">
        Spring Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-simple/" class="md-nav__link">
        Java simple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-validator/" class="md-nav__link">
        Java Validator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-string/" class="md-nav__link">
        Java String
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../java/java-utils/" class="md-nav__link">
        Java Utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/feature/" class="md-nav__link">
        Python特性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/str_joint/" class="md-nav__link">
        Python字符拼接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/syntax_rule/" class="md-nav__link">
        Python语法技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/fabric/" class="md-nav__link">
        远程部署神器 Fabric
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
          Go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../go/go_base/" class="md-nav__link">
        Go基础语法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
          PHP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          PHP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../php/kj/" class="md-nav__link">
        框架
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/es6/" class="md-nav__link">
        es6语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/ali_js_style/" class="md-nav__link">
        阿里js样式规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/node.js/" class="md-nav__link">
        node.js文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react/" class="md-nav__link">
        React 开发者指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../dart/syntax/" class="md-nav__link">
        Dart语法学习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/react_interview/" class="md-nav__link">
        React 面试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/js_tool_method/" class="md-nav__link">
        js 工具函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/vue_cp_react/" class="md-nav__link">
        vue与react比较
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../web/javascript/" class="md-nav__link">
        JavaScript 基础
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_yh17/" class="md-nav__link">
        MySQL优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_log/" class="md-nav__link">
        MySQL日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_index/" class="md-nav__link">
        MySQL索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_pxc/" class="md-nav__link">
        MySQL PXC集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_use/" class="md-nav__link">
        MySQL 数据库应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mysql_backups/" class="md-nav__link">
        MySql 备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/sql_server_master/" class="md-nav__link">
        Sql Server 主从备份
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/data_split/" class="md-nav__link">
        数据库之互联网常用分库分表方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../sql/mybatis/" class="md-nav__link">
        Mybatis使用心德
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
      
      
      
        <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/linux/" class="md-nav__link">
        Linux学习笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/often/" class="md-nav__link">
        常用命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../linux/ope/" class="md-nav__link">
        实用的Linux 命令
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker/" class="md-nav__link">
        Docker全科
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker_core/" class="md-nav__link">
        Docker 核心技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-compose/" class="md-nav__link">
        docker和docker-compose配置常用环境
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-jenkins/" class="md-nav__link">
        Docker部署Jenkins
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../docker/docker-phabricator/" class="md-nav__link">
        Docker部署Phabricator
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
      
      
      
        <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_10">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_fw_rule_and_object_design/" class="md-nav__link">
        Kubernetes架构原则和对象设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_etcd/" class="md-nav__link">
        Kubernetes控制平面组件etcd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_kube_APIServer/" class="md-nav__link">
        深入理解Kube-APIServer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../kubernetes/k8s_controller_manager/" class="md-nav__link">
        kubernetes控制平面组件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
      
      
      
        <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
          Tool
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_11">
          <span class="md-nav__icon md-icon"></span>
          Tool
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitusual/" class="md-nav__link">
        Git动画展示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitquestion/" class="md-nav__link">
        Git问题处理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitflow/" class="md-nav__link">
        GitFlow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitbook/" class="md-nav__link">
        GitBook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitcmr/" class="md-nav__link">
        Git提交日志规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/markdown/" class="md-nav__link">
        Markdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cicd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/mkdocs/" class="md-nav__link">
        mkdocs简单使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/gitstudy/" class="md-nav__link">
        Git的黑魔法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/minio/" class="md-nav__link">
        MinIO 搭建使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tool/cat-monitoring/" class="md-nav__link">
        Cat分布式监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          云架构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          云架构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../native/" class="md-nav__link">
        云原生
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../virtual/" class="md-nav__link">
        虚拟化技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compute/" class="md-nav__link">
        云计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprelease/" class="md-nav__link">
        应用部署容器化演进
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../containerlinux/" class="md-nav__link">
        容器技术所涉及Linux内核关键技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_native/" class="md-nav__link">
        容器管理工具Docker生态架构及部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_nginx/" class="md-nav__link">
        使用容器运行Nginx应用及Docker命令
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image/" class="md-nav__link">
        Docker容器镜像
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_image_fast/" class="md-nav__link">
        Docker容器镜像加速器及本地容器镜像仓库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container_enterprice/" class="md-nav__link">
        Docker容器化部署企业级应用集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_file/" class="md-nav__link">
        Dockerfile精讲及新型容器镜像构建技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_network/" class="md-nav__link">
        Docker容器网络与通信原理深度解析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_date/" class="md-nav__link">
        Docker容器数据持久化存储机制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_compose/" class="md-nav__link">
        Docker容器服务编排利器Docker Compose应用实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_swarm/" class="md-nav__link">
        Docker主机集群化方案 Docker Swarm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_devops/" class="md-nav__link">
        基于Docker容器DevOps应用方案 企业业务代码发布系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/docker_container/" class="md-nav__link">
        轻量级或工业级容器管理工具
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
          Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        kubeadm极速部署Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_introduce/" class="md-nav__link">
        kubernetes介绍与集群架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_way/" class="md-nav__link">
        Kubernetes集群部署方式说明
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_master/" class="md-nav__link">
        kubeadm部署单Master节点kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight/" class="md-nav__link">
        kubeadm部署高可用kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rke/" class="md-nav__link">
        使用RKE构建企业生产级Kubernetes集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin1/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）一
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hight_bin2/" class="md-nav__link">
        Kubernetes高可用集群二进制部署（Runtime Docker）二
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        Kubernetes集群UI及主机资源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_sealos/" class="md-nav__link">
        使用sealos部署kubernetes集群并实现集群管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster/" class="md-nav__link">
        kubernetes集群命令语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_core/" class="md-nav__link">
        Kubernetes核心概念
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_nginx_ingress_controller/" class="md-nav__link">
        Kubernetes集群 服务暴露 Nginx Ingress Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_traefik/" class="md-nav__link">
        Kubernetes集群 服务暴露 Traefik
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_configMap_secret/" class="md-nav__link">
        Kubernetes配置与密钥管理 ConfigMap&Secret
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_harbor/" class="md-nav__link">
        Kubernetes集群使用容器镜像仓库Harbor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_safety/" class="md-nav__link">
        Kubernetes集群安全管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_volume/" class="md-nav__link">
        kubernetes持久化存储卷
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_storage_ceph/" class="md-nav__link">
        kubernetes存储解决方案Ceph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_cluster_serve/" class="md-nav__link">
        Kubernetes集群公共服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_java/" class="md-nav__link">
        kubernetes集群java项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_python/" class="md-nav__link">
        kubernetes集群Python项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_deploy_golang/" class="md-nav__link">
        Kubernetes集群golang项目上云部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_logs_collect/" class="md-nav__link">
        kubernetes日志收集方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_zookeeper/" class="md-nav__link">
        企业级中间件上云部署 zookeeper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kafka/" class="md-nav__link">
        kubernetes云原生中间件上云部署 kafka
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rokectmq/" class="md-nav__link">
        rocketmq部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_helm/" class="md-nav__link">
        Kubernetes集群包管理解决方案 Helm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kustomize/" class="md-nav__link">
        Kubernetes原生配置管理利器 kustomize
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_flannel/" class="md-nav__link">
        kubernetes集群网络解决方案 flannel
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        kubernetes集群网络解决方案 calico
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_hybridnet/" class="md-nav__link">
        kubernetes集群 underlay 网络方案 hybridnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ipv4_and_ipv6/" class="md-nav__link">
        kubernetes版本双栈协议（IPv4&IPv6）集群部署
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_rancher/" class="md-nav__link">
        Rancher容器云管理平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_kubeconfig/" class="md-nav__link">
        使用kubeconfig管理多集群方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_karmada/" class="md-nav__link">
        karmada实现k8s集群联邦
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_csdn/" class="md-nav__link">
        《将博客搬至CSDN》
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes_ui/" class="md-nav__link">
        源监控
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          微服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          微服务
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/fbs-lock/" class="md-nav__link">
        分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/design/" class="md-nav__link">
        微服务设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/distrimsg/" class="md-nav__link">
        分布式系统与消息的投递
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/ddd/" class="md-nav__link">
        基于DDD的微服务设计和开发实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/kafka/" class="md-nav__link">
        Kafka架构原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/redis_cluster/" class="md-nav__link">
        Redis Cluster原理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../micro/spring-cloud-micro/" class="md-nav__link">
        分布式架构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          经验分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          经验分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/devops/" class="md-nav__link">
        DevOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/micro-service/" class="md-nav__link">
        Micro-Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/raft-gossip/" class="md-nav__link">
        Raft算法和Gossip协议
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cl/" class="md-nav__link">
        集群和负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/ai/" class="md-nav__link">
        人工智能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/code-principle/" class="md-nav__link">
        代码原则
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/techbig/" class="md-nav__link">
        如何成为技术大牛
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/learnweetout/" class="md-nav__link">
        程序员如何技术成长
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/pt/" class="md-nav__link">
        产品与技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/four_deep_learning/" class="md-nav__link">
        深度学习框架
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/tl/" class="md-nav__link">
        在阿里做了5年技术Leader，我总结出这些套路！
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../exp/cto/" class="md-nav__link">
        CTO 技能图谱
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          构架
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          构架
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/split/" class="md-nav__link">
        构架拆分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fgb/" class="md-nav__link">
        分布式、高并发、多线程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/agility/" class="md-nav__link">
        如何理解敏捷开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/fwork/" class="md-nav__link">
        走向架构师必备的技能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/data_middle/" class="md-nav__link">
        数据中台的思考与总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../framework/algorithm-ten/" class="md-nav__link">
        必学的 10 大算法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          情感
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          情感
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/eq/" class="md-nav__link">
        情商
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/workheard/" class="md-nav__link">
        工作心得
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lookbook/" class="md-nav__link">
        看书
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/selfdiscipline/" class="md-nav__link">
        自律
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/livefail/" class="md-nav__link">
        为什么活着失败
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/emotion/" class="md-nav__link">
        情绪管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/losecome/" class="md-nav__link">
        所有的失去，都会以另一种方式归来
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/threeheart/" class="md-nav__link">
        人生有这三种好心态
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/onepath/" class="md-nav__link">
        余生，学会一个人走，不管有没有人陪
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/twopath/" class="md-nav__link">
        往后余生还很精彩，别被熬夜拖垮了
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../emotion/lifetime/" class="md-nav__link">
        心态好的人，一辈子都好
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="kubernetes_calico">kubernetes网络解决方案 Calico<a class="headerlink" href="#kubernetes_calico" title="Permanent link">&para;</a></h1>
<h1 id="cni">一、CNI方案<a class="headerlink" href="#cni" title="Permanent link">&para;</a></h1>
<p>学习目标</p>
<p>这一节，我们从 基础原理、方案解读、小结 三个方面来学习</p>
<p><strong>基础原理</strong></p>
<p>容器访问模式</p>
<p><img alt="1633650192071" src="../../../img/kubernetes/kubernetes_calico/1633650192071.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">方法1</span><span class="err">：</span> <span class="n">虚拟网桥</span> <span class="p">+</span> <span class="n">虚拟网卡对</span>
<span class="n">方法2</span><span class="err">：</span> <span class="n">多路复用</span> <span class="p">+</span> <span class="n">内核级的VLAN模块</span>
<span class="n">方法3</span><span class="err">：</span> <span class="n">硬件交换</span> <span class="p">+</span> <span class="n">硬件虚拟化</span>
</code></pre></div>
<p>CNI简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">根据我们对于容器的基本了解</span><span class="err">，</span><span class="n">他虽然可以借助于虚拟网桥docker0实现一定程度的网络功能</span><span class="err">，</span><span class="n">但是在大范围容器访问层面</span><span class="err">，</span><span class="n">其没有最好的网络解决方案</span><span class="err">，</span><span class="n">只能借助于一些第三方的网络解决方案来实现容器级别的跨网络通信能力</span><span class="err">。</span>
    <span class="n">CNI的全称是Container</span> <span class="n">Network</span> <span class="n">Interface</span><span class="err">，</span><span class="n">Google和CoreOS联合定制的多容器通信的网络模型</span><span class="err">。</span><span class="n">在Kubernetes中通过一个CNI接口来替代docker0</span><span class="err">，</span><span class="n">它在宿主机上的默认名字叫cni0</span><span class="err">。</span><span class="n">它没有使用Docker的网络模型的原因有两个</span><span class="err">：</span><span class="n">1</span> <span class="n">不想被Docker要挟</span><span class="err">，</span><span class="n">2</span> <span class="n">自有的网络namespace设计有关</span><span class="err">。</span>
</code></pre></div>
<p><img alt="1633651873150" src="../../../img/kubernetes/kubernetes_calico/1633651873150.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">CNI的设计思想即为</span><span class="err">：</span><span class="n">Kubernetes在启动Pod的pause容器之后</span><span class="err">，</span><span class="n">直接调用CNI网络插件</span><span class="err">，</span><span class="n">从而实现为Pod内部应用容器所在的Network</span> <span class="n">Namespace配置符合预期的网络信息</span><span class="err">。</span><span class="n">这里面需要特别关注两个方面</span><span class="err">：</span>
    <span class="p">-</span> <span class="n">Container必须有自己的网络命名空间的环境</span><span class="err">，</span><span class="n">也就是endpoint地址</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">Container所在的网段必须能够注册网络地址信息</span>

<span class="n">对容器网络的设置和操作都通过插件</span><span class="err">（</span><span class="n">Plugin</span><span class="err">）</span><span class="n">进行具体实现</span><span class="err">，</span><span class="n">CNI插件包括两种类型</span><span class="err">：</span><span class="n">CNIPlugin和IPAM</span><span class="err">（</span><span class="n">IP</span> <span class="n">Address</span> <span class="n">Management</span><span class="err">）</span><span class="n">Plugin</span><span class="err">。</span><span class="n">CNI</span> <span class="n">Plugin负责为容器配置网络资源</span><span class="err">，</span><span class="n">IPAM</span> <span class="n">Plugin负责对容器的IP地址进行分配和管理</span><span class="err">。</span><span class="n">IPAM</span> <span class="n">Plugin作为CNI</span> <span class="n">Plugin的一部分</span><span class="err">，</span><span class="n">与CNI</span> <span class="n">Plugin一起工作</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在Kubernetes中</span><span class="err">，</span><span class="n">CNI对于容器网络的设置主要是以CNI</span> <span class="n">Plugin插件的方式来为容器配置网络资源</span><span class="err">，</span><span class="n">它主要有三种模式</span><span class="err">：</span>
    <span class="n">MainPlugin</span>
        <span class="p">-</span> <span class="n">用来创建具体的网络设备的二进制文件</span>
        <span class="p">-</span> <span class="n">比如bridge</span><span class="err">、</span><span class="n">ipvlan</span><span class="err">、</span><span class="n">vlan</span><span class="err">、</span><span class="n">host-device</span>
    <span class="n">IPAM</span> <span class="n">Plugin</span>
        <span class="p">-</span> <span class="n">IPAM</span> <span class="n">就是</span> <span class="n">IP</span> <span class="n">Address</span> <span class="n">Management</span>
        <span class="p">-</span> <span class="n">负责对容器的IP地址进行分配和管理</span><span class="err">，</span><span class="n">作为CNI</span> <span class="n">Plugin的一部分</span><span class="err">，</span><span class="n">与CNI</span> <span class="n">Plugin一起工作</span>
    <span class="n">Meta</span> <span class="n">Plugin</span>
        <span class="p">-</span> <span class="n">由CNI社区维护的内部插件功能模块</span><span class="p">,</span><span class="n">常见的插件功能模块有以下几种</span>
        <span class="p">-</span> <span class="n">flannel</span> <span class="n">专门为Flannel项目提供的插件</span>
        <span class="p">-</span> <span class="n">tuning</span> <span class="n">通过sysctl调整网络设备参数的二进制文件</span>
        <span class="p">-</span> <span class="n">portmap</span> <span class="n">通过iptables配置端口映射的二进制文件</span>
        <span class="p">-</span> <span class="n">bandwidth</span> <span class="n">使用</span> <span class="n">Token</span> <span class="n">Bucket</span> <span class="k">Filter</span> <span class="p">(</span><span class="n">TBF</span><span class="p">)</span><span class="n">来进行限流的二进制文件</span>
        <span class="p">-</span> <span class="n">firewall</span> <span class="n">通过iptables或者firewalled添加规则控制容器的进出流量</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">更多详情查看</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">containernetworking</span><span class="p">/</span><span class="n">cni</span><span class="p">/</span><span class="n">blob</span><span class="p">/</span><span class="n">main</span><span class="p">/</span><span class="n">SPEC</span><span class="p">.</span><span class="nb">md</span>
</code></pre></div>
<p>CNI目前被谁管理？</p>
<div class="highlight"><pre><span></span><code>    <span class="n">在</span> <span class="n">Kubernetes</span> <span class="n">1</span><span class="p">.</span><span class="n">24</span> <span class="n">之前</span><span class="err">，</span><span class="n">CNI</span> <span class="n">插件也可以由</span> <span class="n">kubelet</span> <span class="n">使用命令行参数</span> <span class="n">cni-bin-dir</span> <span class="n">和</span> <span class="n">network-plugin</span> <span class="n">管理</span><span class="err">。</span><span class="n">而在Kubernetes</span> <span class="n">1</span><span class="p">.</span><span class="n">24</span> <span class="n">移除了这些命令行参数</span><span class="err">，</span> <span class="n">CNI</span> <span class="n">的管理不再是</span> <span class="n">kubelet</span> <span class="n">的工作</span><span class="err">。</span><span class="n">而变成下层的容器引擎需要做的事情了</span><span class="err">，</span><span class="n">比如cri-dockerd服务的启动文件</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看服务文件</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">cri-docker</span><span class="p">.</span><span class="n">service</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">cri-dockerd</span> <span class="p">-</span><span class="n">-network-plugin</span><span class="p">=</span><span class="n">cni</span> <span class="p">-</span><span class="n">-cni-conf-dir</span><span class="p">=/</span><span class="n">etc</span><span class="p">/</span><span class="n">cni</span><span class="p">/</span><span class="n">net</span><span class="p">.</span><span class="n">d</span> <span class="p">-</span><span class="n">-cni-bin-dir</span><span class="p">=/</span><span class="n">opt</span><span class="p">/</span><span class="n">cni</span><span class="p">/</span><span class="n">bin</span> <span class="p">...</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="p">/</span><span class="n">opt</span><span class="p">/</span><span class="n">cni</span><span class="p">/</span><span class="n">bin</span> <span class="n">目录是部署kubernetes的时候</span><span class="err">，</span><span class="n">安装的cni-tools软件包自动创建出来的</span><span class="err">，</span><span class="n">这里面包含了很多的网络命令工具</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">flannel的CNI配置文件</span>
<span class="c"># cat /etc/cni/net.d/10-flannel.conflist</span>
<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;cbr0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;flannel&quot;</span><span class="p">,</span>  <span class="c"># 为Flannel项目提供的插件，配置容器网络</span>
      <span class="s2">&quot;delegate&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;hairpinMode&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
        <span class="s2">&quot;isDefaultGateway&quot;</span><span class="p">:</span> <span class="n">true</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;portmap&quot;</span><span class="p">,</span> <span class="c"># 通过iptables配置端口映射的二进制文件，配置端口映射</span>
      <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;portMappings&quot;</span><span class="p">:</span> <span class="n">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">calico的CNI配置文件</span>
<span class="c"># cat /etc/cni/net.d/10-calico.conflist</span>
<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;k8s-pod-network&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cniVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;0.3.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;calico&quot;</span><span class="p">,</span>
      <span class="s2">&quot;log_level&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
      <span class="s2">&quot;log_file_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/calico/cni/cni.log&quot;</span><span class="p">,</span>
      <span class="s2">&quot;datastore_type&quot;</span><span class="p">:</span> <span class="s2">&quot;kubernetes&quot;</span><span class="p">,</span>
      <span class="s2">&quot;nodename&quot;</span><span class="p">:</span> <span class="s2">&quot;kubernetes-master&quot;</span><span class="p">,</span>
      <span class="s2">&quot;mtu&quot;</span><span class="p">:</span> <span class="n">0</span><span class="p">,</span>
      <span class="s2">&quot;ipam&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;host-local&quot;</span><span class="p">,</span>
          <span class="s2">&quot;subnet&quot;</span><span class="p">:</span> <span class="s2">&quot;usePodCidr&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;k8s&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;kubernetes&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;kubeconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/cni/net.d/calico-kubeconfig&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;portmap&quot;</span><span class="p">,</span>
      <span class="s2">&quot;snat&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;portMappings&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bandwidth&quot;</span><span class="p">,</span>
      <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bandwidth&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>方案解读</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">kubernetes提供了很多的网络解决方案</span><span class="err">，</span><span class="n">相关的资料如下</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">zh-cn</span><span class="p">/</span><span class="n">docs</span><span class="p">/</span><span class="n">concepts</span><span class="p">/</span><span class="n">cluster-administration</span><span class="p">/</span><span class="n">addons</span><span class="p">/</span>
</code></pre></div>
<p>flannel方案</p>
<div class="highlight"><pre><span></span><code><span class="n">项目地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">coreos</span><span class="p">/</span><span class="n">flannel</span>

    <span class="n">Flannel是CoreOS</span> <span class="n">开发的项目</span><span class="err">，</span><span class="n">它是容器编排系统中最成熟的网络方案之一</span><span class="err">，</span><span class="n">旨在实现更好的容器间和主机间网络</span><span class="err">，</span><span class="n">由于其稳定和配置简单</span><span class="err">，</span><span class="n">所以它是CNI最早引入的一套方案</span><span class="err">。</span><span class="n">常见的</span> <span class="n">Kubernetes</span> <span class="n">集群部署工具和许多</span> <span class="n">Kubernetes</span> <span class="n">发行版都可以默认安装</span> <span class="n">Flannel</span><span class="err">。</span>
    <span class="n">如果你需要一个稳定而又简单的网络功能的话</span><span class="err">，</span><span class="n">不那么在乎安全性的话</span><span class="err">，</span><span class="n">Flannel是一个很好的选择</span><span class="err">。</span>
</code></pre></div>
<p>calico方案</p>
<div class="highlight"><pre><span></span><code><span class="n">项目地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">projectcalico</span><span class="p">/</span><span class="n">cni-plugin</span>

    <span class="n">Calico</span> <span class="n">是</span> <span class="n">Kubernetes</span> <span class="n">生态系统中另一种流行的网络选择</span><span class="err">。</span><span class="n">虽然</span> <span class="n">Flannel</span> <span class="n">被公认为是最简单的选择</span><span class="err">，</span><span class="n">但</span> <span class="n">Calico</span> <span class="n">以其性能</span><span class="err">、</span><span class="n">灵活性而闻名</span><span class="err">。</span><span class="n">Calico</span> <span class="n">的功能更为全面</span><span class="err">，</span><span class="n">除了通用的网络连接</span><span class="err">，</span><span class="n">还涉及网络安全和网络策略管理</span><span class="err">，</span><span class="n">甚至Calico还可以在微服务的网络治理中进行整合</span><span class="err">。</span><span class="n">Calico</span> <span class="n">CNI</span> <span class="n">插件在</span> <span class="n">CNI</span> <span class="n">框架内封装了</span> <span class="n">Calico</span> <span class="n">的功能</span><span class="err">。</span>
    <span class="n">如果对你的环境而言</span><span class="err">，</span><span class="n">支持网络策略是非常重要的一点</span><span class="err">，</span><span class="n">而且你对其他性能和功能也有需求</span><span class="err">，</span><span class="n">那么</span> <span class="n">Calico</span> <span class="n">会是一个理想的选择</span><span class="err">。</span>
</code></pre></div>
<p>canal方案</p>
<div class="highlight"><pre><span></span><code><span class="n">项目地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">projectcalico</span><span class="p">/</span><span class="n">canal</span>

    <span class="n">Canal</span> <span class="n">试图将</span> <span class="n">Flannel</span> <span class="n">提供的网络功能与</span> <span class="n">Calico</span> <span class="n">的网络策略功能集成在一起</span><span class="err">，</span><span class="n">只不过在研发的时候</span><span class="err">，</span><span class="n">发现Flannel</span> <span class="n">和</span> <span class="n">Calico</span> <span class="n">这两个项目的标准化和灵活性都想当标准</span><span class="err">，</span><span class="n">那集成就没必要了</span><span class="err">，</span><span class="n">所以目前这个项目</span><span class="err">“</span><span class="n">烂尾</span><span class="err">”</span><span class="n">了</span><span class="err">。</span><span class="n">由于Canal的思路很好</span><span class="err">，</span><span class="n">业界习惯性地将</span> <span class="n">Flannel</span> <span class="n">和</span> <span class="n">Calico</span> <span class="n">的功能组合实施称为</span><span class="err">“</span><span class="n">Canal</span><span class="err">”。</span>
    <span class="n">对于那些喜欢</span> <span class="n">Flannel</span> <span class="n">提供的网络模型</span><span class="err">，</span><span class="n">同时喜欢</span> <span class="n">Calico</span> <span class="n">的网络策略功能的人来说</span><span class="err">，</span><span class="n">Canal是一个选择</span><span class="err">。</span>
</code></pre></div>
<p>weave方案</p>
<div class="highlight"><pre><span></span><code><span class="n">项目地址</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">www</span><span class="p">.</span><span class="n">weave</span><span class="p">.</span><span class="n">works</span><span class="p">/</span><span class="n">oss</span><span class="p">/</span><span class="n">net</span><span class="p">/</span>

    <span class="n">Weave</span> <span class="n">是由</span> <span class="n">Weaveworks</span> <span class="n">提供的一种</span> <span class="n">Kubernetes</span> <span class="n">CNI</span> <span class="n">网络选项</span><span class="err">，</span><span class="n">它在集群中的每个节点上部署路由组件</span><span class="err">，</span><span class="n">从而实现主机之间创建更加灵活的网状</span> <span class="n">overlay</span> <span class="n">网络</span><span class="err">，</span><span class="n">借助于内核级别的Open</span> <span class="n">vSwitch</span> <span class="n">配置</span><span class="err">，</span><span class="n">从而实现具有一定程度的智能路由功能</span><span class="err">。</span><span class="n">除此之外</span><span class="err">，</span><span class="n">weave还具有想当的网络策略功能</span><span class="err">，</span><span class="n">网络加密传输功能等</span><span class="err">。</span>
    <span class="n">对于那些寻求功能丰富的网络</span><span class="err">、</span><span class="n">同时希望不要增加大量复杂性或管理难度的人来说</span><span class="err">，</span><span class="n">Weave</span> <span class="n">是一个很好的选择</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220903022845285" src="../../../img/kubernetes/kubernetes_calico/image-20220903022845285.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">bandwidth</span> <span class="p">-</span> <span class="n">带宽</span><span class="err">、</span><span class="n">consumption</span> <span class="p">-</span> <span class="n">消耗</span><span class="err">、</span><span class="n">encryption</span> <span class="p">-</span> <span class="n">加密</span>
<span class="n">资料来源</span><span class="err">：</span>
<span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">spreadsheets</span><span class="p">/</span><span class="n">d</span><span class="p">/</span><span class="n">12dQqSGI0ZcmuEy48nA0P_bPl7Yp17fNg7De47CYWzaM</span><span class="p">/</span><span class="n">edit</span><span class="c">#gid=404703955</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h1 id="calico">二、 Calico环境<a class="headerlink" href="#calico" title="Permanent link">&para;</a></h1>
<p>学习目标</p>
<p>这一节，我们从 基础知识、原理解读、小结 三个方面来学习</p>
<p><strong>基础知识</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    Calico是一个开源的虚拟化网络方案,用于为云原生应用实现互联及策略控制.相较于 Flannel 来说,Calico 的优势是对网络策略(network policy),它允许用户动态定义 ACL 规则控制进出容器的数据报文,实现为 Pod 间的通信按需施加安全策略.不仅如此,Calico 还可以整合进大多数具备编排能力的环境,可以为 虚机和容器提供多主机间通信的功能。
    Calico 本身是一个三层的虚拟网络方案,它将每个节点都当作路由器,将每个节点的容器都当作是节点路由器的一个终端并为其分配一个 IP 地址,各节点路由器通过 BGP(Border Gateway Protocol)学习生成路由规则,从而将不同节点上的容器连接起来.因此,Calico 方案其实是一个纯三层的解决方案,通过每个节点协议栈的三层（网络层）确保容器之间的连通性,这摆脱了 flannel host-gw 类型的所有节点必须位于同一二层网络的限制,从而极大地扩展了网络规模和网络边界。

官方地址：https://www.tigera.io/project-calico/
最新版本：v3.24.1 (20220827)、 v3.20.6 (20220802)、v3.21.6 (20220722)、 v3.23.3 (20220720)、v3.22.4 (20220720)
</code></pre></div>
<p>网络模型</p>
<div class="highlight"><pre><span></span><code>Calico为了实现更广层次的虚拟网络的应用场景，它支持多种网络模型来满足需求。
underlay network - BGP(三层虚拟网络解决方案)
overlay network - IPIP(双层IP实现跨网段效果)、VXLAN(数据包标识实现大二层上的跨网段通信)
</code></pre></div>
<p>设计思想</p>
<div class="highlight"><pre><span></span><code>Calico不使用隧道或者NAT来实现转发，而是巧妙的把所有二三层流量转换成三层流量，并通过host上路由配置完成跨host转发。
</code></pre></div>
<p>为什么用calico</p>
<p><img alt="image-20220905120240844" src="../../../img/kubernetes/kubernetes_calico/image-20220905120240844.png" /></p>
<p><strong>原理解读</strong></p>
<p>calico</p>
<div class="highlight"><pre><span></span><code>    <span class="n">Calico是一个开源的虚拟化网络方案</span><span class="p">,</span><span class="n">用于为云原生应用实现互联及策略控制</span><span class="p">.</span><span class="n">相较于</span> <span class="n">Flannel</span> <span class="n">来说</span><span class="p">,</span><span class="n">Calico</span> <span class="n">的优势是对网络策略</span><span class="p">(</span><span class="n">network</span> <span class="n">policy</span><span class="p">),</span><span class="n">它允许用户动态定义</span> <span class="n">ACL</span> <span class="n">规则控制进出容器的数据报文</span><span class="p">,</span><span class="n">实现为</span> <span class="n">Pod</span> <span class="n">间的通信按需施加安全策略</span><span class="p">.</span><span class="n">不仅如此</span><span class="p">,</span><span class="n">Calico</span> <span class="n">还可以整合进大多数具备编排能力的环境</span><span class="p">,</span><span class="n">可以为</span> <span class="n">虚机和容器提供多主机间通信的功能</span><span class="err">。</span>
    <span class="n">我们平常使用Calico主要用到的是它的网络策略功能</span>
</code></pre></div>
<p>软件结构</p>
<p><img alt="image-20220722175645610" src="../../../img/kubernetes/kubernetes_calico/image-20220722175645610.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">Felix</span>
    <span class="n">每个节点都有</span><span class="err">，</span><span class="n">负责配置路由</span><span class="err">、</span><span class="n">ACL</span><span class="err">、</span><span class="n">向etcd宣告状态等</span>
<span class="n">BIRD</span>
    <span class="n">每个节点都有</span><span class="err">，</span><span class="n">负责把</span> <span class="n">Felix</span> <span class="n">写入Kernel的路由信息</span> <span class="n">分发到整个</span> <span class="n">Calico网络</span><span class="err">，</span><span class="n">确保</span> <span class="n">workload</span> <span class="n">连通</span>
<span class="n">etcd</span>
    <span class="n">存储calico自己的状态数据</span><span class="err">，</span><span class="n">可以结合kube-apiserver来工作</span>
    <span class="n">官方推荐</span><span class="err">；</span>
        <span class="p">&lt;</span> <span class="n">50节点</span><span class="p">,</span><span class="n">可以结合</span> <span class="n">kube-apiserver</span> <span class="n">来实现数据的存储</span>
        <span class="p">&gt;</span> <span class="n">50节点</span><span class="p">,</span><span class="n">推荐使用独立的ETCD集群来进行处理</span><span class="err">。</span>
    <span class="n">参考资料</span><span class="err">：</span>
        <span class="n">https</span><span class="p">://</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">docs</span><span class="p">.</span><span class="n">tigera</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">getting-started</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">self-managed-onprem</span><span class="p">/</span><span class="n">onpremises</span><span class="c">#install-calico</span>
<span class="n">Route</span> <span class="n">Reflector</span>
    <span class="n">路由反射器</span><span class="err">，</span><span class="n">用于集中式的动态生成所有主机的路由表</span><span class="err">，</span><span class="n">非必须选项</span>
    <span class="n">超过100个节点推荐使用</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">docs</span><span class="p">.</span><span class="n">tigera</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">getting-started</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">rancher</span><span class="c">#concepts</span>
<span class="n">Calico编排系统插件</span>
    <span class="n">实现更广范围的虚拟网络解决方案</span><span class="err">。</span>

<span class="n">参考资料</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">reference</span><span class="p">/</span><span class="n">architecture</span><span class="p">/</span><span class="n">overview</span>
</code></pre></div>
<p>工作模式</p>
<p><img alt="image-20220722180040443" src="../../../img/kubernetes/kubernetes_calico/image-20220722180040443.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">对于节点量少的情况下</span><span class="err">，</span><span class="n">我们推荐使用左侧默认的模式</span><span class="err">，</span><span class="n">当节点量多的时候</span><span class="err">，</span><span class="n">我们推荐使用右侧的反射器模式</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="21_calico">2.1  Calico部署<a class="headerlink" href="#21_calico" title="Permanent link">&para;</a></h2>
<p>学习目标</p>
<p>这一节，我们从 环境解析、简单实践、小结 三个方面来学习</p>
<p><strong>环境解析</strong></p>
<p>k8s环境上的calico逻辑</p>
<p><img alt="architecture-calico" src="../../../img/kubernetes/kubernetes_calico/architecture-calico.svg" /></p>
<div class="highlight"><pre><span></span><code><span class="n">confd</span> 
    <span class="p">-</span> <span class="n">统一管控</span> <span class="n">Calico</span> <span class="n">数据存储以及</span> <span class="n">BGP</span> <span class="n">配置的轻量级的配置管理工具</span><span class="err">。</span>
    <span class="p">-</span> <span class="n">当配置文件发生变化时</span><span class="err">，</span><span class="n">动态更新和生成BIRD</span> <span class="n">配置文件</span>
<span class="n">Dikastes</span>
    <span class="p">-</span> <span class="n">为</span> <span class="n">Istio</span> <span class="n">服务网格实施网络策略</span><span class="err">。</span><span class="n">作为</span> <span class="n">Istio</span> <span class="n">Envoy</span> <span class="n">的</span> <span class="n">sidecar</span> <span class="n">代理在集群上运行</span><span class="err">。</span>
<span class="n">CNI</span> <span class="n">plugin</span>  
    <span class="p">-</span> <span class="n">为</span> <span class="n">Kubernetes</span> <span class="n">集群提供</span> <span class="n">Calico</span> <span class="n">网络</span><span class="err">，</span><span class="n">必须安装在</span> <span class="n">Kubernetes</span> <span class="n">集群中的每个节点上</span><span class="err">。</span>
<span class="n">Datastore</span> <span class="n">plugin</span>
    <span class="p">-</span> <span class="n">独立使用etcd作为Calico的数据存储平台</span><span class="err">，</span><span class="n">特点在于独立扩展数据存储</span>
    <span class="p">-</span> <span class="n">结合K8s的apiserver实现数据存储到etcd中</span><span class="err">，</span><span class="n">特点在于使用</span> <span class="n">Kubernetes的存储</span><span class="err">、</span><span class="n">RBAC</span><span class="err">、</span><span class="n">审计功能为Calico服务</span>
<span class="n">IPAM</span> <span class="n">plugin</span>
    <span class="p">-</span> <span class="n">使用</span> <span class="n">Calico</span> <span class="n">的</span> <span class="n">IP</span> <span class="n">池资源来控制</span> <span class="n">IP</span> <span class="n">地址如何分配给集群内的</span> <span class="n">Pod</span><span class="err">。</span>
<span class="n">kube-controllers</span>
    <span class="p">-</span> <span class="n">监控</span> <span class="n">Kubernetes</span> <span class="n">API</span> <span class="n">并根据集群状态执行操作</span>
    <span class="p">-</span> <span class="n">主要是策略</span><span class="err">、</span><span class="n">命名空间</span><span class="err">、</span><span class="n">服务账号</span><span class="err">、</span><span class="n">负载</span><span class="err">、</span><span class="n">节点等通信策略的控制</span>
<span class="n">Typha</span>
    <span class="p">-</span> <span class="n">通过减少每个节点对数据存储的影响来增加规模</span><span class="err">。</span><span class="n">在数据存储和</span> <span class="n">Felix</span> <span class="n">实例之间作为守护进程运行</span><span class="err">。</span>

<span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">docs</span><span class="p">.</span><span class="n">tigera</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">reference</span><span class="p">/</span><span class="n">architecture</span><span class="p">/</span><span class="n">overview</span>
</code></pre></div>
<p>基础环境支持</p>
<div class="highlight"><pre><span></span><code><span class="n">linux</span> <span class="n">主机基本要求</span><span class="err">：</span>
    <span class="n">x86</span><span class="p">-</span><span class="n">64</span><span class="err">、</span><span class="n">arm64</span><span class="err">、</span><span class="n">ppc64le</span> <span class="n">或</span> <span class="n">s390x</span> <span class="n">处理器</span>
    <span class="n">2CPU</span>
    <span class="n">2GB</span> <span class="n">内存</span>
    <span class="n">10GB</span> <span class="n">可用磁盘空间</span>
    <span class="n">RedHat</span> <span class="n">Enterprise</span> <span class="n">Linux</span> <span class="n">7</span><span class="p">.</span><span class="n">x</span><span class="p">+</span><span class="err">、</span><span class="n">CentOS</span> <span class="n">7</span><span class="p">.</span><span class="n">x</span><span class="p">+</span><span class="err">、</span><span class="n">Ubuntu</span> <span class="n">16</span><span class="p">.</span><span class="n">04</span><span class="p">+</span> <span class="n">或</span> <span class="n">Debian</span> <span class="n">9</span><span class="p">.</span><span class="n">x</span><span class="p">+</span>
    <span class="n">确保</span> <span class="n">Calico</span> <span class="n">可以在主机上进行管理cali和接口</span>
<span class="n">其他需求</span><span class="err">：</span>
    <span class="n">kubernetes集群配置了</span> <span class="p">-</span><span class="n">-pod-network-cidr</span> <span class="n">属性</span>
<span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">docs</span><span class="p">.</span><span class="n">tigera</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">getting-started</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">quickstart</span>
</code></pre></div>
<p>部署解析</p>
<div class="highlight"><pre><span></span><code><span class="n">对于calico在k8s集群上的部署来说</span><span class="err">，</span><span class="n">为了完成上面四个组件的部署</span><span class="err">，</span><span class="n">这里会涉及到两个部署组件</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>组件名</th>
<th>组件作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>calico-node</td>
<td>需要部署到所有集群节点上的代理守护进程，提供封装好的Felix和BIRD</td>
</tr>
<tr>
<td>calico-kube-controller</td>
<td>专用于k8s上对calico所有节点管理的中央控制器。负责calico与k8s集群的协同及calico核心功能实现。</td>
</tr>
</tbody>
</table>
<p>部署步骤</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">获取资源配置文件</span>
    <span class="n">从calico官网获取相关的配置信息</span>
<span class="n">2</span> <span class="n">定制CIDR配置</span>
    <span class="n">定制calico自身对于pod网段的配置信息</span><span class="err">，</span><span class="n">并且清理无关的网络其他插件</span>
<span class="n">3</span> <span class="n">定制pod的manifest文件分配网络配置</span>
    <span class="n">默认的k8s集群在启动的时候</span><span class="err">，</span><span class="n">会有一个cidr的配置</span><span class="err">，</span><span class="n">有可能与calico进行冲突</span><span class="err">，</span><span class="n">那么我们需要修改一下</span>
<span class="n">4</span> <span class="n">应用资源配置文件</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">注意事项</span><span class="err">：</span>
    <span class="n">对于calico来说</span><span class="err">，</span><span class="n">它自己会生成自己的路由表</span><span class="err">，</span><span class="n">如果路由表中存在响应的记录</span><span class="err">，</span><span class="n">默认情况下会直接使用</span><span class="err">，</span><span class="n">而不是覆盖掉当前主机的路由表</span>
    <span class="n">所以如果我们在部署calico之前</span><span class="err">，</span><span class="n">曾经使用过flannel</span><span class="err">，</span><span class="n">尤其是flannel的host-gw模式的话</span><span class="err">，</span><span class="n">一定要注意</span><span class="err">，</span><span class="n">在使用calico之前</span><span class="err">，</span><span class="n">将之前所有的路由表信息清空</span><span class="err">，</span><span class="n">否则无法看到calico的tunl的封装效果</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>环境部署</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span> <span class="n">获取资源清单文件</span>
<span class="n">mkdir</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">network</span><span class="p">/</span><span class="n">calico</span> <span class="n">-p</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">network</span><span class="p">/</span><span class="n">calico</span><span class="p">/</span>
<span class="nb">curl </span><span class="n">https</span><span class="p">://</span><span class="n">docs</span><span class="p">.</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">manifests</span><span class="p">/</span><span class="n">calico</span><span class="p">.</span><span class="n">yaml</span> <span class="n">-O</span>
<span class="nb">cp </span><span class="n">calico</span><span class="p">.</span><span class="n">yaml</span><span class="p">{,.</span><span class="n">bak</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2</span> <span class="n">配置资源清单文件</span>
<span class="c"># vim calico.yaml</span>
<span class="p">----</span> <span class="n">官网推荐的修改内容</span>
<span class="n">4546</span>             <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">CALICO_IPV4POOL_CIDR</span>
<span class="n">4547</span>               <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;10.244.0.0/16&quot;</span>
<span class="p">----</span> <span class="n">方便我们的后续实验</span><span class="err">，</span><span class="n">新增调小子网段的分配</span>
<span class="n">4548</span>             <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">CALICO_IPV4POOL_BLOCK_SIZE</span>
<span class="n">4549</span>               <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;24&quot;</span>
<span class="n">配置解析</span><span class="err">：</span>
    <span class="n">开放默认注释的CALICO_IPV4POOL_CIDR变量</span><span class="err">，</span><span class="n">然后定制我们当前的pod的网段范围即可</span>
    <span class="n">原则上来说</span><span class="err">，</span><span class="n">我们修改官方提示的属性即可</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3</span> <span class="n">定制pod的manifest文件分配网络配置</span>
<span class="c"># vim calico.yaml</span>
<span class="p">----</span> <span class="n">修改下面的内容</span>
  <span class="n">64</span>           <span class="s2">&quot;ipam&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">65</span>               <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;calico-ipam&quot;</span>
  <span class="n">66</span>           <span class="p">},</span>
<span class="p">----</span> <span class="n">修改后的内容</span>
  <span class="n">64</span>           <span class="s2">&quot;ipam&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">65</span>               <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;host-local&quot;</span><span class="p">,</span>
  <span class="n">66</span>               <span class="s2">&quot;subnet&quot;</span><span class="p">:</span> <span class="s2">&quot;usePodCidr&quot;</span>
  <span class="n">67</span>           <span class="p">},</span>
<span class="p">----</span> <span class="n">定制calico使用k8s集群节点的地址</span>
<span class="n">4551</span>             <span class="p">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">USE_POD_CIDR</span>
<span class="n">4552</span>               <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
<span class="n">配置解析</span><span class="p">:</span>
    <span class="n">Calico默认并不会从Node</span><span class="p">.</span><span class="n">Spec</span><span class="p">.</span><span class="n">PodCIDR中分配地址</span><span class="err">，</span><span class="n">但可通过USE_POD_CIDR变量并结合host-local这一IPAM插件以强制从PodCIDR中分配地址</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">4</span> <span class="n">定制默认的docker镜像</span>
<span class="n">查看默认的镜像</span>
<span class="c"># grep docker.io calico.yaml | uniq</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">calico</span><span class="p">/</span><span class="n">cni</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">calico</span><span class="p">/</span><span class="n">node</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">docker</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">calico</span><span class="p">/</span><span class="n">kube-controllers</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
<span class="n">获取镜像</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="p">$(</span><span class="n">grep</span> <span class="n">docker</span><span class="p">.</span><span class="n">io</span> <span class="n">calico</span><span class="p">.</span><span class="n">yaml</span> <span class="p">|</span> <span class="n">uniq</span> <span class="p">|</span> <span class="n">awk</span> <span class="o">-F</span><span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $NF}&#39;</span><span class="p">)</span>
<span class="k">do</span>
  <span class="n">docker</span> <span class="n">pull</span> <span class="n">calico</span><span class="p">/</span><span class="nv">$i</span>
  <span class="n">docker</span> <span class="n">tag</span> <span class="n">calico</span><span class="p">/</span><span class="nv">$i</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$i</span>
  <span class="n">docker</span> <span class="n">push</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$i</span>
  <span class="n">docker</span> <span class="n">rmi</span> <span class="n">calico</span><span class="p">/</span><span class="nv">$i</span>
<span class="n">done</span>

<span class="n">修改为定制的镜像</span>
<span class="n">sed</span> <span class="n">-i</span> <span class="s1">&#39;s#docker.io/calico#kubernetes-register.superopsmsb.com/google_containers#g&#39;</span> <span class="n">calico</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">查看效果</span>
<span class="c"># grep google calico.yaml</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">cni</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">cni</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">node</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">node</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="n">kube-controllers</span><span class="p">:</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">5</span> <span class="n">应用资源配置文件</span>
<span class="n">清理之前的flannel插件</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="o">-f</span> <span class="n">kube-flannel</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span> <span class="n">-n</span> <span class="n">kube-system</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">flannel</span>

<span class="n">这个时候</span><span class="err">，</span><span class="n">先清除旧网卡</span><span class="err">，</span><span class="n">然后最好重启一下主机</span><span class="err">，</span><span class="n">直接清空所有的路由表信息</span>
<span class="n">ifconfig</span> <span class="n">flannel</span><span class="p">.</span><span class="n">1</span>
<span class="n">reboot</span>

<span class="n">重启后</span><span class="err">，</span><span class="n">查看网络效果</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">为了避免后续calico网络测试的异常</span><span class="err">，</span><span class="n">我们这里最好只留下一个网卡</span> <span class="n">eth0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">应用calico插件</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">calico</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">在calico-node部署的时候</span><span class="err">，</span><span class="n">会启动多个进程</span>
<span class="c"># kubectl get pod -n kube-system | egrep &#39;NAME|calico&#39;</span>
<span class="n">NAME</span>                                        <span class="n">READY</span>   <span class="n">STATUS</span>              <span class="n">RESTARTS</span>       <span class="n">AGE</span>
<span class="n">calico-kube-controllers</span><span class="p">-</span><span class="n">549f7748b5-xqz8j</span>    <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">ContainerCreating</span>   <span class="n">0</span>              <span class="n">9s</span>
<span class="n">calico-node</span><span class="p">-</span><span class="n">74c5w</span>                           <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Init</span><span class="p">:</span><span class="n">0</span><span class="p">/</span><span class="n">3</span>            <span class="n">0</span>              <span class="n">9s</span>
<span class="p">...</span>

<span class="n">环境部署完毕后</span><span class="err">，</span><span class="n">查看效果</span>
<span class="c"># kubectl get pod -n kube-system | egrep &#39;NAME|calico&#39;</span>
<span class="n">NAME</span>                                        <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>       <span class="n">AGE</span>
<span class="n">calico-kube-controllers</span><span class="p">-</span><span class="n">549f7748b5-xqz8j</span>    <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>              <span class="n">39s</span>
<span class="n">calico-node</span><span class="p">-</span><span class="n">74c5w</span>                           <span class="n">0</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>              <span class="n">39s</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">每个calico节点上都有多个进程</span><span class="err">，</span><span class="n">分别来处理不同的功能</span>
<span class="p">]</span><span class="c"># ps aux | egrep &#39;NAME | calico&#39;</span>
<span class="n">root</span>       <span class="n">9315</span>  <span class="n">0</span><span class="p">.</span><span class="n">5</span>  <span class="n">1</span><span class="p">.</span><span class="n">1</span> <span class="n">1524284</span> <span class="n">43360</span> <span class="p">?</span>       <span class="nb">Sl </span>  <span class="n">15</span><span class="p">:</span><span class="n">29</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="n">calico-node</span> <span class="n">-confd</span>
<span class="n">root</span>       <span class="n">9316</span>  <span class="n">0</span><span class="p">.</span><span class="n">2</span>  <span class="n">0</span><span class="p">.</span><span class="n">8</span> <span class="n">1155624</span> <span class="n">32924</span> <span class="p">?</span>       <span class="nb">Sl </span>  <span class="n">15</span><span class="p">:</span><span class="n">29</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="n">calico-node</span> <span class="n">-monitor-token</span>
<span class="n">root</span>       <span class="n">9317</span>  <span class="n">2</span><span class="p">.</span><span class="n">8</span>  <span class="n">1</span><span class="p">.</span><span class="n">0</span> <span class="n">1598528</span> <span class="n">40992</span> <span class="p">?</span>       <span class="nb">Sl </span>  <span class="n">15</span><span class="p">:</span><span class="n">29</span>   <span class="n">0</span><span class="p">:</span><span class="n">02</span> <span class="n">calico-node</span> <span class="n">-felix</span>
<span class="n">root</span>       <span class="n">9318</span>  <span class="n">0</span><span class="p">.</span><span class="n">3</span>  <span class="n">0</span><span class="p">.</span><span class="n">9</span> <span class="n">1155624</span> <span class="n">35236</span> <span class="p">?</span>       <span class="nb">Sl </span>  <span class="n">15</span><span class="p">:</span><span class="n">29</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="n">calico-node</span> <span class="n">-monitor-addresses</span>
<span class="n">root</span>       <span class="n">9319</span>  <span class="n">0</span><span class="p">.</span><span class="n">3</span>  <span class="n">0</span><span class="p">.</span><span class="n">8</span> <span class="n">1155624</span> <span class="n">33460</span> <span class="p">?</span>       <span class="nb">Sl </span>  <span class="n">15</span><span class="p">:</span><span class="n">29</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="n">calico-node</span> <span class="n">-status-reporter</span>
<span class="n">root</span>       <span class="n">9320</span>  <span class="n">0</span><span class="p">.</span><span class="n">2</span>  <span class="n">0</span><span class="p">.</span><span class="n">7</span> <span class="n">1155624</span> <span class="n">30364</span> <span class="p">?</span>       <span class="nb">Sl </span>  <span class="n">15</span><span class="p">:</span><span class="n">29</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span> <span class="n">calico-node</span> <span class="n">-allocate-tunnel-addrs</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">获取镜像</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">nginx</span>
<span class="n">docket</span> <span class="n">tag</span> <span class="n">nginx</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">1</span>
<span class="n">docker</span> <span class="n">push</span> <span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">1</span>
<span class="n">docker</span> <span class="n">rmi</span> <span class="n">nginx</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">创建一个deployment</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">pod-deployment</span> <span class="p">-</span><span class="n">-image</span><span class="p">=</span><span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">nginx</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">1</span> <span class="p">-</span><span class="n">-replicas</span><span class="p">=</span><span class="n">3</span>

<span class="n">查看pod</span>
<span class="c"># kubectl get pod</span>
<span class="n">NAME</span>                             <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod-deployment</span><span class="p">-</span><span class="n">554dff674</span><span class="p">-</span><span class="n">267gq</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">48s</span>
<span class="n">pod-deployment</span><span class="p">-</span><span class="n">554dff674-c8cjs</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">48s</span>
<span class="n">pod-deployment</span><span class="p">-</span><span class="n">554dff674-pxrwb</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>     <span class="n">Running</span>   <span class="n">0</span>          <span class="n">48s</span>

<span class="n">暴露一个service</span>
<span class="n">kubectl</span> <span class="n">expose</span> <span class="n">deployment</span> <span class="n">pod-deployment</span> <span class="p">-</span><span class="n">-port</span><span class="p">=</span><span class="n">80</span> <span class="p">-</span><span class="n">-target-port</span><span class="p">=</span><span class="n">80</span>

<span class="n">确认效果</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">service</span>
<span class="nb">curl </span><span class="n">10</span><span class="p">.</span><span class="n">108</span><span class="p">.</span><span class="n">138</span><span class="p">.</span><span class="n">97</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="22">2.2  简单实践<a class="headerlink" href="#22" title="Permanent link">&para;</a></h2>
<p>学习目标</p>
<p>这一节，我们从 网络解析、命令完善、小结 三个方面来学习</p>
<p><strong>网络解析</strong></p>
<p>calico部署完毕后，会生成一系列的自定义配置属性信息</p>
<div class="highlight"><pre><span></span><code><span class="n">自动生成一个api版本信息</span>
<span class="c"># kubectl api-versions  | grep crd</span>
<span class="n">crd</span><span class="p">.</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v1</span>

<span class="n">该api版本信息中有大量的配置属性</span>
<span class="n">kubectl</span> <span class="n">api-resources</span>  <span class="p">|</span> <span class="n">grep</span> <span class="n">crd</span><span class="p">.</span><span class="n">pro</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">这里面的</span> <span class="n">ippools</span> <span class="n">里面包含了calico相关的网络属性信息</span>
<span class="c"># kubectl get ippools</span>
<span class="n">NAME</span>                  <span class="n">AGE</span>
<span class="k">default</span><span class="n">-ipv4-ippool</span>   <span class="n">37m</span>

<span class="n">查看这里配置的calico相关的信息</span>
<span class="c"># kubectl get ippools default-ipv4-ippool -o yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">crd</span><span class="p">.</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">IPPool</span>
<span class="p">...</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">allowedUses</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">Workload</span>
  <span class="p">-</span> <span class="n">Tunnel</span>
  <span class="n">blockSize</span><span class="p">:</span> <span class="n">24</span>
  <span class="n">cidr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
  <span class="n">ipipMode</span><span class="p">:</span> <span class="n">Always</span>
  <span class="n">natOutgoing</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">nodeSelector</span><span class="p">:</span> <span class="n">all</span><span class="p">()</span>
  <span class="n">vxlanMode</span><span class="p">:</span> <span class="n">Never</span>
<span class="n">结果显式</span><span class="err">：</span>
    <span class="n">这里的calico采用的模型就是</span> <span class="n">ipip模型</span><span class="err">，</span><span class="n">分配的网段是使我们定制的</span> <span class="n">cidr网段</span><span class="err">，</span><span class="n">而且子网段也是我们定制的</span> <span class="n">24位掩码</span>
</code></pre></div>
<p>环境创建完毕后，会生成一个tunl0的网卡，所有的流量会走这个tunl0网卡</p>
<div class="highlight"><pre><span></span><code><span class="n">确认网卡和路由信息</span>
<span class="p">]</span><span class="c"># ifconfig | grep flags</span>
<span class="p">]</span><span class="c"># ip route list | grep tun</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">dev</span> <span class="n">tunl0</span> <span class="n">proto</span> <span class="n">bird</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="n">dev</span> <span class="n">tunl0</span> <span class="n">proto</span> <span class="n">bird</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">dev</span> <span class="n">tunl0</span> <span class="n">proto</span> <span class="n">bird</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">dev</span> <span class="n">tunl0</span> <span class="n">proto</span> <span class="n">bird</span> <span class="n">onlink</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">dev</span> <span class="n">tunl0</span> <span class="n">proto</span> <span class="n">bird</span> <span class="n">onlink</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">calico模型中</span><span class="err">，</span><span class="n">默认使用的是tunl0虚拟网卡实现数据包的专线转发</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">由于在calico的默认网络模型是</span> <span class="n">IPIP</span><span class="err">，</span><span class="n">所以我们在进行数据包测试的时候</span><span class="err">，</span><span class="n">可以通过直接抓取宿主机数据包</span><span class="err">，</span><span class="n">来发现双层ip效果</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span> <span class="n">-o</span> <span class="n">wide</span>

<span class="n">在master1上采用ping的方式来测试</span> <span class="n">node2上的节点pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">data</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">network</span><span class="p">/</span><span class="n">calico</span><span class="p">]</span><span class="c"># ping -c 1 10.244.4.3</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">794</span> <span class="n">ms</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在node2上检测数据包的效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node2</span> <span class="p">~]</span><span class="c"># tcpdump -i eth0 -nn ip host 10.0.0.16 and host 10.0.0.12</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="n">-v</span> <span class="n">or</span> <span class="n">-vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">eth0</span><span class="p">,</span> <span class="n">link-type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="n">262144</span> <span class="n">bytes</span>
<span class="n">15</span><span class="p">:</span><span class="n">38</span><span class="p">:</span><span class="n">52</span><span class="p">.</span><span class="n">231680</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="p">:</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">:</span> <span class="n">ICMP</span> <span class="nb">echo </span><span class="n">request</span><span class="p">,</span> <span class="n">id</span> <span class="n">19189</span><span class="p">,</span> <span class="n">seq</span> <span class="n">1</span><span class="p">,</span> <span class="n">length</span> <span class="n">64</span> <span class="p">(</span><span class="n">ipip-proto</span><span class="p">-</span><span class="n">4</span><span class="p">)</span>
<span class="n">15</span><span class="p">:</span><span class="n">38</span><span class="p">:</span><span class="n">52</span><span class="p">.</span><span class="n">231989</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">:</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="nb">echo </span><span class="n">reply</span><span class="p">,</span> <span class="n">id</span> <span class="n">19189</span><span class="p">,</span> <span class="n">seq</span> <span class="n">1</span><span class="p">,</span> <span class="n">length</span> <span class="n">64</span> <span class="p">(</span><span class="n">ipip-proto</span><span class="p">-</span><span class="n">4</span><span class="p">)</span>
<span class="n">15</span><span class="p">:</span><span class="n">38</span><span class="p">:</span><span class="n">54</span><span class="p">.</span><span class="n">666538</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">33992</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">179</span><span class="p">:</span> <span class="n">Flags</span> <span class="no">[P.]</span><span class="p">,</span> <span class="n">seq</span> <span class="n">4281052787</span><span class="p">:</span><span class="n">4281052806</span><span class="p">,</span> <span class="n">ack</span> <span class="n">3643645463</span><span class="p">,</span> <span class="n">win</span> <span class="n">58</span><span class="p">,</span> <span class="n">length</span> <span class="n">19</span><span class="p">:</span> <span class="n">BGP</span>
<span class="n">15</span><span class="p">:</span><span class="n">38</span><span class="p">:</span><span class="n">54</span><span class="p">.</span><span class="n">666962</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">179</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">33992</span><span class="p">:</span> <span class="n">Flags</span> <span class="p">[.],</span> <span class="n">ack</span> <span class="n">19</span><span class="p">,</span> <span class="n">win</span> <span class="n">58</span><span class="p">,</span> <span class="n">length</span> <span class="n">0</span>
<span class="n">结果显式</span><span class="err">：</span>
    <span class="n">每个数据包都是基于双层ip嵌套的方式来进行传输</span><span class="err">，</span><span class="n">而且协议是</span> <span class="n">ipip-proto</span><span class="p">-</span><span class="n">4</span>
    <span class="n">结合路由的分发详情</span><span class="err">，</span><span class="n">可以看到具体的操作效果</span><span class="err">。</span>
    <span class="n">具体效果</span><span class="err">：</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">-&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">-&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="p">-&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">6</span><span class="p">.</span><span class="n">3</span>
</code></pre></div>
<p><strong>命令完善</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">calico本身是一个复杂的系统</span><span class="err">，</span><span class="n">复杂到它自己提供一个非常重要的Restful接口</span><span class="err">，</span><span class="n">结合calicoctl命令来管理自身的相关属性信息</span><span class="err">，</span><span class="n">calicoctl可以直接与etcd进行操作</span><span class="err">，</span><span class="n">也可以通过kube-apiserver的方式与etcd来进行操作</span><span class="err">。</span><span class="n">默认情况下</span><span class="err">，</span><span class="n">它与kube-apiserver通信的认证方式与kubectl的命令使用同一个context</span><span class="err">。</span><span class="n">但是我们还是推荐</span><span class="err">，</span><span class="n">使用手工定制的一个配置文件</span><span class="err">。</span>

    <span class="n">calicoctl</span> <span class="n">是运行在集群之外的</span><span class="err">，</span><span class="n">用于管理集群功能的一个重要的组件</span><span class="err">。</span><span class="n">calicoctl</span> <span class="n">的安装方式很多</span><span class="err">，</span><span class="n">常见的方式有</span><span class="err">：</span><span class="n">单主机方式</span><span class="err">、</span><span class="n">kubectl命令插件方式</span><span class="err">、</span><span class="n">pod方式</span><span class="err">、</span><span class="n">主机容器方式</span><span class="err">。</span><span class="n">我们需要自己选择一种适合自己的方式</span>
    <span class="n">参考资料</span><span class="err">：</span><span class="n">https</span><span class="p">://</span><span class="n">projectcalico</span><span class="p">.</span><span class="n">docs</span><span class="p">.</span><span class="n">tigera</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">getting-started</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">hardway</span><span class="p">/</span><span class="n">the-calico-datastore</span><span class="c">#install</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取专用命令</span>
<span class="nb">cd </span><span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">/</span>
<span class="nb">curl </span><span class="n">-L</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">projectcalico</span><span class="p">/</span><span class="n">calico</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">v3</span><span class="p">.</span><span class="n">24</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="n">calicoctl-linux-amd64</span> <span class="n">-o</span> <span class="n">calicoctl</span>
<span class="n">chmod</span> <span class="p">+</span><span class="n">x</span> <span class="n">calicoctl</span>

<span class="n">查看帮助</span>
<span class="c"># calicoctl --help</span>
<span class="n">Usage</span><span class="p">:</span>
  <span class="n">calicoctl</span> <span class="no">[options]</span> <span class="p">&lt;</span><span class="n">command</span><span class="p">&gt;</span> <span class="p">[&lt;</span><span class="n">args</span><span class="p">&gt;...]</span>
</code></pre></div>
<p>命令的基本演示</p>
<div class="highlight"><pre><span></span><code><span class="n">查看ip的管理</span>
<span class="n">calicoctl</span> <span class="n">ipam</span> <span class="p">-</span><span class="n">-help</span>

<span class="n">查看ip的信息</span>
<span class="c"># calicoctl ipam show</span>
<span class="p">+----------+---------------+-----------+------------+--------------+</span>
<span class="p">|</span> <span class="n">GROUPING</span> <span class="p">|</span>     <span class="n">CIDR</span>      <span class="p">|</span> <span class="n">IPS</span> <span class="n">TOTAL</span> <span class="p">|</span> <span class="n">IPS</span> <span class="k">IN</span> <span class="n">USE</span> <span class="p">|</span>   <span class="n">IPS</span> <span class="n">FREE</span>   <span class="p">|</span>
<span class="p">+----------+---------------+-----------+------------+--------------+</span>
<span class="p">|</span> <span class="n">IP</span> <span class="n">Pool</span>  <span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span> <span class="p">|</span>     <span class="n">65536</span> <span class="p">|</span> <span class="n">0</span> <span class="p">(</span><span class="n">0</span><span class="p">%)</span>     <span class="p">|</span> <span class="n">65536</span> <span class="p">(</span><span class="n">100</span><span class="p">%)</span> <span class="p">|</span>
<span class="p">+----------+---------------+-----------+------------+--------------+</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看信息的显式效果</span>
<span class="n">calicoctl</span> <span class="n">ipam</span> <span class="n">show</span> <span class="p">-</span><span class="n">-help</span>

<span class="n">显式相关的配置属性</span>
<span class="c"># calicoctl ipam show --show-configuration</span>
<span class="p">+--------------------+-------+</span>
<span class="p">|</span>      <span class="n">PROPERTY</span>      <span class="p">|</span> <span class="n">VALUE</span> <span class="p">|</span>
<span class="p">+--------------------+-------+</span>
<span class="p">|</span> <span class="n">StrictAffinity</span>     <span class="p">|</span> <span class="n">false</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">AutoAllocateBlocks</span> <span class="p">|</span> <span class="n">true</span>  <span class="p">|</span>
<span class="p">|</span> <span class="n">MaxBlocksPerHost</span>   <span class="p">|</span>     <span class="n">0</span> <span class="p">|</span>
<span class="p">+--------------------+-------+</span>
</code></pre></div>
<p>将calico整合到kubectl里面</p>
<div class="highlight"><pre><span></span><code><span class="n">定制kubectl</span> <span class="n">插件子命令</span>
<span class="c"># cd /usr/local/bin/</span>
<span class="c"># cp -p calicoctl kubectl-calico</span>

<span class="n">测试效果</span>
<span class="c"># kubectl calico --help</span>
<span class="n">Usage</span><span class="p">:</span>
  <span class="n">kubectl-calico</span> <span class="no">[options]</span> <span class="p">&lt;</span><span class="n">command</span><span class="p">&gt;</span> <span class="p">[&lt;</span><span class="n">args</span><span class="p">&gt;...]</span>

<span class="n">后续的操作基本上都一样了</span><span class="err">，</span><span class="n">比如获取网络节点效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">local</span><span class="p">/</span><span class="n">bin</span><span class="p">]</span><span class="c"># kubectl calico node status</span>
<span class="n">Calico</span> <span class="k">process</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>

<span class="n">IPv4</span> <span class="n">BGP</span> <span class="n">status</span>
<span class="p">+--------------+-------------------+-------+----------+-------------+</span>
<span class="p">|</span> <span class="n">PEER</span> <span class="n">ADDRESS</span> <span class="p">|</span>     <span class="n">PEER</span> <span class="nb">TYPE </span>    <span class="p">|</span> <span class="n">STATE</span> <span class="p">|</span>  <span class="n">SINCE</span>   <span class="p">|</span>    <span class="n">INFO</span>     <span class="p">|</span>
<span class="p">+--------------+-------------------+-------+----------+-------------+</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">48</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">48</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">48</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">51</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">31</span><span class="p">:</span><span class="n">41</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">+--------------+-------------------+-------+----------+-------------+</span>

<span class="n">IPv6</span> <span class="n">BGP</span> <span class="n">status</span>
<span class="n">No</span> <span class="n">IPv6</span> <span class="n">peers</span> <span class="n">found</span><span class="p">.</span>
<span class="n">注意</span><span class="err">：</span>
    <span class="n">这里查看的是除了自己网段之外的其他节点的路由信息</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="23_bgp">2.3  BGP实践<a class="headerlink" href="#23_bgp" title="Permanent link">&para;</a></h2>
<p>学习目标</p>
<p>这一节，我们从 bgp改造、反射器实践、小结 三个方面来学习</p>
<p><strong>bgp改造</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">对于现有的calico环境</span><span class="err">，</span><span class="n">我们如果需要使用BGP环境</span><span class="err">，</span><span class="n">我们可以直接使用一个配置清单来进行修改calico环境即可</span><span class="err">。</span><span class="n">我们这里先来演示一下如何使用calicoctl修改配置属性</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">获取当前的配置属性</span>
<span class="c"># kubectl calico get ipPools</span>
<span class="n">NAME</span>                  <span class="n">CIDR</span>            <span class="n">SELECTOR</span>
<span class="k">default</span><span class="n">-ipv4-ippool</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>   <span class="n">all</span><span class="p">()</span>

<span class="c"># kubectl calico get ipPools default-ipv4-ippool -o yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">IPPool</span>
<span class="p">...</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">blockSize</span><span class="p">:</span> <span class="n">24</span>
  <span class="n">cidr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
  <span class="n">ipipMode</span><span class="p">:</span> <span class="n">Always</span>
  <span class="n">natOutgoing</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">nodeSelector</span><span class="p">:</span> <span class="n">all</span><span class="p">()</span>
  <span class="n">vxlanMode</span><span class="p">:</span> <span class="n">Never</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">定制资源配置文件</span>
<span class="n">kubectl</span> <span class="n">calico</span> <span class="n">get</span> <span class="n">ipPools</span> <span class="k">default</span><span class="n">-ipv4-ippool</span> <span class="n">-o</span> <span class="n">yaml</span> <span class="p">&gt;</span> <span class="k">default</span><span class="n">-ipv4-ippool</span><span class="p">.</span><span class="n">yaml</span>

<span class="n">修改配置文件</span>
<span class="c"># cat default-ipv4-ippool.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">IPPool</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="k">default</span><span class="n">-ipv4-ippool</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">blockSize</span><span class="p">:</span> <span class="n">24</span>
  <span class="n">cidr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
  <span class="n">ipipMode</span><span class="p">:</span> <span class="n">CrossSubnet</span>
  <span class="n">natOutgoing</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">nodeSelector</span><span class="p">:</span> <span class="n">all</span><span class="p">()</span>
  <span class="n">vxlanMode</span><span class="p">:</span> <span class="n">Never</span>
  <span class="n">配置解析</span><span class="err">：</span>
    <span class="n">仅仅将原来的Always</span> <span class="n">更换成</span> <span class="n">CrossSubnet</span><span class="p">(</span><span class="n">跨节点子网</span><span class="p">)</span> <span class="n">模式即可</span>
    <span class="n">vxlanMode</span> <span class="n">的两个值可以实现所谓的</span> <span class="n">BGP</span> <span class="n">with</span> <span class="n">vxlan的效果</span>

<span class="n">应用资源配置文件</span>
<span class="c"># kubectl calico apply -f default-ipv4-ippool.yaml</span>
<span class="n">Successfully</span> <span class="n">applied</span> <span class="n">1</span> <span class="s1">&#39;IPPool&#39;</span> <span class="n">resource</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>
<p>检查效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看路由信息</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># ip route list | grep via</span>
<span class="k">default</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">2</span> <span class="n">dev</span> <span class="n">eth0</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">bird</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">bird</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">bird</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">bird</span>
<span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span> <span class="n">via</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">bird</span>

<span class="n">结果显式</span><span class="err">：</span>
    <span class="n">更新完毕配置后</span><span class="err">，</span><span class="n">动态路由的信息就发生改变了</span><span class="err">，</span><span class="n">不再完全是</span> <span class="n">tunl0</span> <span class="n">网卡了</span><span class="err">，</span><span class="n">而是变成了通过具体的物理网卡eth0</span> <span class="n">转发出去了</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在master1上ping在节点node2上的pod</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># ping -c 1 10.244.4.3</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">671</span> <span class="n">ms</span>

<span class="n">由于这次是直接通过节点进行转发的</span><span class="err">，</span><span class="n">所以我们在node2节点上抓包的时候</span><span class="err">，</span><span class="n">直接通过内层ip抓取即可</span><span class="err">。</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-node2</span> <span class="p">~]</span><span class="c"># tcpdump -i eth0 -nn ip host 10.244.4.3</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="n">-v</span> <span class="n">or</span> <span class="n">-vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">eth0</span><span class="p">,</span> <span class="n">link-type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="n">262144</span> <span class="n">bytes</span>
<span class="n">15</span><span class="p">:</span><span class="n">47</span><span class="p">:</span><span class="n">32</span><span class="p">.</span><span class="n">906462</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span><span class="p">:</span> <span class="n">ICMP</span> <span class="nb">echo </span><span class="n">request</span><span class="p">,</span> <span class="n">id</span> <span class="n">28248</span><span class="p">,</span> <span class="n">seq</span> <span class="n">1</span><span class="p">,</span> <span class="n">length</span> <span class="n">64</span>
<span class="n">15</span><span class="p">:</span><span class="n">47</span><span class="p">:</span><span class="n">32</span><span class="p">.</span><span class="n">906689</span> <span class="n">IP</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">3</span> <span class="p">&gt;</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">:</span> <span class="n">ICMP</span> <span class="nb">echo </span><span class="n">reply</span><span class="p">,</span> <span class="n">id</span> <span class="n">28248</span><span class="p">,</span> <span class="n">seq</span> <span class="n">1</span><span class="p">,</span> <span class="n">length</span> <span class="n">64</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">他们实现了直接的连通</span><span class="err">，</span><span class="n">无需进行数据包的转换了</span><span class="err">，</span><span class="n">效率更高一点</span>
</code></pre></div>
<p><strong>反射器实践</strong></p>
<p>当前节点的网络效果</p>
<div class="highlight"><pre><span></span><code><span class="n">查看当前节点的网络效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl calico node status</span>
<span class="n">Calico</span> <span class="k">process</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>

<span class="n">IPv4</span> <span class="n">BGP</span> <span class="n">status</span>
<span class="p">+--------------+-------------------+-------+----------+-------------+</span>
<span class="p">|</span> <span class="n">PEER</span> <span class="n">ADDRESS</span> <span class="p">|</span>     <span class="n">PEER</span> <span class="nb">TYPE </span>    <span class="p">|</span> <span class="n">STATE</span> <span class="p">|</span>  <span class="n">SINCE</span>   <span class="p">|</span>    <span class="n">INFO</span>     <span class="p">|</span>
<span class="p">+--------------+-------------------+-------+----------+-------------+</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">48</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">48</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">48</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">30</span><span class="p">:</span><span class="n">51</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>    <span class="p">|</span> <span class="n">node-to-node</span> <span class="n">mesh</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">31</span><span class="p">:</span><span class="n">41</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">+--------------+-------------------+-------+----------+-------------+</span>
</code></pre></div>
<p>需求</p>
<div class="highlight"><pre><span></span><code>    <span class="n">当前的calico节点的网络状态是</span> <span class="n">BGP</span> <span class="n">peer</span> <span class="n">的模型效果</span><span class="err">，</span><span class="n">也就是说</span> <span class="n">每个节点上都要维护</span> <span class="n">n</span><span class="p">-</span><span class="n">1</span> <span class="n">个路由配置信息</span><span class="err">，</span><span class="n">整个集群中需要维护</span> <span class="n">n</span><span class="p">*(</span><span class="n">n</span><span class="p">-</span><span class="n">1</span><span class="p">)</span> <span class="n">个路由效果</span><span class="err">，</span><span class="n">这在节点量非常多的场景中</span><span class="err">，</span><span class="n">不是我们想要的</span><span class="err">。</span>
    <span class="n">所以我们需要实现一种</span> <span class="n">BGP</span> <span class="n">reflecter</span> <span class="n">的效果</span><span class="err">。</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>    <span class="n">如果我们要做</span> <span class="n">BGP</span> <span class="n">reflecter</span> <span class="n">效果的话</span><span class="err">，</span><span class="n">需要对反射器角色做冗余</span><span class="err">，</span><span class="n">如果我们的集群是一个多主集群的话</span><span class="err">，</span><span class="n">可以将集群的master节点作为bgp的reflecter角色</span><span class="err">，</span><span class="n">从而实现反射器的冗余</span><span class="err">。</span>
    <span class="n">1</span> <span class="n">定制反射器角色</span>
    <span class="n">2</span> <span class="n">后端节点使用反射器</span>
    <span class="n">3</span> <span class="n">关闭默认的网格效果</span>
</code></pre></div>
<p>1 创建反射器角色</p>
<div class="highlight"><pre><span></span><code><span class="n">定制资源定义文件</span> <span class="n">01-calico-reflector-master</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Node</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">route-reflector</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">kubernetes-master1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">bgp</span><span class="p">:</span>
    <span class="n">ipv4Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">12</span><span class="p">/</span><span class="n">16</span>
    <span class="n">ipv4IPIPTunnelAddr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
    <span class="n">routeReflectorClusterID</span><span class="p">:</span> <span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">1</span>
<span class="n">属性解析</span><span class="err">；</span>
    <span class="n">metadata</span><span class="p">.</span><span class="n">labels</span> <span class="n">是非常重要的</span><span class="err">，</span><span class="n">因为它需要被后面的节点来进行获取</span>
    <span class="n">metadata</span><span class="p">.</span><span class="n">name</span> <span class="n">的属性</span><span class="err">，</span><span class="n">必须是通过</span> <span class="n">calicoctl</span> <span class="n">get</span> <span class="n">nodes</span> <span class="n">获取到的节点名称</span><span class="err">。</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">bgp</span><span class="p">.</span><span class="n">ipv4Address必须是</span> <span class="n">指定节点的ip地址</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">bgp</span><span class="p">.</span><span class="n">ipv4IPIPTunnelAddr必须是</span> <span class="n">指定节点上tunl0的地址</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">bgp</span><span class="p">.</span><span class="n">routeReflectorClusterID</span> <span class="n">是BGP网络中的唯一标识</span><span class="err">，</span><span class="n">所以这里的集群标识只要唯一就可以了</span>

<span class="n">应用资源配置文件</span>
<span class="n">kubectl</span> <span class="n">calico</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">01-calico-reflector-master</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<p>2 更改节点的网络模型为 reflecter模型</p>
<div class="highlight"><pre><span></span><code><span class="n">定制资源定义文件</span> <span class="n">02-calico-reflector-bgppeer</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">BGPPeer</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v3</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">bgppeer-demo</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeSelector</span><span class="p">:</span> <span class="n">all</span><span class="p">()</span>
  <span class="n">peerSelector</span><span class="p">:</span> <span class="n">route-reflector</span><span class="p">==</span><span class="s2">&quot;true&quot;</span>
<span class="n">属性解析</span><span class="err">；</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">nodeSelector</span> <span class="n">指定的所有后端节点</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">peerSelector</span> <span class="n">指定的是反射器的标签</span><span class="err">，</span><span class="n">标识所有的后端节点与这个反射器进行数据交流</span>

<span class="n">应用资源配置文件</span>
<span class="n">kubectl</span> <span class="n">calico</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">02-calico-reflector-bgppeer</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<p>3 关闭默认的网格效果</p>
<div class="highlight"><pre><span></span><code><span class="n">定制资源定义文件</span> <span class="n">03-calico-reflector-defaultconfig</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">projectcalico</span><span class="p">.</span><span class="n">org</span><span class="p">/</span><span class="n">v3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">BGPConfiguration</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">logSeverityScreen</span><span class="p">:</span> <span class="n">Info</span>
  <span class="n">nodeToNodeMeshEnabled</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">asNumber</span><span class="p">:</span> <span class="n">63400</span>

<span class="n">属性解析</span><span class="err">；</span>
    <span class="n">metadata</span><span class="p">.</span><span class="n">name</span> <span class="n">在这里最好是default</span><span class="err">，</span><span class="n">因为我们要对BGP默认的网络效果进行关闭</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">nodeToNodeMeshEnabled</span> <span class="n">关闭后端节点的BGP</span> <span class="n">peer默认状态</span> <span class="p">--</span> <span class="n">即点对点通信关闭</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">asNumber</span> <span class="n">指定的是后端节点间使用反射器的时候</span><span class="err">，</span><span class="n">我们要在一个标志号内</span><span class="err">，</span><span class="n">这里随意写一个</span>

<span class="n">应用资源配置文件</span>
<span class="n">kubectl</span> <span class="n">calico</span> <span class="n">apply</span> <span class="o">-f</span> <span class="n">03-calico-reflector-defaultconfig</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~/</span><span class="n">txt</span><span class="p">]</span><span class="c"># kubectl calico node status</span>
<span class="p">...</span>
<span class="n">IPv4</span> <span class="n">BGP</span> <span class="n">status</span>
<span class="p">+--------------+---------------+-------+----------+-------------+</span>
<span class="p">|</span> <span class="n">PEER</span> <span class="n">ADDRESS</span> <span class="p">|</span>   <span class="n">PEER</span> <span class="nb">TYPE </span>  <span class="p">|</span> <span class="n">STATE</span> <span class="p">|</span>  <span class="n">SINCE</span>   <span class="p">|</span>    <span class="n">INFO</span>     <span class="p">|</span>
<span class="p">+--------------+---------------+-------+----------+-------------+</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">13</span>    <span class="p">|</span> <span class="n">node</span> <span class="n">specific</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">51</span><span class="p">:</span><span class="n">47</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">14</span>    <span class="p">|</span> <span class="n">node</span> <span class="n">specific</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">51</span><span class="p">:</span><span class="n">49</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">15</span>    <span class="p">|</span> <span class="n">node</span> <span class="n">specific</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">51</span><span class="p">:</span><span class="n">49</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">16</span>    <span class="p">|</span> <span class="n">node</span> <span class="n">specific</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">51</span><span class="p">:</span><span class="n">47</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">|</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">17</span>    <span class="p">|</span> <span class="n">node</span> <span class="n">specific</span> <span class="p">|</span> <span class="n">up</span>    <span class="p">|</span> <span class="n">07</span><span class="p">:</span><span class="n">51</span><span class="p">:</span><span class="n">47</span> <span class="p">|</span> <span class="n">Established</span> <span class="p">|</span>
<span class="p">+--------------+---------------+-------+----------+-------------+</span>
<span class="n">结果显式</span><span class="err">：</span>
    <span class="n">默认的点对点通信方式就已经丢失了</span><span class="err">，</span><span class="n">剩下了反射器模式</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="24">2.4  策略实践<a class="headerlink" href="#24" title="Permanent link">&para;</a></h2>
<p>学习目标</p>
<p>这一节，我们从 属性解读、基本控制、小结 三个方面来学习。</p>
<p><strong>属性解读</strong></p>
<p>策略简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">为了使用Network</span> <span class="n">Policy</span><span class="err">，</span><span class="n">Kubernetes引入了一个新的资源对象Network</span> <span class="n">Policy</span><span class="err">，</span><span class="n">供用户设置Pod间网络访问的策略</span><span class="err">。</span><span class="n">策略控制器用于监控指定区域创建对象</span><span class="p">(</span><span class="n">pod</span><span class="p">)</span><span class="n">时所生成的新API端点</span><span class="err">，</span><span class="n">并按需为其附加网络策略</span><span class="err">。</span>

    <span class="n">对于Pod对象来说</span><span class="err">，</span><span class="n">网络流量分为</span> <span class="n">流入</span><span class="p">(</span><span class="n">Ingress</span><span class="p">)</span><span class="n">和流出</span><span class="p">(</span><span class="n">Egress</span><span class="p">)</span><span class="n">两个方向</span><span class="err">，</span><span class="n">每个方向包含允许和禁止两种控制策略</span><span class="err">，</span><span class="n">默认情况下</span><span class="err">，</span><span class="n">所有的策略都是允许的</span><span class="err">，</span><span class="n">应用策略后</span><span class="err">，</span><span class="n">所有未经明确允许的流量都将拒绝</span><span class="err">。</span>
</code></pre></div>
<p><img alt="image-20220722193530812" src="../../../img/kubernetes/kubernetes_calico/image-20220722193530812.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">注意</span><span class="err">：</span>
    <span class="n">网络策略的控制</span><span class="err">，</span><span class="n">可以是多个级别</span><span class="err">：</span>
        <span class="n">集群级别</span><span class="err">、</span><span class="n">namespace级别</span><span class="err">、</span><span class="n">Pod级别</span><span class="err">、</span><span class="n">ip级别</span><span class="err">、</span><span class="n">端口级别</span>
</code></pre></div>
<p>资源对象属性</p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>    <span class="c"># 资源隶属的API群组及版本号</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>                 <span class="c"># 资源类型的名称，名称空间级别的资源；</span>
<span class="n">metadata</span><span class="p">:</span>                           <span class="c"># 资源元数据</span>
    <span class="n">name</span> <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>                   <span class="c"># 资源名称标识</span>
    <span class="n">namespace</span> <span class="p">&lt;</span><span class="n">string</span><span class="p">&gt;</span>              <span class="c"># NetworkPolicy是名称空间级别的资源</span>
<span class="n">spec</span><span class="p">:</span>                               <span class="c"># 期望的状态</span>
    <span class="n">podSelector</span> <span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;</span>            <span class="c"># 当前规则生效的一组目标Pod对象，必选字段；空值表示当前名称空间中的所有Pod资源</span>
    <span class="n">policyTypes</span> <span class="p">&lt;[]</span><span class="n">string</span><span class="p">&gt;</span>          <span class="c"># Ingress表示生效ingress字段；Egress表示生效egress字段，同时提供表示二者均有效</span>
    <span class="n">ingress</span> <span class="p">&lt;[]</span><span class="n">Object</span><span class="p">&gt;</span>              <span class="c"># 入站流量源端点对象列表，白名单，空值表示“所有”</span>
    <span class="p">-</span> <span class="n">from</span> <span class="p">&lt;[]</span><span class="n">Object</span><span class="p">&gt;</span>               <span class="c"># 具体的端点对象列表，空值表示所有合法端点</span>
      <span class="p">-</span> <span class="n">ipBlock</span>  <span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;</span>           <span class="c"># IP地址块范围内的端点，不能与另外两个字段同时使用</span>
      <span class="p">-</span> <span class="n">namespaceSelector</span> <span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;</span>  <span class="c"># 匹配的名称空间内的端点</span>
        <span class="n">podSelector</span> <span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;</span>        <span class="c"># 由Pod标签选择器匹配到的端点，空值表示&lt;none&gt;</span>
      <span class="n">ports</span> <span class="p">&lt;[]</span><span class="n">Object</span><span class="p">&gt;</span>              <span class="c"># 具体的端口对象列表，空值表示所有合法端口</span>
    <span class="n">egress</span> <span class="p">&lt;[]</span><span class="n">Object</span><span class="p">&gt;</span>               <span class="c"># 出站流量目标端点对象列表，白名单，空值表示“所有”</span>
    <span class="p">-</span> <span class="n">to</span> <span class="p">&lt;[]</span><span class="n">Object</span><span class="p">&gt;</span>                 <span class="c"># 具体的端点对象列表，空值表示所有合法端点，格式同ingres.from；</span>
      <span class="n">ports</span> <span class="p">&lt;[]</span><span class="n">Object</span><span class="p">&gt;</span>              <span class="c"># 具体的端口对象列表，空值表示所有合法端口</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">入栈和出栈哪个策略生效</span><span class="err">，</span><span class="n">由</span> <span class="n">policyTypes</span> <span class="n">来决定</span><span class="err">。</span>
    <span class="n">如果仅配置了podSelector</span><span class="err">，</span><span class="n">表明</span><span class="err">，</span><span class="n">当前限制仅限于当前的命名空间</span>
</code></pre></div>
<p>配置示例</p>
<div class="highlight"><pre><span></span><code><span class="n">apiVersion</span><span class="p">:</span>  <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="nb">test-network</span><span class="n">-policy</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">podSelector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">role</span><span class="p">:</span> <span class="n">db</span>
  <span class="n">policyTypes</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">Ingress</span>
  <span class="p">-</span> <span class="n">Egress</span>
  <span class="n">ingress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">from</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">ipBlock</span><span class="p">:</span>
        <span class="n">cidr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
        <span class="n">except</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
    <span class="p">-</span> <span class="n">namespacesSelector</span><span class="p">:</span>
        <span class="n">matchLabels</span><span class="p">:</span>
          <span class="n">project</span><span class="p">:</span> <span class="n">develop</span>
    <span class="p">-</span> <span class="n">podSelector</span><span class="p">:</span>
        <span class="n">matchLabels</span><span class="p">:</span>
          <span class="n">arch</span><span class="p">:</span> <span class="n">frontend</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">6379</span>
  <span class="n">egress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">to</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">ipBlock</span><span class="p">:</span>
        <span class="n">cidr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
      <span class="n">ports</span><span class="p">:</span>
      <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">3306</span>
</code></pre></div>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">在default命名空间创建应用</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl create deployment nginx-web --image=kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx-web --port=80</span>

<span class="n">在superopsmsb命名空间创建应用</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl create deployment nginx-web --image=kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1 --namespace=superopsmsb</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl expose deployment nginx-web --port=80 --namespace=superopsmsb</span>

<span class="n">确认效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  get pod -o wide</span>
<span class="n">NAME</span>                         <span class="n">READY</span><span class="p">...</span> <span class="n">AGE</span>   <span class="n">IP</span>           <span class="p">...</span>
<span class="n">nginx-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>  <span class="p">...</span> <span class="n">10s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span>   <span class="p">...</span>

<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  get pod -o wide -n superopsmsb</span>
<span class="n">NAME</span>                         <span class="n">READY</span><span class="p">...</span> <span class="n">AGE</span>   <span class="n">IP</span>           <span class="p">...</span>
<span class="n">nginx-web</span><span class="p">-</span><span class="n">65d688fd6-h6sbpp</span>   <span class="n">1</span><span class="p">/</span><span class="n">1</span>  <span class="p">...</span> <span class="n">10s</span>   <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span>   <span class="p">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">开启superopsmsb的测试容器</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  exec -it nginx-web-65d688fd6-h6sbp -n superopsmsb -- /bin/bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">65d688fd6-h6sbp</span><span class="p">:/</span><span class="c"># apt update; apt install net-tools iputils-ping dnsutils curl -y</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">进入到容器里面查看效果</span>
<span class="p">[</span><span class="n">root</span><span class="nv">@kubernetes</span><span class="n">-master1</span> <span class="p">~]</span><span class="c"># kubectl  exec -it nginx-web-5865bb968d-759lc -- /bin/bash</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># apt update; apt install net-tools iputils-ping dnsutils curl -y</span>

<span class="n">域名检测</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># nslookup nginx-web</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">nginx-web</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">101</span><span class="p">.</span><span class="n">181</span><span class="p">.</span><span class="n">105</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># nslookup nginx-web.superopsmsb.svc.cluster.local</span>
<span class="n">Server</span><span class="p">:</span>         <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span><span class="p">:</span>        <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="c">#53</span>
<span class="n">Name</span><span class="p">:</span>   <span class="n">nginx-web</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">105</span><span class="p">.</span><span class="n">110</span><span class="p">.</span><span class="n">175</span>

<span class="n">ping检测</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># ifconfig | grep 244</span>
        <span class="n">inet</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span>  <span class="n">netmask</span> <span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>  <span class="n">broadcast</span> <span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="n">22442</span>  <span class="n">bytes</span> <span class="n">20956160</span> <span class="p">(</span><span class="n">19</span><span class="p">.</span><span class="n">9</span> <span class="n">MiB</span><span class="p">)</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># ping -c 1 10.244.1.5</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">357</span> <span class="n">ms</span>
</code></pre></div>
<p><strong>基本控制</strong></p>
<p>默认拒绝规则</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源清单文件</span>
<span class="c"># cat 01_kubernetes_secure_networkpolicy_refuse.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="nb">deny-all</span><span class="n">-ingress</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">superopsmsb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">policyTypes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ingress&quot;</span><span class="p">,</span> <span class="s2">&quot;Egress&quot;</span><span class="p">]</span>

<span class="n">应用资源清单文件</span>
<span class="c"># kubectl  apply -f 01_kubernetes_secure_networkpolicy_refuse.yaml</span>
<span class="n">networkpolicy</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="nb">deny-all</span><span class="n">-ingress</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">尝试default空间资源访问superopsmsb空间资源</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># ping -c 1 10.244.1.5</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>

<span class="p">---</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="p">---</span>
<span class="n">1</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="n">0</span> <span class="n">received</span><span class="p">,</span> <span class="n">100</span><span class="p">%</span> <span class="n">packet</span> <span class="n">loss</span><span class="p">,</span> <span class="n">time</span> <span class="n">0ms</span>

<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># curl nginx-web.superopsmsb.svc.cluster.local</span>
<span class="n">curl</span><span class="p">:</span> <span class="p">(</span><span class="n">28</span><span class="p">)</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">nginx-web</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="n">port</span> <span class="n">80</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">timed</span> <span class="n">out</span>
<span class="n">结果显示</span><span class="p">:</span>
    <span class="n">访问失败</span>

<span class="n">default空间资源访问非superopsmsb空间资源正常</span><span class="err">。</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># curl nginx-web</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">nginx-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
</code></pre></div>
<p>默认启用规则</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源清单文件</span>
<span class="c"># cat 02_kubernetes_secure_networkpolicy_allow.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">allow-all-ingress</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">superopsmsb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">policyTypes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ingress&quot;</span><span class="p">,</span> <span class="s2">&quot;Egress&quot;</span><span class="p">]</span>
  <span class="n">egress</span><span class="p">:</span>
  <span class="p">-</span> <span class="p">{}</span>
  <span class="n">ingress</span><span class="p">:</span>
  <span class="p">-</span> <span class="p">{}</span>

<span class="n">应用资源清单文件</span>
<span class="c"># kubectl  apply -f 02_kubernetes_secure_networkpolicy_allow.yaml</span>
<span class="n">networkpolicy</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">allow-all-ingress</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在default空间访问superopsmsb空间资源</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># curl nginx-web.superopsmsb.svc.cluster.local</span>
<span class="n">Hello</span> <span class="n">Nginx</span><span class="p">,</span> <span class="n">nginx-web</span><span class="p">-</span><span class="n">65d688fd6-h6sbp</span><span class="p">-</span><span class="n">1</span><span class="p">.</span><span class="n">23</span><span class="p">.</span><span class="n">0</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># ping -c 1 10.244.1.5</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">181</span> <span class="n">ms</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">网络策略成功了</span><span class="err">，</span><span class="n">而且多个网络策略可以叠加</span>
    <span class="n">注意</span><span class="err">：</span><span class="n">仅仅同名策略或者同类型策略可以覆盖</span>

<span class="n">清理网络策略</span>
<span class="c"># kubectl  delete -f 02_kubernetes_secure_networkpolicy_allow.yaml</span>
</code></pre></div>
<p>当前namespace的流量限制</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源清单文件</span>
<span class="c"># cat 03_kubernetes_secure_networkpolicy_ns.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">allow-current-ns</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">superopsmsb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">policyTypes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ingress&quot;</span><span class="p">,</span> <span class="s2">&quot;Egress&quot;</span><span class="p">]</span>
  <span class="n">egress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">to</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">ingress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">from</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">配置解析</span><span class="err">：</span>
    <span class="n">虽然设置了egress和ingress属性</span><span class="err">，</span><span class="n">但是下面的podSelector没有选择节点</span><span class="err">，</span><span class="n">表示只有当前命名空间所有节点不受限制</span>

<span class="n">应用资源清单文件</span>
<span class="c"># kubectl  apply -f 03_kubernetes_secure_networkpolicy_ns.yaml</span>
<span class="n">networkpolicy</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">allow-current-ns</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">default资源访问superopsmsb资源</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># curl nginx-web.superopsmsb.svc.cluster.local</span>
<span class="n">curl</span><span class="p">:</span> <span class="p">(</span><span class="n">28</span><span class="p">)</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">nginx-web</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span> <span class="n">port</span> <span class="n">80</span><span class="p">:</span> <span class="n">Connection</span> <span class="n">timed</span> <span class="n">out</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">5865bb968d</span><span class="p">-</span><span class="n">759lc</span><span class="p">:/</span><span class="c"># ping -c 1 10.244.1.5</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">访问失败</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">superopsmsb资源访问同命名空间的其他资源</span>
<span class="n">root</span><span class="nv">@nginx</span><span class="n">-web</span><span class="p">-</span><span class="n">65d688fd6-h6sbp</span><span class="p">:/</span><span class="c"># ping 10.244.1.2</span>
<span class="n">PING</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">)</span> <span class="n">56</span><span class="p">(</span><span class="n">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="n">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="p">=</span><span class="n">1</span> <span class="n">ttl</span><span class="p">=</span><span class="n">63</span> <span class="n">time</span><span class="p">=</span><span class="n">0</span><span class="p">.</span><span class="n">206</span> <span class="n">ms</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">同命名空间可以正常访问</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="25">2.5  流量管控<a class="headerlink" href="#25" title="Permanent link">&para;</a></h2>
<p>学习目标</p>
<p>这一节，我们从 ip限制实践、pod限制实践、小结 三个方面来学习。</p>
<p><strong>ip限制知识</strong></p>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">准备同名空间的两个测试pod</span>
<span class="n">终端1</span>
<span class="n">kubectl</span> <span class="n">run</span> <span class="n">superopsmsb-client1</span> <span class="p">-</span><span class="n">-image</span><span class="p">=</span><span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">busybox</span> <span class="n">-n</span> <span class="n">superopsmsb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-it</span> <span class="p">--</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">sh</span>

<span class="n">终端2</span>
<span class="n">kubectl</span> <span class="n">run</span> <span class="n">superopsmsb-client2</span> <span class="p">-</span><span class="n">-image</span><span class="p">=</span><span class="n">kubernetes-register</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">superopsmsb</span><span class="p">/</span><span class="n">busybox</span> <span class="n">-n</span> <span class="n">superopsmsb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-it</span> <span class="p">--</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">sh</span>
</code></pre></div>
<p>简介</p>
<div class="highlight"><pre><span></span><code><span class="n">查看资源清单文件</span>
<span class="c"># cat 04_kubernetes_secure_networkpolicy_ns_pod.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="nb">deny-ns</span><span class="n">-pod</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">superopsmsb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">policyTypes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ingress&quot;</span><span class="p">,</span> <span class="s2">&quot;Egress&quot;</span><span class="p">]</span>
  <span class="n">egress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">to</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">ingress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">from</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">ipBlock</span><span class="p">:</span>
        <span class="n">cidr</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">16</span>
        <span class="n">except</span><span class="p">:</span>
        <span class="p">-</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">0</span><span class="p">/</span><span class="n">24</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">80</span>
  <span class="n">配置解析</span><span class="err">：</span>
    <span class="n">虽然设置了egress和ingress属性</span><span class="err">，</span><span class="n">但是下面的podSelector没有选择节点</span><span class="err">，</span><span class="n">表示只有当前命名空间所有节点不受限制</span>

<span class="n">应用资源对象文件</span>
<span class="c"># kubectl  apply -f 04_kubernetes_secure_networkpolicy_ns_pod.yaml</span>
<span class="n">networkpolicy</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="nb">deny-ns</span><span class="n">-pod</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">3网段测试容器查看效果</span>
<span class="p">/</span> <span class="c"># ifconfig | grep 244</span>
          <span class="n">inet</span> <span class="n">addr</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">3</span><span class="p">.</span><span class="n">7</span>  <span class="n">Bcast</span><span class="p">:</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>  <span class="n">Mask</span><span class="p">:</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>
<span class="p">/</span> <span class="c"># wget 10.244.1.5</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">:</span><span class="n">80</span><span class="p">)</span>
<span class="n">index</span><span class="p">.</span><span class="n">html</span>           <span class="n">100</span><span class="p">%</span> <span class="p">|*****************************************************|</span>    <span class="n">46</span>   <span class="n">0</span><span class="p">:</span><span class="n">00</span><span class="p">:</span><span class="n">00</span> <span class="n">ETA</span>
<span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">2网段测试容器查看效果</span>
<span class="p">/</span> <span class="c"># ifconfig | grep 244</span>
          <span class="n">inet</span> <span class="n">addr</span><span class="p">:</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">6</span>  <span class="n">Bcast</span><span class="p">:</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span>  <span class="n">Mask</span><span class="p">:</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span><span class="p">.</span><span class="n">255</span>
<span class="p">/</span> <span class="c"># wget 10.244.1.5</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">:</span><span class="n">80</span><span class="p">)</span>
<span class="n">wget</span><span class="p">:</span> <span class="n">can</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">host</span> <span class="p">(</span><span class="n">10</span><span class="p">.</span><span class="n">244</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">5</span><span class="p">):</span> <span class="n">Connection</span> <span class="n">timed</span> <span class="n">out</span>
<span class="p">/</span>
<span class="n">结果显示</span><span class="err">：</span>
    <span class="n">同namespace可以进行ip级别的访问测试</span>
</code></pre></div>
<p><strong>pod限制实践</strong></p>
<p>实践</p>
<div class="highlight"><pre><span></span><code><span class="n">查看在ip限制的基础上</span><span class="err">，</span><span class="n">扩充pod限制资源清单文件</span>
<span class="c"># cat 05_kubernetes_secure_networkpolicy_ns_port.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">NetworkPolicy</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">egress-controller</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">superopsmsb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">podSelector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">policyTypes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Egress&quot;</span><span class="p">]</span>
  <span class="n">egress</span><span class="p">:</span>
  <span class="p">-</span> <span class="n">to</span><span class="p">:</span> 
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">UDP</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">53</span>
  <span class="p">-</span> <span class="n">to</span><span class="p">:</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="p">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="n">80</span> 
  <span class="n">配置解析</span><span class="err">：</span>
    <span class="n">虽然设置了egress和ingress属性</span><span class="err">，</span><span class="n">但是下面的podSelector没有选择节点</span><span class="err">，</span><span class="n">表示只有当前命名空间所有节点不受限制</span>

<span class="n">应用资源对象文件</span>
<span class="c"># kubectl apply -f 05_kubernetes_secure_networkpolicy_ns_port.yaml</span>
<span class="n">networkpolicy</span><span class="p">.</span><span class="n">networking</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">egress-controller</span> <span class="n">created</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">在所有pod测试容器中</span>
<span class="p">/</span> <span class="c"># nslookup nginx-web.default.svc.cluster.local</span>
<span class="n">Server</span><span class="p">:</span>    <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span> <span class="n">kube-dns</span><span class="p">.</span><span class="n">kube-system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>

<span class="n">Name</span><span class="p">:</span>      <span class="n">nginx-web</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">101</span><span class="p">.</span><span class="n">181</span><span class="p">.</span><span class="n">105</span> <span class="n">nginx-web</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="p">/</span> <span class="c"># nslookup nginx-web</span>
<span class="n">Server</span><span class="p">:</span>    <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span>
<span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">96</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span> <span class="n">kube-dns</span><span class="p">.</span><span class="n">kube-system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>

<span class="n">Name</span><span class="p">:</span>      <span class="n">nginx-web</span>
<span class="n">Address</span> <span class="n">1</span><span class="p">:</span> <span class="n">10</span><span class="p">.</span><span class="n">105</span><span class="p">.</span><span class="n">110</span><span class="p">.</span><span class="n">175</span> <span class="n">nginx-web</span><span class="p">.</span><span class="n">superopsmsb</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>
<span class="n">结果显示</span><span class="err">：</span>   
    <span class="n">在不影响之前的策略的前提下</span><span class="err">，</span><span class="n">扩充了dns的解析功能</span>
</code></pre></div>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h2 id="26">2.6  基准测试<a class="headerlink" href="#26" title="Permanent link">&para;</a></h2>
<p>学习目标</p>
<p>这一节，我们从 软件简介、简单实践、小结 三个方面来学习</p>
<p><strong>软件简介</strong></p>
<p>简介</p>
<div class="highlight"><pre><span></span><code>    <span class="n">knb</span> <span class="n">全称</span> <span class="n">Kubernetes</span> <span class="n">Network</span> <span class="n">Benchmark</span><span class="p">,</span><span class="n">它是一个</span> <span class="n">bash</span> <span class="n">脚本</span><span class="err">，</span><span class="n">它将在目标</span> <span class="n">Kubernetes</span> <span class="n">集群上启动网络基准测试</span><span class="err">。</span>

<span class="n">参考资料</span><span class="err">：</span>
    <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">InfraBuilder</span><span class="p">/</span><span class="n">k8s-bench-suite</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">它的主要特点如下</span><span class="err">：</span>
    <span class="n">依赖很少的普通</span> <span class="n">bash</span> <span class="n">脚本</span>
    <span class="n">完成基准测试仅需</span> <span class="n">2</span> <span class="n">分钟</span>
    <span class="n">能够仅选择要运行的基准测试的子集</span>
    <span class="n">测试TCP</span> <span class="n">和</span> <span class="n">UDP带宽</span>
    <span class="n">自动检测</span> <span class="n">CNI</span> <span class="n">MTU</span>
    <span class="n">在基准报告中包括主机</span> <span class="n">cpu</span> <span class="n">和</span> <span class="n">ram</span> <span class="n">监控</span>
    <span class="n">能够使用</span> <span class="n">plotly</span><span class="p">/</span><span class="n">orca</span> <span class="n">基于结果数据创建静态图形图像</span><span class="err">（</span><span class="n">参见下面的示例</span><span class="err">）</span>
    <span class="n">无需</span> <span class="n">ssh</span> <span class="n">访问</span><span class="err">，</span><span class="n">只需通过标准</span> <span class="n">kubectl访问目标集群</span>
    <span class="n">不需要高权限</span><span class="err">，</span><span class="n">脚本只会在两个节点上启动非常轻量级的</span> <span class="n">Pod</span><span class="err">。</span>
    <span class="n">它提供了数据的图形生成镜像和配套的服务镜像</span>
</code></pre></div>
<p>准备工作</p>
<div class="highlight"><pre><span></span><code><span class="n">master节点下载核心服务镜像</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">olegeech</span><span class="p">/</span><span class="n">k8s-bench-suite</span>

<span class="n">特定node节点下载镜像</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">infrabuilder</span><span class="p">/</span><span class="n">bench-custom-monitor</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">infrabuilder</span><span class="p">/</span><span class="n">bench-iperf3</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">quay</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="n">plotly</span><span class="p">/</span><span class="n">orca</span>
</code></pre></div>
<p>注意事项</p>
<div class="highlight"><pre><span></span><code><span class="n">由于需要测试k8s节点间的网络通信质量并且将结果输出</span><span class="err">，</span><span class="n">所以它在操作的过程中需要提前做一些准备</span>
    <span class="n">1</span> <span class="n">准备k8s集群的认证config文件</span>
    <span class="n">2</span> <span class="n">准备数据文件的映射目录</span>
</code></pre></div>
<p><strong>简单实践</strong></p>
<p>命令解析</p>
<div class="highlight"><pre><span></span><code><span class="n">对于容器内部的knb命令来说</span><span class="err">，</span><span class="n">它的基本格式如下</span><span class="err">：</span>
    <span class="n">knb</span> <span class="p">-</span><span class="n">-verbose</span> <span class="p">-</span><span class="n">-client-node</span> <span class="n">客户端节点</span> <span class="p">-</span><span class="n">-server-node</span> <span class="n">服务端节点</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">docker</span> <span class="n">run时候</span><span class="err">，</span><span class="n">可以通过NODE_AUTOSELECT从集群中自动选择几个节点来运行测试</span>
        <span class="p">-</span> <span class="n">如果master节点的污点无法容忍</span><span class="err">，</span><span class="n">从而导致失败</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">查看命令帮助</span>
<span class="n">docker</span> <span class="n">run</span> <span class="n">-it</span> <span class="p">-</span><span class="n">-hostname</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-name</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-v</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">my-graphs</span><span class="p">:/</span><span class="n">my-graphs</span> <span class="n">-v</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span><span class="p">:/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">olegeech</span><span class="p">/</span><span class="n">k8s-bench-suite</span> <span class="p">-</span><span class="n">-help</span>

<span class="n">注意</span><span class="err">：</span>
    <span class="n">如果网络效果不是很好的话</span><span class="err">，</span><span class="n">会因为镜像无法获取而导致失败</span><span class="err">，</span><span class="n">需要重试几次即可</span>
    <span class="n">所以</span><span class="err">，</span><span class="n">如果可以的话</span><span class="err">，</span><span class="n">提前下载到特定的工作节点上</span>
</code></pre></div>
<p>测试效果</p>
<div class="highlight"><pre><span></span><code><span class="n">生成检测数据</span>
<span class="n">docker</span> <span class="n">run</span> <span class="n">-it</span> <span class="p">-</span><span class="n">-hostname</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-name</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-v</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">my-graphs</span><span class="p">:/</span><span class="n">my-graphs</span> <span class="n">-v</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span><span class="p">:/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">olegeech</span><span class="p">/</span><span class="n">k8s-bench-suite</span> <span class="p">-</span><span class="n">-verbose</span> <span class="p">-</span><span class="n">-server-node</span> <span class="n">kubernetes-node1</span> <span class="p">-</span><span class="n">-client-node</span> <span class="n">kubernetes-node2</span> <span class="n">-o</span> <span class="n">data</span> <span class="o">-f</span> <span class="p">/</span><span class="n">my-graphs</span><span class="p">/</span><span class="n">mybench</span><span class="p">.</span><span class="n">knbdata</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">以json方式显示数据</span>
<span class="n">docker</span> <span class="n">run</span> <span class="n">-it</span> <span class="p">-</span><span class="n">-hostname</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-name</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-v</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">my-graphs</span><span class="p">:/</span><span class="n">my-graphs</span> <span class="n">-v</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span><span class="p">:/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">olegeech</span><span class="p">/</span><span class="n">k8s-bench-suite</span> <span class="n">-fd</span> <span class="p">/</span><span class="n">my-graphs</span><span class="p">/</span><span class="n">mybench</span><span class="p">.</span><span class="n">knbdata</span> <span class="n">-o</span> <span class="n">json</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">根据数据进行绘图展示</span>
 <span class="n">docker</span> <span class="n">run</span> <span class="n">-it</span> <span class="p">-</span><span class="n">-hostname</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-name</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-v</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">my-graphs</span><span class="p">:/</span><span class="n">my-graphs</span> <span class="n">-v</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span><span class="p">:/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">olegeech</span><span class="p">/</span><span class="n">k8s-bench-suite</span> <span class="n">-fd</span> <span class="p">/</span><span class="n">my-graphs</span><span class="p">/</span><span class="n">mybench</span><span class="p">.</span><span class="n">knbdata</span> <span class="p">-</span><span class="n">-plot</span> <span class="p">-</span><span class="n">-plot-dir</span> <span class="p">/</span><span class="n">my-graphs</span><span class="p">/</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">设定数据的图形样式</span>
<span class="n">docker</span> <span class="n">run</span> <span class="n">-it</span> <span class="p">-</span><span class="n">-hostname</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-name</span> <span class="n">knb</span> <span class="p">-</span><span class="n">-rm</span> <span class="n">-v</span> <span class="p">/</span><span class="n">tmp</span><span class="p">/</span><span class="n">my-graphs</span><span class="p">:/</span><span class="n">my-graphs</span> <span class="n">-v</span> <span class="p">/</span><span class="n">root</span><span class="p">/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span><span class="p">:/.</span><span class="n">kube</span><span class="p">/</span><span class="n">config</span> <span class="n">olegeech</span><span class="p">/</span><span class="n">k8s-bench-suite</span> <span class="n">-fd</span> <span class="p">/</span><span class="n">my-graphs</span><span class="p">/</span><span class="n">mybench</span><span class="p">.</span><span class="n">knbdata</span> <span class="p">-</span><span class="n">-plot</span> <span class="p">-</span><span class="n">-plot-args</span> <span class="s1">&#39;--width 900 --height 600&#39;</span> <span class="p">-</span><span class="n">-plot-dir</span> <span class="p">/</span><span class="n">my-graphs</span>
</code></pre></div>
<p><strong>小结</strong></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      BurningMyself<a href='https://beian.miit.gov.cn/' target='_blank'>  蜀ICP备15033200号-1</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/burningmyself" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitee.com/burningmyself" target="_blank" rel="noopener" title="gitee.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
        <script src="../../../js/baidu-tongji.js"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155084439-1"></script>
      
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-155132293-1"></script>
      
        <script src="../../../js/google.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>